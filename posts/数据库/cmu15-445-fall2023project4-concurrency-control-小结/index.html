<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>ã€CMU15-445 Fall2023ã€‘Project4 Concurrency Control å°ç»“ | Kerolt's Blog</title><meta name=keywords content="CPlusPlus,Database,CMU-15445"><meta name=description content="è¿™ä¸ª project ä¸»è¦æ˜¯å¸Œæœ›æˆ‘ä»¬ç†è§£ MVCC çš„ä¸€äº›ç›¸å…³çŸ¥è¯†ã€‚MVCC çš„è®¾è®¡ç›®æ ‡æ˜¯é€šè¿‡ç»´æŠ¤å¤šä¸ªç‰ˆæœ¬çš„å…ƒç»„ï¼ˆtupleï¼‰ï¼Œä½¿å¾—ä¸åŒçš„äº‹åŠ¡èƒ½å¤Ÿè®¿é—®åˆ°ä¸å…¶æ—¶é—´æˆ³ä¸€è‡´çš„æ•°æ®ç‰ˆæœ¬ï¼Œè€Œæ— éœ€é€šè¿‡é”æœºåˆ¶å®Œå…¨é˜»å¡å…¶ä»–äº‹åŠ¡çš„æ“ä½œã€‚å…·ä½“æ¥è¯´ï¼š

æ¯ä¸ªäº‹åŠ¡åœ¨å¯åŠ¨æ—¶ä¼šè¢«åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„ äº‹åŠ¡ ID æˆ– è¯»å–æ—¶é—´æˆ³ ã€‚
æ•°æ®åº“ç³»ç»Ÿä¼šæ ¹æ®äº‹åŠ¡çš„è¯»å–æ—¶é—´æˆ³ï¼Œå†³å®šè¯¥äº‹åŠ¡èƒ½çœ‹åˆ°å“ªäº›æ•°æ®ç‰ˆæœ¬ï¼š
å¯è§æ€§è§„åˆ™ ï¼šäº‹åŠ¡åªèƒ½çœ‹åˆ°åœ¨å…¶è¯»å–æ—¶é—´æˆ³ä¹‹å‰æäº¤çš„æ•°æ®ç‰ˆæœ¬ã€‚
ä¸å¯è§æ€§è§„åˆ™ ï¼šäº‹åŠ¡ä¸èƒ½çœ‹åˆ°åœ¨å…¶è¯»å–æ—¶é—´æˆ³ä¹‹åæäº¤æˆ–æœªæäº¤çš„æ•°æ®ç‰ˆæœ¬ã€‚


15445 çš„ lab å†™äº†å¤ªä¹…å¤ªä¹…äº†ï¼Œè‡ªå·±æ‡’æ˜¯ä¸€æ–¹é¢ï¼Œå®åŠ›ä¸å¤Ÿä¹Ÿæ˜¯ä¸€æ–¹é¢ï¼Œtask4 åé¢çš„ lab å°±ä¸æ‰“ç®—å†™äº†ï¼ˆæ— å¥ˆ.jpgï¼‰ã€‚åœ¨è¿™æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œå­¦åˆ°çš„ä¸œè¥¿è¿˜æŒºå¤šçš„ï¼Œå¯¹äºä»£ç èƒ½åŠ›ä¹Ÿæœ‰æå‡ï¼Œä»¥åæœ‰æ—¶é—´è¿˜æ˜¯å¯ä»¥å¤šçœ‹çœ‹é…å¥—çš„è¯¾ç¨‹ï¼Œç„¶åå†å¥½å¥½è¯»è¯»ä»£ç ï¼Œå†™å†™æ³¨é‡Šå’Œåšå®¢å»æ·±å…¥ç†è§£ç†è§£ï¼Œæ¯•ç«Ÿ bustub çš„ä¸è®ºæ˜¯ä»£ç æ¶æ„è¿˜æ˜¯è§„èŒƒæˆ‘éƒ½è§‰å¾—éå¸¸æ£’ã€‚åé¢å°±è¦åƒ 15445 ç½‘é¡µä¸­å†™åˆ°çš„ï¼Œå»å¤šå…³æ³¨ç”Ÿæ´»ä¸­å…¶ä»–æ„Ÿå…´è¶£çš„åœ°æ–¹äº†ï¼Œå¸Œæœ›èƒ½å¤Ÿä¸æ–­æå‡è‡ªå·±~

0. Bustub ä¸­çš„ undolog
bustub ä¸­åœ¨ TransactionManager ä¸­é€šè¿‡ä¸€ä¸ªå“ˆå¸Œè¡¨æ¥ä¿å­˜æ‰€æœ‰ tuple çš„ undolog èµ·ç‚¹ï¼š
class TransactionManager {
 public:
   ...
   
   struct PageVersionInfo {
    /** protects the map */
    std::shared_mutex mutex_;
    /** Stores previous version info for all slots. Note: DO NOT use `[x]` to access it because
     * it will create new elements even if it does not exist. Use `find` instead.
     */
    std::unordered_map<slot_offset_t, VersionUndoLink> prev_version_;
  };

  /** protects version info */
  std::shared_mutex version_info_mutex_;
  /** Stores the previous version of each tuple in the table heap. Do not directly access this field. Use the helper
   * functions in `transaction_manager_impl.cpp`. */
  std::unordered_map<page_id_t, std::shared_ptr<PageVersionInfo>> version_info_;

  ...
}
å…¶ä¸­çš„ VersionUndoLink ä¹Ÿåªæ˜¯å¯¹ UndoLink çš„ä¸€ä¸ªåŒ…è£…ï¼š"><meta name=author content="Kerolt"><link rel=canonical href=https://kerolt.github.io/posts/%E6%95%B0%E6%8D%AE%E5%BA%93/cmu15-445-fall2023project4-concurrency-control-%E5%B0%8F%E7%BB%93/><meta name=google-site-verification content="NpIO0KEIJS0CPRzTzQCbYQdSRIyb0Lspx"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="2300A23B82DB579A2DEA6261191AD771"><link crossorigin=anonymous href=/assets/css/stylesheet.679ef4369acccbeadd679a095a08e226e874ee5a0a2930197bc0ed485044db42.css integrity="sha256-Z570NprMy+rdZ5oJWgjiJuh07loKKTAZe8DtSFBE20I=" rel="preload stylesheet" as=style><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-screen-web/style.css><link rel=icon href=https://kerolt.github.io/images/avatar/favicon.png><link rel=icon type=image/png sizes=16x16 href=https://kerolt.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://kerolt.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://kerolt.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://kerolt.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://kerolt.github.io/posts/%E6%95%B0%E6%8D%AE%E5%BA%93/cmu15-445-fall2023project4-concurrency-control-%E5%B0%8F%E7%BB%93/><script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css><script src=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js></script><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://kerolt.github.io/posts/%E6%95%B0%E6%8D%AE%E5%BA%93/cmu15-445-fall2023project4-concurrency-control-%E5%B0%8F%E7%BB%93/"><meta property="og:site_name" content="Kerolt's Blog"><meta property="og:title" content="ã€CMU15-445 Fall2023ã€‘Project4 Concurrency Control å°ç»“"><meta property="og:description" content="è¿™ä¸ª project ä¸»è¦æ˜¯å¸Œæœ›æˆ‘ä»¬ç†è§£ MVCC çš„ä¸€äº›ç›¸å…³çŸ¥è¯†ã€‚MVCC çš„è®¾è®¡ç›®æ ‡æ˜¯é€šè¿‡ç»´æŠ¤å¤šä¸ªç‰ˆæœ¬çš„å…ƒç»„ï¼ˆtupleï¼‰ï¼Œä½¿å¾—ä¸åŒçš„äº‹åŠ¡èƒ½å¤Ÿè®¿é—®åˆ°ä¸å…¶æ—¶é—´æˆ³ä¸€è‡´çš„æ•°æ®ç‰ˆæœ¬ï¼Œè€Œæ— éœ€é€šè¿‡é”æœºåˆ¶å®Œå…¨é˜»å¡å…¶ä»–äº‹åŠ¡çš„æ“ä½œã€‚å…·ä½“æ¥è¯´ï¼š
æ¯ä¸ªäº‹åŠ¡åœ¨å¯åŠ¨æ—¶ä¼šè¢«åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„ äº‹åŠ¡ ID æˆ– è¯»å–æ—¶é—´æˆ³ ã€‚ æ•°æ®åº“ç³»ç»Ÿä¼šæ ¹æ®äº‹åŠ¡çš„è¯»å–æ—¶é—´æˆ³ï¼Œå†³å®šè¯¥äº‹åŠ¡èƒ½çœ‹åˆ°å“ªäº›æ•°æ®ç‰ˆæœ¬ï¼š å¯è§æ€§è§„åˆ™ ï¼šäº‹åŠ¡åªèƒ½çœ‹åˆ°åœ¨å…¶è¯»å–æ—¶é—´æˆ³ä¹‹å‰æäº¤çš„æ•°æ®ç‰ˆæœ¬ã€‚ ä¸å¯è§æ€§è§„åˆ™ ï¼šäº‹åŠ¡ä¸èƒ½çœ‹åˆ°åœ¨å…¶è¯»å–æ—¶é—´æˆ³ä¹‹åæäº¤æˆ–æœªæäº¤çš„æ•°æ®ç‰ˆæœ¬ã€‚ 15445 çš„ lab å†™äº†å¤ªä¹…å¤ªä¹…äº†ï¼Œè‡ªå·±æ‡’æ˜¯ä¸€æ–¹é¢ï¼Œå®åŠ›ä¸å¤Ÿä¹Ÿæ˜¯ä¸€æ–¹é¢ï¼Œtask4 åé¢çš„ lab å°±ä¸æ‰“ç®—å†™äº†ï¼ˆæ— å¥ˆ.jpgï¼‰ã€‚åœ¨è¿™æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œå­¦åˆ°çš„ä¸œè¥¿è¿˜æŒºå¤šçš„ï¼Œå¯¹äºä»£ç èƒ½åŠ›ä¹Ÿæœ‰æå‡ï¼Œä»¥åæœ‰æ—¶é—´è¿˜æ˜¯å¯ä»¥å¤šçœ‹çœ‹é…å¥—çš„è¯¾ç¨‹ï¼Œç„¶åå†å¥½å¥½è¯»è¯»ä»£ç ï¼Œå†™å†™æ³¨é‡Šå’Œåšå®¢å»æ·±å…¥ç†è§£ç†è§£ï¼Œæ¯•ç«Ÿ bustub çš„ä¸è®ºæ˜¯ä»£ç æ¶æ„è¿˜æ˜¯è§„èŒƒæˆ‘éƒ½è§‰å¾—éå¸¸æ£’ã€‚åé¢å°±è¦åƒ 15445 ç½‘é¡µä¸­å†™åˆ°çš„ï¼Œå»å¤šå…³æ³¨ç”Ÿæ´»ä¸­å…¶ä»–æ„Ÿå…´è¶£çš„åœ°æ–¹äº†ï¼Œå¸Œæœ›èƒ½å¤Ÿä¸æ–­æå‡è‡ªå·±~
0. Bustub ä¸­çš„ undolog bustub ä¸­åœ¨ TransactionManager ä¸­é€šè¿‡ä¸€ä¸ªå“ˆå¸Œè¡¨æ¥ä¿å­˜æ‰€æœ‰ tuple çš„ undolog èµ·ç‚¹ï¼š
class TransactionManager { public: ... struct PageVersionInfo { /** protects the map */ std::shared_mutex mutex_; /** Stores previous version info for all slots. Note: DO NOT use `[x]` to access it because * it will create new elements even if it does not exist. Use `find` instead. */ std::unordered_map<slot_offset_t, VersionUndoLink> prev_version_; }; /** protects version info */ std::shared_mutex version_info_mutex_; /** Stores the previous version of each tuple in the table heap. Do not directly access this field. Use the helper * functions in `transaction_manager_impl.cpp`. */ std::unordered_map<page_id_t, std::shared_ptr<PageVersionInfo>> version_info_; ... } å…¶ä¸­çš„ VersionUndoLink ä¹Ÿåªæ˜¯å¯¹ UndoLink çš„ä¸€ä¸ªåŒ…è£…ï¼š"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-05-06T00:00:00+00:00"><meta property="article:modified_time" content="2025-05-06T00:00:00+00:00"><meta property="article:tag" content="CPlusPlus"><meta property="article:tag" content="Database"><meta property="article:tag" content="CMU-15445"><meta property="og:image" content="https://kerolt.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://kerolt.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="ã€CMU15-445 Fall2023ã€‘Project4 Concurrency Control å°ç»“"><meta name=twitter:description content="è¿™ä¸ª project ä¸»è¦æ˜¯å¸Œæœ›æˆ‘ä»¬ç†è§£ MVCC çš„ä¸€äº›ç›¸å…³çŸ¥è¯†ã€‚MVCC çš„è®¾è®¡ç›®æ ‡æ˜¯é€šè¿‡ç»´æŠ¤å¤šä¸ªç‰ˆæœ¬çš„å…ƒç»„ï¼ˆtupleï¼‰ï¼Œä½¿å¾—ä¸åŒçš„äº‹åŠ¡èƒ½å¤Ÿè®¿é—®åˆ°ä¸å…¶æ—¶é—´æˆ³ä¸€è‡´çš„æ•°æ®ç‰ˆæœ¬ï¼Œè€Œæ— éœ€é€šè¿‡é”æœºåˆ¶å®Œå…¨é˜»å¡å…¶ä»–äº‹åŠ¡çš„æ“ä½œã€‚å…·ä½“æ¥è¯´ï¼š

æ¯ä¸ªäº‹åŠ¡åœ¨å¯åŠ¨æ—¶ä¼šè¢«åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„ äº‹åŠ¡ ID æˆ– è¯»å–æ—¶é—´æˆ³ ã€‚
æ•°æ®åº“ç³»ç»Ÿä¼šæ ¹æ®äº‹åŠ¡çš„è¯»å–æ—¶é—´æˆ³ï¼Œå†³å®šè¯¥äº‹åŠ¡èƒ½çœ‹åˆ°å“ªäº›æ•°æ®ç‰ˆæœ¬ï¼š
å¯è§æ€§è§„åˆ™ ï¼šäº‹åŠ¡åªèƒ½çœ‹åˆ°åœ¨å…¶è¯»å–æ—¶é—´æˆ³ä¹‹å‰æäº¤çš„æ•°æ®ç‰ˆæœ¬ã€‚
ä¸å¯è§æ€§è§„åˆ™ ï¼šäº‹åŠ¡ä¸èƒ½çœ‹åˆ°åœ¨å…¶è¯»å–æ—¶é—´æˆ³ä¹‹åæäº¤æˆ–æœªæäº¤çš„æ•°æ®ç‰ˆæœ¬ã€‚


15445 çš„ lab å†™äº†å¤ªä¹…å¤ªä¹…äº†ï¼Œè‡ªå·±æ‡’æ˜¯ä¸€æ–¹é¢ï¼Œå®åŠ›ä¸å¤Ÿä¹Ÿæ˜¯ä¸€æ–¹é¢ï¼Œtask4 åé¢çš„ lab å°±ä¸æ‰“ç®—å†™äº†ï¼ˆæ— å¥ˆ.jpgï¼‰ã€‚åœ¨è¿™æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œå­¦åˆ°çš„ä¸œè¥¿è¿˜æŒºå¤šçš„ï¼Œå¯¹äºä»£ç èƒ½åŠ›ä¹Ÿæœ‰æå‡ï¼Œä»¥åæœ‰æ—¶é—´è¿˜æ˜¯å¯ä»¥å¤šçœ‹çœ‹é…å¥—çš„è¯¾ç¨‹ï¼Œç„¶åå†å¥½å¥½è¯»è¯»ä»£ç ï¼Œå†™å†™æ³¨é‡Šå’Œåšå®¢å»æ·±å…¥ç†è§£ç†è§£ï¼Œæ¯•ç«Ÿ bustub çš„ä¸è®ºæ˜¯ä»£ç æ¶æ„è¿˜æ˜¯è§„èŒƒæˆ‘éƒ½è§‰å¾—éå¸¸æ£’ã€‚åé¢å°±è¦åƒ 15445 ç½‘é¡µä¸­å†™åˆ°çš„ï¼Œå»å¤šå…³æ³¨ç”Ÿæ´»ä¸­å…¶ä»–æ„Ÿå…´è¶£çš„åœ°æ–¹äº†ï¼Œå¸Œæœ›èƒ½å¤Ÿä¸æ–­æå‡è‡ªå·±~

0. Bustub ä¸­çš„ undolog
bustub ä¸­åœ¨ TransactionManager ä¸­é€šè¿‡ä¸€ä¸ªå“ˆå¸Œè¡¨æ¥ä¿å­˜æ‰€æœ‰ tuple çš„ undolog èµ·ç‚¹ï¼š
class TransactionManager {
 public:
   ...
   
   struct PageVersionInfo {
    /** protects the map */
    std::shared_mutex mutex_;
    /** Stores previous version info for all slots. Note: DO NOT use `[x]` to access it because
     * it will create new elements even if it does not exist. Use `find` instead.
     */
    std::unordered_map<slot_offset_t, VersionUndoLink> prev_version_;
  };

  /** protects version info */
  std::shared_mutex version_info_mutex_;
  /** Stores the previous version of each tuple in the table heap. Do not directly access this field. Use the helper
   * functions in `transaction_manager_impl.cpp`. */
  std::unordered_map<page_id_t, std::shared_ptr<PageVersionInfo>> version_info_;

  ...
}
å…¶ä¸­çš„ VersionUndoLink ä¹Ÿåªæ˜¯å¯¹ UndoLink çš„ä¸€ä¸ªåŒ…è£…ï¼š"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://kerolt.github.io/posts/"},{"@type":"ListItem","position":2,"name":"ã€CMU15-445 Fall2023ã€‘Project4 Concurrency Control å°ç»“","item":"https://kerolt.github.io/posts/%E6%95%B0%E6%8D%AE%E5%BA%93/cmu15-445-fall2023project4-concurrency-control-%E5%B0%8F%E7%BB%93/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"ã€CMU15-445 Fall2023ã€‘Project4 Concurrency Control å°ç»“","name":"ã€CMU15-445 Fall2023ã€‘Project4 Concurrency Control å°ç»“","description":"è¿™ä¸ª project ä¸»è¦æ˜¯å¸Œæœ›æˆ‘ä»¬ç†è§£ MVCC çš„ä¸€äº›ç›¸å…³çŸ¥è¯†ã€‚MVCC çš„è®¾è®¡ç›®æ ‡æ˜¯é€šè¿‡ç»´æŠ¤å¤šä¸ªç‰ˆæœ¬çš„å…ƒç»„ï¼ˆtupleï¼‰ï¼Œä½¿å¾—ä¸åŒçš„äº‹åŠ¡èƒ½å¤Ÿè®¿é—®åˆ°ä¸å…¶æ—¶é—´æˆ³ä¸€è‡´çš„æ•°æ®ç‰ˆæœ¬ï¼Œè€Œæ— éœ€é€šè¿‡é”æœºåˆ¶å®Œå…¨é˜»å¡å…¶ä»–äº‹åŠ¡çš„æ“ä½œã€‚å…·ä½“æ¥è¯´ï¼š\næ¯ä¸ªäº‹åŠ¡åœ¨å¯åŠ¨æ—¶ä¼šè¢«åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„ äº‹åŠ¡ ID æˆ– è¯»å–æ—¶é—´æˆ³ ã€‚ æ•°æ®åº“ç³»ç»Ÿä¼šæ ¹æ®äº‹åŠ¡çš„è¯»å–æ—¶é—´æˆ³ï¼Œå†³å®šè¯¥äº‹åŠ¡èƒ½çœ‹åˆ°å“ªäº›æ•°æ®ç‰ˆæœ¬ï¼š å¯è§æ€§è§„åˆ™ ï¼šäº‹åŠ¡åªèƒ½çœ‹åˆ°åœ¨å…¶è¯»å–æ—¶é—´æˆ³ä¹‹å‰æäº¤çš„æ•°æ®ç‰ˆæœ¬ã€‚ ä¸å¯è§æ€§è§„åˆ™ ï¼šäº‹åŠ¡ä¸èƒ½çœ‹åˆ°åœ¨å…¶è¯»å–æ—¶é—´æˆ³ä¹‹åæäº¤æˆ–æœªæäº¤çš„æ•°æ®ç‰ˆæœ¬ã€‚ 15445 çš„ lab å†™äº†å¤ªä¹…å¤ªä¹…äº†ï¼Œè‡ªå·±æ‡’æ˜¯ä¸€æ–¹é¢ï¼Œå®åŠ›ä¸å¤Ÿä¹Ÿæ˜¯ä¸€æ–¹é¢ï¼Œtask4 åé¢çš„ lab å°±ä¸æ‰“ç®—å†™äº†ï¼ˆæ— å¥ˆ.jpgï¼‰ã€‚åœ¨è¿™æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œå­¦åˆ°çš„ä¸œè¥¿è¿˜æŒºå¤šçš„ï¼Œå¯¹äºä»£ç èƒ½åŠ›ä¹Ÿæœ‰æå‡ï¼Œä»¥åæœ‰æ—¶é—´è¿˜æ˜¯å¯ä»¥å¤šçœ‹çœ‹é…å¥—çš„è¯¾ç¨‹ï¼Œç„¶åå†å¥½å¥½è¯»è¯»ä»£ç ï¼Œå†™å†™æ³¨é‡Šå’Œåšå®¢å»æ·±å…¥ç†è§£ç†è§£ï¼Œæ¯•ç«Ÿ bustub çš„ä¸è®ºæ˜¯ä»£ç æ¶æ„è¿˜æ˜¯è§„èŒƒæˆ‘éƒ½è§‰å¾—éå¸¸æ£’ã€‚åé¢å°±è¦åƒ 15445 ç½‘é¡µä¸­å†™åˆ°çš„ï¼Œå»å¤šå…³æ³¨ç”Ÿæ´»ä¸­å…¶ä»–æ„Ÿå…´è¶£çš„åœ°æ–¹äº†ï¼Œå¸Œæœ›èƒ½å¤Ÿä¸æ–­æå‡è‡ªå·±~\n0. Bustub ä¸­çš„ undolog bustub ä¸­åœ¨ TransactionManager ä¸­é€šè¿‡ä¸€ä¸ªå“ˆå¸Œè¡¨æ¥ä¿å­˜æ‰€æœ‰ tuple çš„ undolog èµ·ç‚¹ï¼š\nclass TransactionManager { public: ... struct PageVersionInfo { /** protects the map */ std::shared_mutex mutex_; /** Stores previous version info for all slots. Note: DO NOT use `[x]` to access it because * it will create new elements even if it does not exist. Use `find` instead. */ std::unordered_map\u0026lt;slot_offset_t, VersionUndoLink\u0026gt; prev_version_; }; /** protects version info */ std::shared_mutex version_info_mutex_; /** Stores the previous version of each tuple in the table heap. Do not directly access this field. Use the helper * functions in `transaction_manager_impl.cpp`. */ std::unordered_map\u0026lt;page_id_t, std::shared_ptr\u0026lt;PageVersionInfo\u0026gt;\u0026gt; version_info_; ... } å…¶ä¸­çš„ VersionUndoLink ä¹Ÿåªæ˜¯å¯¹ UndoLink çš„ä¸€ä¸ªåŒ…è£…ï¼š\n","keywords":["CPlusPlus","Database","CMU-15445"],"articleBody":"è¿™ä¸ª project ä¸»è¦æ˜¯å¸Œæœ›æˆ‘ä»¬ç†è§£ MVCC çš„ä¸€äº›ç›¸å…³çŸ¥è¯†ã€‚MVCC çš„è®¾è®¡ç›®æ ‡æ˜¯é€šè¿‡ç»´æŠ¤å¤šä¸ªç‰ˆæœ¬çš„å…ƒç»„ï¼ˆtupleï¼‰ï¼Œä½¿å¾—ä¸åŒçš„äº‹åŠ¡èƒ½å¤Ÿè®¿é—®åˆ°ä¸å…¶æ—¶é—´æˆ³ä¸€è‡´çš„æ•°æ®ç‰ˆæœ¬ï¼Œè€Œæ— éœ€é€šè¿‡é”æœºåˆ¶å®Œå…¨é˜»å¡å…¶ä»–äº‹åŠ¡çš„æ“ä½œã€‚å…·ä½“æ¥è¯´ï¼š\næ¯ä¸ªäº‹åŠ¡åœ¨å¯åŠ¨æ—¶ä¼šè¢«åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„ äº‹åŠ¡ ID æˆ– è¯»å–æ—¶é—´æˆ³ ã€‚ æ•°æ®åº“ç³»ç»Ÿä¼šæ ¹æ®äº‹åŠ¡çš„è¯»å–æ—¶é—´æˆ³ï¼Œå†³å®šè¯¥äº‹åŠ¡èƒ½çœ‹åˆ°å“ªäº›æ•°æ®ç‰ˆæœ¬ï¼š å¯è§æ€§è§„åˆ™ ï¼šäº‹åŠ¡åªèƒ½çœ‹åˆ°åœ¨å…¶è¯»å–æ—¶é—´æˆ³ä¹‹å‰æäº¤çš„æ•°æ®ç‰ˆæœ¬ã€‚ ä¸å¯è§æ€§è§„åˆ™ ï¼šäº‹åŠ¡ä¸èƒ½çœ‹åˆ°åœ¨å…¶è¯»å–æ—¶é—´æˆ³ä¹‹åæäº¤æˆ–æœªæäº¤çš„æ•°æ®ç‰ˆæœ¬ã€‚ 15445 çš„ lab å†™äº†å¤ªä¹…å¤ªä¹…äº†ï¼Œè‡ªå·±æ‡’æ˜¯ä¸€æ–¹é¢ï¼Œå®åŠ›ä¸å¤Ÿä¹Ÿæ˜¯ä¸€æ–¹é¢ï¼Œtask4 åé¢çš„ lab å°±ä¸æ‰“ç®—å†™äº†ï¼ˆæ— å¥ˆ.jpgï¼‰ã€‚åœ¨è¿™æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œå­¦åˆ°çš„ä¸œè¥¿è¿˜æŒºå¤šçš„ï¼Œå¯¹äºä»£ç èƒ½åŠ›ä¹Ÿæœ‰æå‡ï¼Œä»¥åæœ‰æ—¶é—´è¿˜æ˜¯å¯ä»¥å¤šçœ‹çœ‹é…å¥—çš„è¯¾ç¨‹ï¼Œç„¶åå†å¥½å¥½è¯»è¯»ä»£ç ï¼Œå†™å†™æ³¨é‡Šå’Œåšå®¢å»æ·±å…¥ç†è§£ç†è§£ï¼Œæ¯•ç«Ÿ bustub çš„ä¸è®ºæ˜¯ä»£ç æ¶æ„è¿˜æ˜¯è§„èŒƒæˆ‘éƒ½è§‰å¾—éå¸¸æ£’ã€‚åé¢å°±è¦åƒ 15445 ç½‘é¡µä¸­å†™åˆ°çš„ï¼Œå»å¤šå…³æ³¨ç”Ÿæ´»ä¸­å…¶ä»–æ„Ÿå…´è¶£çš„åœ°æ–¹äº†ï¼Œå¸Œæœ›èƒ½å¤Ÿä¸æ–­æå‡è‡ªå·±~\n0. Bustub ä¸­çš„ undolog bustub ä¸­åœ¨ TransactionManager ä¸­é€šè¿‡ä¸€ä¸ªå“ˆå¸Œè¡¨æ¥ä¿å­˜æ‰€æœ‰ tuple çš„ undolog èµ·ç‚¹ï¼š\nclass TransactionManager { public: ... struct PageVersionInfo { /** protects the map */ std::shared_mutex mutex_; /** Stores previous version info for all slots. Note: DO NOT use `[x]` to access it because * it will create new elements even if it does not exist. Use `find` instead. */ std::unordered_map\u003cslot_offset_t, VersionUndoLink\u003e prev_version_; }; /** protects version info */ std::shared_mutex version_info_mutex_; /** Stores the previous version of each tuple in the table heap. Do not directly access this field. Use the helper * functions in `transaction_manager_impl.cpp`. */ std::unordered_map\u003cpage_id_t, std::shared_ptr\u003cPageVersionInfo\u003e\u003e version_info_; ... } å…¶ä¸­çš„ VersionUndoLink ä¹Ÿåªæ˜¯å¯¹ UndoLink çš„ä¸€ä¸ªåŒ…è£…ï¼š\nstruct UndoLink { /* Previous version can be found in which txn */ txn_id_t prev_txn_{INVALID_TXN_ID}; /* The log index of the previous version in `prev_txn_` */ int prev_log_idx_{0}; ... }; struct VersionUndoLink { /** The next version in the version chain. */ UndoLink prev_; /** Whether a transaction is modifying the version link. Fall 2023: you do not need to read / write this field until * task 4.2. */ bool in_progress_{false}; ... }; ä¸€ä¸ª tuple æœ€æ–°çš„æ•°æ®ä¼šä¿å­˜åœ¨ table heap ä¸­ï¼Œè€Œ txn manager é€šè¿‡è¿™ä¸ª tuple çš„ rid å¯ä»¥è·å–åˆ°è¿™ä¸ª tuple çš„ undologï¼š\nexec_ctx_-\u003eGetTransactionManager()-\u003eGetUndoLink(rid);\n1. Task 1 - Timestamps æ¯ä¸ªäº‹åŠ¡æœ‰ä¸¤ä¸ªæ—¶é—´æˆ³ï¼š\nread_tsï¼šäº‹åŠ¡å¼€å§‹æ—¶åˆ†é…ï¼Œè¡¨ç¤ºè¯¥äº‹åŠ¡èƒ½çœ‹åˆ°çš„æœ€æ–°æäº¤çš„æ•°æ®ç‰ˆæœ¬ã€‚ commit_tsï¼šäº‹åŠ¡æäº¤æ—¶åˆ†é…ï¼Œæ˜¯ä¸€ä¸ªå•è°ƒé€’å¢çš„é€»è¾‘æ—¶é—´æˆ³ï¼Œå†³å®šäº‹åŠ¡çš„ä¸²è¡ŒåŒ–é¡ºåºã€‚ è§„åˆ™å¦‚ä¸‹ï¼š\näº‹åŠ¡å¼€å§‹æ—¶ï¼ˆBeginï¼‰ï¼Œread_ts = last_commit_ts äº‹åŠ¡æäº¤æ—¶ï¼ˆCommitï¼‰ï¼Œcommit_ts = ++last_commit_ts å¯¹äº Watermark æœºåˆ¶ï¼Œå…¶å®šä¹‰æ˜¯æ‰€æœ‰æ´»è·ƒäº‹åŠ¡ä¸­çš„æœ€å° read_tsï¼Œä½œç”¨ä¸ºç¡®å®šå“ªäº›æ•°æ®ç‰ˆæœ¬å·²ç»ä¸å†è¢«ä»»ä½•äº‹åŠ¡è¯»å–ï¼Œä»è€Œå¯ä»¥å®‰å…¨åœ°æ¸…ç†æ—§ç‰ˆæœ¬æ•°æ®ã€‚\nè¿™é‡Œå¾ˆç®€å•ï¼Œå°±æ˜¯éœ€è¦åœ¨ç»´æŠ¤å¥½ç³»ç»Ÿä¸­çš„ watermarkï¼Œéå†äº‹åŠ¡æ˜ å°„ä¸­çš„æ‰€æœ‰äº‹åŠ¡ï¼Œæ‰¾å‡ºæ‰€æœ‰è¿›è¡Œä¸­äº‹åŠ¡ä¸­æœ€å°çš„ read_ts ä¸º watermarkã€‚åœ¨äº‹åŠ¡çš„ Beginã€Commitã€Abort ä¸­éœ€è¦ä½¿ç”¨ Watermark::AddTxn å’Œ Watermark::RemoveTxn æ¥æ›´æ–° watermarkã€‚åœ¨æ›´æ–°æ—¶ï¼Œå¯ä»¥ä½¿ç”¨çº¢é»‘æ ‘æˆ–è€…å“ˆå¸Œè¡¨ + ä¼˜å…ˆé˜Ÿåˆ—æ¥å¿«é€Ÿæ‰¾åˆ°æœ€å°çš„ read_tsã€‚\n2. Task2 - Storage Format and Sequential Scan 2.1 Tuple Reconstruction æ•°æ®åº“éœ€è¦ä¸€ç§æœºåˆ¶æ¥â€œå›æº¯â€æ•°æ®çš„å†å²ç‰ˆæœ¬ï¼Œè€Œ ReconstructTuple æ­£æ˜¯è¿™ç§æœºåˆ¶çš„æ ¸å¿ƒå®ç°ã€‚\nåœ¨ MVCC ç³»ç»Ÿä¸­ï¼Œè¡¨å †ï¼ˆtable heapï¼‰é€šå¸¸å­˜å‚¨çš„æ˜¯æœ€æ–°çš„æ•°æ®ç‰ˆæœ¬ï¼Œè€Œæ—§ç‰ˆæœ¬çš„å…ƒç»„ä¿¡æ¯åˆ™é€šè¿‡ undo logs è®°å½•ä¸‹æ¥ã€‚å½“äº‹åŠ¡éœ€è¦è®¿é—®æŸä¸ªå…ƒç»„çš„å†å²ç‰ˆæœ¬æ—¶ï¼ŒReconstructTuple ä¼šä»è¡¨å †ä¸­è·å–æœ€æ–°çš„å…ƒç»„ï¼Œå¹¶æ ¹æ® undo logs é€æ­¥æ¢å¤å‡ºç¬¦åˆäº‹åŠ¡è¯»å–æ—¶é—´æˆ³çš„ç‰ˆæœ¬ã€‚\nåœ¨ MVCC ç³»ç»Ÿä¸­ï¼Œæ•°æ®çš„åˆ é™¤æ“ä½œå¹¶ä¸ä¼šç«‹å³ä»è¡¨å †ä¸­ç§»é™¤å…ƒç»„ï¼Œè€Œæ˜¯é€šè¿‡è®¾ç½® is_deleted æ ‡å¿—æ¥æ ‡è®°é€»è¾‘åˆ é™¤ã€‚ReconstructTuple åœ¨å¤„ç† undo logs æ—¶ä¼šæ£€æŸ¥ is_deleted æ ‡å¿—ï¼Œä»è€Œåˆ¤æ–­æŸä¸ªå…ƒç»„æ˜¯å¦å·²è¢«åˆ é™¤ã€‚ReconstructTuple å°†å§‹ç»ˆåº”ç”¨æä¾›ç»™å‡½æ•°çš„æ‰€æœ‰ä¿®æ”¹ï¼Œè€Œæ— éœ€æŸ¥çœ‹å…ƒæ•°æ®æˆ–æ’¤é”€æ—¥å¿—ä¸­çš„æ—¶é—´æˆ³ã€‚é™¤äº†å‡½æ•°å‚æ•°åˆ—è¡¨ä¸­æä¾›çš„æ•°æ®å¤–ï¼Œå®ƒä¸éœ€è¦è®¿é—®å…¶ä»–æ•°æ®ã€‚\nundo log è®°å½•çš„æ˜¯ä¸Šæ¬¡æ“ä½œå®Œçš„ç»“æœï¼ˆæ¢å¥è¯è¯´ï¼Œè¿™æ¬¡æ²¡æ“ä½œå‰æ˜¯ä»€ä¹ˆæ ·å­ï¼‰ï¼Œåªæœ‰ modified_fields_ æ˜¯ä¸ºäº†å‘Šè¯‰è¿™æ¬¡æ“ä½œï¼Œåœ¨ä¸Šæ¬¡ä¿®æ”¹å®Œæˆä¹‹å‰ tuple æ˜¯ä»€ä¹ˆæ ·å­ã€‚\nmodified_fields_ï¼šé•¿åº¦ä¸ tuple çš„ schema ç›¸åŒï¼Œæ¯ä¸ªä½ä»£è¡¨åœ¨è¿™æ¬¡çš„æ“ä½œä¸­å¯¹äºæŸä¸ªå­—æ®µæ—¶å€™æœ‰æ›´æ–° tuple_ï¼šå…¶é•¿åº¦ \u003c= åŸå§‹çš„ tupleï¼Œåªè®°å½•äº† modified_fields_ ä¸­ä¸º true çš„å­—æ®µï¼Œå¹¶ä¸”ä¿å­˜çš„å€¼æ˜¯æœ¬æ¬¡æ“ä½œä¹‹å‰çš„å€¼ ReconstructTuple çš„å·¥ä½œæµç¨‹ï¼š\nä»è¡¨å †ä¸­è¯»å–æœ€æ–°ç‰ˆæœ¬çš„å…ƒç»„ï¼ˆbase_tupleï¼‰åŠå…¶å…ƒæ•°æ®ï¼ˆbase_metaï¼‰ã€‚ åˆå§‹åŒ– tuple_valuesï¼Œå­˜å‚¨å…ƒç»„çš„å­—æ®µå€¼ã€‚ è·å–æœ€æ–°å…ƒç»„ ä»è¡¨å †ä¸­è¯»å–æœ€æ–°ç‰ˆæœ¬çš„å…ƒç»„ï¼ˆbase_tupleï¼‰åŠå…¶å…ƒæ•°æ®ï¼ˆbase_metaï¼‰ã€‚ åˆå§‹åŒ– tuple_valuesï¼Œå­˜å‚¨å…ƒç»„çš„å­—æ®µå€¼ã€‚ éå† undo logs Undo logs æŒ‰æ—¶é—´æˆ³é™åºæ’åˆ—ï¼Œè®°å½•äº†å…ƒç»„çš„å†å²ä¿®æ”¹ã€‚ å¯¹äºæ¯ä¸ª undo logï¼š å¦‚æœ is_deleted_ ä¸º trueï¼Œæ ‡è®°å…ƒç»„ä¸ºå·²åˆ é™¤ã€‚ å¦åˆ™ï¼Œæ ¹æ® modified_fields_ æ›´æ–° tuple_values ä¸­å¯¹åº”å­—æ®µçš„å€¼ã€‚ï¼ˆæ‰€ä»¥è¿™é‡Œç±»ä¼¼äºå»è¦†ç›–æ›´æ–°ï¼‰ ç”Ÿæˆç»“æœå…ƒç»„ å¦‚æœå…ƒç»„è¢«æ ‡è®°ä¸ºåˆ é™¤ï¼Œè¿”å›ç©ºå€¼ã€‚ å¦åˆ™ï¼Œæ ¹æ®æ›´æ–°åçš„ tuple_values æ„é€ å¹¶è¿”å›æ–°çš„å…ƒç»„ã€‚ 2.2 Sequential Scan / Tuple Retrieval è¿™é‡Œçš„æ„å›¾å°±æ˜¯éœ€è¦åœ¨ bustub æ‰§è¡Œ seq executor ç®—å­æ—¶æ‰¾åˆ°å½“å‰äº‹åŠ¡å¯ä»¥ä½¿ç”¨çš„ tupleã€‚\nåˆ¤æ–­å½“å‰ tuple æ˜¯å¦å¯¹å½“å‰äº‹åŠ¡å¯è§:\ncase1ï¼štuple çš„ ts_ æ¯” txn_read_ts å°ï¼Œåˆ™ tuple å¯¹å½“å‰äº‹åŠ¡å¯è§ case2ï¼štuple çš„ ts_ ç­‰äº txn_temp_tsï¼Œåˆ™ tuple å¯¹å½“å‰äº‹åŠ¡å¯è§ case3ï¼šä¸æ»¡è¶³ case1 ä¹Ÿä¸æ»¡è¶³ case2ï¼Œåˆ™ tuple å¯¹å½“å‰äº‹åŠ¡ä¸å¯è§ å¦‚æœæ˜¯ case1 å’Œ case2ï¼Œè¯´æ˜å½“å‰äº‹åŠ¡å¯ä»¥ç›´æ¥ä½¿ç”¨ table heap ä¸­çš„è¿™æ¡ tupleï¼›è€Œå¦‚æœæ˜¯ case3ï¼Œåˆ™éœ€è¦éå†è¿™æ¡ tuple çš„ç‰ˆæœ¬é“¾ï¼Œæ‰¾å‡ºå¯ä»¥ç”¨çš„ undologï¼Œå¦‚æœæœ‰å°±ä½¿ç”¨ ReconstructTuple æ¥é‡å»ºä¸€ä¸ªå¯è§çš„å†å²ç‰ˆæœ¬çš„ tupleã€‚\n3. Task3 - MVCC Executors åœ¨æ’å…¥ä¸€æ¡è®°å½•æ—¶ï¼Œè¦æŠŠè¿™æ¡è®°å½•çš„ä¸»é”®å€¼è®°ä¸‹æ¥ï¼Œè¿™æ ·ä¹‹åå›æ»šæ—¶åªéœ€è¦æŠŠè¿™ä¸ªä¸»é”®å€¼å¯¹åº”çš„è®°å½•åˆ æ‰å°±å¥½äº†ï¼› åœ¨åˆ é™¤ä¸€æ¡è®°å½•æ—¶ï¼Œè¦æŠŠè¿™æ¡è®°å½•ä¸­çš„å†…å®¹éƒ½è®°ä¸‹æ¥ï¼Œè¿™æ ·ä¹‹åå›æ»šæ—¶å†æŠŠç”±è¿™äº›å†…å®¹ç»„æˆçš„è®°å½•æ’å…¥åˆ°è¡¨ä¸­å°±å¥½äº†ï¼› åœ¨æ›´æ–°ä¸€æ¡è®°å½•æ—¶ï¼Œè¦æŠŠè¢«æ›´æ–°çš„åˆ—çš„æ—§å€¼è®°ä¸‹æ¥ï¼Œè¿™æ ·ä¹‹åå›æ»šæ—¶å†æŠŠè¿™äº›åˆ—æ›´æ–°ä¸ºæ—§å€¼å°±å¥½äº†ã€‚ from å°æ—coding - ä¸ºä»€ä¹ˆéœ€è¦-undo-log\nç®€å•ç†è§£ï¼šæ”¹äº†ä»€ä¹ˆï¼Œä½ å°±ä¿å­˜ä»€ä¹ˆã€‚\nInsert åœ¨è¿™ä¸€æ­¥åªéœ€è¦å°†æ’å…¥çš„ tuple çš„ rid è®°å½•åˆ°äº‹åŠ¡ write set ä¸­ï¼Œç„¶ååœ¨ txn manager ä¸­è®¾ç½®æ–° tuple çš„ undolog é“¾ä¸ºç©ºï¼ˆç›¸å½“äºç»™è¿™ä¸ª undolog é“¾åˆå§‹åŒ–ï¼‰ã€‚\nä¸ºä»€ä¹ˆ Insert æ“ä½œä¸éœ€è¦ undo log\nåœ¨ MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰æœºåˆ¶ä¸‹ï¼Œæ¯ä¸ªäº‹åŠ¡çœ‹åˆ°çš„æ•°æ®ç‰ˆæœ¬å–å†³äºå…¶æ—¶é—´æˆ³ã€‚å¯¹äº INSERT æ“ä½œï¼Œç”±äºæ’å…¥çš„æ˜¯å…¨æ–°çš„è®°å½•ï¼Œä¸å­˜åœ¨â€œå†å²ç‰ˆæœ¬â€çš„é—®é¢˜ã€‚å› æ­¤ï¼Œä¸éœ€è¦ä¸º INSERT æ“ä½œç»´æŠ¤ Undo Log æ¥æ”¯æŒ MVCC ä¸­çš„ç‰ˆæœ¬é“¾ã€‚\nå½“æ‰§è¡Œä¸€ä¸ª INSERT æ“ä½œæ—¶ï¼Œå¦‚æœäº‹åŠ¡éœ€è¦å›æ»šï¼Œåªéœ€åˆ é™¤åˆšåˆšæ’å…¥çš„è®°å½•å³å¯ï¼Œè€Œæ— éœ€åƒ UPDATE æˆ– DELETE é‚£æ ·æ¢å¤æ—§æ•°æ®çŠ¶æ€ã€‚å› æ­¤ï¼ŒINSERT æ“ä½œåªéœ€è¦è®°å½•è¢«æ’å…¥è®°å½•çš„ä¸»é”®ä¿¡æ¯ï¼Œä»¥ä¾¿åœ¨å›æ»šæ—¶å®šä½å¹¶åˆ é™¤è¯¥è®°å½•ã€‚è¿™ç§æƒ…å†µä¸‹ï¼ŒUndo Log çš„ä½œç”¨éå¸¸æœ‰é™ï¼Œç”šè‡³å¯ä»¥çœç•¥ã€‚\nç›¸æ¯”ä¹‹ä¸‹ï¼ŒUPDATE å’Œ DELETE æ“ä½œä¼šåˆ›å»ºæ–°çš„ç‰ˆæœ¬æˆ–æ ‡è®°æ—§ç‰ˆæœ¬ä¸ºæ— æ•ˆï¼Œè¿™äº›éƒ½éœ€è¦é€šè¿‡ Undo Log æ¥è®°å½•å’Œç®¡ç†ã€‚\nUpdate \u0026 Delete åœ¨ä¿®æ”¹æ“ä½œï¼ˆupdate å’Œ deleteï¼‰ä¸­ï¼Œå¯¹äº tuple ä¸­çš„å­—æ®µæœ‰ä¸¤ç§æƒ…å†µï¼š\næƒ…å†µ 1ï¼ˆå½“å‰äº‹åŠ¡åœ¨æœªæäº¤å‰è¿›è¡Œäº†ä¿®æ”¹ï¼‰ï¼šç”±äºæ¯ä¸ªäº‹åŠ¡éƒ½å¯¹å½“å‰æ“ä½œçš„ tuple çš„ undolog åªèƒ½ä¿å­˜ä¸€ä»½ï¼Œå› æ­¤åœ¨ç”Ÿæˆæœ¬æ¬¡çš„ undolog åè¿˜éœ€è¦éœ€è¦åˆå¹¶ä¸Šä¸€æ¬¡çš„ undologã€‚ æƒ…å†µ 2ï¼ˆè¿™æ˜¯å½“å‰äº‹åŠ¡ç¬¬ä¸€æ¬¡ä¿®æ”¹ï¼‰ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ undologï¼Œå¹¶æŠŠå®ƒæ·»åŠ åˆ°ç‰ˆæœ¬é“¾ä¸­ã€‚ åœ¨å®Œæˆä¿®æ”¹æ“ä½œåï¼Œéœ€è¦æ›´æ–° table heap ä¸­çš„å€¼ï¼šä¿®æ”¹ tuple çš„æ•°æ®ä¸ºæ›´æ–°åçš„å€¼ï¼ŒåŒæ—¶æ›´æ–° tuple çš„ metaï¼Œå…¶æ—¶é—´æˆ³ä¸ºå½“å‰äº‹åŠ¡çš„ temp tsï¼ˆè¿™å¯ç”¨äºæ ‡è¯†è¿™ä¸ª tuple æ­£åœ¨è¢«å“ªä¸ªäº‹åŠ¡ä¿®æ”¹ï¼‰ï¼›ç„¶åè¿˜è¦å°†å½“å‰ä¿®æ”¹ tuple çš„ idï¼ˆä¹Ÿå°±æ˜¯å…¶ ridï¼‰æ·»åŠ åˆ°å½“å‰äº‹åŠ¡çš„ write setï¼Œè¿™åœ¨äº‹åŠ¡æäº¤æ—¶ä¼šæ ¹æ® rid æ¥æ­£ç¡®è®¾ç½® table heap ä¸­ tuple çš„ tsã€‚\nCommit åˆšåˆšè¯´åˆ°åœ¨ä¿®æ”¹æ—¶éœ€è¦ä¿®æ”¹ tuple çš„ meta æ•°æ®ä¸­çš„ ts ä¸ºå½“å‰äº‹åŠ¡çš„ temp tsï¼Œå› ä¸ºæ­¤æ—¶äº‹åŠ¡è¿˜æ²¡æäº¤ï¼Œä½¿ç”¨ temp ts å°±èƒ½åˆ†è¾¨å‡ºç°åœ¨è¿™æ¡ tuple æ˜¯å¦æ­£åœ¨è¢«ä¿®æ”¹ï¼štemp ts æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„æ•°ï¼ˆTXN_START_ID + txn_idï¼Œå…¶ä¸­ TXN_START_ID = 1LL \u003c\u003c 62ï¼‰ï¼Œäº‹åŠ¡çš„ read ts å’Œ commit ts éƒ½ä¼šå°äºè¿™ä¸ªæ•°ï¼›åœ¨åˆ¤æ–­ä¸€ä¸ª tuple æ˜¯å¦å¯è§æ—¶ï¼Œéƒ½æ˜¯é€šè¿‡äº‹åŠ¡çš„ read tsï¼ˆtxn.read_tsï¼‰ä¸ tuple.meta.ts è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœ tuple.meta.ts \u003c= txn.read_tsï¼Œé‚£ä¹ˆè¿™ä¸ª tuple å¯¹äº txn æ˜¯å¯è§çš„ï¼Œè€Œå¦‚æœ tuple.meta.ts == txn.temp_tsï¼Œåˆ™è¿™ä¸ª tuple æ­£åœ¨è¢« txn è¿›è¡Œä¿®æ”¹ã€‚\nè¿™æ ·çš„è¯ï¼Œå³ä¾¿æ˜¯åœ¨ä¿®æ”¹å tuple.meta.ts ä¹Ÿåªæ˜¯äº‹åŠ¡çš„ temp tsï¼Œæ‰€ä»¥åœ¨ commit æ—¶ï¼Œéœ€è¦å°†å…¶è®¾ç½®ä¸ºç³»ç»Ÿçš„æœ€æ–° commit tsã€‚è¿™é‡Œéœ€è¦åšå‡ ç‚¹ï¼š\nè·å–å½“å‰ç³»ç»Ÿçš„ commit tsï¼Œè®¡ç®—æ–¹å¼ä¸º last_commit_ts_ + 1 éå†å½“å‰è¦æäº¤çš„äº‹åŠ¡çš„ write setï¼Œæ›´æ–°ä¿®æ”¹äº†çš„ tuple çš„ meta æ•°æ®ï¼Œå°† meta.ts è®¾ç½®ä¸º commit ts è®¾ç½®äº‹åŠ¡çš„ commit tsï¼Œå¹¶ä¸”æ›´æ–°ç³»ç»Ÿçš„ last_commit_ts GarbageCollection ä¹‹å‰ä¸€æ—¦æˆ‘ä»¬å°†äº‹åŠ¡æ·»åŠ åˆ° txn manager ä¸­ï¼Œæˆ‘ä»¬å°±æ°¸è¿œä¸ä¼šåˆ é™¤å®ƒï¼Œå› ä¸º read_ts è¾ƒå°çš„äº‹åŠ¡å¯èƒ½éœ€è¦è¯»å–å­˜å‚¨åœ¨å…ˆå‰å·²æäº¤æˆ–å·²ä¸­æ­¢äº‹åŠ¡ä¸­çš„æ’¤é”€æ—¥å¿—ã€‚è¿™é‡Œéœ€è¦å®ç° TransactionManager::GarbageCollection() å‡½æ•°ï¼Œåˆ é™¤æœªä½¿ç”¨çš„äº‹åŠ¡ã€‚\nä¸€ä¸ªäº‹åŠ¡åœ¨è¿è¡Œæ—¶åªéœ€è¦çœ‹åˆ°å®ƒè‡ªå·±çš„å¿«ç…§ï¼Œä¸€æ—¦äº‹åŠ¡ç»“æŸï¼Œå®ƒæ‰€ä¾èµ–çš„æ•°æ®ç‰ˆæœ¬å°±å¯ä»¥è¢«è€ƒè™‘å›æ”¶ã€‚åªæœ‰å½“æŸä¸ªæ•°æ®ç‰ˆæœ¬ä¸å†è¢«ä»»ä½•æ´»è·ƒäº‹åŠ¡éœ€è¦æ—¶ï¼Œæ‰èƒ½è¿›è¡Œåƒåœ¾å›æ”¶ï¼ˆGCï¼‰ã€‚\nä¸¾ä¸ªğŸŒ°ï¼Œå‡è®¾æˆ‘ä»¬æœ‰å¦‚ä¸‹è®°å½•ï¼š\nRID ts_ æ•°æ® A 1 Alice A 2 Bob A 3 Charlie A 4 David è¿™è¡¨ç¤ºè®°å½• A è¢«ä¸åŒäº‹åŠ¡æ›´æ–°äº†å››æ¬¡ã€‚ç°åœ¨ç³»ç»Ÿä¸­æœ‰ä¸‰ä¸ªäº‹åŠ¡ï¼š\näº‹åŠ¡ ID çŠ¶æ€ å¯è§æ€§èŒƒå›´ T2 RUNNING ts â‰¤ 2 T4 RUNNING ts â‰¤ 4 T5 RUNNING ts â‰¤ 5 watermark = 2ï¼ˆæœ€å°æ´»è·ƒäº‹åŠ¡ IDï¼‰\nQ1: T5 èƒ½çœ‹åˆ° ts_=1 çš„æ•°æ®å—ï¼Ÿ\næ²¡é—®é¢˜ï¼Œå› ä¸º T5 çš„ ts=5 \u003e 1ï¼Œä¸”äº‹åŠ¡ 1 å·²å®Œæˆã€‚\nQ2: ts_=1 çš„æ•°æ®å¯ä»¥è¢«æ¸…ç†å—ï¼Ÿ\nä¸å¯ä»¥ï¼Œå› ä¸º T2ï¼ˆts=2ï¼‰è¿˜åœ¨è¿è¡Œï¼Œå®ƒçš„å¯è§èŒƒå›´æ˜¯ ts â‰¤ 2ï¼Œæ‰€ä»¥å®ƒå¯èƒ½ä¼šè®¿é—® ts=1 çš„æ•°æ®ã€‚\nQ3: å¦‚æœ T2 æäº¤æˆ–ä¸­æ­¢ï¼Œwatermark ä¼šå˜æˆå¤šå°‘ï¼Ÿæ­¤æ—¶ ts=1 çš„æ•°æ®èƒ½è¢«æ¸…ç†å—ï¼Ÿ\nwatermark æ›´æ–°ä¸º min(4,5) = 4 æ­¤æ—¶æ‰€æœ‰æ´»è·ƒäº‹åŠ¡çš„ ts â‰¥ 4 æ‰€ä»¥ ts â‰¤ 3 çš„æ•°æ®éƒ½å¯¹æ´»è·ƒäº‹åŠ¡ä¸å¯è§ â†’ å¯ä»¥å®‰å…¨æ¸…ç† è¿™é‡Œæœ‰ä¸€ä¸ªå…³é”®ç‚¹ï¼šå¯è§ â‰  ä¸å¯æ¸…ç†\nå¯è§æ€§ï¼šè¡¨ç¤ºæŸä¸ªäº‹åŠ¡æ˜¯å¦èƒ½çœ‹åˆ°æŸæ¡è®°å½•ï¼ˆæ¯”å¦‚ T5 èƒ½çœ‹åˆ° ts_=3 çš„è®°å½•ï¼‰ æ¸…ç†æ¡ä»¶ï¼šè¡¨ç¤ºè¿™æ¡è®°å½•æ˜¯å¦ä»ç„¶è¢«ä»»ä½•ä¸€ä¸ªæ´»è·ƒäº‹åŠ¡æ‰€éœ€è¦ï¼Œå¦‚æœæ²¡æœ‰ä»»ä½•æ´»è·ƒäº‹åŠ¡å†è®¿é—®å®ƒï¼Œå°±å¯ä»¥æ¸…ç† æ‰€ä»¥ GC çš„æ­¥éª¤å¯ä»¥ç®€å•æ€»ç»“å¦‚ä¸‹ï¼š\néå†æ•°æ®åº“ä¸­æ‰€æœ‰ tuple åˆ¤æ–­ tuple.ts_ â‰¤ watermark â†’ ä¸å†è¢«æ´»è·ƒäº‹åŠ¡è®¿é—® æ²¿ç€ undo link éå† undo log é“¾ ç»Ÿè®¡æ¯ä¸ªäº‹åŠ¡æœ‰å¤šå°‘ undo log ä¸å†è¢«è®¿é—® å¦‚æœæŸä¸ªäº‹åŠ¡æ‰€æœ‰ undo log éƒ½ä¸å¯è§ï¼Œä¸”äº‹åŠ¡å·²å®Œæˆ â†’ åˆ é™¤å…¶ undo log å’Œäº‹åŠ¡å…ƒä¿¡æ¯ References https://blog.csdn.net/weixin_48885685/article/details/143225977 https://github.com/ZepengLi111/cmu15445-2023-fall-bustub Qwen ChatGPT ","wordCount":"735","inLanguage":"en","image":"https://kerolt.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2025-05-06T00:00:00Z","dateModified":"2025-05-06T00:00:00Z","author":{"@type":"Person","name":"Kerolt"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://kerolt.github.io/posts/%E6%95%B0%E6%8D%AE%E5%BA%93/cmu15-445-fall2023project4-concurrency-control-%E5%B0%8F%E7%BB%93/"},"publisher":{"@type":"Organization","name":"Kerolt's Blog","logo":{"@type":"ImageObject","url":"https://kerolt.github.io/images/avatar/favicon.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://kerolt.github.io/ accesskey=h title="Kerolt's Blog (Alt + H)">Kerolt's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://kerolt.github.io/posts/ title=æ–‡ç« ><span>æ–‡ç« </span></a></li><li><a href=https://kerolt.github.io/categories/ title=åˆ†ç±»><span>åˆ†ç±»</span></a></li><li><a href=https://kerolt.github.io/tags/ title=æ ‡ç­¾><span>æ ‡ç­¾</span></a></li><li><a href=https://kerolt.github.io/archives/ title=å½’æ¡£><span>å½’æ¡£</span></a></li><li><a href=https://kerolt.github.io/about/ title=å…³äºæˆ‘><span>å…³äºæˆ‘</span></a></li><li><a href=https://kerolt.github.io/search/ title="ğŸ” (Alt + /)" accesskey=/><span>ğŸ”</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://kerolt.github.io/>Home</a>&nbsp;Â»&nbsp;<a href=https://kerolt.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">ã€CMU15-445 Fall2023ã€‘Project4 Concurrency Control å°ç»“</h1><div class=post-meta><span title='2025-05-06 00:00:00 +0000 UTC'>å‘å¸ƒäº2025-05-06</span>&nbsp;&nbsp;Â·&nbsp;&nbsp;Kerolt</div><ul class=post-tags><li><a href=https://kerolt.github.io/tags/cplusplus/>CPlusPlus</a></li><li><a href=https://kerolt.github.io/tags/database/>Database</a></li><li><a href=https://kerolt.github.io/tags/cmu-15445/>CMU-15445</a></li></ul></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#0-bustub-%e4%b8%ad%e7%9a%84-undolog aria-label="0. Bustub ä¸­çš„ undolog">0. Bustub ä¸­çš„ undolog</a></li><li><a href=#1-task-1---timestamps aria-label="1. Task 1 - Timestamps">1. Task 1 - Timestamps</a></li><li><a href=#2-task2---storage-format-and-sequential-scan aria-label="2. Task2 - Storage Format and Sequential Scan">2. Task2 - Storage Format and Sequential Scan</a><ul><li><a href=#21-tuple-reconstruction aria-label="2.1 Tuple Reconstruction">2.1 Tuple Reconstruction</a></li><li><a href=#22-sequential-scan--tuple-retrieval aria-label="2.2 Sequential Scan / Tuple Retrieval">2.2 Sequential Scan / Tuple Retrieval</a></li></ul></li><li><a href=#3-task3---mvcc-executors aria-label="3. Task3 - MVCC Executors">3. Task3 - MVCC Executors</a><ul><li><a href=#insert aria-label=Insert>Insert</a></li><li><a href=#update--delete aria-label="Update & Delete">Update & Delete</a></li><li><a href=#commit aria-label=Commit>Commit</a></li><li><a href=#garbagecollection aria-label=GarbageCollection>GarbageCollection</a></li></ul></li><li><a href=#references aria-label=References>References</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><p>è¿™ä¸ª project ä¸»è¦æ˜¯å¸Œæœ›æˆ‘ä»¬ç†è§£ MVCC çš„ä¸€äº›ç›¸å…³çŸ¥è¯†ã€‚MVCC çš„è®¾è®¡ç›®æ ‡æ˜¯é€šè¿‡ç»´æŠ¤å¤šä¸ªç‰ˆæœ¬çš„å…ƒç»„ï¼ˆtupleï¼‰ï¼Œä½¿å¾—ä¸åŒçš„äº‹åŠ¡èƒ½å¤Ÿè®¿é—®åˆ°ä¸å…¶æ—¶é—´æˆ³ä¸€è‡´çš„æ•°æ®ç‰ˆæœ¬ï¼Œè€Œæ— éœ€é€šè¿‡é”æœºåˆ¶å®Œå…¨é˜»å¡å…¶ä»–äº‹åŠ¡çš„æ“ä½œã€‚å…·ä½“æ¥è¯´ï¼š</p><ul><li>æ¯ä¸ªäº‹åŠ¡åœ¨å¯åŠ¨æ—¶ä¼šè¢«åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„ äº‹åŠ¡ ID æˆ– è¯»å–æ—¶é—´æˆ³ ã€‚</li><li>æ•°æ®åº“ç³»ç»Ÿä¼šæ ¹æ®äº‹åŠ¡çš„è¯»å–æ—¶é—´æˆ³ï¼Œå†³å®šè¯¥äº‹åŠ¡èƒ½çœ‹åˆ°å“ªäº›æ•°æ®ç‰ˆæœ¬ï¼š</li><li>å¯è§æ€§è§„åˆ™ ï¼šäº‹åŠ¡åªèƒ½çœ‹åˆ°åœ¨å…¶è¯»å–æ—¶é—´æˆ³ä¹‹å‰æäº¤çš„æ•°æ®ç‰ˆæœ¬ã€‚</li><li>ä¸å¯è§æ€§è§„åˆ™ ï¼šäº‹åŠ¡ä¸èƒ½çœ‹åˆ°åœ¨å…¶è¯»å–æ—¶é—´æˆ³ä¹‹åæäº¤æˆ–æœªæäº¤çš„æ•°æ®ç‰ˆæœ¬ã€‚</li></ul><blockquote><p>15445 çš„ lab å†™äº†å¤ªä¹…å¤ªä¹…äº†ï¼Œè‡ªå·±æ‡’æ˜¯ä¸€æ–¹é¢ï¼Œå®åŠ›ä¸å¤Ÿä¹Ÿæ˜¯ä¸€æ–¹é¢ï¼Œtask4 åé¢çš„ lab å°±ä¸æ‰“ç®—å†™äº†ï¼ˆæ— å¥ˆ.jpgï¼‰ã€‚åœ¨è¿™æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œå­¦åˆ°çš„ä¸œè¥¿è¿˜æŒºå¤šçš„ï¼Œå¯¹äºä»£ç èƒ½åŠ›ä¹Ÿæœ‰æå‡ï¼Œä»¥åæœ‰æ—¶é—´è¿˜æ˜¯å¯ä»¥å¤šçœ‹çœ‹é…å¥—çš„è¯¾ç¨‹ï¼Œç„¶åå†å¥½å¥½è¯»è¯»ä»£ç ï¼Œå†™å†™æ³¨é‡Šå’Œåšå®¢å»æ·±å…¥ç†è§£ç†è§£ï¼Œæ¯•ç«Ÿ bustub çš„ä¸è®ºæ˜¯ä»£ç æ¶æ„è¿˜æ˜¯è§„èŒƒæˆ‘éƒ½è§‰å¾—éå¸¸æ£’ã€‚åé¢å°±è¦åƒ 15445 ç½‘é¡µä¸­å†™åˆ°çš„ï¼Œå»å¤šå…³æ³¨ç”Ÿæ´»ä¸­å…¶ä»–æ„Ÿå…´è¶£çš„åœ°æ–¹äº†ï¼Œå¸Œæœ›èƒ½å¤Ÿä¸æ–­æå‡è‡ªå·±~</p></blockquote><h2 id=0-bustub-ä¸­çš„-undolog>0. Bustub ä¸­çš„ undolog<a hidden class=anchor aria-hidden=true href=#0-bustub-ä¸­çš„-undolog>#</a></h2><p>bustub ä¸­åœ¨ TransactionManager ä¸­é€šè¿‡ä¸€ä¸ªå“ˆå¸Œè¡¨æ¥ä¿å­˜æ‰€æœ‰ tuple çš„ undolog èµ·ç‚¹ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#069;font-weight:700>class</span> <span style=color:#0a8;font-weight:700>TransactionManager</span> {
</span></span><span style=display:flex><span> <span style=color:#069;font-weight:700>public</span><span style=color:#555>:</span>
</span></span><span style=display:flex><span>   ...
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>   <span style=color:#069;font-weight:700>struct</span> <span style=color:#0a8;font-weight:700>PageVersionInfo</span> {
</span></span><span style=display:flex><span>    <span style=color:#09f;font-style:italic>/** protects the map */</span>
</span></span><span style=display:flex><span>    std<span style=color:#555>::</span>shared_mutex mutex_;
</span></span><span style=display:flex><span>    <span style=color:#09f;font-style:italic>/** Stores previous version info for all slots. Note: DO NOT use `[x]` to access it because
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>     * it will create new elements even if it does not exist. Use `find` instead.
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    std<span style=color:#555>::</span>unordered_map<span style=color:#555>&lt;</span>slot_offset_t, VersionUndoLink<span style=color:#555>&gt;</span> prev_version_;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>/** protects version info */</span>
</span></span><span style=display:flex><span>  std<span style=color:#555>::</span>shared_mutex version_info_mutex_;
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>/** Stores the previous version of each tuple in the table heap. Do not directly access this field. Use the helper
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>   * functions in `transaction_manager_impl.cpp`. */</span>
</span></span><span style=display:flex><span>  std<span style=color:#555>::</span>unordered_map<span style=color:#555>&lt;</span>page_id_t, std<span style=color:#555>::</span>shared_ptr<span style=color:#555>&lt;</span>PageVersionInfo<span style=color:#555>&gt;&gt;</span> version_info_;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å…¶ä¸­çš„ VersionUndoLink ä¹Ÿåªæ˜¯å¯¹ UndoLink çš„ä¸€ä¸ªåŒ…è£…ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#069;font-weight:700>struct</span> <span style=color:#0a8;font-weight:700>UndoLink</span> {
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>/* Previous version can be found in which txn */</span>
</span></span><span style=display:flex><span>  txn_id_t prev_txn_{INVALID_TXN_ID};
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>/* The log index of the previous version in `prev_txn_` */</span>
</span></span><span style=display:flex><span>  <span style=color:#078;font-weight:700>int</span> prev_log_idx_{<span style=color:#f60>0</span>};
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>struct</span> <span style=color:#0a8;font-weight:700>VersionUndoLink</span> {
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>/** The next version in the version chain. */</span>
</span></span><span style=display:flex><span>  UndoLink prev_;
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>/** Whether a transaction is modifying the version link. Fall 2023: you do not need to read / write this field until
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>   * task 4.2. */</span>
</span></span><span style=display:flex><span>  <span style=color:#078;font-weight:700>bool</span> in_progress_{<span style=color:#366>false</span>};
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>ä¸€ä¸ª tuple æœ€æ–°çš„æ•°æ®ä¼šä¿å­˜åœ¨ table heap ä¸­ï¼Œè€Œ txn manager é€šè¿‡è¿™ä¸ª tuple çš„ rid å¯ä»¥è·å–åˆ°è¿™ä¸ª tuple çš„ undologï¼š</p><p><code>exec_ctx_->GetTransactionManager()->GetUndoLink(rid);</code></p><p><div class=post-img-view><a data-fancybox=gallery href="https://picx.zhimg.com/80/v2-ae68d292fedbec77059813d8864a5b5e_720w.png?source=d16d100b"><img src="https://picx.zhimg.com/80/v2-ae68d292fedbec77059813d8864a5b5e_720w.png?source=d16d100b" alt></a></div></p><p><div class=post-img-view><a data-fancybox=gallery href="https://picx.zhimg.com/80/v2-687a70512a629a68730b20eae0096a01_720w.png?source=d16d100b"><img src="https://picx.zhimg.com/80/v2-687a70512a629a68730b20eae0096a01_720w.png?source=d16d100b" alt></a></div></p><h2 id=1-task-1---timestamps>1. Task 1 - Timestamps<a hidden class=anchor aria-hidden=true href=#1-task-1---timestamps>#</a></h2><p>æ¯ä¸ªäº‹åŠ¡æœ‰ä¸¤ä¸ªæ—¶é—´æˆ³ï¼š</p><ul><li><code>read_ts</code>ï¼šäº‹åŠ¡å¼€å§‹æ—¶åˆ†é…ï¼Œè¡¨ç¤ºè¯¥äº‹åŠ¡èƒ½çœ‹åˆ°çš„æœ€æ–°æäº¤çš„æ•°æ®ç‰ˆæœ¬ã€‚</li><li><code>commit_ts</code>ï¼šäº‹åŠ¡æäº¤æ—¶åˆ†é…ï¼Œæ˜¯ä¸€ä¸ªå•è°ƒé€’å¢çš„é€»è¾‘æ—¶é—´æˆ³ï¼Œå†³å®šäº‹åŠ¡çš„ä¸²è¡ŒåŒ–é¡ºåºã€‚</li></ul><p>è§„åˆ™å¦‚ä¸‹ï¼š</p><ul><li>äº‹åŠ¡å¼€å§‹æ—¶ï¼ˆBeginï¼‰ï¼Œ<code>read_ts = last_commit_ts</code></li><li>äº‹åŠ¡æäº¤æ—¶ï¼ˆCommitï¼‰ï¼Œ<code>commit_ts = ++last_commit_ts</code></li></ul><p>å¯¹äº Watermark æœºåˆ¶ï¼Œå…¶å®šä¹‰æ˜¯æ‰€æœ‰æ´»è·ƒäº‹åŠ¡ä¸­çš„æœ€å° read_tsï¼Œä½œç”¨ä¸ºç¡®å®šå“ªäº›æ•°æ®ç‰ˆæœ¬å·²ç»ä¸å†è¢«ä»»ä½•äº‹åŠ¡è¯»å–ï¼Œä»è€Œå¯ä»¥å®‰å…¨åœ°æ¸…ç†æ—§ç‰ˆæœ¬æ•°æ®ã€‚</p><p>è¿™é‡Œå¾ˆç®€å•ï¼Œå°±æ˜¯éœ€è¦åœ¨ç»´æŠ¤å¥½ç³»ç»Ÿä¸­çš„ watermarkï¼Œéå†äº‹åŠ¡æ˜ å°„ä¸­çš„æ‰€æœ‰äº‹åŠ¡ï¼Œæ‰¾å‡ºæ‰€æœ‰è¿›è¡Œä¸­äº‹åŠ¡ä¸­æœ€å°çš„ read_ts ä¸º watermarkã€‚åœ¨äº‹åŠ¡çš„ Beginã€Commitã€Abort ä¸­éœ€è¦ä½¿ç”¨ Watermark::AddTxn å’Œ Watermark::RemoveTxn æ¥æ›´æ–° watermarkã€‚åœ¨æ›´æ–°æ—¶ï¼Œå¯ä»¥ä½¿ç”¨çº¢é»‘æ ‘æˆ–è€…å“ˆå¸Œè¡¨ + ä¼˜å…ˆé˜Ÿåˆ—æ¥å¿«é€Ÿæ‰¾åˆ°æœ€å°çš„ read_tsã€‚</p><h2 id=2-task2---storage-format-and-sequential-scan>2. Task2 - Storage Format and Sequential Scan<a hidden class=anchor aria-hidden=true href=#2-task2---storage-format-and-sequential-scan>#</a></h2><h3 id=21-tuple-reconstruction>2.1 Tuple Reconstruction<a hidden class=anchor aria-hidden=true href=#21-tuple-reconstruction>#</a></h3><p>æ•°æ®åº“éœ€è¦ä¸€ç§æœºåˆ¶æ¥â€œå›æº¯â€æ•°æ®çš„å†å²ç‰ˆæœ¬ï¼Œè€Œ ReconstructTuple æ­£æ˜¯è¿™ç§æœºåˆ¶çš„æ ¸å¿ƒå®ç°ã€‚</p><p>åœ¨ MVCC ç³»ç»Ÿä¸­ï¼Œè¡¨å †ï¼ˆtable heapï¼‰é€šå¸¸å­˜å‚¨çš„æ˜¯æœ€æ–°çš„æ•°æ®ç‰ˆæœ¬ï¼Œè€Œæ—§ç‰ˆæœ¬çš„å…ƒç»„ä¿¡æ¯åˆ™é€šè¿‡ undo logs è®°å½•ä¸‹æ¥ã€‚å½“äº‹åŠ¡éœ€è¦è®¿é—®æŸä¸ªå…ƒç»„çš„å†å²ç‰ˆæœ¬æ—¶ï¼ŒReconstructTuple ä¼šä»è¡¨å †ä¸­è·å–æœ€æ–°çš„å…ƒç»„ï¼Œå¹¶æ ¹æ® undo logs é€æ­¥æ¢å¤å‡ºç¬¦åˆäº‹åŠ¡è¯»å–æ—¶é—´æˆ³çš„ç‰ˆæœ¬ã€‚</p><p>åœ¨ MVCC ç³»ç»Ÿä¸­ï¼Œæ•°æ®çš„åˆ é™¤æ“ä½œå¹¶ä¸ä¼šç«‹å³ä»è¡¨å †ä¸­ç§»é™¤å…ƒç»„ï¼Œè€Œæ˜¯é€šè¿‡è®¾ç½® is_deleted æ ‡å¿—æ¥æ ‡è®°é€»è¾‘åˆ é™¤ã€‚ReconstructTuple åœ¨å¤„ç† undo logs æ—¶ä¼šæ£€æŸ¥ is_deleted æ ‡å¿—ï¼Œä»è€Œåˆ¤æ–­æŸä¸ªå…ƒç»„æ˜¯å¦å·²è¢«åˆ é™¤ã€‚ReconstructTuple å°†å§‹ç»ˆåº”ç”¨æä¾›ç»™å‡½æ•°çš„æ‰€æœ‰ä¿®æ”¹ï¼Œè€Œæ— éœ€æŸ¥çœ‹å…ƒæ•°æ®æˆ–æ’¤é”€æ—¥å¿—ä¸­çš„æ—¶é—´æˆ³ã€‚é™¤äº†å‡½æ•°å‚æ•°åˆ—è¡¨ä¸­æä¾›çš„æ•°æ®å¤–ï¼Œå®ƒä¸éœ€è¦è®¿é—®å…¶ä»–æ•°æ®ã€‚</p><p><div class=post-img-view><a data-fancybox=gallery href="https://pic1.zhimg.com/80/v2-5279e94ec6c3adf36a4adfcaba7cbad6_720w.png?source=d16d100b"><img src="https://pic1.zhimg.com/80/v2-5279e94ec6c3adf36a4adfcaba7cbad6_720w.png?source=d16d100b" alt></a></div></p><p>undo log è®°å½•çš„æ˜¯ä¸Šæ¬¡æ“ä½œå®Œçš„ç»“æœï¼ˆæ¢å¥è¯è¯´ï¼Œè¿™æ¬¡æ²¡æ“ä½œå‰æ˜¯ä»€ä¹ˆæ ·å­ï¼‰ï¼Œåªæœ‰ modified_fields_ æ˜¯ä¸ºäº†å‘Šè¯‰è¿™æ¬¡æ“ä½œï¼Œåœ¨ä¸Šæ¬¡ä¿®æ”¹å®Œæˆä¹‹å‰ tuple æ˜¯ä»€ä¹ˆæ ·å­ã€‚</p><ul><li><code>modified_fields_</code>ï¼šé•¿åº¦ä¸ tuple çš„ schema ç›¸åŒï¼Œæ¯ä¸ªä½ä»£è¡¨åœ¨è¿™æ¬¡çš„æ“ä½œä¸­å¯¹äºæŸä¸ªå­—æ®µæ—¶å€™æœ‰æ›´æ–°</li><li><code>tuple_</code>ï¼šå…¶é•¿åº¦ &lt;= åŸå§‹çš„ tupleï¼Œåªè®°å½•äº† modified_fields_ ä¸­ä¸º true çš„å­—æ®µï¼Œå¹¶ä¸”ä¿å­˜çš„å€¼æ˜¯æœ¬æ¬¡æ“ä½œä¹‹å‰çš„å€¼</li></ul><p><code>ReconstructTuple</code> çš„å·¥ä½œæµç¨‹ï¼š</p><ul><li>ä»è¡¨å †ä¸­è¯»å–æœ€æ–°ç‰ˆæœ¬çš„å…ƒç»„ï¼ˆbase_tupleï¼‰åŠå…¶å…ƒæ•°æ®ï¼ˆbase_metaï¼‰ã€‚</li><li>åˆå§‹åŒ– tuple_valuesï¼Œå­˜å‚¨å…ƒç»„çš„å­—æ®µå€¼ã€‚</li></ul><ol><li>è·å–æœ€æ–°å…ƒç»„<ol><li>ä»è¡¨å †ä¸­è¯»å–æœ€æ–°ç‰ˆæœ¬çš„å…ƒç»„ï¼ˆbase_tupleï¼‰åŠå…¶å…ƒæ•°æ®ï¼ˆbase_metaï¼‰ã€‚</li><li>åˆå§‹åŒ– tuple_valuesï¼Œå­˜å‚¨å…ƒç»„çš„å­—æ®µå€¼ã€‚</li></ol></li><li>éå† undo logs<ol><li>Undo logs æŒ‰æ—¶é—´æˆ³é™åºæ’åˆ—ï¼Œè®°å½•äº†å…ƒç»„çš„å†å²ä¿®æ”¹ã€‚</li><li>å¯¹äºæ¯ä¸ª undo logï¼š<ol><li>å¦‚æœ is_deleted_ ä¸º trueï¼Œæ ‡è®°å…ƒç»„ä¸ºå·²åˆ é™¤ã€‚</li></ol></li><li>å¦åˆ™ï¼Œæ ¹æ® modified_fields_ æ›´æ–° tuple_values ä¸­å¯¹åº”å­—æ®µçš„å€¼ã€‚ï¼ˆæ‰€ä»¥è¿™é‡Œç±»ä¼¼äºå»è¦†ç›–æ›´æ–°ï¼‰</li></ol></li><li>ç”Ÿæˆç»“æœå…ƒç»„<ol><li>å¦‚æœå…ƒç»„è¢«æ ‡è®°ä¸ºåˆ é™¤ï¼Œè¿”å›ç©ºå€¼ã€‚</li><li>å¦åˆ™ï¼Œæ ¹æ®æ›´æ–°åçš„ tuple_values æ„é€ å¹¶è¿”å›æ–°çš„å…ƒç»„ã€‚</li></ol></li></ol><h3 id=22-sequential-scan--tuple-retrieval>2.2 Sequential Scan / Tuple Retrieval<a hidden class=anchor aria-hidden=true href=#22-sequential-scan--tuple-retrieval>#</a></h3><p>è¿™é‡Œçš„æ„å›¾å°±æ˜¯éœ€è¦åœ¨ bustub æ‰§è¡Œ seq executor ç®—å­æ—¶æ‰¾åˆ°å½“å‰äº‹åŠ¡å¯ä»¥ä½¿ç”¨çš„ tupleã€‚</p><p>åˆ¤æ–­å½“å‰ tuple æ˜¯å¦å¯¹å½“å‰äº‹åŠ¡å¯è§:</p><ul><li>case1ï¼štuple çš„ ts_ æ¯” txn_read_ts å°ï¼Œåˆ™ tuple å¯¹å½“å‰äº‹åŠ¡å¯è§</li><li>case2ï¼štuple çš„ ts_ ç­‰äº txn_temp_tsï¼Œåˆ™ tuple å¯¹å½“å‰äº‹åŠ¡å¯è§</li><li>case3ï¼šä¸æ»¡è¶³ case1 ä¹Ÿä¸æ»¡è¶³ case2ï¼Œåˆ™ tuple å¯¹å½“å‰äº‹åŠ¡ä¸å¯è§</li></ul><p>å¦‚æœæ˜¯ case1 å’Œ case2ï¼Œè¯´æ˜å½“å‰äº‹åŠ¡å¯ä»¥ç›´æ¥ä½¿ç”¨ table heap ä¸­çš„è¿™æ¡ tupleï¼›è€Œå¦‚æœæ˜¯ case3ï¼Œåˆ™éœ€è¦éå†è¿™æ¡ tuple çš„ç‰ˆæœ¬é“¾ï¼Œæ‰¾å‡ºå¯ä»¥ç”¨çš„ undologï¼Œå¦‚æœæœ‰å°±ä½¿ç”¨ ReconstructTuple æ¥é‡å»ºä¸€ä¸ªå¯è§çš„å†å²ç‰ˆæœ¬çš„ tupleã€‚</p><h2 id=3-task3---mvcc-executors>3. Task3 - MVCC Executors<a hidden class=anchor aria-hidden=true href=#3-task3---mvcc-executors>#</a></h2><blockquote><p>åœ¨æ’å…¥ä¸€æ¡è®°å½•æ—¶ï¼Œè¦æŠŠè¿™æ¡è®°å½•çš„ä¸»é”®å€¼è®°ä¸‹æ¥ï¼Œè¿™æ ·ä¹‹åå›æ»šæ—¶åªéœ€è¦æŠŠè¿™ä¸ªä¸»é”®å€¼å¯¹åº”çš„è®°å½•åˆ æ‰å°±å¥½äº†ï¼› åœ¨åˆ é™¤ä¸€æ¡è®°å½•æ—¶ï¼Œè¦æŠŠè¿™æ¡è®°å½•ä¸­çš„å†…å®¹éƒ½è®°ä¸‹æ¥ï¼Œè¿™æ ·ä¹‹åå›æ»šæ—¶å†æŠŠç”±è¿™äº›å†…å®¹ç»„æˆçš„è®°å½•æ’å…¥åˆ°è¡¨ä¸­å°±å¥½äº†ï¼› åœ¨æ›´æ–°ä¸€æ¡è®°å½•æ—¶ï¼Œè¦æŠŠè¢«æ›´æ–°çš„åˆ—çš„æ—§å€¼è®°ä¸‹æ¥ï¼Œè¿™æ ·ä¹‹åå›æ»šæ—¶å†æŠŠè¿™äº›åˆ—æ›´æ–°ä¸ºæ—§å€¼å°±å¥½äº†ã€‚ from <a href=https://xiaolincoding.com/mysql/log/how_update.html#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81-undo-log>å°æ—coding - ä¸ºä»€ä¹ˆéœ€è¦-undo-log</a></p></blockquote><p>ç®€å•ç†è§£ï¼šæ”¹äº†ä»€ä¹ˆï¼Œä½ å°±ä¿å­˜ä»€ä¹ˆã€‚</p><h3 id=insert>Insert<a hidden class=anchor aria-hidden=true href=#insert>#</a></h3><p>åœ¨è¿™ä¸€æ­¥åªéœ€è¦å°†æ’å…¥çš„ tuple çš„ rid è®°å½•åˆ°äº‹åŠ¡ write set ä¸­ï¼Œç„¶ååœ¨ txn manager ä¸­è®¾ç½®æ–° tuple çš„ undolog é“¾ä¸ºç©ºï¼ˆç›¸å½“äºç»™è¿™ä¸ª undolog é“¾åˆå§‹åŒ–ï¼‰ã€‚</p><blockquote><p>ä¸ºä»€ä¹ˆ Insert æ“ä½œä¸éœ€è¦ undo log</p></blockquote><p>åœ¨ MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰æœºåˆ¶ä¸‹ï¼Œæ¯ä¸ªäº‹åŠ¡çœ‹åˆ°çš„æ•°æ®ç‰ˆæœ¬å–å†³äºå…¶æ—¶é—´æˆ³ã€‚å¯¹äº INSERT æ“ä½œï¼Œç”±äºæ’å…¥çš„æ˜¯å…¨æ–°çš„è®°å½•ï¼Œä¸å­˜åœ¨â€œå†å²ç‰ˆæœ¬â€çš„é—®é¢˜ã€‚å› æ­¤ï¼Œä¸éœ€è¦ä¸º INSERT æ“ä½œç»´æŠ¤ Undo Log æ¥æ”¯æŒ MVCC ä¸­çš„ç‰ˆæœ¬é“¾ã€‚</p><p>å½“æ‰§è¡Œä¸€ä¸ª INSERT æ“ä½œæ—¶ï¼Œå¦‚æœäº‹åŠ¡éœ€è¦å›æ»šï¼Œåªéœ€åˆ é™¤åˆšåˆšæ’å…¥çš„è®°å½•å³å¯ï¼Œè€Œæ— éœ€åƒ UPDATE æˆ– DELETE é‚£æ ·æ¢å¤æ—§æ•°æ®çŠ¶æ€ã€‚å› æ­¤ï¼ŒINSERT æ“ä½œåªéœ€è¦è®°å½•è¢«æ’å…¥è®°å½•çš„ä¸»é”®ä¿¡æ¯ï¼Œä»¥ä¾¿åœ¨å›æ»šæ—¶å®šä½å¹¶åˆ é™¤è¯¥è®°å½•ã€‚è¿™ç§æƒ…å†µä¸‹ï¼ŒUndo Log çš„ä½œç”¨éå¸¸æœ‰é™ï¼Œç”šè‡³å¯ä»¥çœç•¥ã€‚</p><p>ç›¸æ¯”ä¹‹ä¸‹ï¼ŒUPDATE å’Œ DELETE æ“ä½œä¼šåˆ›å»ºæ–°çš„ç‰ˆæœ¬æˆ–æ ‡è®°æ—§ç‰ˆæœ¬ä¸ºæ— æ•ˆï¼Œè¿™äº›éƒ½éœ€è¦é€šè¿‡ Undo Log æ¥è®°å½•å’Œç®¡ç†ã€‚</p><h3 id=update--delete>Update & Delete<a hidden class=anchor aria-hidden=true href=#update--delete>#</a></h3><p>åœ¨ä¿®æ”¹æ“ä½œï¼ˆupdate å’Œ deleteï¼‰ä¸­ï¼Œå¯¹äº tuple ä¸­çš„å­—æ®µæœ‰ä¸¤ç§æƒ…å†µï¼š</p><ol><li>æƒ…å†µ 1ï¼ˆå½“å‰äº‹åŠ¡åœ¨æœªæäº¤å‰è¿›è¡Œäº†ä¿®æ”¹ï¼‰ï¼šç”±äºæ¯ä¸ªäº‹åŠ¡éƒ½å¯¹å½“å‰æ“ä½œçš„ tuple çš„ undolog åªèƒ½ä¿å­˜ä¸€ä»½ï¼Œå› æ­¤åœ¨ç”Ÿæˆæœ¬æ¬¡çš„ undolog åè¿˜éœ€è¦éœ€è¦åˆå¹¶ä¸Šä¸€æ¬¡çš„ undologã€‚</li><li>æƒ…å†µ 2ï¼ˆè¿™æ˜¯å½“å‰äº‹åŠ¡ç¬¬ä¸€æ¬¡ä¿®æ”¹ï¼‰ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ undologï¼Œå¹¶æŠŠå®ƒæ·»åŠ åˆ°ç‰ˆæœ¬é“¾ä¸­ã€‚</li></ol><p>åœ¨å®Œæˆä¿®æ”¹æ“ä½œåï¼Œéœ€è¦æ›´æ–° table heap ä¸­çš„å€¼ï¼šä¿®æ”¹ tuple çš„æ•°æ®ä¸ºæ›´æ–°åçš„å€¼ï¼ŒåŒæ—¶æ›´æ–° tuple çš„ metaï¼Œå…¶æ—¶é—´æˆ³ä¸ºå½“å‰äº‹åŠ¡çš„ temp tsï¼ˆè¿™å¯ç”¨äºæ ‡è¯†è¿™ä¸ª tuple æ­£åœ¨è¢«å“ªä¸ªäº‹åŠ¡ä¿®æ”¹ï¼‰ï¼›ç„¶åè¿˜è¦å°†å½“å‰ä¿®æ”¹ tuple çš„ idï¼ˆä¹Ÿå°±æ˜¯å…¶ ridï¼‰æ·»åŠ åˆ°å½“å‰äº‹åŠ¡çš„ write setï¼Œè¿™åœ¨äº‹åŠ¡æäº¤æ—¶ä¼šæ ¹æ® rid æ¥æ­£ç¡®è®¾ç½® table heap ä¸­ tuple çš„ tsã€‚</p><h3 id=commit>Commit<a hidden class=anchor aria-hidden=true href=#commit>#</a></h3><p>åˆšåˆšè¯´åˆ°åœ¨ä¿®æ”¹æ—¶éœ€è¦ä¿®æ”¹ tuple çš„ meta æ•°æ®ä¸­çš„ ts ä¸ºå½“å‰äº‹åŠ¡çš„ temp tsï¼Œå› ä¸ºæ­¤æ—¶äº‹åŠ¡è¿˜æ²¡æäº¤ï¼Œä½¿ç”¨ temp ts å°±èƒ½åˆ†è¾¨å‡ºç°åœ¨è¿™æ¡ tuple æ˜¯å¦æ­£åœ¨è¢«ä¿®æ”¹ï¼štemp ts æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„æ•°ï¼ˆ<code>TXN_START_ID + txn_id</code>ï¼Œå…¶ä¸­ <code>TXN_START_ID = 1LL &lt;&lt; 62</code>ï¼‰ï¼Œäº‹åŠ¡çš„ read ts å’Œ commit ts éƒ½ä¼šå°äºè¿™ä¸ªæ•°ï¼›åœ¨åˆ¤æ–­ä¸€ä¸ª tuple æ˜¯å¦å¯è§æ—¶ï¼Œéƒ½æ˜¯é€šè¿‡äº‹åŠ¡çš„ read tsï¼ˆtxn.read_tsï¼‰ä¸ tuple.meta.ts è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœ <code>tuple.meta.ts &lt;= txn.read_ts</code>ï¼Œé‚£ä¹ˆè¿™ä¸ª tuple å¯¹äº txn æ˜¯å¯è§çš„ï¼Œè€Œå¦‚æœ <code>tuple.meta.ts == txn.temp_ts</code>ï¼Œåˆ™è¿™ä¸ª tuple æ­£åœ¨è¢« txn è¿›è¡Œä¿®æ”¹ã€‚</p><p>è¿™æ ·çš„è¯ï¼Œå³ä¾¿æ˜¯åœ¨ä¿®æ”¹å <code>tuple.meta.ts</code> ä¹Ÿåªæ˜¯äº‹åŠ¡çš„ temp tsï¼Œæ‰€ä»¥åœ¨ commit æ—¶ï¼Œéœ€è¦å°†å…¶è®¾ç½®ä¸ºç³»ç»Ÿçš„æœ€æ–° commit tsã€‚è¿™é‡Œéœ€è¦åšå‡ ç‚¹ï¼š</p><ol><li>è·å–å½“å‰ç³»ç»Ÿçš„ commit tsï¼Œè®¡ç®—æ–¹å¼ä¸º <code>last_commit_ts_ + 1</code></li><li>éå†å½“å‰è¦æäº¤çš„äº‹åŠ¡çš„ write setï¼Œæ›´æ–°ä¿®æ”¹äº†çš„ tuple çš„ meta æ•°æ®ï¼Œå°† meta.ts è®¾ç½®ä¸º commit ts</li><li>è®¾ç½®äº‹åŠ¡çš„ commit tsï¼Œå¹¶ä¸”æ›´æ–°ç³»ç»Ÿçš„ last_commit_ts</li></ol><h3 id=garbagecollection>GarbageCollection<a hidden class=anchor aria-hidden=true href=#garbagecollection>#</a></h3><p>ä¹‹å‰ä¸€æ—¦æˆ‘ä»¬å°†äº‹åŠ¡æ·»åŠ åˆ° txn manager ä¸­ï¼Œæˆ‘ä»¬å°±æ°¸è¿œä¸ä¼šåˆ é™¤å®ƒï¼Œå› ä¸º read_ts è¾ƒå°çš„äº‹åŠ¡å¯èƒ½éœ€è¦è¯»å–å­˜å‚¨åœ¨å…ˆå‰å·²æäº¤æˆ–å·²ä¸­æ­¢äº‹åŠ¡ä¸­çš„æ’¤é”€æ—¥å¿—ã€‚è¿™é‡Œéœ€è¦å®ç° TransactionManager::GarbageCollection() å‡½æ•°ï¼Œåˆ é™¤æœªä½¿ç”¨çš„äº‹åŠ¡ã€‚</p><p>ä¸€ä¸ªäº‹åŠ¡åœ¨è¿è¡Œæ—¶åªéœ€è¦çœ‹åˆ°å®ƒè‡ªå·±çš„å¿«ç…§ï¼Œä¸€æ—¦äº‹åŠ¡ç»“æŸï¼Œå®ƒæ‰€ä¾èµ–çš„æ•°æ®ç‰ˆæœ¬å°±å¯ä»¥è¢«è€ƒè™‘å›æ”¶ã€‚åªæœ‰å½“æŸä¸ªæ•°æ®ç‰ˆæœ¬ä¸å†è¢«ä»»ä½•æ´»è·ƒäº‹åŠ¡éœ€è¦æ—¶ï¼Œæ‰èƒ½è¿›è¡Œåƒåœ¾å›æ”¶ï¼ˆGCï¼‰ã€‚</p><p>ä¸¾ä¸ªğŸŒ°ï¼Œå‡è®¾æˆ‘ä»¬æœ‰å¦‚ä¸‹è®°å½•ï¼š</p><table><thead><tr><th>RID</th><th>ts_</th><th>æ•°æ®</th></tr></thead><tbody><tr><td>A</td><td>1</td><td>Alice</td></tr><tr><td>A</td><td>2</td><td>Bob</td></tr><tr><td>A</td><td>3</td><td>Charlie</td></tr><tr><td>A</td><td>4</td><td>David</td></tr></tbody></table><p>è¿™è¡¨ç¤ºè®°å½• A è¢«ä¸åŒäº‹åŠ¡æ›´æ–°äº†å››æ¬¡ã€‚ç°åœ¨ç³»ç»Ÿä¸­æœ‰ä¸‰ä¸ªäº‹åŠ¡ï¼š</p><table><thead><tr><th>äº‹åŠ¡ ID</th><th>çŠ¶æ€</th><th>å¯è§æ€§èŒƒå›´</th></tr></thead><tbody><tr><td>T2</td><td>RUNNING</td><td>ts â‰¤ 2</td></tr><tr><td>T4</td><td>RUNNING</td><td>ts â‰¤ 4</td></tr><tr><td>T5</td><td>RUNNING</td><td>ts â‰¤ 5</td></tr></tbody></table><p>watermark = 2ï¼ˆæœ€å°æ´»è·ƒäº‹åŠ¡ IDï¼‰</p><blockquote><p>Q1: T5 èƒ½çœ‹åˆ° ts_=1 çš„æ•°æ®å—ï¼Ÿ</p></blockquote><p>æ²¡é—®é¢˜ï¼Œå› ä¸º T5 çš„ ts=5 > 1ï¼Œä¸”äº‹åŠ¡ 1 å·²å®Œæˆã€‚</p><blockquote><p>Q2: ts_=1 çš„æ•°æ®å¯ä»¥è¢«æ¸…ç†å—ï¼Ÿ</p></blockquote><p>ä¸å¯ä»¥ï¼Œå› ä¸º T2ï¼ˆts=2ï¼‰è¿˜åœ¨è¿è¡Œï¼Œå®ƒçš„å¯è§èŒƒå›´æ˜¯ ts â‰¤ 2ï¼Œæ‰€ä»¥å®ƒå¯èƒ½ä¼šè®¿é—® ts=1 çš„æ•°æ®ã€‚</p><blockquote><p>Q3: å¦‚æœ T2 æäº¤æˆ–ä¸­æ­¢ï¼Œwatermark ä¼šå˜æˆå¤šå°‘ï¼Ÿæ­¤æ—¶ ts=1 çš„æ•°æ®èƒ½è¢«æ¸…ç†å—ï¼Ÿ</p></blockquote><ul><li>watermark æ›´æ–°ä¸º min(4,5) = 4</li><li>æ­¤æ—¶æ‰€æœ‰æ´»è·ƒäº‹åŠ¡çš„ ts â‰¥ 4</li><li>æ‰€ä»¥ ts â‰¤ 3 çš„æ•°æ®éƒ½å¯¹æ´»è·ƒäº‹åŠ¡ä¸å¯è§ â†’ å¯ä»¥å®‰å…¨æ¸…ç†</li></ul><p>è¿™é‡Œæœ‰ä¸€ä¸ªå…³é”®ç‚¹ï¼šå¯è§ â‰  ä¸å¯æ¸…ç†</p><ul><li>å¯è§æ€§ï¼šè¡¨ç¤ºæŸä¸ªäº‹åŠ¡æ˜¯å¦èƒ½çœ‹åˆ°æŸæ¡è®°å½•ï¼ˆæ¯”å¦‚ T5 èƒ½çœ‹åˆ° ts_=3 çš„è®°å½•ï¼‰</li><li>æ¸…ç†æ¡ä»¶ï¼šè¡¨ç¤ºè¿™æ¡è®°å½•æ˜¯å¦ä»ç„¶è¢«ä»»ä½•ä¸€ä¸ªæ´»è·ƒäº‹åŠ¡æ‰€éœ€è¦ï¼Œå¦‚æœæ²¡æœ‰ä»»ä½•æ´»è·ƒäº‹åŠ¡å†è®¿é—®å®ƒï¼Œå°±å¯ä»¥æ¸…ç†</li></ul><p>æ‰€ä»¥ GC çš„æ­¥éª¤å¯ä»¥ç®€å•æ€»ç»“å¦‚ä¸‹ï¼š</p><ol><li>éå†æ•°æ®åº“ä¸­æ‰€æœ‰ tuple</li><li>åˆ¤æ–­ tuple.ts_ â‰¤ watermark â†’ ä¸å†è¢«æ´»è·ƒäº‹åŠ¡è®¿é—®</li><li>æ²¿ç€ undo link éå† undo log é“¾</li><li>ç»Ÿè®¡æ¯ä¸ªäº‹åŠ¡æœ‰å¤šå°‘ undo log ä¸å†è¢«è®¿é—®</li><li>å¦‚æœæŸä¸ªäº‹åŠ¡æ‰€æœ‰ undo log éƒ½ä¸å¯è§ï¼Œä¸”äº‹åŠ¡å·²å®Œæˆ â†’ åˆ é™¤å…¶ undo log å’Œäº‹åŠ¡å…ƒä¿¡æ¯</li></ol><h2 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h2><ul><li><a href=https://blog.csdn.net/weixin_48885685/article/details/143225977>https://blog.csdn.net/weixin_48885685/article/details/143225977</a></li><li><a href=https://github.com/ZepengLi111/cmu15445-2023-fall-bustub>https://github.com/ZepengLi111/cmu15445-2023-fall-bustub</a></li><li>Qwen</li><li>ChatGPT</li></ul></div><footer class=post-footer><nav class=paginav><a class=prev href=https://kerolt.github.io/posts/%E7%AE%97%E6%B3%95/%E4%BA%8C%E5%88%86/875.-%E7%88%B1%E5%90%83%E9%A6%99%E8%95%89%E7%9A%84%E7%8F%82%E7%8F%82/><span class=title>Â« Prev</span><br><span>875. çˆ±åƒé¦™è•‰çš„ç‚ç‚</span>
</a><a class=next href=https://kerolt.github.io/posts/c++/c++%E6%8A%98%E5%8F%A0%E8%A1%A8%E8%BE%BE%E5%BC%8F/><span class=title>Next Â»</span><br><span>C++æŠ˜å è¡¨è¾¾å¼</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2026 <a href=https://kerolt.github.io/>Kerolt's Blog</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>