<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>ã€CMU15-445 Fall2023ã€‘Project3 Query Execution å°ç»“ | Kerolt's Blog</title><meta name=keywords content="CPlusPlus,Database,CMU-15445"><meta name=description content="
è¯¥ç³»åˆ—åšå®¢åªæ˜¯ä¸ºäº†è®°å½•è‡ªå·±åœ¨å†™ Lab æ—¶çš„æ€è·¯ï¼ŒæŒ‰ç…§è¯¾ç¨‹è¦æ±‚ä¸ä¼šåœ¨ Github å’Œåšå®¢ä¸­å…¬å¼€æºä»£ç ã€‚æ¬¢è¿ä¸æˆ‘ä¸€èµ·è®¨è®ºäº¤æµï¼

è¿™ä¸ª project å’Œä¹‹å‰å°±ä¸ä¸€æ ·äº†ï¼Œå¼€å§‹æ·±å…¥æ•°æ®åº“å†…æ ¸çš„å®ç°äº†ã€‚éœ€è¦ç†æ¸…æ¥šä¸€æ¡ sql è¯­å¥æ˜¯å¦‚ä½•è¢«æ‰§è¡Œçš„ï¼Œæ–¹æ‰èƒ½å†™å‡ºä»£ç ã€‚
å‰ç½®å¥¶é…ª
ä¸€æ¡ SQL è¯­å¥çš„æ‰§è¡Œ


  
    
  


è¿™é‡Œéœ€è¦å»çœ‹çœ‹ä¸€æ¡ sql è¯­å¥ä¼ å…¥ bustub å†…éƒ¨ä¹‹åçš„ä»£ç ï¼šsrc/common/bustub_instance.cpp:ExecuteSqlTxnï¼š
auto BustubInstance::ExecuteSqlTxn(const std::string &amp;sql, ResultWriter &amp;writer, Transaction *txn,
                                   std::shared_ptr<CheckOptions> check_options) -> bool {
  if (!sql.empty() && sql[0] == '\\') {
    // å¤„ç†å…ƒå‘½ä»¤
    ... 
  }

  // binderï¼Œä½†æ˜¯åœ¨å…¶ä¸­ä¼šä½¿ç”¨libpg_queryæ¥è§£æsqlè¯­å¥
  bustub::Binder binder(*catalog_);
  binder.ParseAndSave(sql);

  // ç»è¿‡ä¸Šä¸€æ­¥åï¼Œbinderä¸­çš„statement_nodes_å­˜å‚¨ç€æ‰€æœ‰çš„è¯­å¥è§£æèŠ‚ç‚¹
  for (auto *stmt : binder.statement_nodes_) {
    // å°†stmtè½¬æ¢æˆBoundStatementå¯¹è±¡ï¼Œæ–¹ä¾¿åé¢å¤„ç†æ•°æ®
    auto statement = binder.BindStatement(stmt);
    
    // åªæœ‰ä¸éœ€è¦æ„å»ºplanæ ‘ã€ä¸éœ€è¦è¿›è¡Œä¼˜åŒ–çš„sqlè¯­å¥æ‰ä¼šåœ¨switchä¹‹åç»§ç»­æ‰§è¡Œ
    switch (statement->type_) {
      ...
    }

	// ç”Ÿæˆåˆæ­¥çš„æ‰§è¡Œè®¡åˆ’
    bustub::Planner planner(*catalog_);
    planner.PlanQuery(*statement);

	// ä¼˜åŒ–åˆšåˆšçš„æ‰§è¡Œè®¡åˆ’
    bustub::Optimizer optimizer(*catalog_, IsForceStarterRule());
    auto optimized_plan = optimizer.Optimize(planner.plan_);

	...

	// æ‰§è¡Œä¼˜åŒ–åçš„planï¼Œè¿™é‡Œä¼šä½¿ç”¨ç«å±±æ¨¡å‹å»æ ¹æ®ä¸‹é¢èŠ‚ç‚¹çš„Nextå‡½æ•°æ¥æ‰§è¡Œç›¸åº”çš„ç®—å­
	execution_engine_->Execute(optimized_plan, &amp;result_set, txn, exec_ctx.get());

	// å°†æ‰§è¡Œç»“æœè¾“å‡ºè‡³æŒ‡å®šä½ç½®
	...
  }
  return æ˜¯å¦æ‰§è¡ŒæˆåŠŸ;	
}
åœ¨ binder ä¹‹åï¼Œæˆ‘ä»¬å°±æœ‰äº†ä¸€æ¡ sql çš„è¯­å¥è§£æèŠ‚ç‚¹ï¼Œä¾‹å¦‚æ‰§è¡Œ select * from (select * from test_2 where colA > 10) where colB > 2;ï¼Œå…¶ statement node å¦‚ä¸‹ï¼š"><meta name=author content="Kerolt"><link rel=canonical href=https://kerolt.github.io/posts/%E6%95%B0%E6%8D%AE%E5%BA%93/cmu15-445-fall2023project3-query-execution-%E5%B0%8F%E7%BB%93/><meta name=google-site-verification content="NpIO0KEIJS0CPRzTzQCbYQdSRIyb0Lspx"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="2300A23B82DB579A2DEA6261191AD771"><link crossorigin=anonymous href=/assets/css/stylesheet.606825f206d352379c6dde44af4261b470bb478e4cd3698f13051e7ae36000f2.css integrity="sha256-YGgl8gbTUjecbd5Er0JhtHC7R45M02mPEwUeeuNgAPI=" rel="preload stylesheet" as=style><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-screen-web/style.css><link rel=icon href=https://kerolt.github.io/images/avatar/favicon.png><link rel=icon type=image/png sizes=16x16 href=https://kerolt.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://kerolt.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://kerolt.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://kerolt.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://kerolt.github.io/posts/%E6%95%B0%E6%8D%AE%E5%BA%93/cmu15-445-fall2023project3-query-execution-%E5%B0%8F%E7%BB%93/><script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css><script src=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js></script><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://kerolt.github.io/posts/%E6%95%B0%E6%8D%AE%E5%BA%93/cmu15-445-fall2023project3-query-execution-%E5%B0%8F%E7%BB%93/"><meta property="og:site_name" content="Kerolt's Blog"><meta property="og:title" content="ã€CMU15-445 Fall2023ã€‘Project3 Query Execution å°ç»“"><meta property="og:description" content=" è¯¥ç³»åˆ—åšå®¢åªæ˜¯ä¸ºäº†è®°å½•è‡ªå·±åœ¨å†™ Lab æ—¶çš„æ€è·¯ï¼ŒæŒ‰ç…§è¯¾ç¨‹è¦æ±‚ä¸ä¼šåœ¨ Github å’Œåšå®¢ä¸­å…¬å¼€æºä»£ç ã€‚æ¬¢è¿ä¸æˆ‘ä¸€èµ·è®¨è®ºäº¤æµï¼
è¿™ä¸ª project å’Œä¹‹å‰å°±ä¸ä¸€æ ·äº†ï¼Œå¼€å§‹æ·±å…¥æ•°æ®åº“å†…æ ¸çš„å®ç°äº†ã€‚éœ€è¦ç†æ¸…æ¥šä¸€æ¡ sql è¯­å¥æ˜¯å¦‚ä½•è¢«æ‰§è¡Œçš„ï¼Œæ–¹æ‰èƒ½å†™å‡ºä»£ç ã€‚
å‰ç½®å¥¶é…ª ä¸€æ¡ SQL è¯­å¥çš„æ‰§è¡Œ è¿™é‡Œéœ€è¦å»çœ‹çœ‹ä¸€æ¡ sql è¯­å¥ä¼ å…¥ bustub å†…éƒ¨ä¹‹åçš„ä»£ç ï¼šsrc/common/bustub_instance.cpp:ExecuteSqlTxnï¼š
auto BustubInstance::ExecuteSqlTxn(const std::string &amp;sql, ResultWriter &amp;writer, Transaction *txn, std::shared_ptr<CheckOptions> check_options) -> bool { if (!sql.empty() && sql[0] == '\\') { // å¤„ç†å…ƒå‘½ä»¤ ... } // binderï¼Œä½†æ˜¯åœ¨å…¶ä¸­ä¼šä½¿ç”¨libpg_queryæ¥è§£æsqlè¯­å¥ bustub::Binder binder(*catalog_); binder.ParseAndSave(sql); // ç»è¿‡ä¸Šä¸€æ­¥åï¼Œbinderä¸­çš„statement_nodes_å­˜å‚¨ç€æ‰€æœ‰çš„è¯­å¥è§£æèŠ‚ç‚¹ for (auto *stmt : binder.statement_nodes_) { // å°†stmtè½¬æ¢æˆBoundStatementå¯¹è±¡ï¼Œæ–¹ä¾¿åé¢å¤„ç†æ•°æ® auto statement = binder.BindStatement(stmt); // åªæœ‰ä¸éœ€è¦æ„å»ºplanæ ‘ã€ä¸éœ€è¦è¿›è¡Œä¼˜åŒ–çš„sqlè¯­å¥æ‰ä¼šåœ¨switchä¹‹åç»§ç»­æ‰§è¡Œ switch (statement->type_) { ... } // ç”Ÿæˆåˆæ­¥çš„æ‰§è¡Œè®¡åˆ’ bustub::Planner planner(*catalog_); planner.PlanQuery(*statement); // ä¼˜åŒ–åˆšåˆšçš„æ‰§è¡Œè®¡åˆ’ bustub::Optimizer optimizer(*catalog_, IsForceStarterRule()); auto optimized_plan = optimizer.Optimize(planner.plan_); ... // æ‰§è¡Œä¼˜åŒ–åçš„planï¼Œè¿™é‡Œä¼šä½¿ç”¨ç«å±±æ¨¡å‹å»æ ¹æ®ä¸‹é¢èŠ‚ç‚¹çš„Nextå‡½æ•°æ¥æ‰§è¡Œç›¸åº”çš„ç®—å­ execution_engine_->Execute(optimized_plan, &amp;result_set, txn, exec_ctx.get()); // å°†æ‰§è¡Œç»“æœè¾“å‡ºè‡³æŒ‡å®šä½ç½® ... } return æ˜¯å¦æ‰§è¡ŒæˆåŠŸ;	} åœ¨ binder ä¹‹åï¼Œæˆ‘ä»¬å°±æœ‰äº†ä¸€æ¡ sql çš„è¯­å¥è§£æèŠ‚ç‚¹ï¼Œä¾‹å¦‚æ‰§è¡Œ select * from (select * from test_2 where colA > 10) where colB > 2;ï¼Œå…¶ statement node å¦‚ä¸‹ï¼š"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-03-11T00:00:00+00:00"><meta property="article:modified_time" content="2025-03-11T00:00:00+00:00"><meta property="article:tag" content="CPlusPlus"><meta property="article:tag" content="Database"><meta property="article:tag" content="CMU-15445"><meta property="og:image" content="https://kerolt.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://kerolt.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="ã€CMU15-445 Fall2023ã€‘Project3 Query Execution å°ç»“"><meta name=twitter:description content="
è¯¥ç³»åˆ—åšå®¢åªæ˜¯ä¸ºäº†è®°å½•è‡ªå·±åœ¨å†™ Lab æ—¶çš„æ€è·¯ï¼ŒæŒ‰ç…§è¯¾ç¨‹è¦æ±‚ä¸ä¼šåœ¨ Github å’Œåšå®¢ä¸­å…¬å¼€æºä»£ç ã€‚æ¬¢è¿ä¸æˆ‘ä¸€èµ·è®¨è®ºäº¤æµï¼

è¿™ä¸ª project å’Œä¹‹å‰å°±ä¸ä¸€æ ·äº†ï¼Œå¼€å§‹æ·±å…¥æ•°æ®åº“å†…æ ¸çš„å®ç°äº†ã€‚éœ€è¦ç†æ¸…æ¥šä¸€æ¡ sql è¯­å¥æ˜¯å¦‚ä½•è¢«æ‰§è¡Œçš„ï¼Œæ–¹æ‰èƒ½å†™å‡ºä»£ç ã€‚
å‰ç½®å¥¶é…ª
ä¸€æ¡ SQL è¯­å¥çš„æ‰§è¡Œ


  
    
  


è¿™é‡Œéœ€è¦å»çœ‹çœ‹ä¸€æ¡ sql è¯­å¥ä¼ å…¥ bustub å†…éƒ¨ä¹‹åçš„ä»£ç ï¼šsrc/common/bustub_instance.cpp:ExecuteSqlTxnï¼š
auto BustubInstance::ExecuteSqlTxn(const std::string &amp;sql, ResultWriter &amp;writer, Transaction *txn,
                                   std::shared_ptr<CheckOptions> check_options) -> bool {
  if (!sql.empty() && sql[0] == '\\') {
    // å¤„ç†å…ƒå‘½ä»¤
    ... 
  }

  // binderï¼Œä½†æ˜¯åœ¨å…¶ä¸­ä¼šä½¿ç”¨libpg_queryæ¥è§£æsqlè¯­å¥
  bustub::Binder binder(*catalog_);
  binder.ParseAndSave(sql);

  // ç»è¿‡ä¸Šä¸€æ­¥åï¼Œbinderä¸­çš„statement_nodes_å­˜å‚¨ç€æ‰€æœ‰çš„è¯­å¥è§£æèŠ‚ç‚¹
  for (auto *stmt : binder.statement_nodes_) {
    // å°†stmtè½¬æ¢æˆBoundStatementå¯¹è±¡ï¼Œæ–¹ä¾¿åé¢å¤„ç†æ•°æ®
    auto statement = binder.BindStatement(stmt);
    
    // åªæœ‰ä¸éœ€è¦æ„å»ºplanæ ‘ã€ä¸éœ€è¦è¿›è¡Œä¼˜åŒ–çš„sqlè¯­å¥æ‰ä¼šåœ¨switchä¹‹åç»§ç»­æ‰§è¡Œ
    switch (statement->type_) {
      ...
    }

	// ç”Ÿæˆåˆæ­¥çš„æ‰§è¡Œè®¡åˆ’
    bustub::Planner planner(*catalog_);
    planner.PlanQuery(*statement);

	// ä¼˜åŒ–åˆšåˆšçš„æ‰§è¡Œè®¡åˆ’
    bustub::Optimizer optimizer(*catalog_, IsForceStarterRule());
    auto optimized_plan = optimizer.Optimize(planner.plan_);

	...

	// æ‰§è¡Œä¼˜åŒ–åçš„planï¼Œè¿™é‡Œä¼šä½¿ç”¨ç«å±±æ¨¡å‹å»æ ¹æ®ä¸‹é¢èŠ‚ç‚¹çš„Nextå‡½æ•°æ¥æ‰§è¡Œç›¸åº”çš„ç®—å­
	execution_engine_->Execute(optimized_plan, &amp;result_set, txn, exec_ctx.get());

	// å°†æ‰§è¡Œç»“æœè¾“å‡ºè‡³æŒ‡å®šä½ç½®
	...
  }
  return æ˜¯å¦æ‰§è¡ŒæˆåŠŸ;	
}
åœ¨ binder ä¹‹åï¼Œæˆ‘ä»¬å°±æœ‰äº†ä¸€æ¡ sql çš„è¯­å¥è§£æèŠ‚ç‚¹ï¼Œä¾‹å¦‚æ‰§è¡Œ select * from (select * from test_2 where colA > 10) where colB > 2;ï¼Œå…¶ statement node å¦‚ä¸‹ï¼š"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://kerolt.github.io/posts/"},{"@type":"ListItem","position":2,"name":"ã€CMU15-445 Fall2023ã€‘Project3 Query Execution å°ç»“","item":"https://kerolt.github.io/posts/%E6%95%B0%E6%8D%AE%E5%BA%93/cmu15-445-fall2023project3-query-execution-%E5%B0%8F%E7%BB%93/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"ã€CMU15-445 Fall2023ã€‘Project3 Query Execution å°ç»“","name":"ã€CMU15-445 Fall2023ã€‘Project3 Query Execution å°ç»“","description":" è¯¥ç³»åˆ—åšå®¢åªæ˜¯ä¸ºäº†è®°å½•è‡ªå·±åœ¨å†™ Lab æ—¶çš„æ€è·¯ï¼ŒæŒ‰ç…§è¯¾ç¨‹è¦æ±‚ä¸ä¼šåœ¨ Github å’Œåšå®¢ä¸­å…¬å¼€æºä»£ç ã€‚æ¬¢è¿ä¸æˆ‘ä¸€èµ·è®¨è®ºäº¤æµï¼\nè¿™ä¸ª project å’Œä¹‹å‰å°±ä¸ä¸€æ ·äº†ï¼Œå¼€å§‹æ·±å…¥æ•°æ®åº“å†…æ ¸çš„å®ç°äº†ã€‚éœ€è¦ç†æ¸…æ¥šä¸€æ¡ sql è¯­å¥æ˜¯å¦‚ä½•è¢«æ‰§è¡Œçš„ï¼Œæ–¹æ‰èƒ½å†™å‡ºä»£ç ã€‚\nå‰ç½®å¥¶é…ª ä¸€æ¡ SQL è¯­å¥çš„æ‰§è¡Œ è¿™é‡Œéœ€è¦å»çœ‹çœ‹ä¸€æ¡ sql è¯­å¥ä¼ å…¥ bustub å†…éƒ¨ä¹‹åçš„ä»£ç ï¼šsrc/common/bustub_instance.cpp:ExecuteSqlTxnï¼š\nauto BustubInstance::ExecuteSqlTxn(const std::string \u0026amp;sql, ResultWriter \u0026amp;writer, Transaction *txn, std::shared_ptr\u0026lt;CheckOptions\u0026gt; check_options) -\u0026gt; bool { if (!sql.empty() \u0026amp;\u0026amp; sql[0] == \u0026#39;\\\\\u0026#39;) { // å¤„ç†å…ƒå‘½ä»¤ ... } // binderï¼Œä½†æ˜¯åœ¨å…¶ä¸­ä¼šä½¿ç”¨libpg_queryæ¥è§£æsqlè¯­å¥ bustub::Binder binder(*catalog_); binder.ParseAndSave(sql); // ç»è¿‡ä¸Šä¸€æ­¥åï¼Œbinderä¸­çš„statement_nodes_å­˜å‚¨ç€æ‰€æœ‰çš„è¯­å¥è§£æèŠ‚ç‚¹ for (auto *stmt : binder.statement_nodes_) { // å°†stmtè½¬æ¢æˆBoundStatementå¯¹è±¡ï¼Œæ–¹ä¾¿åé¢å¤„ç†æ•°æ® auto statement = binder.BindStatement(stmt); // åªæœ‰ä¸éœ€è¦æ„å»ºplanæ ‘ã€ä¸éœ€è¦è¿›è¡Œä¼˜åŒ–çš„sqlè¯­å¥æ‰ä¼šåœ¨switchä¹‹åç»§ç»­æ‰§è¡Œ switch (statement-\u0026gt;type_) { ... } // ç”Ÿæˆåˆæ­¥çš„æ‰§è¡Œè®¡åˆ’ bustub::Planner planner(*catalog_); planner.PlanQuery(*statement); // ä¼˜åŒ–åˆšåˆšçš„æ‰§è¡Œè®¡åˆ’ bustub::Optimizer optimizer(*catalog_, IsForceStarterRule()); auto optimized_plan = optimizer.Optimize(planner.plan_); ... // æ‰§è¡Œä¼˜åŒ–åçš„planï¼Œè¿™é‡Œä¼šä½¿ç”¨ç«å±±æ¨¡å‹å»æ ¹æ®ä¸‹é¢èŠ‚ç‚¹çš„Nextå‡½æ•°æ¥æ‰§è¡Œç›¸åº”çš„ç®—å­ execution_engine_-\u0026gt;Execute(optimized_plan, \u0026amp;result_set, txn, exec_ctx.get()); // å°†æ‰§è¡Œç»“æœè¾“å‡ºè‡³æŒ‡å®šä½ç½® ... } return æ˜¯å¦æ‰§è¡ŒæˆåŠŸ;\t} åœ¨ binder ä¹‹åï¼Œæˆ‘ä»¬å°±æœ‰äº†ä¸€æ¡ sql çš„è¯­å¥è§£æèŠ‚ç‚¹ï¼Œä¾‹å¦‚æ‰§è¡Œ select * from (select * from test_2 where colA \u0026gt; 10) where colB \u0026gt; 2;ï¼Œå…¶ statement node å¦‚ä¸‹ï¼š\n","keywords":["CPlusPlus","Database","CMU-15445"],"articleBody":" è¯¥ç³»åˆ—åšå®¢åªæ˜¯ä¸ºäº†è®°å½•è‡ªå·±åœ¨å†™ Lab æ—¶çš„æ€è·¯ï¼ŒæŒ‰ç…§è¯¾ç¨‹è¦æ±‚ä¸ä¼šåœ¨ Github å’Œåšå®¢ä¸­å…¬å¼€æºä»£ç ã€‚æ¬¢è¿ä¸æˆ‘ä¸€èµ·è®¨è®ºäº¤æµï¼\nè¿™ä¸ª project å’Œä¹‹å‰å°±ä¸ä¸€æ ·äº†ï¼Œå¼€å§‹æ·±å…¥æ•°æ®åº“å†…æ ¸çš„å®ç°äº†ã€‚éœ€è¦ç†æ¸…æ¥šä¸€æ¡ sql è¯­å¥æ˜¯å¦‚ä½•è¢«æ‰§è¡Œçš„ï¼Œæ–¹æ‰èƒ½å†™å‡ºä»£ç ã€‚\nå‰ç½®å¥¶é…ª ä¸€æ¡ SQL è¯­å¥çš„æ‰§è¡Œ è¿™é‡Œéœ€è¦å»çœ‹çœ‹ä¸€æ¡ sql è¯­å¥ä¼ å…¥ bustub å†…éƒ¨ä¹‹åçš„ä»£ç ï¼šsrc/common/bustub_instance.cpp:ExecuteSqlTxnï¼š\nauto BustubInstance::ExecuteSqlTxn(const std::string \u0026sql, ResultWriter \u0026writer, Transaction *txn, std::shared_ptr\u003cCheckOptions\u003e check_options) -\u003e bool { if (!sql.empty() \u0026\u0026 sql[0] == '\\\\') { // å¤„ç†å…ƒå‘½ä»¤ ... } // binderï¼Œä½†æ˜¯åœ¨å…¶ä¸­ä¼šä½¿ç”¨libpg_queryæ¥è§£æsqlè¯­å¥ bustub::Binder binder(*catalog_); binder.ParseAndSave(sql); // ç»è¿‡ä¸Šä¸€æ­¥åï¼Œbinderä¸­çš„statement_nodes_å­˜å‚¨ç€æ‰€æœ‰çš„è¯­å¥è§£æèŠ‚ç‚¹ for (auto *stmt : binder.statement_nodes_) { // å°†stmtè½¬æ¢æˆBoundStatementå¯¹è±¡ï¼Œæ–¹ä¾¿åé¢å¤„ç†æ•°æ® auto statement = binder.BindStatement(stmt); // åªæœ‰ä¸éœ€è¦æ„å»ºplanæ ‘ã€ä¸éœ€è¦è¿›è¡Œä¼˜åŒ–çš„sqlè¯­å¥æ‰ä¼šåœ¨switchä¹‹åç»§ç»­æ‰§è¡Œ switch (statement-\u003etype_) { ... } // ç”Ÿæˆåˆæ­¥çš„æ‰§è¡Œè®¡åˆ’ bustub::Planner planner(*catalog_); planner.PlanQuery(*statement); // ä¼˜åŒ–åˆšåˆšçš„æ‰§è¡Œè®¡åˆ’ bustub::Optimizer optimizer(*catalog_, IsForceStarterRule()); auto optimized_plan = optimizer.Optimize(planner.plan_); ... // æ‰§è¡Œä¼˜åŒ–åçš„planï¼Œè¿™é‡Œä¼šä½¿ç”¨ç«å±±æ¨¡å‹å»æ ¹æ®ä¸‹é¢èŠ‚ç‚¹çš„Nextå‡½æ•°æ¥æ‰§è¡Œç›¸åº”çš„ç®—å­ execution_engine_-\u003eExecute(optimized_plan, \u0026result_set, txn, exec_ctx.get()); // å°†æ‰§è¡Œç»“æœè¾“å‡ºè‡³æŒ‡å®šä½ç½® ... } return æ˜¯å¦æ‰§è¡ŒæˆåŠŸ;\t} åœ¨ binder ä¹‹åï¼Œæˆ‘ä»¬å°±æœ‰äº†ä¸€æ¡ sql çš„è¯­å¥è§£æèŠ‚ç‚¹ï¼Œä¾‹å¦‚æ‰§è¡Œ select * from (select * from test_2 where colA \u003e 10) where colB \u003e 2;ï¼Œå…¶ statement node å¦‚ä¸‹ï¼š\nBoundSelect { table=BoundSubqueryRef { alias=__subquery#0, subquery=BoundSelect { table=BoundBaseTableRef { table=test_2, oid=23 }, columns=[\"test_2.colA\", \"test_2.colB\", \"test_2.colC\"], groupBy=[], having=, where=(test_2.colA\u003e10), limit=, offset=, order_by=[], is_distinct=false, ctes=, }, columns=[\"test_2.colA\", \"test_2.colB\", \"test_2.colC\"], }, columns=[\"__subquery#0.test_2.colA\", \"__subquery#0.test_2.colB\", \"__subquery#0.test_2.colC\"], groupBy=[], having=, where=(__subquery#0.test_2.colB\u003e2), limit=, offset=, order_by=[], is_distinct=false, ctes=, } å…¶ä¸­çš„å­æŸ¥è¯¢å’Œ where çš„æ¡ä»¶è¿˜æœ‰éœ€è¦å“ªäº›åˆ—éƒ½èƒ½éå¸¸æ¸…æ¥šçš„çœ‹åˆ°ã€‚\nIterator Model é€šå¸¸ä¸€ä¸ª SQL ä¼šè¢«ç»„ç»‡æˆæ ‘çŠ¶çš„æŸ¥è¯¢è®¡åˆ’ï¼Œæ•°æ®ä»å¶å­èŠ‚ç‚¹æµåˆ°æ ¹èŠ‚ç‚¹ï¼ŒæŸ¥è¯¢ç»“æœåœ¨æ ¹èŠ‚ç‚¹ä¸­å¾—å‡ºã€‚\nbustub ä¸­é‡‡ç”¨çš„æ•°æ®åº“æŸ¥è¯¢æ‰§è¡Œæ¨¡å‹å«åšè¿­ä»£å™¨æ¨¡å‹ï¼Œä¹Ÿå«ç«å±±æ¨¡å‹ã€‚\næŸ¥è¯¢è®¡åˆ’ï¼ˆquery planï¼‰ä¸­çš„æ¯æ­¥ operator å¯¹åº”çš„ executor éƒ½å®ç°ä¸€ä¸ª next å‡½æ•°ï¼Œæ¯æ¬¡è°ƒç”¨æ—¶ï¼Œoperator è¿”å›ä¸€ä¸ª tuple æˆ–è€… nullï¼Œåè€…è¡¨ç¤ºæ•°æ®å·²ç»éå†å®Œæ¯•ã€‚operator æœ¬èº«å®ç°ä¸€ä¸ªå¾ªç¯ï¼Œæ¯æ¬¡è°ƒç”¨å…¶ child operators çš„ next å‡½æ•°ï¼Œä»å®ƒä»¬é‚£è¾¹è·å–ä¸‹ä¸€æ¡æ•°æ®ä¾›è‡ªå·±æ“ä½œï¼Œè¿™æ ·æ•´ä¸ª query plan å°±è¢«ä»ä¸Šè‡³ä¸‹åœ°ä¸²è”èµ·æ¥ã€‚\nä½†æ˜¯åƒ Joins, Aggregates, Subqueries, Order By è¿™æ ·çš„æ“ä½œéœ€è¦ç­‰æ‰€æœ‰ children è¿”å›å®ƒä»¬çš„ tupleã€‚è™½ç„¶ä¸€æ¬¡è°ƒç”¨è¯·æ±‚ä¸€æ¡æ•°æ®ï¼Œå ç”¨å†…å­˜è¾ƒå°ï¼Œä½†å‡½æ•°è°ƒç”¨å¼€é”€å¤§ã€‚\nCatalog, Table and Index ä¸‹å›¾å‡ºå¤„ï¼šhttps://www.cnblogs.com/joey-wang/p/17351258.html\nç´¢å¼• index åœ¨ Bustub ä¸­ï¼Œç´¢å¼•ç”¨äºåŠ é€Ÿæ•°æ®è®¿é—®ã€‚ç´¢å¼•é€šè¿‡ç»´æŠ¤è¡¨ä¸­æ•°æ®çš„æœ‰åºç»“æ„ï¼Œä½¿å¾—æŸ¥è¯¢å¯ä»¥æ›´å¿«åœ°å®šä½åˆ°æ‰€éœ€çš„è®°å½•ã€‚\nç»“æ„ ç´¢å¼•çš„ç»“æ„å›¾å’Œä¸Šé¢è¡¨çš„ç»“æ„å›¾ç±»ä¼¼ã€‚åœ¨ catalog ä¸­ï¼Œå¯ä»¥è·å–åˆ°ä¸€ä¸ªè¡¨å¯¹åº”çš„æ‰€æœ‰IndexInfoï¼Œæ¯ä¸ª IndexInfo ä¸­åŒ…å«ç€è¿™ä¸ªç´¢å¼•çš„ä¿¡æ¯ï¼Œè¿™é‡Œè®²ä¸¤ä¸ªä¸ªæˆ‘è®¤ä¸ºæ¯”è¾ƒé‡è¦çš„æˆå‘˜å˜é‡ï¼š\nkey_schema_ï¼šç´¢å¼•å¯¹åº”çš„åˆ—çš„ç»“æ„ï¼Œä¾‹å¦‚ä½¿ç”¨å…¶ ToString() å‡½æ•°æ—¶ï¼Œå…¶ä¼šè¿”å› (æ·»åŠ äº†ç´¢å¼•çš„åˆ—çš„åç§°:è¯¥åˆ—çš„æ•°æ®ç±»å‹) index_ï¼šè¿™æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ª Index ç±»çš„å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯çœŸæ­£çš„ç´¢å¼• // catalog.h class Catalog { public: template \u003cclass KeyType, class ValueType, class KeyComparator\u003e auto CreateIndex(Transaction *txn, const std::string \u0026index_name, const std::string \u0026table_name, const Schema \u0026schema, const Schema \u0026key_schema, const std::vector\u003cuint32_t\u003e \u0026key_attrs, std::size_t keysize, HashFunction\u003cKeyType\u003e hash_function, bool is_primary_key = false, IndexType index_type = IndexType::HashTableIndex) -\u003e IndexInfo *; auto GetIndex(const std::string \u0026index_name, const std::string \u0026table_name) -\u003e IndexInfo *; auto GetIndex(const std::string \u0026index_name, const table_oid_t table_oid) -\u003e IndexInfo *; auto GetIndex(index_oid_t index_oid) -\u003e IndexInfo *; auto GetTableIndexes(const std::string \u0026table_name) const -\u003e std::vector\u003cIndexInfo *\u003e; ... private: ... /** * Map index identifier -\u003e index metadata. * * NOTE: that `indexes_` owns all index metadata. */ std::unordered_map\u003cindex_oid_t, std::unique_ptr\u003cIndexInfo\u003e\u003e indexes_; /** Map table name -\u003e index names -\u003e index identifiers. */ std::unordered_map\u003cstd::string, std::unordered_map\u003cstd::string, index_oid_t\u003e\u003e index_names_; /** The next index identifier to be used. */ std::atomic\u003cindex_oid_t\u003e next_index_oid_{0}; }; struct IndexInfo { ... /** The schema for the index key */ Schema key_schema_; /** The name of the index */ std::string name_; /** An owning pointer to the index */ std::unique_ptr\u003cIndex\u003e index_; /** The unique OID for the index */ index_oid_t index_oid_; /** The name of the table on which the index is created */ std::string table_name_; /** The size of the index key, in bytes */ const size_t key_size_; /** Is primary key index? */ bool is_primary_key_; /** The index type */ [[maybe_unused]] IndexType index_type_{IndexType::BPlusTreeIndex}; }; Index ä¸­æœ‰ç€ä¸‰ä¸ªè™šå‡½æ•°ä¾›å…¶æ´¾ç”Ÿç±»å»å®ç°ï¼Œå…¶å”¯ä¸€çš„æˆå‘˜å˜é‡çš„ç±»å‹ä¸º IndexMetaï¼Œç”¨æ¥å­˜å‚¨ä¸€äº›å…ƒä¿¡æ¯ï¼Œä¾‹å¦‚è¿™ä¸ªç´¢å¼•çš„åç§°ï¼Œå®ƒæ‰€å±çš„è¡¨çš„åç§°ï¼Œæœ€é‡è¦çš„è¿˜æœ‰ä¸€ä¸ª key_attrs_ï¼Œç¨åå°±è¯´è°ˆè®ºå®ƒã€‚\n// index.h class IndexMeta { ... private: /** The name of the index */ std::string name_; /** The name of the table on which the index is created */ std::string table_name_; /** The mapping relation between key schema and tuple schema */ const std::vector\u003cuint32_t\u003e key_attrs_; /** The schema of the indexed key */ std::shared_ptr\u003cSchema\u003e key_schema_; /** Is primary key? */ bool is_primary_key_; }; class Index { ... private: /** The Index structure owns its metadata */ std::unique_ptr\u003cIndexMetadata\u003e metadata_; }; fall2023 æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯å“ˆå¸Œç´¢å¼•ï¼Œåº•å±‚ä½¿ç”¨çš„å°±æ˜¯åœ¨ project2 ä¸­å®ç°çš„å¯æ‹“å±•å“ˆå¸Œã€‚\n// extendible_hash_table_index.h #define HASH_TABLE_INDEX_TYPE ExtendibleHashTableIndex template \u003ctypename KeyType, typename ValueType, typename KeyComparator\u003e class ExtendibleHashTableIndex : public Index { public: ExtendibleHashTableIndex(std::unique_ptr\u003cIndexMetadata\u003e \u0026\u0026metadata, BufferPoolManager *buffer_pool_manager, const HashFunction\u003cKeyType\u003e \u0026hash_fn); ~ExtendibleHashTableIndex() override = default; auto InsertEntry(const Tuple \u0026key, RID rid, Transaction *transaction) -\u003e bool override; void DeleteEntry(const Tuple \u0026key, RID rid, Transaction *transaction) override; void ScanKey(const Tuple \u0026key, std::vector\u003cRID\u003e *result, Transaction *transaction) override; protected: // comparator for key KeyComparator comparator_; // container DiskExtendibleHashTable\u003cKeyType, ValueType, KeyComparator\u003e container_; }; æ›´æ–°ç´¢å¼• å½“æ’å…¥æ–°è®°å½•æ—¶ï¼Œä¸ä»…éœ€è¦å°†è®°å½•æ’å…¥åˆ°è¡¨ä¸­ï¼Œè¿˜éœ€è¦å°†ç›¸åº”çš„ç´¢å¼•æ¡ç›®æ’å…¥åˆ°ç´¢å¼•ä¸­ã€‚è¿™æ ·ï¼Œåç»­çš„æŸ¥è¯¢æ“ä½œå¯ä»¥åˆ©ç”¨ç´¢å¼•å¿«é€Ÿå®šä½åˆ°ç›®æ ‡è®°å½•ã€‚å¦‚æœä¸æ›´æ–°ç´¢å¼•ï¼Œåç»­çš„æŸ¥è¯¢æ“ä½œå¯èƒ½ä¼šé”™è¿‡æ–°æ’å…¥çš„è®°å½•ï¼Œå¯¼è‡´æŸ¥è¯¢ç»“æœä¸å‡†ç¡®ã€‚\nUPDATE å’Œ DELETE å¦‚ä½•å½±å“ç´¢å¼•ï¼Ÿ\nUPDATE\nâœ… éœ€è¦æ›´æ–°ç´¢å¼•çš„æƒ…å†µï¼šä¿®æ”¹äº†ç´¢å¼•åˆ— çš„å€¼ï¼ˆä¾‹å¦‚ï¼šå°† id=100 çš„ name å­—æ®µä» â€œAliceâ€ æ”¹ä¸º â€œBobâ€ï¼Œè€Œ name è¢«å»ºäº†ç´¢å¼•ï¼‰\næ­¤æ—¶æ—§ç´¢å¼•é¡¹ï¼ˆâ€œAliceâ€ï¼‰éœ€è¦è¢«åˆ é™¤ æ–°ç´¢å¼•é¡¹ï¼ˆâ€œBobâ€ï¼‰éœ€è¦è¢«æ’å…¥ âŒ ä¸éœ€è¦æ›´æ–°ç´¢å¼•çš„æƒ…å†µï¼šä¿®æ”¹çš„æ˜¯éç´¢å¼•åˆ—\nä¾‹å¦‚ï¼šage å­—æ®µæ²¡æœ‰è¢«ç´¢å¼•ï¼Œä¿®æ”¹å®ƒä¸ä¼šå½±å“ç´¢å¼• DELETE\næ— è®ºåˆ é™¤å“ªä¸€è¡Œï¼Œåªè¦è¯¥è¡Œåœ¨æŸä¸ªç´¢å¼•ä¸­å­˜åœ¨ï¼Œå°±éœ€è¦ä»ç´¢å¼•ä¸­åˆ é™¤å¯¹åº”çš„æ¡ç›® ã€‚\nbustub ä¸­æœ‰å“ˆå¸Œç´¢å¼•å’Œ B+Tree ç´¢å¼•ï¼Œfall2023 ç‰ˆæœ¬ä½¿ç”¨çš„æ˜¯å¯æ‹“å±•å“ˆå¸Œä½œä¸ºä½œä¸ºç´¢å¼•ã€‚ä¸è¿‡è¿™ä¸¤ä¸ªå…·ä½“çš„å®ç°éƒ½æœ‰ä¸€ä¸ªåŸºç±» Indexï¼Œå…¶ä¸­æœ‰ä»¥ä¸‹è™šå‡½æ•°éœ€è¦å­ç±»å»å®ç°ï¼š\nInsertEntry(const Tuple \u0026key, RID rid, Transaction *transaction): æ’å…¥ä¸€ä¸ªç´¢å¼•æ¡ç›®ã€‚ DeleteEntry(const Tuple \u0026key, RID rid, Transaction *transaction): åˆ é™¤ä¸€ä¸ªç´¢å¼•æ¡ç›®ã€‚ ScanKey(const Tuple \u0026key, std::vector *result, Transaction *transaction): æ ¹æ®ç´¢å¼•é”®æœç´¢è®°å½•ï¼Œå¹¶å°†ç»“æœ RID å­˜å‚¨åœ¨æŒ‡å®šçš„å‘é‡ä¸­ã€‚ æ‰€ä»¥ä¸ç®¡ç”¨çš„æ˜¯å“ˆå¸Œè¿˜æ˜¯ B+Treeï¼Œåœ¨æ“ä½œç´¢å¼•æ—¶ç”¨çš„æ¥å£éƒ½ç›¸åŒã€‚\nå¦‚ä½•ç†è§£ç´¢å¼• å°±å¦‚ç½‘ä¸Šå¾ˆå¤šä»‹ç»ç´¢å¼•çš„åšå®¢æ‰€æè¿°çš„é‚£æ ·ï¼Œæ•°æ®åº“ç´¢å¼•æ˜¯ç”¨æ¥åŠ é€Ÿæ£€ç´¢é€Ÿåº¦çš„ï¼Œå°±å¦‚åŒæ–°åå­—å…¸ä¸­çš„éŸ³èŠ‚ç´¢å¼•ä¸€æ ·ï¼š\nå¦‚åŒ table_infoï¼Œcatalog ä¸­ä¹Ÿæœ‰è®¸å¤šçš„ index_infoï¼Œæ¯ä¸ª index_info å°±å¦‚åŒä¸Šå›¾éŸ³èŠ‚è¡¨ä¸­çš„ä¸€ä¸ªå­—æ¯ã€‚æˆ‘ä»¬å¯¹ä¸€ä¸ªå­—æ®µï¼ˆåˆ—ï¼‰æ„å»ºä¸€ä¸ªç´¢å¼•ï¼Œå°±å¦‚åŒåœ¨ä¸Šå›¾ä¸­éŸ³èŠ‚è¡¨ä¸­å¤šåŠ ä¸€ä¸ªå­—æ¯ï¼ˆä¾‹å¦‚ Xï¼‰ã€‚\néœ€è¦æ’å…¥ä¸€æ¡è®°å½•æ—¶ï¼Œå°±å¾€å¯¹åº”çš„ç´¢å¼•ä¸‹æ’å…¥ (è®°å½•ï¼Œ å¯¹åº”è®°å½•çš„åœ°å€) è¿™æ ·çš„é”®å€¼å¯¹ï¼Œä¾‹å¦‚ä¸Šå›¾çš„ (xian, 519)ï¼Œè¿™é‡Œçš„åœ°å€ä¸º RIDã€‚ éœ€è¦åˆ é™¤ä¸€æ¡è®°å½•æ—¶ï¼Œåœ¨å¯¹åº”çš„ç´¢å¼•ä¸‹åˆ æ‰åŒ¹é…çš„é”®å€¼å¯¹ã€‚ éœ€è¦æ›´æ–°ä¸€æ¡è®°å½•æ—¶ï¼Œç”±äº bustub æ²¡æœ‰æä¾›æ›´æ–°ç´¢å¼•çš„ APIï¼Œæ‰€ä»¥å¯ä»¥ç”¨å…ˆåˆ é™¤å†æ’å…¥çš„æ–¹å¼æ¨¡æ‹Ÿæ›´æ–°ã€‚ æ‰§è¡Œå™¨å¦‚ä½•ä½¿ç”¨ç´¢å¼•è·å–æ•°æ® å½“æ‰§è¡Œå™¨éœ€è¦ä»è¡¨ä¸­è·å–æ•°æ®æ—¶ï¼Œå¦‚æœæŸ¥è¯¢è®¡åˆ’ä¸­åŒ…å«ç´¢å¼•æ‰«ææ“ä½œï¼Œæ‰§è¡Œå™¨ä¼šé€šè¿‡ç´¢å¼•æ¥å¿«é€Ÿå®šä½æ•°æ®ã€‚ä»¥ä¸‹æ˜¯å…·ä½“çš„æ­¥éª¤ï¼š\nè§£ææŸ¥è¯¢è®¡åˆ’ï¼š æ‰§è¡Œå™¨æ ¹æ®æŸ¥è¯¢è®¡åˆ’ç¡®å®šéœ€è¦ä½¿ç”¨çš„ç´¢å¼•ã€‚ è·å–ç´¢å¼•çš„å…ƒæ•°æ®ï¼ŒåŒ…æ‹¬ç´¢å¼•é”®çš„æ¨¡å¼å’Œè¡¨åˆ—çš„æ˜ å°„å…³ç³»ã€‚ æ„å»ºç´¢å¼•é”®ï¼š æ ¹æ®æŸ¥è¯¢æ¡ä»¶å’Œç´¢å¼•çš„å…ƒæ•°æ®ï¼Œæ„å»ºç´¢å¼•é”®ã€‚è¿™é€šå¸¸æ¶‰åŠåˆ°ä»æŸ¥è¯¢æ¡ä»¶ä¸­æå–åˆ—å€¼ï¼Œå¹¶æ ¹æ®ç´¢å¼•é”®çš„æ¨¡å¼è¿›è¡Œè½¬æ¢ã€‚ ä½¿ç”¨ç´¢å¼•è¿›è¡Œæœç´¢ï¼š è°ƒç”¨ç´¢å¼•çš„Â ScanKeyÂ æ–¹æ³•ï¼Œä¼ å…¥æ„å»ºå¥½çš„ç´¢å¼•é”®å’Œä¸€ä¸ªç»“æœ RID å‘é‡ã€‚ ç´¢å¼•ä¼šæ ¹æ®é”®å€¼æŸ¥æ‰¾å¯¹åº”çš„è®°å½•ï¼Œå¹¶å°†æ‰¾åˆ°çš„ RID å­˜å‚¨åœ¨ç»“æœå‘é‡ä¸­ã€‚ è¯»å–æ•°æ®é¡µï¼š ä½¿ç”¨ç»“æœå‘é‡ä¸­çš„ RIDï¼Œä»ç¼“å†²æ± ä¸­æŸ¥æ‰¾å¯¹åº”çš„é¡µã€‚å¦‚æœé¡µä¸åœ¨ç¼“å†²æ± ä¸­ï¼Œåˆ™ä»ç£ç›˜åŠ è½½åˆ°ç¼“å†²æ± ã€‚ ä»é¡µä¸­è¯»å–æ•°æ®å¹¶åˆ›å»ºÂ TupleÂ å¯¹è±¡ã€‚ å¤„ç†å’Œè¿”å›ç»“æœï¼š ä½¿ç”¨Â TupleÂ å¯¹è±¡çš„æ–¹æ³•ï¼ˆå¦‚Â GetValueã€IsNullÂ ç­‰ï¼‰è®¿é—®å’Œå¤„ç†å…ƒç»„ä¸­çš„æ•°æ®ã€‚ å°†å¤„ç†åçš„æ•°æ®ä½œä¸ºç»“æœè¿”å›ç»™ç”¨æˆ·æˆ–è¿›ä¸€æ­¥å¤„ç†ã€‚ è°“è¯ä¸‹æ¨ è°“è¯ä¸‹æ¨ï¼ˆPredicate Pushdownï¼‰æ˜¯æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–ä¸­çš„ä¸€ç§æŠ€æœ¯ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯å°†æŸ¥è¯¢ä¸­çš„è¿‡æ»¤æ¡ä»¶ï¼ˆå³è°“è¯ï¼‰å°½å¯èƒ½æ—©åœ°åº”ç”¨åˆ°æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’çš„åº•éƒ¨ï¼Œä¹Ÿå°±æ˜¯æ•°æ®ç”Ÿæˆçš„åœ°æ–¹ã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯ä¸ºäº†å‡å°‘æ•°æ®çš„ä¼ è¾“é‡å’Œå¤„ç†é‡ï¼Œä»è€Œæé«˜æŸ¥è¯¢æ•ˆç‡ã€‚\nå…·ä½“æ¥è¯´ï¼Œè°“è¯ä¸‹æ¨åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š\nè¿‡æ»¤æ¡ä»¶å‰ç§»ï¼šåœ¨æŸ¥è¯¢æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œå°½æ—©åœ°å¯¹æ•°æ®è¿›è¡Œè¿‡æ»¤ï¼Œè¿™æ ·ä¸éœ€è¦å°†æ‰€æœ‰æ•°æ®éƒ½ä¼ é€’åˆ°ä¸Šå±‚æ“ä½œä¸­ï¼Œåªä¼ é€’æ»¡è¶³æ¡ä»¶çš„æ•°æ®ã€‚ å‡å°‘æ•°æ®ä¼ è¾“ï¼šé€šè¿‡åœ¨æ•°æ®ç”Ÿæˆçš„é˜¶æ®µå°±è¿›è¡Œè¿‡æ»¤ï¼Œå¯ä»¥å‡å°‘ä»æ•°æ®åº“å­˜å‚¨å¼•æ“åˆ°æŸ¥è¯¢å¤„ç†å¼•æ“ä¹‹é—´çš„æ•°æ®ä¼ è¾“é‡ã€‚ å‡å°‘ CPU å¤„ç†ï¼šä¸éœ€è¦å¯¹æ‰€æœ‰æ•°æ®è¿›è¡Œåç»­çš„å¤„ç†ï¼Œåªéœ€è¦å¤„ç†å·²ç»è¿‡æ»¤çš„æ•°æ®ï¼Œè¿™æ ·å¯ä»¥å‡å°‘ CPU çš„å·¥ä½œé‡ã€‚ åˆ©ç”¨ç´¢å¼•ï¼šå¦‚æœè¿‡æ»¤æ¡ä»¶å¯ä»¥åˆ©ç”¨ç°æœ‰çš„ç´¢å¼•ï¼Œè°“è¯ä¸‹æ¨å¯ä»¥ä½¿å¾—æŸ¥è¯¢ç›´æ¥åˆ©ç”¨ç´¢å¼•æ¥å¿«é€Ÿå®šä½æ•°æ®ï¼Œè€Œä¸æ˜¯æ‰«ææ•´ä¸ªè¡¨ã€‚ ä¼˜åŒ–æŸ¥è¯¢è®¡åˆ’ï¼šæ•°æ®åº“ä¼˜åŒ–å™¨ä¼šæ ¹æ®è°“è¯ä¸‹æ¨çš„åŸåˆ™é‡æ–°è§„åˆ’æŸ¥è¯¢çš„æ‰§è¡Œæ­¥éª¤ï¼Œç”Ÿæˆæ›´é«˜æ•ˆçš„æŸ¥è¯¢è®¡åˆ’ã€‚ ä¾‹å¦‚ï¼š\nSELECT * FROM employees WHERE department_id = 5 AND salary \u003e 50000; åœ¨è¿™ä¸ªæŸ¥è¯¢ä¸­ï¼ŒWHERE å­å¥åŒ…å«äº†ä¸¤ä¸ªè¿‡æ»¤æ¡ä»¶ã€‚å¦‚æœä¸è¿›è¡Œè°“è¯ä¸‹æ¨ï¼Œæ•°æ®åº“å¯èƒ½ä¼šå…ˆæ‰«ææ•´ä¸ª employees è¡¨ï¼Œç„¶åå°†æ‰€æœ‰è¡Œä¼ é€’ç»™ä¸Šå±‚æ“ä½œï¼Œä¹‹åå†åº”ç”¨è¿‡æ»¤æ¡ä»¶ã€‚è€Œé€šè¿‡è°“è¯ä¸‹æ¨ï¼Œæ•°æ®åº“å¯ä»¥åœ¨æ‰«æè¡¨çš„æ—¶å€™ç›´æ¥åº”ç”¨è¿™äº›è¿‡æ»¤æ¡ä»¶ï¼Œåªè¿”å›éƒ¨é—¨ ID ä¸º 5 ä¸”è–ªèµ„å¤§äº 50000 çš„å‘˜å·¥è®°å½•ã€‚\nè°“è¯ä¸‹æ¨æ˜¯æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–ä¸­éå¸¸é‡è¦çš„ä¸€ç¯ï¼Œå®ƒæœ‰åŠ©äºæé«˜æŸ¥è¯¢æ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†å¤§è§„æ¨¡æ•°æ®é›†æ—¶ã€‚æ•°æ®åº“ä¼˜åŒ–å™¨ä¼šå°è¯•è‡ªåŠ¨åº”ç”¨è°“è¯ä¸‹æ¨ï¼Œä½†æœ‰æ—¶å¼€å‘è€…ä¹Ÿå¯ä»¥é€šè¿‡ç¼–å†™æ›´ä¼˜åŒ–çš„æŸ¥è¯¢æ¡ä»¶æ¥å¸®åŠ©ä¼˜åŒ–å™¨æ›´å¥½åœ°è¿›è¡Œè°“è¯ä¸‹æ¨ã€‚\nTask1 - Access Method Executors SeqScan é¡ºåºæ‰«ææŒ‡å®šçš„è¡¨ï¼Œè¡¨çš„éå†å¯ä»¥ä½¿ç”¨ TableIteratorã€‚\næ¯æ¬¡æ‰¾åˆ°ä¸€æ¡æ²¡æœ‰è¢«æ ‡è®°ä¸ºâ€œåˆ é™¤â€æˆ–è€…ä¸æ˜¯ where ä¹‹ç±»çš„è¿‡æ»¤å­å¥åŒ¹é…ï¼ˆè¿™é‡Œä¼šåœ¨ delete æ“ä½œä¸­è¯´æ˜ï¼‰çš„ tupleï¼ˆè®°å½•ï¼‰å°±å¹¶è¿”å›ï¼Œå¦‚æœå·²ç»æ‰«æåˆ°äº†è¡¨çš„ç»“æŸä½ç½®åˆ™è¿”å› falseã€‚\nInsert ä¸ºä»€ä¹ˆ Insert ç­‰ Executor æœ‰ child è€Œ SeqScan æ²¡æœ‰ï¼Ÿ InsertExecutorÂ çš„ä¸»è¦èŒè´£æ˜¯å°†ä¸€æ¡æˆ–å¤šæ¡è®°å½•æ’å…¥åˆ°æŒ‡å®šçš„è¡¨ä¸­ã€‚å®ƒå¯èƒ½éœ€è¦ä¾èµ–äºå…¶ä»–Â ExecutorÂ æ¥è·å–è¦æ’å…¥çš„æ•°æ®ã€‚ä¾‹å¦‚ï¼Œå¦‚æœÂ INSERTÂ æ“ä½œæ˜¯ä»ä¸€ä¸ªÂ SELECTÂ æŸ¥è¯¢çš„ç»“æœé›†ä¸­æ’å…¥æ•°æ®ï¼Œé‚£ä¹ˆÂ InsertExecutorÂ å¯èƒ½ä¼šæœ‰ä¸€ä¸ªå­Â Executorï¼ˆå¦‚Â SeqScanExecutorÂ æˆ–å…¶ä»–ç±»å‹çš„Â Executorï¼‰ï¼Œè¯¥å­Â ExecutorÂ è´Ÿè´£æ‰§è¡ŒÂ SELECTÂ æ“ä½œå¹¶æä¾›æ•°æ®ç»™Â InsertExecutorã€‚\nå› æ­¤ï¼ŒInsertExecutorÂ æœ‰ child æ˜¯å› ä¸ºå®ƒå¯èƒ½éœ€è¦ä»å¦ä¸€ä¸ªæŸ¥è¯¢çš„ç»“æœä¸­è·å–æ•°æ®ã€‚\nSeqScanExecutor çš„ä¸»è¦èŒè´£æ˜¯å¯¹è¡¨è¿›è¡Œå…¨è¡¨æ‰«æï¼Œå³æŒ‰é¡ºåºè¯»å–è¡¨ä¸­çš„æ‰€æœ‰è®°å½•ã€‚è¿™æ˜¯ä¸€ä¸ªåŸºæœ¬çš„æ“ä½œï¼Œé€šå¸¸ä¸éœ€è¦å…¶ä»–Â ExecutorÂ çš„æ”¯æŒæ¥å®Œæˆå…¶å·¥ä½œã€‚\nå®ƒç›´æ¥ä½œç”¨äºå­˜å‚¨å±‚ï¼Œéå†è¡¨ä¸­çš„æ¯ä¸€è¡Œæ•°æ®ï¼Œå› æ­¤æ²¡æœ‰å­Â Executorã€‚å®ƒçš„ä»»åŠ¡ç›¸å¯¹ç®€å•ï¼Œå°±æ˜¯éå†å’Œè¿”å›è¡¨ä¸­çš„æ‰€æœ‰è®°å½•ã€‚\nç®€è€Œè¨€ä¹‹ï¼ŒInsertExecutor éœ€è¦ child æ˜¯å› ä¸ºå®ƒçš„æ“ä½œå¯èƒ½æ¶‰åŠä»å…¶ä»–æŸ¥è¯¢ç»“æœä¸­è·å–æ•°æ®ï¼Œè€Œ SeqScanExecutor ä¸éœ€è¦ child æ˜¯å› ä¸ºå®ƒçš„ä»»åŠ¡æ˜¯ç‹¬ç«‹å®Œæˆçš„ï¼Œåªéœ€éå†è¡¨ä¸­çš„æ‰€æœ‰è®°å½•å³å¯ã€‚è¿™åæ˜ äº†æ•°æ®åº“æ‰§è¡Œè®¡åˆ’ä¸­ä¸åŒæ“ä½œä¹‹é—´çš„ä¾èµ–å…³ç³»å’Œäº¤äº’æ–¹å¼ã€‚å…¶ä»– Executor åŒç†ã€‚\nä¸¾ä¸ªæ‰¹é‡æ’å…¥çš„ğŸŒ°ï¼š\nå‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ª orders è¡¨ï¼ŒåŒ…å«ä»¥ä¸‹åˆ—ï¼š\norder_idÂ (ä¸»é”®) customer_id product_id quantity order_date æˆ‘ä»¬å¸Œæœ›é€šè¿‡ä¸€ä¸ªå­æŸ¥è¯¢ï¼ˆselectï¼‰æ¥è·å–ä¸€æ‰¹è®¢å•è®°å½•ï¼Œå¹¶å°†è¿™äº›è®°å½•æ’å…¥åˆ° orders è¡¨ä¸­ï¼š\nINSERT INTO orders (customer_id, product_id, quantity, order_date) SELECT customer_id, product_id, quantity, order_date FROM pending_orders WHERE status = 'approved'; å¾ˆæ˜æ˜¾ï¼Œæˆ‘ä»¬åœ¨æ’å…¥ä¹‹å‰è¦ä» select å­å¥ä¸­è·å–æ•°æ®ï¼Œå› æ­¤è¿™ä¸ªå­æŸ¥è¯¢æ“ä½œå°±æ˜¯ insert æ“ä½œçš„ child_executorã€‚\næ²¡æœ‰å­æ“ä½œæ—¶ï¼Œéœ€è¦æ’å…¥çš„æ•°æ®ä»å“ªé‡Œè·å–ï¼Ÿ æ¯”å¦‚æ‰§è¡Œå¦‚ä¸‹ SQL æ—¶ï¼š\ninsert into test_1 values (202, 1, 2, 3); ä»è‚‰çœ¼çœ‹å¯ä»¥çŸ¥é“éœ€è¦æ’å…¥çš„æ•°æ®ä¸º (202, 1, 2, 3)ï¼Œä½†æ˜¯åœ¨ä»£ç ä¸­åˆæ˜¯ä»å“ªé‡Œè·å–çš„å‘¢ï¼Ÿ\nè®©æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸‹ explain å·¥å…·æ¥çœ‹çœ‹è¿™æ¡ SQL è¯­å¥åœ¨ bustub å†…éƒ¨åšäº†ä»€ä¹ˆï¼š\nbustub\u003e explain insert into test_1 values (202, 1, 2, 3); === BINDER === BoundInsert { table=BoundBaseTableRef { table=test_1, oid=22 }, select= BoundSelect { table=BoundExpressionListRef { identifier=__values#0, values=[[\"202\", \"1\", \"2\", \"3\"]] }, columns=[\"__values#0.0\", \"__values#0.1\", \"__values#0.2\", \"__values#0.3\"], groupBy=[], having=, where=, limit=, offset=, order_by=[], is_distinct=false, ctes=, } } === PLANNER === Insert { table_oid=22 } | (__bustub_internal.insert_rows:INTEGER) Projection { exprs=[\"#0.0\", \"#0.1\", \"#0.2\", \"#0.3\"] } | (__values#0.0:INTEGER, __values#0.1:INTEGER, __values#0.2:INTEGER, __values#0.3:INTEGER) Values { rows=1 } | (__values#0.0:INTEGER, __values#0.1:INTEGER, __values#0.2:INTEGER, __values#0.3:INTEGER) === OPTIMIZER === Insert { table_oid=22 } | (__bustub_internal.insert_rows:INTEGER) Values { rows=1 } | (__values#0.0:INTEGER, __values#0.1:INTEGER, __values#0.2:INTEGER, __values#0.3:INTEGER) å°†ç›®æ ‡èšç„¦åœ¨ç”Ÿæˆçš„æŸ¥è¯¢è®¡åˆ’ä¸Šï¼Œä»ä¸Šåˆ°ä¸‹ï¼Œåœ¨ä¸€ä¸ª Insert çš„æŸ¥è¯¢è®¡åˆ’ä¸­ï¼Œä½¿ç”¨ Projection ä»å…¶è¾“å…¥æºï¼ˆå¦‚è¡¨æ‰«æã€ç´¢å¼•æ‰«æã€è¿æ¥ç­‰ï¼‰ä¸­æå–æ‰€éœ€çš„åˆ—ï¼Œæœ€ä¸‹å±‚ä½¿ç”¨ Value è·å–åˆ°è¦æ“ä½œçš„æ•°æ®ï¼\næ‰€ä»¥å¯¹åº”çš„ï¼ŒInsertExecutor çš„ child_executor ä¸º ProjectionExecutorï¼Œè€Œ ProjectionExecutor çš„ child_executor ä¸º ValuesExecutorï¼Œä½¿ç”¨è¿­ä»£å™¨æ¨¡å‹å°±èƒ½å¾ˆæ–¹ä¾¿çš„è·å–åˆ°æ•°æ®äº†ï¼ˆValuesExecutor å°±æ˜¯æœ€åçš„ Executorï¼Œå…¶ Next å‡½æ•°ä¸ä¼šå†å¾€ä¸‹è°ƒç”¨ï¼Œå…¶æ‰€åšçš„åªæ˜¯æ ¹æ®åœ¨è§£æ SQL åŠå…¶ä¹‹åçš„ä¸€äº›æ­¥éª¤ä¸­å¾—åˆ°çš„éœ€è¦æ“ä½œçš„æ•°æ®å°è£…æˆä¸€ä¸ª tuple è¿›è¡Œè¿”å›ï¼‰ã€‚\nDelete éœ€è¦å†™çš„ä»£ç å’Œ insert æ“ä½œçš„åŸºæœ¬ç›¸åŒã€‚ä½†æœ‰ä¸ªåœ°æ–¹éœ€è¦æ³¨æ„ä¸€ä¸‹ï¼Œåœ¨æ‰§è¡Œä¸€æ¡ delete è¯­å¥æ—¶ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹åšäº†äº›ä»€ä¹ˆï¼š\nbustub\u003e explain delete from test_1 where colA = 999; === BINDER === Delete { table=BoundBaseTableRef { table=test_1, oid=22 }, expr=(test_1.colA=999) } === PLANNER === Delete { table_oid=22 } | (__bustub_internal.delete_rows:INTEGER) Filter { predicate=(#0.0=999) } | (test_1.colA:INTEGER, test_1.colB:INTEGER, test_1.colC:INTEGER, test_1.colD:INTEGER) SeqScan { table=test_1 } | (test_1.colA:INTEGER, test_1.colB:INTEGER, test_1.colC:INTEGER, test_1.colD:INTEGER) === OPTIMIZER === Delete { table_oid=22 } | (__bustub_internal.delete_rows:INTEGER) SeqScan { table=test_1, filter=(#0.0=999) } | (test_1.colA:INTEGER, test_1.colB:INTEGER, test_1.colC:INTEGER, test_1.colD:INTEGER) å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ optimizer é˜¶æ®µï¼Œwhere å­å¥çš„ filter ä¸‹æ”¾è‡³ SeqScan å¤„ä¸å…¶åˆå¹¶äº†ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å®ç° SeqScanExecutor æ—¶æ³¨æ„å¤„ç†ä¸€ä¸‹ filterã€‚è¿™é‡Œæç¤ºä¸€ä¸‹ï¼š\nwhile (cur_tuple.first.is_deleted_ || (plan_-\u003efilter_predicate_ \u0026\u0026 !(plan_-\u003efilter_predicate_-\u003eEvaluate(tuple, GetOutputSchema()).GetAs\u003cbool\u003e()))) å¦‚æœå…¶è¿”å› trueï¼Œè¯´æ˜ filter åŒ¹é…åˆ°äº†æ•°æ®ï¼ˆå°±å¦‚ä¾‹å­ä¸­åŒ¹é…åˆ°äº† colA åˆ—ä¸º 999 çš„ tupleï¼‰ï¼Œå¦‚æœæ­¤æ—¶è¿™ä¸ª tuple æ²¡æœ‰è¢«æ ‡è®°ä¸ºåˆ é™¤ï¼Œé‚£ä¹ˆå°±è¯´æ˜æ‰¾åˆ°äº†æˆ‘ä»¬éœ€è¦åˆ é™¤çš„ tupleã€‚\nUpdate æˆ‘ä»¬å¦‚ä½•çŸ¥é“ update éœ€è¦æ›´æ–°çš„æ•°æ®ä»å“ªé‡Œå–å‘¢ï¼Ÿ\nbustub\u003e explain(p, o) update test_1 set colB = 15445; === PLANNER === Update { table_oid=22, target_exprs=[\"#0.0\", \"15445\", \"#0.2\", \"#0.3\"] } Filter { predicate=true } SeqScan { table=test_1 } === OPTIMIZER === Update { table_oid=22, target_exprs=[\"#0.0\", \"15445\", \"#0.2\", \"#0.3\"] } SeqScan { table=test_1, filter=true } çœ‹çœ‹ Update ä¸­ï¼Œæœ‰ä¸€ä¸ª target_exprs æ•°ç»„ï¼Œè¿™ä¸ªæ•°ç»„å¯ä¸å°±æ˜¯æˆ‘ä»¬çš„ä¸€è¡Œæ•°æ®å—ï¼Œå¹¶ä¸”æ˜¯éœ€è¦æ›´æ–°çš„é‚£è¡Œæ•°æ®ï¼šupdate è¯­å¥å¯ä»¥ä¸åŠ  where å­å¥ï¼Œè¿™æ ·å°±æ˜¯é€‰ä¸­è¡¨ä¸­çš„æ‰€æœ‰è¡Œï¼Œä¹Ÿå°±æ˜¯è¿™é‡Œå°†è¡¨ä¸­ colB åˆ—çš„æ•°æ®éƒ½ update ä¸º 15445ï¼\nå¯¹äº target_exprs è¿™ä¸ªæ•°ç»„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ plan_-\u003etarget_expressions_ è·å–ï¼Œç„¶åç”¨å…¶æ„å»ºä¸€ä¸ªæ–°çš„ tupleã€‚\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œå¹¶æ²¡æœ‰æä¾›ç›´æ¥æ›´æ–° tuple çš„æ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬çš„ update æ“ä½œå¯ä»¥ç”¨å…ˆåˆ é™¤åæ’å…¥çš„æ–¹å¼æ¥æ¨¡æ‹Ÿã€‚\nIndexScan æˆ‘ä»¬é¦–å…ˆéœ€è¦å®Œæˆ OptimizeSeqScanAsIndexScan è¿™ä¸ªä¼˜åŒ–æ­¥éª¤ã€‚\nå‡è®¾ç°åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ªè¡¨å«â€œtest_1â€ï¼Œå…¶åˆ—å¦‚ä¸‹ï¼š\n+-------------+-------------+-------------+-------------+ | test_1.colA | test_1.colB | test_1.colC | test_1.colD | +-------------+-------------+-------------+-------------+ ç°åœ¨æˆ‘ä»¬å¸Œæœ›è¿™æ¡ SQL èƒ½æ‰§è¡Œçš„æ›´å¿«ï¼š\nselect * from test_1 where colB = 11; é‚£æ¯”è¾ƒä¸é”™çš„æ–¹æ³•å°±æ˜¯ç»™ colB åˆ—åŠ ä¸Šç´¢å¼•ï¼š\ncreate index v1 on test_1(colB); è¿™æ ·åœ¨æ‰§è¡Œæ—¶å¯ä»¥æ›´å¿«é€Ÿçš„æŸ¥æ‰¾æ•°æ®ã€‚\né‚£ä¹ˆä¸ºäº†å®ç°è¿™ä¸€ç›®æ ‡ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡ OptimizeSeqScanAsIndexScan å°† plan æ ‘ä¸­çš„ SeqScanPlanNode è½¬æ¢æˆ IndexScanPlanNodeï¼Œè¿™æ ·æˆ‘ä»¬æ‰èƒ½ä½¿ç”¨ IndexScanPlanNode å¯¹åº”çš„ç®—å­ â€”IndexScanExecutor å»ä½¿ç”¨ç´¢å¼•ã€‚ä½†æ˜¯ç”±äº bustub çš„ä¸€äº›è®¾è®¡ï¼Œéœ€è¦éµå¾ªä»¥ä¸‹è§„åˆ™æ‰å¯ä»¥è½¬åŒ–ï¼š\nå½“å‰çš„èŠ‚ç‚¹çš„ç±»å‹å¿…é¡»æ˜¯ PlanType::SeqScan å½“å‰èŠ‚ç‚¹å¿…é¡»æœ‰ filter è°“è¯ï¼Œå¦‚æœåªæ˜¯ select * from test_1; è¿™æ ·çš„æ˜¯ä¸éœ€è¦ä½¿ç”¨ç´¢å¼•çš„ å½“å‰è¡¨ä¸­å¿…é¡»æœ‰ç´¢å¼•ï¼Œæ²¡æœ‰ç´¢å¼•è¿˜ç©å•¥å‘¢ fileter è°“è¯ä¸­çš„é€»è¾‘è¡¨è¾¾å¼åªèƒ½æœ‰ä¸€ä¸ªï¼Œå¹¶ä¸”å…¶ç±»å‹å¿…é¡»æ˜¯ ComparisonType::Equalï¼ˆæˆ‘æƒ³è¿™é‡Œå¿…é¡»æ˜¯â€œç­‰äºâ€æ˜¯ä¸æ˜¯å› ä¸º fall2023 ä½¿ç”¨çš„ç´¢å¼•æ˜¯å“ˆå¸Œç´¢å¼•ï¼‰ åœ¨å½“å‰è¡¨çš„ç´¢å¼•ä¿¡æ¯ä¸­æ‰¾åˆ°ä¸ filter è°“è¯ç›¸å¯¹åº”çš„ç´¢å¼•åæ‰èƒ½è¿”å›ä¸€ä¸ª IndexScanPlanNode åœ¨ select * from test_1 where colB = 11; ä¸­ï¼ŒåŠ äº†ç´¢å¼•åï¼Œæœ€éœ€è¦å…³æ³¨çš„å°±æ˜¯ where colB = 11 è¿™ä¸€ä¸ªè¿‡æ»¤æ¡ä»¶ã€‚bustub ä¸­è¦æ±‚ IndexScan è¿‡æ»¤è¿ç®—ç¬¦å¿…é¡»æ˜¯ =ï¼Œä¸”åªèƒ½æœ‰ä¸€ä¸ªæ¡ä»¶ã€‚å¦‚æœ colA å’Œ colB éƒ½æ˜¯ç´¢å¼•ï¼Œç„¶åæ‰§è¡Œ select * from test_1 where colB = 11 and colA = 1;ï¼Œè¿™æ ·æ˜¯ä¸ä¼šèµ°ç´¢å¼•ä¼˜åŒ–çš„ã€‚\næˆ‘ä»¬å°†æŸ¥è¯¢è®¡åˆ’ä¸­çš„è¿‡æ»¤è°“è¯è½¬åŒ–æˆ ComparisonExpression ç±»å‹ï¼Œæ®æˆ‘çš„ç†è§£ï¼Œå…¶å¯é€šè¿‡ GetChildAt å‡½æ•°è·å–æ¯”è¾ƒè°“è¯å·¦è¾¹çš„åˆ—åè¡¨è¾¾å¼ï¼ˆå³è¿™é‡Œçš„â€œcolBâ€ï¼Œæœ‰äº†è¿™ä¸ªåˆ—åçš„è¡¨è¾¾å¼ï¼Œæˆ‘ä»¬å°±å¯ä»¥è·å–åˆ°è¿™ä¸ªåˆ—çš„ col_id å€¼ï¼‰å’Œå³è¾¹çš„å€¼ï¼ˆå³â€œ11â€ï¼‰ã€‚ä¹‹åéœ€è¦å»è¿™å¼ è¡¨ä¸­çš„æ‰€æœ‰ç´¢å¼•ä¸­å»æ‰¾æ˜¯å¦æœ‰ colB çš„ç´¢å¼•ï¼Œæ€ä¹ˆç¡®å®šæ˜¯å¦æœ‰å‘¢ï¼Œé‚£å°±è¦çœ‹è¿™ä¸ªè¡¨ä¸­çš„æ¯ä¸ª Index çš„ key_attrs_ï¼š\nåœ¨ Index ä¸­ï¼Œkey_attrs_ å†³å®šäº†ç´¢å¼•çš„å…³é”®å­—ç”±å“ªäº›åˆ—ç»„æˆï¼Œå¯¹åº”äº†æ¯ä¸ªåˆ—çš„ä¸‹æ ‡ã€‚ä¾‹å¦‚ï¼š\nå¦‚æœè¡¨çš„ schema å®šä¹‰æœ‰ 5 åˆ—ï¼Œåˆ†åˆ«ä¸º A, B, C, D, Eã€‚ æŸä¸ªç´¢å¼•çš„ key_attrs_ æ˜¯ [0, 2]ï¼Œåˆ™è¡¨ç¤ºè¯¥ç´¢å¼•ä½¿ç”¨äº†ç¬¬ 0 åˆ—ï¼ˆAï¼‰å’Œç¬¬ 2 åˆ—ï¼ˆCï¼‰ä½œä¸ºå…¶å…³é”®å­—ã€‚ å¦‚æœä¹‹å‰æˆ‘ä»¬è·å–çš„åˆ—çš„ col_id å€¼å’ŒæŸä¸ª Index çš„ key_attrs_ ä¸­çš„å€¼ç›¸åŒï¼Œé‚£ä¹ˆå°±å­˜åœ¨ç›¸åº”çš„ç´¢å¼•ï¼è¿™æ—¶æ„é€ ä¸€ä¸ª IndexScanPlanNode è¿”å›å³å¯ï¼ˆå‚è€ƒ merge_filter_scan.cpp ä¸­æ˜¯å¦‚ä½•åšçš„ï¼‰ã€‚\nå½“ä¼˜åŒ–å™¨æˆåŠŸæ›´æ¢èŠ‚ç‚¹åï¼Œåœ¨æ‰§è¡Œæ—¶å°±ä¼šèµ°ç´¢å¼•ï¼Œå…¶åº•å±‚ç®—å­å°±ä¼šä½¿ç”¨åˆ° IndexScanExecutorã€‚åˆ°è¿™é‡Œï¼Œè¿™ä¸ªç®—å­éœ€è¦åšçš„äº‹æƒ…å°±å¾ˆç®€å•äº†ï¼Œå°±æ˜¯è°ƒç”¨å“ˆå¸Œç´¢å¼•çš„ ScanKey è¿›è¡ŒæŸ¥æ‰¾ï¼Œä¸è¿‡è¿™é‡Œæœ‰ 3 ç‚¹éœ€è¦æ³¨æ„ï¼š\nåœ¨ project2 ä¸­ï¼Œæˆ‘ä»¬å®ç°çš„ç´¢å¼•å¼•æ“åªæ”¯æŒä¸€ä¸ªé”®å¯¹åº”ä¸€ä¸ªå€¼ï¼ˆä¸åªæ˜¯è¿™ä¸ªç‰ˆæœ¬çš„å¯æ‹“å±•å“ˆå¸Œï¼Œå…¶ä»–ç‰ˆæœ¬ä¸­çš„ B+Tree ä¹Ÿåªè¦æ±‚è¿™æ ·å®ç°ï¼‰ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„è¿™ä¸ªç®—å­åœ¨åº•å±‚ç´¢å¼•å¼•æ“ä¸æ‰©å±•çš„æƒ…å†µä¸‹æœ€å¤šæŸ¥åˆ°ä¸€æ¡è®°å½•ï¼Œè¿™æ ·çš„è¯å°±å¯ä»¥åœ¨ç®—å­çš„ Init å‡½æ•°ä¸­è°ƒç”¨ ScanKey æŸ¥æ‰¾è®°å½•å°±è¡Œã€‚ å¯æ‹“å±•å“ˆå¸Œä¸­æ˜¯å°†ä¸€ä¸ª Tuple çš„ data è½¬åŒ–ä¸€ä¸‹å½“ä½œ keyï¼Œæ‰€ä»¥åœ¨ç´¢å¼•ä¸­ï¼Œå…¶æ˜¯å°†ç´¢å¼•åˆ—çš„å€¼ä½œä¸º keyï¼Œå…¶å¯¹åº”çš„ oid ä½œä¸ºå€¼ã€‚åœ¨ä½¿ç”¨ ScanKey æ—¶ï¼Œç¬¬ä¸€ä¸ªå‚æ•°éœ€è¦çš„ tuple å°†ç”¨æŸ¥è¯¢è®¡åˆ’èŠ‚ç‚¹ IndexScanPlanNode ä¸­çš„ pred_key_ æ„é€ ã€‚ è¡¨ä¸­çš„ tuple çš„å…ƒæ•°æ®ä¸­ï¼Œå…¶ is_deleted_ å¯èƒ½ä¸º trueï¼Œè¿™è¯´æ˜è¿™ä¸ª tuple åœ¨é€»è¾‘ä¸Šå·²ç»åˆ é™¤äº†ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬é€šè¿‡ 2 ä¸­è·å–çš„ oid å¯¹åº”çš„ tuple æ˜¯è¿™ç§æƒ…å†µï¼Œå°±ä¸ç”¨å‘ä¸Šè¿”å›æ•°æ®ã€‚ Task2 - Aggregation \u0026 Join Executors Aggregation åˆ†æä¸€ä¸ªä¾‹å­ï¼š\nbustub\u003e EXPLAIN SELECT MAX(colC), MIN(colB) FROM test_1 GROUP BY colA HAVING MAX(colB) \u003e 10; === BINDER === BoundSelect { table=BoundBaseTableRef { table=test_1, oid=22 }, columns=[\"max([\\\"test_1.colC\\\"])\", \"min([\\\"test_1.colB\\\"])\"], groupBy=[\"test_1.colA\"], having=(max([\"test_1.colB\"])\u003e10), where=, limit=, offset=, order_by=[], is_distinct=false, ctes=, } === PLANNER === Projection { exprs=[\"#0.2\", \"#0.3\"] } | (\u003cunnamed\u003e:INTEGER, \u003cunnamed\u003e:INTEGER) Filter { predicate=(#0.1\u003e10) } | (test_1.colA:INTEGER, agg#0:INTEGER, agg#1:INTEGER, agg#2:INTEGER) Agg { types=[\"max\", \"max\", \"min\"], aggregates=[\"#0.1\", \"#0.2\", \"#0.1\"], group_by=[\"#0.0\"] } | (test_1.colA:INTEGER, agg#0:INTEGER, agg#1:INTEGER, agg#2:INTEGER) SeqScan { table=test_1 } | (test_1.colA:INTEGER, test_1.colB:INTEGER, test_1.colC:INTEGER, test_1.colD:INTEGER) === OPTIMIZER === Projection { exprs=[\"#0.2\", \"#0.3\"] } | (\u003cunnamed\u003e:INTEGER, \u003cunnamed\u003e:INTEGER) Filter { predicate=(#0.1\u003e10) } | (test_1.colA:INTEGER, agg#0:INTEGER, agg#1:INTEGER, agg#2:INTEGER) Agg { types=[\"max\", \"max\", \"min\"], aggregates=[\"#0.1\", \"#0.2\", \"#0.1\"], group_by=[\"#0.0\"] } | (test_1.colA:INTEGER, agg#0:INTEGER, agg#1:INTEGER, agg#2:INTEGER) SeqScan { table=test_1 } | (test_1.colA:INTEGER, test_1.colB:INTEGER, test_1.colC:INTEGER, test_1.colD:INTEGER) å¯¹äº AggregationExecutorï¼Œæˆ‘ä»¬å¯ä»¥è·å–åˆ° SQL è¯­å¥ä¸­ï¼š\nèšåˆæ“ä½œçš„ typesï¼ˆè¿›è¡Œèšåˆæ“ä½œçš„ç±»å‹ï¼‰å’Œ aggregatesï¼ˆéœ€è¦èšåˆæ“ä½œçš„åˆ—ï¼‰ï¼ŒäºŒè€…ä¸€ä¸€å¯¹åº” éœ€è¦ group by è¿›è¡Œåˆ†ç»„çš„åˆ— å†çœ‹çœ‹ lecture ä¸­çš„è¿™ä¸ªä¾‹å­ï¼Œå…¶å¯¹åˆ— cid ä½¿ç”¨ group by è¿›è¡Œåˆ†ç»„ï¼Œå…¶ä¸­æ¶‰åŠçš„èšåˆæ“ä½œä¸º AVGï¼Œå¯è½¬æ¢æˆ COUNT å’Œ SUM æ“ä½œã€‚è¿™é‡Œç›¸å½“äºï¼š\ntypes = ['count', 'sum'] aggregates = ['s.gpa', 's.gpa'] æˆ‘çš„ç†è§£æ˜¯æ ¹æ® group by çš„å­—æ®µçš„å€¼è¿›è¡Œ hash å‡½æ•°å¤„ç†ä½œä¸ºå“ˆå¸Œè¡¨çš„é”®ï¼Œä¾‹å¦‚å›¾ä¸­çš„â€œ15-445â€ï¼Œâ€œ15-826â€ç­‰ï¼›ç„¶åå“ˆå¸Œè¡¨çš„å€¼ä¸ºä¸€ä¸ªé›†åˆï¼Œè¿™ä¸ªé›†åˆçš„å¤§å°å’Œ types å’Œ aggregates çš„å¤§å°ç›¸åŒï¼Œå¹¶ä¸”å¯¹åº”çš„ä½ç½®å°±ä¸º aggregates çš„å€¼ï¼šä¾‹å¦‚å›¾ä¸­é”®â€œ15-445â€çš„å€¼ä¸­ï¼Œç¬¬ä¸€ä¸ªå…ƒç´ å°±ä¸º COUNT æ“ä½œä¸‹ s.gpa ä¸º 15-445 çš„ä¸ªæ•°ã€‚\nåœ¨ lab ä¸­éœ€è¦å®ç° countã€sumã€maxã€min æ“ä½œï¼Œå…¶å®å°±æ˜¯åœ¨ SimpleAggregationHashTableï¼šï¼šCombineAggregateValues ä¸­å®ç°å¯¹åº”çš„æ“ä½œå³å¯ï¼Œæœ¬è´¨ä¸Šæ˜¯å¯¹å“ˆå¸Œè¡¨çš„å‡ ä¸ªå¾ˆç®€å•çš„æ“ä½œã€‚\naggregation é€šå¸¸éœ€è¦å¯¹ä¸€ç»„æ•°æ®è¿›è¡Œè®¡ç®—ï¼Œè¿™äº›è®¡ç®—å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š\néœ€è¦å®Œæ•´è¾“å…¥ï¼šAggregation é€šå¸¸éœ€è¦ä»ä¸‹å±‚æ‹‰å–æ‰€æœ‰ç›¸å…³æ•°æ®æ‰èƒ½è®¡ç®—ç»“æœï¼Œä¾‹å¦‚è®¡ç®— SUM éœ€è¦éå†æ‰€æœ‰è¡Œã€‚ é˜»å¡æ€§ï¼šåœ¨ä¼ ç»Ÿå®ç°ä¸­ï¼ŒAggregation ç®—å­é€šå¸¸è¢«ç§°ä¸ºâ€œé˜»å¡ç®—å­â€ï¼Œå› ä¸ºå®ƒå¿…é¡»ç­‰å¾…æ‰€æœ‰è¾“å…¥æ•°æ®éƒ½æ‹‰å–å®Œæˆæ‰èƒ½äº§å‡ºç»“æœã€‚è¿™æ„å‘³ç€ next() è°ƒç”¨ä¼šè¢«å»¶è¿Ÿï¼Œç›´åˆ°èšåˆè®¡ç®—å®Œæˆã€‚ åœ¨æˆ‘ä»¬çš„ç«å±±æ¨¡å‹ä¸­ aggregation æ˜¯é˜»å¡ç®—å­ï¼š\nå½“ä¸Šå±‚ç®—å­è°ƒç”¨ next() æ—¶ï¼Œaggregation ä¼šå‘ä¸‹å±‚ç®—å­è¿ç»­è°ƒç”¨ next()ï¼Œç›´åˆ°æ‹‰å–å®Œå…¨éƒ¨æ•°æ®å¹¶å®Œæˆèšåˆã€‚ åœ¨æ•°æ®å°šæœªå®Œå…¨æ‹‰å–å¹¶èšåˆå®Œæˆä¹‹å‰ï¼Œä¸Šå±‚çš„ next() è°ƒç”¨æ— æ³•ç›´æ¥è¿”å›ç»“æœã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼š\nSQL ä¸­è¿›è¡Œ group by åä½¿ç”¨ countï¼Œç»Ÿè®¡çš„æ˜¯æ¯ç»„æ•°æ®ä¸­çš„è®°å½•æ•°ï¼Œè€Œéåˆ†ç»„åæ–°è¡¨çš„è¡Œæ•°ã€‚ distinct å…¶å®å°±æ˜¯å¯¹æŸä¸ªå­—æ®µè¿›è¡Œ group by æ“ä½œ count(*) ç»Ÿè®¡ nullï¼Œè€Œ count(å­—æ®µ) ä¸ç»Ÿè®¡ null NestedLoopJoin Inner Joinï¼š\nbustub\u003e EXPLAIN SELECT * FROM __mock_table_1, __mock_table_3 WHERE colA = colE; === BINDER === BoundSelect { table=BoundCrossProductRef { left=BoundBaseTableRef { table=__mock_table_1, oid=0 }, right=BoundBaseTableRef { table=__mock_table_3, oid=2 } }, columns=[\"__mock_table_1.colA\", \"__mock_table_1.colB\", \"__mock_table_3.colE\", \"__mock_table_3.colF\"], groupBy=[], having=, where=(__mock_table_1.colA=__mock_table_3.colE), limit=, offset=, order_by=[], is_distinct=false, ctes=, } === PLANNER === Projection { exprs=[\"#0.0\", \"#0.1\", \"#0.2\", \"#0.3\"] } | (__mock_table_1.colA:INTEGER, __mock_table_1.colB:INTEGER, __mock_table_3.colE:INTEGER, __mock_table_3.colF:VARCHAR) Filter { predicate=(#0.0=#0.2) } | (__mock_table_1.colA:INTEGER, __mock_table_1.colB:INTEGER, __mock_table_3.colE:INTEGER, __mock_table_3.colF:VARCHAR) NestedLoopJoin { type=Inner, predicate=true } | (__mock_table_1.colA:INTEGER, __mock_table_1.colB:INTEGER, __mock_table_3.colE:INTEGER, __mock_table_3.colF:VARCHAR) MockScan { table=__mock_table_1 } | (__mock_table_1.colA:INTEGER, __mock_table_1.colB:INTEGER) MockScan { table=__mock_table_3 } | (__mock_table_3.colE:INTEGER, __mock_table_3.colF:VARCHAR) === OPTIMIZER === NestedLoopJoin { type=Inner, predicate=(#0.0=#1.0) } | (__mock_table_1.colA:INTEGER, __mock_table_1.colB:INTEGER, __mock_table_3.colE:INTEGER, __mock_table_3.colF:VARCHAR) MockScan { table=__mock_table_1 } | (__mock_table_1.colA:INTEGER, __mock_table_1.colB:INTEGER) MockScan { table=__mock_table_3 } | (__mock_table_3.colE:INTEGER, __mock_table_3.colF:VARCHAR) bustub\u003e EXPLAIN SELECT * FROM __mock_table_1 INNER JOIN __mock_table_3 ON colA = colE; === BINDER === BoundSelect { table=BoundJoin { type=Inner, left=BoundBaseTableRef { table=__mock_table_1, oid=0 }, right=BoundBaseTableRef { table=__mock_table_3, oid=2 }, condition=(__mock_table_1.colA=__mock_table_3.colE) }, columns=[\"__mock_table_1.colA\", \"__mock_table_1.colB\", \"__mock_table_3.colE\", \"__mock_table_3.colF\"], groupBy=[], having=, where=, limit=, offset=, order_by=[], is_distinct=false, ctes=, } === PLANNER === Projection { exprs=[\"#0.0\", \"#0.1\", \"#0.2\", \"#0.3\"] } | (__mock_table_1.colA:INTEGER, __mock_table_1.colB:INTEGER, __mock_table_3.colE:INTEGER, __mock_table_3.colF:VARCHAR) NestedLoopJoin { type=Inner, predicate=(#0.0=#1.0) } | (__mock_table_1.colA:INTEGER, __mock_table_1.colB:INTEGER, __mock_table_3.colE:INTEGER, __mock_table_3.colF:VARCHAR) MockScan { table=__mock_table_1 } | (__mock_table_1.colA:INTEGER, __mock_table_1.colB:INTEGER) MockScan { table=__mock_table_3 } | (__mock_table_3.colE:INTEGER, __mock_table_3.colF:VARCHAR) === OPTIMIZER === NestedLoopJoin { type=Inner, predicate=(#0.0=#1.0) } | (__mock_table_1.colA:INTEGER, __mock_table_1.colB:INTEGER, __mock_table_3.colE:INTEGER, __mock_table_3.colF:VARCHAR) MockScan { table=__mock_table_1 } | (__mock_table_1.colA:INTEGER, __mock_table_1.colB:INTEGER) MockScan { table=__mock_table_3 } | (__mock_table_3.colE:INTEGER, __mock_table_3.colF:VARCHAR) å¯ä»¥çœ‹åˆ°ï¼Œå³ä¾¿æˆ‘ä»¬ä¸åŠ  inner joinï¼Œé»˜è®¤æƒ…å†µä¸‹ä¹Ÿæ˜¯ä½¿ç”¨çš„ Inner Joinï¼šNestedLoopJoin ä¸­çš„ type å‡ä¸º Innerã€‚\nLeft Joinï¼š\nbustub\u003e EXPLAIN SELECT * FROM __mock_table_1 LEFT OUTER JOIN __mock_table_3 ON colA = colE; === BINDER === BoundSelect { table=BoundJoin { type=Left, left=BoundBaseTableRef { table=__mock_table_1, oid=0 }, right=BoundBaseTableRef { table=__mock_table_3, oid=2 }, condition=(__mock_table_1.colA=__mock_table_3.colE) }, columns=[\"__mock_table_1.colA\", \"__mock_table_1.colB\", \"__mock_table_3.colE\", \"__mock_table_3.colF\"], groupBy=[], having=, where=, limit=, offset=, order_by=[], is_distinct=false, ctes=, } === PLANNER === Projection { exprs=[\"#0.0\", \"#0.1\", \"#0.2\", \"#0.3\"] } | (__mock_table_1.colA:INTEGER, __mock_table_1.colB:INTEGER, __mock_table_3.colE:INTEGER, __mock_table_3.colF:VARCHAR) NestedLoopJoin { type=Left, predicate=(#0.0=#1.0) } | (__mock_table_1.colA:INTEGER, __mock_table_1.colB:INTEGER, __mock_table_3.colE:INTEGER, __mock_table_3.colF:VARCHAR) MockScan { table=__mock_table_1 } | (__mock_table_1.colA:INTEGER, __mock_table_1.colB:INTEGER) MockScan { table=__mock_table_3 } | (__mock_table_3.colE:INTEGER, __mock_table_3.colF:VARCHAR) === OPTIMIZER === NestedLoopJoin { type=Left, predicate=(#0.0=#1.0) } | (__mock_table_1.colA:INTEGER, __mock_table_1.colB:INTEGER, __mock_table_3.colE:INTEGER, __mock_table_3.colF:VARCHAR) MockScan { table=__mock_table_1 } | (__mock_table_1.colA:INTEGER, __mock_table_1.colB:INTEGER) MockScan { table=__mock_table_3 } | (__mock_table_3.colE:INTEGER, __mock_table_3.colF:VARCHAR) ç”±äºç«å±±æ¨¡å‹ä¸­çš„ Next æ¯æ¬¡è¿”å›ä¸€æ¡ tupleï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨ Init ä¸­å¾—åˆ° join åçš„æ‰€æœ‰ tupleã€‚Nested Loop Join å…¶å®å°±æ˜¯ç”¨ä¸¤ä¸ª for å¾ªç¯å»éå†ä¸¤å¼ è¡¨ï¼Œä¿å­˜æ»¡è¶³ç­›é€‰æ¡ä»¶çš„ tupleã€‚\ninner join åªä¼šè¿”å›ä¸¤ä¸ªè¡¨ä¸­æ»¡è¶³è¿æ¥æ¡ä»¶çš„ tupleï¼›è€Œ left join ä¼šè¿”å›å·¦è¡¨ä¸­çš„æ‰€æœ‰è®°å½•ï¼Œä»¥åŠå³è¡¨ä¸­æ»¡è¶³æ¡ä»¶çš„ tupleã€‚æ‰€ä»¥åœ¨åµŒå¥— for å¾ªç¯ä¸­ï¼Œå¦‚æœå³è¡¨ä¸­æœ‰æœªèƒ½æ»¡è¶³æ¡ä»¶çš„ tupleï¼Œé‚£ä¹ˆå°±ä¿å­˜å·¦è¡¨ä¸­çš„æ¯ä¸€åˆ—çš„å€¼ï¼Œå¹¶ä¸”åŠ ä¸Šå³è¡¨ä¸­æ¯ä¸€åˆ—çš„ null å€¼ã€‚\nTask3 - HashJoin Executor and Optimization ä¸ºä»€ä¹ˆéœ€è¦ hash join å‘¢ï¼Ÿå¦‚æœä¸¤å¼ è¦è¿›è¡Œ join çš„è¡¨éå¸¸å¤§ï¼Œè¿™æ—¶ä½¿ç”¨ NLJ çš„æ—¶é—´å¤æ‚åº¦å°±ä¸º O(n*m)ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬ä½¿ç”¨ hash joinï¼Œå…ˆå¯¹ä¸€å¼ è¡¨å»ºç«‹å“ˆå¸Œæ˜ å°„ï¼Œç„¶åå†å¯¹å¦ä¸€å¼ è¡¨è¿›è¡Œå“ˆå¸Œæ£€æµ‹æ¥åˆ¤æ–­æ˜¯å¦æ»¡è¶³è¿æ¥æ¡ä»¶ï¼Œè¿™æ ·å°±åªè¦å„æ‰«æä¸€æ¬¡ä¸¤å¼ è¡¨ï¼Œæ—¶é—´å¤æ‚åº¦å°±é™ä¸ºäº† O(n+m)ã€‚\nå°† NL Join ä¼˜åŒ–ä¸º Hash Join å®éªŒæŒ‡å¯¼ä¸­è¯´ï¼Œä¼˜åŒ–å™¨éœ€è¦å°† nl join ä¼˜åŒ–ä¸º hash join çš„æƒ…å†µä¸ºï¼šè¿æ¥æ¡ä»¶ä¸­æœ‰å¤šä¸ªç­‰å€¼ AND æ“ä½œï¼Œå³ x = y AND a = b AND ...ã€‚é‚£æˆ‘ä»¬åªè¦åœ¨ç¢°åˆ° NestedLoopPlanNode æ—¶è·å–å…¶è°“è¯ï¼Œåˆ¤æ–­ä¸€ä¸‹æ˜¯å¦æ»¡è¶³è¯¥æƒ…å†µå°±å¥½äº†ã€‚\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“è°“è¯ä»…ä¸º a = b æ—¶ï¼Œè¿™ä¸ªè°“è¯æ˜¯ä¸€ä¸ª ComparationExpressionï¼›è€Œå½“å®ƒä¸º x = y AND a = b AND ... æ—¶ï¼Œå®ƒæ˜¯ä¸€ä¸ª LogicExpressionã€‚è¿™é‡Œåœ¨åˆ¤æ–­çš„æ˜¯å¦éœ€è¦åŒºåˆ†ï¼Œè€Œåœ¨ä¹‹å‰çš„å®éªŒä¸­ï¼Œæœ‰å­¦ä¹ åˆ°å¯ä»¥ä½¿ç”¨æ ‡å‡†åº“ä¸­çš„ std::dynamic_pointer_cast å‡½æ•°æ¥å°†è°“è¯ä» ExpressionåŸºç±» è½¬æ¢ä¸ºæŒ‡å®šçš„ Expressionæ´¾ç”Ÿç±»ï¼Œå½“è½¬æ¢å¤±è´¥æ—¶ï¼Œä¼šè¿”å›ç©ºæŒ‡é’ˆï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿”å›çš„æŒ‡é’ˆæ¥åˆ¤æ–­æ˜¯å¦æ˜¯æƒ³è¦çš„ Expressionï¼Œå¦‚æœä¸ºç©ºï¼Œå°±ä»£è¡¨æ˜¯å¦ä¸€ä¸ª Expressionã€‚\nç”±äºè°“è¯ä¸­å¾ˆæœ‰å¯èƒ½æ˜¯ LogicExpression åµŒå¥—ç€ LogicExpression å’Œ ComparationExpressionï¼Œæ•°é‡ä¹Ÿä¸ç¡®å®šï¼Œä¸”å­ LogicExpression å¾ˆå¯èƒ½è¿˜æœ‰åµŒå¥—ï¼Œè¿™æ ·çš„è¯ä½¿ç”¨é€’å½’æ¥å¤„ç†å°±éå¸¸æ–¹ä¾¿ã€‚\nå®ç° Hash Join hash join çš„æ ¸å¿ƒå°±æ˜¯ï¼šå…ˆå¯¹ä¸€å¼ è¡¨å»ºç«‹å“ˆå¸Œæ˜ å°„ï¼Œç„¶åå†å¯¹å¦ä¸€å¼ è¡¨è¿›è¡Œå“ˆå¸Œæ£€æµ‹æ¥åˆ¤æ–­æ˜¯å¦æ»¡è¶³è¿æ¥æ¡ä»¶ã€‚å“ˆå¸Œè¡¨ä¸­çš„ key ä¸ºè¿æ¥æ¡ä»¶ä¸­å¯¹åº”çš„å€¼çš„æ‹¼æ¥ï¼Œvalue ä¸ºæ•´ä¸ª tupleã€‚è€Œä¸€å¼ è¡¨ä¸­çš„æ‰€æœ‰ tupleï¼Œå¾ˆæœ‰å¯èƒ½ä¼šæœ‰å‡ ä¸ªåˆ—æ˜¯å®Œå…¨ç›¸åŒçš„ï¼Œå¦‚æœè¿™äº›åˆ—åˆšå¥½ä½œä¸ºè¿æ¥æ¡ä»¶ï¼Œé‚£è¿›è¡Œå“ˆå¸Œæ—¶å°±ä¼šé€ æˆ key ç›¸åŒçš„æƒ…å†µï¼Œè¿™å°±é€ æˆäº†å“ˆå¸Œç¢°æ’ã€‚\nè§£å†³æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼š\nä½¿ç”¨ std::unordered_mapï¼Œå°†æ‹¼æ¥çš„åˆ—å€¼ä½œä¸º keyï¼Œè€Œå€¼çš„ç±»å‹ä¸º std::vector; ä½¿ç”¨ std::unordered_multimap æ¥å¤„ç†ã€‚ å½“æˆ‘ä»¬æ„å»ºå¥½å“ˆå¸Œè¡¨åï¼Œæ¯æ¬¡è·å–äº†å¦ä¸€å¼ è¡¨ä¸­çš„ tuple åè¿›è¡Œä¸€æ¬¡å“ˆå¸Œæ£€æµ‹ï¼Œå¦‚æœ key å­˜åœ¨ï¼Œéœ€è¦å°†æ‰€æœ‰ value éƒ½è¿›è¡Œè¿æ¥æ‹¼æ¥ã€‚åŒ nested loop join ä¸€æ ·ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†è¿æ¥ç±»å‹ä¸º left çš„æƒ…å†µã€‚\nTask4 - Sort + Limit Executors + Window Functions + Top-N Optimization Sort è¿™ä¸ªç®—å­çš„å®ç°æ€è·¯å¾ˆç®€å•ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„ä¸¤ç‚¹ï¼š\norder by åé¢å¯ä»¥è·Ÿå¤šä¸ªå…³é”®å­—ï¼Œä¹Ÿå°±æ˜¯éœ€è¦åœ¨ std::sort ä¸­å¯¹å¤šä¸ªå…³é”®å­—è¿›è¡Œæ’åºï¼ˆåˆ©ç”¨ for å¾ªç¯ï¼‰ã€‚ è¿™äº›å…³é”®å­—ä¸­å¯èƒ½è¿›è¡Œç®—æ•°è¿ç®—ï¼ˆç®—æ•°å¯¹è±¡ç±»å‹ä¸º ArithmeticExpressionï¼Œææ¸…æ¥šè¿›è¡Œè¿ç®—çš„å‡½æ•°å°±å¯ï¼‰ã€‚ Limit è¿™ä¸ªå°±æ›´ç®€å•äº†ï¼Œæ ¹æ® limit çš„è¿”å›å¯¹åº”æ•°é‡çš„ tupleã€‚\nTopN topn ç®—å­çš„ä¼˜åŒ–åªæœ‰ sort å’Œ limit åŒæ—¶å‡ºç°çš„æ˜¯å¦æ‰ä¼šè§¦å‘ï¼Œè¿™é‡Œçš„ä¼˜åŒ–é€»è¾‘æ¯”è¾ƒç®€å•ã€‚\nè€Œå…·ä½“çš„ç®—å­çš„å®ç°å…¶å®å°±æ˜¯ä¸€ä¸ªä¼˜å…ˆé˜Ÿåˆ—ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œç°åœ¨ tuple æŒ‰ç…§æŸä¸ªå…³é”®å­—å‡åºæ’åˆ—ï¼Œå¹¶ä¸” limit ä¸º 10ï¼Œé‚£ä¹ˆå°±å¯ä»¥æ„é€ ä¸€ä¸ªå°æ ¹å †ï¼Œå¹¶ç»´æŠ¤å…¶å¤§å°æœ€å¤šä¸º 10ï¼Œæœ€åç•™åœ¨å †ä¸­çš„å°±æ˜¯ç»“æœã€‚å¦‚æœåŠ›æ‰£åˆ·äº†ä¸€ç‚¹é¢˜çš„è¯å¾ˆå®¹æ˜“å°±èƒ½ç†è§£è¿™é‡Œã€‚\nWindow Function è¯´æ¥æƒ­æ„§ï¼Œå­¦ SQL çš„æ—¶å€™å¹¶ä¸çŸ¥é“çª—å£å‡½æ•°è¿™ä¸ªä¸œè¥¿â€¦ç®€å•æ¥ç†è§£ï¼Œå°±æ˜¯åœ¨ä½¿ç”¨èšåˆå‡½æ•°çš„åé¢åŠ ä¸Š over ([å¯é€‰æ“ä½œ]) å³å¯å¯¹åŒºé—´è¿›è¡Œèšåˆæ“ä½œã€‚\nå¯¹äºä¸‹é¢çš„ SQLï¼Œæœ€åè¾“å‡ºçš„ schema åº”è¯¥å’Œ WindowFunc.columns ç›¸åŒï¼Œå¹¶ä¸”è¡Œæ•°ä¹Ÿå’Œå­ executor è¿”å›çš„è¡Œæ•°ç›¸åŒï¼ˆä¸‹æ–‡å°†å­ executor è¿”å›çš„ tuple ç§°ä¸º child_tuplesï¼‰ï¼Œåªæ˜¯å¤šäº†ä¸€äº›é¢å¤–çš„è®¡ç®—åˆ—ã€‚\nbustub\u003e explain(o) select v1, min(v1) over () as min_v1, max(v1) over () as max_v1, count(v1) over () as count_v1, sum(v1) over () as sum_v1 from t1; === OPTIMIZER === WindowFunc { columns=#0.0, placeholder, placeholder, placeholder, placeholder, , window_functions={ 1=\u003e{ function_arg=#0.0, type=min, partition_by=[], order_by=[] }, 2=\u003e{ function_arg=#0.0, type=max, partition_by=[], order_by=[] }, 3=\u003e{ function_arg=#0.0, type=count, partition_by=[], order_by=[] }, 4=\u003e{ function_arg=#0.0, type=sum, partition_by=[], order_by=[] } } } SeqScan { table=t1 } åœ¨è¿™æ¡ SQL ä¸­ï¼Œè¿”å›çš„ tuple çš„æ ¼å¼åº”è¯¥ä¸ºï¼š\nè¿™æ¡ tuple çš„ v1 åˆ—çš„å€¼ æ‰€æœ‰ tuple ä¸­æœ€å°çš„ v1 çš„å€¼ æ‰€æœ‰ tuple ä¸­æœ€å¤§çš„ v1 çš„å€¼ æ‰€æœ‰ tuple ä¸­ v1 çš„ä¸ªæ•° æ‰€æœ‰ tuple ä¸­ v1 çš„å€¼çš„å’Œ è¿™å…¶å®å’Œ WindowFunc.columns æœ‰å¾ˆå¤§çš„å…³ç³»ï¼Œplaceholder è¯´æ˜è¿™åªæ˜¯ä¸ªå ä½ç¬¦ï¼Œå…¶åº”è¯¥ä¸º window_functions[ä¸‹æ ‡] å¯¹åº”çš„çª—å£å‡½æ•°ã€‚ä¾‹å¦‚ç¬¬äºŒä¸ª placeholder åœ¨ columns çš„ä¸‹è¡¨ä¸º 1ï¼Œå…¶å¯¹åº”çš„çª—å£å‡½æ•°å°±æ˜¯ { function_arg=#0.0, type=min, partition_by=[], order_by=[] }ã€‚é‚£ä¹ˆå°±å¯ä»¥é€šè¿‡ column æ¥æ‰¾åˆ°æ¯ä¸ªçª—å£å¯¹åº”çš„å“ˆå¸Œè¡¨ã€‚\nï¸éœ€è¦æ³¨æ„çš„æ˜¯ï¼š\nå¦‚æœæŒ‰ç…§ ORDER BY è¿›è¡Œæ’åºåï¼Œæ¯ä¸€è¡Œçš„çª—å£èŒƒå›´ä»ç¬¬ä¸€è¡Œå¼€å§‹æ‰©å±•åˆ°å½“å‰è¡Œ å¦åˆ™æ¯ä¸€è¡Œçš„çª—å£èŒƒå›´æ˜¯æ•´ä¸ª child_tuples æ—¢ç„¶å¦‚æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å…ˆä» child_executor è·å–åˆ°æ‰€æœ‰çš„ child_tuplesï¼Œç„¶åå¯¹ child_tuples éå†ï¼šå¦‚æœæœ‰åˆ†ç»„è¡Œä¸ºï¼Œé‚£å°±éœ€è¦æŒ‰ç…§æŸä¸€åˆ—ï¼ˆæˆ–å¤šåˆ—ï¼‰è¿›è¡Œåˆ†ç»„ï¼Œç„¶åå¯¹äºæ¯ä¸€ä¸ª tupleï¼Œéƒ½è®©å…¶æ‰§è¡Œä¸€æ¬¡ WindowFunc.window_functions ä¸­çš„çª—å£å‡½æ•°ã€‚\nç¨æœ‰ä¸åŒçš„æ˜¯ï¼Œä¹‹å‰çš„ aggregation æ“ä½œåˆ†ç»„åå¯èƒ½éœ€è¦å®Œæˆå¤šä¸ªèšåˆå‡½æ•°ï¼Œä½†æ˜¯è¿™é‡Œæˆ‘ä»¬åˆ†ç»„ä¹‹åï¼Œåªä¼šå®Œæˆä¸€ä¸ªèšåˆå‡½æ•°ï¼Œå› ä¸ºæ¯ä¸ªçª—å£ä¸­åªæœ‰ä¸€ä¸ªèšåˆå‡½æ•°ã€‚\nç°åœ¨çœ‹æ¥ï¼Œè¿™ä¸ªçª—å£å‡½æ•°ä¹Ÿæ— éå°±æ˜¯å¯¹æŸä¸ªèŒƒå›´å†…çš„ tuple è¿›è¡Œåˆ†ç»„å’Œèšåˆæ“ä½œï¼Œå®éªŒæŒ‡å¯¼ä¸­ä¹Ÿæç¤ºæˆ‘ä»¬å¯ä»¥å»åˆ©ç”¨ task2 ä¸­å†™çš„ä»£ç ã€‚åœ¨æˆ‘çš„å®ç°æ–¹æ¡ˆä¸­ï¼Œå¹¶ä¸åƒ task2 ä¸­åªä½¿ç”¨ä¸€ä¸ªå“ˆå¸Œè¡¨ï¼Œå› ä¸ºåœ¨ä¸€æ¡ SQL å‡½æ•°ä¸­ï¼Œå¯èƒ½æœ‰å¤šä¸ªçª—å£å‡½æ•°ï¼Œæ¯ä¸€ä¸ªçª—å£å‡½æ•°åˆå¯èƒ½åˆä¸åŒçš„åˆ†ç»„å’Œä¸åŒçš„èšåˆæ“ä½œï¼Œå› æ­¤æˆ‘å¯¹äºæ¯ä¸€ä¸ªçª—å£å‡½æ•°éƒ½è®¾ç½®äº†ä¸€ä¸ªå“ˆå¸Œè¡¨ã€‚\nè¯¥ task ä¸­ bustub å¾ˆä»æ…ˆåœ°ç®€åŒ–äº†éš¾åº¦ï¼šå¦‚æœçª—å£å‡½æ•°ä»»æ„ä¸€ä¸ªä¸­æœ‰ order byï¼Œé‚£ä¹ˆæ‰€æœ‰çª—å£å‡½æ•°çš„ order by éƒ½ç›¸åŒã€‚ä¸è¿‡åœ¨æœ‰æ’åºå’Œæ²¡æœ‰æ’åºçš„æƒ…å†µä¸‹ï¼Œçª—å£çš„èŒƒå›´æœ‰æ‰€ä¸åŒï¼Œå¤„ç†èµ·æ¥çš„æ–¹æ³•ä¹Ÿä¸åŒã€‚\næ— æ’åºçš„æƒ…å†µ è¿™ä¸ªæƒ…å†µä¸‹ï¼Œæ¯ä¸ªçª—å£å‡½æ•°çš„èŒƒå›´å°±æ˜¯æ•´ä¸ª child_tuplesã€‚ä¹‹åå†æ¬¡éå†æ¯ä¸€æ¡ tupleï¼ŒæŒ‰ç…§è¾“å‡ºçš„ schema æ¥æ„å»ºè¿”å›çš„ tupleã€‚é‚£ä¹ˆå®ç°æ“ä½œåº”è¯¥å¦‚ä¸‹ï¼š\nå…ˆææ‰€æœ‰ tupleï¼Œç”Ÿæˆè¿™æ¡ tuple å¯¹åº”çš„ key å’Œ valueï¼Œå†æŠŠ key å’Œ value åŠ å…¥å¯¹åº”çš„å“ˆå¸Œè¡¨ã€‚\nç„¶åå¯¹äºæ¯ä¸€æ¡ tupleï¼Œéå† WindowFunc.columnsï¼š\nå¦‚æœ column ä¸æ˜¯ placeholderï¼Œé‚£ä¹ˆè¯´æ˜è¿™ä¸ªä½ç½®æ˜¯è¿™ä¸ª tuple ä¸­çš„ä¸€åˆ—ï¼Œè·å–è¿™ä¸€åˆ—å¯¹åº”çš„ Value å°±å¥½ã€‚ å¦‚æœ column æ˜¯ placeholderï¼Œé‚£ä¹ˆè¯´æ˜è¿™ä¸ªä½ç½®çš„å€¼åº”è¯¥æ˜¯å¯¹åº”çš„çª—å£å‡½æ•°çš„æ‰§è¡Œç»“æœï¼Œé‚£ä¹ˆä» column å¯¹åº”çš„å“ˆå¸Œè¡¨ä¸­æ‰¾å‡ºè¿™ä¸ª tuple å¯¹åº”çš„å€¼å°± okã€‚ æœ‰æ’åºçš„æƒ…å†µ åœ¨è¿™ä¸ªæƒ…å†µä¸‹ï¼Œæ’åºå·åæ¯æ¡ tuple çš„èŒƒå›´æ˜¯è‡ªèº«åŠä¹‹å‰çš„æ‰€æœ‰ tupleï¼Œè€Œä¸æ˜¯åƒä¹‹å‰ä¸€æ ·çš„æ‰€æœ‰ tupleã€‚è¿™å°±æœ‰ç‚¹åƒä¸€å¥è¯ï¼šâ€œèµ°ä¸€æ­¥çœ‹ä¸€æ­¥â€ã€‚\nè¿˜æ˜¯éå†æ¯ä¸€æ¡ tupleï¼Œå¯¹æ¯ä¸€æ¡ tuple åˆéå† WindowFunc.columnsï¼š\nå¦‚æœ column ä¸æ˜¯ placeholderï¼Œé‚£ä¹ˆè¯´æ˜è¿™ä¸ªä½ç½®æ˜¯è¿™ä¸ª tuple ä¸­çš„ä¸€åˆ—ï¼Œè·å–è¿™ä¸€åˆ—å¯¹åº”çš„ Value å°±å¥½ã€‚è¿™é‡Œå’Œæ— æ’åºçš„æƒ…å†µä¸€è‡´ã€‚ å¦‚æœ column æ˜¯ placeholderï¼Œ ç”Ÿæˆè¿™æ¡ tuple å¯¹åº”çš„ key ç”Ÿæˆè¿™æ¡ tuple å¯¹åº”çš„ valueï¼Œå¹¶å°† {key, value} æ’å…¥ column å¯¹åº”çš„å“ˆå¸Œè¡¨ï¼ˆåœ¨ task2 ä¸­å¯çŸ¥ï¼Œè¿™é‡Œçš„â€œæ’å…¥â€å…¶å®æ˜¯å¯¹ key å¤„çš„æ—§å€¼ old_value ä¸æ–°å€¼ value è¿›è¡Œèšåˆæ“ä½œï¼‰ ä»å“ˆå¸Œè¡¨ä¸­å–å‡º key å¯¹åº”çš„ value è¿™é‡Œçš„ 2.2 å’Œ 2.3 å°±æ˜¯ä¹‹å‰æ‰€è¯´çš„â€œèµ°ä¸€æ­¥çœ‹ä¸€æ­¥â€ï¼šå½“å‰ tuple çš„ç»“æœæ˜¯åœ¨ä¹‹å‰çš„ tuple ä¸Šèšåˆè€Œæ¥çš„ã€‚\næ€»ç»“ è¿™ä¸ª Project éœ€è¦æˆ‘ä»¬å»æ·±å…¥ç†è§£ bustub çš„æºç ï¼ŒçŸ¥é“ä¸€æ¡ SQL ä¼šè¢«è§£ææˆä¸€æ£µä»€ä¹ˆæ ·çš„ plan æ ‘ï¼Œåœ¨ç»è¿‡åŸºäºè§„åˆ™çš„ä¼˜åŒ–å™¨ä¼˜åŒ–åæ‰ä¼šæ˜¯æœ€ç»ˆçš„ç‰©ç† plan æ ‘ï¼Œè¿™æ—¶åˆè¦å»ç†è§£è¿™æ£µæ ‘ä¸Šæ¯ä¸ªèŠ‚ç‚¹å¯¹åº”çš„ç®—å­åº”è¯¥æ˜¯æ€ä¹ˆå®ç°çš„ã€‚å…¶å®çŸ¥é“äº† plan æ ‘æ˜¯ä»€ä¹ˆæ ·å­åï¼ŒèŠ‚ç‚¹å¯¹åº”çš„ç®—å­å°±æŒ‰ç…§è¦æ±‚å»è®¾è®¡å°±å¥½äº†ã€‚\nåœ¨ä¼—å¤š AI ä¾‹å¦‚ ChatGPTã€DeepSeekã€Kimi ç­‰å¸®åŠ©ä¸‹ï¼Œè¿˜æ˜¯æ…¢æ…¢ç†è§£å¹¶å®Œæˆäº†è¿™ä¸ª Projectï¼ä½†æ˜¯æœ‰çš„åœ°æ–¹æˆ‘å¯èƒ½è¿˜æ²¡æœ‰åšçš„æ¯”è¾ƒå¥½ï¼Œä»¥åæœ‰æ—¶é—´å†ä¼˜åŒ–ä¸€ä¸‹ã€‚\n","wordCount":"2423","inLanguage":"en","image":"https://kerolt.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2025-03-11T00:00:00Z","dateModified":"2025-03-11T00:00:00Z","author":{"@type":"Person","name":"Kerolt"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://kerolt.github.io/posts/%E6%95%B0%E6%8D%AE%E5%BA%93/cmu15-445-fall2023project3-query-execution-%E5%B0%8F%E7%BB%93/"},"publisher":{"@type":"Organization","name":"Kerolt's Blog","logo":{"@type":"ImageObject","url":"https://kerolt.github.io/images/avatar/favicon.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://kerolt.github.io/ accesskey=h title="Kerolt's Blog (Alt + H)">Kerolt's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://kerolt.github.io/posts/ title=æ–‡ç« ><span>æ–‡ç« </span></a></li><li><a href=https://kerolt.github.io/categories/ title=åˆ†ç±»><span>åˆ†ç±»</span></a></li><li><a href=https://kerolt.github.io/tags/ title=æ ‡ç­¾><span>æ ‡ç­¾</span></a></li><li><a href=https://kerolt.github.io/archives/ title=å½’æ¡£><span>å½’æ¡£</span></a></li><li><a href=https://kerolt.github.io/about/ title=å…³äºæˆ‘><span>å…³äºæˆ‘</span></a></li><li><a href=https://kerolt.github.io/search/ title="ğŸ” (Alt + /)" accesskey=/><span>ğŸ”</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://kerolt.github.io/>Home</a>&nbsp;Â»&nbsp;<a href=https://kerolt.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">ã€CMU15-445 Fall2023ã€‘Project3 Query Execution å°ç»“</h1><div class=post-meta><span title='2025-03-11 00:00:00 +0000 UTC'>å‘å¸ƒäº2025-03-11</span>&nbsp;&nbsp;Â·&nbsp;&nbsp;<span title='2025-03-11 00:00:00 +0000 UTC'>æœ€åæ›´æ–°äº2025-03-11</span>&nbsp;&nbsp;Â·&nbsp;&nbsp;Kerolt</div><ul class=post-tags><li><a href=https://kerolt.github.io/tags/cplusplus/>CPlusPlus</a></li><li><a href=https://kerolt.github.io/tags/database/>Database</a></li><li><a href=https://kerolt.github.io/tags/cmu-15445/>CMU-15445</a></li></ul></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e5%89%8d%e7%bd%ae%e5%a5%b6%e9%85%aa aria-label=å‰ç½®å¥¶é…ª>å‰ç½®å¥¶é…ª</a><ul><li><a href=#%e4%b8%80%e6%9d%a1-sql-%e8%af%ad%e5%8f%a5%e7%9a%84%e6%89%a7%e8%a1%8c aria-label="ä¸€æ¡ SQL è¯­å¥çš„æ‰§è¡Œ">ä¸€æ¡ SQL è¯­å¥çš„æ‰§è¡Œ</a></li><li><a href=#iterator-model aria-label="Iterator Model">Iterator Model</a></li><li><a href=#catalog-table-and-index aria-label="Catalog, Table and Index">Catalog, Table and Index</a></li><li><a href=#%e7%b4%a2%e5%bc%95-index aria-label="ç´¢å¼• index">ç´¢å¼• index</a><ul><li><a href=#%e7%bb%93%e6%9e%84 aria-label=ç»“æ„>ç»“æ„</a></li><li><a href=#%e6%9b%b4%e6%96%b0%e7%b4%a2%e5%bc%95 aria-label=æ›´æ–°ç´¢å¼•>æ›´æ–°ç´¢å¼•</a></li><li><a href=#%e5%a6%82%e4%bd%95%e7%90%86%e8%a7%a3%e7%b4%a2%e5%bc%95 aria-label=å¦‚ä½•ç†è§£ç´¢å¼•>å¦‚ä½•ç†è§£ç´¢å¼•</a></li><li><a href=#%e6%89%a7%e8%a1%8c%e5%99%a8%e5%a6%82%e4%bd%95%e4%bd%bf%e7%94%a8%e7%b4%a2%e5%bc%95%e8%8e%b7%e5%8f%96%e6%95%b0%e6%8d%ae aria-label=æ‰§è¡Œå™¨å¦‚ä½•ä½¿ç”¨ç´¢å¼•è·å–æ•°æ®>æ‰§è¡Œå™¨å¦‚ä½•ä½¿ç”¨ç´¢å¼•è·å–æ•°æ®</a></li></ul></li><li><a href=#%e8%b0%93%e8%af%8d%e4%b8%8b%e6%8e%a8 aria-label=è°“è¯ä¸‹æ¨>è°“è¯ä¸‹æ¨</a></li></ul></li><li><a href=#task1---access-method-executors aria-label="Task1 - Access Method Executors">Task1 - Access Method Executors</a><ul><li><a href=#seqscan aria-label=SeqScan>SeqScan</a></li><li><a href=#insert aria-label=Insert>Insert</a><ul><li><a href=#%e4%b8%ba%e4%bb%80%e4%b9%88-insert-%e7%ad%89-executor-%e6%9c%89-child-%e8%80%8c-seqscan-%e6%b2%a1%e6%9c%89 aria-label="ä¸ºä»€ä¹ˆ Insert ç­‰ Executor æœ‰ child è€Œ SeqScan æ²¡æœ‰ï¼Ÿ">ä¸ºä»€ä¹ˆ Insert ç­‰ Executor æœ‰ child è€Œ SeqScan æ²¡æœ‰ï¼Ÿ</a></li><li><a href=#%e6%b2%a1%e6%9c%89%e5%ad%90%e6%93%8d%e4%bd%9c%e6%97%b6%e9%9c%80%e8%a6%81%e6%8f%92%e5%85%a5%e7%9a%84%e6%95%b0%e6%8d%ae%e4%bb%8e%e5%93%aa%e9%87%8c%e8%8e%b7%e5%8f%96 aria-label=æ²¡æœ‰å­æ“ä½œæ—¶ï¼Œéœ€è¦æ’å…¥çš„æ•°æ®ä»å“ªé‡Œè·å–ï¼Ÿ>æ²¡æœ‰å­æ“ä½œæ—¶ï¼Œéœ€è¦æ’å…¥çš„æ•°æ®ä»å“ªé‡Œè·å–ï¼Ÿ</a></li></ul></li><li><a href=#delete aria-label=Delete>Delete</a></li><li><a href=#update aria-label=Update>Update</a></li><li><a href=#indexscan aria-label=IndexScan>IndexScan</a></li></ul></li><li><a href=#task2---aggregation--join-executors aria-label="Task2 - Aggregation & Join Executors">Task2 - Aggregation & Join Executors</a><ul><li><a href=#aggregation aria-label=Aggregation>Aggregation</a></li><li><a href=#nestedloopjoin aria-label=NestedLoopJoin>NestedLoopJoin</a></li></ul></li><li><a href=#task3---hashjoin-executor-and-optimization aria-label="Task3 - HashJoin Executor and Optimization">Task3 - HashJoin Executor and Optimization</a><ul><li><a href=#%e5%b0%86-nl-join-%e4%bc%98%e5%8c%96%e4%b8%ba-hash-join aria-label="å°† NL Join ä¼˜åŒ–ä¸º Hash Join">å°† NL Join ä¼˜åŒ–ä¸º Hash Join</a></li><li><a href=#%e5%ae%9e%e7%8e%b0-hash-join aria-label="å®ç° Hash Join">å®ç° Hash Join</a></li></ul></li><li><a href=#task4---sort--limit-executors--window-functions--top-n-optimization aria-label="Task4 - Sort + Limit Executors + Window Functions + Top-N Optimization">Task4 - Sort + Limit Executors + Window Functions + Top-N Optimization</a><ul><li><a href=#sort aria-label=Sort>Sort</a></li><li><a href=#limit aria-label=Limit>Limit</a></li><li><a href=#topn aria-label=TopN>TopN</a></li><li><a href=#window-function aria-label="Window Function">Window Function</a><ul><li><a href=#%e6%97%a0%e6%8e%92%e5%ba%8f%e7%9a%84%e6%83%85%e5%86%b5 aria-label=æ— æ’åºçš„æƒ…å†µ>æ— æ’åºçš„æƒ…å†µ</a></li><li><a href=#%e6%9c%89%e6%8e%92%e5%ba%8f%e7%9a%84%e6%83%85%e5%86%b5 aria-label=æœ‰æ’åºçš„æƒ…å†µ>æœ‰æ’åºçš„æƒ…å†µ</a></li></ul></li></ul></li><li><a href=#%e6%80%bb%e7%bb%93 aria-label=æ€»ç»“>æ€»ç»“</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><blockquote><p>è¯¥ç³»åˆ—åšå®¢åªæ˜¯ä¸ºäº†è®°å½•è‡ªå·±åœ¨å†™ Lab æ—¶çš„æ€è·¯ï¼ŒæŒ‰ç…§è¯¾ç¨‹è¦æ±‚ä¸ä¼šåœ¨ Github å’Œåšå®¢ä¸­å…¬å¼€æºä»£ç ã€‚æ¬¢è¿ä¸æˆ‘ä¸€èµ·è®¨è®ºäº¤æµï¼</p></blockquote><p>è¿™ä¸ª project å’Œä¹‹å‰å°±ä¸ä¸€æ ·äº†ï¼Œå¼€å§‹æ·±å…¥æ•°æ®åº“å†…æ ¸çš„å®ç°äº†ã€‚éœ€è¦ç†æ¸…æ¥šä¸€æ¡ sql è¯­å¥æ˜¯å¦‚ä½•è¢«æ‰§è¡Œçš„ï¼Œæ–¹æ‰èƒ½å†™å‡ºä»£ç ã€‚</p><h2 id=å‰ç½®å¥¶é…ª>å‰ç½®å¥¶é…ª<a hidden class=anchor aria-hidden=true href=#å‰ç½®å¥¶é…ª>#</a></h2><h3 id=ä¸€æ¡-sql-è¯­å¥çš„æ‰§è¡Œ>ä¸€æ¡ SQL è¯­å¥çš„æ‰§è¡Œ<a hidden class=anchor aria-hidden=true href=#ä¸€æ¡-sql-è¯­å¥çš„æ‰§è¡Œ>#</a></h3><p><div class=post-img-view><a data-fancybox=gallery href=https://15445.courses.cs.cmu.edu/fall2023/project3/img/project-structure.svg><img src=https://15445.courses.cs.cmu.edu/fall2023/project3/img/project-structure.svg alt></a></div></p><p>è¿™é‡Œéœ€è¦å»çœ‹çœ‹ä¸€æ¡ sql è¯­å¥ä¼ å…¥ bustub å†…éƒ¨ä¹‹åçš„ä»£ç ï¼š<code>src/common/bustub_instance.cpp:ExecuteSqlTxn</code>ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#069;font-weight:700>auto</span> BustubInstance<span style=color:#555>::</span>ExecuteSqlTxn(<span style=color:#069;font-weight:700>const</span> std<span style=color:#555>::</span>string <span style=color:#555>&amp;</span>sql, ResultWriter <span style=color:#555>&amp;</span>writer, Transaction <span style=color:#555>*</span>txn,
</span></span><span style=display:flex><span>                                   std<span style=color:#555>::</span>shared_ptr<span style=color:#555>&lt;</span>CheckOptions<span style=color:#555>&gt;</span> check_options) <span style=color:#555>-&gt;</span> <span style=color:#078;font-weight:700>bool</span> {
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>if</span> (<span style=color:#555>!</span>sql.empty() <span style=color:#555>&amp;&amp;</span> sql[<span style=color:#f60>0</span>] <span style=color:#555>==</span> <span style=color:#c30>&#39;\\&#39;</span>) {
</span></span><span style=display:flex><span>    <span style=color:#09f;font-style:italic>// å¤„ç†å…ƒå‘½ä»¤
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span>    ... 
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>// binderï¼Œä½†æ˜¯åœ¨å…¶ä¸­ä¼šä½¿ç”¨libpg_queryæ¥è§£æsqlè¯­å¥
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span>  bustub<span style=color:#555>::</span>Binder binder(<span style=color:#555>*</span>catalog_);
</span></span><span style=display:flex><span>  binder.ParseAndSave(sql);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>// ç»è¿‡ä¸Šä¸€æ­¥åï¼Œbinderä¸­çš„statement_nodes_å­˜å‚¨ç€æ‰€æœ‰çš„è¯­å¥è§£æèŠ‚ç‚¹
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span>  <span style=color:#069;font-weight:700>for</span> (<span style=color:#069;font-weight:700>auto</span> <span style=color:#555>*</span><span style=color:#99f>stmt</span> : binder.statement_nodes_) {
</span></span><span style=display:flex><span>    <span style=color:#09f;font-style:italic>// å°†stmtè½¬æ¢æˆBoundStatementå¯¹è±¡ï¼Œæ–¹ä¾¿åé¢å¤„ç†æ•°æ®
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span>    <span style=color:#069;font-weight:700>auto</span> statement <span style=color:#555>=</span> binder.BindStatement(stmt);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#09f;font-style:italic>// åªæœ‰ä¸éœ€è¦æ„å»ºplanæ ‘ã€ä¸éœ€è¦è¿›è¡Œä¼˜åŒ–çš„sqlè¯­å¥æ‰ä¼šåœ¨switchä¹‹åç»§ç»­æ‰§è¡Œ
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span>    <span style=color:#069;font-weight:700>switch</span> (statement<span style=color:#555>-&gt;</span>type_) {
</span></span><span style=display:flex><span>      ...
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#09f;font-style:italic>// ç”Ÿæˆåˆæ­¥çš„æ‰§è¡Œè®¡åˆ’
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span>    bustub<span style=color:#555>::</span>Planner planner(<span style=color:#555>*</span>catalog_);
</span></span><span style=display:flex><span>    planner.PlanQuery(<span style=color:#555>*</span>statement);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#09f;font-style:italic>// ä¼˜åŒ–åˆšåˆšçš„æ‰§è¡Œè®¡åˆ’
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span>    bustub<span style=color:#555>::</span>Optimizer optimizer(<span style=color:#555>*</span>catalog_, IsForceStarterRule());
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>auto</span> optimized_plan <span style=color:#555>=</span> optimizer.Optimize(planner.plan_);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#09f;font-style:italic>// æ‰§è¡Œä¼˜åŒ–åçš„planï¼Œè¿™é‡Œä¼šä½¿ç”¨ç«å±±æ¨¡å‹å»æ ¹æ®ä¸‹é¢èŠ‚ç‚¹çš„Nextå‡½æ•°æ¥æ‰§è¡Œç›¸åº”çš„ç®—å­
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span>	execution_engine_<span style=color:#555>-&gt;</span>Execute(optimized_plan, <span style=color:#555>&amp;</span>result_set, txn, exec_ctx.get());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#09f;font-style:italic>// å°†æ‰§è¡Œç»“æœè¾“å‡ºè‡³æŒ‡å®šä½ç½®
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span>	...
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>return</span> <span style=color:#a00;background-color:#faa>æ˜¯å¦æ‰§è¡ŒæˆåŠŸ</span>;	
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>åœ¨ binder ä¹‹åï¼Œæˆ‘ä»¬å°±æœ‰äº†ä¸€æ¡ sql çš„è¯­å¥è§£æèŠ‚ç‚¹ï¼Œä¾‹å¦‚æ‰§è¡Œ <code>select * from (select * from test_2 where colA > 10) where colB > 2;</code>ï¼Œå…¶ statement node å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>BoundSelect {
</span></span><span style=display:flex><span>  table<span style=color:#555>=</span>BoundSubqueryRef {
</span></span><span style=display:flex><span>    alias<span style=color:#555>=</span>__subquery<span style=color:#a00;background-color:#faa>#</span><span style=color:#f60>0</span>,
</span></span><span style=display:flex><span>    subquery<span style=color:#555>=</span>BoundSelect {
</span></span><span style=display:flex><span>      table<span style=color:#555>=</span>BoundBaseTableRef { table<span style=color:#555>=</span>test_2, oid<span style=color:#555>=</span><span style=color:#f60>23</span> },
</span></span><span style=display:flex><span>      columns<span style=color:#555>=</span>[<span style=color:#c30>&#34;test_2.colA&#34;</span>, <span style=color:#c30>&#34;test_2.colB&#34;</span>, <span style=color:#c30>&#34;test_2.colC&#34;</span>],
</span></span><span style=display:flex><span>      groupBy<span style=color:#555>=</span>[],
</span></span><span style=display:flex><span>      having<span style=color:#555>=</span>,
</span></span><span style=display:flex><span>      where<span style=color:#555>=</span>(test_2.colA<span style=color:#555>&gt;</span><span style=color:#f60>10</span>),
</span></span><span style=display:flex><span>      limit<span style=color:#555>=</span>,
</span></span><span style=display:flex><span>      offset<span style=color:#555>=</span>,
</span></span><span style=display:flex><span>      order_by<span style=color:#555>=</span>[],
</span></span><span style=display:flex><span>      is_distinct<span style=color:#555>=</span><span style=color:#366>false</span>,
</span></span><span style=display:flex><span>      ctes<span style=color:#555>=</span>,
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    columns<span style=color:#555>=</span>[<span style=color:#c30>&#34;test_2.colA&#34;</span>, <span style=color:#c30>&#34;test_2.colB&#34;</span>, <span style=color:#c30>&#34;test_2.colC&#34;</span>],
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  columns<span style=color:#555>=</span>[<span style=color:#c30>&#34;__subquery#0.test_2.colA&#34;</span>, <span style=color:#c30>&#34;__subquery#0.test_2.colB&#34;</span>, <span style=color:#c30>&#34;__subquery#0.test_2.colC&#34;</span>],
</span></span><span style=display:flex><span>  groupBy<span style=color:#555>=</span>[],
</span></span><span style=display:flex><span>  having<span style=color:#555>=</span>,
</span></span><span style=display:flex><span>  where<span style=color:#555>=</span>(__subquery<span style=color:#a00;background-color:#faa>#</span><span style=color:#f60>0.</span>test_2.colB<span style=color:#555>&gt;</span><span style=color:#f60>2</span>),
</span></span><span style=display:flex><span>  limit<span style=color:#555>=</span>,
</span></span><span style=display:flex><span>  offset<span style=color:#555>=</span>,
</span></span><span style=display:flex><span>  order_by<span style=color:#555>=</span>[],
</span></span><span style=display:flex><span>  is_distinct<span style=color:#555>=</span><span style=color:#366>false</span>,
</span></span><span style=display:flex><span>  ctes<span style=color:#555>=</span>,
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å…¶ä¸­çš„å­æŸ¥è¯¢å’Œ where çš„æ¡ä»¶è¿˜æœ‰éœ€è¦å“ªäº›åˆ—éƒ½èƒ½éå¸¸æ¸…æ¥šçš„çœ‹åˆ°ã€‚</p><h3 id=iterator-model>Iterator Model<a hidden class=anchor aria-hidden=true href=#iterator-model>#</a></h3><p>é€šå¸¸ä¸€ä¸ª SQL ä¼šè¢«ç»„ç»‡æˆæ ‘çŠ¶çš„æŸ¥è¯¢è®¡åˆ’ï¼Œæ•°æ®ä»å¶å­èŠ‚ç‚¹æµåˆ°æ ¹èŠ‚ç‚¹ï¼ŒæŸ¥è¯¢ç»“æœåœ¨æ ¹èŠ‚ç‚¹ä¸­å¾—å‡ºã€‚</p><p>bustub ä¸­é‡‡ç”¨çš„æ•°æ®åº“æŸ¥è¯¢æ‰§è¡Œæ¨¡å‹å«åšè¿­ä»£å™¨æ¨¡å‹ï¼Œä¹Ÿå«ç«å±±æ¨¡å‹ã€‚</p><p>æŸ¥è¯¢è®¡åˆ’ï¼ˆquery planï¼‰ä¸­çš„æ¯æ­¥ operator å¯¹åº”çš„ executor éƒ½å®ç°ä¸€ä¸ª <code>next</code> å‡½æ•°ï¼Œæ¯æ¬¡è°ƒç”¨æ—¶ï¼Œoperator è¿”å›ä¸€ä¸ª <code>tuple</code> æˆ–è€… nullï¼Œåè€…è¡¨ç¤ºæ•°æ®å·²ç»éå†å®Œæ¯•ã€‚operator æœ¬èº«å®ç°ä¸€ä¸ªå¾ªç¯ï¼Œæ¯æ¬¡è°ƒç”¨å…¶ child operators çš„ next å‡½æ•°ï¼Œä»å®ƒä»¬é‚£è¾¹è·å–ä¸‹ä¸€æ¡æ•°æ®ä¾›è‡ªå·±æ“ä½œï¼Œè¿™æ ·æ•´ä¸ª query plan å°±è¢«ä»ä¸Šè‡³ä¸‹åœ°ä¸²è”èµ·æ¥ã€‚</p><p>ä½†æ˜¯åƒ Joins, Aggregates, Subqueries, Order By è¿™æ ·çš„æ“ä½œéœ€è¦ç­‰æ‰€æœ‰ children è¿”å›å®ƒä»¬çš„ tupleã€‚è™½ç„¶ä¸€æ¬¡è°ƒç”¨è¯·æ±‚ä¸€æ¡æ•°æ®ï¼Œå ç”¨å†…å­˜è¾ƒå°ï¼Œä½†å‡½æ•°è°ƒç”¨å¼€é”€å¤§ã€‚</p><h3 id=catalog-table-and-index>Catalog, Table and Index<a hidden class=anchor aria-hidden=true href=#catalog-table-and-index>#</a></h3><p>ä¸‹å›¾å‡ºå¤„ï¼šhttps://www.cnblogs.com/joey-wang/p/17351258.html</p><p><div class=post-img-view><a data-fancybox=gallery href=https://fastly.jsdelivr.net/gh/Angelia-Wang/blogImage/img/image-20230415234907799.png><img src=https://fastly.jsdelivr.net/gh/Angelia-Wang/blogImage/img/image-20230415234907799.png alt></a></div></p><h3 id=ç´¢å¼•-index>ç´¢å¼• index<a hidden class=anchor aria-hidden=true href=#ç´¢å¼•-index>#</a></h3><p>åœ¨ Bustub ä¸­ï¼Œç´¢å¼•ç”¨äºåŠ é€Ÿæ•°æ®è®¿é—®ã€‚ç´¢å¼•é€šè¿‡ç»´æŠ¤è¡¨ä¸­æ•°æ®çš„æœ‰åºç»“æ„ï¼Œä½¿å¾—æŸ¥è¯¢å¯ä»¥æ›´å¿«åœ°å®šä½åˆ°æ‰€éœ€çš„è®°å½•ã€‚</p><h4 id=ç»“æ„>ç»“æ„<a hidden class=anchor aria-hidden=true href=#ç»“æ„>#</a></h4><p>ç´¢å¼•çš„ç»“æ„å›¾å’Œä¸Šé¢è¡¨çš„ç»“æ„å›¾ç±»ä¼¼ã€‚åœ¨ catalog ä¸­ï¼Œå¯ä»¥è·å–åˆ°ä¸€ä¸ªè¡¨å¯¹åº”çš„<strong>æ‰€æœ‰</strong><code>IndexInfo</code>ï¼Œæ¯ä¸ª <code>IndexInfo</code> ä¸­åŒ…å«ç€è¿™ä¸ªç´¢å¼•çš„ä¿¡æ¯ï¼Œè¿™é‡Œè®²ä¸¤ä¸ªä¸ªæˆ‘è®¤ä¸ºæ¯”è¾ƒé‡è¦çš„æˆå‘˜å˜é‡ï¼š</p><ul><li><code>key_schema_</code>ï¼šç´¢å¼•å¯¹åº”çš„åˆ—çš„ç»“æ„ï¼Œä¾‹å¦‚ä½¿ç”¨å…¶ <code>ToString()</code> å‡½æ•°æ—¶ï¼Œå…¶ä¼šè¿”å› <code>(æ·»åŠ äº†ç´¢å¼•çš„åˆ—çš„åç§°:è¯¥åˆ—çš„æ•°æ®ç±»å‹)</code></li><li><code>index_</code>ï¼šè¿™æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ª <code>Index</code> ç±»çš„å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯çœŸæ­£çš„ç´¢å¼•</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#09f;font-style:italic>// catalog.h
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>class</span> <span style=color:#0a8;font-weight:700>Catalog</span> {
</span></span><span style=display:flex><span> <span style=color:#069;font-weight:700>public</span><span style=color:#555>:</span>
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>template</span> <span style=color:#555>&lt;</span><span style=color:#069;font-weight:700>class</span> <span style=color:#0a8;font-weight:700>KeyType</span>, <span style=color:#069;font-weight:700>class</span> <span style=color:#0a8;font-weight:700>ValueType</span>, <span style=color:#069;font-weight:700>class</span> <span style=color:#0a8;font-weight:700>KeyComparator</span><span style=color:#555>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>auto</span> CreateIndex(Transaction <span style=color:#555>*</span>txn, <span style=color:#069;font-weight:700>const</span> std<span style=color:#555>::</span>string <span style=color:#555>&amp;</span>index_name, <span style=color:#069;font-weight:700>const</span> std<span style=color:#555>::</span>string <span style=color:#555>&amp;</span>table_name, <span style=color:#069;font-weight:700>const</span> Schema <span style=color:#555>&amp;</span>schema,
</span></span><span style=display:flex><span>                   <span style=color:#069;font-weight:700>const</span> Schema <span style=color:#555>&amp;</span>key_schema, <span style=color:#069;font-weight:700>const</span> std<span style=color:#555>::</span>vector<span style=color:#555>&lt;</span><span style=color:#078;font-weight:700>uint32_t</span><span style=color:#555>&gt;</span> <span style=color:#555>&amp;</span>key_attrs, std<span style=color:#555>::</span>size_t keysize,
</span></span><span style=display:flex><span>                   HashFunction<span style=color:#555>&lt;</span>KeyType<span style=color:#555>&gt;</span> hash_function, <span style=color:#078;font-weight:700>bool</span> is_primary_key <span style=color:#555>=</span> <span style=color:#366>false</span>,
</span></span><span style=display:flex><span>                   IndexType index_type <span style=color:#555>=</span> IndexType<span style=color:#555>::</span>HashTableIndex) <span style=color:#555>-&gt;</span> IndexInfo <span style=color:#555>*</span>;
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>auto</span> <span style=color:#c0f>GetIndex</span>(<span style=color:#069;font-weight:700>const</span> std<span style=color:#555>::</span>string <span style=color:#555>&amp;</span>index_name, <span style=color:#069;font-weight:700>const</span> std<span style=color:#555>::</span>string <span style=color:#555>&amp;</span>table_name) <span style=color:#555>-&gt;</span> IndexInfo <span style=color:#555>*</span>;
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>auto</span> <span style=color:#c0f>GetIndex</span>(<span style=color:#069;font-weight:700>const</span> std<span style=color:#555>::</span>string <span style=color:#555>&amp;</span>index_name, <span style=color:#069;font-weight:700>const</span> table_oid_t table_oid) <span style=color:#555>-&gt;</span> IndexInfo <span style=color:#555>*</span>;
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>auto</span> <span style=color:#c0f>GetIndex</span>(index_oid_t index_oid) <span style=color:#555>-&gt;</span> IndexInfo <span style=color:#555>*</span>;
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>auto</span> <span style=color:#c0f>GetTableIndexes</span>(<span style=color:#069;font-weight:700>const</span> std<span style=color:#555>::</span>string <span style=color:#555>&amp;</span>table_name) <span style=color:#069;font-weight:700>const</span> <span style=color:#555>-&gt;</span> std<span style=color:#555>::</span>vector<span style=color:#555>&lt;</span>IndexInfo <span style=color:#555>*&gt;</span>;
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#069;font-weight:700>private</span><span style=color:#555>:</span>
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>   * Map index identifier -&gt; index metadata.
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>   *
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>   * NOTE: that `indexes_` owns all index metadata.
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>   */</span>
</span></span><span style=display:flex><span>  std<span style=color:#555>::</span>unordered_map<span style=color:#555>&lt;</span>index_oid_t, std<span style=color:#555>::</span>unique_ptr<span style=color:#555>&lt;</span>IndexInfo<span style=color:#555>&gt;&gt;</span> indexes_;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>/** Map table name -&gt; index names -&gt; index identifiers. */</span>
</span></span><span style=display:flex><span>  std<span style=color:#555>::</span>unordered_map<span style=color:#555>&lt;</span>std<span style=color:#555>::</span>string, std<span style=color:#555>::</span>unordered_map<span style=color:#555>&lt;</span>std<span style=color:#555>::</span>string, index_oid_t<span style=color:#555>&gt;&gt;</span> index_names_;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>/** The next index identifier to be used. */</span>
</span></span><span style=display:flex><span>  std<span style=color:#555>::</span>atomic<span style=color:#555>&lt;</span>index_oid_t<span style=color:#555>&gt;</span> next_index_oid_{<span style=color:#f60>0</span>};
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>struct</span> <span style=color:#0a8;font-weight:700>IndexInfo</span> {
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>/** The schema for the index key */</span>
</span></span><span style=display:flex><span>  Schema key_schema_;
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>/** The name of the index */</span>
</span></span><span style=display:flex><span>  std<span style=color:#555>::</span>string name_;
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>/** An owning pointer to the index */</span>
</span></span><span style=display:flex><span>  std<span style=color:#555>::</span>unique_ptr<span style=color:#555>&lt;</span>Index<span style=color:#555>&gt;</span> index_;
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>/** The unique OID for the index */</span>
</span></span><span style=display:flex><span>  index_oid_t index_oid_;
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>/** The name of the table on which the index is created */</span>
</span></span><span style=display:flex><span>  std<span style=color:#555>::</span>string table_name_;
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>/** The size of the index key, in bytes */</span>
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>const</span> size_t key_size_;
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>/** Is primary key index? */</span>
</span></span><span style=display:flex><span>  <span style=color:#078;font-weight:700>bool</span> is_primary_key_;
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>/** The index type */</span>
</span></span><span style=display:flex><span>  <span style=color:#309>[[maybe_unused]]</span> IndexType index_type_{IndexType<span style=color:#555>::</span>BPlusTreeIndex};
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p><code>Index</code> ä¸­æœ‰ç€ä¸‰ä¸ªè™šå‡½æ•°ä¾›å…¶æ´¾ç”Ÿç±»å»å®ç°ï¼Œå…¶å”¯ä¸€çš„æˆå‘˜å˜é‡çš„ç±»å‹ä¸º <code>IndexMeta</code>ï¼Œç”¨æ¥å­˜å‚¨ä¸€äº›å…ƒä¿¡æ¯ï¼Œä¾‹å¦‚è¿™ä¸ªç´¢å¼•çš„åç§°ï¼Œå®ƒæ‰€å±çš„è¡¨çš„åç§°ï¼Œæœ€é‡è¦çš„è¿˜æœ‰ä¸€ä¸ª <code>key_attrs_</code>ï¼Œç¨åå°±è¯´è°ˆè®ºå®ƒã€‚</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#09f;font-style:italic>// index.h
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>class</span> <span style=color:#0a8;font-weight:700>IndexMeta</span> {
</span></span><span style=display:flex><span> ...
</span></span><span style=display:flex><span> <span style=color:#069;font-weight:700>private</span><span style=color:#555>:</span>
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>/** The name of the index */</span>
</span></span><span style=display:flex><span>  std<span style=color:#555>::</span>string name_;
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>/** The name of the table on which the index is created */</span>
</span></span><span style=display:flex><span>  std<span style=color:#555>::</span>string table_name_;
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>/** The mapping relation between key schema and tuple schema */</span>
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>const</span> std<span style=color:#555>::</span>vector<span style=color:#555>&lt;</span><span style=color:#078;font-weight:700>uint32_t</span><span style=color:#555>&gt;</span> key_attrs_;
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>/** The schema of the indexed key */</span>
</span></span><span style=display:flex><span>  std<span style=color:#555>::</span>shared_ptr<span style=color:#555>&lt;</span>Schema<span style=color:#555>&gt;</span> key_schema_;
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>/** Is primary key? */</span>
</span></span><span style=display:flex><span>  <span style=color:#078;font-weight:700>bool</span> is_primary_key_;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>class</span> <span style=color:#0a8;font-weight:700>Index</span> {
</span></span><span style=display:flex><span> ...
</span></span><span style=display:flex><span> <span style=color:#069;font-weight:700>private</span><span style=color:#555>:</span>
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>/** The Index structure owns its metadata */</span>
</span></span><span style=display:flex><span>  std<span style=color:#555>::</span>unique_ptr<span style=color:#555>&lt;</span>IndexMetadata<span style=color:#555>&gt;</span> metadata_;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>fall2023 æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯å“ˆå¸Œç´¢å¼•ï¼Œåº•å±‚ä½¿ç”¨çš„å°±æ˜¯åœ¨ project2 ä¸­å®ç°çš„å¯æ‹“å±•å“ˆå¸Œã€‚</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#09f;font-style:italic>// extendible_hash_table_index.h
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#099>#define HASH_TABLE_INDEX_TYPE ExtendibleHashTableIndex&lt;KeyType, ValueType, KeyComparator&gt;
</span></span></span><span style=display:flex><span><span style=color:#099></span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>template</span> <span style=color:#555>&lt;</span><span style=color:#069;font-weight:700>typename</span> KeyType, <span style=color:#069;font-weight:700>typename</span> ValueType, <span style=color:#069;font-weight:700>typename</span> KeyComparator<span style=color:#555>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>class</span> <span style=color:#0a8;font-weight:700>ExtendibleHashTableIndex</span> <span style=color:#555>:</span> <span style=color:#069;font-weight:700>public</span> Index {
</span></span><span style=display:flex><span> <span style=color:#069;font-weight:700>public</span><span style=color:#555>:</span>
</span></span><span style=display:flex><span>  ExtendibleHashTableIndex(std<span style=color:#555>::</span>unique_ptr<span style=color:#555>&lt;</span>IndexMetadata<span style=color:#555>&gt;</span> <span style=color:#555>&amp;&amp;</span>metadata, BufferPoolManager <span style=color:#555>*</span>buffer_pool_manager,
</span></span><span style=display:flex><span>                           <span style=color:#069;font-weight:700>const</span> HashFunction<span style=color:#555>&lt;</span>KeyType<span style=color:#555>&gt;</span> <span style=color:#555>&amp;</span>hash_fn);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#555>~</span>ExtendibleHashTableIndex() <span style=color:#069;font-weight:700>override</span> <span style=color:#555>=</span> <span style=color:#069;font-weight:700>default</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>auto</span> <span style=color:#c0f>InsertEntry</span>(<span style=color:#069;font-weight:700>const</span> Tuple <span style=color:#555>&amp;</span>key, RID rid, Transaction <span style=color:#555>*</span>transaction) <span style=color:#555>-&gt;</span> <span style=color:#078;font-weight:700>bool</span> <span style=color:#069;font-weight:700>override</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#078;font-weight:700>void</span> <span style=color:#c0f>DeleteEntry</span>(<span style=color:#069;font-weight:700>const</span> Tuple <span style=color:#555>&amp;</span>key, RID rid, Transaction <span style=color:#555>*</span>transaction) <span style=color:#069;font-weight:700>override</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#078;font-weight:700>void</span> <span style=color:#c0f>ScanKey</span>(<span style=color:#069;font-weight:700>const</span> Tuple <span style=color:#555>&amp;</span>key, std<span style=color:#555>::</span>vector<span style=color:#555>&lt;</span>RID<span style=color:#555>&gt;</span> <span style=color:#555>*</span>result, Transaction <span style=color:#555>*</span>transaction) <span style=color:#069;font-weight:700>override</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#069;font-weight:700>protected</span><span style=color:#555>:</span>
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>// comparator for key
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span>  KeyComparator comparator_;
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>// container
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span>  DiskExtendibleHashTable<span style=color:#555>&lt;</span>KeyType, ValueType, KeyComparator<span style=color:#555>&gt;</span> container_;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><h4 id=æ›´æ–°ç´¢å¼•>æ›´æ–°ç´¢å¼•<a hidden class=anchor aria-hidden=true href=#æ›´æ–°ç´¢å¼•>#</a></h4><p>å½“æ’å…¥æ–°è®°å½•æ—¶ï¼Œä¸ä»…éœ€è¦å°†è®°å½•æ’å…¥åˆ°è¡¨ä¸­ï¼Œè¿˜éœ€è¦å°†ç›¸åº”çš„ç´¢å¼•æ¡ç›®æ’å…¥åˆ°ç´¢å¼•ä¸­ã€‚è¿™æ ·ï¼Œåç»­çš„æŸ¥è¯¢æ“ä½œå¯ä»¥åˆ©ç”¨ç´¢å¼•å¿«é€Ÿå®šä½åˆ°ç›®æ ‡è®°å½•ã€‚å¦‚æœä¸æ›´æ–°ç´¢å¼•ï¼Œåç»­çš„æŸ¥è¯¢æ“ä½œå¯èƒ½ä¼šé”™è¿‡æ–°æ’å…¥çš„è®°å½•ï¼Œå¯¼è‡´æŸ¥è¯¢ç»“æœä¸å‡†ç¡®ã€‚</p><blockquote><p><code>UPDATE</code> å’Œ <code>DELETE</code> å¦‚ä½•å½±å“ç´¢å¼•ï¼Ÿ</p></blockquote><ol><li><p><strong>UPDATE</strong></p><p>âœ… éœ€è¦æ›´æ–°ç´¢å¼•çš„æƒ…å†µï¼šä¿®æ”¹äº†<strong>ç´¢å¼•åˆ—</strong> çš„å€¼ï¼ˆä¾‹å¦‚ï¼šå°† <code>id=100</code> çš„ <code>name</code> å­—æ®µä» &ldquo;Alice&rdquo; æ”¹ä¸º &ldquo;Bob&rdquo;ï¼Œè€Œ <code>name</code> è¢«å»ºäº†ç´¢å¼•ï¼‰</p><ul><li>æ­¤æ—¶æ—§ç´¢å¼•é¡¹ï¼ˆ&ldquo;Alice&rdquo;ï¼‰éœ€è¦è¢«åˆ é™¤</li><li>æ–°ç´¢å¼•é¡¹ï¼ˆ&ldquo;Bob&rdquo;ï¼‰éœ€è¦è¢«æ’å…¥</li></ul><p>âŒ ä¸éœ€è¦æ›´æ–°ç´¢å¼•çš„æƒ…å†µï¼šä¿®æ”¹çš„æ˜¯<strong>éç´¢å¼•åˆ—</strong></p><ul><li>ä¾‹å¦‚ï¼š<code>age</code> å­—æ®µæ²¡æœ‰è¢«ç´¢å¼•ï¼Œä¿®æ”¹å®ƒä¸ä¼šå½±å“ç´¢å¼•</li></ul></li><li><p><strong>DELETE</strong></p><p>æ— è®ºåˆ é™¤å“ªä¸€è¡Œï¼Œåªè¦è¯¥è¡Œåœ¨æŸä¸ªç´¢å¼•ä¸­å­˜åœ¨ï¼Œå°±éœ€è¦ä»ç´¢å¼•ä¸­<strong>åˆ é™¤å¯¹åº”çš„æ¡ç›®</strong> ã€‚</p></li></ol><p>bustub ä¸­æœ‰å“ˆå¸Œç´¢å¼•å’Œ B+Tree ç´¢å¼•ï¼Œfall2023 ç‰ˆæœ¬ä½¿ç”¨çš„æ˜¯<strong>å¯æ‹“å±•å“ˆå¸Œ</strong>ä½œä¸ºä½œä¸ºç´¢å¼•ã€‚ä¸è¿‡è¿™ä¸¤ä¸ªå…·ä½“çš„å®ç°éƒ½æœ‰ä¸€ä¸ªåŸºç±» <code>Index</code>ï¼Œå…¶ä¸­æœ‰ä»¥ä¸‹è™šå‡½æ•°éœ€è¦å­ç±»å»å®ç°ï¼š</p><ul><li><code>InsertEntry(const Tuple &amp;key, RID rid, Transaction *transaction)</code>: æ’å…¥ä¸€ä¸ªç´¢å¼•æ¡ç›®ã€‚</li><li><code>DeleteEntry(const Tuple &amp;key, RID rid, Transaction *transaction)</code>: åˆ é™¤ä¸€ä¸ªç´¢å¼•æ¡ç›®ã€‚</li><li><code>ScanKey(const Tuple &amp;key, std::vector&lt;RID> *result, Transaction *transaction)</code>: æ ¹æ®ç´¢å¼•é”®æœç´¢è®°å½•ï¼Œå¹¶å°†ç»“æœ RID å­˜å‚¨åœ¨æŒ‡å®šçš„å‘é‡ä¸­ã€‚</li></ul><p>æ‰€ä»¥ä¸ç®¡ç”¨çš„æ˜¯å“ˆå¸Œè¿˜æ˜¯ B+Treeï¼Œåœ¨æ“ä½œç´¢å¼•æ—¶ç”¨çš„æ¥å£éƒ½ç›¸åŒã€‚</p><h4 id=å¦‚ä½•ç†è§£ç´¢å¼•>å¦‚ä½•ç†è§£ç´¢å¼•<a hidden class=anchor aria-hidden=true href=#å¦‚ä½•ç†è§£ç´¢å¼•>#</a></h4><p>å°±å¦‚ç½‘ä¸Šå¾ˆå¤šä»‹ç»ç´¢å¼•çš„åšå®¢æ‰€æè¿°çš„é‚£æ ·ï¼Œæ•°æ®åº“ç´¢å¼•æ˜¯ç”¨æ¥åŠ é€Ÿæ£€ç´¢é€Ÿåº¦çš„ï¼Œå°±å¦‚åŒæ–°åå­—å…¸ä¸­çš„éŸ³èŠ‚ç´¢å¼•ä¸€æ ·ï¼š</p><p><div class=post-img-view><a data-fancybox=gallery href=https://i2.kknews.cc/xGbg60mPdeRNfqICEnjrmqLM9nGZdeKcOg/0.jpg><img src=https://i2.kknews.cc/xGbg60mPdeRNfqICEnjrmqLM9nGZdeKcOg/0.jpg alt></a></div></p><p>å¦‚åŒ table_infoï¼Œcatalog ä¸­ä¹Ÿæœ‰è®¸å¤šçš„ index_infoï¼Œæ¯ä¸ª index_info å°±å¦‚åŒä¸Šå›¾éŸ³èŠ‚è¡¨ä¸­çš„ä¸€ä¸ªå­—æ¯ã€‚æˆ‘ä»¬å¯¹ä¸€ä¸ªå­—æ®µï¼ˆåˆ—ï¼‰æ„å»ºä¸€ä¸ªç´¢å¼•ï¼Œå°±å¦‚åŒåœ¨ä¸Šå›¾ä¸­éŸ³èŠ‚è¡¨ä¸­å¤šåŠ ä¸€ä¸ªå­—æ¯ï¼ˆä¾‹å¦‚ Xï¼‰ã€‚</p><ul><li>éœ€è¦æ’å…¥ä¸€æ¡è®°å½•æ—¶ï¼Œå°±å¾€å¯¹åº”çš„ç´¢å¼•ä¸‹æ’å…¥ <code>(è®°å½•ï¼Œ å¯¹åº”è®°å½•çš„åœ°å€)</code> è¿™æ ·çš„é”®å€¼å¯¹ï¼Œä¾‹å¦‚ä¸Šå›¾çš„ <code>(xian, 519)</code>ï¼Œè¿™é‡Œçš„åœ°å€ä¸º <code>RID</code>ã€‚</li><li>éœ€è¦åˆ é™¤ä¸€æ¡è®°å½•æ—¶ï¼Œåœ¨å¯¹åº”çš„ç´¢å¼•ä¸‹åˆ æ‰åŒ¹é…çš„é”®å€¼å¯¹ã€‚</li><li>éœ€è¦æ›´æ–°ä¸€æ¡è®°å½•æ—¶ï¼Œç”±äº bustub æ²¡æœ‰æä¾›æ›´æ–°ç´¢å¼•çš„ APIï¼Œæ‰€ä»¥å¯ä»¥ç”¨å…ˆåˆ é™¤å†æ’å…¥çš„æ–¹å¼æ¨¡æ‹Ÿæ›´æ–°ã€‚</li></ul><h4 id=æ‰§è¡Œå™¨å¦‚ä½•ä½¿ç”¨ç´¢å¼•è·å–æ•°æ®>æ‰§è¡Œå™¨å¦‚ä½•ä½¿ç”¨ç´¢å¼•è·å–æ•°æ®<a hidden class=anchor aria-hidden=true href=#æ‰§è¡Œå™¨å¦‚ä½•ä½¿ç”¨ç´¢å¼•è·å–æ•°æ®>#</a></h4><p>å½“æ‰§è¡Œå™¨éœ€è¦ä»è¡¨ä¸­è·å–æ•°æ®æ—¶ï¼Œå¦‚æœæŸ¥è¯¢è®¡åˆ’ä¸­åŒ…å«ç´¢å¼•æ‰«ææ“ä½œï¼Œæ‰§è¡Œå™¨ä¼šé€šè¿‡ç´¢å¼•æ¥å¿«é€Ÿå®šä½æ•°æ®ã€‚ä»¥ä¸‹æ˜¯å…·ä½“çš„æ­¥éª¤ï¼š</p><ol><li><strong>è§£ææŸ¥è¯¢è®¡åˆ’</strong>ï¼š<ul><li>æ‰§è¡Œå™¨æ ¹æ®æŸ¥è¯¢è®¡åˆ’ç¡®å®šéœ€è¦ä½¿ç”¨çš„ç´¢å¼•ã€‚</li><li>è·å–ç´¢å¼•çš„å…ƒæ•°æ®ï¼ŒåŒ…æ‹¬ç´¢å¼•é”®çš„æ¨¡å¼å’Œè¡¨åˆ—çš„æ˜ å°„å…³ç³»ã€‚</li></ul></li><li><strong>æ„å»ºç´¢å¼•é”®</strong>ï¼š<ul><li>æ ¹æ®æŸ¥è¯¢æ¡ä»¶å’Œç´¢å¼•çš„å…ƒæ•°æ®ï¼Œæ„å»ºç´¢å¼•é”®ã€‚è¿™é€šå¸¸æ¶‰åŠåˆ°ä»æŸ¥è¯¢æ¡ä»¶ä¸­æå–åˆ—å€¼ï¼Œå¹¶æ ¹æ®ç´¢å¼•é”®çš„æ¨¡å¼è¿›è¡Œè½¬æ¢ã€‚</li></ul></li><li><strong>ä½¿ç”¨ç´¢å¼•è¿›è¡Œæœç´¢</strong>ï¼š<ul><li>è°ƒç”¨ç´¢å¼•çš„Â <code>ScanKey</code>Â æ–¹æ³•ï¼Œä¼ å…¥æ„å»ºå¥½çš„ç´¢å¼•é”®å’Œä¸€ä¸ªç»“æœ RID å‘é‡ã€‚</li><li>ç´¢å¼•ä¼šæ ¹æ®é”®å€¼æŸ¥æ‰¾å¯¹åº”çš„è®°å½•ï¼Œå¹¶å°†æ‰¾åˆ°çš„ RID å­˜å‚¨åœ¨ç»“æœå‘é‡ä¸­ã€‚</li></ul></li><li><strong>è¯»å–æ•°æ®é¡µ</strong>ï¼š<ul><li>ä½¿ç”¨ç»“æœå‘é‡ä¸­çš„ RIDï¼Œä»ç¼“å†²æ± ä¸­æŸ¥æ‰¾å¯¹åº”çš„é¡µã€‚å¦‚æœé¡µä¸åœ¨ç¼“å†²æ± ä¸­ï¼Œåˆ™ä»ç£ç›˜åŠ è½½åˆ°ç¼“å†²æ± ã€‚</li><li>ä»é¡µä¸­è¯»å–æ•°æ®å¹¶åˆ›å»ºÂ <code>Tuple</code>Â å¯¹è±¡ã€‚</li></ul></li><li><strong>å¤„ç†å’Œè¿”å›ç»“æœ</strong>ï¼š<ul><li>ä½¿ç”¨Â <code>Tuple</code>Â å¯¹è±¡çš„æ–¹æ³•ï¼ˆå¦‚Â <code>GetValue</code>ã€<code>IsNull</code>Â ç­‰ï¼‰è®¿é—®å’Œå¤„ç†å…ƒç»„ä¸­çš„æ•°æ®ã€‚</li><li>å°†å¤„ç†åçš„æ•°æ®ä½œä¸ºç»“æœè¿”å›ç»™ç”¨æˆ·æˆ–è¿›ä¸€æ­¥å¤„ç†ã€‚</li></ul></li></ol><h3 id=è°“è¯ä¸‹æ¨>è°“è¯ä¸‹æ¨<a hidden class=anchor aria-hidden=true href=#è°“è¯ä¸‹æ¨>#</a></h3><p>è°“è¯ä¸‹æ¨ï¼ˆPredicate Pushdownï¼‰æ˜¯æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–ä¸­çš„ä¸€ç§æŠ€æœ¯ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯å°†æŸ¥è¯¢ä¸­çš„è¿‡æ»¤æ¡ä»¶ï¼ˆå³è°“è¯ï¼‰å°½å¯èƒ½æ—©åœ°åº”ç”¨åˆ°æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’çš„åº•éƒ¨ï¼Œä¹Ÿå°±æ˜¯æ•°æ®ç”Ÿæˆçš„åœ°æ–¹ã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯ä¸ºäº†å‡å°‘æ•°æ®çš„ä¼ è¾“é‡å’Œå¤„ç†é‡ï¼Œä»è€Œæé«˜æŸ¥è¯¢æ•ˆç‡ã€‚</p><p>å…·ä½“æ¥è¯´ï¼Œè°“è¯ä¸‹æ¨åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š</p><ol><li><strong>è¿‡æ»¤æ¡ä»¶å‰ç§»</strong>ï¼šåœ¨æŸ¥è¯¢æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œå°½æ—©åœ°å¯¹æ•°æ®è¿›è¡Œè¿‡æ»¤ï¼Œè¿™æ ·ä¸éœ€è¦å°†æ‰€æœ‰æ•°æ®éƒ½ä¼ é€’åˆ°ä¸Šå±‚æ“ä½œä¸­ï¼Œåªä¼ é€’æ»¡è¶³æ¡ä»¶çš„æ•°æ®ã€‚</li><li><strong>å‡å°‘æ•°æ®ä¼ è¾“</strong>ï¼šé€šè¿‡åœ¨æ•°æ®ç”Ÿæˆçš„é˜¶æ®µå°±è¿›è¡Œè¿‡æ»¤ï¼Œå¯ä»¥å‡å°‘ä»æ•°æ®åº“å­˜å‚¨å¼•æ“åˆ°æŸ¥è¯¢å¤„ç†å¼•æ“ä¹‹é—´çš„æ•°æ®ä¼ è¾“é‡ã€‚</li><li><strong>å‡å°‘ CPU å¤„ç†</strong>ï¼šä¸éœ€è¦å¯¹æ‰€æœ‰æ•°æ®è¿›è¡Œåç»­çš„å¤„ç†ï¼Œåªéœ€è¦å¤„ç†å·²ç»è¿‡æ»¤çš„æ•°æ®ï¼Œè¿™æ ·å¯ä»¥å‡å°‘ CPU çš„å·¥ä½œé‡ã€‚</li><li><strong>åˆ©ç”¨ç´¢å¼•</strong>ï¼šå¦‚æœè¿‡æ»¤æ¡ä»¶å¯ä»¥åˆ©ç”¨ç°æœ‰çš„ç´¢å¼•ï¼Œè°“è¯ä¸‹æ¨å¯ä»¥ä½¿å¾—æŸ¥è¯¢ç›´æ¥åˆ©ç”¨ç´¢å¼•æ¥å¿«é€Ÿå®šä½æ•°æ®ï¼Œè€Œä¸æ˜¯æ‰«ææ•´ä¸ªè¡¨ã€‚</li><li><strong>ä¼˜åŒ–æŸ¥è¯¢è®¡åˆ’</strong>ï¼šæ•°æ®åº“ä¼˜åŒ–å™¨ä¼šæ ¹æ®è°“è¯ä¸‹æ¨çš„åŸåˆ™é‡æ–°è§„åˆ’æŸ¥è¯¢çš„æ‰§è¡Œæ­¥éª¤ï¼Œç”Ÿæˆæ›´é«˜æ•ˆçš„æŸ¥è¯¢è®¡åˆ’ã€‚</li></ol><p>ä¾‹å¦‚ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#069;font-weight:700>SELECT</span><span style=color:#bbb> </span><span style=color:#555>*</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>FROM</span><span style=color:#bbb> </span>employees<span style=color:#bbb> </span><span style=color:#069;font-weight:700>WHERE</span><span style=color:#bbb> </span>department_id<span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span><span style=color:#f60>5</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>AND</span><span style=color:#bbb> </span>salary<span style=color:#bbb> </span><span style=color:#555>&gt;</span><span style=color:#bbb> </span><span style=color:#f60>50000</span>;<span style=color:#bbb>
</span></span></span></code></pre></div><p>åœ¨è¿™ä¸ªæŸ¥è¯¢ä¸­ï¼Œ<code>WHERE</code> å­å¥åŒ…å«äº†ä¸¤ä¸ªè¿‡æ»¤æ¡ä»¶ã€‚å¦‚æœä¸è¿›è¡Œè°“è¯ä¸‹æ¨ï¼Œæ•°æ®åº“å¯èƒ½ä¼šå…ˆæ‰«ææ•´ä¸ª <code>employees</code> è¡¨ï¼Œç„¶åå°†æ‰€æœ‰è¡Œä¼ é€’ç»™ä¸Šå±‚æ“ä½œï¼Œä¹‹åå†åº”ç”¨è¿‡æ»¤æ¡ä»¶ã€‚è€Œé€šè¿‡è°“è¯ä¸‹æ¨ï¼Œæ•°æ®åº“å¯ä»¥åœ¨æ‰«æè¡¨çš„æ—¶å€™ç›´æ¥åº”ç”¨è¿™äº›è¿‡æ»¤æ¡ä»¶ï¼Œåªè¿”å›éƒ¨é—¨ ID ä¸º 5 ä¸”è–ªèµ„å¤§äº 50000 çš„å‘˜å·¥è®°å½•ã€‚</p><p>è°“è¯ä¸‹æ¨æ˜¯æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–ä¸­éå¸¸é‡è¦çš„ä¸€ç¯ï¼Œå®ƒæœ‰åŠ©äºæé«˜æŸ¥è¯¢æ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†å¤§è§„æ¨¡æ•°æ®é›†æ—¶ã€‚æ•°æ®åº“ä¼˜åŒ–å™¨ä¼šå°è¯•è‡ªåŠ¨åº”ç”¨è°“è¯ä¸‹æ¨ï¼Œä½†æœ‰æ—¶å¼€å‘è€…ä¹Ÿå¯ä»¥é€šè¿‡ç¼–å†™æ›´ä¼˜åŒ–çš„æŸ¥è¯¢æ¡ä»¶æ¥å¸®åŠ©ä¼˜åŒ–å™¨æ›´å¥½åœ°è¿›è¡Œè°“è¯ä¸‹æ¨ã€‚</p><h2 id=task1---access-method-executors>Task1 - Access Method Executors<a hidden class=anchor aria-hidden=true href=#task1---access-method-executors>#</a></h2><h3 id=seqscan>SeqScan<a hidden class=anchor aria-hidden=true href=#seqscan>#</a></h3><p>é¡ºåºæ‰«ææŒ‡å®šçš„è¡¨ï¼Œè¡¨çš„éå†å¯ä»¥ä½¿ç”¨ <code>TableIterator</code>ã€‚</p><p>æ¯æ¬¡æ‰¾åˆ°ä¸€æ¡æ²¡æœ‰è¢«æ ‡è®°ä¸ºâ€œåˆ é™¤â€æˆ–è€…ä¸æ˜¯ where ä¹‹ç±»çš„è¿‡æ»¤å­å¥åŒ¹é…ï¼ˆè¿™é‡Œä¼šåœ¨ delete æ“ä½œä¸­è¯´æ˜ï¼‰çš„ tupleï¼ˆè®°å½•ï¼‰å°±å¹¶è¿”å›ï¼Œå¦‚æœå·²ç»æ‰«æåˆ°äº†è¡¨çš„ç»“æŸä½ç½®åˆ™è¿”å› falseã€‚</p><h3 id=insert>Insert<a hidden class=anchor aria-hidden=true href=#insert>#</a></h3><h4 id=ä¸ºä»€ä¹ˆ-insert-ç­‰-executor-æœ‰-child-è€Œ-seqscan-æ²¡æœ‰>ä¸ºä»€ä¹ˆ Insert ç­‰ Executor æœ‰ child è€Œ SeqScan æ²¡æœ‰ï¼Ÿ<a hidden class=anchor aria-hidden=true href=#ä¸ºä»€ä¹ˆ-insert-ç­‰-executor-æœ‰-child-è€Œ-seqscan-æ²¡æœ‰>#</a></h4><p><code>InsertExecutor</code>Â çš„ä¸»è¦èŒè´£æ˜¯å°†ä¸€æ¡æˆ–å¤šæ¡è®°å½•æ’å…¥åˆ°æŒ‡å®šçš„è¡¨ä¸­ã€‚å®ƒå¯èƒ½éœ€è¦ä¾èµ–äºå…¶ä»–Â <code>Executor</code>Â æ¥è·å–è¦æ’å…¥çš„æ•°æ®ã€‚ä¾‹å¦‚ï¼Œå¦‚æœÂ <code>INSERT</code>Â æ“ä½œæ˜¯ä»ä¸€ä¸ªÂ <code>SELECT</code>Â æŸ¥è¯¢çš„ç»“æœé›†ä¸­æ’å…¥æ•°æ®ï¼Œé‚£ä¹ˆÂ <code>InsertExecutor</code>Â å¯èƒ½ä¼šæœ‰ä¸€ä¸ªå­Â <code>Executor</code>ï¼ˆå¦‚Â <code>SeqScanExecutor</code>Â æˆ–å…¶ä»–ç±»å‹çš„Â <code>Executor</code>ï¼‰ï¼Œè¯¥å­Â <code>Executor</code>Â è´Ÿè´£æ‰§è¡ŒÂ <code>SELECT</code>Â æ“ä½œå¹¶æä¾›æ•°æ®ç»™Â <code>InsertExecutor</code>ã€‚</p><p>å› æ­¤ï¼Œ<code>InsertExecutor</code>Â æœ‰ child æ˜¯å› ä¸ºå®ƒå¯èƒ½éœ€è¦ä»å¦ä¸€ä¸ªæŸ¥è¯¢çš„ç»“æœä¸­è·å–æ•°æ®ã€‚</p><p><code>SeqScanExecutor</code> çš„ä¸»è¦èŒè´£æ˜¯å¯¹è¡¨è¿›è¡Œå…¨è¡¨æ‰«æï¼Œå³æŒ‰é¡ºåºè¯»å–è¡¨ä¸­çš„æ‰€æœ‰è®°å½•ã€‚è¿™æ˜¯ä¸€ä¸ªåŸºæœ¬çš„æ“ä½œï¼Œé€šå¸¸ä¸éœ€è¦å…¶ä»–Â <code>Executor</code>Â çš„æ”¯æŒæ¥å®Œæˆå…¶å·¥ä½œã€‚</p><p>å®ƒç›´æ¥ä½œç”¨äºå­˜å‚¨å±‚ï¼Œéå†è¡¨ä¸­çš„æ¯ä¸€è¡Œæ•°æ®ï¼Œå› æ­¤æ²¡æœ‰å­Â <code>Executor</code>ã€‚å®ƒçš„ä»»åŠ¡ç›¸å¯¹ç®€å•ï¼Œå°±æ˜¯éå†å’Œè¿”å›è¡¨ä¸­çš„æ‰€æœ‰è®°å½•ã€‚</p><p>ç®€è€Œè¨€ä¹‹ï¼Œ<code>InsertExecutor</code> éœ€è¦ child æ˜¯<strong>å› ä¸ºå®ƒçš„æ“ä½œå¯èƒ½æ¶‰åŠä»å…¶ä»–æŸ¥è¯¢ç»“æœä¸­è·å–æ•°æ®</strong>ï¼Œè€Œ <code>SeqScanExecutor</code> ä¸éœ€è¦ child æ˜¯å› ä¸ºå®ƒçš„ä»»åŠ¡æ˜¯ç‹¬ç«‹å®Œæˆçš„ï¼Œåªéœ€éå†è¡¨ä¸­çš„æ‰€æœ‰è®°å½•å³å¯ã€‚è¿™åæ˜ äº†æ•°æ®åº“æ‰§è¡Œè®¡åˆ’ä¸­ä¸åŒæ“ä½œä¹‹é—´çš„ä¾èµ–å…³ç³»å’Œäº¤äº’æ–¹å¼ã€‚å…¶ä»– Executor åŒç†ã€‚</p><p>ä¸¾ä¸ªæ‰¹é‡æ’å…¥çš„ğŸŒ°ï¼š</p><p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ª <code>orders</code> è¡¨ï¼ŒåŒ…å«ä»¥ä¸‹åˆ—ï¼š</p><ul><li><code>order_id</code>Â (ä¸»é”®)</li><li><code>customer_id</code></li><li><code>product_id</code></li><li><code>quantity</code></li><li><code>order_date</code></li></ul><p>æˆ‘ä»¬å¸Œæœ›é€šè¿‡ä¸€ä¸ªå­æŸ¥è¯¢ï¼ˆselectï¼‰æ¥è·å–ä¸€æ‰¹è®¢å•è®°å½•ï¼Œå¹¶å°†è¿™äº›è®°å½•æ’å…¥åˆ° <code>orders</code> è¡¨ä¸­ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#069;font-weight:700>INSERT</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>INTO</span><span style=color:#bbb> </span>orders<span style=color:#bbb> </span>(customer_id,<span style=color:#bbb> </span>product_id,<span style=color:#bbb> </span>quantity,<span style=color:#bbb> </span>order_date)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#069;font-weight:700>SELECT</span><span style=color:#bbb> </span>customer_id,<span style=color:#bbb> </span>product_id,<span style=color:#bbb> </span>quantity,<span style=color:#bbb> </span>order_date<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#069;font-weight:700>FROM</span><span style=color:#bbb> </span>pending_orders<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#069;font-weight:700>WHERE</span><span style=color:#bbb> </span>status<span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span><span style=color:#c30>&#39;approved&#39;</span>;<span style=color:#bbb>
</span></span></span></code></pre></div><p>å¾ˆæ˜æ˜¾ï¼Œæˆ‘ä»¬åœ¨æ’å…¥ä¹‹å‰è¦ä» select å­å¥ä¸­è·å–æ•°æ®ï¼Œå› æ­¤è¿™ä¸ªå­æŸ¥è¯¢æ“ä½œå°±æ˜¯ insert æ“ä½œçš„ <code>child_executor</code>ã€‚</p><h4 id=æ²¡æœ‰å­æ“ä½œæ—¶éœ€è¦æ’å…¥çš„æ•°æ®ä»å“ªé‡Œè·å–>æ²¡æœ‰å­æ“ä½œæ—¶ï¼Œéœ€è¦æ’å…¥çš„æ•°æ®ä»å“ªé‡Œè·å–ï¼Ÿ<a hidden class=anchor aria-hidden=true href=#æ²¡æœ‰å­æ“ä½œæ—¶éœ€è¦æ’å…¥çš„æ•°æ®ä»å“ªé‡Œè·å–>#</a></h4><p>æ¯”å¦‚æ‰§è¡Œå¦‚ä¸‹ SQL æ—¶ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#069;font-weight:700>insert</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>into</span><span style=color:#bbb> </span>test_1<span style=color:#bbb> </span><span style=color:#069;font-weight:700>values</span><span style=color:#bbb> </span>(<span style=color:#f60>202</span>,<span style=color:#bbb> </span><span style=color:#f60>1</span>,<span style=color:#bbb> </span><span style=color:#f60>2</span>,<span style=color:#bbb> </span><span style=color:#f60>3</span>);<span style=color:#bbb>
</span></span></span></code></pre></div><p>ä»è‚‰çœ¼çœ‹å¯ä»¥çŸ¥é“éœ€è¦æ’å…¥çš„æ•°æ®ä¸º <code>(202, 1, 2, 3)</code>ï¼Œä½†æ˜¯åœ¨ä»£ç ä¸­åˆæ˜¯ä»å“ªé‡Œè·å–çš„å‘¢ï¼Ÿ</p><p>è®©æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸‹ <code>explain</code> å·¥å…·æ¥çœ‹çœ‹è¿™æ¡ SQL è¯­å¥åœ¨ bustub å†…éƒ¨åšäº†ä»€ä¹ˆï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>bustub<span style=color:#555>&gt;</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>explain</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>insert</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>into</span><span style=color:#bbb> </span>test_1<span style=color:#bbb> </span><span style=color:#069;font-weight:700>values</span><span style=color:#bbb> </span>(<span style=color:#f60>202</span>,<span style=color:#bbb> </span><span style=color:#f60>1</span>,<span style=color:#bbb> </span><span style=color:#f60>2</span>,<span style=color:#bbb> </span><span style=color:#f60>3</span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#555>===</span><span style=color:#bbb> </span>BINDER<span style=color:#bbb> </span><span style=color:#555>===</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>BoundInsert<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#069;font-weight:700>table</span><span style=color:#555>=</span>BoundBaseTableRef<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>table</span><span style=color:#555>=</span>test_1,<span style=color:#bbb> </span>oid<span style=color:#555>=</span><span style=color:#f60>22</span><span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#069;font-weight:700>select</span><span style=color:#555>=</span><span style=color:#bbb>  </span>BoundSelect<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#069;font-weight:700>table</span><span style=color:#555>=</span>BoundExpressionListRef<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span>identifier<span style=color:#555>=</span>__values<span style=color:#555>#</span><span style=color:#f60>0</span>,<span style=color:#bbb> </span><span style=color:#069;font-weight:700>values</span><span style=color:#555>=</span>[[<span style=color:#c30>&#34;202&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;1&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;2&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;3&#34;</span>]]<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>columns<span style=color:#555>=</span>[<span style=color:#c30>&#34;__values#0.0&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;__values#0.1&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;__values#0.2&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;__values#0.3&#34;</span>],<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>groupBy<span style=color:#555>=</span>[],<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#069;font-weight:700>having</span><span style=color:#555>=</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#069;font-weight:700>where</span><span style=color:#555>=</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#069;font-weight:700>limit</span><span style=color:#555>=</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#069;font-weight:700>offset</span><span style=color:#555>=</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>order_by<span style=color:#555>=</span>[],<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>is_distinct<span style=color:#555>=</span><span style=color:#069;font-weight:700>false</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>ctes<span style=color:#555>=</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#555>===</span><span style=color:#bbb> </span>PLANNER<span style=color:#bbb> </span><span style=color:#555>===</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#069;font-weight:700>Insert</span><span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span>table_oid<span style=color:#555>=</span><span style=color:#f60>22</span><span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb> </span><span style=color:#555>|</span><span style=color:#bbb> </span>(__bustub_internal.insert_rows:<span style=color:#366>INTEGER</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>Projection<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span>exprs<span style=color:#555>=</span>[<span style=color:#c30>&#34;#0.0&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;#0.1&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;#0.2&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;#0.3&#34;</span>]<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb> </span><span style=color:#555>|</span><span style=color:#bbb> </span>(__values<span style=color:#555>#</span><span style=color:#f60>0</span>.<span style=color:#f60>0</span>:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__values<span style=color:#555>#</span><span style=color:#f60>0</span>.<span style=color:#f60>1</span>:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__values<span style=color:#555>#</span><span style=color:#f60>0</span>.<span style=color:#f60>2</span>:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__values<span style=color:#555>#</span><span style=color:#f60>0</span>.<span style=color:#f60>3</span>:<span style=color:#366>INTEGER</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#069;font-weight:700>Values</span><span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>rows</span><span style=color:#555>=</span><span style=color:#f60>1</span><span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb> </span><span style=color:#555>|</span><span style=color:#bbb> </span>(__values<span style=color:#555>#</span><span style=color:#f60>0</span>.<span style=color:#f60>0</span>:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__values<span style=color:#555>#</span><span style=color:#f60>0</span>.<span style=color:#f60>1</span>:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__values<span style=color:#555>#</span><span style=color:#f60>0</span>.<span style=color:#f60>2</span>:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__values<span style=color:#555>#</span><span style=color:#f60>0</span>.<span style=color:#f60>3</span>:<span style=color:#366>INTEGER</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#555>===</span><span style=color:#bbb> </span>OPTIMIZER<span style=color:#bbb> </span><span style=color:#555>===</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#069;font-weight:700>Insert</span><span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span>table_oid<span style=color:#555>=</span><span style=color:#f60>22</span><span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb> </span><span style=color:#555>|</span><span style=color:#bbb> </span>(__bustub_internal.insert_rows:<span style=color:#366>INTEGER</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#069;font-weight:700>Values</span><span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>rows</span><span style=color:#555>=</span><span style=color:#f60>1</span><span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb> </span><span style=color:#555>|</span><span style=color:#bbb> </span>(__values<span style=color:#555>#</span><span style=color:#f60>0</span>.<span style=color:#f60>0</span>:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__values<span style=color:#555>#</span><span style=color:#f60>0</span>.<span style=color:#f60>1</span>:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__values<span style=color:#555>#</span><span style=color:#f60>0</span>.<span style=color:#f60>2</span>:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__values<span style=color:#555>#</span><span style=color:#f60>0</span>.<span style=color:#f60>3</span>:<span style=color:#366>INTEGER</span>)<span style=color:#bbb>
</span></span></span></code></pre></div><p>å°†ç›®æ ‡èšç„¦åœ¨ç”Ÿæˆçš„æŸ¥è¯¢è®¡åˆ’ä¸Šï¼Œä»ä¸Šåˆ°ä¸‹ï¼Œåœ¨ä¸€ä¸ª <code>Insert</code> çš„æŸ¥è¯¢è®¡åˆ’ä¸­ï¼Œä½¿ç”¨ <code>Projection</code> ä»å…¶è¾“å…¥æºï¼ˆå¦‚è¡¨æ‰«æã€ç´¢å¼•æ‰«æã€è¿æ¥ç­‰ï¼‰ä¸­æå–æ‰€éœ€çš„åˆ—ï¼Œæœ€ä¸‹å±‚ä½¿ç”¨ <code>Value</code> è·å–åˆ°è¦æ“ä½œçš„æ•°æ®ï¼</p><p>æ‰€ä»¥å¯¹åº”çš„ï¼Œ<code>InsertExecutor</code> çš„ <code>child_executor</code> ä¸º <code>ProjectionExecutor</code>ï¼Œè€Œ <code>ProjectionExecutor</code> çš„ <code>child_executor</code> ä¸º <code>ValuesExecutor</code>ï¼Œä½¿ç”¨è¿­ä»£å™¨æ¨¡å‹å°±èƒ½å¾ˆæ–¹ä¾¿çš„è·å–åˆ°æ•°æ®äº†ï¼ˆ<code>ValuesExecutor</code> å°±æ˜¯æœ€åçš„ Executorï¼Œå…¶ <code>Next</code> å‡½æ•°ä¸ä¼šå†å¾€ä¸‹è°ƒç”¨ï¼Œå…¶æ‰€åšçš„åªæ˜¯æ ¹æ®åœ¨è§£æ SQL åŠå…¶ä¹‹åçš„ä¸€äº›æ­¥éª¤ä¸­å¾—åˆ°çš„éœ€è¦æ“ä½œçš„æ•°æ®å°è£…æˆä¸€ä¸ª tuple è¿›è¡Œè¿”å›ï¼‰ã€‚</p><h3 id=delete>Delete<a hidden class=anchor aria-hidden=true href=#delete>#</a></h3><p>éœ€è¦å†™çš„ä»£ç å’Œ insert æ“ä½œçš„åŸºæœ¬ç›¸åŒã€‚ä½†æœ‰ä¸ªåœ°æ–¹éœ€è¦æ³¨æ„ä¸€ä¸‹ï¼Œåœ¨æ‰§è¡Œä¸€æ¡ delete è¯­å¥æ—¶ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹åšäº†äº›ä»€ä¹ˆï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>bustub<span style=color:#555>&gt;</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>explain</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>delete</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>from</span><span style=color:#bbb> </span>test_1<span style=color:#bbb> </span><span style=color:#069;font-weight:700>where</span><span style=color:#bbb> </span>colA<span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span><span style=color:#f60>999</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#555>===</span><span style=color:#bbb> </span>BINDER<span style=color:#bbb> </span><span style=color:#555>===</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#069;font-weight:700>Delete</span><span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>table</span><span style=color:#555>=</span>BoundBaseTableRef<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>table</span><span style=color:#555>=</span>test_1,<span style=color:#bbb> </span>oid<span style=color:#555>=</span><span style=color:#f60>22</span><span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span>,<span style=color:#bbb> </span>expr<span style=color:#555>=</span>(test_1.colA<span style=color:#555>=</span><span style=color:#f60>999</span>)<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#555>===</span><span style=color:#bbb> </span>PLANNER<span style=color:#bbb> </span><span style=color:#555>===</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#069;font-weight:700>Delete</span><span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span>table_oid<span style=color:#555>=</span><span style=color:#f60>22</span><span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb> </span><span style=color:#555>|</span><span style=color:#bbb> </span>(__bustub_internal.delete_rows:<span style=color:#366>INTEGER</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>Filter<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span>predicate<span style=color:#555>=</span>(<span style=color:#555>#</span><span style=color:#f60>0</span>.<span style=color:#f60>0</span><span style=color:#555>=</span><span style=color:#f60>999</span>)<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb> </span><span style=color:#555>|</span><span style=color:#bbb> </span>(test_1.colA:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>test_1.colB:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>test_1.colC:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>test_1.colD:<span style=color:#366>INTEGER</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>SeqScan<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>table</span><span style=color:#555>=</span>test_1<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb> </span><span style=color:#555>|</span><span style=color:#bbb> </span>(test_1.colA:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>test_1.colB:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>test_1.colC:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>test_1.colD:<span style=color:#366>INTEGER</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#555>===</span><span style=color:#bbb> </span>OPTIMIZER<span style=color:#bbb> </span><span style=color:#555>===</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#069;font-weight:700>Delete</span><span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span>table_oid<span style=color:#555>=</span><span style=color:#f60>22</span><span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb> </span><span style=color:#555>|</span><span style=color:#bbb> </span>(__bustub_internal.delete_rows:<span style=color:#366>INTEGER</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>SeqScan<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>table</span><span style=color:#555>=</span>test_1,<span style=color:#bbb> </span>filter<span style=color:#555>=</span>(<span style=color:#555>#</span><span style=color:#f60>0</span>.<span style=color:#f60>0</span><span style=color:#555>=</span><span style=color:#f60>999</span>)<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb> </span><span style=color:#555>|</span><span style=color:#bbb> </span>(test_1.colA:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>test_1.colB:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>test_1.colC:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>test_1.colD:<span style=color:#366>INTEGER</span>)<span style=color:#bbb>
</span></span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ optimizer é˜¶æ®µï¼Œwhere å­å¥çš„ filter ä¸‹æ”¾è‡³ SeqScan å¤„ä¸å…¶åˆå¹¶äº†ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å®ç° <code>SeqScanExecutor</code> æ—¶æ³¨æ„å¤„ç†ä¸€ä¸‹ filterã€‚è¿™é‡Œæç¤ºä¸€ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#069;font-weight:700>while</span> (cur_tuple.first.is_deleted_ <span style=color:#555>||</span>
</span></span><span style=display:flex><span>	    (plan_<span style=color:#555>-&gt;</span>filter_predicate_ <span style=color:#555>&amp;&amp;</span> <span style=color:#555>!</span>(plan_<span style=color:#555>-&gt;</span>filter_predicate_<span style=color:#555>-&gt;</span>Evaluate(tuple, GetOutputSchema()).GetAs<span style=color:#555>&lt;</span><span style=color:#078;font-weight:700>bool</span><span style=color:#555>&gt;</span>())))
</span></span></code></pre></div><p>å¦‚æœå…¶è¿”å› trueï¼Œè¯´æ˜ filter åŒ¹é…åˆ°äº†æ•°æ®ï¼ˆå°±å¦‚ä¾‹å­ä¸­åŒ¹é…åˆ°äº† colA åˆ—ä¸º 999 çš„ tupleï¼‰ï¼Œå¦‚æœæ­¤æ—¶è¿™ä¸ª tuple æ²¡æœ‰è¢«æ ‡è®°ä¸ºåˆ é™¤ï¼Œé‚£ä¹ˆå°±è¯´æ˜æ‰¾åˆ°äº†æˆ‘ä»¬éœ€è¦åˆ é™¤çš„ tupleã€‚</p><h3 id=update>Update<a hidden class=anchor aria-hidden=true href=#update>#</a></h3><p>æˆ‘ä»¬å¦‚ä½•çŸ¥é“ update éœ€è¦æ›´æ–°çš„æ•°æ®ä»å“ªé‡Œå–å‘¢ï¼Ÿ</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>bustub<span style=color:#555>&gt;</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>explain</span>(p,<span style=color:#bbb> </span>o)<span style=color:#bbb> </span><span style=color:#069;font-weight:700>update</span><span style=color:#bbb> </span>test_1<span style=color:#bbb> </span><span style=color:#069;font-weight:700>set</span><span style=color:#bbb> </span>colB<span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span><span style=color:#f60>15445</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#555>===</span><span style=color:#bbb> </span>PLANNER<span style=color:#bbb> </span><span style=color:#555>===</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#069;font-weight:700>Update</span><span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span>table_oid<span style=color:#555>=</span><span style=color:#f60>22</span>,<span style=color:#bbb> </span>target_exprs<span style=color:#555>=</span>[<span style=color:#c30>&#34;#0.0&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;15445&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;#0.2&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;#0.3&#34;</span>]<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>Filter<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span>predicate<span style=color:#555>=</span><span style=color:#069;font-weight:700>true</span><span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>SeqScan<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>table</span><span style=color:#555>=</span>test_1<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#555>===</span><span style=color:#bbb> </span>OPTIMIZER<span style=color:#bbb> </span><span style=color:#555>===</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#069;font-weight:700>Update</span><span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span>table_oid<span style=color:#555>=</span><span style=color:#f60>22</span>,<span style=color:#bbb> </span>target_exprs<span style=color:#555>=</span>[<span style=color:#c30>&#34;#0.0&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;15445&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;#0.2&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;#0.3&#34;</span>]<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>SeqScan<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>table</span><span style=color:#555>=</span>test_1,<span style=color:#bbb> </span>filter<span style=color:#555>=</span><span style=color:#069;font-weight:700>true</span><span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>çœ‹çœ‹ Update ä¸­ï¼Œæœ‰ä¸€ä¸ª <code>target_exprs</code> æ•°ç»„ï¼Œè¿™ä¸ªæ•°ç»„å¯ä¸å°±æ˜¯æˆ‘ä»¬çš„ä¸€è¡Œæ•°æ®å—ï¼Œå¹¶ä¸”æ˜¯éœ€è¦æ›´æ–°çš„é‚£è¡Œæ•°æ®ï¼šupdate è¯­å¥å¯ä»¥ä¸åŠ  where å­å¥ï¼Œè¿™æ ·å°±æ˜¯é€‰ä¸­è¡¨ä¸­çš„æ‰€æœ‰è¡Œï¼Œä¹Ÿå°±æ˜¯è¿™é‡Œå°†è¡¨ä¸­ colB åˆ—çš„æ•°æ®éƒ½ update ä¸º 15445ï¼</p><p>å¯¹äº <code>target_exprs</code> è¿™ä¸ªæ•°ç»„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>plan_->target_expressions_</code> è·å–ï¼Œç„¶åç”¨å…¶æ„å»ºä¸€ä¸ªæ–°çš„ tupleã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œå¹¶æ²¡æœ‰æä¾›ç›´æ¥æ›´æ–° tuple çš„æ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬çš„ update æ“ä½œå¯ä»¥ç”¨å…ˆåˆ é™¤åæ’å…¥çš„æ–¹å¼æ¥æ¨¡æ‹Ÿã€‚</p><h3 id=indexscan>IndexScan<a hidden class=anchor aria-hidden=true href=#indexscan>#</a></h3><p>æˆ‘ä»¬é¦–å…ˆéœ€è¦å®Œæˆ <code>OptimizeSeqScanAsIndexScan</code> è¿™ä¸ªä¼˜åŒ–æ­¥éª¤ã€‚</p><p>å‡è®¾ç°åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ªè¡¨å«â€œtest_1â€ï¼Œå…¶åˆ—å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#555>+</span><span style=color:#09f;font-style:italic>-------------+-------------+-------------+-------------+
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span><span style=color:#555>|</span><span style=color:#bbb> </span>test_1.colA<span style=color:#bbb> </span><span style=color:#555>|</span><span style=color:#bbb> </span>test_1.colB<span style=color:#bbb> </span><span style=color:#555>|</span><span style=color:#bbb> </span>test_1.colC<span style=color:#bbb> </span><span style=color:#555>|</span><span style=color:#bbb> </span>test_1.colD<span style=color:#bbb> </span><span style=color:#555>|</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#555>+</span><span style=color:#09f;font-style:italic>-------------+-------------+-------------+-------------+
</span></span></span></code></pre></div><p>ç°åœ¨æˆ‘ä»¬å¸Œæœ›è¿™æ¡ SQL èƒ½æ‰§è¡Œçš„æ›´å¿«ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#069;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#555>*</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>from</span><span style=color:#bbb> </span>test_1<span style=color:#bbb> </span><span style=color:#069;font-weight:700>where</span><span style=color:#bbb> </span>colB<span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span><span style=color:#f60>11</span>;<span style=color:#bbb>
</span></span></span></code></pre></div><p>é‚£æ¯”è¾ƒä¸é”™çš„æ–¹æ³•å°±æ˜¯ç»™ <code>colB</code> åˆ—åŠ ä¸Šç´¢å¼•ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#069;font-weight:700>create</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>index</span><span style=color:#bbb> </span>v1<span style=color:#bbb> </span><span style=color:#069;font-weight:700>on</span><span style=color:#bbb> </span>test_1(colB);<span style=color:#bbb>
</span></span></span></code></pre></div><p>è¿™æ ·åœ¨æ‰§è¡Œæ—¶å¯ä»¥æ›´å¿«é€Ÿçš„æŸ¥æ‰¾æ•°æ®ã€‚</p><p>é‚£ä¹ˆä¸ºäº†å®ç°è¿™ä¸€ç›®æ ‡ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡ <code>OptimizeSeqScanAsIndexScan</code> å°† plan æ ‘ä¸­çš„ <code>SeqScanPlanNode</code> è½¬æ¢æˆ <code>IndexScanPlanNode</code>ï¼Œè¿™æ ·æˆ‘ä»¬æ‰èƒ½ä½¿ç”¨ IndexScanPlanNode å¯¹åº”çš„ç®—å­ &mdash;<code>IndexScanExecutor</code> å»ä½¿ç”¨ç´¢å¼•ã€‚ä½†æ˜¯ç”±äº bustub çš„ä¸€äº›è®¾è®¡ï¼Œéœ€è¦éµå¾ªä»¥ä¸‹è§„åˆ™æ‰å¯ä»¥è½¬åŒ–ï¼š</p><ol><li>å½“å‰çš„èŠ‚ç‚¹çš„ç±»å‹å¿…é¡»æ˜¯ <code>PlanType::SeqScan</code></li><li>å½“å‰èŠ‚ç‚¹å¿…é¡»æœ‰ filter è°“è¯ï¼Œå¦‚æœåªæ˜¯ <code>select * from test_1;</code> è¿™æ ·çš„æ˜¯ä¸éœ€è¦ä½¿ç”¨ç´¢å¼•çš„</li><li>å½“å‰è¡¨ä¸­å¿…é¡»æœ‰ç´¢å¼•ï¼Œæ²¡æœ‰ç´¢å¼•è¿˜ç©å•¥å‘¢</li><li>fileter è°“è¯ä¸­çš„é€»è¾‘è¡¨è¾¾å¼åªèƒ½æœ‰ä¸€ä¸ªï¼Œå¹¶ä¸”å…¶ç±»å‹å¿…é¡»æ˜¯ <code>ComparisonType::Equal</code>ï¼ˆæˆ‘æƒ³è¿™é‡Œå¿…é¡»æ˜¯â€œç­‰äºâ€æ˜¯ä¸æ˜¯å› ä¸º fall2023 ä½¿ç”¨çš„ç´¢å¼•æ˜¯å“ˆå¸Œç´¢å¼•ï¼‰</li><li>åœ¨å½“å‰è¡¨çš„ç´¢å¼•ä¿¡æ¯ä¸­æ‰¾åˆ°ä¸ filter è°“è¯ç›¸å¯¹åº”çš„ç´¢å¼•åæ‰èƒ½è¿”å›ä¸€ä¸ª <code>IndexScanPlanNode</code></li></ol><p>åœ¨ <code>select * from test_1 where colB = 11;</code> ä¸­ï¼ŒåŠ äº†ç´¢å¼•åï¼Œæœ€éœ€è¦å…³æ³¨çš„å°±æ˜¯ <code>where colB = 11</code> è¿™ä¸€ä¸ªè¿‡æ»¤æ¡ä»¶ã€‚bustub ä¸­è¦æ±‚ <code>IndexScan</code> è¿‡æ»¤è¿ç®—ç¬¦å¿…é¡»æ˜¯ <code>=</code>ï¼Œä¸”åªèƒ½æœ‰ä¸€ä¸ªæ¡ä»¶ã€‚å¦‚æœ <code>colA</code> å’Œ <code>colB</code> éƒ½æ˜¯ç´¢å¼•ï¼Œç„¶åæ‰§è¡Œ <code>select * from test_1 where colB = 11 and colA = 1;</code>ï¼Œè¿™æ ·æ˜¯ä¸ä¼šèµ°ç´¢å¼•ä¼˜åŒ–çš„ã€‚</p><p>æˆ‘ä»¬å°†æŸ¥è¯¢è®¡åˆ’ä¸­çš„è¿‡æ»¤è°“è¯è½¬åŒ–æˆ <code>ComparisonExpression</code> ç±»å‹ï¼Œæ®æˆ‘çš„ç†è§£ï¼Œå…¶å¯é€šè¿‡ <code>GetChildAt</code> å‡½æ•°è·å–æ¯”è¾ƒè°“è¯å·¦è¾¹çš„åˆ—åè¡¨è¾¾å¼ï¼ˆå³è¿™é‡Œçš„â€œcolBâ€ï¼Œæœ‰äº†è¿™ä¸ªåˆ—åçš„è¡¨è¾¾å¼ï¼Œæˆ‘ä»¬å°±å¯ä»¥è·å–åˆ°è¿™ä¸ªåˆ—çš„ col_id å€¼ï¼‰å’Œå³è¾¹çš„å€¼ï¼ˆå³â€œ11â€ï¼‰ã€‚ä¹‹åéœ€è¦å»è¿™å¼ è¡¨ä¸­çš„æ‰€æœ‰ç´¢å¼•ä¸­å»æ‰¾æ˜¯å¦æœ‰ colB çš„ç´¢å¼•ï¼Œæ€ä¹ˆç¡®å®šæ˜¯å¦æœ‰å‘¢ï¼Œé‚£å°±è¦çœ‹è¿™ä¸ªè¡¨ä¸­çš„æ¯ä¸ª <code>Index</code> çš„ <code>key_attrs_</code>ï¼š</p><p>åœ¨ <code>Index</code> ä¸­ï¼Œ<code>key_attrs_</code> å†³å®šäº†ç´¢å¼•çš„å…³é”®å­—ç”±å“ªäº›åˆ—ç»„æˆï¼Œå¯¹åº”äº†æ¯ä¸ªåˆ—çš„ä¸‹æ ‡ã€‚ä¾‹å¦‚ï¼š</p><ul><li>å¦‚æœè¡¨çš„ schema å®šä¹‰æœ‰ 5 åˆ—ï¼Œåˆ†åˆ«ä¸º <code>A</code>, <code>B</code>, <code>C</code>, <code>D</code>, <code>E</code>ã€‚</li><li>æŸä¸ªç´¢å¼•çš„ <code>key_attrs_</code> æ˜¯ <code>[0, 2]</code>ï¼Œåˆ™è¡¨ç¤ºè¯¥ç´¢å¼•ä½¿ç”¨äº†ç¬¬ 0 åˆ—ï¼ˆ<code>A</code>ï¼‰å’Œç¬¬ 2 åˆ—ï¼ˆ<code>C</code>ï¼‰ä½œä¸ºå…¶å…³é”®å­—ã€‚</li></ul><p>å¦‚æœä¹‹å‰æˆ‘ä»¬è·å–çš„åˆ—çš„ col_id å€¼å’ŒæŸä¸ª <code>Index</code> çš„ <code>key_attrs_</code> ä¸­çš„å€¼ç›¸åŒï¼Œé‚£ä¹ˆå°±å­˜åœ¨ç›¸åº”çš„ç´¢å¼•ï¼è¿™æ—¶æ„é€ ä¸€ä¸ª <code>IndexScanPlanNode</code> è¿”å›å³å¯ï¼ˆå‚è€ƒ <code>merge_filter_scan.cpp</code> ä¸­æ˜¯å¦‚ä½•åšçš„ï¼‰ã€‚</p><p>å½“ä¼˜åŒ–å™¨æˆåŠŸæ›´æ¢èŠ‚ç‚¹åï¼Œåœ¨æ‰§è¡Œæ—¶å°±ä¼šèµ°ç´¢å¼•ï¼Œå…¶åº•å±‚ç®—å­å°±ä¼šä½¿ç”¨åˆ° <code>IndexScanExecutor</code>ã€‚åˆ°è¿™é‡Œï¼Œè¿™ä¸ªç®—å­éœ€è¦åšçš„äº‹æƒ…å°±å¾ˆç®€å•äº†ï¼Œå°±æ˜¯è°ƒç”¨å“ˆå¸Œç´¢å¼•çš„ <code>ScanKey</code> è¿›è¡ŒæŸ¥æ‰¾ï¼Œä¸è¿‡è¿™é‡Œæœ‰ 3 ç‚¹éœ€è¦æ³¨æ„ï¼š</p><ol><li>åœ¨ project2 ä¸­ï¼Œæˆ‘ä»¬å®ç°çš„ç´¢å¼•å¼•æ“åªæ”¯æŒä¸€ä¸ªé”®å¯¹åº”ä¸€ä¸ªå€¼ï¼ˆä¸åªæ˜¯è¿™ä¸ªç‰ˆæœ¬çš„å¯æ‹“å±•å“ˆå¸Œï¼Œå…¶ä»–ç‰ˆæœ¬ä¸­çš„ B+Tree ä¹Ÿåªè¦æ±‚è¿™æ ·å®ç°ï¼‰ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„è¿™ä¸ªç®—å­åœ¨åº•å±‚ç´¢å¼•å¼•æ“ä¸æ‰©å±•çš„æƒ…å†µä¸‹æœ€å¤šæŸ¥åˆ°ä¸€æ¡è®°å½•ï¼Œè¿™æ ·çš„è¯å°±å¯ä»¥åœ¨ç®—å­çš„ <code>Init</code> å‡½æ•°ä¸­è°ƒç”¨ <code>ScanKey</code> æŸ¥æ‰¾è®°å½•å°±è¡Œã€‚</li><li>å¯æ‹“å±•å“ˆå¸Œä¸­æ˜¯å°†ä¸€ä¸ª Tuple çš„ data è½¬åŒ–ä¸€ä¸‹å½“ä½œ keyï¼Œæ‰€ä»¥åœ¨ç´¢å¼•ä¸­ï¼Œå…¶æ˜¯å°†ç´¢å¼•åˆ—çš„å€¼ä½œä¸º keyï¼Œå…¶å¯¹åº”çš„ oid ä½œä¸ºå€¼ã€‚åœ¨ä½¿ç”¨ <code>ScanKey</code> æ—¶ï¼Œç¬¬ä¸€ä¸ªå‚æ•°éœ€è¦çš„ tuple å°†ç”¨æŸ¥è¯¢è®¡åˆ’èŠ‚ç‚¹ <code>IndexScanPlanNode</code> ä¸­çš„ <code>pred_key_</code> æ„é€ ã€‚</li><li>è¡¨ä¸­çš„ tuple çš„å…ƒæ•°æ®ä¸­ï¼Œå…¶ <code>is_deleted_</code> å¯èƒ½ä¸º trueï¼Œè¿™è¯´æ˜è¿™ä¸ª tuple åœ¨é€»è¾‘ä¸Šå·²ç»åˆ é™¤äº†ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬é€šè¿‡ 2 ä¸­è·å–çš„ oid å¯¹åº”çš„ tuple æ˜¯è¿™ç§æƒ…å†µï¼Œå°±ä¸ç”¨å‘ä¸Šè¿”å›æ•°æ®ã€‚</li></ol><h2 id=task2---aggregation--join-executors>Task2 - Aggregation & Join Executors<a hidden class=anchor aria-hidden=true href=#task2---aggregation--join-executors>#</a></h2><h3 id=aggregation>Aggregation<a hidden class=anchor aria-hidden=true href=#aggregation>#</a></h3><p>åˆ†æä¸€ä¸ªä¾‹å­ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>bustub<span style=color:#555>&gt;</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>EXPLAIN</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>SELECT</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>MAX</span>(colC),<span style=color:#bbb> </span><span style=color:#069;font-weight:700>MIN</span>(colB)<span style=color:#bbb> </span><span style=color:#069;font-weight:700>FROM</span><span style=color:#bbb> </span>test_1<span style=color:#bbb> </span><span style=color:#069;font-weight:700>GROUP</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>BY</span><span style=color:#bbb> </span>colA<span style=color:#bbb> </span><span style=color:#069;font-weight:700>HAVING</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>MAX</span>(colB)<span style=color:#bbb> </span><span style=color:#555>&gt;</span><span style=color:#bbb> </span><span style=color:#f60>10</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#555>===</span><span style=color:#bbb> </span>BINDER<span style=color:#bbb> </span><span style=color:#555>===</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>BoundSelect<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#069;font-weight:700>table</span><span style=color:#555>=</span>BoundBaseTableRef<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>table</span><span style=color:#555>=</span>test_1,<span style=color:#bbb> </span>oid<span style=color:#555>=</span><span style=color:#f60>22</span><span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>columns<span style=color:#555>=</span>[<span style=color:#c30>&#34;max([\&#34;</span>test_1.colC<span style=color:#a00;background-color:#faa>\</span><span style=color:#c30>&#34;])&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;min([\&#34;</span>test_1.colB<span style=color:#a00;background-color:#faa>\</span><span style=color:#c30>&#34;])&#34;</span>],<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>groupBy<span style=color:#555>=</span>[<span style=color:#c30>&#34;test_1.colA&#34;</span>],<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#069;font-weight:700>having</span><span style=color:#555>=</span>(<span style=color:#069;font-weight:700>max</span>([<span style=color:#c30>&#34;test_1.colB&#34;</span>])<span style=color:#555>&gt;</span><span style=color:#f60>10</span>),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#069;font-weight:700>where</span><span style=color:#555>=</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#069;font-weight:700>limit</span><span style=color:#555>=</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#069;font-weight:700>offset</span><span style=color:#555>=</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>order_by<span style=color:#555>=</span>[],<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>is_distinct<span style=color:#555>=</span><span style=color:#069;font-weight:700>false</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>ctes<span style=color:#555>=</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#555>===</span><span style=color:#bbb> </span>PLANNER<span style=color:#bbb> </span><span style=color:#555>===</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>Projection<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span>exprs<span style=color:#555>=</span>[<span style=color:#c30>&#34;#0.2&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;#0.3&#34;</span>]<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb> </span><span style=color:#555>|</span><span style=color:#bbb> </span>(<span style=color:#555>&lt;</span><span style=color:#069;font-weight:700>unnamed</span><span style=color:#555>&gt;</span>:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span><span style=color:#555>&lt;</span><span style=color:#069;font-weight:700>unnamed</span><span style=color:#555>&gt;</span>:<span style=color:#366>INTEGER</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>Filter<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span>predicate<span style=color:#555>=</span>(<span style=color:#555>#</span><span style=color:#f60>0</span>.<span style=color:#f60>1</span><span style=color:#555>&gt;</span><span style=color:#f60>10</span>)<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb> </span><span style=color:#555>|</span><span style=color:#bbb> </span>(test_1.colA:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>agg<span style=color:#555>#</span><span style=color:#f60>0</span>:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>agg<span style=color:#555>#</span><span style=color:#f60>1</span>:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>agg<span style=color:#555>#</span><span style=color:#f60>2</span>:<span style=color:#366>INTEGER</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>Agg<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span>types<span style=color:#555>=</span>[<span style=color:#c30>&#34;max&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;max&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;min&#34;</span>],<span style=color:#bbb> </span>aggregates<span style=color:#555>=</span>[<span style=color:#c30>&#34;#0.1&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;#0.2&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;#0.1&#34;</span>],<span style=color:#bbb> </span>group_by<span style=color:#555>=</span>[<span style=color:#c30>&#34;#0.0&#34;</span>]<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb> </span><span style=color:#555>|</span><span style=color:#bbb> </span>(test_1.colA:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>agg<span style=color:#555>#</span><span style=color:#f60>0</span>:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>agg<span style=color:#555>#</span><span style=color:#f60>1</span>:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>agg<span style=color:#555>#</span><span style=color:#f60>2</span>:<span style=color:#366>INTEGER</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>SeqScan<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>table</span><span style=color:#555>=</span>test_1<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb> </span><span style=color:#555>|</span><span style=color:#bbb> </span>(test_1.colA:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>test_1.colB:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>test_1.colC:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>test_1.colD:<span style=color:#366>INTEGER</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#555>===</span><span style=color:#bbb> </span>OPTIMIZER<span style=color:#bbb> </span><span style=color:#555>===</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>Projection<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span>exprs<span style=color:#555>=</span>[<span style=color:#c30>&#34;#0.2&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;#0.3&#34;</span>]<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb> </span><span style=color:#555>|</span><span style=color:#bbb> </span>(<span style=color:#555>&lt;</span><span style=color:#069;font-weight:700>unnamed</span><span style=color:#555>&gt;</span>:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span><span style=color:#555>&lt;</span><span style=color:#069;font-weight:700>unnamed</span><span style=color:#555>&gt;</span>:<span style=color:#366>INTEGER</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>Filter<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span>predicate<span style=color:#555>=</span>(<span style=color:#555>#</span><span style=color:#f60>0</span>.<span style=color:#f60>1</span><span style=color:#555>&gt;</span><span style=color:#f60>10</span>)<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb> </span><span style=color:#555>|</span><span style=color:#bbb> </span>(test_1.colA:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>agg<span style=color:#555>#</span><span style=color:#f60>0</span>:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>agg<span style=color:#555>#</span><span style=color:#f60>1</span>:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>agg<span style=color:#555>#</span><span style=color:#f60>2</span>:<span style=color:#366>INTEGER</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>Agg<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span>types<span style=color:#555>=</span>[<span style=color:#c30>&#34;max&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;max&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;min&#34;</span>],<span style=color:#bbb> </span>aggregates<span style=color:#555>=</span>[<span style=color:#c30>&#34;#0.1&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;#0.2&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;#0.1&#34;</span>],<span style=color:#bbb> </span>group_by<span style=color:#555>=</span>[<span style=color:#c30>&#34;#0.0&#34;</span>]<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb> </span><span style=color:#555>|</span><span style=color:#bbb> </span>(test_1.colA:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>agg<span style=color:#555>#</span><span style=color:#f60>0</span>:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>agg<span style=color:#555>#</span><span style=color:#f60>1</span>:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>agg<span style=color:#555>#</span><span style=color:#f60>2</span>:<span style=color:#366>INTEGER</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>SeqScan<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>table</span><span style=color:#555>=</span>test_1<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb> </span><span style=color:#555>|</span><span style=color:#bbb> </span>(test_1.colA:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>test_1.colB:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>test_1.colC:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>test_1.colD:<span style=color:#366>INTEGER</span>)<span style=color:#bbb>
</span></span></span></code></pre></div><p>å¯¹äº AggregationExecutorï¼Œæˆ‘ä»¬å¯ä»¥è·å–åˆ° SQL è¯­å¥ä¸­ï¼š</p><ol><li>èšåˆæ“ä½œçš„ <code>types</code>ï¼ˆè¿›è¡Œèšåˆæ“ä½œçš„ç±»å‹ï¼‰å’Œ <code>aggregates</code>ï¼ˆéœ€è¦èšåˆæ“ä½œçš„åˆ—ï¼‰ï¼ŒäºŒè€…ä¸€ä¸€å¯¹åº”</li><li>éœ€è¦ group by è¿›è¡Œåˆ†ç»„çš„åˆ—</li></ol><p><div class=post-img-view><a data-fancybox=gallery href=https://obsidian-image-oss.oss-cn-shanghai.aliyuncs.com/Pasted%20image%2020250311194555.png><img src=https://obsidian-image-oss.oss-cn-shanghai.aliyuncs.com/Pasted%20image%2020250311194555.png alt></a></div></p><p>å†çœ‹çœ‹ lecture ä¸­çš„è¿™ä¸ªä¾‹å­ï¼Œå…¶å¯¹åˆ— cid ä½¿ç”¨ group by è¿›è¡Œåˆ†ç»„ï¼Œå…¶ä¸­æ¶‰åŠçš„èšåˆæ“ä½œä¸º <code>AVG</code>ï¼Œå¯è½¬æ¢æˆ <code>COUNT</code> å’Œ <code>SUM</code> æ“ä½œã€‚è¿™é‡Œç›¸å½“äºï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>types = [&#39;count&#39;, &#39;sum&#39;]
</span></span><span style=display:flex><span>aggregates = [&#39;s.gpa&#39;, &#39;s.gpa&#39;]
</span></span></code></pre></div><p>æˆ‘çš„ç†è§£æ˜¯æ ¹æ® group by çš„å­—æ®µçš„å€¼è¿›è¡Œ hash å‡½æ•°å¤„ç†ä½œä¸ºå“ˆå¸Œè¡¨çš„é”®ï¼Œä¾‹å¦‚å›¾ä¸­çš„â€œ15-445â€ï¼Œâ€œ15-826â€ç­‰ï¼›ç„¶åå“ˆå¸Œè¡¨çš„å€¼ä¸ºä¸€ä¸ªé›†åˆï¼Œè¿™ä¸ªé›†åˆçš„å¤§å°å’Œ <code>types</code> å’Œ <code>aggregates</code> çš„å¤§å°ç›¸åŒï¼Œå¹¶ä¸”å¯¹åº”çš„ä½ç½®å°±ä¸º aggregates çš„å€¼ï¼šä¾‹å¦‚å›¾ä¸­é”®â€œ15-445â€çš„å€¼ä¸­ï¼Œç¬¬ä¸€ä¸ªå…ƒç´ å°±ä¸º <code>COUNT</code> æ“ä½œä¸‹ <code>s.gpa</code> ä¸º 15-445 çš„ä¸ªæ•°ã€‚</p><p>åœ¨ lab ä¸­éœ€è¦å®ç° <code>count</code>ã€<code>sum</code>ã€<code>max</code>ã€<code>min</code> æ“ä½œï¼Œå…¶å®å°±æ˜¯åœ¨ <code>SimpleAggregationHashTableï¼šï¼šCombineAggregateValues</code> ä¸­å®ç°å¯¹åº”çš„æ“ä½œå³å¯ï¼Œæœ¬è´¨ä¸Šæ˜¯å¯¹å“ˆå¸Œè¡¨çš„å‡ ä¸ªå¾ˆç®€å•çš„æ“ä½œã€‚</p><p><code>aggregation</code> é€šå¸¸éœ€è¦å¯¹ä¸€ç»„æ•°æ®è¿›è¡Œè®¡ç®—ï¼Œè¿™äº›è®¡ç®—å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p><ol><li><strong>éœ€è¦å®Œæ•´è¾“å…¥</strong>ï¼šAggregation é€šå¸¸éœ€è¦ä»ä¸‹å±‚æ‹‰å–æ‰€æœ‰ç›¸å…³æ•°æ®æ‰èƒ½è®¡ç®—ç»“æœï¼Œä¾‹å¦‚è®¡ç®— <code>SUM</code> éœ€è¦éå†æ‰€æœ‰è¡Œã€‚</li><li><strong>é˜»å¡æ€§</strong>ï¼šåœ¨ä¼ ç»Ÿå®ç°ä¸­ï¼ŒAggregation ç®—å­é€šå¸¸è¢«ç§°ä¸ºâ€œé˜»å¡ç®—å­â€ï¼Œå› ä¸ºå®ƒå¿…é¡»ç­‰å¾…æ‰€æœ‰è¾“å…¥æ•°æ®éƒ½æ‹‰å–å®Œæˆæ‰èƒ½äº§å‡ºç»“æœã€‚è¿™æ„å‘³ç€ <code>next()</code> è°ƒç”¨ä¼šè¢«å»¶è¿Ÿï¼Œç›´åˆ°èšåˆè®¡ç®—å®Œæˆã€‚</li></ol><p>åœ¨æˆ‘ä»¬çš„ç«å±±æ¨¡å‹ä¸­ <code>aggregation</code> æ˜¯é˜»å¡ç®—å­ï¼š</p><ul><li>å½“ä¸Šå±‚ç®—å­è°ƒç”¨ <code>next()</code> æ—¶ï¼Œ<code>aggregation</code> ä¼šå‘ä¸‹å±‚ç®—å­è¿ç»­è°ƒç”¨ <code>next()</code>ï¼Œç›´åˆ°æ‹‰å–å®Œå…¨éƒ¨æ•°æ®å¹¶å®Œæˆèšåˆã€‚</li><li>åœ¨æ•°æ®å°šæœªå®Œå…¨æ‹‰å–å¹¶èšåˆå®Œæˆä¹‹å‰ï¼Œä¸Šå±‚çš„ <code>next()</code> è°ƒç”¨æ— æ³•ç›´æ¥è¿”å›ç»“æœã€‚</li></ul><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼š</p><ul><li>SQL ä¸­è¿›è¡Œ <code>group by</code> åä½¿ç”¨ <code>count</code>ï¼Œç»Ÿè®¡çš„æ˜¯<strong>æ¯ç»„æ•°æ®ä¸­çš„è®°å½•æ•°</strong>ï¼Œè€Œéåˆ†ç»„åæ–°è¡¨çš„è¡Œæ•°ã€‚</li><li><code>distinct</code> å…¶å®å°±æ˜¯å¯¹æŸä¸ªå­—æ®µè¿›è¡Œ <code>group by</code> æ“ä½œ</li><li><code>count(*)</code> ç»Ÿè®¡ nullï¼Œè€Œ <code>count(å­—æ®µ)</code> ä¸ç»Ÿè®¡ null</li></ul><h3 id=nestedloopjoin>NestedLoopJoin<a hidden class=anchor aria-hidden=true href=#nestedloopjoin>#</a></h3><p>Inner Joinï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>bustub<span style=color:#555>&gt;</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>EXPLAIN</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>SELECT</span><span style=color:#bbb> </span><span style=color:#555>*</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>FROM</span><span style=color:#bbb> </span>__mock_table_1,<span style=color:#bbb> </span>__mock_table_3<span style=color:#bbb> </span><span style=color:#069;font-weight:700>WHERE</span><span style=color:#bbb> </span>colA<span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span>colE;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#555>===</span><span style=color:#bbb> </span>BINDER<span style=color:#bbb> </span><span style=color:#555>===</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>BoundSelect<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#069;font-weight:700>table</span><span style=color:#555>=</span>BoundCrossProductRef<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>left</span><span style=color:#555>=</span>BoundBaseTableRef<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>table</span><span style=color:#555>=</span>__mock_table_1,<span style=color:#bbb> </span>oid<span style=color:#555>=</span><span style=color:#f60>0</span><span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span>,<span style=color:#bbb> </span><span style=color:#069;font-weight:700>right</span><span style=color:#555>=</span>BoundBaseTableRef<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>table</span><span style=color:#555>=</span>__mock_table_3,<span style=color:#bbb> </span>oid<span style=color:#555>=</span><span style=color:#f60>2</span><span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>columns<span style=color:#555>=</span>[<span style=color:#c30>&#34;__mock_table_1.colA&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;__mock_table_1.colB&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;__mock_table_3.colE&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;__mock_table_3.colF&#34;</span>],<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>groupBy<span style=color:#555>=</span>[],<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#069;font-weight:700>having</span><span style=color:#555>=</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#069;font-weight:700>where</span><span style=color:#555>=</span>(__mock_table_1.colA<span style=color:#555>=</span>__mock_table_3.colE),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#069;font-weight:700>limit</span><span style=color:#555>=</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#069;font-weight:700>offset</span><span style=color:#555>=</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>order_by<span style=color:#555>=</span>[],<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>is_distinct<span style=color:#555>=</span><span style=color:#069;font-weight:700>false</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>ctes<span style=color:#555>=</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#555>===</span><span style=color:#bbb> </span>PLANNER<span style=color:#bbb> </span><span style=color:#555>===</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>Projection<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span>exprs<span style=color:#555>=</span>[<span style=color:#c30>&#34;#0.0&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;#0.1&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;#0.2&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;#0.3&#34;</span>]<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb> </span><span style=color:#555>|</span><span style=color:#bbb> </span>(__mock_table_1.colA:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__mock_table_1.colB:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__mock_table_3.colE:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__mock_table_3.colF:<span style=color:#366>VARCHAR</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>Filter<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span>predicate<span style=color:#555>=</span>(<span style=color:#555>#</span><span style=color:#f60>0</span>.<span style=color:#f60>0</span><span style=color:#555>=#</span><span style=color:#f60>0</span>.<span style=color:#f60>2</span>)<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb> </span><span style=color:#555>|</span><span style=color:#bbb> </span>(__mock_table_1.colA:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__mock_table_1.colB:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__mock_table_3.colE:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__mock_table_3.colF:<span style=color:#366>VARCHAR</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>NestedLoopJoin<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>type</span><span style=color:#555>=</span><span style=color:#069;font-weight:700>Inner</span>,<span style=color:#bbb> </span>predicate<span style=color:#555>=</span><span style=color:#069;font-weight:700>true</span><span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb> </span><span style=color:#555>|</span><span style=color:#bbb> </span>(__mock_table_1.colA:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__mock_table_1.colB:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__mock_table_3.colE:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__mock_table_3.colF:<span style=color:#366>VARCHAR</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>MockScan<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>table</span><span style=color:#555>=</span>__mock_table_1<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb> </span><span style=color:#555>|</span><span style=color:#bbb> </span>(__mock_table_1.colA:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__mock_table_1.colB:<span style=color:#366>INTEGER</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>MockScan<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>table</span><span style=color:#555>=</span>__mock_table_3<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb> </span><span style=color:#555>|</span><span style=color:#bbb> </span>(__mock_table_3.colE:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__mock_table_3.colF:<span style=color:#366>VARCHAR</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#555>===</span><span style=color:#bbb> </span>OPTIMIZER<span style=color:#bbb> </span><span style=color:#555>===</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>NestedLoopJoin<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>type</span><span style=color:#555>=</span><span style=color:#069;font-weight:700>Inner</span>,<span style=color:#bbb> </span>predicate<span style=color:#555>=</span>(<span style=color:#555>#</span><span style=color:#f60>0</span>.<span style=color:#f60>0</span><span style=color:#555>=#</span><span style=color:#f60>1</span>.<span style=color:#f60>0</span>)<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb> </span><span style=color:#555>|</span><span style=color:#bbb> </span>(__mock_table_1.colA:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__mock_table_1.colB:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__mock_table_3.colE:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__mock_table_3.colF:<span style=color:#366>VARCHAR</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>MockScan<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>table</span><span style=color:#555>=</span>__mock_table_1<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb> </span><span style=color:#555>|</span><span style=color:#bbb> </span>(__mock_table_1.colA:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__mock_table_1.colB:<span style=color:#366>INTEGER</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>MockScan<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>table</span><span style=color:#555>=</span>__mock_table_3<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb> </span><span style=color:#555>|</span><span style=color:#bbb> </span>(__mock_table_3.colE:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__mock_table_3.colF:<span style=color:#366>VARCHAR</span>)<span style=color:#bbb>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>bustub<span style=color:#555>&gt;</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>EXPLAIN</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>SELECT</span><span style=color:#bbb> </span><span style=color:#555>*</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>FROM</span><span style=color:#bbb> </span>__mock_table_1<span style=color:#bbb> </span><span style=color:#069;font-weight:700>INNER</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>JOIN</span><span style=color:#bbb> </span>__mock_table_3<span style=color:#bbb> </span><span style=color:#069;font-weight:700>ON</span><span style=color:#bbb> </span>colA<span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span>colE;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#555>===</span><span style=color:#bbb> </span>BINDER<span style=color:#bbb> </span><span style=color:#555>===</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>BoundSelect<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#069;font-weight:700>table</span><span style=color:#555>=</span>BoundJoin<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>type</span><span style=color:#555>=</span><span style=color:#069;font-weight:700>Inner</span>,<span style=color:#bbb> </span><span style=color:#069;font-weight:700>left</span><span style=color:#555>=</span>BoundBaseTableRef<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>table</span><span style=color:#555>=</span>__mock_table_1,<span style=color:#bbb> </span>oid<span style=color:#555>=</span><span style=color:#f60>0</span><span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span>,<span style=color:#bbb> </span><span style=color:#069;font-weight:700>right</span><span style=color:#555>=</span>BoundBaseTableRef<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>table</span><span style=color:#555>=</span>__mock_table_3,<span style=color:#bbb> </span>oid<span style=color:#555>=</span><span style=color:#f60>2</span><span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span>,<span style=color:#bbb> </span>condition<span style=color:#555>=</span>(__mock_table_1.colA<span style=color:#555>=</span>__mock_table_3.colE)<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>columns<span style=color:#555>=</span>[<span style=color:#c30>&#34;__mock_table_1.colA&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;__mock_table_1.colB&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;__mock_table_3.colE&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;__mock_table_3.colF&#34;</span>],<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>groupBy<span style=color:#555>=</span>[],<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#069;font-weight:700>having</span><span style=color:#555>=</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#069;font-weight:700>where</span><span style=color:#555>=</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#069;font-weight:700>limit</span><span style=color:#555>=</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#069;font-weight:700>offset</span><span style=color:#555>=</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>order_by<span style=color:#555>=</span>[],<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>is_distinct<span style=color:#555>=</span><span style=color:#069;font-weight:700>false</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>ctes<span style=color:#555>=</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#555>===</span><span style=color:#bbb> </span>PLANNER<span style=color:#bbb> </span><span style=color:#555>===</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>Projection<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span>exprs<span style=color:#555>=</span>[<span style=color:#c30>&#34;#0.0&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;#0.1&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;#0.2&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;#0.3&#34;</span>]<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb> </span><span style=color:#555>|</span><span style=color:#bbb> </span>(__mock_table_1.colA:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__mock_table_1.colB:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__mock_table_3.colE:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__mock_table_3.colF:<span style=color:#366>VARCHAR</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>NestedLoopJoin<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>type</span><span style=color:#555>=</span><span style=color:#069;font-weight:700>Inner</span>,<span style=color:#bbb> </span>predicate<span style=color:#555>=</span>(<span style=color:#555>#</span><span style=color:#f60>0</span>.<span style=color:#f60>0</span><span style=color:#555>=#</span><span style=color:#f60>1</span>.<span style=color:#f60>0</span>)<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb> </span><span style=color:#555>|</span><span style=color:#bbb> </span>(__mock_table_1.colA:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__mock_table_1.colB:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__mock_table_3.colE:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__mock_table_3.colF:<span style=color:#366>VARCHAR</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>MockScan<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>table</span><span style=color:#555>=</span>__mock_table_1<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb> </span><span style=color:#555>|</span><span style=color:#bbb> </span>(__mock_table_1.colA:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__mock_table_1.colB:<span style=color:#366>INTEGER</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>MockScan<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>table</span><span style=color:#555>=</span>__mock_table_3<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb> </span><span style=color:#555>|</span><span style=color:#bbb> </span>(__mock_table_3.colE:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__mock_table_3.colF:<span style=color:#366>VARCHAR</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#555>===</span><span style=color:#bbb> </span>OPTIMIZER<span style=color:#bbb> </span><span style=color:#555>===</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>NestedLoopJoin<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>type</span><span style=color:#555>=</span><span style=color:#069;font-weight:700>Inner</span>,<span style=color:#bbb> </span>predicate<span style=color:#555>=</span>(<span style=color:#555>#</span><span style=color:#f60>0</span>.<span style=color:#f60>0</span><span style=color:#555>=#</span><span style=color:#f60>1</span>.<span style=color:#f60>0</span>)<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb> </span><span style=color:#555>|</span><span style=color:#bbb> </span>(__mock_table_1.colA:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__mock_table_1.colB:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__mock_table_3.colE:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__mock_table_3.colF:<span style=color:#366>VARCHAR</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>MockScan<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>table</span><span style=color:#555>=</span>__mock_table_1<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb> </span><span style=color:#555>|</span><span style=color:#bbb> </span>(__mock_table_1.colA:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__mock_table_1.colB:<span style=color:#366>INTEGER</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>MockScan<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>table</span><span style=color:#555>=</span>__mock_table_3<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb> </span><span style=color:#555>|</span><span style=color:#bbb> </span>(__mock_table_3.colE:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__mock_table_3.colF:<span style=color:#366>VARCHAR</span>)<span style=color:#bbb>
</span></span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼Œå³ä¾¿æˆ‘ä»¬ä¸åŠ  <code>inner join</code>ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¹Ÿæ˜¯ä½¿ç”¨çš„ Inner Joinï¼š<code>NestedLoopJoin</code> ä¸­çš„ type å‡ä¸º <code>Inner</code>ã€‚</p><p>Left Joinï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>bustub<span style=color:#555>&gt;</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>EXPLAIN</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>SELECT</span><span style=color:#bbb> </span><span style=color:#555>*</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>FROM</span><span style=color:#bbb> </span>__mock_table_1<span style=color:#bbb> </span><span style=color:#069;font-weight:700>LEFT</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>OUTER</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>JOIN</span><span style=color:#bbb> </span>__mock_table_3<span style=color:#bbb> </span><span style=color:#069;font-weight:700>ON</span><span style=color:#bbb> </span>colA<span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span>colE;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#555>===</span><span style=color:#bbb> </span>BINDER<span style=color:#bbb> </span><span style=color:#555>===</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>BoundSelect<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#069;font-weight:700>table</span><span style=color:#555>=</span>BoundJoin<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>type</span><span style=color:#555>=</span><span style=color:#069;font-weight:700>Left</span>,<span style=color:#bbb> </span><span style=color:#069;font-weight:700>left</span><span style=color:#555>=</span>BoundBaseTableRef<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>table</span><span style=color:#555>=</span>__mock_table_1,<span style=color:#bbb> </span>oid<span style=color:#555>=</span><span style=color:#f60>0</span><span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span>,<span style=color:#bbb> </span><span style=color:#069;font-weight:700>right</span><span style=color:#555>=</span>BoundBaseTableRef<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>table</span><span style=color:#555>=</span>__mock_table_3,<span style=color:#bbb> </span>oid<span style=color:#555>=</span><span style=color:#f60>2</span><span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span>,<span style=color:#bbb> </span>condition<span style=color:#555>=</span>(__mock_table_1.colA<span style=color:#555>=</span>__mock_table_3.colE)<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>columns<span style=color:#555>=</span>[<span style=color:#c30>&#34;__mock_table_1.colA&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;__mock_table_1.colB&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;__mock_table_3.colE&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;__mock_table_3.colF&#34;</span>],<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>groupBy<span style=color:#555>=</span>[],<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#069;font-weight:700>having</span><span style=color:#555>=</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#069;font-weight:700>where</span><span style=color:#555>=</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#069;font-weight:700>limit</span><span style=color:#555>=</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#069;font-weight:700>offset</span><span style=color:#555>=</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>order_by<span style=color:#555>=</span>[],<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>is_distinct<span style=color:#555>=</span><span style=color:#069;font-weight:700>false</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>ctes<span style=color:#555>=</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#555>===</span><span style=color:#bbb> </span>PLANNER<span style=color:#bbb> </span><span style=color:#555>===</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>Projection<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span>exprs<span style=color:#555>=</span>[<span style=color:#c30>&#34;#0.0&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;#0.1&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;#0.2&#34;</span>,<span style=color:#bbb> </span><span style=color:#c30>&#34;#0.3&#34;</span>]<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb> </span><span style=color:#555>|</span><span style=color:#bbb> </span>(__mock_table_1.colA:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__mock_table_1.colB:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__mock_table_3.colE:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__mock_table_3.colF:<span style=color:#366>VARCHAR</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>NestedLoopJoin<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>type</span><span style=color:#555>=</span><span style=color:#069;font-weight:700>Left</span>,<span style=color:#bbb> </span>predicate<span style=color:#555>=</span>(<span style=color:#555>#</span><span style=color:#f60>0</span>.<span style=color:#f60>0</span><span style=color:#555>=#</span><span style=color:#f60>1</span>.<span style=color:#f60>0</span>)<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb> </span><span style=color:#555>|</span><span style=color:#bbb> </span>(__mock_table_1.colA:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__mock_table_1.colB:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__mock_table_3.colE:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__mock_table_3.colF:<span style=color:#366>VARCHAR</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>MockScan<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>table</span><span style=color:#555>=</span>__mock_table_1<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb> </span><span style=color:#555>|</span><span style=color:#bbb> </span>(__mock_table_1.colA:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__mock_table_1.colB:<span style=color:#366>INTEGER</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>MockScan<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>table</span><span style=color:#555>=</span>__mock_table_3<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb> </span><span style=color:#555>|</span><span style=color:#bbb> </span>(__mock_table_3.colE:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__mock_table_3.colF:<span style=color:#366>VARCHAR</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#555>===</span><span style=color:#bbb> </span>OPTIMIZER<span style=color:#bbb> </span><span style=color:#555>===</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>NestedLoopJoin<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>type</span><span style=color:#555>=</span><span style=color:#069;font-weight:700>Left</span>,<span style=color:#bbb> </span>predicate<span style=color:#555>=</span>(<span style=color:#555>#</span><span style=color:#f60>0</span>.<span style=color:#f60>0</span><span style=color:#555>=#</span><span style=color:#f60>1</span>.<span style=color:#f60>0</span>)<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb> </span><span style=color:#555>|</span><span style=color:#bbb> </span>(__mock_table_1.colA:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__mock_table_1.colB:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__mock_table_3.colE:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__mock_table_3.colF:<span style=color:#366>VARCHAR</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>MockScan<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>table</span><span style=color:#555>=</span>__mock_table_1<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb> </span><span style=color:#555>|</span><span style=color:#bbb> </span>(__mock_table_1.colA:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__mock_table_1.colB:<span style=color:#366>INTEGER</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>MockScan<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>table</span><span style=color:#555>=</span>__mock_table_3<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb> </span><span style=color:#555>|</span><span style=color:#bbb> </span>(__mock_table_3.colE:<span style=color:#366>INTEGER</span>,<span style=color:#bbb> </span>__mock_table_3.colF:<span style=color:#366>VARCHAR</span>)<span style=color:#bbb>
</span></span></span></code></pre></div><p>ç”±äºç«å±±æ¨¡å‹ä¸­çš„ Next æ¯æ¬¡è¿”å›ä¸€æ¡ tupleï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨ Init ä¸­å¾—åˆ° join åçš„æ‰€æœ‰ tupleã€‚Nested Loop Join å…¶å®å°±æ˜¯ç”¨ä¸¤ä¸ª for å¾ªç¯å»éå†ä¸¤å¼ è¡¨ï¼Œä¿å­˜æ»¡è¶³ç­›é€‰æ¡ä»¶çš„ tupleã€‚</p><p><code>inner join</code> åªä¼šè¿”å›ä¸¤ä¸ªè¡¨ä¸­æ»¡è¶³è¿æ¥æ¡ä»¶çš„ tupleï¼›è€Œ <code>left join</code> ä¼šè¿”å›å·¦è¡¨ä¸­çš„æ‰€æœ‰è®°å½•ï¼Œä»¥åŠå³è¡¨ä¸­æ»¡è¶³æ¡ä»¶çš„ tupleã€‚æ‰€ä»¥åœ¨åµŒå¥— for å¾ªç¯ä¸­ï¼Œå¦‚æœå³è¡¨ä¸­æœ‰æœªèƒ½æ»¡è¶³æ¡ä»¶çš„ tupleï¼Œé‚£ä¹ˆå°±ä¿å­˜å·¦è¡¨ä¸­çš„æ¯ä¸€åˆ—çš„å€¼ï¼Œå¹¶ä¸”åŠ ä¸Šå³è¡¨ä¸­æ¯ä¸€åˆ—çš„ null å€¼ã€‚</p><h2 id=task3---hashjoin-executor-and-optimization>Task3 - HashJoin Executor and Optimization<a hidden class=anchor aria-hidden=true href=#task3---hashjoin-executor-and-optimization>#</a></h2><p>ä¸ºä»€ä¹ˆéœ€è¦ hash join å‘¢ï¼Ÿå¦‚æœä¸¤å¼ è¦è¿›è¡Œ join çš„è¡¨éå¸¸å¤§ï¼Œè¿™æ—¶ä½¿ç”¨ NLJ çš„æ—¶é—´å¤æ‚åº¦å°±ä¸º <code>O(n*m)</code>ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬ä½¿ç”¨ hash joinï¼Œå…ˆå¯¹ä¸€å¼ è¡¨å»ºç«‹å“ˆå¸Œæ˜ å°„ï¼Œç„¶åå†å¯¹å¦ä¸€å¼ è¡¨è¿›è¡Œå“ˆå¸Œæ£€æµ‹æ¥åˆ¤æ–­æ˜¯å¦æ»¡è¶³è¿æ¥æ¡ä»¶ï¼Œè¿™æ ·å°±åªè¦å„æ‰«æä¸€æ¬¡ä¸¤å¼ è¡¨ï¼Œæ—¶é—´å¤æ‚åº¦å°±é™ä¸ºäº† <code>O(n+m)</code>ã€‚</p><h3 id=å°†-nl-join-ä¼˜åŒ–ä¸º-hash-join>å°† NL Join ä¼˜åŒ–ä¸º Hash Join<a hidden class=anchor aria-hidden=true href=#å°†-nl-join-ä¼˜åŒ–ä¸º-hash-join>#</a></h3><p>å®éªŒæŒ‡å¯¼ä¸­è¯´ï¼Œä¼˜åŒ–å™¨éœ€è¦å°† nl join ä¼˜åŒ–ä¸º hash join çš„æƒ…å†µä¸ºï¼šè¿æ¥æ¡ä»¶ä¸­æœ‰å¤šä¸ªç­‰å€¼ AND æ“ä½œï¼Œå³ <code>x = y AND a = b AND ...</code>ã€‚é‚£æˆ‘ä»¬åªè¦åœ¨ç¢°åˆ° <code>NestedLoopPlanNode</code> æ—¶è·å–å…¶è°“è¯ï¼Œåˆ¤æ–­ä¸€ä¸‹æ˜¯å¦æ»¡è¶³è¯¥æƒ…å†µå°±å¥½äº†ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“è°“è¯ä»…ä¸º <code>a = b</code> æ—¶ï¼Œè¿™ä¸ªè°“è¯æ˜¯ä¸€ä¸ª <code>ComparationExpression</code>ï¼›è€Œå½“å®ƒä¸º <code>x = y AND a = b AND ...</code> æ—¶ï¼Œå®ƒæ˜¯ä¸€ä¸ª <code>LogicExpression</code>ã€‚è¿™é‡Œåœ¨åˆ¤æ–­çš„æ˜¯å¦éœ€è¦åŒºåˆ†ï¼Œè€Œåœ¨ä¹‹å‰çš„å®éªŒä¸­ï¼Œæœ‰å­¦ä¹ åˆ°å¯ä»¥ä½¿ç”¨æ ‡å‡†åº“ä¸­çš„ <code>std::dynamic_pointer_cast</code> å‡½æ•°æ¥å°†è°“è¯ä» <code>ExpressionåŸºç±»</code> è½¬æ¢ä¸ºæŒ‡å®šçš„ <code>Expressionæ´¾ç”Ÿç±»</code>ï¼Œå½“è½¬æ¢å¤±è´¥æ—¶ï¼Œä¼šè¿”å›ç©ºæŒ‡é’ˆï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿”å›çš„æŒ‡é’ˆæ¥åˆ¤æ–­æ˜¯å¦æ˜¯æƒ³è¦çš„ Expressionï¼Œå¦‚æœä¸ºç©ºï¼Œå°±ä»£è¡¨æ˜¯å¦ä¸€ä¸ª Expressionã€‚</p><p>ç”±äºè°“è¯ä¸­å¾ˆæœ‰å¯èƒ½æ˜¯ <code>LogicExpression</code> åµŒå¥—ç€ <code>LogicExpression</code> å’Œ <code>ComparationExpression</code>ï¼Œæ•°é‡ä¹Ÿä¸ç¡®å®šï¼Œä¸”å­ <code>LogicExpression</code> å¾ˆå¯èƒ½è¿˜æœ‰åµŒå¥—ï¼Œè¿™æ ·çš„è¯ä½¿ç”¨<strong>é€’å½’</strong>æ¥å¤„ç†å°±éå¸¸æ–¹ä¾¿ã€‚</p><h3 id=å®ç°-hash-join>å®ç° Hash Join<a hidden class=anchor aria-hidden=true href=#å®ç°-hash-join>#</a></h3><p>hash join çš„æ ¸å¿ƒå°±æ˜¯ï¼šå…ˆå¯¹ä¸€å¼ è¡¨å»ºç«‹å“ˆå¸Œæ˜ å°„ï¼Œç„¶åå†å¯¹å¦ä¸€å¼ è¡¨è¿›è¡Œå“ˆå¸Œæ£€æµ‹æ¥åˆ¤æ–­æ˜¯å¦æ»¡è¶³è¿æ¥æ¡ä»¶ã€‚å“ˆå¸Œè¡¨ä¸­çš„ key ä¸ºè¿æ¥æ¡ä»¶ä¸­å¯¹åº”çš„å€¼çš„æ‹¼æ¥ï¼Œvalue ä¸ºæ•´ä¸ª tupleã€‚è€Œä¸€å¼ è¡¨ä¸­çš„æ‰€æœ‰ tupleï¼Œå¾ˆæœ‰å¯èƒ½ä¼šæœ‰å‡ ä¸ªåˆ—æ˜¯å®Œå…¨ç›¸åŒçš„ï¼Œå¦‚æœè¿™äº›åˆ—åˆšå¥½ä½œä¸ºè¿æ¥æ¡ä»¶ï¼Œé‚£è¿›è¡Œå“ˆå¸Œæ—¶å°±ä¼šé€ æˆ key ç›¸åŒçš„æƒ…å†µï¼Œè¿™å°±é€ æˆäº†<strong>å“ˆå¸Œç¢°æ’</strong>ã€‚</p><p>è§£å†³æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼š</p><ol><li>ä½¿ç”¨ <code>std::unordered_map</code>ï¼Œå°†æ‹¼æ¥çš„åˆ—å€¼ä½œä¸º keyï¼Œè€Œå€¼çš„ç±»å‹ä¸º <code>std::vector&lt;Tuple></code>;</li><li>ä½¿ç”¨ <code>std::unordered_multimap</code> æ¥å¤„ç†ã€‚</li></ol><p>å½“æˆ‘ä»¬æ„å»ºå¥½å“ˆå¸Œè¡¨åï¼Œæ¯æ¬¡è·å–äº†å¦ä¸€å¼ è¡¨ä¸­çš„ tuple åè¿›è¡Œä¸€æ¬¡å“ˆå¸Œæ£€æµ‹ï¼Œå¦‚æœ key å­˜åœ¨ï¼Œéœ€è¦å°†æ‰€æœ‰ value éƒ½è¿›è¡Œè¿æ¥æ‹¼æ¥ã€‚åŒ nested loop join ä¸€æ ·ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†è¿æ¥ç±»å‹ä¸º <code>left</code> çš„æƒ…å†µã€‚</p><h2 id=task4---sort--limit-executors--window-functions--top-n-optimization>Task4 - Sort + Limit Executors + Window Functions + Top-N Optimization<a hidden class=anchor aria-hidden=true href=#task4---sort--limit-executors--window-functions--top-n-optimization>#</a></h2><h3 id=sort>Sort<a hidden class=anchor aria-hidden=true href=#sort>#</a></h3><p>è¿™ä¸ªç®—å­çš„å®ç°æ€è·¯å¾ˆç®€å•ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„ä¸¤ç‚¹ï¼š</p><ol><li><code>order by</code> åé¢å¯ä»¥è·Ÿå¤šä¸ªå…³é”®å­—ï¼Œä¹Ÿå°±æ˜¯éœ€è¦åœ¨ <code>std::sort</code> ä¸­å¯¹<strong>å¤šä¸ªå…³é”®å­—è¿›è¡Œæ’åº</strong>ï¼ˆåˆ©ç”¨ for å¾ªç¯ï¼‰ã€‚</li><li>è¿™äº›å…³é”®å­—ä¸­å¯èƒ½è¿›è¡Œç®—æ•°è¿ç®—ï¼ˆç®—æ•°å¯¹è±¡ç±»å‹ä¸º <code>ArithmeticExpression</code>ï¼Œææ¸…æ¥šè¿›è¡Œè¿ç®—çš„å‡½æ•°å°±å¯ï¼‰ã€‚</li></ol><h3 id=limit>Limit<a hidden class=anchor aria-hidden=true href=#limit>#</a></h3><p>è¿™ä¸ªå°±æ›´ç®€å•äº†ï¼Œæ ¹æ® <code>limit</code> çš„è¿”å›å¯¹åº”æ•°é‡çš„ tupleã€‚</p><h3 id=topn>TopN<a hidden class=anchor aria-hidden=true href=#topn>#</a></h3><p>topn ç®—å­çš„ä¼˜åŒ–åªæœ‰ sort å’Œ limit åŒæ—¶å‡ºç°çš„æ˜¯å¦æ‰ä¼šè§¦å‘ï¼Œè¿™é‡Œçš„ä¼˜åŒ–é€»è¾‘æ¯”è¾ƒç®€å•ã€‚</p><p>è€Œå…·ä½“çš„ç®—å­çš„å®ç°å…¶å®å°±æ˜¯ä¸€ä¸ª<strong>ä¼˜å…ˆé˜Ÿåˆ—</strong>ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œç°åœ¨ tuple æŒ‰ç…§æŸä¸ªå…³é”®å­—å‡åºæ’åˆ—ï¼Œå¹¶ä¸” limit ä¸º 10ï¼Œé‚£ä¹ˆå°±å¯ä»¥æ„é€ ä¸€ä¸ªå°æ ¹å †ï¼Œå¹¶ç»´æŠ¤å…¶å¤§å°æœ€å¤šä¸º 10ï¼Œæœ€åç•™åœ¨å †ä¸­çš„å°±æ˜¯ç»“æœã€‚å¦‚æœåŠ›æ‰£åˆ·äº†ä¸€ç‚¹é¢˜çš„è¯å¾ˆå®¹æ˜“å°±èƒ½ç†è§£è¿™é‡Œã€‚</p><h3 id=window-function>Window Function<a hidden class=anchor aria-hidden=true href=#window-function>#</a></h3><p>è¯´æ¥æƒ­æ„§ï¼Œå­¦ SQL çš„æ—¶å€™å¹¶ä¸çŸ¥é“çª—å£å‡½æ•°è¿™ä¸ªä¸œè¥¿&mldr;ç®€å•æ¥ç†è§£ï¼Œå°±æ˜¯åœ¨ä½¿ç”¨èšåˆå‡½æ•°çš„åé¢åŠ ä¸Š <code>over ([å¯é€‰æ“ä½œ])</code> å³å¯å¯¹<strong>åŒºé—´</strong>è¿›è¡Œèšåˆæ“ä½œã€‚</p><p>å¯¹äºä¸‹é¢çš„ SQLï¼Œæœ€åè¾“å‡ºçš„ schema åº”è¯¥å’Œ <code>WindowFunc.columns</code> ç›¸åŒï¼Œ<strong>å¹¶ä¸”è¡Œæ•°ä¹Ÿå’Œå­ executor è¿”å›çš„è¡Œæ•°ç›¸åŒ</strong>ï¼ˆä¸‹æ–‡å°†å­ executor è¿”å›çš„ tuple ç§°ä¸º <code>child_tuples</code>ï¼‰ï¼Œåªæ˜¯å¤šäº†ä¸€äº›é¢å¤–çš„è®¡ç®—åˆ—ã€‚</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>bustub<span style=color:#555>&gt;</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>explain</span>(o)<span style=color:#bbb> </span><span style=color:#069;font-weight:700>select</span><span style=color:#bbb> </span>v1,<span style=color:#bbb>  </span><span style=color:#069;font-weight:700>min</span>(v1)<span style=color:#bbb> </span>over<span style=color:#bbb> </span>()<span style=color:#bbb> </span><span style=color:#069;font-weight:700>as</span><span style=color:#bbb> </span>min_v1,<span style=color:#bbb> </span><span style=color:#069;font-weight:700>max</span>(v1)<span style=color:#bbb> </span>over<span style=color:#bbb> </span>()<span style=color:#bbb> </span><span style=color:#069;font-weight:700>as</span><span style=color:#bbb> </span>max_v1,<span style=color:#bbb> </span><span style=color:#069;font-weight:700>count</span>(v1)<span style=color:#bbb> </span>over<span style=color:#bbb> </span>()<span style=color:#bbb> </span><span style=color:#069;font-weight:700>as</span><span style=color:#bbb> </span>count_v1,<span style=color:#bbb> </span><span style=color:#069;font-weight:700>sum</span>(v1)<span style=color:#bbb> </span>over<span style=color:#bbb> </span>()<span style=color:#bbb> </span><span style=color:#069;font-weight:700>as</span><span style=color:#bbb> </span>sum_v1<span style=color:#bbb> </span><span style=color:#069;font-weight:700>from</span><span style=color:#bbb> </span>t1;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#555>===</span><span style=color:#bbb> </span>OPTIMIZER<span style=color:#bbb> </span><span style=color:#555>===</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>WindowFunc<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>columns<span style=color:#555>=#</span><span style=color:#f60>0</span>.<span style=color:#f60>0</span>,<span style=color:#bbb> </span>placeholder,<span style=color:#bbb> </span>placeholder,<span style=color:#bbb> </span>placeholder,<span style=color:#bbb> </span>placeholder,<span style=color:#bbb> </span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>window_functions<span style=color:#555>=</span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#f60>1</span><span style=color:#555>=&gt;</span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span>function_arg<span style=color:#555>=#</span><span style=color:#f60>0</span>.<span style=color:#f60>0</span>,<span style=color:#bbb> </span><span style=color:#069;font-weight:700>type</span><span style=color:#555>=</span><span style=color:#069;font-weight:700>min</span>,<span style=color:#bbb> </span>partition_by<span style=color:#555>=</span>[],<span style=color:#bbb> </span>order_by<span style=color:#555>=</span>[]<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#f60>2</span><span style=color:#555>=&gt;</span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span>function_arg<span style=color:#555>=#</span><span style=color:#f60>0</span>.<span style=color:#f60>0</span>,<span style=color:#bbb> </span><span style=color:#069;font-weight:700>type</span><span style=color:#555>=</span><span style=color:#069;font-weight:700>max</span>,<span style=color:#bbb> </span>partition_by<span style=color:#555>=</span>[],<span style=color:#bbb> </span>order_by<span style=color:#555>=</span>[]<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#f60>3</span><span style=color:#555>=&gt;</span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span>function_arg<span style=color:#555>=#</span><span style=color:#f60>0</span>.<span style=color:#f60>0</span>,<span style=color:#bbb> </span><span style=color:#069;font-weight:700>type</span><span style=color:#555>=</span><span style=color:#069;font-weight:700>count</span>,<span style=color:#bbb> </span>partition_by<span style=color:#555>=</span>[],<span style=color:#bbb> </span>order_by<span style=color:#555>=</span>[]<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#f60>4</span><span style=color:#555>=&gt;</span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span>function_arg<span style=color:#555>=#</span><span style=color:#f60>0</span>.<span style=color:#f60>0</span>,<span style=color:#bbb> </span><span style=color:#069;font-weight:700>type</span><span style=color:#555>=</span><span style=color:#069;font-weight:700>sum</span>,<span style=color:#bbb> </span>partition_by<span style=color:#555>=</span>[],<span style=color:#bbb> </span>order_by<span style=color:#555>=</span>[]<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>SeqScan<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>{</span><span style=color:#bbb> </span><span style=color:#069;font-weight:700>table</span><span style=color:#555>=</span>t1<span style=color:#bbb> </span><span style=color:#a00;background-color:#faa>}</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>åœ¨è¿™æ¡ SQL ä¸­ï¼Œè¿”å›çš„ tuple çš„æ ¼å¼åº”è¯¥ä¸ºï¼š</p><table><thead><tr><th>è¿™æ¡ tuple çš„ v1 åˆ—çš„å€¼</th><th>æ‰€æœ‰ tuple ä¸­æœ€å°çš„ v1 çš„å€¼</th><th>æ‰€æœ‰ tuple ä¸­æœ€å¤§çš„ v1 çš„å€¼</th><th>æ‰€æœ‰ tuple ä¸­ v1 çš„ä¸ªæ•°</th><th>æ‰€æœ‰ tuple ä¸­ v1 çš„å€¼çš„å’Œ</th></tr></thead><tbody></tbody></table><p>è¿™å…¶å®å’Œ <code>WindowFunc.columns</code> æœ‰å¾ˆå¤§çš„å…³ç³»ï¼Œplaceholder è¯´æ˜è¿™åªæ˜¯ä¸ªå ä½ç¬¦ï¼Œå…¶åº”è¯¥ä¸º <code>window_functions[ä¸‹æ ‡]</code> å¯¹åº”çš„çª—å£å‡½æ•°ã€‚ä¾‹å¦‚ç¬¬äºŒä¸ª placeholder åœ¨ columns çš„ä¸‹è¡¨ä¸º 1ï¼Œå…¶å¯¹åº”çš„çª—å£å‡½æ•°å°±æ˜¯ <code>{ function_arg=#0.0, type=min, partition_by=[], order_by=[] }</code>ã€‚é‚£ä¹ˆå°±å¯ä»¥é€šè¿‡ column æ¥æ‰¾åˆ°æ¯ä¸ªçª—å£å¯¹åº”çš„å“ˆå¸Œè¡¨ã€‚</p><p>ï¸éœ€è¦æ³¨æ„çš„æ˜¯ï¼š</p><ul><li>å¦‚æœæŒ‰ç…§ <code>ORDER BY</code> è¿›è¡Œæ’åºåï¼Œæ¯ä¸€è¡Œçš„çª—å£èŒƒå›´ä»ç¬¬ä¸€è¡Œå¼€å§‹æ‰©å±•åˆ°å½“å‰è¡Œ</li><li>å¦åˆ™æ¯ä¸€è¡Œçš„çª—å£èŒƒå›´æ˜¯æ•´ä¸ª <code>child_tuples</code></li></ul><p>æ—¢ç„¶å¦‚æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å…ˆä» <code>child_executor</code> è·å–åˆ°æ‰€æœ‰çš„ <code>child_tuples</code>ï¼Œç„¶åå¯¹ <code>child_tuples</code> éå†ï¼šå¦‚æœæœ‰åˆ†ç»„è¡Œä¸ºï¼Œé‚£å°±éœ€è¦æŒ‰ç…§æŸä¸€åˆ—ï¼ˆæˆ–å¤šåˆ—ï¼‰è¿›è¡Œåˆ†ç»„ï¼Œç„¶åå¯¹äºæ¯ä¸€ä¸ª tupleï¼Œéƒ½è®©å…¶æ‰§è¡Œä¸€æ¬¡ <code>WindowFunc.window_functions</code> ä¸­çš„çª—å£å‡½æ•°ã€‚</p><blockquote><p>ç¨æœ‰ä¸åŒçš„æ˜¯ï¼Œä¹‹å‰çš„ aggregation æ“ä½œåˆ†ç»„åå¯èƒ½éœ€è¦å®Œæˆå¤šä¸ªèšåˆå‡½æ•°ï¼Œä½†æ˜¯è¿™é‡Œæˆ‘ä»¬åˆ†ç»„ä¹‹åï¼Œåªä¼šå®Œæˆä¸€ä¸ªèšåˆå‡½æ•°ï¼Œå› ä¸ºæ¯ä¸ªçª—å£ä¸­åªæœ‰ä¸€ä¸ªèšåˆå‡½æ•°ã€‚</p></blockquote><p>ç°åœ¨çœ‹æ¥ï¼Œè¿™ä¸ªçª—å£å‡½æ•°ä¹Ÿæ— éå°±æ˜¯å¯¹æŸä¸ªèŒƒå›´å†…çš„ tuple è¿›è¡Œåˆ†ç»„å’Œèšåˆæ“ä½œï¼Œå®éªŒæŒ‡å¯¼ä¸­ä¹Ÿæç¤ºæˆ‘ä»¬å¯ä»¥å»åˆ©ç”¨ task2 ä¸­å†™çš„ä»£ç ã€‚åœ¨æˆ‘çš„å®ç°æ–¹æ¡ˆä¸­ï¼Œå¹¶ä¸åƒ task2 ä¸­åªä½¿ç”¨ä¸€ä¸ªå“ˆå¸Œè¡¨ï¼Œå› ä¸ºåœ¨ä¸€æ¡ SQL å‡½æ•°ä¸­ï¼Œå¯èƒ½æœ‰å¤šä¸ªçª—å£å‡½æ•°ï¼Œæ¯ä¸€ä¸ªçª—å£å‡½æ•°åˆå¯èƒ½åˆä¸åŒçš„åˆ†ç»„å’Œä¸åŒçš„èšåˆæ“ä½œï¼Œå› æ­¤æˆ‘å¯¹äºæ¯ä¸€ä¸ªçª—å£å‡½æ•°éƒ½è®¾ç½®äº†ä¸€ä¸ªå“ˆå¸Œè¡¨ã€‚</p><p>è¯¥ task ä¸­ bustub å¾ˆä»æ…ˆåœ°ç®€åŒ–äº†éš¾åº¦ï¼š<u>å¦‚æœçª—å£å‡½æ•°ä»»æ„ä¸€ä¸ªä¸­æœ‰ order byï¼Œé‚£ä¹ˆæ‰€æœ‰çª—å£å‡½æ•°çš„ order by éƒ½ç›¸åŒ</u>ã€‚ä¸è¿‡åœ¨æœ‰æ’åºå’Œæ²¡æœ‰æ’åºçš„æƒ…å†µä¸‹ï¼Œçª—å£çš„èŒƒå›´æœ‰æ‰€ä¸åŒï¼Œå¤„ç†èµ·æ¥çš„æ–¹æ³•ä¹Ÿä¸åŒã€‚</p><h4 id=æ— æ’åºçš„æƒ…å†µ>æ— æ’åºçš„æƒ…å†µ<a hidden class=anchor aria-hidden=true href=#æ— æ’åºçš„æƒ…å†µ>#</a></h4><p>è¿™ä¸ªæƒ…å†µä¸‹ï¼Œæ¯ä¸ªçª—å£å‡½æ•°çš„èŒƒå›´å°±æ˜¯æ•´ä¸ª <code>child_tuples</code>ã€‚ä¹‹åå†æ¬¡éå†æ¯ä¸€æ¡ tupleï¼ŒæŒ‰ç…§è¾“å‡ºçš„ schema æ¥æ„å»ºè¿”å›çš„ tupleã€‚é‚£ä¹ˆå®ç°æ“ä½œåº”è¯¥å¦‚ä¸‹ï¼š</p><p><strong>å…ˆææ‰€æœ‰ tupleï¼Œç”Ÿæˆè¿™æ¡ tuple å¯¹åº”çš„ key å’Œ valueï¼Œå†æŠŠ key å’Œ value åŠ å…¥å¯¹åº”çš„å“ˆå¸Œè¡¨ã€‚</strong></p><p>ç„¶åå¯¹äºæ¯ä¸€æ¡ tupleï¼Œéå† <code>WindowFunc.columns</code>ï¼š</p><ol><li>å¦‚æœ column ä¸æ˜¯ placeholderï¼Œé‚£ä¹ˆè¯´æ˜è¿™ä¸ªä½ç½®æ˜¯è¿™ä¸ª tuple ä¸­çš„ä¸€åˆ—ï¼Œè·å–è¿™ä¸€åˆ—å¯¹åº”çš„ Value å°±å¥½ã€‚</li><li>å¦‚æœ column æ˜¯ placeholderï¼Œé‚£ä¹ˆè¯´æ˜è¿™ä¸ªä½ç½®çš„å€¼åº”è¯¥æ˜¯å¯¹åº”çš„çª—å£å‡½æ•°çš„æ‰§è¡Œç»“æœï¼Œé‚£ä¹ˆä» column å¯¹åº”çš„å“ˆå¸Œè¡¨ä¸­æ‰¾å‡ºè¿™ä¸ª tuple å¯¹åº”çš„å€¼å°± okã€‚</li></ol><h4 id=æœ‰æ’åºçš„æƒ…å†µ>æœ‰æ’åºçš„æƒ…å†µ<a hidden class=anchor aria-hidden=true href=#æœ‰æ’åºçš„æƒ…å†µ>#</a></h4><p>åœ¨è¿™ä¸ªæƒ…å†µä¸‹ï¼Œæ’åºå·åæ¯æ¡ tuple çš„èŒƒå›´æ˜¯è‡ªèº«åŠä¹‹å‰çš„æ‰€æœ‰ tupleï¼Œè€Œä¸æ˜¯åƒä¹‹å‰ä¸€æ ·çš„æ‰€æœ‰ tupleã€‚è¿™å°±æœ‰ç‚¹åƒä¸€å¥è¯ï¼š<strong>â€œèµ°ä¸€æ­¥çœ‹ä¸€æ­¥â€</strong>ã€‚</p><p>è¿˜æ˜¯éå†æ¯ä¸€æ¡ tupleï¼Œå¯¹æ¯ä¸€æ¡ tuple åˆéå† <code>WindowFunc.columns</code>ï¼š</p><ol><li>å¦‚æœ column ä¸æ˜¯ placeholderï¼Œé‚£ä¹ˆè¯´æ˜è¿™ä¸ªä½ç½®æ˜¯è¿™ä¸ª tuple ä¸­çš„ä¸€åˆ—ï¼Œè·å–è¿™ä¸€åˆ—å¯¹åº”çš„ Value å°±å¥½ã€‚è¿™é‡Œå’Œæ— æ’åºçš„æƒ…å†µä¸€è‡´ã€‚</li><li>å¦‚æœ column æ˜¯ placeholderï¼Œ<ol><li>ç”Ÿæˆè¿™æ¡ tuple å¯¹åº”çš„ key</li><li>ç”Ÿæˆè¿™æ¡ tuple å¯¹åº”çš„ valueï¼Œå¹¶å°† <code>{key, value}</code> æ’å…¥ column å¯¹åº”çš„å“ˆå¸Œè¡¨ï¼ˆåœ¨ task2 ä¸­å¯çŸ¥ï¼Œè¿™é‡Œçš„â€œæ’å…¥â€å…¶å®æ˜¯å¯¹ key å¤„çš„æ—§å€¼ old_value ä¸æ–°å€¼ value è¿›è¡Œèšåˆæ“ä½œï¼‰</li><li>ä»å“ˆå¸Œè¡¨ä¸­å–å‡º key å¯¹åº”çš„ value</li></ol></li></ol><p>è¿™é‡Œçš„ 2.2 å’Œ 2.3 å°±æ˜¯ä¹‹å‰æ‰€è¯´çš„â€œèµ°ä¸€æ­¥çœ‹ä¸€æ­¥â€ï¼š<strong>å½“å‰ tuple çš„ç»“æœæ˜¯åœ¨ä¹‹å‰çš„ tuple ä¸Šèšåˆè€Œæ¥çš„</strong>ã€‚</p><h2 id=æ€»ç»“>æ€»ç»“<a hidden class=anchor aria-hidden=true href=#æ€»ç»“>#</a></h2><p>è¿™ä¸ª Project éœ€è¦æˆ‘ä»¬å»æ·±å…¥ç†è§£ bustub çš„æºç ï¼ŒçŸ¥é“ä¸€æ¡ SQL ä¼šè¢«è§£ææˆä¸€æ£µä»€ä¹ˆæ ·çš„ plan æ ‘ï¼Œåœ¨ç»è¿‡åŸºäºè§„åˆ™çš„ä¼˜åŒ–å™¨ä¼˜åŒ–åæ‰ä¼šæ˜¯æœ€ç»ˆçš„ç‰©ç† plan æ ‘ï¼Œè¿™æ—¶åˆè¦å»ç†è§£è¿™æ£µæ ‘ä¸Šæ¯ä¸ªèŠ‚ç‚¹å¯¹åº”çš„ç®—å­åº”è¯¥æ˜¯æ€ä¹ˆå®ç°çš„ã€‚å…¶å®çŸ¥é“äº† plan æ ‘æ˜¯ä»€ä¹ˆæ ·å­åï¼ŒèŠ‚ç‚¹å¯¹åº”çš„ç®—å­å°±æŒ‰ç…§è¦æ±‚å»è®¾è®¡å°±å¥½äº†ã€‚</p><p>åœ¨ä¼—å¤š AI ä¾‹å¦‚ ChatGPTã€DeepSeekã€Kimi ç­‰å¸®åŠ©ä¸‹ï¼Œè¿˜æ˜¯æ…¢æ…¢ç†è§£å¹¶å®Œæˆäº†è¿™ä¸ª Projectï¼ä½†æ˜¯æœ‰çš„åœ°æ–¹æˆ‘å¯èƒ½è¿˜æ²¡æœ‰åšçš„æ¯”è¾ƒå¥½ï¼Œä»¥åæœ‰æ—¶é—´å†ä¼˜åŒ–ä¸€ä¸‹ã€‚</p><p><div class=post-img-view><a data-fancybox=gallery href=https://obsidian-image-oss.oss-cn-shanghai.aliyuncs.com/Pasted%20image%2020250311201509.png><img src=https://obsidian-image-oss.oss-cn-shanghai.aliyuncs.com/Pasted%20image%2020250311201509.png alt></a></div></p></div><footer class=post-footer><nav class=paginav><a class=prev href=https://kerolt.github.io/posts/c++/c++%E4%BD%95%E6%97%B6%E4%BC%9A%E9%98%BB%E6%AD%A2%E9%BB%98%E8%AE%A4%E7%9A%84%E7%89%B9%E6%AE%8A%E6%88%90%E5%91%98%E5%87%BD%E6%95%B0%E7%9A%84%E7%94%9F%E6%88%90/><span class=title>Â« Prev</span><br><span>C++ä½•æ—¶ä¼šé˜»æ­¢é»˜è®¤çš„ç‰¹æ®Šæˆå‘˜å‡½æ•°çš„ç”Ÿæˆ</span>
</a><a class=next href=https://kerolt.github.io/posts/%E5%AD%A6%E4%B9%A0%E9%9A%8F%E7%AC%94/%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3/linux%E4%B8%8B%E5%BE%AE%E4%BF%A1%E6%97%A0%E6%B3%95%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E8%BE%93%E5%85%A5%E6%B3%95%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3/><span class=title>Next Â»</span><br><span>Linuxä¸‹å¾®ä¿¡æ— æ³•ä½¿ç”¨ä¸­æ–‡è¾“å…¥æ³•é—®é¢˜è§£å†³</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://kerolt.github.io/>Kerolt's Blog</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>