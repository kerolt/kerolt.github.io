<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>ã€MIT6.S081ã€‘Lab8 lock | Kerolt's Blog</title><meta name=keywords content="OS,MIT6-S081,xv6"><meta name=description content="Intro
è¿™ä¸ªå®éªŒä¸ªäººæ„Ÿè§‰æŒºéš¾çš„ï¼Œéœ€è¦æˆ‘ä»¬é‡æ–°è®¾è®¡æ•°æ®ç»“æ„ï¼Œè¿˜è¦è€ƒè™‘åœ¨å¹¶å‘ï¼ˆå¹¶è¡Œï¼‰æƒ…å†µä¸‹å¯¹äºé”çš„æ“ä½œï¼Œä»¥å‡å°‘å¤šæ ¸æƒ…å†µä¸‹å¯¹äºé”çš„ç«äº‰ã€‚å…¶ä¸­ä¸»è¦æ¶‰åŠå†…å­˜åˆ†é…å’ŒIOç¼“å†²å—åˆ†é…ï¼Œåœ¨è¿™ä¸ªlabä¹‹å‰ï¼Œxv6å¯¹äºè¿™ä¸¤ä¸ªåˆ†é…éƒ½æ˜¯ä½¿ç”¨çš„å…¨å±€å¯¹è±¡ï¼Œå¹¶åªæœ‰ä¸€æŠŠå…¨å±€é”è¿›è¡Œæ“ä½œï¼Œè¿™æ ·çš„è¯åœ¨å¹¶è¡Œæƒ…å†µä¸‹é”çš„ç«äº‰æ˜¯å¾ˆæ¿€çƒˆçš„ï¼Œæˆ‘ä»¬çš„ä»»åŠ¡å°±æ˜¯é‡æ–°è®¾è®¡è¿™ä¸¤ä¸ªåˆ†é…å™¨ï¼Œå®ƒä»¬çš„é‡æ„æ€è·¯å¹¶ä¸å®Œå…¨ä¸€è‡´ï¼Œéœ€è¦å…·ä½“é—®é¢˜å…·ä½“åˆ†æã€‚"><meta name=author content="Kerolt"><link rel=canonical href=https://kerolt.github.io/posts/%E5%8A%A8%E6%89%8B%E5%AE%9E%E7%8E%B0x/mit6.s081/mit6.s081lab8-lock/><meta name=google-site-verification content="NpIO0KEIJS0CPRzTzQCbYQdSRIyb0Lspx"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="2300A23B82DB579A2DEA6261191AD771"><link crossorigin=anonymous href=/assets/css/stylesheet.e6faa598b3a7420a559415a0a672c9fd91658a7351011c4c3bf20e9f34ba4aa9.css integrity="sha256-5vqlmLOnQgpVlBWgpnLJ/ZFlinNRARxMO/IOnzS6Sqk=" rel="preload stylesheet" as=style><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-screen-web/style.css><link rel=icon href=https://kerolt.github.io/images/avatar/favicon.png><link rel=icon type=image/png sizes=16x16 href=https://kerolt.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://kerolt.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://kerolt.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://kerolt.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://kerolt.github.io/posts/%E5%8A%A8%E6%89%8B%E5%AE%9E%E7%8E%B0x/mit6.s081/mit6.s081lab8-lock/><script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css><script src=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js></script><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://kerolt.github.io/posts/%E5%8A%A8%E6%89%8B%E5%AE%9E%E7%8E%B0x/mit6.s081/mit6.s081lab8-lock/"><meta property="og:site_name" content="Kerolt's Blog"><meta property="og:title" content="ã€MIT6.S081ã€‘Lab8 lock"><meta property="og:description" content="Intro è¿™ä¸ªå®éªŒä¸ªäººæ„Ÿè§‰æŒºéš¾çš„ï¼Œéœ€è¦æˆ‘ä»¬é‡æ–°è®¾è®¡æ•°æ®ç»“æ„ï¼Œè¿˜è¦è€ƒè™‘åœ¨å¹¶å‘ï¼ˆå¹¶è¡Œï¼‰æƒ…å†µä¸‹å¯¹äºé”çš„æ“ä½œï¼Œä»¥å‡å°‘å¤šæ ¸æƒ…å†µä¸‹å¯¹äºé”çš„ç«äº‰ã€‚å…¶ä¸­ä¸»è¦æ¶‰åŠå†…å­˜åˆ†é…å’ŒIOç¼“å†²å—åˆ†é…ï¼Œåœ¨è¿™ä¸ªlabä¹‹å‰ï¼Œxv6å¯¹äºè¿™ä¸¤ä¸ªåˆ†é…éƒ½æ˜¯ä½¿ç”¨çš„å…¨å±€å¯¹è±¡ï¼Œå¹¶åªæœ‰ä¸€æŠŠå…¨å±€é”è¿›è¡Œæ“ä½œï¼Œè¿™æ ·çš„è¯åœ¨å¹¶è¡Œæƒ…å†µä¸‹é”çš„ç«äº‰æ˜¯å¾ˆæ¿€çƒˆçš„ï¼Œæˆ‘ä»¬çš„ä»»åŠ¡å°±æ˜¯é‡æ–°è®¾è®¡è¿™ä¸¤ä¸ªåˆ†é…å™¨ï¼Œå®ƒä»¬çš„é‡æ„æ€è·¯å¹¶ä¸å®Œå…¨ä¸€è‡´ï¼Œéœ€è¦å…·ä½“é—®é¢˜å…·ä½“åˆ†æã€‚"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-11-17T00:00:00+00:00"><meta property="article:modified_time" content="2024-11-17T00:00:00+00:00"><meta property="article:tag" content="OS"><meta property="article:tag" content="MIT6-S081"><meta property="article:tag" content="Xv6"><meta property="og:image" content="https://kerolt.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://kerolt.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="ã€MIT6.S081ã€‘Lab8 lock"><meta name=twitter:description content="Intro
è¿™ä¸ªå®éªŒä¸ªäººæ„Ÿè§‰æŒºéš¾çš„ï¼Œéœ€è¦æˆ‘ä»¬é‡æ–°è®¾è®¡æ•°æ®ç»“æ„ï¼Œè¿˜è¦è€ƒè™‘åœ¨å¹¶å‘ï¼ˆå¹¶è¡Œï¼‰æƒ…å†µä¸‹å¯¹äºé”çš„æ“ä½œï¼Œä»¥å‡å°‘å¤šæ ¸æƒ…å†µä¸‹å¯¹äºé”çš„ç«äº‰ã€‚å…¶ä¸­ä¸»è¦æ¶‰åŠå†…å­˜åˆ†é…å’ŒIOç¼“å†²å—åˆ†é…ï¼Œåœ¨è¿™ä¸ªlabä¹‹å‰ï¼Œxv6å¯¹äºè¿™ä¸¤ä¸ªåˆ†é…éƒ½æ˜¯ä½¿ç”¨çš„å…¨å±€å¯¹è±¡ï¼Œå¹¶åªæœ‰ä¸€æŠŠå…¨å±€é”è¿›è¡Œæ“ä½œï¼Œè¿™æ ·çš„è¯åœ¨å¹¶è¡Œæƒ…å†µä¸‹é”çš„ç«äº‰æ˜¯å¾ˆæ¿€çƒˆçš„ï¼Œæˆ‘ä»¬çš„ä»»åŠ¡å°±æ˜¯é‡æ–°è®¾è®¡è¿™ä¸¤ä¸ªåˆ†é…å™¨ï¼Œå®ƒä»¬çš„é‡æ„æ€è·¯å¹¶ä¸å®Œå…¨ä¸€è‡´ï¼Œéœ€è¦å…·ä½“é—®é¢˜å…·ä½“åˆ†æã€‚"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://kerolt.github.io/posts/"},{"@type":"ListItem","position":2,"name":"ã€MIT6.S081ã€‘Lab8 lock","item":"https://kerolt.github.io/posts/%E5%8A%A8%E6%89%8B%E5%AE%9E%E7%8E%B0x/mit6.s081/mit6.s081lab8-lock/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"ã€MIT6.S081ã€‘Lab8 lock","name":"ã€MIT6.S081ã€‘Lab8 lock","description":"Intro è¿™ä¸ªå®éªŒä¸ªäººæ„Ÿè§‰æŒºéš¾çš„ï¼Œéœ€è¦æˆ‘ä»¬é‡æ–°è®¾è®¡æ•°æ®ç»“æ„ï¼Œè¿˜è¦è€ƒè™‘åœ¨å¹¶å‘ï¼ˆå¹¶è¡Œï¼‰æƒ…å†µä¸‹å¯¹äºé”çš„æ“ä½œï¼Œä»¥å‡å°‘å¤šæ ¸æƒ…å†µä¸‹å¯¹äºé”çš„ç«äº‰ã€‚å…¶ä¸­ä¸»è¦æ¶‰åŠå†…å­˜åˆ†é…å’ŒIOç¼“å†²å—åˆ†é…ï¼Œåœ¨è¿™ä¸ªlabä¹‹å‰ï¼Œxv6å¯¹äºè¿™ä¸¤ä¸ªåˆ†é…éƒ½æ˜¯ä½¿ç”¨çš„å…¨å±€å¯¹è±¡ï¼Œå¹¶åªæœ‰ä¸€æŠŠå…¨å±€é”è¿›è¡Œæ“ä½œï¼Œè¿™æ ·çš„è¯åœ¨å¹¶è¡Œæƒ…å†µä¸‹é”çš„ç«äº‰æ˜¯å¾ˆæ¿€çƒˆçš„ï¼Œæˆ‘ä»¬çš„ä»»åŠ¡å°±æ˜¯é‡æ–°è®¾è®¡è¿™ä¸¤ä¸ªåˆ†é…å™¨ï¼Œå®ƒä»¬çš„é‡æ„æ€è·¯å¹¶ä¸å®Œå…¨ä¸€è‡´ï¼Œéœ€è¦å…·ä½“é—®é¢˜å…·ä½“åˆ†æã€‚\n","keywords":["OS","MIT6-S081","xv6"],"articleBody":"Intro è¿™ä¸ªå®éªŒä¸ªäººæ„Ÿè§‰æŒºéš¾çš„ï¼Œéœ€è¦æˆ‘ä»¬é‡æ–°è®¾è®¡æ•°æ®ç»“æ„ï¼Œè¿˜è¦è€ƒè™‘åœ¨å¹¶å‘ï¼ˆå¹¶è¡Œï¼‰æƒ…å†µä¸‹å¯¹äºé”çš„æ“ä½œï¼Œä»¥å‡å°‘å¤šæ ¸æƒ…å†µä¸‹å¯¹äºé”çš„ç«äº‰ã€‚å…¶ä¸­ä¸»è¦æ¶‰åŠå†…å­˜åˆ†é…å’ŒIOç¼“å†²å—åˆ†é…ï¼Œåœ¨è¿™ä¸ªlabä¹‹å‰ï¼Œxv6å¯¹äºè¿™ä¸¤ä¸ªåˆ†é…éƒ½æ˜¯ä½¿ç”¨çš„å…¨å±€å¯¹è±¡ï¼Œå¹¶åªæœ‰ä¸€æŠŠå…¨å±€é”è¿›è¡Œæ“ä½œï¼Œè¿™æ ·çš„è¯åœ¨å¹¶è¡Œæƒ…å†µä¸‹é”çš„ç«äº‰æ˜¯å¾ˆæ¿€çƒˆçš„ï¼Œæˆ‘ä»¬çš„ä»»åŠ¡å°±æ˜¯é‡æ–°è®¾è®¡è¿™ä¸¤ä¸ªåˆ†é…å™¨ï¼Œå®ƒä»¬çš„é‡æ„æ€è·¯å¹¶ä¸å®Œå…¨ä¸€è‡´ï¼Œéœ€è¦å…·ä½“é—®é¢˜å…·ä½“åˆ†æã€‚\nMemory Allocator åœ¨xv6ä¸­ï¼Œå†…å­˜é€šè¿‡kalloc()æ¥åˆ†é…ï¼Œåœ¨å…¶å†…éƒ¨ï¼Œä¼šä½¿ç”¨ä¸€ä¸ªkmemçš„ç»“æ„ä½“å˜é‡ï¼š\n// kernel/kalloc.c struct run { struct run *next; }; struct { struct spinlock lock; struct run *freelist; } kmem; kmem.freelistä¿å­˜ç€æœªä½¿ç”¨çš„å†…å­˜å—ï¼ˆæ¯å—å¤§å°ä¸º4KBï¼‰ï¼Œåœ¨å†…æ ¸åˆå§‹åŒ–æ—¶ï¼Œä¼šé€šè¿‡kinit()å°†åœ°å€KERNBASE ~ PHYSTOPçš„ç‰©ç†å†…å­˜ï¼ˆä¸€å…±128MBï¼‰æ”¾å…¥freelistä¸­ï¼š\nvoid kinit() { initlock(\u0026kmem.lock, \"kmem\"); freerange(end, (void*)PHYSTOP); // endä¸ºkernel.ldä¸­å®šä¹‰çš„ï¼Œå€¼ä¸º0x80000000ï¼Œå³KERNBASE } void freerange(void *pa_start, void *pa_end) { char *p; p = (char*)PGROUNDUP((uint64)pa_start); for(; p + PGSIZE \u003c= (char*)pa_end; p += PGSIZE) kfree(p); // ä½¿ç”¨kfreeå°†å†…å­˜å—æ”¾å…¥freelistä¸­ } é€šè¿‡ä¸Šé¢çš„æºç åˆ†ææˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ•´ä¸ªxv6å†…æ ¸éƒ½æ˜¯é€šè¿‡ä¸€ä¸ªå…¨å±€çš„kmemæ¥åˆ†é…å’Œå›æ”¶å†…å­˜å—ï¼Œé‚£ä¹ˆå¦‚æœå½“å¤šä¸ªCPUï¼ˆå¤šä¸ªcoreï¼‰éœ€è¦æ“ä½œå†…å­˜å—æ—¶ï¼Œå°±å¿…é¡»å¾—ç”¨é”æ‰èƒ½ä¿è¯æ•´ä½“çš„ç¨³å®šå’Œæ­£ç¡®ã€‚\nä½†æ˜¯è¿™æ ·åšåˆä¼šæœ‰ä¸€ä¸ªå¤§é—®é¢˜ï¼Œé‚£å°±æ˜¯ä¸€ä¸ªcpuåœ¨æ“ä½œkmemæ—¶ï¼Œå¦ä¸€ä¸ªCPUå³ä¾¿æƒ³è·å–å†…å­˜å—æˆ–é‡Šæ”¾å†…å­˜å—ï¼Œå› ä¸ºé”çš„ç¼˜æ•…ä¹Ÿåªèƒ½ç­‰å¾…ã€‚æ•…æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆæ˜¯ä¸ºæ¯ä¸ªCPUéƒ½è®¾ç½®ä¸€ä¸ªkmemï¼Œè¿™æ ·ï¼Œå“ªä¸ªCPUéœ€è¦æ“ä½œå†…å­˜å—æ—¶å°±å¯ä»¥åªé”ä¸Šå®ƒè‡ªå·±çš„kmemï¼Œå…¶ä»–CPUå—åˆ°çš„å¹²æ‰°ä¼šå¤§å¤§å‡å°‘ã€‚\nä¸ºä»€ä¹ˆè¯´æ˜¯å¤§å¤§å‡å°‘è€Œä¸æ˜¯å®Œå…¨å‡å°‘å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºå½“æŸä¸ªCPUçš„kmem.freelistä¸­æ²¡æœ‰å¯åˆ†é…çš„å†…å­˜å—æ—¶ï¼Œéœ€è¦å»å…¶ä»–CPUçš„kmem.freelistä¸­å»æ‹¿ä¸€ä¸ªè¿‡æ¥ï¼Œè¿™æ—¶å°±éœ€è¦å¤„ç†å¥½è¿™ä¸¤ä¸ªCPUçš„é”çš„å¤„ç†äº†ã€‚\nstruct { struct spinlock lock; struct run *freelist; char lock_name[8]; // æ¯ä¸ªkmemçš„é”çš„åç§° } kmem[NCPU]; // ä¸ºæ¯ä¸ªCPUéƒ½è®¾ç½®ä¸€ä¸ªkmem void kinit() { // åˆå§‹åŒ–æ—¶è¦å¯¹æ¯ä¸ªkmeméƒ½åˆå§‹é” for (int i = 0; i \u003c NCPU; i++) { initlock(\u0026kmem[i].lock, \"kmem\"); snprintf(kmem[i].lock_name, sizeof(kmem[i].lock_name), \"kmem%d\", i); } // è¿™é‡Œä¼šå…ˆå°†æ‰€æœ‰å†…å­˜å—éƒ½åˆ†é…ç»™kmem[0]ï¼Œå› ä¸ºå†…æ ¸å¯åŠ¨æ—¶æ˜¯cpus[0]åœ¨åšåˆå§‹åŒ–æ“ä½œ // ä¹‹åå…¶ä»–CPUéœ€è¦å†…å­˜å—æ—¶ï¼Œä»cpus[0]è¿™é‡Œæ‹¿ freerange(end, (void*)PHYSTOP); } void kfree(void *pa) { struct run *r; if(((uint64)pa % PGSIZE) != 0 || (char*)pa \u003c end || (uint64)pa \u003e= PHYSTOP) panic(\"kfree\"); // Fill with junk to catch dangling refs. memset(pa, 1, PGSIZE); r = (struct run*)pa; // ---------------------------------------- // kfreeæ—¶åªéœ€è¦å°†å†…å­˜å—æ”¾åˆ°è‡ªå·±æ‰€å±cpuçš„kmem.freelistä¸­ push_off(); int cid = cpuid(); acquire(\u0026kmem[cid].lock); r-\u003enext = kmem[cid].freelist; kmem[cid].freelist = r; release(\u0026kmem[cid].lock); pop_off(); // ---------------------------------------- } void * kalloc(void) { struct run *r; // ---------------------------------------- push_off(); int cid = cpuid(); acquire(\u0026kmem[cid].lock); r = kmem[cid].freelist; if (r) { // å¦‚æœå½“å‰çš„freelistä¸­è¿˜æœ‰å†…å­˜å—ï¼Œåˆ™ç›´æ¥ç”¨ kmem[cid].freelist = r-\u003enext; } else { // æ²¡æœ‰ï¼Ÿé‚£å°±æ‹¿ï¼ // éå†ä¸€ä¸‹å…¶ä»–CPUçš„kmemï¼Œå¦‚æœæ‰¾åˆ°çš„freelistä¸­è¿˜æœ‰å†…å­˜å—ï¼Œå°±æ‹¿å®ƒçš„ for (int next_cid = 0; next_cid \u003c NCPU; next_cid++) { // ä¸æ‰¾è‡ªå·± if (next_cid == cid) continue; acquire(\u0026kmem[next_cid].lock); r = kmem[next_cid].freelist; if (r) { kmem[next_cid].freelist = r-\u003enext; release(\u0026kmem[next_cid].lock); break; } release(\u0026kmem[next_cid].lock); } } release(\u0026kmem[cid].lock); pop_off(); // ---------------------------------------- if(r) memset((char*)r, 5, PGSIZE); // fill with junk return (void*)r; } Buffer Cache å…ˆä»‹ç»ä¸‹å®éªŒåˆå§‹çš„bcacheï¼š\nstruct { struct spinlock lock; struct buf buf[NBUF]; // Linked list of all buffers, through prev/next. // Sorted by how recently the buffer was used. // head.next is most recent, head.prev is least. struct buf head; } bcache; struct spinlock lockï¼šbcacheçš„å…¨å±€é” struct buf buf[NBUF]ï¼šç¼“å†²å—æ± ï¼Œå³åŒ…å«äº†æ‰€æœ‰çš„buffer cache struct buf headï¼šä¸€ä¸ªLRUé“¾è¡¨ï¼Œç”¨äºæ“ä½œç¼“å†²å—ï¼Œä½¿ç”¨head.nextè·å–çš„æ˜¯æœ€è¿‘åˆšä½¿ç”¨è¿‡çš„bufferï¼Œhead.prevè·å–çš„æ˜¯æœ€è¿‘æœªä½¿ç”¨æ—¶é—´æœ€ä¹…çš„bufferï¼ˆæˆ–è€…è¯´æ˜¯æœªè¢«ä½¿ç”¨çš„bufferï¼Œå³å¼•ç”¨è®¡æ•°ä¸º0ï¼‰ åŸæ¥çš„bcacheä¸­çš„bufæ•°ç»„åœ¨binitæ—¶å°±ç»™LRUé“¾è¡¨åˆå§‹åŒ–ç”¨äº†ï¼š\nvoid binit(void) { struct buf *b; initlock(\u0026bcache.lock, \"bcache\"); // Create linked list of buffers bcache.head.prev = \u0026bcache.head; bcache.head.next = \u0026bcache.head; for(b = bcache.buf; b \u003c bcache.buf+NBUF; b++){ b-\u003enext = bcache.head.next; b-\u003eprev = \u0026bcache.head; initsleeplock(\u0026b-\u003elock, \"buffer\"); bcache.head.next-\u003eprev = b; bcache.head.next = b; } } è€Œè¿™æ ·è®¾è®¡çš„buffer cacheæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œç”±äºbuffer cacheåªæœ‰ä¸€ä¸ªå…¨å±€é”ï¼Œå½“åœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œè¿›ç¨‹éœ€è¦å¹¶å‘è®¿é—®bcacheæ—¶ï¼Œæ— æ³•è¾¾åˆ°å¤šè¿›ç¨‹å¸¦æ¥çš„ä¼˜åŠ¿ï¼Œä¸€ä¸ªè¿›ç¨‹å¿…é¡»è¦å…ˆç­‰å‰ä¸€ä¸ªè¿›ç¨‹é‡Šæ”¾é”åæ‰å¯ä»¥æ“ä½œã€‚\nè€ƒè™‘å‰ä¸€ä¸ªå®éªŒä¸­çš„kallocï¼Œæˆ‘ä»¬èƒ½å¦ä¹Ÿä½¿ç”¨é‚£æ ·çš„ç­–ç•¥ï¼Ÿ\nReducing contention in the block cache is more tricky than for kalloc, because bcache buffers are truly shared among processes (and thus CPUs). For kalloc, one could eliminate most contention by giving each CPU its own allocator; that wonâ€™t work for the block cache.\nä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Ÿæ˜¯å› ä¸ºblock cacheå¹¶ä¸åƒå†…å­˜é¡µé‚£æ ·å…·æœ‰é€šç”¨æ€§ã€‚block cacheå¯¹åº”ç€çœŸå®çš„ç‰©ç†å¤–å­˜å—ï¼Œæ¯ä¸€ä¸ªCPUéƒ½å¯èƒ½ä½¿ç”¨åŒä¸€ä¸ªblock cacheï¼Œæ‰€ä»¥æ— æ³•åƒkallocä¸­é‚£æ ·ä¸ºæ¯ä¸ªCPUåˆ†é…å…¶å¯¹åº”çš„cacheã€‚\næ—¢ç„¶æˆ‘ä»¬æ— æ³•åˆ†åˆ«ä¸ºæ¯ä¸ªCPUåˆ†é…ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æ¢ä¸€ä¸ªè§’åº¦ï¼Œå¯¹æ‰€æœ‰çš„blockå—è¿›è¡Œåˆ†ç»„ï¼šæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªå“ˆå¸Œæ¡¶hash bucketsï¼ˆè¿™é‡Œä½¿ç”¨çš„å®¹é‡ä¸º13ï¼‰ï¼Œé‚£ä¹ˆå¯¹æ¯ä¸ªblockå—çš„å—å·è¿›è¡Œå–ä½™æ“ä½œï¼ˆmod 13ï¼‰å³å¯å°†å®ƒä»¬æ˜ å°„åˆ°å…¶ä¸­ä¸€ä¸ªå“ˆå¸Œæ¡¶ä¸­ã€‚è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨æ ‡å·ä¸ºblocknoçš„å—æ—¶ï¼Œåˆ°å…¶æ˜ å°„çš„å“ˆå¸Œæ¡¶ä¸­å»å¯»æ‰¾å³å¯ï¼Œå¹¶ä¸”ï¼Œåœ¨å¹¶å‘æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¸Šé”çš„å•ä½ä»æ•´ä¸ªbcacheå˜ä¸ºäº†å…¶ä¸­çš„ä¸€ä¸ªæ¡¶ï¼Œé”çš„ç²’åº¦å¤§å¤§å‡å°äº†ã€‚\né‚£ä¹ˆæˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹bcacheçš„æ•°æ®ç»“æ„ï¼š\n#define NBUCKET 13 #define BLOCK_HASH(blockno) (blockno % NBUCKET) struct { struct spinlock g_lock; // å…¨å±€é”ï¼Œè¿™é‡Œç›¸è¾ƒä¹‹å‰åªæ˜¯æ”¹äº†ä¸ªåå­— struct buf buf[NBUF]; struct spinlock bk_lock[NBUCKET]; // æ¯ä¸ªhash bucketéƒ½å¯¹åº”æœ‰ä¸€æŠŠé” struct buf bucket[NBUCKET]; // hash bucket int size; // ç¼“å†²å—æ± ï¼ˆbuf[NBUF]ï¼‰ä¸­å·²ä½¿ç”¨çš„å—æ•° } bcache; æˆ‘ä»¬åœ¨é‡æ„çš„æ–¹æ¡ˆä¸­ï¼Œä¸å†ä½¿ç”¨LRUé“¾è¡¨ï¼Œä½†è¿˜æ˜¯ä½¿ç”¨äº†LRUç®—æ³•çš„æ€æƒ³ï¼Œåªæ˜¯ç”¨æ—¶é—´æˆ³æ¥ä»£æ›¿LRUé“¾è¡¨ï¼š\nstruct buf { int valid; // has data been read from disk? int disk; // does disk \"own\" buf? uint dev; uint blockno; struct sleeplock lock; uint refcnt; // struct buf *prev; // LRU cache list struct buf *next; uchar data[BSIZE]; uint timestamp; }; è¿™ä¸ªæ—¶é—´æˆ³é€šè¿‡ä¸€ä¸ªå…¨å±€å˜é‡ticksï¼ˆtrap.cï¼‰æ¥è·å–ï¼š\nextern uint ticks; é‚£ä¹ˆåœ¨åˆå§‹åŒ–bcacheæ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦åˆå§‹åŒ–å…¶ä¸­çš„é”å’Œbcache.sizeå³å¯ï¼š\nvoid binit(void) { struct buf *b; bcache.size = 0; initlock(\u0026bcache.g_lock, \"bcache\"); for (int i = 0; i \u003c NBUCKET; i++) { initlock(\u0026bcache.bk_lock[i], \"bk_lock\"); } for(b = bcache.buf; b \u003c bcache.buf+NBUF; b++){ initsleeplock(\u0026b-\u003elock, \"buffer\"); } } ç”±äºæˆ‘ä»¬å¯¹äºé”çš„æ“ä½œå•ä½å˜ä¸ºäº†bucketï¼Œæ‰€ä»¥ä¸‹é¢ä¸¤ä¸ªå‡½æ•°ä¹Ÿéœ€è¦ä¿®æ”¹ï¼š\nvoid bpin(struct buf *b) { int idx = BLOCK_HASH(b-\u003eblockno); acquire(\u0026bcache.bk_lock[idx]); b-\u003erefcnt++; release(\u0026bcache.bk_lock[idx]); } void bunpin(struct buf *b) { int idx = BLOCK_HASH(b-\u003eblockno); acquire(\u0026bcache.bk_lock[idx]); b-\u003erefcnt--; release(\u0026bcache.bk_lock[idx]); } åœ¨åŸå…ˆçš„é‡Šæ”¾bufferå—çš„brelse(struct buf *b)å‡½æ•°ä¸­ï¼Œä¼šå…ˆå¯¹bçš„å¼•ç”¨è®¡æ•°-1ï¼Œå½“å…¶å€¼ä¸º0æ—¶ï¼Œå°†å…¶è½¬ç§»è‡³LRUé“¾è¡¨çš„head-\u003eprevä½ç½®ï¼Œè¯´æ˜è¿™ä¸ªbufferæ²¡æœ‰è¢«ä»»ä½•è¿›ç¨‹ä½¿ç”¨äº†ã€‚è€Œåœ¨é‡æ„æ–¹æ¡ˆä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨æ—¶é—´æˆ³ä»£æ›¿äº†LRUé“¾è¡¨ï¼Œæ¯ä¸ªbucketä¸­æˆ‘ä»¬å¹¶æ²¡æœ‰ç»´æŠ¤ä¸€ä¸ªLRUé“¾è¡¨ï¼Œè€Œæ˜¯è®¤ä¸ºå¼•ç”¨è®¡æ•°ä¸º0ä¸”æ—¶é—´æˆ³æœ€å°çš„çš„bufferæ˜¯æ²¡æœ‰è¢«ä»»ä½•è¿›ç¨‹ä½¿ç”¨çš„ï¼Œæ•…åœ¨å¼•ç”¨è®¡æ•°ä¸º0æ—¶ï¼Œåªéœ€è¦æ›´æ–°bufferçš„æ—¶é—´æˆ³å³å¯ï¼š\nvoid brelse(struct buf *b) { if(!holdingsleep(\u0026b-\u003elock)) panic(\"brelse\"); releasesleep(\u0026b-\u003elock); int idx = BLOCK_HASH(b-\u003eblockno); acquire(\u0026bcache.bk_lock[idx]); b-\u003erefcnt--; if (b-\u003erefcnt == 0) { // no one is waiting for it. b-\u003etimestamp = ticks; // æœªä½¿ç”¨çš„bufferçš„æ—¶é—´æˆ³ä¸€å®šæ˜¯æœ€å°çš„ } release(\u0026bcache.bk_lock[idx]); } å¯¹äºbcacheæœ€é‡è¦çš„bget()å‡½æ•°ï¼Œæˆ‘ä»¬é‡æ„çš„æ€è·¯ä¸ºï¼š\næ£€æŸ¥æ ‡å·ä¸ºblocknoçš„å—çš„ç¼“å­˜æ˜¯å¦åœ¨cacheä¸­ï¼Œå¦‚æœåœ¨ï¼Œåˆ™å…¶å¼•ç”¨è®¡æ•°+1ï¼Œè¿”å›è¯¥ç¼“å­˜å— åœ¨ç¼“å­˜ä¸­æ²¡æœ‰æ‰¾åˆ°ï¼Œå…ˆåœ¨ç¼“å†²å—æ± ä¸­å¯»æ‰¾è¿˜æœªåˆ†é…ç»™bucketçš„ç¼“å­˜å— å¦‚æœç¼“å†²å—æ± ä¸­éƒ½åˆ†é…å‡ºå»äº†ï¼Œå°±åˆ°æ¯ä¸ªbucketä¸­å»æ‰¾ã€‚å¦‚æœå½“å‰éå†çš„bucketä¸­æœ‰bufferçš„å¼•ç”¨è®¡æ•°ä¸º0ï¼Œæ‹¿åˆ°å…¶ä¸­æ—¶é—´æˆ³æœ€å°çš„bufferï¼ˆè¿™ä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªbufferæ˜¯è·ç¦»ç°åœ¨æœ€ä¹…æ²¡æœ‰ä½¿ç”¨çš„åˆæ³•å—ï¼‰ å¦‚æœè¿™ä¸ªbufferåœ¨åŸå…ˆçš„bucketä¸­ï¼Œè¿”å›è¿™ä¸ªbuffer å¦åˆ™éœ€è¦å°†è¿™ä¸ªbufferä»å½“å‰bucketä¸­è½¬ç§»åˆ°ç›®æ ‡bucketä¸­ è¿™æ˜¯ä¸€ä¸ªå¤§è‡´çš„æ€è·¯ï¼Œå…·ä½“ç»†èŠ‚å‚è€ƒå¦‚ä¸‹ä»£ç ï¼š\nstatic struct buf* bget(uint dev, uint blockno) { struct buf *b; int bucket_idx = BLOCK_HASH(blockno); // å…ˆå¯¹blocknoå¯¹åº”çš„bucketä¸Šé”å³å¯ acquire(\u0026bcache.bk_lock[bucket_idx]); // Is the block already cached? for(b = \u0026bcache.bucket[bucket_idx]; b; b = b-\u003enext){ if(b-\u003edev == dev \u0026\u0026 b-\u003eblockno == blockno){ b-\u003erefcnt++; release(\u0026bcache.bk_lock[bucket_idx]); acquiresleep(\u0026b-\u003elock); return b; } } // åœ¨ç¼“å­˜ä¸­æ²¡æœ‰æ‰¾åˆ°ï¼Œå…ˆåœ¨ç¼“å†²å—æ± ä¸­å¯»æ‰¾è¿˜æœªåˆ†é…ç»™bucketçš„ç¼“å­˜å— // éœ€è¦ä½¿ç”¨å…¨å±€é”æ¥ä¿è¯bcache.size++çš„åŸå­æ€§ // è¿™é‡Œä¹Ÿæ˜¯ä¸ºä»€ä¹ˆbufferæ—¶é—´æˆ³ä¸éœ€è¦åˆå§‹åŒ–çš„åŸå› ï¼šæ¯ä¸€æ¬¡éœ€è¦ä½¿ç”¨bufferæ—¶ï¼ˆä¼šè°ƒç”¨bgetï¼‰ï¼Œ // å¦‚æœbufferæ± ä¸­è¿˜æœ‰ç©ºé—²bufferï¼Œåˆ™ä¼šç›´æ¥ä½¿ç”¨è¿™ä¸ªbufferï¼Œå®Œæˆæ“ä½œåä¼šè°ƒç”¨releseé‡Šæ”¾bufferï¼Œæ­¤æ—¶å°±ä¼šæ›´æ–°bufferçš„æ—¶é—´æˆ³ acquire(\u0026bcache.g_lock); if (bcache.size \u003c NBUF) { struct buf *b = \u0026bcache.buf[bcache.size++]; b-\u003enext = bcache.bucket[bucket_idx].next; bcache.bucket[bucket_idx].next = b; b-\u003edev = dev; b-\u003eblockno = blockno; b-\u003evalid = 0; b-\u003erefcnt = 1; release(\u0026bcache.g_lock); acquiresleep(\u0026b-\u003elock); return b; } release(\u0026bcache.g_lock); // åœ¨è¿™æ—¶æ‰èƒ½é‡Šæ”¾è¯¥bucketçš„é”ï¼Œå‡è®¾åœ¨æ£€æŸ¥ç¼“å­˜æ˜¯å¦å­˜åœ¨åé‡Šæ”¾ï¼š // å¦‚æœæœ‰ä¸¤ä¸ªè¿›ç¨‹1å’Œ2ï¼Œæ­¤æ—¶ç¼“å†²å—æ± è¿˜æœ‰å¤šä¸ªæœªåˆ†é…çš„å—ï¼Œè¿›ç¨‹1æ£€æŸ¥bucketï¼Œå‘ç°æ²¡æœ‰ç¼“å­˜ï¼Œé‡Šæ”¾é”ï¼Œå‡†å¤‡å»ç¼“å†²å—æ± ä¸­æ‹¿ // æ­¤æ—¶åˆ‡æ¢åˆ°è¿›ç¨‹2ï¼Œè¿›ç¨‹2æ£€æŸ¥bucket,å‘ç°æ²¡æœ‰ç¼“å­˜ï¼Œä¹Ÿå»ç¼“å†²å—æ± ä¸­æ‹¿ // è¿™æ ·å°±ä¼šå¯¼è‡´bucketä¼šæ·»åŠ ä¸¤ä¸ªblocknoçš„ç¼“å†²å— release(\u0026bcache.bk_lock[bucket_idx]); // åœ¨æ¯ä¸ªbucketä¸­å»æ‰¾å¯ç”¨çš„buffer cache for (int i = 0; i \u003c NBUCKET; i++) { struct buf *cur_buf, *pre_buf, *min_buf, *min_pre_buf; uint min_timestamp = -1; acquire(\u0026bcache.bk_lock[bucket_idx]); pre_buf = \u0026bcache.bucket[bucket_idx]; cur_buf = pre_buf-\u003enext; // éå†bcache.bucket[bucket_idx] while (cur_buf) { // ä¸ºä»€ä¹ˆè¿™é‡Œéœ€è¦é‡æ–°æ£€æŸ¥ï¼Ÿè€ƒè™‘è¿™æ ·ä¸€ç§æƒ…å†µï¼š // å‡è®¾ç¼“å†²å—æ± ä¸­è¿˜æœ‰ä¸€ä¸ªæœªåˆ†é…çš„ï¼Œæ­¤æ—¶æœ‰ä¸¤ä¸ªè¿›ç¨‹ï¼Œè¿›ç¨‹1å’Œ2éƒ½éœ€è¦è®¿é—®åŒä¸€ä¸ªæ ‡å·blocknoçš„å— // è¿›ç¨‹1å…ˆæ‹¿åˆ°è¿™ä¸ªæœªåˆ†é…çš„ï¼Œå¹¶å°†å…¶æ”¾å…¥äº†å¯¹åº”çš„bucketä¸­ // ä¹‹åè¿›ç¨‹2å‘ç°æ± ä¸­æ²¡æœ‰æœªåˆ†é…çš„äº†ï¼Œå¼€å§‹éå†æ‰€æœ‰bucketï¼Œ // å¦‚æœè¿™æ—¶ä¸é‡æ–°æ£€æŸ¥ä¸€ä¸‹blocknoå¯¹åº”çš„bucketï¼Œåˆ™ä¼šå¯¼è‡´ä¸€ä¸ªbucketä¸­æœ‰ä¸¤ä¸ªblocknoçš„å— if (bucket_idx == BLOCK_HASH(blockno) \u0026\u0026 cur_buf-\u003eblockno == blockno \u0026\u0026 cur_buf-\u003edev == dev) { cur_buf-\u003erefcnt++; release(\u0026bcache.bk_lock[bucket_idx]); acquiresleep(\u0026cur_buf-\u003elock); return cur_buf; } // åªæœ‰å¼•ç”¨è®¡æ•°ä¸º0,å¹¶ä¸”æ—¶é—´æˆ³æœ€å°çš„ç¼“å†²å—æ‰å¯è¢«é‡æ–°åˆ†é… if (cur_buf-\u003erefcnt == 0 \u0026\u0026 cur_buf-\u003etimestamp \u003c min_timestamp) { min_pre_buf = pre_buf; min_buf = cur_buf; min_timestamp = cur_buf-\u003etimestamp; } pre_buf = cur_buf; cur_buf = cur_buf-\u003enext; } // åœ¨æœ¬è½®ä¸­æ‰¾åˆ°äº†å¯é‡æ–°åˆ†é…çš„ç¼“å†²å— if (min_buf) { min_buf-\u003edev = dev; min_buf-\u003eblockno = blockno; min_buf-\u003evalid = 0; min_buf-\u003erefcnt = 1; // æ˜¯è‡ªèº«bucketä¸­çš„ï¼Œä¸ç”¨åšè½¬ç§»æ“ä½œ if (bucket_idx == BLOCK_HASH(blockno)) { // release(\u0026bcache.hash_lock); release(\u0026bcache.bk_lock[bucket_idx]); acquiresleep(\u0026min_buf-\u003elock); return min_buf; } // æ˜¯å…¶ä»–bucketä¸­çš„ï¼Œéœ€è¦è½¬ç§» // å…ˆå°†ç›®æ ‡bucketä¸­çš„bufferç§»é™¤ï¼Œç„¶åé‡Šæ”¾é” min_pre_buf-\u003enext = min_buf-\u003enext; release(\u0026bcache.bk_lock[bucket_idx]); // æ¥ç€è·å–blocknoå¯¹åº”çš„é”ï¼Œå¹¶å°†ä»ç›®æ ‡bucketä¸­ç§»é™¤çš„bufferæ”¾è‡³blocknoå¯¹åº”çš„bucketï¼Œè¿”å›è¯¥buffer bucket_idx = BLOCK_HASH(blockno); acquire(\u0026bcache.bk_lock[bucket_idx]); min_buf-\u003enext = bcache.bucket[bucket_idx].next; bcache.bucket[bucket_idx].next = min_buf; release(\u0026bcache.bk_lock[bucket_idx]); acquiresleep(\u0026min_buf-\u003elock); return min_buf; } release(\u0026bcache.bk_lock[bucket_idx]); // å¦‚æœåˆ°åº•äº†ï¼Œä»å¤´æ¥ï¼Œä¿è¯éå†æ¯ä¸€ä¸ªbucket if (++bucket_idx == NBUCKET) { bucket_idx = 0; } } panic(\"bget: no buffers\"); } bgetæ˜¯è¿™ä¸ªlabä¸­æœ€å¤æ‚çš„åœ°æ–¹ï¼Œå…¶å¤„ç†é€»è¾‘è™½ç„¶è¾ƒå¥½ç†è§£ï¼Œä½†æ˜¯å¤šä¸ªé”çš„æ“ä½œé¡ºåºå¾ˆè®©äººå¤´ç–¼ï¼Œéœ€è¦è€ƒè™‘åˆ°å¤šç§å¹¶å‘æƒ…å†µã€‚\nCode Details ä»£ç å®ç°è¯¦æƒ…è¯·è§Githubï¼šhttps://github.com/kerolt/xv6-labs-2023/commit/ccac48e8ae6b6dde3e7c747a77f4149232420901\nReference https://github.com/whileskies/xv6-labs-2020/blob/main/doc/Lab8-locks.md https://blog.csdn.net/LostUnravel/article/details/121430900 ","wordCount":"859","inLanguage":"en","image":"https://kerolt.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2024-11-17T00:00:00Z","dateModified":"2024-11-17T00:00:00Z","author":{"@type":"Person","name":"Kerolt"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://kerolt.github.io/posts/%E5%8A%A8%E6%89%8B%E5%AE%9E%E7%8E%B0x/mit6.s081/mit6.s081lab8-lock/"},"publisher":{"@type":"Organization","name":"Kerolt's Blog","logo":{"@type":"ImageObject","url":"https://kerolt.github.io/images/avatar/favicon.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://kerolt.github.io/ accesskey=h title="Kerolt's Blog (Alt + H)">Kerolt's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://kerolt.github.io/posts/ title=æ–‡ç« ><span>æ–‡ç« </span></a></li><li><a href=https://kerolt.github.io/categories/ title=åˆ†ç±»><span>åˆ†ç±»</span></a></li><li><a href=https://kerolt.github.io/tags/ title=æ ‡ç­¾><span>æ ‡ç­¾</span></a></li><li><a href=https://kerolt.github.io/archives/ title=å½’æ¡£><span>å½’æ¡£</span></a></li><li><a href=https://kerolt.github.io/about/ title=å…³äºæˆ‘><span>å…³äºæˆ‘</span></a></li><li><a href=https://kerolt.github.io/search/ title="ğŸ” (Alt + /)" accesskey=/><span>ğŸ”</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://kerolt.github.io/>Home</a>&nbsp;Â»&nbsp;<a href=https://kerolt.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">ã€MIT6.S081ã€‘Lab8 lock</h1><div class=post-meta><span title='2024-11-17 00:00:00 +0000 UTC'>å‘å¸ƒäº2024-11-17</span>&nbsp;&nbsp;Â·&nbsp;&nbsp;Kerolt</div><ul class=post-tags><li><a href=https://kerolt.github.io/tags/os/>OS</a></li><li><a href=https://kerolt.github.io/tags/mit6-s081/>MIT6-S081</a></li><li><a href=https://kerolt.github.io/tags/xv6/>Xv6</a></li></ul></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#intro aria-label=Intro>Intro</a></li><li><a href=#memory-allocator aria-label="Memory Allocator">Memory Allocator</a></li><li><a href=#buffer-cache aria-label="Buffer Cache">Buffer Cache</a></li><li><a href=#code-details aria-label="Code Details">Code Details</a></li><li><a href=#reference aria-label=Reference>Reference</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h2 id=intro>Intro<a hidden class=anchor aria-hidden=true href=#intro>#</a></h2><p>è¿™ä¸ªå®éªŒä¸ªäººæ„Ÿè§‰æŒºéš¾çš„ï¼Œéœ€è¦æˆ‘ä»¬é‡æ–°è®¾è®¡æ•°æ®ç»“æ„ï¼Œè¿˜è¦è€ƒè™‘åœ¨å¹¶å‘ï¼ˆå¹¶è¡Œï¼‰æƒ…å†µä¸‹å¯¹äºé”çš„æ“ä½œï¼Œä»¥å‡å°‘å¤šæ ¸æƒ…å†µä¸‹å¯¹äºé”çš„ç«äº‰ã€‚å…¶ä¸­ä¸»è¦æ¶‰åŠå†…å­˜åˆ†é…å’ŒIOç¼“å†²å—åˆ†é…ï¼Œåœ¨è¿™ä¸ªlabä¹‹å‰ï¼Œxv6å¯¹äºè¿™ä¸¤ä¸ªåˆ†é…éƒ½æ˜¯ä½¿ç”¨çš„å…¨å±€å¯¹è±¡ï¼Œå¹¶åªæœ‰ä¸€æŠŠå…¨å±€é”è¿›è¡Œæ“ä½œï¼Œè¿™æ ·çš„è¯åœ¨å¹¶è¡Œæƒ…å†µä¸‹é”çš„ç«äº‰æ˜¯å¾ˆæ¿€çƒˆçš„ï¼Œæˆ‘ä»¬çš„ä»»åŠ¡å°±æ˜¯é‡æ–°è®¾è®¡è¿™ä¸¤ä¸ªåˆ†é…å™¨ï¼Œå®ƒä»¬çš„é‡æ„æ€è·¯å¹¶ä¸å®Œå…¨ä¸€è‡´ï¼Œéœ€è¦å…·ä½“é—®é¢˜å…·ä½“åˆ†æã€‚</p><h2 id=memory-allocator>Memory Allocator<a hidden class=anchor aria-hidden=true href=#memory-allocator>#</a></h2><p>åœ¨xv6ä¸­ï¼Œå†…å­˜é€šè¿‡<code>kalloc()</code>æ¥åˆ†é…ï¼Œåœ¨å…¶å†…éƒ¨ï¼Œä¼šä½¿ç”¨ä¸€ä¸ª<code>kmem</code>çš„ç»“æ„ä½“å˜é‡ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#09f;font-style:italic>// kernel/kalloc.c
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>struct</span> run {
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>struct</span> run <span style=color:#555>*</span>next;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>struct</span> {
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>struct</span> spinlock lock;
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>struct</span> run <span style=color:#555>*</span>freelist;
</span></span><span style=display:flex><span>} kmem;
</span></span></code></pre></div><p><code>kmem.freelist</code>ä¿å­˜ç€æœªä½¿ç”¨çš„å†…å­˜å—ï¼ˆæ¯å—å¤§å°ä¸º4KBï¼‰ï¼Œåœ¨å†…æ ¸åˆå§‹åŒ–æ—¶ï¼Œä¼šé€šè¿‡<code>kinit()</code>å°†åœ°å€<code>KERNBASE ~ PHYSTOP</code>çš„ç‰©ç†å†…å­˜ï¼ˆä¸€å…±128MBï¼‰æ”¾å…¥freelistä¸­ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#078;font-weight:700>void</span>
</span></span><span style=display:flex><span><span style=color:#c0f>kinit</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#c0f>initlock</span>(<span style=color:#555>&amp;</span>kmem.lock, <span style=color:#c30>&#34;kmem&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#c0f>freerange</span>(end, (<span style=color:#078;font-weight:700>void</span><span style=color:#555>*</span>)PHYSTOP); <span style=color:#09f;font-style:italic>// endä¸ºkernel.ldä¸­å®šä¹‰çš„ï¼Œå€¼ä¸º0x80000000ï¼Œå³KERNBASE
</span></span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#078;font-weight:700>void</span>
</span></span><span style=display:flex><span><span style=color:#c0f>freerange</span>(<span style=color:#078;font-weight:700>void</span> <span style=color:#555>*</span>pa_start, <span style=color:#078;font-weight:700>void</span> <span style=color:#555>*</span>pa_end)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#078;font-weight:700>char</span> <span style=color:#555>*</span>p;
</span></span><span style=display:flex><span>  p <span style=color:#555>=</span> (<span style=color:#078;font-weight:700>char</span><span style=color:#555>*</span>)<span style=color:#c0f>PGROUNDUP</span>((uint64)pa_start);
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>for</span>(; p <span style=color:#555>+</span> PGSIZE <span style=color:#555>&lt;=</span> (<span style=color:#078;font-weight:700>char</span><span style=color:#555>*</span>)pa_end; p <span style=color:#555>+=</span> PGSIZE)
</span></span><span style=display:flex><span>    <span style=color:#c0f>kfree</span>(p); <span style=color:#09f;font-style:italic>// ä½¿ç”¨kfreeå°†å†…å­˜å—æ”¾å…¥freelistä¸­
</span></span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>é€šè¿‡ä¸Šé¢çš„æºç åˆ†ææˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ•´ä¸ªxv6å†…æ ¸éƒ½æ˜¯é€šè¿‡ä¸€ä¸ªå…¨å±€çš„<code>kmem</code>æ¥åˆ†é…å’Œå›æ”¶å†…å­˜å—ï¼Œé‚£ä¹ˆå¦‚æœå½“å¤šä¸ªCPUï¼ˆå¤šä¸ªcoreï¼‰éœ€è¦æ“ä½œå†…å­˜å—æ—¶ï¼Œå°±å¿…é¡»å¾—ç”¨é”æ‰èƒ½ä¿è¯æ•´ä½“çš„ç¨³å®šå’Œæ­£ç¡®ã€‚</p><p>ä½†æ˜¯è¿™æ ·åšåˆä¼šæœ‰ä¸€ä¸ªå¤§é—®é¢˜ï¼Œé‚£å°±æ˜¯ä¸€ä¸ªcpuåœ¨æ“ä½œ<code>kmem</code>æ—¶ï¼Œå¦ä¸€ä¸ªCPUå³ä¾¿æƒ³è·å–å†…å­˜å—æˆ–é‡Šæ”¾å†…å­˜å—ï¼Œå› ä¸ºé”çš„ç¼˜æ•…ä¹Ÿåªèƒ½ç­‰å¾…ã€‚æ•…æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆæ˜¯ä¸ºæ¯ä¸ªCPUéƒ½è®¾ç½®ä¸€ä¸ª<code>kmem</code>ï¼Œè¿™æ ·ï¼Œå“ªä¸ªCPUéœ€è¦æ“ä½œå†…å­˜å—æ—¶å°±å¯ä»¥åªé”ä¸Šå®ƒè‡ªå·±çš„kmemï¼Œå…¶ä»–CPUå—åˆ°çš„å¹²æ‰°ä¼šå¤§å¤§å‡å°‘ã€‚</p><p>ä¸ºä»€ä¹ˆè¯´æ˜¯å¤§å¤§å‡å°‘è€Œä¸æ˜¯å®Œå…¨å‡å°‘å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºå½“æŸä¸ªCPUçš„<code>kmem.freelist</code>ä¸­æ²¡æœ‰å¯åˆ†é…çš„å†…å­˜å—æ—¶ï¼Œéœ€è¦å»å…¶ä»–CPUçš„<code>kmem.freelist</code>ä¸­å»æ‹¿ä¸€ä¸ªè¿‡æ¥ï¼Œè¿™æ—¶å°±éœ€è¦å¤„ç†å¥½è¿™ä¸¤ä¸ªCPUçš„é”çš„å¤„ç†äº†ã€‚</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#069;font-weight:700>struct</span> {
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>struct</span> spinlock lock;
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>struct</span> run <span style=color:#555>*</span>freelist;
</span></span><span style=display:flex><span>  <span style=color:#078;font-weight:700>char</span> lock_name[<span style=color:#f60>8</span>]; <span style=color:#09f;font-style:italic>// æ¯ä¸ªkmemçš„é”çš„åç§°
</span></span></span><span style=display:flex><span>} kmem[NCPU]; <span style=color:#09f;font-style:italic>// ä¸ºæ¯ä¸ªCPUéƒ½è®¾ç½®ä¸€ä¸ªkmem
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#078;font-weight:700>void</span>
</span></span><span style=display:flex><span><span style=color:#c0f>kinit</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>// åˆå§‹åŒ–æ—¶è¦å¯¹æ¯ä¸ªkmeméƒ½åˆå§‹é”
</span></span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>for</span> (<span style=color:#078;font-weight:700>int</span> i <span style=color:#555>=</span> <span style=color:#f60>0</span>; i <span style=color:#555>&lt;</span> NCPU; i<span style=color:#555>++</span>) {
</span></span><span style=display:flex><span>    <span style=color:#c0f>initlock</span>(<span style=color:#555>&amp;</span>kmem[i].lock, <span style=color:#c30>&#34;kmem&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#c0f>snprintf</span>(kmem[i].lock_name, <span style=color:#069;font-weight:700>sizeof</span>(kmem[i].lock_name), <span style=color:#c30>&#34;kmem%d&#34;</span>, i);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>// è¿™é‡Œä¼šå…ˆå°†æ‰€æœ‰å†…å­˜å—éƒ½åˆ†é…ç»™kmem[0]ï¼Œå› ä¸ºå†…æ ¸å¯åŠ¨æ—¶æ˜¯cpus[0]åœ¨åšåˆå§‹åŒ–æ“ä½œ
</span></span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>// ä¹‹åå…¶ä»–CPUéœ€è¦å†…å­˜å—æ—¶ï¼Œä»cpus[0]è¿™é‡Œæ‹¿
</span></span></span><span style=display:flex><span>  <span style=color:#c0f>freerange</span>(end, (<span style=color:#078;font-weight:700>void</span><span style=color:#555>*</span>)PHYSTOP);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#078;font-weight:700>void</span>
</span></span><span style=display:flex><span><span style=color:#c0f>kfree</span>(<span style=color:#078;font-weight:700>void</span> <span style=color:#555>*</span>pa)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>struct</span> run <span style=color:#555>*</span>r;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>if</span>(((uint64)pa <span style=color:#555>%</span> PGSIZE) <span style=color:#555>!=</span> <span style=color:#f60>0</span> <span style=color:#555>||</span> (<span style=color:#078;font-weight:700>char</span><span style=color:#555>*</span>)pa <span style=color:#555>&lt;</span> end <span style=color:#555>||</span> (uint64)pa <span style=color:#555>&gt;=</span> PHYSTOP)
</span></span><span style=display:flex><span>    <span style=color:#c0f>panic</span>(<span style=color:#c30>&#34;kfree&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>// Fill with junk to catch dangling refs.
</span></span></span><span style=display:flex><span>  <span style=color:#c0f>memset</span>(pa, <span style=color:#f60>1</span>, PGSIZE);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  r <span style=color:#555>=</span> (<span style=color:#069;font-weight:700>struct</span> run<span style=color:#555>*</span>)pa;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>// ----------------------------------------
</span></span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>// kfreeæ—¶åªéœ€è¦å°†å†…å­˜å—æ”¾åˆ°è‡ªå·±æ‰€å±cpuçš„kmem.freelistä¸­
</span></span></span><span style=display:flex><span>  <span style=color:#c0f>push_off</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#078;font-weight:700>int</span> cid <span style=color:#555>=</span> <span style=color:#c0f>cpuid</span>();
</span></span><span style=display:flex><span>  <span style=color:#c0f>acquire</span>(<span style=color:#555>&amp;</span>kmem[cid].lock);
</span></span><span style=display:flex><span>  r<span style=color:#555>-&gt;</span>next <span style=color:#555>=</span> kmem[cid].freelist;
</span></span><span style=display:flex><span>  kmem[cid].freelist <span style=color:#555>=</span> r;
</span></span><span style=display:flex><span>  <span style=color:#c0f>release</span>(<span style=color:#555>&amp;</span>kmem[cid].lock);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#c0f>pop_off</span>();
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>// ----------------------------------------
</span></span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#078;font-weight:700>void</span> <span style=color:#555>*</span>
</span></span><span style=display:flex><span><span style=color:#c0f>kalloc</span>(<span style=color:#078;font-weight:700>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>struct</span> run <span style=color:#555>*</span>r;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>// ----------------------------------------
</span></span></span><span style=display:flex><span>  <span style=color:#c0f>push_off</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#078;font-weight:700>int</span> cid <span style=color:#555>=</span> <span style=color:#c0f>cpuid</span>();
</span></span><span style=display:flex><span>  <span style=color:#c0f>acquire</span>(<span style=color:#555>&amp;</span>kmem[cid].lock);
</span></span><span style=display:flex><span>  r <span style=color:#555>=</span> kmem[cid].freelist;
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>if</span> (r) {
</span></span><span style=display:flex><span>    <span style=color:#09f;font-style:italic>// å¦‚æœå½“å‰çš„freelistä¸­è¿˜æœ‰å†…å­˜å—ï¼Œåˆ™ç›´æ¥ç”¨
</span></span></span><span style=display:flex><span>    kmem[cid].freelist <span style=color:#555>=</span> r<span style=color:#555>-&gt;</span>next;
</span></span><span style=display:flex><span>  } <span style=color:#069;font-weight:700>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#09f;font-style:italic>// æ²¡æœ‰ï¼Ÿé‚£å°±æ‹¿ï¼
</span></span></span><span style=display:flex><span>    <span style=color:#09f;font-style:italic>// éå†ä¸€ä¸‹å…¶ä»–CPUçš„kmemï¼Œå¦‚æœæ‰¾åˆ°çš„freelistä¸­è¿˜æœ‰å†…å­˜å—ï¼Œå°±æ‹¿å®ƒçš„
</span></span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>for</span> (<span style=color:#078;font-weight:700>int</span> next_cid <span style=color:#555>=</span> <span style=color:#f60>0</span>; next_cid <span style=color:#555>&lt;</span> NCPU; next_cid<span style=color:#555>++</span>) {
</span></span><span style=display:flex><span>      <span style=color:#09f;font-style:italic>// ä¸æ‰¾è‡ªå·±
</span></span></span><span style=display:flex><span>      <span style=color:#069;font-weight:700>if</span> (next_cid <span style=color:#555>==</span> cid)
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>continue</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#c0f>acquire</span>(<span style=color:#555>&amp;</span>kmem[next_cid].lock);
</span></span><span style=display:flex><span>      r <span style=color:#555>=</span> kmem[next_cid].freelist;
</span></span><span style=display:flex><span>      <span style=color:#069;font-weight:700>if</span> (r) {
</span></span><span style=display:flex><span>        kmem[next_cid].freelist <span style=color:#555>=</span> r<span style=color:#555>-&gt;</span>next;
</span></span><span style=display:flex><span>        <span style=color:#c0f>release</span>(<span style=color:#555>&amp;</span>kmem[next_cid].lock);
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>break</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#c0f>release</span>(<span style=color:#555>&amp;</span>kmem[next_cid].lock);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#c0f>release</span>(<span style=color:#555>&amp;</span>kmem[cid].lock);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#c0f>pop_off</span>();
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>// ----------------------------------------
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>if</span>(r)
</span></span><span style=display:flex><span>    <span style=color:#c0f>memset</span>((<span style=color:#078;font-weight:700>char</span><span style=color:#555>*</span>)r, <span style=color:#f60>5</span>, PGSIZE); <span style=color:#09f;font-style:italic>// fill with junk
</span></span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>return</span> (<span style=color:#078;font-weight:700>void</span><span style=color:#555>*</span>)r;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=buffer-cache>Buffer Cache<a hidden class=anchor aria-hidden=true href=#buffer-cache>#</a></h2><p>å…ˆä»‹ç»ä¸‹å®éªŒåˆå§‹çš„bcacheï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#069;font-weight:700>struct</span> {
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>struct</span> spinlock lock;
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>struct</span> buf buf[NBUF];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>// Linked list of all buffers, through prev/next.
</span></span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>// Sorted by how recently the buffer was used.
</span></span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>// head.next is most recent, head.prev is least.
</span></span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>struct</span> buf head;
</span></span><span style=display:flex><span>} bcache;
</span></span></code></pre></div><ul><li><code>struct spinlock lock</code>ï¼šbcacheçš„å…¨å±€é”</li><li><code>struct buf buf[NBUF]</code>ï¼šç¼“å†²å—æ± ï¼Œå³åŒ…å«äº†æ‰€æœ‰çš„buffer cache</li><li><code>struct buf head</code>ï¼šä¸€ä¸ªLRUé“¾è¡¨ï¼Œç”¨äºæ“ä½œç¼“å†²å—ï¼Œä½¿ç”¨head.nextè·å–çš„æ˜¯æœ€è¿‘åˆšä½¿ç”¨è¿‡çš„bufferï¼Œhead.prevè·å–çš„æ˜¯æœ€è¿‘æœªä½¿ç”¨æ—¶é—´æœ€ä¹…çš„bufferï¼ˆæˆ–è€…è¯´æ˜¯æœªè¢«ä½¿ç”¨çš„bufferï¼Œå³å¼•ç”¨è®¡æ•°ä¸º0ï¼‰</li></ul><p><div class=post-img-view><a data-fancybox=gallery href=https://gitee.com/kerolt/picture/raw/main/20241215-134743.png><img src=https://gitee.com/kerolt/picture/raw/main/20241215-134743.png alt></a></div></p><p>åŸæ¥çš„bcacheä¸­çš„bufæ•°ç»„åœ¨binitæ—¶å°±ç»™LRUé“¾è¡¨åˆå§‹åŒ–ç”¨äº†ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#078;font-weight:700>void</span>
</span></span><span style=display:flex><span><span style=color:#c0f>binit</span>(<span style=color:#078;font-weight:700>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>struct</span> buf <span style=color:#555>*</span>b;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#c0f>initlock</span>(<span style=color:#555>&amp;</span>bcache.lock, <span style=color:#c30>&#34;bcache&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>// Create linked list of buffers
</span></span></span><span style=display:flex><span>  bcache.head.prev <span style=color:#555>=</span> <span style=color:#555>&amp;</span>bcache.head;
</span></span><span style=display:flex><span>  bcache.head.next <span style=color:#555>=</span> <span style=color:#555>&amp;</span>bcache.head;
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>for</span>(b <span style=color:#555>=</span> bcache.buf; b <span style=color:#555>&lt;</span> bcache.buf<span style=color:#555>+</span>NBUF; b<span style=color:#555>++</span>){
</span></span><span style=display:flex><span>    b<span style=color:#555>-&gt;</span>next <span style=color:#555>=</span> bcache.head.next;
</span></span><span style=display:flex><span>    b<span style=color:#555>-&gt;</span>prev <span style=color:#555>=</span> <span style=color:#555>&amp;</span>bcache.head;
</span></span><span style=display:flex><span>    <span style=color:#c0f>initsleeplock</span>(<span style=color:#555>&amp;</span>b<span style=color:#555>-&gt;</span>lock, <span style=color:#c30>&#34;buffer&#34;</span>);
</span></span><span style=display:flex><span>    bcache.head.next<span style=color:#555>-&gt;</span>prev <span style=color:#555>=</span> b;
</span></span><span style=display:flex><span>    bcache.head.next <span style=color:#555>=</span> b;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è€Œè¿™æ ·è®¾è®¡çš„buffer cacheæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œç”±äºbuffer cacheåªæœ‰ä¸€ä¸ªå…¨å±€é”ï¼Œå½“åœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œè¿›ç¨‹éœ€è¦å¹¶å‘è®¿é—®bcacheæ—¶ï¼Œæ— æ³•è¾¾åˆ°å¤šè¿›ç¨‹å¸¦æ¥çš„ä¼˜åŠ¿ï¼Œä¸€ä¸ªè¿›ç¨‹å¿…é¡»è¦å…ˆç­‰å‰ä¸€ä¸ªè¿›ç¨‹é‡Šæ”¾é”åæ‰å¯ä»¥æ“ä½œã€‚</p><p>è€ƒè™‘å‰ä¸€ä¸ªå®éªŒä¸­çš„kallocï¼Œæˆ‘ä»¬èƒ½å¦ä¹Ÿä½¿ç”¨é‚£æ ·çš„ç­–ç•¥ï¼Ÿ</p><blockquote><p>Reducing contention in the block cache is more tricky than for kalloc, because bcache buffers are truly shared among processes (and thus CPUs). For kalloc, one could eliminate most contention by giving each CPU its own allocator; that won&rsquo;t work for the block cache.</p></blockquote><p>ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Ÿæ˜¯å› ä¸ºblock cacheå¹¶ä¸åƒå†…å­˜é¡µé‚£æ ·å…·æœ‰é€šç”¨æ€§ã€‚block cacheå¯¹åº”ç€çœŸå®çš„ç‰©ç†å¤–å­˜å—ï¼Œæ¯ä¸€ä¸ªCPUéƒ½å¯èƒ½ä½¿ç”¨åŒä¸€ä¸ªblock cacheï¼Œæ‰€ä»¥æ— æ³•åƒkallocä¸­é‚£æ ·ä¸ºæ¯ä¸ªCPUåˆ†é…å…¶å¯¹åº”çš„cacheã€‚</p><p>æ—¢ç„¶æˆ‘ä»¬æ— æ³•åˆ†åˆ«ä¸ºæ¯ä¸ªCPUåˆ†é…ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æ¢ä¸€ä¸ªè§’åº¦ï¼Œå¯¹æ‰€æœ‰çš„blockå—è¿›è¡Œåˆ†ç»„ï¼šæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªå“ˆå¸Œæ¡¶hash bucketsï¼ˆè¿™é‡Œä½¿ç”¨çš„å®¹é‡ä¸º13ï¼‰ï¼Œé‚£ä¹ˆå¯¹æ¯ä¸ªblockå—çš„å—å·è¿›è¡Œå–ä½™æ“ä½œï¼ˆmod 13ï¼‰å³å¯å°†å®ƒä»¬æ˜ å°„åˆ°å…¶ä¸­ä¸€ä¸ªå“ˆå¸Œæ¡¶ä¸­ã€‚è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨æ ‡å·ä¸ºblocknoçš„å—æ—¶ï¼Œåˆ°å…¶æ˜ å°„çš„å“ˆå¸Œæ¡¶ä¸­å»å¯»æ‰¾å³å¯ï¼Œå¹¶ä¸”ï¼Œåœ¨å¹¶å‘æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¸Šé”çš„å•ä½ä»æ•´ä¸ªbcacheå˜ä¸ºäº†å…¶ä¸­çš„ä¸€ä¸ªæ¡¶ï¼Œé”çš„ç²’åº¦å¤§å¤§å‡å°äº†ã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹bcacheçš„æ•°æ®ç»“æ„ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#099>#define NBUCKET 13
</span></span></span><span style=display:flex><span><span style=color:#099>#define BLOCK_HASH(blockno) (blockno % NBUCKET)
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>struct</span> {
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>struct</span> spinlock g_lock; <span style=color:#09f;font-style:italic>// å…¨å±€é”ï¼Œè¿™é‡Œç›¸è¾ƒä¹‹å‰åªæ˜¯æ”¹äº†ä¸ªåå­—
</span></span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>struct</span> buf buf[NBUF];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>struct</span> spinlock bk_lock[NBUCKET]; <span style=color:#09f;font-style:italic>// æ¯ä¸ªhash bucketéƒ½å¯¹åº”æœ‰ä¸€æŠŠé”
</span></span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>struct</span> buf bucket[NBUCKET];       <span style=color:#09f;font-style:italic>// hash bucket
</span></span></span><span style=display:flex><span>  <span style=color:#078;font-weight:700>int</span> size; <span style=color:#09f;font-style:italic>// ç¼“å†²å—æ± ï¼ˆbuf[NBUF]ï¼‰ä¸­å·²ä½¿ç”¨çš„å—æ•°
</span></span></span><span style=display:flex><span>} bcache;
</span></span></code></pre></div><p><div class=post-img-view><a data-fancybox=gallery href=https://gitee.com/kerolt/picture/raw/main/20241215-134743-1.png><img src=https://gitee.com/kerolt/picture/raw/main/20241215-134743-1.png alt></a></div></p><p>æˆ‘ä»¬åœ¨é‡æ„çš„æ–¹æ¡ˆä¸­ï¼Œä¸å†ä½¿ç”¨LRUé“¾è¡¨ï¼Œä½†è¿˜æ˜¯ä½¿ç”¨äº†LRUç®—æ³•çš„æ€æƒ³ï¼Œåªæ˜¯ç”¨æ—¶é—´æˆ³æ¥ä»£æ›¿LRUé“¾è¡¨ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#069;font-weight:700>struct</span> buf {
</span></span><span style=display:flex><span>  <span style=color:#078;font-weight:700>int</span> valid;   <span style=color:#09f;font-style:italic>// has data been read from disk?
</span></span></span><span style=display:flex><span>  <span style=color:#078;font-weight:700>int</span> disk;    <span style=color:#09f;font-style:italic>// does disk &#34;own&#34; buf?
</span></span></span><span style=display:flex><span>  uint dev;
</span></span><span style=display:flex><span>  uint blockno;
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>struct</span> sleeplock lock;
</span></span><span style=display:flex><span>  uint refcnt;
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>// struct buf *prev; // LRU cache list
</span></span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>struct</span> buf <span style=color:#555>*</span>next;
</span></span><span style=display:flex><span>  uchar data[BSIZE];
</span></span><span style=display:flex><span>  uint timestamp;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>è¿™ä¸ªæ—¶é—´æˆ³é€šè¿‡ä¸€ä¸ªå…¨å±€å˜é‡<code>ticks</code>ï¼ˆtrap.cï¼‰æ¥è·å–ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#069;font-weight:700>extern</span> uint ticks;
</span></span></code></pre></div><p>é‚£ä¹ˆåœ¨åˆå§‹åŒ–bcacheæ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦åˆå§‹åŒ–å…¶ä¸­çš„é”å’Œbcache.sizeå³å¯ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#078;font-weight:700>void</span>
</span></span><span style=display:flex><span><span style=color:#c0f>binit</span>(<span style=color:#078;font-weight:700>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>struct</span> buf <span style=color:#555>*</span>b;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  bcache.size <span style=color:#555>=</span> <span style=color:#f60>0</span>;
</span></span><span style=display:flex><span>  <span style=color:#c0f>initlock</span>(<span style=color:#555>&amp;</span>bcache.g_lock, <span style=color:#c30>&#34;bcache&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>for</span> (<span style=color:#078;font-weight:700>int</span> i <span style=color:#555>=</span> <span style=color:#f60>0</span>; i <span style=color:#555>&lt;</span> NBUCKET; i<span style=color:#555>++</span>) {
</span></span><span style=display:flex><span>    <span style=color:#c0f>initlock</span>(<span style=color:#555>&amp;</span>bcache.bk_lock[i], <span style=color:#c30>&#34;bk_lock&#34;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>for</span>(b <span style=color:#555>=</span> bcache.buf; b <span style=color:#555>&lt;</span> bcache.buf<span style=color:#555>+</span>NBUF; b<span style=color:#555>++</span>){
</span></span><span style=display:flex><span>    <span style=color:#c0f>initsleeplock</span>(<span style=color:#555>&amp;</span>b<span style=color:#555>-&gt;</span>lock, <span style=color:#c30>&#34;buffer&#34;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ç”±äºæˆ‘ä»¬å¯¹äºé”çš„æ“ä½œå•ä½å˜ä¸ºäº†bucketï¼Œæ‰€ä»¥ä¸‹é¢ä¸¤ä¸ªå‡½æ•°ä¹Ÿéœ€è¦ä¿®æ”¹ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#078;font-weight:700>void</span>
</span></span><span style=display:flex><span><span style=color:#c0f>bpin</span>(<span style=color:#069;font-weight:700>struct</span> buf <span style=color:#555>*</span>b) {
</span></span><span style=display:flex><span>  <span style=color:#078;font-weight:700>int</span> idx <span style=color:#555>=</span> <span style=color:#c0f>BLOCK_HASH</span>(b<span style=color:#555>-&gt;</span>blockno);
</span></span><span style=display:flex><span>  <span style=color:#c0f>acquire</span>(<span style=color:#555>&amp;</span>bcache.bk_lock[idx]);
</span></span><span style=display:flex><span>  b<span style=color:#555>-&gt;</span>refcnt<span style=color:#555>++</span>;
</span></span><span style=display:flex><span>  <span style=color:#c0f>release</span>(<span style=color:#555>&amp;</span>bcache.bk_lock[idx]);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#078;font-weight:700>void</span>
</span></span><span style=display:flex><span><span style=color:#c0f>bunpin</span>(<span style=color:#069;font-weight:700>struct</span> buf <span style=color:#555>*</span>b) {
</span></span><span style=display:flex><span>  <span style=color:#078;font-weight:700>int</span> idx <span style=color:#555>=</span> <span style=color:#c0f>BLOCK_HASH</span>(b<span style=color:#555>-&gt;</span>blockno);
</span></span><span style=display:flex><span>  <span style=color:#c0f>acquire</span>(<span style=color:#555>&amp;</span>bcache.bk_lock[idx]);
</span></span><span style=display:flex><span>  b<span style=color:#555>-&gt;</span>refcnt<span style=color:#555>--</span>;
</span></span><span style=display:flex><span>  <span style=color:#c0f>release</span>(<span style=color:#555>&amp;</span>bcache.bk_lock[idx]);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>åœ¨åŸå…ˆçš„é‡Šæ”¾bufferå—çš„<code>brelse(struct buf *b)</code>å‡½æ•°ä¸­ï¼Œä¼šå…ˆå¯¹<code>b</code>çš„å¼•ç”¨è®¡æ•°-1ï¼Œå½“å…¶å€¼ä¸º0æ—¶ï¼Œå°†å…¶è½¬ç§»è‡³LRUé“¾è¡¨çš„<code>head->prev</code>ä½ç½®ï¼Œè¯´æ˜è¿™ä¸ªbufferæ²¡æœ‰è¢«ä»»ä½•è¿›ç¨‹ä½¿ç”¨äº†ã€‚è€Œåœ¨é‡æ„æ–¹æ¡ˆä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨æ—¶é—´æˆ³ä»£æ›¿äº†LRUé“¾è¡¨ï¼Œæ¯ä¸ªbucketä¸­æˆ‘ä»¬å¹¶æ²¡æœ‰ç»´æŠ¤ä¸€ä¸ªLRUé“¾è¡¨ï¼Œè€Œæ˜¯è®¤ä¸ºå¼•ç”¨è®¡æ•°ä¸º0ä¸”æ—¶é—´æˆ³æœ€å°çš„çš„bufferæ˜¯æ²¡æœ‰è¢«ä»»ä½•è¿›ç¨‹ä½¿ç”¨çš„ï¼Œæ•…åœ¨å¼•ç”¨è®¡æ•°ä¸º0æ—¶ï¼Œåªéœ€è¦æ›´æ–°bufferçš„æ—¶é—´æˆ³å³å¯ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#078;font-weight:700>void</span>
</span></span><span style=display:flex><span><span style=color:#c0f>brelse</span>(<span style=color:#069;font-weight:700>struct</span> buf <span style=color:#555>*</span>b)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>if</span>(<span style=color:#555>!</span><span style=color:#c0f>holdingsleep</span>(<span style=color:#555>&amp;</span>b<span style=color:#555>-&gt;</span>lock))
</span></span><span style=display:flex><span>    <span style=color:#c0f>panic</span>(<span style=color:#c30>&#34;brelse&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#c0f>releasesleep</span>(<span style=color:#555>&amp;</span>b<span style=color:#555>-&gt;</span>lock);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#078;font-weight:700>int</span> idx <span style=color:#555>=</span> <span style=color:#c0f>BLOCK_HASH</span>(b<span style=color:#555>-&gt;</span>blockno);
</span></span><span style=display:flex><span>  <span style=color:#c0f>acquire</span>(<span style=color:#555>&amp;</span>bcache.bk_lock[idx]);
</span></span><span style=display:flex><span>  b<span style=color:#555>-&gt;</span>refcnt<span style=color:#555>--</span>;
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>if</span> (b<span style=color:#555>-&gt;</span>refcnt <span style=color:#555>==</span> <span style=color:#f60>0</span>) {
</span></span><span style=display:flex><span>    <span style=color:#09f;font-style:italic>// no one is waiting for it.
</span></span></span><span style=display:flex><span>    b<span style=color:#555>-&gt;</span>timestamp <span style=color:#555>=</span> ticks; <span style=color:#09f;font-style:italic>// æœªä½¿ç”¨çš„bufferçš„æ—¶é—´æˆ³ä¸€å®šæ˜¯æœ€å°çš„
</span></span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#c0f>release</span>(<span style=color:#555>&amp;</span>bcache.bk_lock[idx]);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å¯¹äºbcacheæœ€é‡è¦çš„<code>bget()</code>å‡½æ•°ï¼Œæˆ‘ä»¬é‡æ„çš„æ€è·¯ä¸ºï¼š</p><ol><li>æ£€æŸ¥æ ‡å·ä¸ºblocknoçš„å—çš„ç¼“å­˜æ˜¯å¦åœ¨cacheä¸­ï¼Œå¦‚æœåœ¨ï¼Œåˆ™å…¶å¼•ç”¨è®¡æ•°+1ï¼Œè¿”å›è¯¥ç¼“å­˜å—</li><li>åœ¨ç¼“å­˜ä¸­æ²¡æœ‰æ‰¾åˆ°ï¼Œå…ˆåœ¨ç¼“å†²å—æ± ä¸­å¯»æ‰¾è¿˜æœªåˆ†é…ç»™bucketçš„ç¼“å­˜å—</li><li>å¦‚æœç¼“å†²å—æ± ä¸­éƒ½åˆ†é…å‡ºå»äº†ï¼Œå°±åˆ°æ¯ä¸ªbucketä¸­å»æ‰¾ã€‚å¦‚æœå½“å‰éå†çš„bucketä¸­æœ‰bufferçš„å¼•ç”¨è®¡æ•°ä¸º0ï¼Œæ‹¿åˆ°å…¶ä¸­æ—¶é—´æˆ³æœ€å°çš„bufferï¼ˆè¿™ä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªbufferæ˜¯è·ç¦»ç°åœ¨æœ€ä¹…æ²¡æœ‰ä½¿ç”¨çš„åˆæ³•å—ï¼‰<ul><li>å¦‚æœè¿™ä¸ªbufferåœ¨åŸå…ˆçš„bucketä¸­ï¼Œè¿”å›è¿™ä¸ªbuffer</li><li>å¦åˆ™éœ€è¦å°†è¿™ä¸ªbufferä»å½“å‰bucketä¸­è½¬ç§»åˆ°ç›®æ ‡bucketä¸­</li></ul></li></ol><p>è¿™æ˜¯ä¸€ä¸ªå¤§è‡´çš„æ€è·¯ï¼Œå…·ä½“ç»†èŠ‚å‚è€ƒå¦‚ä¸‹ä»£ç ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#069;font-weight:700>static</span> <span style=color:#069;font-weight:700>struct</span> buf<span style=color:#555>*</span>
</span></span><span style=display:flex><span><span style=color:#c0f>bget</span>(uint dev, uint blockno)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>struct</span> buf <span style=color:#555>*</span>b;
</span></span><span style=display:flex><span>  <span style=color:#078;font-weight:700>int</span> bucket_idx <span style=color:#555>=</span> <span style=color:#c0f>BLOCK_HASH</span>(blockno);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>// å…ˆå¯¹blocknoå¯¹åº”çš„bucketä¸Šé”å³å¯
</span></span></span><span style=display:flex><span>  <span style=color:#c0f>acquire</span>(<span style=color:#555>&amp;</span>bcache.bk_lock[bucket_idx]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>// Is the block already cached?
</span></span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>for</span>(b <span style=color:#555>=</span> <span style=color:#555>&amp;</span>bcache.bucket[bucket_idx]; b; b <span style=color:#555>=</span> b<span style=color:#555>-&gt;</span>next){
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>if</span>(b<span style=color:#555>-&gt;</span>dev <span style=color:#555>==</span> dev <span style=color:#555>&amp;&amp;</span> b<span style=color:#555>-&gt;</span>blockno <span style=color:#555>==</span> blockno){
</span></span><span style=display:flex><span>      b<span style=color:#555>-&gt;</span>refcnt<span style=color:#555>++</span>;
</span></span><span style=display:flex><span>      <span style=color:#c0f>release</span>(<span style=color:#555>&amp;</span>bcache.bk_lock[bucket_idx]);
</span></span><span style=display:flex><span>      <span style=color:#c0f>acquiresleep</span>(<span style=color:#555>&amp;</span>b<span style=color:#555>-&gt;</span>lock);
</span></span><span style=display:flex><span>      <span style=color:#069;font-weight:700>return</span> b;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>// åœ¨ç¼“å­˜ä¸­æ²¡æœ‰æ‰¾åˆ°ï¼Œå…ˆåœ¨ç¼“å†²å—æ± ä¸­å¯»æ‰¾è¿˜æœªåˆ†é…ç»™bucketçš„ç¼“å­˜å—
</span></span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>// éœ€è¦ä½¿ç”¨å…¨å±€é”æ¥ä¿è¯bcache.size++çš„åŸå­æ€§
</span></span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>// è¿™é‡Œä¹Ÿæ˜¯ä¸ºä»€ä¹ˆbufferæ—¶é—´æˆ³ä¸éœ€è¦åˆå§‹åŒ–çš„åŸå› ï¼šæ¯ä¸€æ¬¡éœ€è¦ä½¿ç”¨bufferæ—¶ï¼ˆä¼šè°ƒç”¨bgetï¼‰ï¼Œ
</span></span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>// å¦‚æœbufferæ± ä¸­è¿˜æœ‰ç©ºé—²bufferï¼Œåˆ™ä¼šç›´æ¥ä½¿ç”¨è¿™ä¸ªbufferï¼Œå®Œæˆæ“ä½œåä¼šè°ƒç”¨releseé‡Šæ”¾bufferï¼Œæ­¤æ—¶å°±ä¼šæ›´æ–°bufferçš„æ—¶é—´æˆ³
</span></span></span><span style=display:flex><span>  <span style=color:#c0f>acquire</span>(<span style=color:#555>&amp;</span>bcache.g_lock);
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>if</span> (bcache.size <span style=color:#555>&lt;</span> NBUF) {
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>struct</span> buf <span style=color:#555>*</span>b <span style=color:#555>=</span> <span style=color:#555>&amp;</span>bcache.buf[bcache.size<span style=color:#555>++</span>];
</span></span><span style=display:flex><span>    b<span style=color:#555>-&gt;</span>next <span style=color:#555>=</span> bcache.bucket[bucket_idx].next;
</span></span><span style=display:flex><span>    bcache.bucket[bucket_idx].next <span style=color:#555>=</span> b;
</span></span><span style=display:flex><span>    b<span style=color:#555>-&gt;</span>dev <span style=color:#555>=</span> dev;
</span></span><span style=display:flex><span>    b<span style=color:#555>-&gt;</span>blockno <span style=color:#555>=</span> blockno;
</span></span><span style=display:flex><span>    b<span style=color:#555>-&gt;</span>valid <span style=color:#555>=</span> <span style=color:#f60>0</span>;
</span></span><span style=display:flex><span>    b<span style=color:#555>-&gt;</span>refcnt <span style=color:#555>=</span> <span style=color:#f60>1</span>;
</span></span><span style=display:flex><span>    <span style=color:#c0f>release</span>(<span style=color:#555>&amp;</span>bcache.g_lock);
</span></span><span style=display:flex><span>    <span style=color:#c0f>acquiresleep</span>(<span style=color:#555>&amp;</span>b<span style=color:#555>-&gt;</span>lock);
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>return</span> b;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#c0f>release</span>(<span style=color:#555>&amp;</span>bcache.g_lock);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>// åœ¨è¿™æ—¶æ‰èƒ½é‡Šæ”¾è¯¥bucketçš„é”ï¼Œå‡è®¾åœ¨æ£€æŸ¥ç¼“å­˜æ˜¯å¦å­˜åœ¨åé‡Šæ”¾ï¼š
</span></span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>// å¦‚æœæœ‰ä¸¤ä¸ªè¿›ç¨‹1å’Œ2ï¼Œæ­¤æ—¶ç¼“å†²å—æ± è¿˜æœ‰å¤šä¸ªæœªåˆ†é…çš„å—ï¼Œè¿›ç¨‹1æ£€æŸ¥bucketï¼Œå‘ç°æ²¡æœ‰ç¼“å­˜ï¼Œé‡Šæ”¾é”ï¼Œå‡†å¤‡å»ç¼“å†²å—æ± ä¸­æ‹¿
</span></span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>// æ­¤æ—¶åˆ‡æ¢åˆ°è¿›ç¨‹2ï¼Œè¿›ç¨‹2æ£€æŸ¥bucket,å‘ç°æ²¡æœ‰ç¼“å­˜ï¼Œä¹Ÿå»ç¼“å†²å—æ± ä¸­æ‹¿
</span></span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>// è¿™æ ·å°±ä¼šå¯¼è‡´bucketä¼šæ·»åŠ ä¸¤ä¸ªblocknoçš„ç¼“å†²å—
</span></span></span><span style=display:flex><span>  <span style=color:#c0f>release</span>(<span style=color:#555>&amp;</span>bcache.bk_lock[bucket_idx]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>// åœ¨æ¯ä¸ªbucketä¸­å»æ‰¾å¯ç”¨çš„buffer cache
</span></span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>for</span> (<span style=color:#078;font-weight:700>int</span> i <span style=color:#555>=</span> <span style=color:#f60>0</span>; i <span style=color:#555>&lt;</span> NBUCKET; i<span style=color:#555>++</span>) {
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>struct</span> buf <span style=color:#555>*</span>cur_buf, <span style=color:#555>*</span>pre_buf, <span style=color:#555>*</span>min_buf, <span style=color:#555>*</span>min_pre_buf;
</span></span><span style=display:flex><span>    uint min_timestamp <span style=color:#555>=</span> <span style=color:#555>-</span><span style=color:#f60>1</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c0f>acquire</span>(<span style=color:#555>&amp;</span>bcache.bk_lock[bucket_idx]);
</span></span><span style=display:flex><span>    pre_buf <span style=color:#555>=</span> <span style=color:#555>&amp;</span>bcache.bucket[bucket_idx];
</span></span><span style=display:flex><span>    cur_buf <span style=color:#555>=</span> pre_buf<span style=color:#555>-&gt;</span>next;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#09f;font-style:italic>// éå†bcache.bucket[bucket_idx]
</span></span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>while</span> (cur_buf) {
</span></span><span style=display:flex><span>      <span style=color:#09f;font-style:italic>// ä¸ºä»€ä¹ˆè¿™é‡Œéœ€è¦é‡æ–°æ£€æŸ¥ï¼Ÿè€ƒè™‘è¿™æ ·ä¸€ç§æƒ…å†µï¼š
</span></span></span><span style=display:flex><span>      <span style=color:#09f;font-style:italic>// å‡è®¾ç¼“å†²å—æ± ä¸­è¿˜æœ‰ä¸€ä¸ªæœªåˆ†é…çš„ï¼Œæ­¤æ—¶æœ‰ä¸¤ä¸ªè¿›ç¨‹ï¼Œè¿›ç¨‹1å’Œ2éƒ½éœ€è¦è®¿é—®åŒä¸€ä¸ªæ ‡å·blocknoçš„å—
</span></span></span><span style=display:flex><span>      <span style=color:#09f;font-style:italic>// è¿›ç¨‹1å…ˆæ‹¿åˆ°è¿™ä¸ªæœªåˆ†é…çš„ï¼Œå¹¶å°†å…¶æ”¾å…¥äº†å¯¹åº”çš„bucketä¸­
</span></span></span><span style=display:flex><span>      <span style=color:#09f;font-style:italic>// ä¹‹åè¿›ç¨‹2å‘ç°æ± ä¸­æ²¡æœ‰æœªåˆ†é…çš„äº†ï¼Œå¼€å§‹éå†æ‰€æœ‰bucketï¼Œ
</span></span></span><span style=display:flex><span>      <span style=color:#09f;font-style:italic>// å¦‚æœè¿™æ—¶ä¸é‡æ–°æ£€æŸ¥ä¸€ä¸‹blocknoå¯¹åº”çš„bucketï¼Œåˆ™ä¼šå¯¼è‡´ä¸€ä¸ªbucketä¸­æœ‰ä¸¤ä¸ªblocknoçš„å—
</span></span></span><span style=display:flex><span>      <span style=color:#069;font-weight:700>if</span> (bucket_idx <span style=color:#555>==</span> <span style=color:#c0f>BLOCK_HASH</span>(blockno) <span style=color:#555>&amp;&amp;</span> cur_buf<span style=color:#555>-&gt;</span>blockno <span style=color:#555>==</span> blockno <span style=color:#555>&amp;&amp;</span>
</span></span><span style=display:flex><span>          cur_buf<span style=color:#555>-&gt;</span>dev <span style=color:#555>==</span> dev) {
</span></span><span style=display:flex><span>        cur_buf<span style=color:#555>-&gt;</span>refcnt<span style=color:#555>++</span>;
</span></span><span style=display:flex><span>        <span style=color:#c0f>release</span>(<span style=color:#555>&amp;</span>bcache.bk_lock[bucket_idx]);
</span></span><span style=display:flex><span>        <span style=color:#c0f>acquiresleep</span>(<span style=color:#555>&amp;</span>cur_buf<span style=color:#555>-&gt;</span>lock);
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>return</span> cur_buf;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#09f;font-style:italic>// åªæœ‰å¼•ç”¨è®¡æ•°ä¸º0,å¹¶ä¸”æ—¶é—´æˆ³æœ€å°çš„ç¼“å†²å—æ‰å¯è¢«é‡æ–°åˆ†é…
</span></span></span><span style=display:flex><span>      <span style=color:#069;font-weight:700>if</span> (cur_buf<span style=color:#555>-&gt;</span>refcnt <span style=color:#555>==</span> <span style=color:#f60>0</span> <span style=color:#555>&amp;&amp;</span> cur_buf<span style=color:#555>-&gt;</span>timestamp <span style=color:#555>&lt;</span> min_timestamp) {
</span></span><span style=display:flex><span>        min_pre_buf <span style=color:#555>=</span> pre_buf;
</span></span><span style=display:flex><span>        min_buf <span style=color:#555>=</span> cur_buf;
</span></span><span style=display:flex><span>        min_timestamp <span style=color:#555>=</span> cur_buf<span style=color:#555>-&gt;</span>timestamp;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      pre_buf <span style=color:#555>=</span> cur_buf;
</span></span><span style=display:flex><span>      cur_buf <span style=color:#555>=</span> cur_buf<span style=color:#555>-&gt;</span>next;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#09f;font-style:italic>// åœ¨æœ¬è½®ä¸­æ‰¾åˆ°äº†å¯é‡æ–°åˆ†é…çš„ç¼“å†²å—
</span></span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>if</span> (min_buf) {
</span></span><span style=display:flex><span>      min_buf<span style=color:#555>-&gt;</span>dev <span style=color:#555>=</span> dev;
</span></span><span style=display:flex><span>      min_buf<span style=color:#555>-&gt;</span>blockno <span style=color:#555>=</span> blockno;
</span></span><span style=display:flex><span>      min_buf<span style=color:#555>-&gt;</span>valid <span style=color:#555>=</span> <span style=color:#f60>0</span>;
</span></span><span style=display:flex><span>      min_buf<span style=color:#555>-&gt;</span>refcnt <span style=color:#555>=</span> <span style=color:#f60>1</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#09f;font-style:italic>// æ˜¯è‡ªèº«bucketä¸­çš„ï¼Œä¸ç”¨åšè½¬ç§»æ“ä½œ
</span></span></span><span style=display:flex><span>      <span style=color:#069;font-weight:700>if</span> (bucket_idx <span style=color:#555>==</span> <span style=color:#c0f>BLOCK_HASH</span>(blockno)) {
</span></span><span style=display:flex><span>        <span style=color:#09f;font-style:italic>// release(&amp;bcache.hash_lock);
</span></span></span><span style=display:flex><span>        <span style=color:#c0f>release</span>(<span style=color:#555>&amp;</span>bcache.bk_lock[bucket_idx]);
</span></span><span style=display:flex><span>        <span style=color:#c0f>acquiresleep</span>(<span style=color:#555>&amp;</span>min_buf<span style=color:#555>-&gt;</span>lock);
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>return</span> min_buf;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#09f;font-style:italic>// æ˜¯å…¶ä»–bucketä¸­çš„ï¼Œéœ€è¦è½¬ç§»
</span></span></span><span style=display:flex><span>      <span style=color:#09f;font-style:italic>// å…ˆå°†ç›®æ ‡bucketä¸­çš„bufferç§»é™¤ï¼Œç„¶åé‡Šæ”¾é”
</span></span></span><span style=display:flex><span>      min_pre_buf<span style=color:#555>-&gt;</span>next <span style=color:#555>=</span> min_buf<span style=color:#555>-&gt;</span>next;
</span></span><span style=display:flex><span>      <span style=color:#c0f>release</span>(<span style=color:#555>&amp;</span>bcache.bk_lock[bucket_idx]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#09f;font-style:italic>// æ¥ç€è·å–blocknoå¯¹åº”çš„é”ï¼Œå¹¶å°†ä»ç›®æ ‡bucketä¸­ç§»é™¤çš„bufferæ”¾è‡³blocknoå¯¹åº”çš„bucketï¼Œè¿”å›è¯¥buffer
</span></span></span><span style=display:flex><span>      bucket_idx <span style=color:#555>=</span> <span style=color:#c0f>BLOCK_HASH</span>(blockno);
</span></span><span style=display:flex><span>      <span style=color:#c0f>acquire</span>(<span style=color:#555>&amp;</span>bcache.bk_lock[bucket_idx]);
</span></span><span style=display:flex><span>      min_buf<span style=color:#555>-&gt;</span>next <span style=color:#555>=</span> bcache.bucket[bucket_idx].next;
</span></span><span style=display:flex><span>      bcache.bucket[bucket_idx].next <span style=color:#555>=</span> min_buf;
</span></span><span style=display:flex><span>      <span style=color:#c0f>release</span>(<span style=color:#555>&amp;</span>bcache.bk_lock[bucket_idx]);
</span></span><span style=display:flex><span>      <span style=color:#c0f>acquiresleep</span>(<span style=color:#555>&amp;</span>min_buf<span style=color:#555>-&gt;</span>lock);
</span></span><span style=display:flex><span>      <span style=color:#069;font-weight:700>return</span> min_buf;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c0f>release</span>(<span style=color:#555>&amp;</span>bcache.bk_lock[bucket_idx]);
</span></span><span style=display:flex><span>    <span style=color:#09f;font-style:italic>// å¦‚æœåˆ°åº•äº†ï¼Œä»å¤´æ¥ï¼Œä¿è¯éå†æ¯ä¸€ä¸ªbucket
</span></span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>if</span> (<span style=color:#555>++</span>bucket_idx <span style=color:#555>==</span> NBUCKET) {
</span></span><span style=display:flex><span>      bucket_idx <span style=color:#555>=</span> <span style=color:#f60>0</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#c0f>panic</span>(<span style=color:#c30>&#34;bget: no buffers&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>bgetæ˜¯è¿™ä¸ªlabä¸­æœ€å¤æ‚çš„åœ°æ–¹ï¼Œå…¶å¤„ç†é€»è¾‘è™½ç„¶è¾ƒå¥½ç†è§£ï¼Œä½†æ˜¯å¤šä¸ªé”çš„æ“ä½œé¡ºåºå¾ˆè®©äººå¤´ç–¼ï¼Œéœ€è¦è€ƒè™‘åˆ°å¤šç§å¹¶å‘æƒ…å†µã€‚</p><h2 id=code-details>Code Details<a hidden class=anchor aria-hidden=true href=#code-details>#</a></h2><p>ä»£ç å®ç°è¯¦æƒ…è¯·è§Githubï¼š<a href=https://github.com/kerolt/xv6-labs-2023/commit/ccac48e8ae6b6dde3e7c747a77f4149232420901>https://github.com/kerolt/xv6-labs-2023/commit/ccac48e8ae6b6dde3e7c747a77f4149232420901</a></p><h2 id=reference>Reference<a hidden class=anchor aria-hidden=true href=#reference>#</a></h2><ul><li><a href=https://github.com/whileskies/xv6-labs-2020/blob/main/doc/Lab8-locks.md>https://github.com/whileskies/xv6-labs-2020/blob/main/doc/Lab8-locks.md</a></li><li><a href=https://blog.csdn.net/LostUnravel/article/details/121430900>https://blog.csdn.net/LostUnravel/article/details/121430900</a></li></ul></div><footer class=post-footer><nav class=paginav><a class=prev href=https://kerolt.github.io/posts/%E5%8A%A8%E6%89%8B%E5%AE%9E%E7%8E%B0x/mit6.s081/mit6.s081lab9-file-system/><span class=title>Â« Prev</span><br><span>ã€MIT6.S081ã€‘Lab9 file system</span>
</a><a class=next href=https://kerolt.github.io/posts/%E5%8A%A8%E6%89%8B%E5%AE%9E%E7%8E%B0x/mit6.s081/mit6.s081xv6%E8%BF%9B%E7%A8%8B%E8%B0%83%E5%BA%A6%E5%88%86%E6%9E%90/><span class=title>Next Â»</span><br><span>ã€MIT6.S081ã€‘xv6è¿›ç¨‹è°ƒåº¦åˆ†æ</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2026 <a href=https://kerolt.github.io/>Kerolt's Blog</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>