<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>ã€MIT6.S081ã€‘Lab2 system calls | Kerolt's Blog</title><meta name=keywords content="OS,MIT6-S081"><meta name=description content="å‰è¨€
è¿™ä¸ªlabå¼€å§‹æˆ‘ä»¬å°±æ­£å¼è¿›å…¥äº†xv6çš„ä¸–ç•Œäº†ï¼Œè¿™ä¸€æ¬¡æˆ‘ä»¬å¯ä»¥äº†è§£åˆ°å†…æ ¸ä¸­ç³»ç»Ÿè°ƒç”¨çš„æ³¨å†Œå’Œè¿è¡ŒåŸç†ï¼Œè¿™å¯ä»¥è¯´æ˜¯ä¹‹ålabçš„ä¸€ä¸ªåŸºçŸ³ã€‚"><meta name=author content="Kerolt"><link rel=canonical href=https://kerolt.github.io/posts/%E5%8A%A8%E6%89%8B%E5%AE%9E%E7%8E%B0x/mit6.s081/mit6.s081lab2-system-calls/><meta name=google-site-verification content="NpIO0KEIJS0CPRzTzQCbYQdSRIyb0Lspx"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="2300A23B82DB579A2DEA6261191AD771"><link crossorigin=anonymous href=/assets/css/stylesheet.d199633e3c87808066c2e8bc9bd7e520533fc0913d70b4aad6819b793dd38bbe.css integrity="sha256-0ZljPjyHgIBmwui8m9flIFM/wJE9cLSq1oGbeT3Ti74=" rel="preload stylesheet" as=style><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/cn-fontsource-source-han-serif-sc-vf@1.0.9/font.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-screen-web/style.css><link rel=icon href=https://kerolt.github.io/images/avatar/favicon.png><link rel=icon type=image/png sizes=16x16 href=https://kerolt.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://kerolt.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://kerolt.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://kerolt.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://kerolt.github.io/posts/%E5%8A%A8%E6%89%8B%E5%AE%9E%E7%8E%B0x/mit6.s081/mit6.s081lab2-system-calls/><script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css><script src=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js></script><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://kerolt.github.io/posts/%E5%8A%A8%E6%89%8B%E5%AE%9E%E7%8E%B0x/mit6.s081/mit6.s081lab2-system-calls/"><meta property="og:site_name" content="Kerolt's Blog"><meta property="og:title" content="ã€MIT6.S081ã€‘Lab2 system calls"><meta property="og:description" content="å‰è¨€ è¿™ä¸ªlabå¼€å§‹æˆ‘ä»¬å°±æ­£å¼è¿›å…¥äº†xv6çš„ä¸–ç•Œäº†ï¼Œè¿™ä¸€æ¬¡æˆ‘ä»¬å¯ä»¥äº†è§£åˆ°å†…æ ¸ä¸­ç³»ç»Ÿè°ƒç”¨çš„æ³¨å†Œå’Œè¿è¡ŒåŸç†ï¼Œè¿™å¯ä»¥è¯´æ˜¯ä¹‹ålabçš„ä¸€ä¸ªåŸºçŸ³ã€‚"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-10-28T00:00:00+00:00"><meta property="article:modified_time" content="2024-10-28T00:00:00+00:00"><meta property="article:tag" content="OS"><meta property="article:tag" content="MIT6-S081"><meta property="og:image" content="https://kerolt.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://kerolt.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="ã€MIT6.S081ã€‘Lab2 system calls"><meta name=twitter:description content="å‰è¨€
è¿™ä¸ªlabå¼€å§‹æˆ‘ä»¬å°±æ­£å¼è¿›å…¥äº†xv6çš„ä¸–ç•Œäº†ï¼Œè¿™ä¸€æ¬¡æˆ‘ä»¬å¯ä»¥äº†è§£åˆ°å†…æ ¸ä¸­ç³»ç»Ÿè°ƒç”¨çš„æ³¨å†Œå’Œè¿è¡ŒåŸç†ï¼Œè¿™å¯ä»¥è¯´æ˜¯ä¹‹ålabçš„ä¸€ä¸ªåŸºçŸ³ã€‚"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://kerolt.github.io/posts/"},{"@type":"ListItem","position":2,"name":"ã€MIT6.S081ã€‘Lab2 system calls","item":"https://kerolt.github.io/posts/%E5%8A%A8%E6%89%8B%E5%AE%9E%E7%8E%B0x/mit6.s081/mit6.s081lab2-system-calls/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"ã€MIT6.S081ã€‘Lab2 system calls","name":"ã€MIT6.S081ã€‘Lab2 system calls","description":"å‰è¨€ è¿™ä¸ªlabå¼€å§‹æˆ‘ä»¬å°±æ­£å¼è¿›å…¥äº†xv6çš„ä¸–ç•Œäº†ï¼Œè¿™ä¸€æ¬¡æˆ‘ä»¬å¯ä»¥äº†è§£åˆ°å†…æ ¸ä¸­ç³»ç»Ÿè°ƒç”¨çš„æ³¨å†Œå’Œè¿è¡ŒåŸç†ï¼Œè¿™å¯ä»¥è¯´æ˜¯ä¹‹ålabçš„ä¸€ä¸ªåŸºçŸ³ã€‚\n","keywords":["OS","MIT6-S081"],"articleBody":"å‰è¨€ è¿™ä¸ªlabå¼€å§‹æˆ‘ä»¬å°±æ­£å¼è¿›å…¥äº†xv6çš„ä¸–ç•Œäº†ï¼Œè¿™ä¸€æ¬¡æˆ‘ä»¬å¯ä»¥äº†è§£åˆ°å†…æ ¸ä¸­ç³»ç»Ÿè°ƒç”¨çš„æ³¨å†Œå’Œè¿è¡ŒåŸç†ï¼Œè¿™å¯ä»¥è¯´æ˜¯ä¹‹ålabçš„ä¸€ä¸ªåŸºçŸ³ã€‚\ntrace é¦–å…ˆï¼Œæˆ‘ä»¬è¦æ¸…æ¥šè¿™ä¸ªå®éªŒçš„ç›®çš„æ˜¯ä»€ä¹ˆï¼š\nIn this assignment you will add a system call tracing feature that may help you when debugging later labs. Youâ€™ll create a newÂ traceÂ system call that will control tracing. It should take one argument, an integer â€œmaskâ€, whose bits specify which system calls to trace. For example, to trace the fork system call, a program callsÂ trace(1 Â« SYS_fork), whereÂ SYS_forkÂ is a syscall number fromÂ kernel/syscall.h. You have to modify the xv6 kernel to print out a line when each system call is about to return, if the system callâ€™s number is set in the mask. The line should contain the process id, the name of the system call and the return value; you donâ€™t need to print the system call arguments. TheÂ traceÂ system call should enable tracing for the process that calls it and any children that it subsequently forks, but should not affect other processes.\nè¯‘ï¼šåœ¨Xv6çš„traceå‘½ä»¤ä¸­ï¼Œå®ƒåº”è¯¥æœ‰ä¸€ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ•´æ•°â€œæ©ç â€ï¼Œå…¶ä½æŒ‡å®šè¦è·Ÿè¸ªçš„ç³»ç»Ÿè°ƒç”¨ã€‚ä¾‹å¦‚ï¼Œè¦è·Ÿè¸ªforkç³»ç»Ÿè°ƒç”¨ï¼Œç¨‹åºè°ƒç”¨trace(1\u003c","wordCount":"1195","inLanguage":"en","image":"https://kerolt.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2024-10-28T00:00:00Z","dateModified":"2024-10-28T00:00:00Z","author":{"@type":"Person","name":"Kerolt"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://kerolt.github.io/posts/%E5%8A%A8%E6%89%8B%E5%AE%9E%E7%8E%B0x/mit6.s081/mit6.s081lab2-system-calls/"},"publisher":{"@type":"Organization","name":"Kerolt's Blog","logo":{"@type":"ImageObject","url":"https://kerolt.github.io/images/avatar/favicon.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://kerolt.github.io/ accesskey=h title="Kerolt's Blog (Alt + H)">Kerolt's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://kerolt.github.io/posts/ title=æ–‡ç« ><span>æ–‡ç« </span></a></li><li><a href=https://kerolt.github.io/categories/ title=åˆ†ç±»><span>åˆ†ç±»</span></a></li><li><a href=https://kerolt.github.io/tags/ title=æ ‡ç­¾><span>æ ‡ç­¾</span></a></li><li><a href=https://kerolt.github.io/archives/ title=å½’æ¡£><span>å½’æ¡£</span></a></li><li><a href=https://kerolt.github.io/about/ title=å…³äºæˆ‘><span>å…³äºæˆ‘</span></a></li><li><a href=https://kerolt.github.io/search/ title="ğŸ” (Alt + /)" accesskey=/><span>ğŸ”</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://kerolt.github.io/>Home</a>&nbsp;Â»&nbsp;<a href=https://kerolt.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">ã€MIT6.S081ã€‘Lab2 system calls</h1><div class=post-meta><span title='2024-10-28 00:00:00 +0000 UTC'>å‘å¸ƒäº2024-10-28</span>&nbsp;&nbsp;Â·&nbsp;&nbsp;Kerolt</div><ul class=post-tags><li><a href=https://kerolt.github.io/tags/os/>OS</a></li><li><a href=https://kerolt.github.io/tags/mit6-s081/>MIT6-S081</a></li></ul></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e5%89%8d%e8%a8%80 aria-label=å‰è¨€>å‰è¨€</a></li><li><a href=#trace aria-label=trace>trace</a><ul><li><a href=#mask%e6%98%af%e4%bb%80%e4%b9%88 aria-label=maskæ˜¯ä»€ä¹ˆï¼Ÿ>maskæ˜¯ä»€ä¹ˆï¼Ÿ</a></li><li><a href=#%e8%bf%9b%e7%a8%8b%e5%8f%8a%e5%85%b6%e5%ad%90%e8%bf%9b%e7%a8%8b%e5%a6%82%e4%bd%95%e8%8e%b7%e5%8f%96mask aria-label=è¿›ç¨‹åŠå…¶å­è¿›ç¨‹å¦‚ä½•è·å–maskï¼Ÿ>è¿›ç¨‹åŠå…¶å­è¿›ç¨‹å¦‚ä½•è·å–maskï¼Ÿ</a></li><li><a href=#%e5%a6%82%e4%bd%95%e8%b7%9f%e8%b8%aa%e7%b3%bb%e7%bb%9f%e8%b0%83%e7%94%a8 aria-label=å¦‚ä½•è·Ÿè¸ªç³»ç»Ÿè°ƒç”¨ï¼Ÿ>å¦‚ä½•è·Ÿè¸ªç³»ç»Ÿè°ƒç”¨ï¼Ÿ</a></li></ul></li><li><a href=#sysinfo aria-label=sysinfo>sysinfo</a><ul><li><a href=#%e8%ae%a1%e7%ae%97%e5%8f%af%e7%94%a8%e5%86%85%e5%ad%98%e5%ad%97%e8%8a%82%e6%95%b0 aria-label=è®¡ç®—å¯ç”¨å†…å­˜å­—èŠ‚æ•°>è®¡ç®—å¯ç”¨å†…å­˜å­—èŠ‚æ•°</a></li><li><a href=#%e8%ae%a1%e7%ae%97%e7%8a%b6%e6%80%81%e4%b8%ba%e6%9c%aa%e4%b8%ba%e4%bd%bf%e7%94%a8%e8%bf%9b%e7%a8%8b%e6%95%b0 aria-label=è®¡ç®—çŠ¶æ€ä¸ºæœªä¸ºä½¿ç”¨è¿›ç¨‹æ•°>è®¡ç®—çŠ¶æ€ä¸ºæœªä¸ºä½¿ç”¨è¿›ç¨‹æ•°</a></li><li><a href=#%e5%ae%8c%e6%88%90%e7%b3%bb%e7%bb%9f%e8%b0%83%e7%94%a8 aria-label=å®Œæˆç³»ç»Ÿè°ƒç”¨>å®Œæˆç³»ç»Ÿè°ƒç”¨</a></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h2 id=å‰è¨€>å‰è¨€<a hidden class=anchor aria-hidden=true href=#å‰è¨€>#</a></h2><p>è¿™ä¸ªlabå¼€å§‹æˆ‘ä»¬å°±æ­£å¼è¿›å…¥äº†xv6çš„ä¸–ç•Œäº†ï¼Œè¿™ä¸€æ¬¡æˆ‘ä»¬å¯ä»¥äº†è§£åˆ°å†…æ ¸ä¸­ç³»ç»Ÿè°ƒç”¨çš„æ³¨å†Œå’Œè¿è¡ŒåŸç†ï¼Œè¿™å¯ä»¥è¯´æ˜¯ä¹‹ålabçš„ä¸€ä¸ªåŸºçŸ³ã€‚</p><h2 id=trace>trace<a hidden class=anchor aria-hidden=true href=#trace>#</a></h2><p>é¦–å…ˆï¼Œæˆ‘ä»¬è¦æ¸…æ¥šè¿™ä¸ªå®éªŒçš„ç›®çš„æ˜¯ä»€ä¹ˆï¼š</p><blockquote><p>In this assignment you will add a system call tracing feature that may help you when debugging later labs. You&rsquo;ll create a newÂ traceÂ system call that will control tracing. It should take one argument, an integer &ldquo;mask&rdquo;, whose bits specify which system calls to trace. For example, to trace the fork system call, a program callsÂ trace(1 &#171; SYS_fork), whereÂ SYS_forkÂ is a syscall number fromÂ kernel/syscall.h. You have to modify the xv6 kernel to print out a line when each system call is about to return, if the system call&rsquo;s number is set in the mask. The line should contain the process id, the name of the system call and the return value; you don&rsquo;t need to print the system call arguments. TheÂ traceÂ system call should enable tracing for the process that calls it and any children that it subsequently forks, but should not affect other processes.</p></blockquote><p>è¯‘ï¼šåœ¨Xv6çš„traceå‘½ä»¤ä¸­ï¼Œå®ƒåº”è¯¥æœ‰ä¸€ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ•´æ•°â€œæ©ç â€ï¼Œå…¶ä½æŒ‡å®šè¦è·Ÿè¸ªçš„ç³»ç»Ÿè°ƒç”¨ã€‚ä¾‹å¦‚ï¼Œè¦è·Ÿè¸ªforkç³»ç»Ÿè°ƒç”¨ï¼Œç¨‹åºè°ƒç”¨<code>trace(1&lt;&lt;SYS_fork)</code>ï¼Œå…¶ä¸­SYS_forkæ˜¯<code>kernel/syscall.h</code>ä¸­çš„ç³»ç»Ÿè°ƒç”¨ç¼–å·ã€‚å¦‚æœç³»ç»Ÿè°ƒç”¨çš„ç¼–å·åœ¨æ©ç ä¸­è®¾ç½®ï¼Œåˆ™å¿…é¡»ä¿®æ”¹xv6å†…æ ¸ï¼Œä»¥ä¾¿åœ¨æ¯ä¸ªç³»ç»Ÿè°ƒç”¨å³å°†è¿”å›æ—¶æ‰“å°å‡ºä¸€è¡Œã€‚è¯¥è¡Œåº”åŒ…å«<strong>è¿›ç¨‹id</strong>ã€<strong>ç³»ç»Ÿè°ƒç”¨çš„åç§°</strong>å’Œ<strong>è¿”å›å€¼</strong>ï¼›æ‚¨ä¸éœ€è¦æ‰“å°ç³»ç»Ÿè°ƒç”¨å‚æ•°ã€‚è·Ÿè¸ªç³»ç»Ÿè°ƒç”¨åº”å¯ç”¨å¯¹è°ƒç”¨å®ƒçš„è¿›ç¨‹åŠå…¶éšååˆ†å‰çš„ä»»ä½•<strong>å­è¿›ç¨‹</strong>çš„è·Ÿè¸ªï¼Œä½†ä¸åº”å½±å“å…¶ä»–è¿›ç¨‹ã€‚</p><p>æ³¨æ„ï¼Œåœ¨è¯¥å®éªŒçš„åˆå§‹é˜¶æ®µï¼Œxv6å·²ç»ä¸ºæˆ‘ä»¬æä¾›äº†traceå‘½ä»¤çš„ç”¨æˆ·æ€å®ç°ï¼Œä½†æ˜¯å…¶åº•å±‚çš„ç³»ç»Ÿè°ƒç”¨éœ€è¦æˆ‘ä»¬è‡ªå·±å®ç°ã€‚</p><h3 id=maskæ˜¯ä»€ä¹ˆ>maskæ˜¯ä»€ä¹ˆï¼Ÿ<a hidden class=anchor aria-hidden=true href=#maskæ˜¯ä»€ä¹ˆ>#</a></h3><p>åœ¨ä½¿ç”¨traceå‘½ä»¤æ—¶ç”¨åˆ°çš„æ©ç ï¼Œæ˜¯ç”¨æ¥è·Ÿè¸ªä¹‹åä½¿ç”¨çš„å‘½ä»¤ç”¨åˆ°äº†å“ªäº›ç³»ç»Ÿè°ƒç”¨ã€‚ä¾‹å¦‚å®éªŒä¸­ç»™å‡ºçš„ä¾‹å­ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ trace <span style=color:#f60>32</span> grep hello README
</span></span><span style=display:flex><span>3: syscall <span style=color:#366>read</span> -&gt; <span style=color:#f60>1023</span>
</span></span><span style=display:flex><span>3: syscall <span style=color:#366>read</span> -&gt; <span style=color:#f60>966</span>
</span></span><span style=display:flex><span>3: syscall <span style=color:#366>read</span> -&gt; <span style=color:#f60>70</span>
</span></span><span style=display:flex><span>3: syscall <span style=color:#366>read</span> -&gt; <span style=color:#f60>0</span>
</span></span></code></pre></div><p>è¿™ä¸ª32å°±æ˜¯æ©ç ï¼Œå…¶è·Ÿè¸ªåˆ°äº†grepå‘½ä»¤ä¸­ä½¿ç”¨åˆ°äº†readç³»ç»Ÿè°ƒç”¨ï¼ˆä¸ºä»€ä¹ˆæ˜¯readï¼Ÿé©¬ä¸Šå°±è¯´åˆ°äº†ï¼‰ã€‚åœ¨xv6çš„<code>kernel/syscall.h</code>ä¸­æœ‰æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨çš„ç¼–å·ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#09f;font-style:italic>// System call numbers
</span></span></span><span style=display:flex><span><span style=color:#099>#define SYS_fork    1
</span></span></span><span style=display:flex><span><span style=color:#099>#define SYS_exit    2
</span></span></span><span style=display:flex><span><span style=color:#099>#define SYS_wait    3
</span></span></span><span style=display:flex><span><span style=color:#099>#define SYS_pipe    4
</span></span></span><span style=display:flex><span><span style=color:#099>#define SYS_read    5
</span></span></span><span style=display:flex><span><span style=color:#099>#define SYS_kill    6
</span></span></span><span style=display:flex><span><span style=color:#099>#define SYS_exec    7
</span></span></span><span style=display:flex><span><span style=color:#099>#define SYS_fstat   8
</span></span></span><span style=display:flex><span><span style=color:#099>#define SYS_chdir   9
</span></span></span><span style=display:flex><span><span style=color:#099>#define SYS_dup    10
</span></span></span><span style=display:flex><span><span style=color:#099>#define SYS_getpid 11
</span></span></span><span style=display:flex><span><span style=color:#099>#define SYS_sbrk   12
</span></span></span><span style=display:flex><span><span style=color:#099>#define SYS_sleep  13
</span></span></span><span style=display:flex><span><span style=color:#099>#define SYS_uptime 14
</span></span></span><span style=display:flex><span><span style=color:#099>#define SYS_open   15
</span></span></span><span style=display:flex><span><span style=color:#099>#define SYS_write  16
</span></span></span><span style=display:flex><span><span style=color:#099>#define SYS_mknod  17
</span></span></span><span style=display:flex><span><span style=color:#099>#define SYS_unlink 18
</span></span></span><span style=display:flex><span><span style=color:#099>#define SYS_link   19
</span></span></span><span style=display:flex><span><span style=color:#099>#define SYS_mkdir  20
</span></span></span><span style=display:flex><span><span style=color:#099>#define SYS_close  21
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>// æ·»åŠ 
</span></span></span><span style=display:flex><span><span style=color:#099>#define SYS_trace  22 
</span></span></span></code></pre></div><p>å°†è¿™ä¸ªmaskä»¥äºŒè¿›åˆ¶çš„å½¢å¼æ¥çœ‹å¾…æ›´åŠ å®¹æ˜“ç†è§£ï¼Œå¦‚æœä¼ å…¥çš„maskæ˜¯32ï¼Œé‚£ä¹ˆå…¶äºŒè¿›åˆ¶ä¸º100000ï¼Œè¿™ä¸ª1å‡ºç°çš„ä½ç½®æ˜¯ç¬¬5ä½ï¼ˆæœ€ä½ä½æŒ‰0è®¡æ•°ï¼‰ï¼Œä¹Ÿå°±æ˜¯å»æ‰¾ç¼–å·ä¸º5çš„ç³»ç»Ÿè°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯<code>SYS_read</code>ã€‚</p><p>xv6å†…æ ¸æä¾›ç»™ç”¨æˆ·æ€çš„æ¥å£ä¸ºtraceï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦è‡ªå·±<strong>åœ¨xv6çš„ç”¨æˆ·å¤´æ–‡ä»¶ä¸­æ·»åŠ å‡½æ•°çš„å£°æ˜</strong>ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#09f;font-style:italic>// user/user.h
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>// ...
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#078;font-weight:700>int</span> <span style=color:#c0f>trace</span>(<span style=color:#078;font-weight:700>int</span>); 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>// ...
</span></span></span></code></pre></div><p>è¿™ä¸ªtraceåº•å±‚å…¶å®è°ƒç”¨çš„åº”è¯¥æ˜¯sys_traceï¼ˆè¿™ä¸ªå‡½æ•°åä¸æ˜¯å›ºå®šçš„ï¼Œä½†æ˜¯æºç ä¸­å…¶ä»–çš„ç³»ç»Ÿè°ƒç”¨çš„å‘½åéƒ½ä¸ºsys_*ï¼Œæ•…traceå¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨å†™æˆsys_traceæ›´åŠ åˆç†ï¼‰ã€‚sys_traceéœ€è¦åšçš„æ˜¯å°†ç”¨æˆ·ä¼ å…¥çš„maskå†ä¼ ç»™å½“å‰è¿›ç¨‹åŠå…¶å­è¿›ç¨‹ã€‚</p><p>æˆ‘ä»¬è¿™é‡Œ<strong>å°†ç³»ç»Ÿè°ƒç”¨sys_traceçš„ç¼–å·è®¾ç½®ä¸º22</strong>ã€‚</p><h3 id=è¿›ç¨‹åŠå…¶å­è¿›ç¨‹å¦‚ä½•è·å–mask>è¿›ç¨‹åŠå…¶å­è¿›ç¨‹å¦‚ä½•è·å–maskï¼Ÿ<a hidden class=anchor aria-hidden=true href=#è¿›ç¨‹åŠå…¶å­è¿›ç¨‹å¦‚ä½•è·å–mask>#</a></h3><p>åœ¨xv6 bookçš„4.3èŠ‚ä¸­ï¼Œæœ‰è¿™ä¹ˆä¸€æ®µè¯ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>	syscall (kernel/syscall.c:132) retrieves the system call number from the saved a7 in the trapframe and uses it to index into syscalls. For the first system call, a7 contains SYS_exec (kernel/syscall.h:8),  resulting in a call to the system call implementation function sys_exec.
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	When sys_exec returns, syscall records its return value in p-&gt;trapframe-&gt;a0. This will cause the original user-space call to exec() to return that value, since the C calling convention on RISC-V places return values in a0. System calls conventionally return negative numbers to indicate errors, and zero or positive numbers for success. If the system call number is invalid, syscall prints an error and returns âˆ’1.
</span></span></code></pre></div><p>å³ç³»ç»Ÿè°ƒç”¨çš„ç¼–å·ä¼šä¿å­˜åœ¨è¿›ç¨‹çš„trapframeä¸­ï¼Œæ ¹æ®a7å¯„å­˜å™¨å³å¯è·å¾—ï¼Œç³»ç»Ÿè°ƒç”¨çš„è¿”å›å€¼å¯é€šè¿‡a0å¯„å­˜å™¨è·å¾—ã€‚æ¬¸ï¼è¿™ä¸¤ä¸ªå€¼å¯ä¸å°±æ˜¯å®éªŒå®ç°ä¸­éœ€è¦çš„å—ï¼é‚£ä¹ˆç†æ‰€å½“ç„¶ï¼Œå®éªŒä¸­éœ€è¦æ‰“å°çš„è¯­å¥åº”è¯¥å°±åœ¨è¿™ä¸ªå‡½æ•°ä¸­æ·»åŠ ã€‚</p><p>è®©æˆ‘ä»¬æ¥çœ‹çœ‹xv6ä¸­è¿›ç¨‹çš„æ•°æ®ç»“æ„ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#09f;font-style:italic>// kernel/proc.h
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>struct</span> proc {
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>struct</span> spinlock lock;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>// p-&gt;lock must be held when using these:
</span></span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>enum</span> procstate state;        <span style=color:#09f;font-style:italic>// Process state
</span></span></span><span style=display:flex><span>  <span style=color:#078;font-weight:700>void</span> <span style=color:#555>*</span>chan;                  <span style=color:#09f;font-style:italic>// If non-zero, sleeping on chan
</span></span></span><span style=display:flex><span>  <span style=color:#078;font-weight:700>int</span> killed;                  <span style=color:#09f;font-style:italic>// If non-zero, have been killed
</span></span></span><span style=display:flex><span>  <span style=color:#078;font-weight:700>int</span> xstate;                  <span style=color:#09f;font-style:italic>// Exit status to be returned to parent&#39;s wait
</span></span></span><span style=display:flex><span>  <span style=color:#078;font-weight:700>int</span> pid;                     <span style=color:#09f;font-style:italic>// Process ID
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>// wait_lock must be held when using this:
</span></span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>struct</span> proc <span style=color:#555>*</span>parent;         <span style=color:#09f;font-style:italic>// Parent process
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>// these are private to the process, so p-&gt;lock need not be held.
</span></span></span><span style=display:flex><span>  uint64 kstack;               <span style=color:#09f;font-style:italic>// Virtual address of kernel stack
</span></span></span><span style=display:flex><span>  uint64 sz;                   <span style=color:#09f;font-style:italic>// Size of process memory (bytes)
</span></span></span><span style=display:flex><span>  <span style=color:#078;font-weight:700>pagetable_t</span> pagetable;       <span style=color:#09f;font-style:italic>// User page table
</span></span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>struct</span> trapframe <span style=color:#555>*</span>trapframe; <span style=color:#09f;font-style:italic>// data page for trampoline.S
</span></span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>struct</span> context context;      <span style=color:#09f;font-style:italic>// swtch() here to run process
</span></span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>struct</span> file <span style=color:#555>*</span>ofile[NOFILE];  <span style=color:#09f;font-style:italic>// Open files
</span></span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>struct</span> inode <span style=color:#555>*</span>cwd;           <span style=color:#09f;font-style:italic>// Current directory
</span></span></span><span style=display:flex><span>  <span style=color:#078;font-weight:700>char</span> name[<span style=color:#f60>16</span>];               <span style=color:#09f;font-style:italic>// Process name (debugging)
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>// æ·»åŠ 
</span></span></span><span style=display:flex><span>  <span style=color:#078;font-weight:700>int</span> trace_mask;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°è¯¸å¦‚è¿›ç¨‹åã€pidã€ä¸Šä¸‹æ–‡ç­‰ä¿¡æ¯éƒ½æ˜¯ä¿å­˜åœ¨è¿™ä¸ªæ•°æ®ç»“æ„ä¸­ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥<strong>åœ¨å…¶ä¸­åŠ ä¸Šä¸€ä¸ªæˆå‘˜å˜é‡ <code>trace_mask</code> ç”¨äºä¿å­˜å½“å‰è¿›ç¨‹æ‰€å¯¹åº”traceå‘½ä»¤ä¸­çš„æ©ç mask</strong>ã€‚</p><p>xv6å·²ç»å®ç°äº†ç”¨æˆ·æ€çš„traceå‘½ä»¤ï¼Œå…¶ä½äº <code>user/trace.c</code> ä¸­ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#099>#include</span> <span style=color:#099>&#34;kernel/param.h&#34;</span><span style=color:#099>
</span></span></span><span style=display:flex><span><span style=color:#099>#include</span> <span style=color:#099>&#34;kernel/types.h&#34;</span><span style=color:#099>
</span></span></span><span style=display:flex><span><span style=color:#099>#include</span> <span style=color:#099>&#34;kernel/stat.h&#34;</span><span style=color:#099>
</span></span></span><span style=display:flex><span><span style=color:#099>#include</span> <span style=color:#099>&#34;user/user.h&#34;</span><span style=color:#099>
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#078;font-weight:700>int</span>
</span></span><span style=display:flex><span><span style=color:#c0f>main</span>(<span style=color:#078;font-weight:700>int</span> argc, <span style=color:#078;font-weight:700>char</span> <span style=color:#555>*</span>argv[])
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#078;font-weight:700>int</span> i;
</span></span><span style=display:flex><span>  <span style=color:#078;font-weight:700>char</span> <span style=color:#555>*</span>nargv[MAXARG];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>if</span>(argc <span style=color:#555>&lt;</span> <span style=color:#f60>3</span> <span style=color:#555>||</span> (argv[<span style=color:#f60>1</span>][<span style=color:#f60>0</span>] <span style=color:#555>&lt;</span> <span style=color:#c30>&#39;0&#39;</span> <span style=color:#555>||</span> argv[<span style=color:#f60>1</span>][<span style=color:#f60>0</span>] <span style=color:#555>&gt;</span> <span style=color:#c30>&#39;9&#39;</span>)){
</span></span><span style=display:flex><span>    <span style=color:#c0f>fprintf</span>(<span style=color:#f60>2</span>, <span style=color:#c30>&#34;Usage: %s mask command</span><span style=color:#c30;font-weight:700>\n</span><span style=color:#c30>&#34;</span>, argv[<span style=color:#f60>0</span>]);
</span></span><span style=display:flex><span>    <span style=color:#c0f>exit</span>(<span style=color:#f60>1</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>if</span> (<span style=color:#c0f>trace</span>(<span style=color:#c0f>atoi</span>(argv[<span style=color:#f60>1</span>])) <span style=color:#555>&lt;</span> <span style=color:#f60>0</span>) {
</span></span><span style=display:flex><span>    <span style=color:#c0f>fprintf</span>(<span style=color:#f60>2</span>, <span style=color:#c30>&#34;%s: trace failed</span><span style=color:#c30;font-weight:700>\n</span><span style=color:#c30>&#34;</span>, argv[<span style=color:#f60>0</span>]);
</span></span><span style=display:flex><span>    <span style=color:#c0f>exit</span>(<span style=color:#f60>1</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>for</span>(i <span style=color:#555>=</span> <span style=color:#f60>2</span>; i <span style=color:#555>&lt;</span> argc <span style=color:#555>&amp;&amp;</span> i <span style=color:#555>&lt;</span> MAXARG; i<span style=color:#555>++</span>){
</span></span><span style=display:flex><span>    nargv[i<span style=color:#555>-</span><span style=color:#f60>2</span>] <span style=color:#555>=</span> argv[i];
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#c0f>exec</span>(nargv[<span style=color:#f60>0</span>], nargv);
</span></span><span style=display:flex><span>  <span style=color:#c0f>exit</span>(<span style=color:#f60>0</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å¯¹äºè¿™æ ·çš„ä¸€æ¡å‘½ä»¤ <code>trace 32 grep hello README</code> ï¼Œå‡è®¾å¼€å¯çš„è¿›ç¨‹åä¸ºpï¼Œé‚£ä¹ˆ32å°†ä¼šä¼ ç»™<code>p.trace_mask</code>ï¼Œä¹‹åçš„grepæ“ä½œå°†ä½¿ç”¨<code>exec</code><strong>åˆ›å»ºå­è¿›ç¨‹</strong>ï¼ˆå‡è®¾è¿›ç¨‹åä¸ºsonï¼‰æ‰§è¡Œï¼Œé‚£ä¹ˆåœ¨åˆ›å»ºå­è¿›ç¨‹ååº”è¯¥æœ‰<code>son.trace_mask = p.trace_mask</code>ï¼Œåªæœ‰è¿™æ ·ï¼Œgrepæ“ä½œæ‰€ç”¨åˆ°çš„ç³»ç»Ÿè°ƒç”¨æ‰èƒ½è¢«è·Ÿè¸ªåˆ°ã€‚</p><p>åœ¨ä½¿ç”¨traceå‘½ä»¤æ—¶ï¼Œå…¶åçš„maskå‚æ•°ä¼šå­˜åˆ°a0å¯„å­˜å™¨ä¸­ï¼Œä¸ºäº†ä»å…¶ä¸­æ‹¿åˆ°maskï¼Œå¯ä»¥ä½¿ç”¨<code>argint()</code>å‡½æ•°ï¼Œå…¶æºç ä¸ºï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#09f;font-style:italic>// kernel/syscall.h
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>// Fetch the nth 32-bit system call argument.
</span></span></span><span style=display:flex><span><span style=color:#078;font-weight:700>void</span> <span style=color:#c0f>argint</span>(<span style=color:#078;font-weight:700>int</span> n, <span style=color:#078;font-weight:700>int</span> <span style=color:#555>*</span>ip) {
</span></span><span style=display:flex><span>  <span style=color:#555>*</span>ip <span style=color:#555>=</span> <span style=color:#c0f>argraw</span>(n);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>static</span> uint64 <span style=color:#c0f>argraw</span>(<span style=color:#078;font-weight:700>int</span> n) {
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>struct</span> proc <span style=color:#555>*</span>p <span style=color:#555>=</span> <span style=color:#c0f>myproc</span>();
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>switch</span> (n) {
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>case</span> <span style=color:#f60>0</span><span style=color:#555>:</span>
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>return</span> p<span style=color:#555>-&gt;</span>trapframe<span style=color:#555>-&gt;</span>a0;
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>case</span> <span style=color:#f60>1</span><span style=color:#555>:</span>
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>return</span> p<span style=color:#555>-&gt;</span>trapframe<span style=color:#555>-&gt;</span>a1;
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>case</span> <span style=color:#f60>2</span><span style=color:#555>:</span>
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>return</span> p<span style=color:#555>-&gt;</span>trapframe<span style=color:#555>-&gt;</span>a2;
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>case</span> <span style=color:#f60>3</span><span style=color:#555>:</span>
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>return</span> p<span style=color:#555>-&gt;</span>trapframe<span style=color:#555>-&gt;</span>a3;
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>case</span> <span style=color:#f60>4</span><span style=color:#555>:</span>
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>return</span> p<span style=color:#555>-&gt;</span>trapframe<span style=color:#555>-&gt;</span>a4;
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>case</span> <span style=color:#f60>5</span><span style=color:#555>:</span>
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>return</span> p<span style=color:#555>-&gt;</span>trapframe<span style=color:#555>-&gt;</span>a5;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#c0f>panic</span>(<span style=color:#c30>&#34;argraw&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>return</span> <span style=color:#555>-</span><span style=color:#f60>1</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>argint()</code>å†…è°ƒç”¨äº†<code>argraw()</code>ï¼Œåœ¨æŸ¥çœ‹ä»¥ä¸Šæºç åï¼Œç”±äºåªä¼ å…¥äº†ä¸€ä¸ªå‚æ•°ï¼Œæ•…åº”è¯¥å°†0ä¼ å…¥argrawä¸­ã€‚<strong>åœ¨<code>kernel/sysproc.c</code>ä¸­å®ç°<code>sys_trace()</code></strong>ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#09f;font-style:italic>// kernel/sysproc.c
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>// ...
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>uint64 <span style=color:#c0f>sys_trace</span>(<span style=color:#078;font-weight:700>void</span>) {
</span></span><span style=display:flex><span>  <span style=color:#078;font-weight:700>int</span> mask;
</span></span><span style=display:flex><span>  <span style=color:#c0f>argint</span>(<span style=color:#f60>0</span>, <span style=color:#555>&amp;</span>mask);
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>if</span> (mask <span style=color:#555>&lt;</span> <span style=color:#f60>0</span>) <span style=color:#069;font-weight:700>return</span> <span style=color:#555>-</span><span style=color:#f60>1</span>;
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>struct</span> proc <span style=color:#555>*</span>p <span style=color:#555>=</span> <span style=color:#c0f>myproc</span>();
</span></span><span style=display:flex><span>  p<span style=color:#555>-&gt;</span>trace_mask <span style=color:#555>=</span> mask;
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>return</span> <span style=color:#f60>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¿™æ ·å½“traceä½¿ç”¨äº†åº•å±‚çš„sys_traceæ—¶ï¼Œå°±å¯ä»¥æŠŠmaskå‚æ•°ä¼ é€’ç»™å½“å‰è¿›ç¨‹ã€‚ä½†æ˜¯åªä¼ é€’ç»™å½“å‰è¿›ç¨‹è¿˜ä¸å¤Ÿï¼Œè¿˜è¦ä¼ ç»™å½“å‰è¿›ç¨‹çš„å­è¿›ç¨‹ã€‚åœ¨Linuxï¼Œæˆ‘ä»¬åˆ›å»ºå­è¿›ç¨‹çš„å‡½æ•°ä¸º<code>fork()</code>ï¼Œåœ¨xv6ä¸­ä¹ŸåŒæ ·å¦‚æ­¤ï¼Œforkå†…éƒ¨å…ˆè·å–å½“å‰è¿›ç¨‹çš„procç»“æ„ä½“ï¼Œç„¶åæ–°åˆ›å»ºä¸€ä¸ªprocç»“æ„ä½“ä»£è¡¨å­è¿›ç¨‹ï¼Œå¹¶å°†çˆ¶è¿›ç¨‹ä¸­çš„å€¼æ‹·è´è¿‡å»ï¼Œæ•…<strong>ä¼ é€’ç»™å­è¿›ç¨‹çš„maskä¹Ÿåœ¨å…¶ä¸­æ‹·è´</strong>ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#09f;font-style:italic>// kernel/proc.c
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#078;font-weight:700>int</span> <span style=color:#c0f>fork</span>(<span style=color:#078;font-weight:700>void</span>) {
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>// ...
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>// copy mask from father process to son process
</span></span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>// npä¸ºå­è¿›ç¨‹ï¼Œpä¸ºçˆ¶è¿›ç¨‹
</span></span></span><span style=display:flex><span>  np<span style=color:#555>-&gt;</span>trace_mask <span style=color:#555>=</span> p<span style=color:#555>-&gt;</span>trace_mask;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¦æ³¨æ„ä¸€ä¸ªå°ç»†èŠ‚ï¼Œ<strong>å½“è¿›ç¨‹ç»“æ„ä½“è¢«é‡Šæ”¾æ—¶ï¼ˆè¿›ç¨‹ç»“æŸæˆ–è€…ä¸ºè¿›ç¨‹åˆ†é…procç»“æ„ä½“ï¼‰ï¼Œå…¶maskä¹Ÿè¯¥é‡ç½®</strong>ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#09f;font-style:italic>// kernel/proc.c
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>static</span> <span style=color:#078;font-weight:700>void</span> <span style=color:#c0f>freeproc</span>(<span style=color:#069;font-weight:700>struct</span> proc <span style=color:#555>*</span>p) {
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>// ... ...
</span></span></span><span style=display:flex><span>  p<span style=color:#555>-&gt;</span>trace_mask <span style=color:#555>=</span> <span style=color:#f60>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å®Œæˆå¥½ä»¥ä¸Šå†…å®¹åï¼Œå°±å¯ä»¥<strong>å®ç°sys_trace</strong>äº†ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#09f;font-style:italic>// kernel/sysproc.c
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>uint64 <span style=color:#c0f>sys_trace</span>(<span style=color:#078;font-weight:700>void</span>) {
</span></span><span style=display:flex><span>  <span style=color:#078;font-weight:700>int</span> mask;
</span></span><span style=display:flex><span>  <span style=color:#c0f>argint</span>(<span style=color:#f60>0</span>, <span style=color:#555>&amp;</span>mask);
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>if</span> (mask <span style=color:#555>&lt;</span> <span style=color:#f60>0</span>) <span style=color:#069;font-weight:700>return</span> <span style=color:#555>-</span><span style=color:#f60>1</span>;
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>struct</span> proc <span style=color:#555>*</span>p <span style=color:#555>=</span> <span style=color:#c0f>myproc</span>();
</span></span><span style=display:flex><span>  p<span style=color:#555>-&gt;</span>trace_mask <span style=color:#555>=</span> mask;
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>return</span> <span style=color:#f60>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¿™æ ·ï¼Œå½“å‰è¿›ç¨‹å°±å¯ä»¥è·å–äº†åˆ°maskï¼Œå½“å…¶åˆ›å»ºå­è¿›ç¨‹æ—¶ï¼Œå­è¿›ç¨‹ä¹Ÿå¯è·å–åˆ°mask~</p><h3 id=å¦‚ä½•è·Ÿè¸ªç³»ç»Ÿè°ƒç”¨>å¦‚ä½•è·Ÿè¸ªç³»ç»Ÿè°ƒç”¨ï¼Ÿ<a hidden class=anchor aria-hidden=true href=#å¦‚ä½•è·Ÿè¸ªç³»ç»Ÿè°ƒç”¨>#</a></h3><p>åˆšåˆšæˆ‘ä»¬è¯´äº†maskçš„ä½œç”¨ï¼Œè¿˜æœ‰è¿›ç¨‹åŠå…¶å­è¿›ç¨‹å¦‚ä½•è·å–maskï¼Œé‚£ä¹ˆæˆ‘ä»¬åˆåº”è¯¥å¦‚ä½•è·Ÿè¸ªç³»ç»Ÿè°ƒç”¨å‘¢ï¼Ÿ</p><p>xv6ä¸­æ‰€ç”¨çš„ç³»ç»Ÿè°ƒç”¨éƒ½æ˜¯åœ¨ <code>kernel/syscall.c</code> ä¸­çš„ <code>syscall</code> å‡½æ•°ä¸­è°ƒç”¨çš„ï¼Œä¸ºäº†èƒ½åœ¨syscall.cä¸­è°ƒç”¨sys_traceï¼Œéœ€è¦åœ¨å…¶ä¸­<strong>æ·»åŠ externå£°æ˜</strong>ï¼ˆå…¶å®šä¹‰åœ¨åˆšåˆšå·²ç»å®ç°ï¼Œä½äºkernel/sysproc.cï¼‰ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#069;font-weight:700>extern</span> uint64 <span style=color:#c0f>sys_trace</span>(<span style=color:#078;font-weight:700>void</span>);
</span></span></code></pre></div><p>åŒæ—¶éœ€è¦<strong>åœ¨syscallsæ•°ç»„ä¸­æ·»åŠ sys_traceçš„ç¼–å·</strong>ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#069;font-weight:700>static</span> <span style=color:#c0f>uint64</span> (<span style=color:#555>*</span>syscalls[])(<span style=color:#078;font-weight:700>void</span>) <span style=color:#555>=</span> {
</span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>// ... ...
</span></span></span><span style=display:flex><span>[SYS_trace]   sys_trace,
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>// è¿™é‡Œå®é™…ä¸Šå°±æ˜¯ [22] = sys_trace
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>// ä½¿ç”¨äº†gccçš„ä¸€ä¸ªæ‹“å±•
</span></span></span></code></pre></div><p>å¹¶æŒ‰ç…§é¡ºåº<strong>æ·»åŠ å„ä¸ªç³»ç»Ÿè°ƒç”¨çš„åå­—</strong>ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#078;font-weight:700>char</span> <span style=color:#555>*</span>syscall_names[] <span style=color:#555>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#c30>&#34;fork&#34;</span>, <span style=color:#c30>&#34;exit&#34;</span>, <span style=color:#c30>&#34;wait&#34;</span>, <span style=color:#c30>&#34;pipe&#34;</span>, <span style=color:#c30>&#34;read&#34;</span>, <span style=color:#c30>&#34;kill&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#c30>&#34;exec&#34;</span>, <span style=color:#c30>&#34;fstat&#34;</span>, <span style=color:#c30>&#34;chdir&#34;</span>, <span style=color:#c30>&#34;dup&#34;</span>, <span style=color:#c30>&#34;getpid&#34;</span>, <span style=color:#c30>&#34;sbrk&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#c30>&#34;sleep&#34;</span>, <span style=color:#c30>&#34;uptime&#34;</span>, <span style=color:#c30>&#34;open&#34;</span>, <span style=color:#c30>&#34;write&#34;</span>, <span style=color:#c30>&#34;mknod&#34;</span>, <span style=color:#c30>&#34;unlink&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#c30>&#34;link&#34;</span>, <span style=color:#c30>&#34;mkdir&#34;</span>, <span style=color:#c30>&#34;close&#34;</span>, <span style=color:#c30>&#34;trace&#34;</span>,
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>åœ¨ <code>kernel/syscall.c</code> ä¸­ï¼Œxv6æ ¹æ®a7å¯„å­˜å™¨è·å–ç³»ç»Ÿè°ƒç”¨çš„ç¼–å·ï¼Œç„¶åé€šè¿‡syscallså‡½æ•°æ•°ç»„æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„å®ç°ä¸ºï¼šå½“ä½¿ç”¨çš„ç³»ç»Ÿè°ƒç”¨åˆæ³•æ—¶ï¼Œè·å–å½“å‰è¿›ç¨‹çš„maskï¼Œå¹¶é€šè¿‡åˆ¤æ–­<code>(mask >> syscall_num) & 1</code>æ˜¯å¦ä¸º1æ¥è¾“å‡ºè·Ÿè¸ªä¿¡æ¯ã€‚</p><p>ä¾‹å¦‚sys_readç³»ç»Ÿè°ƒç”¨çš„ç¼–å·ä¸º5ï¼Œmaskä¸º32ï¼Œåˆ™<code>(32 >> 5) & 1 = 1</code>ã€‚</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#078;font-weight:700>void</span> <span style=color:#c0f>syscall</span>(<span style=color:#078;font-weight:700>void</span>) {
</span></span><span style=display:flex><span>  <span style=color:#078;font-weight:700>int</span> num;
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>struct</span> proc <span style=color:#555>*</span>p <span style=color:#555>=</span> <span style=color:#c0f>myproc</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  num <span style=color:#555>=</span> p<span style=color:#555>-&gt;</span>trapframe<span style=color:#555>-&gt;</span>a7;
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>if</span>(num <span style=color:#555>&gt;</span> <span style=color:#f60>0</span> <span style=color:#555>&amp;&amp;</span> num <span style=color:#555>&lt;</span> <span style=color:#c0f>NELEM</span>(syscalls) <span style=color:#555>&amp;&amp;</span> syscalls[num]) {
</span></span><span style=display:flex><span>    <span style=color:#09f;font-style:italic>// Use num to lookup the system call function for num, call it,
</span></span></span><span style=display:flex><span>    <span style=color:#09f;font-style:italic>// and store its return value in p-&gt;trapframe-&gt;a0
</span></span></span><span style=display:flex><span>    p<span style=color:#555>-&gt;</span>trapframe<span style=color:#555>-&gt;</span>a0 <span style=color:#555>=</span> syscalls[num]();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#09f;font-style:italic>// ===============================
</span></span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>int</span> mask <span style=color:#555>=</span> p<span style=color:#555>-&gt;</span>trace_mask;
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>if</span> ((mask <span style=color:#555>&gt;&gt;</span> num) <span style=color:#555>&amp;</span> <span style=color:#f60>1</span>) {
</span></span><span style=display:flex><span>      <span style=color:#c0f>printf</span>(<span style=color:#c30>&#34;%d: syscall %s -&gt; %d</span><span style=color:#c30;font-weight:700>\n</span><span style=color:#c30>&#34;</span>, p<span style=color:#555>-&gt;</span>pid, syscall_names[num <span style=color:#555>-</span> <span style=color:#f60>1</span>], p<span style=color:#555>-&gt;</span>trapframe<span style=color:#555>-&gt;</span>a0);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#09f;font-style:italic>// ===============================
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  } <span style=color:#069;font-weight:700>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#c0f>printf</span>(<span style=color:#c30>&#34;%d %s: unknown sys call %d</span><span style=color:#c30;font-weight:700>\n</span><span style=color:#c30>&#34;</span>,
</span></span><span style=display:flex><span>            p<span style=color:#555>-&gt;</span>pid, p<span style=color:#555>-&gt;</span>name, num);
</span></span><span style=display:flex><span>    p<span style=color:#555>-&gt;</span>trapframe<span style=color:#555>-&gt;</span>a0 <span style=color:#555>=</span> <span style=color:#555>-</span><span style=color:#f60>1</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>é‚£ä¹ˆï¼Œå†…æ ¸æ˜¯å¦‚ä½•é€šè¿‡traceæ‰¾åˆ°sys_traceçš„å‘¢ï¼Ÿæ ¹æ®å®éªŒæŒ‡å¯¼ä¸Šçš„æç¤ºï¼Œå¯ä»¥çŸ¥é“ <code>user/usys.pl</code> èµ·åˆ°äº†ä¸€ä¸ªä¸­é—´äººçš„ä½œç”¨ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span># user/usys.pl
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sub entry {
</span></span><span style=display:flex><span>    my $name = shift;
</span></span><span style=display:flex><span>    print &#34;.global $name\n&#34;;
</span></span><span style=display:flex><span>    print &#34;${name}:\n&#34;;
</span></span><span style=display:flex><span>    print &#34; li a7, SYS_${name}\n&#34;;
</span></span><span style=display:flex><span>    print &#34; ecall\n&#34;;
</span></span><span style=display:flex><span>    print &#34; ret\n&#34;;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>entry(&#34;uptime&#34;);
</span></span><span style=display:flex><span><span style=background-color:#cfc>++entry(&#34;trace&#34;); # è¿™æ˜¯å®éªŒä¸­éœ€è¦ç”±æˆ‘ä»¬è‡ªå·±æ·»åŠ çš„
</span></span></span></code></pre></div><p>é€šè¿‡å…¶ä¸­çš„entryå‡½æ•°ï¼Œå¯ä»¥ç”Ÿæˆå¯¹åº”çš„è°ƒç”¨ï¼ˆxv6ä¸­ä¸ºecallï¼‰ç³»ç»Ÿè°ƒç”¨çš„æ±‡ç¼–è¯­å¥ï¼Œå³å¤§è‡´çš„æµç¨‹ä¸ºxv6åœ¨æ„å»ºå†…æ ¸æ—¶ï¼Œä¼šå°†ç”¨æˆ·æ€traceå‘½ä»¤å¯¹åº”åˆ°ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span><span style=color:#309>.global</span> <span style=color:#360>trace</span>
</span></span><span style=display:flex><span><span style=color:#99f>trace:</span>
</span></span><span style=display:flex><span>    <span style=color:#c0f>li</span> <span style=color:#360>a7</span>, <span style=color:#360>SYS_trace</span>
</span></span><span style=display:flex><span>    <span style=color:#c0f>ecall</span>
</span></span><span style=display:flex><span>    <span style=color:#c0f>ret</span>
</span></span></code></pre></div><p>è¿™æ ·ï¼Œå½“å‰è¿›ç¨‹å°±å¯ä»¥é€šè¿‡a7å¯„å­˜å™¨æ‹¿åˆ°sys_traceçš„ç³»ç»Ÿè°ƒç”¨ç¼–å·äº†ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>syscall</code> å‡½æ•°å¯ä»¥è°ƒç”¨ <code>sys_trace</code> äº†ã€‚</p><p>OKï¼Œé‚£ä¹ˆä¸€ä¸ªå¤§è‡´çš„æ¡†æ¶å°±å‡ºæ¥äº†ï¼š</p><p><div class=post-img-view><a data-fancybox=gallery href=https://s2.loli.net/2024/12/16/U2PElyAr1aZYxFe.png><img src=https://s2.loli.net/2024/12/16/U2PElyAr1aZYxFe.png alt></a></div></p><p>å®Œæˆä¸Šé¢çš„æ­¥éª¤åï¼Œæœ€ååªè¦åœ¨<code>Makefile</code>ä¸­çš„<code>UPROGS</code>åŠ ä¸Š<code>$U/_trace</code>å³å¯ã€‚</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>UPROGS=\
</span></span><span style=display:flex><span>	$U/_cat\
</span></span><span style=display:flex><span>	$U/_echo\
</span></span><span style=display:flex><span>	$U/_forktest\
</span></span><span style=display:flex><span>	$U/_grep\
</span></span><span style=display:flex><span>	$U/_init\
</span></span><span style=display:flex><span>	$U/_kill\
</span></span><span style=display:flex><span>	$U/_ln\
</span></span><span style=display:flex><span>	$U/_ls\
</span></span><span style=display:flex><span>	$U/_mkdir\
</span></span><span style=display:flex><span>	$U/_rm\
</span></span><span style=display:flex><span>	$U/_sh\
</span></span><span style=display:flex><span>	$U/_stressfs\
</span></span><span style=display:flex><span>	$U/_usertests\
</span></span><span style=display:flex><span>	$U/_grind\
</span></span><span style=display:flex><span>	$U/_wc\
</span></span><span style=display:flex><span>	$U/_zombie\
</span></span><span style=display:flex><span><span style=background-color:#cfc>++	$U/_trace
</span></span></span></code></pre></div><p>åœ¨è¿™ä¸ªlabä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨sysinfoï¼Œç”¨äºæ”¶é›†æœ‰å…³æ­£åœ¨è¿è¡Œçš„ç³»ç»Ÿçš„ä¿¡æ¯ã€‚</p><p>ç³»ç»Ÿè°ƒç”¨çš„å£°æ˜ä¸ºï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#078;font-weight:700>int</span> <span style=color:#c0f>sysinfo</span>(<span style=color:#069;font-weight:700>struct</span> sysinfo<span style=color:#555>*</span>);
</span></span></code></pre></div><p>è¿™ä¸ªç³»ç»Ÿè°ƒç”¨æ¥å—ä¸€ä¸ªæŒ‡å‘ç»“æ„ä½“sysinfoçš„æŒ‡é’ˆï¼Œå…¶å®šä¹‰ä¸ºï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#09f;font-style:italic>// kernel/sysinfo.h
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>struct</span> sysinfo {
</span></span><span style=display:flex><span>  uint64 freemem;   <span style=color:#09f;font-style:italic>// amount of free memory (bytes)
</span></span></span><span style=display:flex><span>  uint64 nproc;     <span style=color:#09f;font-style:italic>// number of process
</span></span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>å†…æ ¸åº”å¡«å†™æ­¤ç»“æ„çš„å­—æ®µï¼šfreememå­—æ®µåº”è®¾ç½®ä¸ºå¯ç”¨å†…å­˜çš„<strong>å­—èŠ‚æ•°</strong>ï¼Œnprocå­—æ®µåº”è®¾ä¸º<strong>çŠ¶æ€æœªä½¿ç”¨</strong>çš„è¿›ç¨‹æ•°ã€‚</p><h2 id=sysinfo>sysinfo<a hidden class=anchor aria-hidden=true href=#sysinfo>#</a></h2><p>åœ¨è¿™ä¸ªpartä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨sysinfoï¼Œç”¨äºæ”¶é›†æœ‰å…³æ­£åœ¨è¿è¡Œçš„ç³»ç»Ÿçš„ä¿¡æ¯ã€‚</p><h3 id=è®¡ç®—å¯ç”¨å†…å­˜å­—èŠ‚æ•°>è®¡ç®—å¯ç”¨å†…å­˜å­—èŠ‚æ•°<a hidden class=anchor aria-hidden=true href=#è®¡ç®—å¯ç”¨å†…å­˜å­—èŠ‚æ•°>#</a></h3><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡å†…æ ¸ä¸­çš„<code>kmem</code>æ¥è·å–å¯ç”¨çš„å†…å­˜å—çš„æ•°é‡ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#069;font-weight:700>struct</span> {
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>struct</span> spinlock lock;
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>struct</span> run <span style=color:#555>*</span>freelist;
</span></span><span style=display:flex><span>} kmem;
</span></span></code></pre></div><p><code>kmem.freelist</code>æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œä¿å­˜äº†æ‰€æœ‰<strong>å¯ç”¨</strong>çš„å†…å­˜å—çš„åœ°å€ï¼Œæˆ‘ä»¬éå†è¿™ä¸ªé“¾è¡¨å³å¯è·å–å¯ç”¨å†…å­˜å—æ•°é‡ï¼Œåˆä¸€ä¸ªå†…å­˜å—çš„å¤§å°ä¸º4KBï¼Œé‚£ä¹ˆ<code>ç³»ç»Ÿå¯ç”¨çš„å†…å­˜å­—èŠ‚æ•° = å¯ç”¨å†…å­˜å—æ•°é‡ * 4KB</code>ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#09f;font-style:italic>// kernel/kalloc.c
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>uint64 <span style=color:#c0f>freemem</span>() {
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>struct</span> run<span style=color:#555>*</span> r;
</span></span><span style=display:flex><span>  uint64 free_page <span style=color:#555>=</span> <span style=color:#f60>0</span>;
</span></span><span style=display:flex><span>  <span style=color:#c0f>acquire</span>(<span style=color:#555>&amp;</span>kmem.lock);
</span></span><span style=display:flex><span>  r <span style=color:#555>=</span> kmem.freelist;
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>while</span> (r) {
</span></span><span style=display:flex><span>    free_page<span style=color:#555>++</span>;
</span></span><span style=display:flex><span>    r <span style=color:#555>=</span> r<span style=color:#555>-&gt;</span>next;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#c0f>release</span>(<span style=color:#555>&amp;</span>kmem.lock);
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>// 4K = 2^12ï¼Œå·¦ç§»æ“ä½œç›¸å½“äºå¯¹2çš„ä¹˜æ³•
</span></span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>return</span> (free_page <span style=color:#555>&lt;&lt;</span> <span style=color:#f60>12</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=è®¡ç®—çŠ¶æ€ä¸ºæœªä¸ºä½¿ç”¨è¿›ç¨‹æ•°>è®¡ç®—çŠ¶æ€ä¸ºæœªä¸ºä½¿ç”¨è¿›ç¨‹æ•°<a hidden class=anchor aria-hidden=true href=#è®¡ç®—çŠ¶æ€ä¸ºæœªä¸ºä½¿ç”¨è¿›ç¨‹æ•°>#</a></h3><p>å†…æ ¸ä¸­æœ‰ä¸€ä¸ªå…¨å±€æ•°ç»„ï¼Œå…¶ä¸­æ¯ä¸€é¡¹ä¸ºç³»ç»Ÿä¸­çš„è¿›ç¨‹ï¼Œxv6ä¸­è®¾ç½®æœ€å¤šè¿›ç¨‹æ•°ä¸º64ä¸ªï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#069;font-weight:700>struct</span> proc proc[NPROC];
</span></span></code></pre></div><p>åœ¨è¡¨ç¤ºè¿›ç¨‹çš„ç»“æ„ä½“ä¸­ï¼Œæœ‰ä¸€ä¸ªæˆå‘˜è¡¨ç¤ºè¿™ä¸ªè¿›ç¨‹çš„çŠ¶æ€ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#069;font-weight:700>enum</span> procstate { UNUSED, USED, SLEEPING, RUNNABLE, RUNNING, ZOMBIE };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>// Per-process state
</span></span></span><span style=display:flex><span><span style=color:#069;font-weight:700>struct</span> proc {
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>  <span style=color:#09f;font-style:italic>// p-&gt;lock must be held when using these:
</span></span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>enum</span> procstate state; 
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æˆ‘ä»¬å¯ä»¥éå†procæ•°ç»„ï¼Œæ‰¾åˆ°æ‰€æœ‰<code>state != UNUSED</code>çš„è¿›ç¨‹çš„æ•°é‡ï¼ˆè¿™é‡Œä¸€å®šè¦çœ‹æ¸…æ¥šï¼Œæ˜¯<strong>çŠ¶æ€ä¸ºæœªä½¿ç”¨</strong>çš„è¿›ç¨‹æ•°ï¼Œè€Œä¸æ˜¯æœªä½¿ç”¨çš„è¿›ç¨‹æ•°ï¼‰ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#09f;font-style:italic>// kernel/proc.c
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>uint64 <span style=color:#c0f>nproc</span>() {
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>struct</span> proc<span style=color:#555>*</span> p;
</span></span><span style=display:flex><span>  uint64 not_unused <span style=color:#555>=</span> <span style=color:#f60>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>for</span> (p <span style=color:#555>=</span> proc; p <span style=color:#555>&lt;</span> <span style=color:#555>&amp;</span>proc[NPROC]; p<span style=color:#555>++</span>) {
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>if</span> (p<span style=color:#555>-&gt;</span>state <span style=color:#555>!=</span> UNUSED) {
</span></span><span style=display:flex><span>      not_unused<span style=color:#555>++</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>return</span> not_unused;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=å®Œæˆç³»ç»Ÿè°ƒç”¨>å®Œæˆç³»ç»Ÿè°ƒç”¨<a hidden class=anchor aria-hidden=true href=#å®Œæˆç³»ç»Ÿè°ƒç”¨>#</a></h3><blockquote><p>å¦‚ä½•è·å–ç”¨æˆ·æ€ä¼ é€’è¿‡æ¥çš„å‚æ•°å’Œæ³¨å†Œç³»ç»Ÿè°ƒç”¨å¯ä»¥å‚è€ƒè¿™ç¯‡<a href=https://kerolt.github.io/posts/18ad9abb/#%E5%A6%82%E4%BD%95%E8%B7%9F%E8%B8%AA%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%EF%BC%9F>åšå®¢</a>ï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°äº†</p></blockquote><p>æˆ‘ä»¬åˆ›å»ºäº†<code>struct sysinfo</code>ç»“æ„ä½“å˜é‡<code>info</code>åï¼Œä½¿ç”¨åˆšåˆšçš„<code>freemem</code>å’Œ<code>nproc</code>å‡½æ•°æ¥ä¸ºç»“æ„ä½“å˜é‡èµ‹å€¼ï¼Œä¹‹åé€šè¿‡<code>copyout</code>å‡½æ•°å°†å†…æ ¸æ€ä¸­çš„<code>info</code>æ‹·è´ç»™ç”¨æˆ·æ€çš„<code>struct sysinfo</code>ç»“æ„ä½“å˜é‡ã€‚</p><p>è¿™é‡Œçš„å®ç°åŸç†æ˜¯ï¼šç”¨æˆ·æ€ä¸‹æˆ‘ä»¬ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨ä¼ é€’äº†ä¸€ä¸ª<code>struct sysinfo</code>æŒ‡é’ˆï¼Œå…¶å®å°±æ˜¯ä¼ é€’äº†ä¸€ä¸ªå†…å­˜åœ°å€<code>addr</code>ï¼›å†…æ ¸æ€ä¸‹æˆ‘ä»¬å°†<code>info</code>ä¸­çš„æ•°æ®åŸå°ä¸åŠ¨åœ°æ¬ä¸€ä»½åˆ°<code>addr</code>å¤„ã€‚è¿™æ ·å½“ç”¨æˆ·æ€è®¿é—®<code>addr</code>å¤„çš„å†…å­˜æ—¶å°±å¯ä»¥è·å–åˆ°æƒ³è¦çš„æ•°æ®äº†ã€‚</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>uint64 <span style=color:#c0f>sys_sysinfo</span>() {
</span></span><span style=display:flex><span>  uint64 addr;
</span></span><span style=display:flex><span>  <span style=color:#c0f>argaddr</span>(<span style=color:#f60>0</span>, <span style=color:#555>&amp;</span>addr);
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>if</span> (addr <span style=color:#555>&lt;</span> <span style=color:#f60>0</span>) {
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>return</span> <span style=color:#555>-</span><span style=color:#f60>1</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>struct</span> proc<span style=color:#555>*</span> p <span style=color:#555>=</span> <span style=color:#c0f>myproc</span>();
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>struct</span> sysinfo info;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  info.freemem <span style=color:#555>=</span> <span style=color:#c0f>freemem</span>();
</span></span><span style=display:flex><span>  info.nproc <span style=color:#555>=</span> <span style=color:#c0f>nproc</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>if</span> (<span style=color:#c0f>copyout</span>(p<span style=color:#555>-&gt;</span>pagetable, addr, (<span style=color:#078;font-weight:700>char</span><span style=color:#555>*</span>)<span style=color:#555>&amp;</span>info, <span style=color:#069;font-weight:700>sizeof</span>(info))) {
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>return</span> <span style=color:#555>-</span><span style=color:#f60>1</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#069;font-weight:700>return</span> <span style=color:#f60>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div><footer class=post-footer><nav class=paginav><a class=prev href=https://kerolt.github.io/posts/%E5%8A%A8%E6%89%8B%E5%AE%9E%E7%8E%B0x/mit6.s081/mit6.s081lab3-page-tables%E4%B8%8B/><span class=title>Â« Prev</span><br><span>ã€MIT6.S081ã€‘Lab3 page tablesï¼ˆä¸‹ï¼‰</span>
</a><a class=next href=https://kerolt.github.io/posts/%E5%8A%A8%E6%89%8B%E5%AE%9E%E7%8E%B0x/mit6.s081/mit6.s081lab1-utilities/><span class=title>Next Â»</span><br><span>ã€MIT6.S081ã€‘Lab1 utilities</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2026 <a href=https://kerolt.github.io/>Kerolt's Blog</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>