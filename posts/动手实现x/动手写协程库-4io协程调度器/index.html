<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>ã€åŠ¨æ‰‹å†™åç¨‹åº“ 4ã€‘IOåç¨‹è°ƒåº¦å™¨ | Kerolt's Blog</title><meta name=keywords content="Coroutine,CPlusPlus"><meta name=description content="
ã€åŠ¨æ‰‹å†™åç¨‹åº“ã€‘ç³»åˆ—ç¬”è®°æ˜¯å­¦ä¹ sylarçš„åç¨‹åº“æ—¶çš„è®°å½•ï¼Œå‚è€ƒäº†ä»é›¶å¼€å§‹é‡å†™sylar C++é«˜æ€§èƒ½åˆ†å¸ƒå¼æœåŠ¡å™¨æ¡†æ¶å’Œä»£ç éšæƒ³å½•ä¸­çš„æ–‡æ¡£ã€‚æ–‡ç« å¹¶ä¸æ˜¯å¯¹æ‰€æœ‰ä»£ç çš„è¯¦ç»†è§£é‡Šï¼Œè€Œæ˜¯ä¸ºäº†è‡ªå·±ç†è§£ä¸€äº›ç‰‡æ®µæ‰€åšçš„ç¬”è®°ã€‚
IOManagerç±»ä¸­å…·ä½“å®šä¹‰å®ç°å¯ä»¥åœ¨è¿™é‡ŒæŸ¥çœ‹ï¼šGithub: src/iomanager.cpp

ä¹‹å‰å®ç°çš„åç¨‹è°ƒåº¦å™¨çš„åŠŸèƒ½å…¶å®éå¸¸ç®€å•ï¼Œå½“æ·»åŠ ä»»åŠ¡åè°ƒåº¦å™¨åªæ˜¯å•çº¯çš„ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡äº¤ç»™åç¨‹å»æ‰§è¡Œã€‚sylarçš„åç¨‹åº“çš„å…³æ³¨å¯¹è±¡æ˜¯ç½‘ç»œIOï¼Œå¦‚æœé‡‡ç”¨è¿™ä¹ˆç®€å•çš„è°ƒåº¦å°±æ ¹æœ¬æ²¡æœ‰ç”¨åˆ°åç¨‹çš„ç²¾é«“ã€‚
sylarçš„IOåç¨‹è°ƒåº¦è§£å†³äº†ä¹‹å‰è°ƒåº¦å™¨åœ¨idleçŠ¶æ€ä¸‹å¿™ç­‰å¾…å¯¼è‡´CPUå ç”¨ç‡é«˜çš„é—®é¢˜ã€‚IOåç¨‹è°ƒåº¦å™¨ä½¿ç”¨ä¸€å¯¹ç®¡é“fdæ¥tickleè°ƒåº¦åç¨‹ï¼Œå½“è°ƒåº¦å™¨ç©ºé—²æ—¶ï¼Œidleåç¨‹é€šè¿‡epoll_waité˜»å¡åœ¨ç®¡é“çš„è¯»æè¿°ç¬¦ä¸Šï¼Œç­‰ç®¡é“çš„å¯è¯»äº‹ä»¶ã€‚æ·»åŠ æ–°ä»»åŠ¡æ—¶ï¼Œtickleæ–¹æ³•å†™ç®¡é“ï¼Œidleåç¨‹æ£€æµ‹åˆ°ç®¡é“å¯è¯»åé€€å‡ºï¼Œè°ƒåº¦å™¨æ‰§è¡Œè°ƒåº¦ã€‚"><meta name=author content="Kerolt"><link rel=canonical href=https://kerolt.github.io/posts/%E5%8A%A8%E6%89%8B%E5%AE%9E%E7%8E%B0x/%E5%8A%A8%E6%89%8B%E5%86%99%E5%8D%8F%E7%A8%8B%E5%BA%93-4io%E5%8D%8F%E7%A8%8B%E8%B0%83%E5%BA%A6%E5%99%A8/><meta name=google-site-verification content="NpIO0KEIJS0CPRzTzQCbYQdSRIyb0Lspx"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="2300A23B82DB579A2DEA6261191AD771"><link crossorigin=anonymous href=/assets/css/stylesheet.ef9ab3c5a056d4b92179b140aee474d5f961270bacb25621ebcfd8a244feac6a.css integrity="sha256-75qzxaBW1LkhebFAruR01flhJwusslYh68/YokT+rGo=" rel="preload stylesheet" as=style><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-screen-web/style.css><link rel=icon href=https://kerolt.github.io/images/avatar/favicon.png><link rel=icon type=image/png sizes=16x16 href=https://kerolt.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://kerolt.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://kerolt.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://kerolt.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://kerolt.github.io/posts/%E5%8A%A8%E6%89%8B%E5%AE%9E%E7%8E%B0x/%E5%8A%A8%E6%89%8B%E5%86%99%E5%8D%8F%E7%A8%8B%E5%BA%93-4io%E5%8D%8F%E7%A8%8B%E8%B0%83%E5%BA%A6%E5%99%A8/><script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css><script src=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js></script><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://kerolt.github.io/posts/%E5%8A%A8%E6%89%8B%E5%AE%9E%E7%8E%B0x/%E5%8A%A8%E6%89%8B%E5%86%99%E5%8D%8F%E7%A8%8B%E5%BA%93-4io%E5%8D%8F%E7%A8%8B%E8%B0%83%E5%BA%A6%E5%99%A8/"><meta property="og:site_name" content="Kerolt's Blog"><meta property="og:title" content="ã€åŠ¨æ‰‹å†™åç¨‹åº“ 4ã€‘IOåç¨‹è°ƒåº¦å™¨"><meta property="og:description" content=" ã€åŠ¨æ‰‹å†™åç¨‹åº“ã€‘ç³»åˆ—ç¬”è®°æ˜¯å­¦ä¹ sylarçš„åç¨‹åº“æ—¶çš„è®°å½•ï¼Œå‚è€ƒäº†ä»é›¶å¼€å§‹é‡å†™sylar C++é«˜æ€§èƒ½åˆ†å¸ƒå¼æœåŠ¡å™¨æ¡†æ¶å’Œä»£ç éšæƒ³å½•ä¸­çš„æ–‡æ¡£ã€‚æ–‡ç« å¹¶ä¸æ˜¯å¯¹æ‰€æœ‰ä»£ç çš„è¯¦ç»†è§£é‡Šï¼Œè€Œæ˜¯ä¸ºäº†è‡ªå·±ç†è§£ä¸€äº›ç‰‡æ®µæ‰€åšçš„ç¬”è®°ã€‚
IOManagerç±»ä¸­å…·ä½“å®šä¹‰å®ç°å¯ä»¥åœ¨è¿™é‡ŒæŸ¥çœ‹ï¼šGithub: src/iomanager.cpp
ä¹‹å‰å®ç°çš„åç¨‹è°ƒåº¦å™¨çš„åŠŸèƒ½å…¶å®éå¸¸ç®€å•ï¼Œå½“æ·»åŠ ä»»åŠ¡åè°ƒåº¦å™¨åªæ˜¯å•çº¯çš„ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡äº¤ç»™åç¨‹å»æ‰§è¡Œã€‚sylarçš„åç¨‹åº“çš„å…³æ³¨å¯¹è±¡æ˜¯ç½‘ç»œIOï¼Œå¦‚æœé‡‡ç”¨è¿™ä¹ˆç®€å•çš„è°ƒåº¦å°±æ ¹æœ¬æ²¡æœ‰ç”¨åˆ°åç¨‹çš„ç²¾é«“ã€‚
sylarçš„IOåç¨‹è°ƒåº¦è§£å†³äº†ä¹‹å‰è°ƒåº¦å™¨åœ¨idleçŠ¶æ€ä¸‹å¿™ç­‰å¾…å¯¼è‡´CPUå ç”¨ç‡é«˜çš„é—®é¢˜ã€‚IOåç¨‹è°ƒåº¦å™¨ä½¿ç”¨ä¸€å¯¹ç®¡é“fdæ¥tickleè°ƒåº¦åç¨‹ï¼Œå½“è°ƒåº¦å™¨ç©ºé—²æ—¶ï¼Œidleåç¨‹é€šè¿‡epoll_waité˜»å¡åœ¨ç®¡é“çš„è¯»æè¿°ç¬¦ä¸Šï¼Œç­‰ç®¡é“çš„å¯è¯»äº‹ä»¶ã€‚æ·»åŠ æ–°ä»»åŠ¡æ—¶ï¼Œtickleæ–¹æ³•å†™ç®¡é“ï¼Œidleåç¨‹æ£€æµ‹åˆ°ç®¡é“å¯è¯»åé€€å‡ºï¼Œè°ƒåº¦å™¨æ‰§è¡Œè°ƒåº¦ã€‚"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-09-29T00:00:00+00:00"><meta property="article:modified_time" content="2024-09-29T00:00:00+00:00"><meta property="article:tag" content="Coroutine"><meta property="article:tag" content="CPlusPlus"><meta property="og:image" content="https://kerolt.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://kerolt.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="ã€åŠ¨æ‰‹å†™åç¨‹åº“ 4ã€‘IOåç¨‹è°ƒåº¦å™¨"><meta name=twitter:description content="
ã€åŠ¨æ‰‹å†™åç¨‹åº“ã€‘ç³»åˆ—ç¬”è®°æ˜¯å­¦ä¹ sylarçš„åç¨‹åº“æ—¶çš„è®°å½•ï¼Œå‚è€ƒäº†ä»é›¶å¼€å§‹é‡å†™sylar C++é«˜æ€§èƒ½åˆ†å¸ƒå¼æœåŠ¡å™¨æ¡†æ¶å’Œä»£ç éšæƒ³å½•ä¸­çš„æ–‡æ¡£ã€‚æ–‡ç« å¹¶ä¸æ˜¯å¯¹æ‰€æœ‰ä»£ç çš„è¯¦ç»†è§£é‡Šï¼Œè€Œæ˜¯ä¸ºäº†è‡ªå·±ç†è§£ä¸€äº›ç‰‡æ®µæ‰€åšçš„ç¬”è®°ã€‚
IOManagerç±»ä¸­å…·ä½“å®šä¹‰å®ç°å¯ä»¥åœ¨è¿™é‡ŒæŸ¥çœ‹ï¼šGithub: src/iomanager.cpp

ä¹‹å‰å®ç°çš„åç¨‹è°ƒåº¦å™¨çš„åŠŸèƒ½å…¶å®éå¸¸ç®€å•ï¼Œå½“æ·»åŠ ä»»åŠ¡åè°ƒåº¦å™¨åªæ˜¯å•çº¯çš„ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡äº¤ç»™åç¨‹å»æ‰§è¡Œã€‚sylarçš„åç¨‹åº“çš„å…³æ³¨å¯¹è±¡æ˜¯ç½‘ç»œIOï¼Œå¦‚æœé‡‡ç”¨è¿™ä¹ˆç®€å•çš„è°ƒåº¦å°±æ ¹æœ¬æ²¡æœ‰ç”¨åˆ°åç¨‹çš„ç²¾é«“ã€‚
sylarçš„IOåç¨‹è°ƒåº¦è§£å†³äº†ä¹‹å‰è°ƒåº¦å™¨åœ¨idleçŠ¶æ€ä¸‹å¿™ç­‰å¾…å¯¼è‡´CPUå ç”¨ç‡é«˜çš„é—®é¢˜ã€‚IOåç¨‹è°ƒåº¦å™¨ä½¿ç”¨ä¸€å¯¹ç®¡é“fdæ¥tickleè°ƒåº¦åç¨‹ï¼Œå½“è°ƒåº¦å™¨ç©ºé—²æ—¶ï¼Œidleåç¨‹é€šè¿‡epoll_waité˜»å¡åœ¨ç®¡é“çš„è¯»æè¿°ç¬¦ä¸Šï¼Œç­‰ç®¡é“çš„å¯è¯»äº‹ä»¶ã€‚æ·»åŠ æ–°ä»»åŠ¡æ—¶ï¼Œtickleæ–¹æ³•å†™ç®¡é“ï¼Œidleåç¨‹æ£€æµ‹åˆ°ç®¡é“å¯è¯»åé€€å‡ºï¼Œè°ƒåº¦å™¨æ‰§è¡Œè°ƒåº¦ã€‚"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://kerolt.github.io/posts/"},{"@type":"ListItem","position":2,"name":"ã€åŠ¨æ‰‹å†™åç¨‹åº“ 4ã€‘IOåç¨‹è°ƒåº¦å™¨","item":"https://kerolt.github.io/posts/%E5%8A%A8%E6%89%8B%E5%AE%9E%E7%8E%B0x/%E5%8A%A8%E6%89%8B%E5%86%99%E5%8D%8F%E7%A8%8B%E5%BA%93-4io%E5%8D%8F%E7%A8%8B%E8%B0%83%E5%BA%A6%E5%99%A8/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"ã€åŠ¨æ‰‹å†™åç¨‹åº“ 4ã€‘IOåç¨‹è°ƒåº¦å™¨","name":"ã€åŠ¨æ‰‹å†™åç¨‹åº“ 4ã€‘IOåç¨‹è°ƒåº¦å™¨","description":" ã€åŠ¨æ‰‹å†™åç¨‹åº“ã€‘ç³»åˆ—ç¬”è®°æ˜¯å­¦ä¹ sylarçš„åç¨‹åº“æ—¶çš„è®°å½•ï¼Œå‚è€ƒäº†ä»é›¶å¼€å§‹é‡å†™sylar C++é«˜æ€§èƒ½åˆ†å¸ƒå¼æœåŠ¡å™¨æ¡†æ¶å’Œä»£ç éšæƒ³å½•ä¸­çš„æ–‡æ¡£ã€‚æ–‡ç« å¹¶ä¸æ˜¯å¯¹æ‰€æœ‰ä»£ç çš„è¯¦ç»†è§£é‡Šï¼Œè€Œæ˜¯ä¸ºäº†è‡ªå·±ç†è§£ä¸€äº›ç‰‡æ®µæ‰€åšçš„ç¬”è®°ã€‚\nIOManagerç±»ä¸­å…·ä½“å®šä¹‰å®ç°å¯ä»¥åœ¨è¿™é‡ŒæŸ¥çœ‹ï¼šGithub: src/iomanager.cpp\nä¹‹å‰å®ç°çš„åç¨‹è°ƒåº¦å™¨çš„åŠŸèƒ½å…¶å®éå¸¸ç®€å•ï¼Œå½“æ·»åŠ ä»»åŠ¡åè°ƒåº¦å™¨åªæ˜¯å•çº¯çš„ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡äº¤ç»™åç¨‹å»æ‰§è¡Œã€‚sylarçš„åç¨‹åº“çš„å…³æ³¨å¯¹è±¡æ˜¯ç½‘ç»œIOï¼Œå¦‚æœé‡‡ç”¨è¿™ä¹ˆç®€å•çš„è°ƒåº¦å°±æ ¹æœ¬æ²¡æœ‰ç”¨åˆ°åç¨‹çš„ç²¾é«“ã€‚\nsylarçš„IOåç¨‹è°ƒåº¦è§£å†³äº†ä¹‹å‰è°ƒåº¦å™¨åœ¨idleçŠ¶æ€ä¸‹å¿™ç­‰å¾…å¯¼è‡´CPUå ç”¨ç‡é«˜çš„é—®é¢˜ã€‚IOåç¨‹è°ƒåº¦å™¨ä½¿ç”¨ä¸€å¯¹ç®¡é“fdæ¥tickleè°ƒåº¦åç¨‹ï¼Œå½“è°ƒåº¦å™¨ç©ºé—²æ—¶ï¼Œidleåç¨‹é€šè¿‡epoll_waité˜»å¡åœ¨ç®¡é“çš„è¯»æè¿°ç¬¦ä¸Šï¼Œç­‰ç®¡é“çš„å¯è¯»äº‹ä»¶ã€‚æ·»åŠ æ–°ä»»åŠ¡æ—¶ï¼Œtickleæ–¹æ³•å†™ç®¡é“ï¼Œidleåç¨‹æ£€æµ‹åˆ°ç®¡é“å¯è¯»åé€€å‡ºï¼Œè°ƒåº¦å™¨æ‰§è¡Œè°ƒåº¦ã€‚\n","keywords":["Coroutine","CPlusPlus"],"articleBody":" ã€åŠ¨æ‰‹å†™åç¨‹åº“ã€‘ç³»åˆ—ç¬”è®°æ˜¯å­¦ä¹ sylarçš„åç¨‹åº“æ—¶çš„è®°å½•ï¼Œå‚è€ƒäº†ä»é›¶å¼€å§‹é‡å†™sylar C++é«˜æ€§èƒ½åˆ†å¸ƒå¼æœåŠ¡å™¨æ¡†æ¶å’Œä»£ç éšæƒ³å½•ä¸­çš„æ–‡æ¡£ã€‚æ–‡ç« å¹¶ä¸æ˜¯å¯¹æ‰€æœ‰ä»£ç çš„è¯¦ç»†è§£é‡Šï¼Œè€Œæ˜¯ä¸ºäº†è‡ªå·±ç†è§£ä¸€äº›ç‰‡æ®µæ‰€åšçš„ç¬”è®°ã€‚\nIOManagerç±»ä¸­å…·ä½“å®šä¹‰å®ç°å¯ä»¥åœ¨è¿™é‡ŒæŸ¥çœ‹ï¼šGithub: src/iomanager.cpp\nä¹‹å‰å®ç°çš„åç¨‹è°ƒåº¦å™¨çš„åŠŸèƒ½å…¶å®éå¸¸ç®€å•ï¼Œå½“æ·»åŠ ä»»åŠ¡åè°ƒåº¦å™¨åªæ˜¯å•çº¯çš„ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡äº¤ç»™åç¨‹å»æ‰§è¡Œã€‚sylarçš„åç¨‹åº“çš„å…³æ³¨å¯¹è±¡æ˜¯ç½‘ç»œIOï¼Œå¦‚æœé‡‡ç”¨è¿™ä¹ˆç®€å•çš„è°ƒåº¦å°±æ ¹æœ¬æ²¡æœ‰ç”¨åˆ°åç¨‹çš„ç²¾é«“ã€‚\nsylarçš„IOåç¨‹è°ƒåº¦è§£å†³äº†ä¹‹å‰è°ƒåº¦å™¨åœ¨idleçŠ¶æ€ä¸‹å¿™ç­‰å¾…å¯¼è‡´CPUå ç”¨ç‡é«˜çš„é—®é¢˜ã€‚IOåç¨‹è°ƒåº¦å™¨ä½¿ç”¨ä¸€å¯¹ç®¡é“fdæ¥tickleè°ƒåº¦åç¨‹ï¼Œå½“è°ƒåº¦å™¨ç©ºé—²æ—¶ï¼Œidleåç¨‹é€šè¿‡epoll_waité˜»å¡åœ¨ç®¡é“çš„è¯»æè¿°ç¬¦ä¸Šï¼Œç­‰ç®¡é“çš„å¯è¯»äº‹ä»¶ã€‚æ·»åŠ æ–°ä»»åŠ¡æ—¶ï¼Œtickleæ–¹æ³•å†™ç®¡é“ï¼Œidleåç¨‹æ£€æµ‹åˆ°ç®¡é“å¯è¯»åé€€å‡ºï¼Œè°ƒåº¦å™¨æ‰§è¡Œè°ƒåº¦ã€‚\nIOManager API IOManagerçš„APIå¦‚ä¸‹ï¼š\n#ifndef IOMANAGER_H_ #define IOMANAGER_H_ #include #include #include #include #include #include #include #include \"coroutine.h\" #include \"scheduler.h\" #include \"timer.h\" // äº‹ä»¶ï¼šæ— ã€è¯»ã€å†™ enum Event { NONE = 0x0, READ = EPOLLIN, WRITE = EPOLLOUT, }; // IOåç¨‹è°ƒåº¦ class IOManager : public Scheduler, public TimerManager { public: IOManager(size_t threads = 1, bool use_caller = true, const std::string\u0026 name = \"IOManager\"); ~IOManager(); bool AddEvent(int fd, Event event, std::function\u003cvoid()\u003e cb = nullptr); bool DelEvent(int fd, Event event); bool CancelEvent(int fd, Event event); bool CancelAllEvent(int fd); static IOManager* GetIOManager(); protected: void Idle() override; void Tickle() override; void OnTimerInsertAtFront() override; bool IsStop() override; void ResizeContexts(size_t size); private: // socket fd ä¸Šä¸‹æ–‡ struct FdContext { struct EventContext { Scheduler* scheduler = nullptr; Coroutine::Ptr coroutine; std::function\u003cvoid()\u003e callback; }; // æ ¹æ®ç±»å‹è·å–å¯¹åº”çš„ä¸Šä¸‹æ–‡ EventContext\u0026 GetEventContext(Event\u0026 e); void ResetEventContext(EventContext\u0026 ectx); void TriggerEvent(Event e); EventContext read_ctx, write_ctx; int fd; Event events = Event::NONE; std::mutex mutex; }; private: int epfd_; int tickle_fd_[2]; std::atomic_size_t pending_evt_cnt_; std::mutex mutex_; std::shared_mutex rw_mutex_; // åˆ©ç”¨fdä½œä¸ºä¸‹æ ‡æ¥è·å–å¯¹åº”çš„FdContext*ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å“ˆå¸Œè¡¨ä»£æ›¿ std::vector\u003cFdContext*\u003e fd_contexts_; }; #endif /* IOMANAGER_H_ */ Scheduler::Run() æˆ‘ä»¬å¯ä»¥å…ˆå›é¡¾ä¸€ä¸‹Scheduler::Run()è¿™ä¸ªå‡½æ•°ï¼š\nvoid Scheduler::Run() { LOG \u003c\u003c \"Scheduler running...\\n\"; SetHookFlag(true); SetThisAsScheduler(); // å¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯è°ƒåº¦å™¨æ‰€åœ¨çº¿ç¨‹ï¼Œè®¾ç½®è°ƒåº¦çš„åç¨‹ä¸ºå½“å‰çº¿ç¨‹è¿è¡Œçš„åç¨‹ if (std::this_thread::get_id() != sched_id_) { sched_coroutine = Coroutine::GetNowCoroutine().get(); } Coroutine::Ptr idle_co = std::make_shared\u003cCoroutine\u003e([this] { this-\u003eIdle(); }); Coroutine::Ptr callback_co; SchedulerTask task; while (true) { task.Reset(); bool tickle = false; { std::lock_guard lock(mutex_); auto iter = tasks_.begin(); while (iter != tasks_.end()) { // å½“å‰éå†çš„taskå·²ç»åˆ†é…äº†çº¿ç¨‹å»æ‰§è¡Œä¸”è¿™ä¸ªçº¿ç¨‹ä¸æ˜¯å½“å‰çº¿ç¨‹ï¼Œåˆ™ä¸ç”¨ç®¡ if (iter-\u003ethread_id_ \u0026\u0026 *iter-\u003ethread_id_ != std::this_thread::get_id()) { ++iter; tickle = true; continue; } if (iter-\u003ecoroutine_ \u0026\u0026 iter-\u003ecoroutine_-\u003eGetState() != Coroutine::READY) { LOG \u003c\u003c \"Coroutine task's state should be READY!\\n\"; assert(false); } task = *iter; tasks_.erase(iter++); active_threads_++; break; } // æœ‰ä»»åŠ¡å¯ä»¥å»æ‰§è¡Œï¼Œéœ€è¦tickleä¸€ä¸‹ tickle |= (iter != tasks_.end()); } if (tickle) { Tickle(); } // å­åç¨‹æ‰§è¡Œå®Œæ¯•åyieldä¼šå›åˆ°Run()ä¸­ // æ³¨æ„ï¼Œæ¯æ¬¡è¿è¡Œäº†ä¸€ä¸ªtaskåéœ€è¦Resetä¸€ä¸‹ if (task.coroutine_) { // ä»»åŠ¡ç±»å‹ä¸ºåç¨‹ task.coroutine_-\u003eResume(); active_threads_--; task.Reset(); } else if (task.callback_) { // ä»»åŠ¡ç±»å‹ä¸ºå›è°ƒå‡½æ•°ï¼Œå°†å…¶åŒ…è£…ä¸ºåç¨‹ if (callback_co) { callback_co-\u003eReset(task.callback_); } else { callback_co = std::make_shared\u003cCoroutine\u003e(task.callback_); } callback_co-\u003eResume(); active_threads_--; callback_co.reset(); task.Reset(); } else { // æ— ä»»åŠ¡ï¼Œä»»åŠ¡é˜Ÿåˆ—ä¸ºç©º if (idle_co-\u003eGetState() == Coroutine::FINISH) { LOG \u003c\u003c \"Idle coroutine finish\\n\"; break; } idle_threads_++; idle_co-\u003eResume(); // Idleæœ€åYeildæ—¶å›åˆ°è¿™é‡Œ idle_threads_--; } } LOG \u003c\u003c \"Scheduler Run() exit\\n\"; } è¿™ä¸ªå‡½æ•°å°±æ˜¯æ¯ä¸ªçº¿ç¨‹ä¼šå¯åŠ¨çš„åç¨‹è°ƒåº¦å‡½æ•°ï¼Œè´Ÿè´£ç®¡ç†å’Œæ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼ŒåŒ…æ‹¬åç¨‹å’Œå›è°ƒå‡½æ•°ä¸¤ç§ç±»å‹çš„ä»»åŠ¡ï¼Œå¦‚æœä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™æ‰§è¡ŒIdleåç¨‹ã€‚\nåœ¨Scheduler::Idle()å‡½æ•°ä¸­ï¼Œä»…ä»…åªæ˜¯åšäº†ä¸€ä¸ªç®€å•çš„å¤„ç†ï¼šè°ƒåº¦å™¨æ²¡æœ‰åœæ­¢å°±è®©å‡ºå½“å‰æ­£åœ¨æ‰§è¡Œçš„åç¨‹ï¼Œæˆ‘ä»¬è¦åšçš„å¢å¼ºåçš„IOManageréœ€è¦é‡å†™Idleå‡½æ•°ï¼Œè®©å®ƒä¸æ–­ç­‰å¾…äº‹ä»¶ã€å¤„ç†äº‹ä»¶ã€ç„¶åå†æ¬¡ç­‰å¾…äº‹ä»¶çš„å¾ªç¯è¿‡ç¨‹ï¼Œå®ƒåœ¨æ²¡æœ‰å…¶ä»–åç¨‹è¿è¡Œæ—¶ä¿æŒç³»ç»Ÿçš„æ´»è·ƒåº¦ï¼Œå¹¶åœ¨æœ‰äº‹ä»¶å‘ç”Ÿæ—¶è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚\né‡å†™Idleå‡½æ•° åœ¨IOManagerä¸­ï¼Œæˆ‘ä»¬å°±éœ€è¦é‡å†™Idleå‡½æ•°ï¼Œæˆ‘ä»¬éœ€è¦å®ƒæ˜¯ä¸€ä¸ªä¸æ–­ç­‰å¾…äº‹ä»¶ã€å¤„ç†äº‹ä»¶ã€ç„¶åå†æ¬¡ç­‰å¾…äº‹ä»¶çš„å¾ªç¯è¿‡ç¨‹ï¼Œå®ƒåœ¨æ²¡æœ‰å…¶ä»–åç¨‹è¿è¡Œæ—¶ä¿æŒç³»ç»Ÿçš„æ´»è·ƒåº¦ï¼Œå¹¶åœ¨æœ‰äº‹ä»¶å‘ç”Ÿæ—¶è¿›è¡Œç›¸åº”çš„å¤„ç†ï¼š\næˆ‘ä»¬ä¼šå…ˆæ‰¾åˆ°æœ€è¿‘ä¸€ä¸ªå®šæ—¶å™¨çš„è¶…æ—¶æ—¶é—´ï¼Œå¹¶å°†å…¶ä¸è‡ªå®šä¹‰æœ€é•¿è¶…æ—¶æ—¶é—´ï¼ˆæºç ä¸­æ˜¯5sï¼‰è¿›è¡Œæ¯”è¾ƒå–æœ€å°è€…ä½œä¸ºepoll_waitçš„è¶…æ—¶æ—¶é—´ å°†è¶…æ—¶çš„å®šæ—¶å™¨çš„å›è°ƒå‡½æ•°åŠ å…¥è°ƒåº¦å™¨ å¤„ç†epoll_waité€æ¥çš„äº‹ä»¶ å°†å½“å‰çº¿ç¨‹è¿è¡Œçš„åç¨‹æš‚åœï¼ˆä¹Ÿå°±æ˜¯æš‚åœIdleåç¨‹ï¼‰ï¼Œå¹¶å°†æ‰§è¡Œæƒäº¤ç»™è°ƒåº¦åç¨‹ï¼ˆScheduler::Run()ï¼‰ ä»1.åˆå¼€å§‹é‡å¤æ‰§è¡Œ å…·ä½“æ“ä½œå¯çœ‹ä»£ç ï¼š\nvoid IOManager::Idle() { LOG \u003c\u003c \"idle coroutine start up\\n\"; const int MAX_EVENTS = 256; const int MAX_TIMEOUT = 5000; epoll_event events[MAX_EVENTS]{}; while (true) { // LOG \u003c\u003c \"in idle now\\n\"; if (IsStop()) { LOG \u003c\u003c GetName() \u003c\u003c \"idle stop now\\n\"; break; } uint64_t next_timeout = GetNextTimerInterval(); int triggered_events; do { // å¦‚æœæ—¶é—´å †ä¸­æœ‰è¶…æ—¶çš„å®šæ—¶å™¨ï¼Œåˆ™æ¯”è¾ƒè¿™ä¸ªè¶…æ—¶å®šæ—¶å™¨çš„ä¸‹ä¸€æ¬¡è§¦å‘çš„æ—¶é—´ä¸MAX_TIMEOUTï¼ˆ5sï¼‰ï¼Œé€‰å–æœ€å°å€¼ä½œä¸ºè¶…æ—¶æ—¶é—´ next_timeout = next_timeout != ~0ull ? std::min(static_cast\u003cint\u003e(next_timeout), MAX_TIMEOUT) : MAX_TIMEOUT; // æ²¡æœ‰äº‹ä»¶åˆ°æ¥æ—¶ä¼šé˜»å¡åœ¨epoll_waitä¸Šï¼Œé™¤éåˆ°äº†è¶…æ—¶æ—¶é—´ triggered_events = epoll_wait(epfd_, events, MAX_EVENTS, static_cast\u003cint\u003e(next_timeout)); if (triggered_events \u003c 0 \u0026\u0026 errno == EINTR) { continue; } else { break; } } while (true); // ç”¨while(true)çš„ç›®çš„æ˜¯ç¡®ä¿åœ¨å‡ºç°ç‰¹å®šé”™è¯¯æƒ…å†µæ—¶èƒ½å¤Ÿé‡æ–°å°è¯•æ‰§è¡Œ epoll_wait // å°†è¶…æ—¶çš„å®šæ—¶å™¨çš„å›è°ƒå‡½æ•°åŠ å…¥è°ƒåº¦å™¨ // è¿™äº›å›è°ƒå‡½æ•°çš„ä½œç”¨å¯èƒ½æ˜¯å…³é—­è¿æ¥ç­‰æ“ä½œ std::vector\u003cstd::function\u003cvoid()\u003e\u003e cbs = GetExpiredCbList(); for (auto\u0026 cb : cbs) { Sched(cb); } // å¤„ç†äº‹ä»¶ for (int i = 0; i \u003c triggered_events; i++) { epoll_event\u0026 event = events[i]; // æ˜¯ä¸€ä¸ªç”¨äºé€šçŸ¥åç¨‹è°ƒåº¦çš„äº‹ä»¶ // epollä¸­ç›‘å¬äº†ç”¨äºé€šçŸ¥çš„ç®¡é“è¯»ç«¯fdï¼Œå½“æœ‰æ•°æ®åˆ°æ—¶å³ä¼šè§¦å‘ if (event.data.fd == tickle_fd_[0]) { char buf[256]{}; // å°†ç®¡é“å†…çš„æ•°æ®è¯»å®Œ while (read(tickle_fd_[0], buf, sizeof(buf)) \u003e 0) ; continue; } // FdContext* fd_ctx = (FdContext*) event.data.ptr; FdContext* fd_ctx = static_cast\u003cFdContext*\u003e(event.data.ptr); std::lock_guard lock(fd_ctx-\u003emutex); // å‘ç”Ÿé”™è¯¯æ—¶ï¼Œå¦‚æœåŸæ¥çš„æ–‡ä»¶æè¿°ç¬¦ä¸Šä¸‹æ–‡ï¼ˆfd_ctxï¼‰ä¸­æœ‰å¯è¯»æˆ–å¯å†™äº‹ä»¶æ ‡å¿—è¢«è®¾ç½®ï¼Œé‚£ä¹ˆç°åœ¨å°†é‡æ–°è§¦å‘è¿™äº›äº‹ä»¶ if (event.events \u0026 (EPOLLERR | EPOLLHUP)) { event.events |= (EPOLLIN | EPOLLOUT) \u0026 fd_ctx-\u003eevents; } // è·å–fd_ctxå¯¹åº”çš„äº‹ä»¶ int real_event = Event::NONE; if (event.events \u0026 EPOLLIN) { real_event |= Event::READ; } if (event.events \u0026 EPOLLOUT) { real_event |= Event::WRITE; } if ((fd_ctx-\u003eevents \u0026 real_event) == Event::NONE) { continue; } // å¦‚æœè¿˜æœ‰å‰©ä½™äº‹ä»¶ï¼Œåˆ™ä¿®æ”¹ï¼›å¦åˆ™å°†å…¶ä»epollä¸­åˆ é™¤ // æ³¨æ„è·å–rest_eventsæ—¶ä¸æ˜¯ä½¿ç”¨çš„event.events \u0026 ~real_eventï¼Œå› ä¸ºæ˜¯è¦å»é™¤fd_ctx-\u003efdä¸­æœ¬æ¬¡è§¦å‘çš„äº‹ä»¶ int rest_events = fd_ctx-\u003eevents \u0026 ~real_event; int op = rest_events ? EPOLL_CTL_MOD : EPOLL_CTL_DEL; event.events = EPOLLET | rest_events; if (epoll_ctl(epfd_, op, fd_ctx-\u003efd, \u0026event) \u003c 0) { LOG_ERROR \u003c\u003c strerror(errno) \u003c\u003c \"\\n\"; continue; } if (real_event \u0026 Event::READ) { fd_ctx-\u003eTriggerEvent(Event::READ); --pending_evt_cnt_; } if (real_event \u0026 Event::WRITE) { fd_ctx-\u003eTriggerEvent(Event::WRITE); --pending_evt_cnt_; } } // å°†å½“å‰çº¿ç¨‹è¿è¡Œçš„åç¨‹æš‚åœï¼ˆä¹Ÿå°±æ˜¯æš‚åœIdleåç¨‹ï¼‰ï¼Œå¹¶å°†æ‰§è¡Œæƒäº¤ç»™è°ƒåº¦åç¨‹ Coroutine::Ptr co_ptr = Coroutine::GetNowCoroutine(); auto co = co_ptr.get(); co_ptr.reset(); co-\u003eYield(); } } æ·»åŠ äº‹ä»¶ IOManageré™¤äº†é‡å†™Idleå‡½æ•°è¿™ä¸ªé‡è¦ç‚¹å¤–ï¼Œè¿˜æœ‰ä¸ªé‡è¦ç‚¹å°±æ˜¯ä¸ºæŒ‡å®šæ–‡ä»¶æè¿°ç¬¦æ·»åŠ äº‹ä»¶ã€‚\nIOManagerå†…éƒ¨æœ‰ä¸€ä¸ª[FdContext](#IOManger API)ç»“æ„ä½“ç”¨æ¥å°è£…socket fdçš„ä¸Šä¸‹æ–‡ï¼ˆéœ€è¦ç»‘å®šçš„å›è°ƒå‡½æ•°ï¼Œå¯¹åº”çš„äº‹ä»¶ã€åç¨‹ï¼‰ï¼Œå¹¶ä½¿ç”¨ä¸€ä¸ªvectorä¿å­˜è¿™äº›FdContextã€‚\næˆ‘ä»¬åœ¨æ·»åŠ fdçš„äº‹ä»¶æ—¶ï¼Œéœ€è¦å°†å…¶åŠ å…¥vectorä¸­ï¼Œå¹¶ä¸”éœ€è¦é€šè¿‡epoll_ctlæ³¨å†Œfdçš„å¯¹åº”äº‹ä»¶ã€‚\nbool IOManager::AddEvent(int fd, Event event, std::function\u003cvoid()\u003e cb) { FdContext* fd_ctx = nullptr; { std::shared_lock rw_lock(rw_mutex_); if (fd_contexts_.size() \u003e fd) { fd_ctx = fd_contexts_[fd]; rw_lock.unlock(); } else { rw_lock.unlock(); std::unique_lock rw_lock2(rw_mutex_); ResizeContexts(fd * 1.5); fd_ctx = fd_contexts_[fd]; } } std::lock_guard lock(mutex_); if (fd_ctx-\u003eevents \u0026 event) { LOG_ERROR \u003c\u003c \"A fd can't add same event\\n\"; return false; } int op = fd_ctx-\u003eevents ? EPOLL_CTL_MOD : EPOLL_CTL_ADD; epoll_event ep_evt{}; ep_evt.events = static_cast\u003cint\u003e(fd_ctx-\u003eevents) | EPOLLET | event; ep_evt.data.ptr = fd_ctx; // åœ¨Idle()ä¸­å°†ä½¿ç”¨fdå¯¹åº”çš„è¿™ä¸ªep_evt int ret = epoll_ctl(epfd_, op, fd, \u0026ep_evt); if (ret) { LOG_ERROR \u003c\u003c \"epoll_ctl \" \u003c\u003c strerror(errno); return false; } ++pending_evt_cnt_; // è®¾ç½®fdå¯¹åº”äº‹ä»¶çš„EventContext fd_ctx-\u003eevents = static_cast\u003cEvent\u003e(fd_ctx-\u003eevents | event); // ä½¿ç”¨event_ctxç›¸å½“äºä½¿ç”¨fd_ctx-\u003eread_ctx or fd_ctx-\u003ewrite_ctxï¼ˆæ³¨æ„æ˜¯auto\u0026è€Œä¸æ˜¯autoï¼‰ auto\u0026 event_ctx = fd_ctx-\u003eGetEventContext(event); assert(!event_ctx.scheduler \u0026\u0026 !event_ctx.callback \u0026\u0026 !event_ctx.coroutine); event_ctx.scheduler = Scheduler::GetScheduler(); if (cb) { event_ctx.callback = cb; } else { // è®¾ç½®fdç›¸å…³äº‹ä»¶è§¦å‘æ—¶ä½¿ç”¨çš„åç¨‹ä¸ºå½“å‰ event_ctx.coroutine = Coroutine::GetNowCoroutine(); assert(event_ctx.coroutine-\u003eGetState() == Coroutine::RUNNING); } return true; } ","wordCount":"782","inLanguage":"en","image":"https://kerolt.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2024-09-29T00:00:00Z","dateModified":"2024-09-29T00:00:00Z","author":{"@type":"Person","name":"Kerolt"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://kerolt.github.io/posts/%E5%8A%A8%E6%89%8B%E5%AE%9E%E7%8E%B0x/%E5%8A%A8%E6%89%8B%E5%86%99%E5%8D%8F%E7%A8%8B%E5%BA%93-4io%E5%8D%8F%E7%A8%8B%E8%B0%83%E5%BA%A6%E5%99%A8/"},"publisher":{"@type":"Organization","name":"Kerolt's Blog","logo":{"@type":"ImageObject","url":"https://kerolt.github.io/images/avatar/favicon.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://kerolt.github.io/ accesskey=h title="Kerolt's Blog (Alt + H)">Kerolt's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://kerolt.github.io/posts/ title=æ–‡ç« ><span>æ–‡ç« </span></a></li><li><a href=https://kerolt.github.io/categories/ title=åˆ†ç±»><span>åˆ†ç±»</span></a></li><li><a href=https://kerolt.github.io/tags/ title=æ ‡ç­¾><span>æ ‡ç­¾</span></a></li><li><a href=https://kerolt.github.io/archives/ title=å½’æ¡£><span>å½’æ¡£</span></a></li><li><a href=https://kerolt.github.io/about/ title=å…³äºæˆ‘><span>å…³äºæˆ‘</span></a></li><li><a href=https://kerolt.github.io/search/ title="ğŸ” (Alt + /)" accesskey=/><span>ğŸ”</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://kerolt.github.io/>Home</a>&nbsp;Â»&nbsp;<a href=https://kerolt.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">ã€åŠ¨æ‰‹å†™åç¨‹åº“ 4ã€‘IOåç¨‹è°ƒåº¦å™¨</h1><div class=post-meta><span title='2024-09-29 00:00:00 +0000 UTC'>å‘å¸ƒäº2024-09-29</span>&nbsp;&nbsp;Â·&nbsp;&nbsp;Kerolt</div><ul class=post-tags><li><a href=https://kerolt.github.io/tags/coroutine/>Coroutine</a></li><li><a href=https://kerolt.github.io/tags/cplusplus/>CPlusPlus</a></li></ul></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#iomanager-api aria-label="IOManager API">IOManager API</a></li><li><a href=#schedulerrun aria-label=Scheduler::Run()>Scheduler::Run()</a></li><li><a href=#%e9%87%8d%e5%86%99idle%e5%87%bd%e6%95%b0 aria-label=é‡å†™Idleå‡½æ•°>é‡å†™Idleå‡½æ•°</a></li><li><a href=#%e6%b7%bb%e5%8a%a0%e4%ba%8b%e4%bb%b6 aria-label=æ·»åŠ äº‹ä»¶>æ·»åŠ äº‹ä»¶</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><blockquote><p>ã€åŠ¨æ‰‹å†™åç¨‹åº“ã€‘ç³»åˆ—ç¬”è®°æ˜¯å­¦ä¹ sylarçš„åç¨‹åº“æ—¶çš„è®°å½•ï¼Œå‚è€ƒäº†<a href="https://www.midlane.top/wiki/pages/viewpage.action?pageId=10060952">ä»é›¶å¼€å§‹é‡å†™sylar C++é«˜æ€§èƒ½åˆ†å¸ƒå¼æœåŠ¡å™¨æ¡†æ¶</a>å’Œä»£ç éšæƒ³å½•ä¸­çš„<a href=https://www.programmercarl.com/other/project_coroutine.html#%E4%B8%8B%E8%BD%BD%E6%96%B9%E5%BC%8F>æ–‡æ¡£</a>ã€‚æ–‡ç« å¹¶ä¸æ˜¯å¯¹æ‰€æœ‰ä»£ç çš„è¯¦ç»†è§£é‡Šï¼Œè€Œæ˜¯ä¸ºäº†è‡ªå·±ç†è§£ä¸€äº›ç‰‡æ®µæ‰€åšçš„ç¬”è®°ã€‚</p><p><code>IOManager</code>ç±»ä¸­å…·ä½“å®šä¹‰å®ç°å¯ä»¥åœ¨è¿™é‡ŒæŸ¥çœ‹ï¼š<a href=https://github.com/kerolt/coroutine-lib/blob/master/src/iomanager.cpp>Github: src/iomanager.cpp</a></p></blockquote><p>ä¹‹å‰å®ç°çš„åç¨‹è°ƒåº¦å™¨çš„åŠŸèƒ½å…¶å®éå¸¸ç®€å•ï¼Œå½“æ·»åŠ ä»»åŠ¡åè°ƒåº¦å™¨åªæ˜¯å•çº¯çš„ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡äº¤ç»™åç¨‹å»æ‰§è¡Œã€‚sylarçš„åç¨‹åº“çš„å…³æ³¨å¯¹è±¡æ˜¯ç½‘ç»œIOï¼Œå¦‚æœé‡‡ç”¨è¿™ä¹ˆç®€å•çš„è°ƒåº¦å°±æ ¹æœ¬æ²¡æœ‰ç”¨åˆ°åç¨‹çš„ç²¾é«“ã€‚</p><p>sylarçš„IOåç¨‹è°ƒåº¦è§£å†³äº†ä¹‹å‰è°ƒåº¦å™¨åœ¨idleçŠ¶æ€ä¸‹å¿™ç­‰å¾…å¯¼è‡´CPUå ç”¨ç‡é«˜çš„é—®é¢˜ã€‚IOåç¨‹è°ƒåº¦å™¨ä½¿ç”¨ä¸€å¯¹ç®¡é“fdæ¥tickleè°ƒåº¦åç¨‹ï¼Œå½“è°ƒåº¦å™¨ç©ºé—²æ—¶ï¼Œidleåç¨‹é€šè¿‡epoll_waité˜»å¡åœ¨ç®¡é“çš„è¯»æè¿°ç¬¦ä¸Šï¼Œç­‰ç®¡é“çš„å¯è¯»äº‹ä»¶ã€‚æ·»åŠ æ–°ä»»åŠ¡æ—¶ï¼Œtickleæ–¹æ³•å†™ç®¡é“ï¼Œidleåç¨‹æ£€æµ‹åˆ°ç®¡é“å¯è¯»åé€€å‡ºï¼Œè°ƒåº¦å™¨æ‰§è¡Œè°ƒåº¦ã€‚</p><h2 id=iomanager-api>IOManager API<a hidden class=anchor aria-hidden=true href=#iomanager-api>#</a></h2><p><code>IOManager</code>çš„APIå¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#099>#ifndef IOMANAGER_H_
</span></span></span><span style=display:flex><span><span style=color:#099>#define IOMANAGER_H_
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#099>#include</span> <span style=color:#099>&lt;cstddef&gt;</span><span style=color:#099>
</span></span></span><span style=display:flex><span><span style=color:#099>#include</span> <span style=color:#099>&lt;sys/epoll.h&gt;</span><span style=color:#099>
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#099>#include</span> <span style=color:#099>&lt;atomic&gt;</span><span style=color:#099>
</span></span></span><span style=display:flex><span><span style=color:#099>#include</span> <span style=color:#099>&lt;functional&gt;</span><span style=color:#099>
</span></span></span><span style=display:flex><span><span style=color:#099>#include</span> <span style=color:#099>&lt;mutex&gt;</span><span style=color:#099>
</span></span></span><span style=display:flex><span><span style=color:#099>#include</span> <span style=color:#099>&lt;shared_mutex&gt;</span><span style=color:#099>
</span></span></span><span style=display:flex><span><span style=color:#099>#include</span> <span style=color:#099>&lt;vector&gt;</span><span style=color:#099>
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#099>#include</span> <span style=color:#099>&#34;coroutine.h&#34;</span><span style=color:#099>
</span></span></span><span style=display:flex><span><span style=color:#099>#include</span> <span style=color:#099>&#34;scheduler.h&#34;</span><span style=color:#099>
</span></span></span><span style=display:flex><span><span style=color:#099>#include</span> <span style=color:#099>&#34;timer.h&#34;</span><span style=color:#099>
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>// äº‹ä»¶ï¼šæ— ã€è¯»ã€å†™
</span></span></span><span style=display:flex><span><span style=color:#069;font-weight:700>enum</span> <span style=color:#0a8;font-weight:700>Event</span> {
</span></span><span style=display:flex><span>    NONE <span style=color:#555>=</span> <span style=color:#f60>0x0</span>,
</span></span><span style=display:flex><span>    READ <span style=color:#555>=</span> EPOLLIN,
</span></span><span style=display:flex><span>    WRITE <span style=color:#555>=</span> EPOLLOUT,
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>// IOåç¨‹è°ƒåº¦
</span></span></span><span style=display:flex><span><span style=color:#069;font-weight:700>class</span> <span style=color:#0a8;font-weight:700>IOManager</span> <span style=color:#555>:</span> <span style=color:#069;font-weight:700>public</span> Scheduler, <span style=color:#069;font-weight:700>public</span> TimerManager {
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>public</span><span style=color:#555>:</span>
</span></span><span style=display:flex><span>    IOManager(size_t threads <span style=color:#555>=</span> <span style=color:#f60>1</span>, <span style=color:#078;font-weight:700>bool</span> use_caller <span style=color:#555>=</span> <span style=color:#366>true</span>, <span style=color:#069;font-weight:700>const</span> std<span style=color:#555>::</span>string<span style=color:#555>&amp;</span> name <span style=color:#555>=</span> <span style=color:#c30>&#34;IOManager&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#555>~</span>IOManager();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>bool</span> <span style=color:#c0f>AddEvent</span>(<span style=color:#078;font-weight:700>int</span> fd, Event event, std<span style=color:#555>::</span>function<span style=color:#555>&lt;</span><span style=color:#078;font-weight:700>void</span>()<span style=color:#555>&gt;</span> cb <span style=color:#555>=</span> <span style=color:#069;font-weight:700>nullptr</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>bool</span> <span style=color:#c0f>DelEvent</span>(<span style=color:#078;font-weight:700>int</span> fd, Event event);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>bool</span> <span style=color:#c0f>CancelEvent</span>(<span style=color:#078;font-weight:700>int</span> fd, Event event);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>bool</span> <span style=color:#c0f>CancelAllEvent</span>(<span style=color:#078;font-weight:700>int</span> fd);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>static</span> IOManager<span style=color:#555>*</span> <span style=color:#c0f>GetIOManager</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>protected</span><span style=color:#555>:</span>
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>void</span> Idle() <span style=color:#069;font-weight:700>override</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>void</span> <span style=color:#c0f>Tickle</span>() <span style=color:#069;font-weight:700>override</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>void</span> <span style=color:#c0f>OnTimerInsertAtFront</span>() <span style=color:#069;font-weight:700>override</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>bool</span> <span style=color:#c0f>IsStop</span>() <span style=color:#069;font-weight:700>override</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>void</span> <span style=color:#c0f>ResizeContexts</span>(size_t size);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>private</span><span style=color:#555>:</span>
</span></span><span style=display:flex><span>    <span style=color:#09f;font-style:italic>// socket fd ä¸Šä¸‹æ–‡
</span></span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>struct</span> <span style=color:#0a8;font-weight:700>FdContext</span> {
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>struct</span> <span style=color:#0a8;font-weight:700>EventContext</span> {
</span></span><span style=display:flex><span>            Scheduler<span style=color:#555>*</span> scheduler <span style=color:#555>=</span> <span style=color:#069;font-weight:700>nullptr</span>;
</span></span><span style=display:flex><span>            Coroutine<span style=color:#555>::</span>Ptr coroutine;
</span></span><span style=display:flex><span>            std<span style=color:#555>::</span>function<span style=color:#555>&lt;</span><span style=color:#078;font-weight:700>void</span>()<span style=color:#555>&gt;</span> callback;
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#09f;font-style:italic>// æ ¹æ®ç±»å‹è·å–å¯¹åº”çš„ä¸Šä¸‹æ–‡
</span></span></span><span style=display:flex><span>        EventContext<span style=color:#555>&amp;</span> GetEventContext(Event<span style=color:#555>&amp;</span> e);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#078;font-weight:700>void</span> <span style=color:#c0f>ResetEventContext</span>(EventContext<span style=color:#555>&amp;</span> ectx);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#078;font-weight:700>void</span> <span style=color:#c0f>TriggerEvent</span>(Event e);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        EventContext read_ctx, write_ctx;
</span></span><span style=display:flex><span>        <span style=color:#078;font-weight:700>int</span> fd;
</span></span><span style=display:flex><span>        Event events <span style=color:#555>=</span> Event<span style=color:#555>::</span>NONE;
</span></span><span style=display:flex><span>        std<span style=color:#555>::</span>mutex mutex;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>private</span><span style=color:#555>:</span>
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>int</span> epfd_;
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>int</span> tickle_fd_[<span style=color:#f60>2</span>];
</span></span><span style=display:flex><span>    std<span style=color:#555>::</span>atomic_size_t pending_evt_cnt_;
</span></span><span style=display:flex><span>    std<span style=color:#555>::</span>mutex mutex_;
</span></span><span style=display:flex><span>    std<span style=color:#555>::</span>shared_mutex rw_mutex_;
</span></span><span style=display:flex><span>    <span style=color:#09f;font-style:italic>// åˆ©ç”¨fdä½œä¸ºä¸‹æ ‡æ¥è·å–å¯¹åº”çš„FdContext*ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å“ˆå¸Œè¡¨ä»£æ›¿
</span></span></span><span style=display:flex><span>    std<span style=color:#555>::</span>vector<span style=color:#555>&lt;</span>FdContext<span style=color:#555>*&gt;</span> fd_contexts_;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#099>#endif </span><span style=color:#09f;font-style:italic>/* IOMANAGER_H_ */</span><span style=color:#099>
</span></span></span></code></pre></div><h2 id=schedulerrun>Scheduler::Run()<a hidden class=anchor aria-hidden=true href=#schedulerrun>#</a></h2><p>æˆ‘ä»¬å¯ä»¥å…ˆå›é¡¾ä¸€ä¸‹<code>Scheduler::Run()</code>è¿™ä¸ªå‡½æ•°ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#078;font-weight:700>void</span> Scheduler<span style=color:#555>::</span>Run() {
</span></span><span style=display:flex><span>    LOG <span style=color:#555>&lt;&lt;</span> <span style=color:#c30>&#34;Scheduler running...</span><span style=color:#c30;font-weight:700>\n</span><span style=color:#c30>&#34;</span>;
</span></span><span style=display:flex><span>    SetHookFlag(<span style=color:#366>true</span>);
</span></span><span style=display:flex><span>    SetThisAsScheduler();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#09f;font-style:italic>// å¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯è°ƒåº¦å™¨æ‰€åœ¨çº¿ç¨‹ï¼Œè®¾ç½®è°ƒåº¦çš„åç¨‹ä¸ºå½“å‰çº¿ç¨‹è¿è¡Œçš„åç¨‹
</span></span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>if</span> (std<span style=color:#555>::</span>this_thread<span style=color:#555>::</span>get_id() <span style=color:#555>!=</span> sched_id_) {
</span></span><span style=display:flex><span>        sched_coroutine <span style=color:#555>=</span> Coroutine<span style=color:#555>::</span>GetNowCoroutine().get();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Coroutine<span style=color:#555>::</span>Ptr idle_co <span style=color:#555>=</span> std<span style=color:#555>::</span>make_shared<span style=color:#555>&lt;</span>Coroutine<span style=color:#555>&gt;</span>([<span style=color:#069;font-weight:700>this</span>] { <span style=color:#069;font-weight:700>this</span><span style=color:#555>-&gt;</span>Idle(); });
</span></span><span style=display:flex><span>    Coroutine<span style=color:#555>::</span>Ptr callback_co;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    SchedulerTask task;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>while</span> (<span style=color:#366>true</span>) {
</span></span><span style=display:flex><span>        task.Reset();
</span></span><span style=display:flex><span>        <span style=color:#078;font-weight:700>bool</span> tickle <span style=color:#555>=</span> <span style=color:#366>false</span>;
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            std<span style=color:#555>::</span>lock_guard lock(mutex_);
</span></span><span style=display:flex><span>            <span style=color:#069;font-weight:700>auto</span> iter <span style=color:#555>=</span> tasks_.begin();
</span></span><span style=display:flex><span>            <span style=color:#069;font-weight:700>while</span> (iter <span style=color:#555>!=</span> tasks_.end()) {
</span></span><span style=display:flex><span>                <span style=color:#09f;font-style:italic>// å½“å‰éå†çš„taskå·²ç»åˆ†é…äº†çº¿ç¨‹å»æ‰§è¡Œä¸”è¿™ä¸ªçº¿ç¨‹ä¸æ˜¯å½“å‰çº¿ç¨‹ï¼Œåˆ™ä¸ç”¨ç®¡
</span></span></span><span style=display:flex><span>                <span style=color:#069;font-weight:700>if</span> (iter<span style=color:#555>-&gt;</span>thread_id_ <span style=color:#555>&amp;&amp;</span> <span style=color:#555>*</span>iter<span style=color:#555>-&gt;</span>thread_id_ <span style=color:#555>!=</span> std<span style=color:#555>::</span>this_thread<span style=color:#555>::</span>get_id()) {
</span></span><span style=display:flex><span>                    <span style=color:#555>++</span>iter;
</span></span><span style=display:flex><span>                    tickle <span style=color:#555>=</span> <span style=color:#366>true</span>;
</span></span><span style=display:flex><span>                    <span style=color:#069;font-weight:700>continue</span>;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#069;font-weight:700>if</span> (iter<span style=color:#555>-&gt;</span>coroutine_ <span style=color:#555>&amp;&amp;</span> iter<span style=color:#555>-&gt;</span>coroutine_<span style=color:#555>-&gt;</span>GetState() <span style=color:#555>!=</span> Coroutine<span style=color:#555>::</span>READY) {
</span></span><span style=display:flex><span>                    LOG <span style=color:#555>&lt;&lt;</span> <span style=color:#c30>&#34;Coroutine task&#39;s state should be READY!</span><span style=color:#c30;font-weight:700>\n</span><span style=color:#c30>&#34;</span>;
</span></span><span style=display:flex><span>                    assert(<span style=color:#366>false</span>);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                task <span style=color:#555>=</span> <span style=color:#555>*</span>iter;
</span></span><span style=display:flex><span>                tasks_.erase(iter<span style=color:#555>++</span>);
</span></span><span style=display:flex><span>                active_threads_<span style=color:#555>++</span>;
</span></span><span style=display:flex><span>                <span style=color:#069;font-weight:700>break</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#09f;font-style:italic>// æœ‰ä»»åŠ¡å¯ä»¥å»æ‰§è¡Œï¼Œéœ€è¦tickleä¸€ä¸‹
</span></span></span><span style=display:flex><span>            tickle <span style=color:#555>|=</span> (iter <span style=color:#555>!=</span> tasks_.end());
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>if</span> (tickle) {
</span></span><span style=display:flex><span>            Tickle();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#09f;font-style:italic>// å­åç¨‹æ‰§è¡Œå®Œæ¯•åyieldä¼šå›åˆ°Run()ä¸­
</span></span></span><span style=display:flex><span>        <span style=color:#09f;font-style:italic>// æ³¨æ„ï¼Œæ¯æ¬¡è¿è¡Œäº†ä¸€ä¸ªtaskåéœ€è¦Resetä¸€ä¸‹
</span></span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>if</span> (task.coroutine_) {
</span></span><span style=display:flex><span>            <span style=color:#09f;font-style:italic>// ä»»åŠ¡ç±»å‹ä¸ºåç¨‹
</span></span></span><span style=display:flex><span>            task.coroutine_<span style=color:#555>-&gt;</span>Resume();
</span></span><span style=display:flex><span>            active_threads_<span style=color:#555>--</span>;
</span></span><span style=display:flex><span>            task.Reset();
</span></span><span style=display:flex><span>        } <span style=color:#069;font-weight:700>else</span> <span style=color:#c0f>if</span> (task.callback_) {
</span></span><span style=display:flex><span>            <span style=color:#09f;font-style:italic>// ä»»åŠ¡ç±»å‹ä¸ºå›è°ƒå‡½æ•°ï¼Œå°†å…¶åŒ…è£…ä¸ºåç¨‹
</span></span></span><span style=display:flex><span>            <span style=color:#069;font-weight:700>if</span> (callback_co) {
</span></span><span style=display:flex><span>                callback_co<span style=color:#555>-&gt;</span>Reset(task.callback_);
</span></span><span style=display:flex><span>            } <span style=color:#069;font-weight:700>else</span> {
</span></span><span style=display:flex><span>                callback_co <span style=color:#555>=</span> std<span style=color:#555>::</span>make_shared<span style=color:#555>&lt;</span>Coroutine<span style=color:#555>&gt;</span>(task.callback_);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            callback_co<span style=color:#555>-&gt;</span>Resume();
</span></span><span style=display:flex><span>            active_threads_<span style=color:#555>--</span>;
</span></span><span style=display:flex><span>            callback_co.reset();
</span></span><span style=display:flex><span>            task.Reset();
</span></span><span style=display:flex><span>        } <span style=color:#069;font-weight:700>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#09f;font-style:italic>// æ— ä»»åŠ¡ï¼Œä»»åŠ¡é˜Ÿåˆ—ä¸ºç©º
</span></span></span><span style=display:flex><span>            <span style=color:#069;font-weight:700>if</span> (idle_co<span style=color:#555>-&gt;</span>GetState() <span style=color:#555>==</span> Coroutine<span style=color:#555>::</span>FINISH) {
</span></span><span style=display:flex><span>                LOG <span style=color:#555>&lt;&lt;</span> <span style=color:#c30>&#34;Idle coroutine finish</span><span style=color:#c30;font-weight:700>\n</span><span style=color:#c30>&#34;</span>;
</span></span><span style=display:flex><span>                <span style=color:#069;font-weight:700>break</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            idle_threads_<span style=color:#555>++</span>;
</span></span><span style=display:flex><span>            idle_co<span style=color:#555>-&gt;</span>Resume(); <span style=color:#09f;font-style:italic>// Idleæœ€åYeildæ—¶å›åˆ°è¿™é‡Œ
</span></span></span><span style=display:flex><span>            idle_threads_<span style=color:#555>--</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    LOG <span style=color:#555>&lt;&lt;</span> <span style=color:#c30>&#34;Scheduler Run() exit</span><span style=color:#c30;font-weight:700>\n</span><span style=color:#c30>&#34;</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¿™ä¸ªå‡½æ•°å°±æ˜¯æ¯ä¸ªçº¿ç¨‹ä¼šå¯åŠ¨çš„åç¨‹è°ƒåº¦å‡½æ•°ï¼Œè´Ÿè´£ç®¡ç†å’Œæ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼ŒåŒ…æ‹¬åç¨‹å’Œå›è°ƒå‡½æ•°ä¸¤ç§ç±»å‹çš„ä»»åŠ¡ï¼Œå¦‚æœä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™æ‰§è¡ŒIdleåç¨‹ã€‚</p><p>åœ¨<code>Scheduler::Idle()</code>å‡½æ•°ä¸­ï¼Œä»…ä»…åªæ˜¯åšäº†ä¸€ä¸ªç®€å•çš„å¤„ç†ï¼šè°ƒåº¦å™¨æ²¡æœ‰åœæ­¢å°±è®©å‡ºå½“å‰æ­£åœ¨æ‰§è¡Œçš„åç¨‹ï¼Œæˆ‘ä»¬è¦åšçš„å¢å¼ºåçš„IOManageréœ€è¦é‡å†™Idleå‡½æ•°ï¼Œè®©å®ƒä¸æ–­ç­‰å¾…äº‹ä»¶ã€å¤„ç†äº‹ä»¶ã€ç„¶åå†æ¬¡ç­‰å¾…äº‹ä»¶çš„å¾ªç¯è¿‡ç¨‹ï¼Œå®ƒåœ¨æ²¡æœ‰å…¶ä»–åç¨‹è¿è¡Œæ—¶ä¿æŒç³»ç»Ÿçš„æ´»è·ƒåº¦ï¼Œå¹¶åœ¨æœ‰äº‹ä»¶å‘ç”Ÿæ—¶è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚</p><h2 id=é‡å†™idleå‡½æ•°>é‡å†™Idleå‡½æ•°<a hidden class=anchor aria-hidden=true href=#é‡å†™idleå‡½æ•°>#</a></h2><p>åœ¨<code>IOManager</code>ä¸­ï¼Œæˆ‘ä»¬å°±éœ€è¦é‡å†™Idleå‡½æ•°ï¼Œæˆ‘ä»¬éœ€è¦å®ƒæ˜¯ä¸€ä¸ªä¸æ–­ç­‰å¾…äº‹ä»¶ã€å¤„ç†äº‹ä»¶ã€ç„¶åå†æ¬¡ç­‰å¾…äº‹ä»¶çš„å¾ªç¯è¿‡ç¨‹ï¼Œå®ƒåœ¨æ²¡æœ‰å…¶ä»–åç¨‹è¿è¡Œæ—¶ä¿æŒç³»ç»Ÿçš„æ´»è·ƒåº¦ï¼Œå¹¶åœ¨æœ‰äº‹ä»¶å‘ç”Ÿæ—¶è¿›è¡Œç›¸åº”çš„å¤„ç†ï¼š</p><ol><li>æˆ‘ä»¬ä¼šå…ˆæ‰¾åˆ°æœ€è¿‘ä¸€ä¸ªå®šæ—¶å™¨çš„è¶…æ—¶æ—¶é—´ï¼Œå¹¶å°†å…¶ä¸è‡ªå®šä¹‰æœ€é•¿è¶…æ—¶æ—¶é—´ï¼ˆæºç ä¸­æ˜¯5sï¼‰è¿›è¡Œæ¯”è¾ƒå–æœ€å°è€…ä½œä¸º<code>epoll_wait</code>çš„è¶…æ—¶æ—¶é—´</li><li>å°†è¶…æ—¶çš„å®šæ—¶å™¨çš„å›è°ƒå‡½æ•°åŠ å…¥è°ƒåº¦å™¨</li><li>å¤„ç†<code>epoll_wait</code>é€æ¥çš„äº‹ä»¶</li><li>å°†å½“å‰çº¿ç¨‹è¿è¡Œçš„åç¨‹æš‚åœï¼ˆä¹Ÿå°±æ˜¯æš‚åœIdleåç¨‹ï¼‰ï¼Œå¹¶å°†æ‰§è¡Œæƒäº¤ç»™è°ƒåº¦åç¨‹ï¼ˆ<code>Scheduler::Run()</code>ï¼‰</li><li>ä»1.åˆå¼€å§‹é‡å¤æ‰§è¡Œ</li></ol><p>å…·ä½“æ“ä½œå¯çœ‹ä»£ç ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#078;font-weight:700>void</span> IOManager<span style=color:#555>::</span>Idle() {
</span></span><span style=display:flex><span>    LOG <span style=color:#555>&lt;&lt;</span> <span style=color:#c30>&#34;idle coroutine start up</span><span style=color:#c30;font-weight:700>\n</span><span style=color:#c30>&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>const</span> <span style=color:#078;font-weight:700>int</span> MAX_EVENTS <span style=color:#555>=</span> <span style=color:#f60>256</span>;
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>const</span> <span style=color:#078;font-weight:700>int</span> MAX_TIMEOUT <span style=color:#555>=</span> <span style=color:#f60>5000</span>;
</span></span><span style=display:flex><span>    epoll_event events[MAX_EVENTS]{};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>while</span> (<span style=color:#366>true</span>) {
</span></span><span style=display:flex><span>        <span style=color:#09f;font-style:italic>// LOG &lt;&lt; &#34;in idle now\n&#34;;
</span></span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>if</span> (IsStop()) {
</span></span><span style=display:flex><span>            LOG <span style=color:#555>&lt;&lt;</span> GetName() <span style=color:#555>&lt;&lt;</span> <span style=color:#c30>&#34;idle stop now</span><span style=color:#c30;font-weight:700>\n</span><span style=color:#c30>&#34;</span>;
</span></span><span style=display:flex><span>            <span style=color:#069;font-weight:700>break</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#078;font-weight:700>uint64_t</span> next_timeout <span style=color:#555>=</span> GetNextTimerInterval();
</span></span><span style=display:flex><span>        <span style=color:#078;font-weight:700>int</span> triggered_events;
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>do</span> {
</span></span><span style=display:flex><span>            <span style=color:#09f;font-style:italic>// å¦‚æœæ—¶é—´å †ä¸­æœ‰è¶…æ—¶çš„å®šæ—¶å™¨ï¼Œåˆ™æ¯”è¾ƒè¿™ä¸ªè¶…æ—¶å®šæ—¶å™¨çš„ä¸‹ä¸€æ¬¡è§¦å‘çš„æ—¶é—´ä¸MAX_TIMEOUTï¼ˆ5sï¼‰ï¼Œé€‰å–æœ€å°å€¼ä½œä¸ºè¶…æ—¶æ—¶é—´
</span></span></span><span style=display:flex><span>            next_timeout <span style=color:#555>=</span> next_timeout <span style=color:#555>!=</span> <span style=color:#555>~</span><span style=color:#f60>0ull</span> <span style=color:#555>?</span> std<span style=color:#555>::</span>min(<span style=color:#069;font-weight:700>static_cast</span><span style=color:#555>&lt;</span><span style=color:#078;font-weight:700>int</span><span style=color:#555>&gt;</span>(next_timeout), MAX_TIMEOUT) <span style=color:#555>:</span> MAX_TIMEOUT;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#09f;font-style:italic>// æ²¡æœ‰äº‹ä»¶åˆ°æ¥æ—¶ä¼šé˜»å¡åœ¨epoll_waitä¸Šï¼Œé™¤éåˆ°äº†è¶…æ—¶æ—¶é—´
</span></span></span><span style=display:flex><span>            triggered_events <span style=color:#555>=</span> epoll_wait(epfd_, events, MAX_EVENTS, <span style=color:#069;font-weight:700>static_cast</span><span style=color:#555>&lt;</span><span style=color:#078;font-weight:700>int</span><span style=color:#555>&gt;</span>(next_timeout));
</span></span><span style=display:flex><span>            <span style=color:#069;font-weight:700>if</span> (triggered_events <span style=color:#555>&lt;</span> <span style=color:#f60>0</span> <span style=color:#555>&amp;&amp;</span> errno <span style=color:#555>==</span> EINTR) {
</span></span><span style=display:flex><span>                <span style=color:#069;font-weight:700>continue</span>;
</span></span><span style=display:flex><span>            } <span style=color:#069;font-weight:700>else</span> {
</span></span><span style=display:flex><span>                <span style=color:#069;font-weight:700>break</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        } <span style=color:#069;font-weight:700>while</span> (<span style=color:#366>true</span>); <span style=color:#09f;font-style:italic>// ç”¨while(true)çš„ç›®çš„æ˜¯ç¡®ä¿åœ¨å‡ºç°ç‰¹å®šé”™è¯¯æƒ…å†µæ—¶èƒ½å¤Ÿé‡æ–°å°è¯•æ‰§è¡Œ epoll_wait
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#09f;font-style:italic>// å°†è¶…æ—¶çš„å®šæ—¶å™¨çš„å›è°ƒå‡½æ•°åŠ å…¥è°ƒåº¦å™¨
</span></span></span><span style=display:flex><span>        <span style=color:#09f;font-style:italic>// è¿™äº›å›è°ƒå‡½æ•°çš„ä½œç”¨å¯èƒ½æ˜¯å…³é—­è¿æ¥ç­‰æ“ä½œ
</span></span></span><span style=display:flex><span>        std<span style=color:#555>::</span>vector<span style=color:#555>&lt;</span>std<span style=color:#555>::</span>function<span style=color:#555>&lt;</span><span style=color:#078;font-weight:700>void</span>()<span style=color:#555>&gt;&gt;</span> cbs <span style=color:#555>=</span> GetExpiredCbList();
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>for</span> (<span style=color:#069;font-weight:700>auto</span><span style=color:#555>&amp;</span> <span style=color:#99f>cb</span> : cbs) {
</span></span><span style=display:flex><span>            Sched(cb);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#09f;font-style:italic>// å¤„ç†äº‹ä»¶
</span></span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>for</span> (<span style=color:#078;font-weight:700>int</span> i <span style=color:#555>=</span> <span style=color:#f60>0</span>; i <span style=color:#555>&lt;</span> triggered_events; i<span style=color:#555>++</span>) {
</span></span><span style=display:flex><span>            epoll_event<span style=color:#555>&amp;</span> event <span style=color:#555>=</span> events[i];
</span></span><span style=display:flex><span>            <span style=color:#09f;font-style:italic>// æ˜¯ä¸€ä¸ªç”¨äºé€šçŸ¥åç¨‹è°ƒåº¦çš„äº‹ä»¶
</span></span></span><span style=display:flex><span>            <span style=color:#09f;font-style:italic>// epollä¸­ç›‘å¬äº†ç”¨äºé€šçŸ¥çš„ç®¡é“è¯»ç«¯fdï¼Œå½“æœ‰æ•°æ®åˆ°æ—¶å³ä¼šè§¦å‘
</span></span></span><span style=display:flex><span>            <span style=color:#069;font-weight:700>if</span> (event.data.fd <span style=color:#555>==</span> tickle_fd_[<span style=color:#f60>0</span>]) {
</span></span><span style=display:flex><span>                <span style=color:#078;font-weight:700>char</span> buf[<span style=color:#f60>256</span>]{};
</span></span><span style=display:flex><span>                <span style=color:#09f;font-style:italic>// å°†ç®¡é“å†…çš„æ•°æ®è¯»å®Œ
</span></span></span><span style=display:flex><span>                <span style=color:#069;font-weight:700>while</span> (read(tickle_fd_[<span style=color:#f60>0</span>], buf, <span style=color:#069;font-weight:700>sizeof</span>(buf)) <span style=color:#555>&gt;</span> <span style=color:#f60>0</span>)
</span></span><span style=display:flex><span>                    ;
</span></span><span style=display:flex><span>                <span style=color:#069;font-weight:700>continue</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#09f;font-style:italic>// FdContext* fd_ctx = (FdContext*) event.data.ptr;
</span></span></span><span style=display:flex><span>            FdContext<span style=color:#555>*</span> fd_ctx <span style=color:#555>=</span> <span style=color:#069;font-weight:700>static_cast</span><span style=color:#555>&lt;</span>FdContext<span style=color:#555>*&gt;</span>(event.data.ptr);
</span></span><span style=display:flex><span>            std<span style=color:#555>::</span>lock_guard lock(fd_ctx<span style=color:#555>-&gt;</span>mutex);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#09f;font-style:italic>// å‘ç”Ÿé”™è¯¯æ—¶ï¼Œå¦‚æœåŸæ¥çš„æ–‡ä»¶æè¿°ç¬¦ä¸Šä¸‹æ–‡ï¼ˆfd_ctxï¼‰ä¸­æœ‰å¯è¯»æˆ–å¯å†™äº‹ä»¶æ ‡å¿—è¢«è®¾ç½®ï¼Œé‚£ä¹ˆç°åœ¨å°†é‡æ–°è§¦å‘è¿™äº›äº‹ä»¶
</span></span></span><span style=display:flex><span>            <span style=color:#069;font-weight:700>if</span> (event.events <span style=color:#555>&amp;</span> (EPOLLERR <span style=color:#555>|</span> EPOLLHUP)) {
</span></span><span style=display:flex><span>                event.events <span style=color:#555>|=</span> (EPOLLIN <span style=color:#555>|</span> EPOLLOUT) <span style=color:#555>&amp;</span> fd_ctx<span style=color:#555>-&gt;</span>events;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#09f;font-style:italic>// è·å–fd_ctxå¯¹åº”çš„äº‹ä»¶
</span></span></span><span style=display:flex><span>            <span style=color:#078;font-weight:700>int</span> real_event <span style=color:#555>=</span> Event<span style=color:#555>::</span>NONE;
</span></span><span style=display:flex><span>            <span style=color:#069;font-weight:700>if</span> (event.events <span style=color:#555>&amp;</span> EPOLLIN) {
</span></span><span style=display:flex><span>                real_event <span style=color:#555>|=</span> Event<span style=color:#555>::</span>READ;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#069;font-weight:700>if</span> (event.events <span style=color:#555>&amp;</span> EPOLLOUT) {
</span></span><span style=display:flex><span>                real_event <span style=color:#555>|=</span> Event<span style=color:#555>::</span>WRITE;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#069;font-weight:700>if</span> ((fd_ctx<span style=color:#555>-&gt;</span>events <span style=color:#555>&amp;</span> real_event) <span style=color:#555>==</span> Event<span style=color:#555>::</span>NONE) {
</span></span><span style=display:flex><span>                <span style=color:#069;font-weight:700>continue</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#09f;font-style:italic>// å¦‚æœè¿˜æœ‰å‰©ä½™äº‹ä»¶ï¼Œåˆ™ä¿®æ”¹ï¼›å¦åˆ™å°†å…¶ä»epollä¸­åˆ é™¤
</span></span></span><span style=display:flex><span>            <span style=color:#09f;font-style:italic>// æ³¨æ„è·å–rest_eventsæ—¶ä¸æ˜¯ä½¿ç”¨çš„event.events &amp; ~real_eventï¼Œå› ä¸ºæ˜¯è¦å»é™¤fd_ctx-&gt;fdä¸­æœ¬æ¬¡è§¦å‘çš„äº‹ä»¶
</span></span></span><span style=display:flex><span>            <span style=color:#078;font-weight:700>int</span> rest_events <span style=color:#555>=</span> fd_ctx<span style=color:#555>-&gt;</span>events <span style=color:#555>&amp;</span> <span style=color:#555>~</span>real_event;
</span></span><span style=display:flex><span>            <span style=color:#078;font-weight:700>int</span> op <span style=color:#555>=</span> rest_events <span style=color:#555>?</span> <span style=color:#99f>EPOLL_CTL_MOD</span> : EPOLL_CTL_DEL;
</span></span><span style=display:flex><span>            event.events <span style=color:#555>=</span> EPOLLET <span style=color:#555>|</span> rest_events;
</span></span><span style=display:flex><span>            <span style=color:#069;font-weight:700>if</span> (epoll_ctl(epfd_, op, fd_ctx<span style=color:#555>-&gt;</span>fd, <span style=color:#555>&amp;</span>event) <span style=color:#555>&lt;</span> <span style=color:#f60>0</span>) {
</span></span><span style=display:flex><span>                LOG_ERROR <span style=color:#555>&lt;&lt;</span> strerror(errno) <span style=color:#555>&lt;&lt;</span> <span style=color:#c30>&#34;</span><span style=color:#c30;font-weight:700>\n</span><span style=color:#c30>&#34;</span>;
</span></span><span style=display:flex><span>                <span style=color:#069;font-weight:700>continue</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#069;font-weight:700>if</span> (real_event <span style=color:#555>&amp;</span> Event<span style=color:#555>::</span>READ) {
</span></span><span style=display:flex><span>                fd_ctx<span style=color:#555>-&gt;</span>TriggerEvent(Event<span style=color:#555>::</span>READ);
</span></span><span style=display:flex><span>                <span style=color:#555>--</span>pending_evt_cnt_;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#069;font-weight:700>if</span> (real_event <span style=color:#555>&amp;</span> Event<span style=color:#555>::</span>WRITE) {
</span></span><span style=display:flex><span>                fd_ctx<span style=color:#555>-&gt;</span>TriggerEvent(Event<span style=color:#555>::</span>WRITE);
</span></span><span style=display:flex><span>                <span style=color:#555>--</span>pending_evt_cnt_;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#09f;font-style:italic>// å°†å½“å‰çº¿ç¨‹è¿è¡Œçš„åç¨‹æš‚åœï¼ˆä¹Ÿå°±æ˜¯æš‚åœIdleåç¨‹ï¼‰ï¼Œå¹¶å°†æ‰§è¡Œæƒäº¤ç»™è°ƒåº¦åç¨‹
</span></span></span><span style=display:flex><span>        Coroutine<span style=color:#555>::</span>Ptr co_ptr <span style=color:#555>=</span> Coroutine<span style=color:#555>::</span>GetNowCoroutine();
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>auto</span> co <span style=color:#555>=</span> co_ptr.get();
</span></span><span style=display:flex><span>        co_ptr.reset();
</span></span><span style=display:flex><span>        co<span style=color:#555>-&gt;</span>Yield();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=æ·»åŠ äº‹ä»¶>æ·»åŠ äº‹ä»¶<a hidden class=anchor aria-hidden=true href=#æ·»åŠ äº‹ä»¶>#</a></h2><p>IOManageré™¤äº†é‡å†™Idleå‡½æ•°è¿™ä¸ªé‡è¦ç‚¹å¤–ï¼Œè¿˜æœ‰ä¸ªé‡è¦ç‚¹å°±æ˜¯ä¸ºæŒ‡å®šæ–‡ä»¶æè¿°ç¬¦æ·»åŠ äº‹ä»¶ã€‚</p><p>IOManagerå†…éƒ¨æœ‰ä¸€ä¸ª[<code>FdContext</code>](#IOManger API)ç»“æ„ä½“ç”¨æ¥å°è£…socket fdçš„ä¸Šä¸‹æ–‡ï¼ˆéœ€è¦ç»‘å®šçš„å›è°ƒå‡½æ•°ï¼Œå¯¹åº”çš„äº‹ä»¶ã€åç¨‹ï¼‰ï¼Œå¹¶ä½¿ç”¨ä¸€ä¸ªvectorä¿å­˜è¿™äº›FdContextã€‚</p><p>æˆ‘ä»¬åœ¨æ·»åŠ fdçš„äº‹ä»¶æ—¶ï¼Œéœ€è¦å°†å…¶åŠ å…¥vectorä¸­ï¼Œå¹¶ä¸”éœ€è¦é€šè¿‡<code>epoll_ctl</code>æ³¨å†Œfdçš„å¯¹åº”äº‹ä»¶ã€‚</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#078;font-weight:700>bool</span> IOManager<span style=color:#555>::</span>AddEvent(<span style=color:#078;font-weight:700>int</span> fd, Event event, std<span style=color:#555>::</span>function<span style=color:#555>&lt;</span><span style=color:#078;font-weight:700>void</span>()<span style=color:#555>&gt;</span> cb) {
</span></span><span style=display:flex><span>    FdContext<span style=color:#555>*</span> fd_ctx <span style=color:#555>=</span> <span style=color:#069;font-weight:700>nullptr</span>;
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        std<span style=color:#555>::</span>shared_lock rw_lock(rw_mutex_);
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>if</span> (fd_contexts_.size() <span style=color:#555>&gt;</span> fd) {
</span></span><span style=display:flex><span>            fd_ctx <span style=color:#555>=</span> fd_contexts_[fd];
</span></span><span style=display:flex><span>            rw_lock.unlock();
</span></span><span style=display:flex><span>        } <span style=color:#069;font-weight:700>else</span> {
</span></span><span style=display:flex><span>            rw_lock.unlock();
</span></span><span style=display:flex><span>            std<span style=color:#555>::</span>unique_lock rw_lock2(rw_mutex_);
</span></span><span style=display:flex><span>            ResizeContexts(fd <span style=color:#555>*</span> <span style=color:#f60>1.5</span>);
</span></span><span style=display:flex><span>            fd_ctx <span style=color:#555>=</span> fd_contexts_[fd];
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    std<span style=color:#555>::</span>lock_guard lock(mutex_);
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>if</span> (fd_ctx<span style=color:#555>-&gt;</span>events <span style=color:#555>&amp;</span> event) {
</span></span><span style=display:flex><span>        LOG_ERROR <span style=color:#555>&lt;&lt;</span> <span style=color:#c30>&#34;A fd can&#39;t add same event</span><span style=color:#c30;font-weight:700>\n</span><span style=color:#c30>&#34;</span>;
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>return</span> <span style=color:#366>false</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>int</span> op <span style=color:#555>=</span> fd_ctx<span style=color:#555>-&gt;</span>events <span style=color:#555>?</span> <span style=color:#99f>EPOLL_CTL_MOD</span> : EPOLL_CTL_ADD;
</span></span><span style=display:flex><span>    epoll_event ep_evt{};
</span></span><span style=display:flex><span>    ep_evt.events <span style=color:#555>=</span> <span style=color:#069;font-weight:700>static_cast</span><span style=color:#555>&lt;</span><span style=color:#078;font-weight:700>int</span><span style=color:#555>&gt;</span>(fd_ctx<span style=color:#555>-&gt;</span>events) <span style=color:#555>|</span> EPOLLET <span style=color:#555>|</span> event;
</span></span><span style=display:flex><span>    ep_evt.data.ptr <span style=color:#555>=</span> fd_ctx; <span style=color:#09f;font-style:italic>// åœ¨Idle()ä¸­å°†ä½¿ç”¨fdå¯¹åº”çš„è¿™ä¸ªep_evt
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>int</span> ret <span style=color:#555>=</span> epoll_ctl(epfd_, op, fd, <span style=color:#555>&amp;</span>ep_evt);
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>if</span> (ret) {
</span></span><span style=display:flex><span>        LOG_ERROR <span style=color:#555>&lt;&lt;</span> <span style=color:#c30>&#34;epoll_ctl &#34;</span> <span style=color:#555>&lt;&lt;</span> strerror(errno);
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>return</span> <span style=color:#366>false</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#555>++</span>pending_evt_cnt_;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#09f;font-style:italic>// è®¾ç½®fdå¯¹åº”äº‹ä»¶çš„EventContext
</span></span></span><span style=display:flex><span>    fd_ctx<span style=color:#555>-&gt;</span>events <span style=color:#555>=</span> <span style=color:#069;font-weight:700>static_cast</span><span style=color:#555>&lt;</span>Event<span style=color:#555>&gt;</span>(fd_ctx<span style=color:#555>-&gt;</span>events <span style=color:#555>|</span> event);
</span></span><span style=display:flex><span>    <span style=color:#09f;font-style:italic>// ä½¿ç”¨event_ctxç›¸å½“äºä½¿ç”¨fd_ctx-&gt;read_ctx or fd_ctx-&gt;write_ctxï¼ˆæ³¨æ„æ˜¯auto&amp;è€Œä¸æ˜¯autoï¼‰
</span></span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>auto</span><span style=color:#555>&amp;</span> event_ctx <span style=color:#555>=</span> fd_ctx<span style=color:#555>-&gt;</span>GetEventContext(event);
</span></span><span style=display:flex><span>    assert(<span style=color:#555>!</span>event_ctx.scheduler <span style=color:#555>&amp;&amp;</span> <span style=color:#555>!</span>event_ctx.callback <span style=color:#555>&amp;&amp;</span> <span style=color:#555>!</span>event_ctx.coroutine);
</span></span><span style=display:flex><span>    event_ctx.scheduler <span style=color:#555>=</span> Scheduler<span style=color:#555>::</span>GetScheduler();
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>if</span> (cb) {
</span></span><span style=display:flex><span>        event_ctx.callback <span style=color:#555>=</span> cb;
</span></span><span style=display:flex><span>    } <span style=color:#069;font-weight:700>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#09f;font-style:italic>// è®¾ç½®fdç›¸å…³äº‹ä»¶è§¦å‘æ—¶ä½¿ç”¨çš„åç¨‹ä¸ºå½“å‰
</span></span></span><span style=display:flex><span>        event_ctx.coroutine <span style=color:#555>=</span> Coroutine<span style=color:#555>::</span>GetNowCoroutine();
</span></span><span style=display:flex><span>        assert(event_ctx.coroutine<span style=color:#555>-&gt;</span>GetState() <span style=color:#555>==</span> Coroutine<span style=color:#555>::</span>RUNNING);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>return</span> <span style=color:#366>true</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div><footer class=post-footer><nav class=paginav><a class=prev href=https://kerolt.github.io/posts/%E5%8A%A8%E6%89%8B%E5%AE%9E%E7%8E%B0x/%E5%8A%A8%E6%89%8B%E5%86%99%E5%8D%8F%E7%A8%8B%E5%BA%93-5%E5%B8%B8%E7%94%A8io%E5%87%BD%E6%95%B0%E7%9A%84hook%E5%8A%9F%E8%83%BD/><span class=title>Â« Prev</span><br><span>ã€åŠ¨æ‰‹å†™åç¨‹åº“ 5ã€‘å¸¸ç”¨IOå‡½æ•°çš„HOOKåŠŸèƒ½</span>
</a><a class=next href=https://kerolt.github.io/posts/%E5%8A%A8%E6%89%8B%E5%AE%9E%E7%8E%B0x/%E5%8A%A8%E6%89%8B%E5%86%99%E5%8D%8F%E7%A8%8B%E5%BA%93-3%E5%AE%9A%E6%97%B6%E5%99%A8/><span class=title>Next Â»</span><br><span>ã€åŠ¨æ‰‹å†™åç¨‹åº“ 3ã€‘å®šæ—¶å™¨</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2026 <a href=https://kerolt.github.io/>Kerolt's Blog</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>