<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>åˆ©ç”¨eBPFä¸perf_eventè®°å½•ç³»ç»Ÿè°ƒç”¨æ ˆ | Kerolt's Blog</title><meta name=keywords content="eBPF,perf,cpp"><meta name=description content="perf_event_open


  
    
  



perf åŸç†å›¾ï¼šhttps://plantegg.github.io/2021/05/16/Perf_IPC%E4%BB%A5%E5%8F%8ACPU%E5%88%A9%E7%94%A8%E7%8E%87/

åœ¨ç”¨æˆ·æ€ä¸­è§¦å‘ sys_perf_event_open ç³»ç»Ÿè°ƒç”¨ï¼Œå†…æ ¸é™·å…¥ä¸­æ–­ä»¥åä¼šè°ƒç”¨ perf_event_open æ¥å¤„ç†ã€‚åœ¨ç”¨æˆ·æ€ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å¦‚ä¸‹çš„ä»£ç æ¥ä½¿ç”¨ï¼š
#include <linux/perf_event.h>
#include <sys/syscall.h>
#include <unistd.h>

int64_t perf_event_open(struct perf_event_attr* hw_event, pid_t pid, int cpu,
                     int group_fd, unsigned long flags) ->  {
    return syscall(SYS_perf_event_open, hw_event, pid, cpu, group_fd, flags);
}
ä»¥æ–‡ä»¶æè¿°ç¬¦ä¸ºä¸­å¿ƒçš„â€œæµ‹é‡å•å…ƒâ€
åœ¨ Linux ä¸­ï¼Œâ€œä¸€åˆ‡çš†æ–‡ä»¶â€ã€‚å½“è°ƒç”¨ perf_event_open æ—¶ï¼Œå†…æ ¸åˆ›å»ºäº†ä¸€ä¸ªç‹¬ç«‹çš„æµ‹é‡å®ä¾‹ã€‚
æ¯ä¸ªæ–‡ä»¶æè¿°ç¬¦ä»£è¡¨ä¸€ä¸ªç›‘æ§ä»»åŠ¡ï¼ˆ1 fd == 1 Eventï¼Œæ¯”å¦‚â€œç›‘æ§ CPU 0 çš„æŒ‡ä»¤æ‰§è¡Œæ•°â€ï¼‰ã€‚
åŒæ—¶ï¼Œå¯ä»¥æŠŠå¤šä¸ª fd ç»‘åœ¨ä¸€èµ·ï¼Œå³ä¸ºäº‹ä»¶åˆ†ç»„ (Group)ï¼š

ä¾‹å¦‚ä½ æƒ³è®¡ç®—â€œæ¯æ¡æŒ‡ä»¤çš„ç¼“å­˜æœªå‘½ä¸­ç‡â€ï¼Œä½ éœ€è¦åŒæ—¶æµ‹é‡â€œæŒ‡ä»¤æ•°â€å’Œâ€œç¼“å­˜æœªå‘½ä¸­æ•°â€ã€‚å°†å®ƒä»¬åˆ†ç»„å¯ä»¥ç¡®ä¿è¿™ä¸¤ä¸ªäº‹ä»¶åœ¨ç¡¬ä»¶ä¸Šæ˜¯åŒæ—¶å¼€å§‹ã€åŒæ—¶ç»“æŸçš„ï¼Œä»è€Œä¿è¯æ¯”ä¾‹çš„å‡†ç¡®æ€§ã€‚

çŠ¶æ€æ§åˆ¶ï¼šioctl ä¸ prctl
äº‹ä»¶åˆ›å»ºåï¼Œå¹¶ä¸ä¸€å®šç«‹å³å¼€å§‹å·¥ä½œï¼Œä½ å¯ä»¥åƒæ§åˆ¶å¼€å…³ä¸€æ ·æ§åˆ¶å®ƒã€‚


ioctl (Input/Output Control)ï¼šè¿™æ˜¯æœ€å¸¸ç”¨çš„æ–¹å¼ï¼Œç›´æ¥é’ˆå¯¹æŸä¸ª fd è¿›è¡Œæ“ä½œã€‚

ioctl(fd, PERF_EVENT_IOC_ENABLE)ï¼šæ‰“å¼€å¼€å…³ã€‚
ioctl(fd, PERF_EVENT_IOC_DISABLE)ï¼šå…³é—­å¼€å…³ã€‚



prctl (Process Control)ï¼šè¿™æ˜¯é’ˆå¯¹å½“å‰è¿›ç¨‹åŠå…¶æ‰€æœ‰äº‹ä»¶çš„æ“ä½œã€‚

å¦‚æœä½ æœ‰ 10 ä¸ªæµ‹é‡äº‹ä»¶ï¼Œä¸éœ€è¦ä¸€ä¸ªä¸ª ioctlï¼Œå¯ä»¥ç”¨ prctl ä¸€æ¬¡æ€§å…¨éƒ¨å¯ç”¨æˆ–ç¦ç”¨ã€‚



â€œä¿æŒå­˜åœ¨â€çš„æ„ä¹‰ï¼šç¦ç”¨äº‹ä»¶åªæ˜¯è®©è®¡æ•°å™¨åœæ­¢ï¼Œå®ƒä¸ä¼šé”€æ¯æ•°æ®ã€‚è¿™å…è®¸ä½ åœ¨ç¨‹åºè¿è¡Œçš„ç‰¹å®šç‰‡æ®µï¼ˆæ¯”å¦‚åªåœ¨æŸä¸ªæ ¸å¿ƒç®—æ³•æ‰§è¡ŒæœŸé—´ï¼‰å¼€å¯ç›‘æ§ã€‚"><meta name=author content="Kerolt"><link rel=canonical href=https://kerolt.github.io/posts/ebpf/%E5%88%A9%E7%94%A8ebpf%E4%B8%8Eperf_event%E8%AE%B0%E5%BD%95%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E6%A0%88/><meta name=google-site-verification content="NpIO0KEIJS0CPRzTzQCbYQdSRIyb0Lspx"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="2300A23B82DB579A2DEA6261191AD771"><link crossorigin=anonymous href=/assets/css/stylesheet.3718db6239f5ea38d922de918992363f38eaa34001199db68f4080db5c913b1d.css integrity="sha256-NxjbYjn16jjZIt6RiZI2Pzjqo0ABGZ22j0CA21yROx0=" rel="preload stylesheet" as=style><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/cn-fontsource-source-han-serif-sc-vf@1.0.9/font.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-screen-web/style.css><link rel=icon href=https://kerolt.github.io/images/avatar/favicon.png><link rel=icon type=image/png sizes=16x16 href=https://kerolt.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://kerolt.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://kerolt.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://kerolt.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://kerolt.github.io/posts/ebpf/%E5%88%A9%E7%94%A8ebpf%E4%B8%8Eperf_event%E8%AE%B0%E5%BD%95%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E6%A0%88/><script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css><script src=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js></script><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://kerolt.github.io/posts/ebpf/%E5%88%A9%E7%94%A8ebpf%E4%B8%8Eperf_event%E8%AE%B0%E5%BD%95%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E6%A0%88/"><meta property="og:site_name" content="Kerolt's Blog"><meta property="og:title" content="åˆ©ç”¨eBPFä¸perf_eventè®°å½•ç³»ç»Ÿè°ƒç”¨æ ˆ"><meta property="og:description" content="perf_event_open perf åŸç†å›¾ï¼šhttps://plantegg.github.io/2021/05/16/Perf_IPC%E4%BB%A5%E5%8F%8ACPU%E5%88%A9%E7%94%A8%E7%8E%87/
åœ¨ç”¨æˆ·æ€ä¸­è§¦å‘ sys_perf_event_open ç³»ç»Ÿè°ƒç”¨ï¼Œå†…æ ¸é™·å…¥ä¸­æ–­ä»¥åä¼šè°ƒç”¨ perf_event_open æ¥å¤„ç†ã€‚åœ¨ç”¨æˆ·æ€ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å¦‚ä¸‹çš„ä»£ç æ¥ä½¿ç”¨ï¼š
#include <linux/perf_event.h> #include <sys/syscall.h> #include <unistd.h> int64_t perf_event_open(struct perf_event_attr* hw_event, pid_t pid, int cpu, int group_fd, unsigned long flags) -> { return syscall(SYS_perf_event_open, hw_event, pid, cpu, group_fd, flags); } ä»¥æ–‡ä»¶æè¿°ç¬¦ä¸ºä¸­å¿ƒçš„â€œæµ‹é‡å•å…ƒâ€ åœ¨ Linux ä¸­ï¼Œâ€œä¸€åˆ‡çš†æ–‡ä»¶â€ã€‚å½“è°ƒç”¨ perf_event_open æ—¶ï¼Œå†…æ ¸åˆ›å»ºäº†ä¸€ä¸ªç‹¬ç«‹çš„æµ‹é‡å®ä¾‹ã€‚
æ¯ä¸ªæ–‡ä»¶æè¿°ç¬¦ä»£è¡¨ä¸€ä¸ªç›‘æ§ä»»åŠ¡ï¼ˆ1 fd == 1 Eventï¼Œæ¯”å¦‚â€œç›‘æ§ CPU 0 çš„æŒ‡ä»¤æ‰§è¡Œæ•°â€ï¼‰ã€‚
åŒæ—¶ï¼Œå¯ä»¥æŠŠå¤šä¸ª fd ç»‘åœ¨ä¸€èµ·ï¼Œå³ä¸ºäº‹ä»¶åˆ†ç»„ (Group)ï¼š
ä¾‹å¦‚ä½ æƒ³è®¡ç®—â€œæ¯æ¡æŒ‡ä»¤çš„ç¼“å­˜æœªå‘½ä¸­ç‡â€ï¼Œä½ éœ€è¦åŒæ—¶æµ‹é‡â€œæŒ‡ä»¤æ•°â€å’Œâ€œç¼“å­˜æœªå‘½ä¸­æ•°â€ã€‚å°†å®ƒä»¬åˆ†ç»„å¯ä»¥ç¡®ä¿è¿™ä¸¤ä¸ªäº‹ä»¶åœ¨ç¡¬ä»¶ä¸Šæ˜¯åŒæ—¶å¼€å§‹ã€åŒæ—¶ç»“æŸçš„ï¼Œä»è€Œä¿è¯æ¯”ä¾‹çš„å‡†ç¡®æ€§ã€‚ çŠ¶æ€æ§åˆ¶ï¼šioctl ä¸ prctl äº‹ä»¶åˆ›å»ºåï¼Œå¹¶ä¸ä¸€å®šç«‹å³å¼€å§‹å·¥ä½œï¼Œä½ å¯ä»¥åƒæ§åˆ¶å¼€å…³ä¸€æ ·æ§åˆ¶å®ƒã€‚
ioctl (Input/Output Control)ï¼šè¿™æ˜¯æœ€å¸¸ç”¨çš„æ–¹å¼ï¼Œç›´æ¥é’ˆå¯¹æŸä¸ª fd è¿›è¡Œæ“ä½œã€‚
ioctl(fd, PERF_EVENT_IOC_ENABLE)ï¼šæ‰“å¼€å¼€å…³ã€‚ ioctl(fd, PERF_EVENT_IOC_DISABLE)ï¼šå…³é—­å¼€å…³ã€‚ prctl (Process Control)ï¼šè¿™æ˜¯é’ˆå¯¹å½“å‰è¿›ç¨‹åŠå…¶æ‰€æœ‰äº‹ä»¶çš„æ“ä½œã€‚
å¦‚æœä½ æœ‰ 10 ä¸ªæµ‹é‡äº‹ä»¶ï¼Œä¸éœ€è¦ä¸€ä¸ªä¸ª ioctlï¼Œå¯ä»¥ç”¨ prctl ä¸€æ¬¡æ€§å…¨éƒ¨å¯ç”¨æˆ–ç¦ç”¨ã€‚ â€œä¿æŒå­˜åœ¨â€çš„æ„ä¹‰ï¼šç¦ç”¨äº‹ä»¶åªæ˜¯è®©è®¡æ•°å™¨åœæ­¢ï¼Œå®ƒä¸ä¼šé”€æ¯æ•°æ®ã€‚è¿™å…è®¸ä½ åœ¨ç¨‹åºè¿è¡Œçš„ç‰¹å®šç‰‡æ®µï¼ˆæ¯”å¦‚åªåœ¨æŸä¸ªæ ¸å¿ƒç®—æ³•æ‰§è¡ŒæœŸé—´ï¼‰å¼€å¯ç›‘æ§ã€‚"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2026-01-23T00:00:00+00:00"><meta property="article:modified_time" content="2026-01-24T00:00:00+00:00"><meta property="article:tag" content="EBPF"><meta property="article:tag" content="Perf"><meta property="article:tag" content="Cpp"><meta property="og:image" content="https://kerolt.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://kerolt.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="åˆ©ç”¨eBPFä¸perf_eventè®°å½•ç³»ç»Ÿè°ƒç”¨æ ˆ"><meta name=twitter:description content="perf_event_open


  
    
  



perf åŸç†å›¾ï¼šhttps://plantegg.github.io/2021/05/16/Perf_IPC%E4%BB%A5%E5%8F%8ACPU%E5%88%A9%E7%94%A8%E7%8E%87/

åœ¨ç”¨æˆ·æ€ä¸­è§¦å‘ sys_perf_event_open ç³»ç»Ÿè°ƒç”¨ï¼Œå†…æ ¸é™·å…¥ä¸­æ–­ä»¥åä¼šè°ƒç”¨ perf_event_open æ¥å¤„ç†ã€‚åœ¨ç”¨æˆ·æ€ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å¦‚ä¸‹çš„ä»£ç æ¥ä½¿ç”¨ï¼š
#include <linux/perf_event.h>
#include <sys/syscall.h>
#include <unistd.h>

int64_t perf_event_open(struct perf_event_attr* hw_event, pid_t pid, int cpu,
                     int group_fd, unsigned long flags) ->  {
    return syscall(SYS_perf_event_open, hw_event, pid, cpu, group_fd, flags);
}
ä»¥æ–‡ä»¶æè¿°ç¬¦ä¸ºä¸­å¿ƒçš„â€œæµ‹é‡å•å…ƒâ€
åœ¨ Linux ä¸­ï¼Œâ€œä¸€åˆ‡çš†æ–‡ä»¶â€ã€‚å½“è°ƒç”¨ perf_event_open æ—¶ï¼Œå†…æ ¸åˆ›å»ºäº†ä¸€ä¸ªç‹¬ç«‹çš„æµ‹é‡å®ä¾‹ã€‚
æ¯ä¸ªæ–‡ä»¶æè¿°ç¬¦ä»£è¡¨ä¸€ä¸ªç›‘æ§ä»»åŠ¡ï¼ˆ1 fd == 1 Eventï¼Œæ¯”å¦‚â€œç›‘æ§ CPU 0 çš„æŒ‡ä»¤æ‰§è¡Œæ•°â€ï¼‰ã€‚
åŒæ—¶ï¼Œå¯ä»¥æŠŠå¤šä¸ª fd ç»‘åœ¨ä¸€èµ·ï¼Œå³ä¸ºäº‹ä»¶åˆ†ç»„ (Group)ï¼š

ä¾‹å¦‚ä½ æƒ³è®¡ç®—â€œæ¯æ¡æŒ‡ä»¤çš„ç¼“å­˜æœªå‘½ä¸­ç‡â€ï¼Œä½ éœ€è¦åŒæ—¶æµ‹é‡â€œæŒ‡ä»¤æ•°â€å’Œâ€œç¼“å­˜æœªå‘½ä¸­æ•°â€ã€‚å°†å®ƒä»¬åˆ†ç»„å¯ä»¥ç¡®ä¿è¿™ä¸¤ä¸ªäº‹ä»¶åœ¨ç¡¬ä»¶ä¸Šæ˜¯åŒæ—¶å¼€å§‹ã€åŒæ—¶ç»“æŸçš„ï¼Œä»è€Œä¿è¯æ¯”ä¾‹çš„å‡†ç¡®æ€§ã€‚

çŠ¶æ€æ§åˆ¶ï¼šioctl ä¸ prctl
äº‹ä»¶åˆ›å»ºåï¼Œå¹¶ä¸ä¸€å®šç«‹å³å¼€å§‹å·¥ä½œï¼Œä½ å¯ä»¥åƒæ§åˆ¶å¼€å…³ä¸€æ ·æ§åˆ¶å®ƒã€‚


ioctl (Input/Output Control)ï¼šè¿™æ˜¯æœ€å¸¸ç”¨çš„æ–¹å¼ï¼Œç›´æ¥é’ˆå¯¹æŸä¸ª fd è¿›è¡Œæ“ä½œã€‚

ioctl(fd, PERF_EVENT_IOC_ENABLE)ï¼šæ‰“å¼€å¼€å…³ã€‚
ioctl(fd, PERF_EVENT_IOC_DISABLE)ï¼šå…³é—­å¼€å…³ã€‚



prctl (Process Control)ï¼šè¿™æ˜¯é’ˆå¯¹å½“å‰è¿›ç¨‹åŠå…¶æ‰€æœ‰äº‹ä»¶çš„æ“ä½œã€‚

å¦‚æœä½ æœ‰ 10 ä¸ªæµ‹é‡äº‹ä»¶ï¼Œä¸éœ€è¦ä¸€ä¸ªä¸ª ioctlï¼Œå¯ä»¥ç”¨ prctl ä¸€æ¬¡æ€§å…¨éƒ¨å¯ç”¨æˆ–ç¦ç”¨ã€‚



â€œä¿æŒå­˜åœ¨â€çš„æ„ä¹‰ï¼šç¦ç”¨äº‹ä»¶åªæ˜¯è®©è®¡æ•°å™¨åœæ­¢ï¼Œå®ƒä¸ä¼šé”€æ¯æ•°æ®ã€‚è¿™å…è®¸ä½ åœ¨ç¨‹åºè¿è¡Œçš„ç‰¹å®šç‰‡æ®µï¼ˆæ¯”å¦‚åªåœ¨æŸä¸ªæ ¸å¿ƒç®—æ³•æ‰§è¡ŒæœŸé—´ï¼‰å¼€å¯ç›‘æ§ã€‚"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://kerolt.github.io/posts/"},{"@type":"ListItem","position":2,"name":"åˆ©ç”¨eBPFä¸perf_eventè®°å½•ç³»ç»Ÿè°ƒç”¨æ ˆ","item":"https://kerolt.github.io/posts/ebpf/%E5%88%A9%E7%94%A8ebpf%E4%B8%8Eperf_event%E8%AE%B0%E5%BD%95%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E6%A0%88/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"åˆ©ç”¨eBPFä¸perf_eventè®°å½•ç³»ç»Ÿè°ƒç”¨æ ˆ","name":"åˆ©ç”¨eBPFä¸perf_eventè®°å½•ç³»ç»Ÿè°ƒç”¨æ ˆ","description":"perf_event_open perf åŸç†å›¾ï¼šhttps://plantegg.github.io/2021/05/16/Perf_IPC%E4%BB%A5%E5%8F%8ACPU%E5%88%A9%E7%94%A8%E7%8E%87/\nåœ¨ç”¨æˆ·æ€ä¸­è§¦å‘ sys_perf_event_open ç³»ç»Ÿè°ƒç”¨ï¼Œå†…æ ¸é™·å…¥ä¸­æ–­ä»¥åä¼šè°ƒç”¨ perf_event_open æ¥å¤„ç†ã€‚åœ¨ç”¨æˆ·æ€ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å¦‚ä¸‹çš„ä»£ç æ¥ä½¿ç”¨ï¼š\n#include \u0026lt;linux/perf_event.h\u0026gt; #include \u0026lt;sys/syscall.h\u0026gt; #include \u0026lt;unistd.h\u0026gt; int64_t perf_event_open(struct perf_event_attr* hw_event, pid_t pid, int cpu, int group_fd, unsigned long flags) -\u0026gt; { return syscall(SYS_perf_event_open, hw_event, pid, cpu, group_fd, flags); } ä»¥æ–‡ä»¶æè¿°ç¬¦ä¸ºä¸­å¿ƒçš„â€œæµ‹é‡å•å…ƒâ€ åœ¨ Linux ä¸­ï¼Œâ€œä¸€åˆ‡çš†æ–‡ä»¶â€ã€‚å½“è°ƒç”¨ perf_event_open æ—¶ï¼Œå†…æ ¸åˆ›å»ºäº†ä¸€ä¸ªç‹¬ç«‹çš„æµ‹é‡å®ä¾‹ã€‚\næ¯ä¸ªæ–‡ä»¶æè¿°ç¬¦ä»£è¡¨ä¸€ä¸ªç›‘æ§ä»»åŠ¡ï¼ˆ1 fd == 1 Eventï¼Œæ¯”å¦‚â€œç›‘æ§ CPU 0 çš„æŒ‡ä»¤æ‰§è¡Œæ•°â€ï¼‰ã€‚\nåŒæ—¶ï¼Œå¯ä»¥æŠŠå¤šä¸ª fd ç»‘åœ¨ä¸€èµ·ï¼Œå³ä¸ºäº‹ä»¶åˆ†ç»„ (Group)ï¼š\nä¾‹å¦‚ä½ æƒ³è®¡ç®—â€œæ¯æ¡æŒ‡ä»¤çš„ç¼“å­˜æœªå‘½ä¸­ç‡â€ï¼Œä½ éœ€è¦åŒæ—¶æµ‹é‡â€œæŒ‡ä»¤æ•°â€å’Œâ€œç¼“å­˜æœªå‘½ä¸­æ•°â€ã€‚å°†å®ƒä»¬åˆ†ç»„å¯ä»¥ç¡®ä¿è¿™ä¸¤ä¸ªäº‹ä»¶åœ¨ç¡¬ä»¶ä¸Šæ˜¯åŒæ—¶å¼€å§‹ã€åŒæ—¶ç»“æŸçš„ï¼Œä»è€Œä¿è¯æ¯”ä¾‹çš„å‡†ç¡®æ€§ã€‚ çŠ¶æ€æ§åˆ¶ï¼šioctl ä¸ prctl äº‹ä»¶åˆ›å»ºåï¼Œå¹¶ä¸ä¸€å®šç«‹å³å¼€å§‹å·¥ä½œï¼Œä½ å¯ä»¥åƒæ§åˆ¶å¼€å…³ä¸€æ ·æ§åˆ¶å®ƒã€‚\nioctl (Input/Output Control)ï¼šè¿™æ˜¯æœ€å¸¸ç”¨çš„æ–¹å¼ï¼Œç›´æ¥é’ˆå¯¹æŸä¸ª fd è¿›è¡Œæ“ä½œã€‚\nioctl(fd, PERF_EVENT_IOC_ENABLE)ï¼šæ‰“å¼€å¼€å…³ã€‚ ioctl(fd, PERF_EVENT_IOC_DISABLE)ï¼šå…³é—­å¼€å…³ã€‚ prctl (Process Control)ï¼šè¿™æ˜¯é’ˆå¯¹å½“å‰è¿›ç¨‹åŠå…¶æ‰€æœ‰äº‹ä»¶çš„æ“ä½œã€‚\nå¦‚æœä½ æœ‰ 10 ä¸ªæµ‹é‡äº‹ä»¶ï¼Œä¸éœ€è¦ä¸€ä¸ªä¸ª ioctlï¼Œå¯ä»¥ç”¨ prctl ä¸€æ¬¡æ€§å…¨éƒ¨å¯ç”¨æˆ–ç¦ç”¨ã€‚ â€œä¿æŒå­˜åœ¨â€çš„æ„ä¹‰ï¼šç¦ç”¨äº‹ä»¶åªæ˜¯è®©è®¡æ•°å™¨åœæ­¢ï¼Œå®ƒä¸ä¼šé”€æ¯æ•°æ®ã€‚è¿™å…è®¸ä½ åœ¨ç¨‹åºè¿è¡Œçš„ç‰¹å®šç‰‡æ®µï¼ˆæ¯”å¦‚åªåœ¨æŸä¸ªæ ¸å¿ƒç®—æ³•æ‰§è¡ŒæœŸé—´ï¼‰å¼€å¯ç›‘æ§ã€‚\n","keywords":["eBPF","perf","cpp"],"articleBody":"perf_event_open perf åŸç†å›¾ï¼šhttps://plantegg.github.io/2021/05/16/Perf_IPC%E4%BB%A5%E5%8F%8ACPU%E5%88%A9%E7%94%A8%E7%8E%87/\nåœ¨ç”¨æˆ·æ€ä¸­è§¦å‘ sys_perf_event_open ç³»ç»Ÿè°ƒç”¨ï¼Œå†…æ ¸é™·å…¥ä¸­æ–­ä»¥åä¼šè°ƒç”¨ perf_event_open æ¥å¤„ç†ã€‚åœ¨ç”¨æˆ·æ€ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å¦‚ä¸‹çš„ä»£ç æ¥ä½¿ç”¨ï¼š\n#include #include #include int64_t perf_event_open(struct perf_event_attr* hw_event, pid_t pid, int cpu, int group_fd, unsigned long flags) -\u003e { return syscall(SYS_perf_event_open, hw_event, pid, cpu, group_fd, flags); } ä»¥æ–‡ä»¶æè¿°ç¬¦ä¸ºä¸­å¿ƒçš„â€œæµ‹é‡å•å…ƒâ€ åœ¨ Linux ä¸­ï¼Œâ€œä¸€åˆ‡çš†æ–‡ä»¶â€ã€‚å½“è°ƒç”¨ perf_event_open æ—¶ï¼Œå†…æ ¸åˆ›å»ºäº†ä¸€ä¸ªç‹¬ç«‹çš„æµ‹é‡å®ä¾‹ã€‚\næ¯ä¸ªæ–‡ä»¶æè¿°ç¬¦ä»£è¡¨ä¸€ä¸ªç›‘æ§ä»»åŠ¡ï¼ˆ1 fd == 1 Eventï¼Œæ¯”å¦‚â€œç›‘æ§ CPU 0 çš„æŒ‡ä»¤æ‰§è¡Œæ•°â€ï¼‰ã€‚\nåŒæ—¶ï¼Œå¯ä»¥æŠŠå¤šä¸ª fd ç»‘åœ¨ä¸€èµ·ï¼Œå³ä¸ºäº‹ä»¶åˆ†ç»„ (Group)ï¼š\nä¾‹å¦‚ä½ æƒ³è®¡ç®—â€œæ¯æ¡æŒ‡ä»¤çš„ç¼“å­˜æœªå‘½ä¸­ç‡â€ï¼Œä½ éœ€è¦åŒæ—¶æµ‹é‡â€œæŒ‡ä»¤æ•°â€å’Œâ€œç¼“å­˜æœªå‘½ä¸­æ•°â€ã€‚å°†å®ƒä»¬åˆ†ç»„å¯ä»¥ç¡®ä¿è¿™ä¸¤ä¸ªäº‹ä»¶åœ¨ç¡¬ä»¶ä¸Šæ˜¯åŒæ—¶å¼€å§‹ã€åŒæ—¶ç»“æŸçš„ï¼Œä»è€Œä¿è¯æ¯”ä¾‹çš„å‡†ç¡®æ€§ã€‚ çŠ¶æ€æ§åˆ¶ï¼šioctl ä¸ prctl äº‹ä»¶åˆ›å»ºåï¼Œå¹¶ä¸ä¸€å®šç«‹å³å¼€å§‹å·¥ä½œï¼Œä½ å¯ä»¥åƒæ§åˆ¶å¼€å…³ä¸€æ ·æ§åˆ¶å®ƒã€‚\nioctl (Input/Output Control)ï¼šè¿™æ˜¯æœ€å¸¸ç”¨çš„æ–¹å¼ï¼Œç›´æ¥é’ˆå¯¹æŸä¸ª fd è¿›è¡Œæ“ä½œã€‚\nioctl(fd, PERF_EVENT_IOC_ENABLE)ï¼šæ‰“å¼€å¼€å…³ã€‚ ioctl(fd, PERF_EVENT_IOC_DISABLE)ï¼šå…³é—­å¼€å…³ã€‚ prctl (Process Control)ï¼šè¿™æ˜¯é’ˆå¯¹å½“å‰è¿›ç¨‹åŠå…¶æ‰€æœ‰äº‹ä»¶çš„æ“ä½œã€‚\nå¦‚æœä½ æœ‰ 10 ä¸ªæµ‹é‡äº‹ä»¶ï¼Œä¸éœ€è¦ä¸€ä¸ªä¸ª ioctlï¼Œå¯ä»¥ç”¨ prctl ä¸€æ¬¡æ€§å…¨éƒ¨å¯ç”¨æˆ–ç¦ç”¨ã€‚ â€œä¿æŒå­˜åœ¨â€çš„æ„ä¹‰ï¼šç¦ç”¨äº‹ä»¶åªæ˜¯è®©è®¡æ•°å™¨åœæ­¢ï¼Œå®ƒä¸ä¼šé”€æ¯æ•°æ®ã€‚è¿™å…è®¸ä½ åœ¨ç¨‹åºè¿è¡Œçš„ç‰¹å®šç‰‡æ®µï¼ˆæ¯”å¦‚åªåœ¨æŸä¸ªæ ¸å¿ƒç®—æ³•æ‰§è¡ŒæœŸé—´ï¼‰å¼€å¯ç›‘æ§ã€‚\nä¸¤å¤§å·¥ä½œæ¨¡å¼ äº‹ä»¶åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼šè®¡æ•°å’Œé‡‡æ ·ã€‚è®¡æ•°äº‹ä»¶æ˜¯æŒ‡ç”¨äºç»Ÿè®¡å‘ç”Ÿçš„äº‹ä»¶æ€»æ•°çš„äº‹ä»¶ï¼ˆçœ‹æ€»é‡ï¼‰ï¼›é‡‡æ ·äº‹ä»¶å®šæœŸå°†æµ‹é‡æ•°æ®å†™å…¥ç¼“å†²åŒºï¼ˆçœ‹åˆ†å¸ƒï¼‰ã€‚\nè®¡æ•°æ¨¡å¼ å†…æ ¸ç»´æŠ¤ä¸€ä¸ªç®€å•çš„è®¡æ•°å™¨ï¼ˆå¦‚ u64 æ•´æ•°ï¼‰ã€‚è®¡æ•°äº‹ä»¶çš„ç»“æœé€šå¸¸é€šè¿‡ read è°ƒç”¨æ”¶é›†ã€‚\nåº”ç”¨åœºæ™¯ï¼šåŸºå‡†æµ‹è¯•ã€‚æ¯”å¦‚â€œè¿™æ®µä»£ç è·‘å®Œä¸€å…±æ¶ˆè€—äº†å¤šå°‘ä¸ª CPU å‘¨æœŸâ€ã€‚ é‡‡æ ·æ¨¡å¼ è®¾ç½®ä¸€ä¸ªé˜ˆå€¼ï¼ˆæ¯”å¦‚æ¯ 1000 æ¬¡ç¼“å­˜æœªå‘½ä¸­é‡‡æ ·ä¸€æ¬¡ï¼‰ã€‚å½“äº‹ä»¶æº¢å‡ºæ—¶ï¼Œå†…æ ¸ä¼šæŠ“å–å½“å‰çš„ä¸Šä¸‹æ–‡ï¼ˆå¦‚ IP å¯„å­˜å™¨ã€PIDã€è°ƒç”¨æ ˆç­‰ï¼‰ã€‚\nå†…æ ¸ä¼šå¼€è¾Ÿä¸€æ®µå†…å­˜ç©ºé—´ï¼Œå°†é‡‡æ ·æ•°æ®åƒæµæ°´çº¿ä¸€æ ·å†™è¿›å»ï¼Œç”¨æˆ·æ€ç¨‹åºé€šè¿‡ mmap ç³»ç»Ÿè°ƒç”¨å»è¿™å—å†…å­˜é‡Œâ€œæâ€æ•°æ®ã€‚\nåº”ç”¨åœºæ™¯ï¼šçƒ­ç‚¹åˆ†æã€ç”Ÿæˆç«ç„°å›¾ã€‚ åˆ©ç”¨ eBPF è¿›è¡Œ profiling é€šè¿‡ Linux çš„ perf_event æœºåˆ¶è§¦å‘ï¼Œå®šæœŸæˆ–åœ¨ç‰¹å®šç¡¬ä»¶äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œè®°å½•å½“å‰ç³»ç»Ÿçš„è°ƒç”¨æ ˆä¿¡æ¯ï¼Œä»è€Œæ‰¾å‡º CPU æ¶ˆè€—çš„çƒ­ç‚¹ã€‚\n#include \"vmlinux.h\" #include char LICENSE[] SEC(\"license\") = \"Dual BSD/GPL\"; #ifndef TASK_COMM_LEN #define TASK_COMM_LEN 16 #endif #ifndef MAX_STACK_DEPTH #define MAX_STACK_DEPTH 128 #endif typedef __u64 stack_trace_t[MAX_STACK_DEPTH]; struct stack_trace_event { __u32 pid; __u32 cpu_id; __u64 timestamp; char comm[TASK_COMM_LEN]; __s32 kstack_sz; __s32 ustack_sz; stack_trace_t kstack; stack_trace_t ustack; }; struct { __uint(type, BPF_MAP_TYPE_RINGBUF); __uint(max_entries, 256 * 1024); } events SEC(\".maps\"); SEC(\"perf_event\") int profile(void* ctx) { struct stack_trace_event* event = bpf_ringbuf_reserve(\u0026events, sizeof(struct stack_trace_event), 0); if (!event) { return 1; } int pid = bpf_get_current_pid_tgid() \u003e\u003e 32; int cpu_id = bpf_get_smp_processor_id(); event-\u003epid = pid; event-\u003ecpu_id = cpu_id; event-\u003etimestamp = bpf_ktime_get_ns(); // è·å–å½“å‰è¿›ç¨‹å if (bpf_get_current_comm(event-\u003ecomm, sizeof(event-\u003ecomm))) { event-\u003ecomm[0] = 0; } // è·å–å†…æ ¸æ ˆã€ç”¨æˆ·æ ˆä¿¡æ¯ event-\u003ekstack_sz = bpf_get_stack(ctx, event-\u003ekstack, sizeof(event-\u003ekstack), 0); event-\u003eustack_sz = bpf_get_stack( ctx, event-\u003eustack, sizeof(event-\u003eustack), BPF_F_USER_STACK); bpf_ringbuf_submit(event, 0); return 0; } ç¨‹åºè¢«æŒ‚è½½åˆ° perf_event ä¸Šï¼Œå®ƒä¼šéšç€æ€§èƒ½è®¡æ•°å™¨ï¼ˆå¦‚ CPU å‘¨æœŸã€æŒ‡ä»¤æ•°ï¼‰æˆ–é‡‡æ ·å®šæ—¶å™¨è§¦å‘ã€‚æ¯å½“è§¦å‘æ—¶ï¼Œè¿™æ®µä»£ç å°±ä¼šåœ¨å†…æ ¸ä¸­è¿è¡Œä¸€æ¬¡ã€‚\nè¯¥ eBPF ç¨‹åºé€šè¿‡è°ƒç”¨ bpf è¾…åŠ©å‡½æ•°æ¥è·å–ï¼š\nå½“å‰è¿è¡Œè¿›ç¨‹çš„ ID æ­£åœ¨æ‰§è¡Œè¯¥ä»»åŠ¡çš„ CPU æ ¸å¿ƒç¼–å· äº‹ä»¶å‘ç”Ÿçš„æ—¶é—´æˆ³ å½“å‰è¿›ç¨‹å å†…æ ¸ã€ç”¨æˆ·çš„æ ˆå›æº¯ æ¥ç€å°†é‡‡é›†åˆ°çš„ä¿¡æ¯éƒ½æ”¾å…¥ struct stack_trace_event ç±»å‹çš„ç»“æ„ä½“ä¸­ï¼Œç„¶åé€šè¿‡ Ring Buffer æäº¤ç»™ç”¨æˆ·æ€ç¨‹åºã€‚\nå°†è¿™ä¸ª eBPF ç¨‹åºæ”¶é›†åˆ°çš„æ•°æ®æ±‡æ€»åï¼Œé€šå¸¸ä¼šç”¨äºç”Ÿæˆ ç«ç„°å›¾ (Flame Graphs)ã€‚é€šè¿‡åˆ†æè¿™äº›æ•°æ®å¯ä»¥æ¸…æ™°åœ°çœ‹åˆ°ï¼š\nå“ªä¸ªè¿›ç¨‹å ç”¨äº†æœ€å¤šçš„ CPUã€‚ è¯¥è¿›ç¨‹åœ¨æ‰§è¡Œæ—¶ï¼Œå¤§éƒ¨åˆ†æ—¶é—´èŠ±åœ¨äº†å“ªäº›å‡½æ•°è°ƒç”¨ä¸Šã€‚ ç³»ç»Ÿè°ƒç”¨ï¼ˆå†…æ ¸ç©ºé—´ï¼‰å’Œä¸šåŠ¡é€»è¾‘ï¼ˆç”¨æˆ·ç©ºé—´ï¼‰çš„æ¯”ä¾‹ã€‚ è§£æé‡‡é›†çš„æ ˆå›æº¯ä¿¡æ¯ å‚è€ƒå­¦ä¹  https://zhuanlan.zhihu.com/p/623578927 https://plantegg.github.io/2021/05/16/Perf_IPC%E4%BB%A5%E5%8F%8ACPU%E5%88%A9%E7%94%A8%E7%8E%87 https://man7.org/linux/man-pages/man2/perf_event_open.2.html ","wordCount":"275","inLanguage":"en","image":"https://kerolt.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2026-01-23T00:00:00Z","dateModified":"2026-01-24T00:00:00Z","author":{"@type":"Person","name":"Kerolt"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://kerolt.github.io/posts/ebpf/%E5%88%A9%E7%94%A8ebpf%E4%B8%8Eperf_event%E8%AE%B0%E5%BD%95%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E6%A0%88/"},"publisher":{"@type":"Organization","name":"Kerolt's Blog","logo":{"@type":"ImageObject","url":"https://kerolt.github.io/images/avatar/favicon.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://kerolt.github.io/ accesskey=h title="Kerolt's Blog (Alt + H)">Kerolt's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://kerolt.github.io/posts/ title=æ–‡ç« ><span>æ–‡ç« </span></a></li><li><a href=https://kerolt.github.io/categories/ title=åˆ†ç±»><span>åˆ†ç±»</span></a></li><li><a href=https://kerolt.github.io/tags/ title=æ ‡ç­¾><span>æ ‡ç­¾</span></a></li><li><a href=https://kerolt.github.io/archives/ title=å½’æ¡£><span>å½’æ¡£</span></a></li><li><a href=https://kerolt.github.io/about/ title=å…³äºæˆ‘><span>å…³äºæˆ‘</span></a></li><li><a href=https://kerolt.github.io/search/ title="ğŸ” (Alt + /)" accesskey=/><span>ğŸ”</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://kerolt.github.io/>Home</a>&nbsp;Â»&nbsp;<a href=https://kerolt.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">åˆ©ç”¨eBPFä¸perf_eventè®°å½•ç³»ç»Ÿè°ƒç”¨æ ˆ</h1><div class=post-meta><span title='2026-01-23 00:00:00 +0000 UTC'>å‘å¸ƒäº2026-01-23</span>&nbsp;&nbsp;Â·&nbsp;&nbsp;Kerolt</div><ul class=post-tags><li><a href=https://kerolt.github.io/tags/ebpf/>EBPF</a></li><li><a href=https://kerolt.github.io/tags/perf/>Perf</a></li><li><a href=https://kerolt.github.io/tags/cpp/>Cpp</a></li></ul></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#perf_event_open aria-label=perf_event_open>perf_event_open</a><ul><li><a href=#%e4%bb%a5%e6%96%87%e4%bb%b6%e6%8f%8f%e8%bf%b0%e7%ac%a6%e4%b8%ba%e4%b8%ad%e5%bf%83%e7%9a%84%e6%b5%8b%e9%87%8f%e5%8d%95%e5%85%83 aria-label=ä»¥æ–‡ä»¶æè¿°ç¬¦ä¸ºä¸­å¿ƒçš„â€œæµ‹é‡å•å…ƒâ€>ä»¥æ–‡ä»¶æè¿°ç¬¦ä¸ºä¸­å¿ƒçš„â€œæµ‹é‡å•å…ƒâ€</a></li><li><a href=#%e7%8a%b6%e6%80%81%e6%8e%a7%e5%88%b6ioctl-%e4%b8%8e-prctl aria-label="çŠ¶æ€æ§åˆ¶ï¼šioctl ä¸ prctl">çŠ¶æ€æ§åˆ¶ï¼šioctl ä¸ prctl</a></li></ul></li><li><a href=#%e4%b8%a4%e5%a4%a7%e5%b7%a5%e4%bd%9c%e6%a8%a1%e5%bc%8f aria-label=ä¸¤å¤§å·¥ä½œæ¨¡å¼>ä¸¤å¤§å·¥ä½œæ¨¡å¼</a><ul><li><a href=#%e8%ae%a1%e6%95%b0%e6%a8%a1%e5%bc%8f aria-label=è®¡æ•°æ¨¡å¼>è®¡æ•°æ¨¡å¼</a></li><li><a href=#%e9%87%87%e6%a0%b7%e6%a8%a1%e5%bc%8f aria-label=é‡‡æ ·æ¨¡å¼>é‡‡æ ·æ¨¡å¼</a></li></ul></li><li><a href=#%e5%88%a9%e7%94%a8-ebpf-%e8%bf%9b%e8%a1%8c-profiling aria-label="åˆ©ç”¨ eBPF è¿›è¡Œ profiling">åˆ©ç”¨ eBPF è¿›è¡Œ profiling</a></li><li><a href=#%e8%a7%a3%e6%9e%90%e9%87%87%e9%9b%86%e7%9a%84%e6%a0%88%e5%9b%9e%e6%ba%af%e4%bf%a1%e6%81%af aria-label=è§£æé‡‡é›†çš„æ ˆå›æº¯ä¿¡æ¯>è§£æé‡‡é›†çš„æ ˆå›æº¯ä¿¡æ¯</a></li><li><a href=#%e5%8f%82%e8%80%83%e5%ad%a6%e4%b9%a0 aria-label=å‚è€ƒå­¦ä¹ >å‚è€ƒå­¦ä¹ </a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h2 id=perf_event_open>perf_event_open<a hidden class=anchor aria-hidden=true href=#perf_event_open>#</a></h2><p><div class=post-img-view><a data-fancybox=gallery href=https://plantegg.github.io/images/951413iMgBlog/5edebc74-f8ac-483c-8bcd-24e09abfd06b.png><img src=https://plantegg.github.io/images/951413iMgBlog/5edebc74-f8ac-483c-8bcd-24e09abfd06b.png alt></a></div></p><blockquote><p>perf åŸç†å›¾ï¼šhttps://plantegg.github.io/2021/05/16/Perf_IPC%E4%BB%A5%E5%8F%8ACPU%E5%88%A9%E7%94%A8%E7%8E%87/</p></blockquote><p>åœ¨ç”¨æˆ·æ€ä¸­è§¦å‘ <code>sys_perf_event_open</code> ç³»ç»Ÿè°ƒç”¨ï¼Œå†…æ ¸é™·å…¥ä¸­æ–­ä»¥åä¼šè°ƒç”¨ <code>perf_event_open</code> æ¥å¤„ç†ã€‚åœ¨ç”¨æˆ·æ€ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å¦‚ä¸‹çš„ä»£ç æ¥ä½¿ç”¨ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#099>#include</span> <span style=color:#099>&lt;linux/perf_event.h&gt;</span><span style=color:#099>
</span></span></span><span style=display:flex><span><span style=color:#099>#include</span> <span style=color:#099>&lt;sys/syscall.h&gt;</span><span style=color:#099>
</span></span></span><span style=display:flex><span><span style=color:#099>#include</span> <span style=color:#099>&lt;unistd.h&gt;</span><span style=color:#099>
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#078;font-weight:700>int64_t</span> <span style=color:#c0f>perf_event_open</span>(<span style=color:#069;font-weight:700>struct</span> perf_event_attr<span style=color:#555>*</span> hw_event, <span style=color:#078;font-weight:700>pid_t</span> pid, <span style=color:#078;font-weight:700>int</span> cpu,
</span></span><span style=display:flex><span>                     <span style=color:#078;font-weight:700>int</span> group_fd, <span style=color:#078;font-weight:700>unsigned</span> <span style=color:#078;font-weight:700>long</span> flags) <span style=color:#555>-&gt;</span>  {
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>return</span> <span style=color:#c0f>syscall</span>(SYS_perf_event_open, hw_event, pid, cpu, group_fd, flags);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=ä»¥æ–‡ä»¶æè¿°ç¬¦ä¸ºä¸­å¿ƒçš„æµ‹é‡å•å…ƒ>ä»¥æ–‡ä»¶æè¿°ç¬¦ä¸ºä¸­å¿ƒçš„â€œæµ‹é‡å•å…ƒâ€<a hidden class=anchor aria-hidden=true href=#ä»¥æ–‡ä»¶æè¿°ç¬¦ä¸ºä¸­å¿ƒçš„æµ‹é‡å•å…ƒ>#</a></h3><p>åœ¨ Linux ä¸­ï¼Œâ€œä¸€åˆ‡çš†æ–‡ä»¶â€ã€‚å½“è°ƒç”¨ <code>perf_event_open</code> æ—¶ï¼Œå†…æ ¸åˆ›å»ºäº†ä¸€ä¸ª<strong>ç‹¬ç«‹çš„æµ‹é‡å®ä¾‹</strong>ã€‚</p><p>æ¯ä¸ªæ–‡ä»¶æè¿°ç¬¦ä»£è¡¨ä¸€ä¸ªç›‘æ§ä»»åŠ¡ï¼ˆ<strong>1 fd == 1 Event</strong>ï¼Œæ¯”å¦‚â€œç›‘æ§ CPU 0 çš„æŒ‡ä»¤æ‰§è¡Œæ•°â€ï¼‰ã€‚</p><p>åŒæ—¶ï¼Œå¯ä»¥æŠŠå¤šä¸ª fd ç»‘åœ¨ä¸€èµ·ï¼Œå³ä¸º<strong>äº‹ä»¶åˆ†ç»„ (Group)</strong>ï¼š</p><ul><li>ä¾‹å¦‚ä½ æƒ³è®¡ç®—â€œæ¯æ¡æŒ‡ä»¤çš„ç¼“å­˜æœªå‘½ä¸­ç‡â€ï¼Œä½ éœ€è¦åŒæ—¶æµ‹é‡â€œæŒ‡ä»¤æ•°â€å’Œâ€œç¼“å­˜æœªå‘½ä¸­æ•°â€ã€‚å°†å®ƒä»¬åˆ†ç»„å¯ä»¥ç¡®ä¿è¿™ä¸¤ä¸ªäº‹ä»¶åœ¨ç¡¬ä»¶ä¸Šæ˜¯<strong>åŒæ—¶å¼€å§‹ã€åŒæ—¶ç»“æŸ</strong>çš„ï¼Œä»è€Œä¿è¯æ¯”ä¾‹çš„å‡†ç¡®æ€§ã€‚</li></ul><h3 id=çŠ¶æ€æ§åˆ¶ioctl-ä¸-prctl>çŠ¶æ€æ§åˆ¶ï¼šioctl ä¸ prctl<a hidden class=anchor aria-hidden=true href=#çŠ¶æ€æ§åˆ¶ioctl-ä¸-prctl>#</a></h3><p>äº‹ä»¶åˆ›å»ºåï¼Œå¹¶ä¸ä¸€å®šç«‹å³å¼€å§‹å·¥ä½œï¼Œä½ å¯ä»¥åƒæ§åˆ¶å¼€å…³ä¸€æ ·æ§åˆ¶å®ƒã€‚</p><ul><li><p><strong>ioctl (Input/Output Control)</strong>ï¼šè¿™æ˜¯æœ€å¸¸ç”¨çš„æ–¹å¼ï¼Œç›´æ¥é’ˆå¯¹æŸä¸ª <strong>fd</strong> è¿›è¡Œæ“ä½œã€‚</p><ul><li><code>ioctl(fd, PERF_EVENT_IOC_ENABLE)</code>ï¼šæ‰“å¼€å¼€å…³ã€‚</li><li><code>ioctl(fd, PERF_EVENT_IOC_DISABLE)</code>ï¼šå…³é—­å¼€å…³ã€‚</li></ul></li><li><p><strong>prctl (Process Control)</strong>ï¼šè¿™æ˜¯é’ˆå¯¹<strong>å½“å‰è¿›ç¨‹åŠå…¶æ‰€æœ‰äº‹ä»¶</strong>çš„æ“ä½œã€‚</p><ul><li>å¦‚æœä½ æœ‰ 10 ä¸ªæµ‹é‡äº‹ä»¶ï¼Œä¸éœ€è¦ä¸€ä¸ªä¸ª ioctlï¼Œå¯ä»¥ç”¨ <code>prctl</code> ä¸€æ¬¡æ€§å…¨éƒ¨å¯ç”¨æˆ–ç¦ç”¨ã€‚</li></ul></li></ul><p><strong>â€œä¿æŒå­˜åœ¨â€çš„æ„ä¹‰</strong>ï¼šç¦ç”¨äº‹ä»¶åªæ˜¯è®©è®¡æ•°å™¨åœæ­¢ï¼Œå®ƒä¸ä¼šé”€æ¯æ•°æ®ã€‚è¿™å…è®¸ä½ åœ¨ç¨‹åºè¿è¡Œçš„ç‰¹å®šç‰‡æ®µï¼ˆæ¯”å¦‚åªåœ¨æŸä¸ªæ ¸å¿ƒç®—æ³•æ‰§è¡ŒæœŸé—´ï¼‰å¼€å¯ç›‘æ§ã€‚</p><h2 id=ä¸¤å¤§å·¥ä½œæ¨¡å¼>ä¸¤å¤§å·¥ä½œæ¨¡å¼<a hidden class=anchor aria-hidden=true href=#ä¸¤å¤§å·¥ä½œæ¨¡å¼>#</a></h2><p>äº‹ä»¶åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼š<strong>è®¡æ•°</strong>å’Œ<strong>é‡‡æ ·</strong>ã€‚è®¡æ•°äº‹ä»¶æ˜¯æŒ‡ç”¨äºç»Ÿè®¡å‘ç”Ÿçš„äº‹ä»¶æ€»æ•°çš„äº‹ä»¶ï¼ˆçœ‹æ€»é‡ï¼‰ï¼›é‡‡æ ·äº‹ä»¶å®šæœŸå°†æµ‹é‡æ•°æ®å†™å…¥ç¼“å†²åŒºï¼ˆçœ‹åˆ†å¸ƒï¼‰ã€‚</p><h3 id=è®¡æ•°æ¨¡å¼>è®¡æ•°æ¨¡å¼<a hidden class=anchor aria-hidden=true href=#è®¡æ•°æ¨¡å¼>#</a></h3><p>å†…æ ¸ç»´æŠ¤ä¸€ä¸ªç®€å•çš„è®¡æ•°å™¨ï¼ˆå¦‚ <code>u64</code> æ•´æ•°ï¼‰ã€‚è®¡æ•°äº‹ä»¶çš„ç»“æœé€šå¸¸é€šè¿‡ <code>read</code> è°ƒç”¨æ”¶é›†ã€‚</p><ul><li><strong>åº”ç”¨åœºæ™¯</strong>ï¼šåŸºå‡†æµ‹è¯•ã€‚æ¯”å¦‚â€œè¿™æ®µä»£ç è·‘å®Œä¸€å…±æ¶ˆè€—äº†å¤šå°‘ä¸ª CPU å‘¨æœŸâ€ã€‚</li></ul><h3 id=é‡‡æ ·æ¨¡å¼>é‡‡æ ·æ¨¡å¼<a hidden class=anchor aria-hidden=true href=#é‡‡æ ·æ¨¡å¼>#</a></h3><p>è®¾ç½®ä¸€ä¸ªé˜ˆå€¼ï¼ˆæ¯”å¦‚æ¯ 1000 æ¬¡ç¼“å­˜æœªå‘½ä¸­é‡‡æ ·ä¸€æ¬¡ï¼‰ã€‚å½“äº‹ä»¶æº¢å‡ºæ—¶ï¼Œå†…æ ¸ä¼šæŠ“å–å½“å‰çš„ä¸Šä¸‹æ–‡ï¼ˆå¦‚ IP å¯„å­˜å™¨ã€PIDã€è°ƒç”¨æ ˆç­‰ï¼‰ã€‚</p><p>å†…æ ¸ä¼šå¼€è¾Ÿä¸€æ®µå†…å­˜ç©ºé—´ï¼Œå°†é‡‡æ ·æ•°æ®åƒæµæ°´çº¿ä¸€æ ·å†™è¿›å»ï¼Œç”¨æˆ·æ€ç¨‹åºé€šè¿‡ <code>mmap</code> ç³»ç»Ÿè°ƒç”¨å»è¿™å—å†…å­˜é‡Œâ€œæâ€æ•°æ®ã€‚</p><ul><li><strong>åº”ç”¨åœºæ™¯</strong>ï¼šçƒ­ç‚¹åˆ†æã€ç”Ÿæˆç«ç„°å›¾ã€‚</li></ul><h2 id=åˆ©ç”¨-ebpf-è¿›è¡Œ-profiling>åˆ©ç”¨ eBPF è¿›è¡Œ profiling<a hidden class=anchor aria-hidden=true href=#åˆ©ç”¨-ebpf-è¿›è¡Œ-profiling>#</a></h2><p>é€šè¿‡ Linux çš„ <code>perf_event</code> æœºåˆ¶è§¦å‘ï¼Œå®šæœŸæˆ–åœ¨ç‰¹å®šç¡¬ä»¶äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œè®°å½•å½“å‰ç³»ç»Ÿçš„è°ƒç”¨æ ˆä¿¡æ¯ï¼Œä»è€Œæ‰¾å‡º CPU æ¶ˆè€—çš„çƒ­ç‚¹ã€‚</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#099>#include</span> <span style=color:#099>&#34;vmlinux.h&#34;</span><span style=color:#099>
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#099>#include</span> <span style=color:#099>&lt;bpf/bpf_helpers.h&gt;</span><span style=color:#099>
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#078;font-weight:700>char</span> LICENSE[] <span style=color:#c0f>SEC</span>(<span style=color:#c30>&#34;license&#34;</span>) <span style=color:#555>=</span> <span style=color:#c30>&#34;Dual BSD/GPL&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#099>#ifndef TASK_COMM_LEN
</span></span></span><span style=display:flex><span><span style=color:#099>#define TASK_COMM_LEN 16
</span></span></span><span style=display:flex><span><span style=color:#099>#endif
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#099>#ifndef MAX_STACK_DEPTH
</span></span></span><span style=display:flex><span><span style=color:#099>#define MAX_STACK_DEPTH 128
</span></span></span><span style=display:flex><span><span style=color:#099>#endif
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>typedef</span> __u64 <span style=color:#078;font-weight:700>stack_trace_t</span>[MAX_STACK_DEPTH];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>struct</span> stack_trace_event {
</span></span><span style=display:flex><span>    __u32 pid;
</span></span><span style=display:flex><span>    __u32 cpu_id;
</span></span><span style=display:flex><span>    __u64 timestamp;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>char</span> comm[TASK_COMM_LEN];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    __s32 kstack_sz;
</span></span><span style=display:flex><span>    __s32 ustack_sz;
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>stack_trace_t</span> kstack;
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>stack_trace_t</span> ustack;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#c0f>__uint</span>(type, BPF_MAP_TYPE_RINGBUF);
</span></span><span style=display:flex><span>    <span style=color:#c0f>__uint</span>(max_entries, <span style=color:#f60>256</span> <span style=color:#555>*</span> <span style=color:#f60>1024</span>);
</span></span><span style=display:flex><span>} events <span style=color:#c0f>SEC</span>(<span style=color:#c30>&#34;.maps&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c0f>SEC</span>(<span style=color:#c30>&#34;perf_event&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#078;font-weight:700>int</span> <span style=color:#c0f>profile</span>(<span style=color:#078;font-weight:700>void</span><span style=color:#555>*</span> ctx) {
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>struct</span> stack_trace_event<span style=color:#555>*</span> event <span style=color:#555>=</span>
</span></span><span style=display:flex><span>        <span style=color:#c0f>bpf_ringbuf_reserve</span>(<span style=color:#555>&amp;</span>events, <span style=color:#069;font-weight:700>sizeof</span>(<span style=color:#069;font-weight:700>struct</span> stack_trace_event), <span style=color:#f60>0</span>);
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>if</span> (<span style=color:#555>!</span>event) {
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>return</span> <span style=color:#f60>1</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>int</span> pid <span style=color:#555>=</span> <span style=color:#c0f>bpf_get_current_pid_tgid</span>() <span style=color:#555>&gt;&gt;</span> <span style=color:#f60>32</span>;
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>int</span> cpu_id <span style=color:#555>=</span> <span style=color:#c0f>bpf_get_smp_processor_id</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    event<span style=color:#555>-&gt;</span>pid <span style=color:#555>=</span> pid;
</span></span><span style=display:flex><span>    event<span style=color:#555>-&gt;</span>cpu_id <span style=color:#555>=</span> cpu_id;
</span></span><span style=display:flex><span>    event<span style=color:#555>-&gt;</span>timestamp <span style=color:#555>=</span> <span style=color:#c0f>bpf_ktime_get_ns</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#09f;font-style:italic>// è·å–å½“å‰è¿›ç¨‹å
</span></span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>if</span> (<span style=color:#c0f>bpf_get_current_comm</span>(event<span style=color:#555>-&gt;</span>comm, <span style=color:#069;font-weight:700>sizeof</span>(event<span style=color:#555>-&gt;</span>comm))) {
</span></span><span style=display:flex><span>        event<span style=color:#555>-&gt;</span>comm[<span style=color:#f60>0</span>] <span style=color:#555>=</span> <span style=color:#f60>0</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#09f;font-style:italic>// è·å–å†…æ ¸æ ˆã€ç”¨æˆ·æ ˆä¿¡æ¯
</span></span></span><span style=display:flex><span>    event<span style=color:#555>-&gt;</span>kstack_sz <span style=color:#555>=</span>
</span></span><span style=display:flex><span>        <span style=color:#c0f>bpf_get_stack</span>(ctx, event<span style=color:#555>-&gt;</span>kstack, <span style=color:#069;font-weight:700>sizeof</span>(event<span style=color:#555>-&gt;</span>kstack), <span style=color:#f60>0</span>);
</span></span><span style=display:flex><span>    event<span style=color:#555>-&gt;</span>ustack_sz <span style=color:#555>=</span> <span style=color:#c0f>bpf_get_stack</span>(
</span></span><span style=display:flex><span>        ctx, event<span style=color:#555>-&gt;</span>ustack, <span style=color:#069;font-weight:700>sizeof</span>(event<span style=color:#555>-&gt;</span>ustack), BPF_F_USER_STACK);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c0f>bpf_ringbuf_submit</span>(event, <span style=color:#f60>0</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>return</span> <span style=color:#f60>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ç¨‹åºè¢«æŒ‚è½½åˆ° <code>perf_event</code> ä¸Šï¼Œå®ƒä¼šéšç€æ€§èƒ½è®¡æ•°å™¨ï¼ˆå¦‚ CPU å‘¨æœŸã€æŒ‡ä»¤æ•°ï¼‰æˆ–é‡‡æ ·å®šæ—¶å™¨è§¦å‘ã€‚æ¯å½“è§¦å‘æ—¶ï¼Œè¿™æ®µä»£ç å°±ä¼šåœ¨å†…æ ¸ä¸­è¿è¡Œä¸€æ¬¡ã€‚</p><p>è¯¥ eBPF ç¨‹åºé€šè¿‡è°ƒç”¨ bpf è¾…åŠ©å‡½æ•°æ¥è·å–ï¼š</p><ol><li>å½“å‰è¿è¡Œè¿›ç¨‹çš„ ID</li><li>æ­£åœ¨æ‰§è¡Œè¯¥ä»»åŠ¡çš„ CPU æ ¸å¿ƒç¼–å·</li><li>äº‹ä»¶å‘ç”Ÿçš„æ—¶é—´æˆ³</li><li>å½“å‰è¿›ç¨‹å</li><li><mark><strong>å†…æ ¸ã€ç”¨æˆ·çš„æ ˆå›æº¯</strong></mark></li></ol><p>æ¥ç€å°†é‡‡é›†åˆ°çš„ä¿¡æ¯éƒ½æ”¾å…¥ <code>struct stack_trace_event</code> ç±»å‹çš„ç»“æ„ä½“ä¸­ï¼Œç„¶åé€šè¿‡ <strong>Ring Buffer</strong> æäº¤ç»™ç”¨æˆ·æ€ç¨‹åºã€‚</p><p>å°†è¿™ä¸ª eBPF ç¨‹åºæ”¶é›†åˆ°çš„æ•°æ®æ±‡æ€»åï¼Œé€šå¸¸ä¼šç”¨äºç”Ÿæˆ <strong>ç«ç„°å›¾ (Flame Graphs)</strong>ã€‚é€šè¿‡åˆ†æè¿™äº›æ•°æ®å¯ä»¥æ¸…æ™°åœ°çœ‹åˆ°ï¼š</p><ol><li><strong>å“ªä¸ªè¿›ç¨‹</strong>å ç”¨äº†æœ€å¤šçš„ CPUã€‚</li><li>è¯¥è¿›ç¨‹åœ¨æ‰§è¡Œæ—¶ï¼Œå¤§éƒ¨åˆ†æ—¶é—´èŠ±åœ¨äº†<strong>å“ªäº›å‡½æ•°è°ƒç”¨</strong>ä¸Šã€‚</li><li>ç³»ç»Ÿè°ƒç”¨ï¼ˆå†…æ ¸ç©ºé—´ï¼‰å’Œä¸šåŠ¡é€»è¾‘ï¼ˆç”¨æˆ·ç©ºé—´ï¼‰çš„æ¯”ä¾‹ã€‚</li></ol><h2 id=è§£æé‡‡é›†çš„æ ˆå›æº¯ä¿¡æ¯>è§£æé‡‡é›†çš„æ ˆå›æº¯ä¿¡æ¯<a hidden class=anchor aria-hidden=true href=#è§£æé‡‡é›†çš„æ ˆå›æº¯ä¿¡æ¯>#</a></h2><h2 id=å‚è€ƒå­¦ä¹ >å‚è€ƒå­¦ä¹ <a hidden class=anchor aria-hidden=true href=#å‚è€ƒå­¦ä¹ >#</a></h2><ol><li><a href=https://zhuanlan.zhihu.com/p/623578927>https://zhuanlan.zhihu.com/p/623578927</a></li><li><a href=https://plantegg.github.io/2021/05/16/Perf_IPC%E4%BB%A5%E5%8F%8ACPU%E5%88%A9%E7%94%A8%E7%8E%87>https://plantegg.github.io/2021/05/16/Perf_IPC%E4%BB%A5%E5%8F%8ACPU%E5%88%A9%E7%94%A8%E7%8E%87</a></li><li><a href=https://man7.org/linux/man-pages/man2/perf_event_open.2.html>https://man7.org/linux/man-pages/man2/perf_event_open.2.html</a></li></ol></div><footer class=post-footer><nav class=paginav><a class=prev href=https://kerolt.github.io/posts/dev-null/rockylinux%E5%90%AF%E7%94%A8epel%E8%BD%AF%E4%BB%B6%E4%BB%93%E5%BA%93/><span class=title>Â« Prev</span><br><span>RockyLinuxå¯ç”¨EPELè½¯ä»¶ä»“åº“</span>
</a><a class=next href=https://kerolt.github.io/posts/cmake/cmake%E4%B8%8Econan%E5%8D%8F%E5%90%8C%E5%B7%A5%E4%BD%9C%E7%90%86%E8%A7%A3/><span class=title>Next Â»</span><br><span>CMakeä¸ConanååŒå·¥ä½œç†è§£</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2026 <a href=https://kerolt.github.io/>Kerolt's Blog</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>