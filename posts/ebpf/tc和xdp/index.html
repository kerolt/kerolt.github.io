<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>TCå’ŒXDP | Kerolt's Blog</title><meta name=keywords content="eBPF"><meta name=description content="tc å’Œ XDP éƒ½èƒ½å¯¹ç½‘ç»œæ•°æ®åŒ…è¿›è¡Œå¤„ç†ï¼Œä½†å®ƒä»¬ä½äº ä¸åŒçš„ç½‘ç»œåè®®æ ˆå±‚æ¬¡ï¼Œå› æ­¤æ€§èƒ½ã€èƒ½åŠ›å’Œé€‚ç”¨åœºæ™¯å·®åˆ«éƒ½å¾ˆå¤§ï¼š

  
      
          é¡¹ç›®
          ä½œç”¨å±‚çº§
          å¤„ç†æ–¹å‘
          ç‰¹ç‚¹
      
  
  
      
          XDP (eXpress Data Path)
          é©±åŠ¨å±‚ï¼ˆæœ€æ—©ï¼‰ï¼šç½‘ç»œè®¾å¤‡é©±åŠ¨å…¥å£å¤„ï¼ˆL2 ä¹‹å‰ï¼‰
          å…¥ç«™ï¼ˆIngressï¼‰
          æå¿«ï¼Œç»•è¿‡å†…æ ¸åè®®æ ˆï¼Œå¯ç›´æ¥ä¸¢åŒ…/è½¬å‘
      
      
          tc (Traffic Control)
          å†…æ ¸ç½‘ç»œæ ˆå±‚ï¼ˆL3/L4 ä¹‹åï¼‰
          å…¥ç«™ + å‡ºç«™
          é€šå¸¸ç”¨äºå¸¦å®½æ§åˆ¶ã€QoSã€æµé‡æ•´å½¢ç­‰
      
  

Linux ç½‘ç»œåŒ…å¤„ç†è·¯å¾„
ä¸‹é¢è¿™å¼ å›¾èƒ½æ¸…æ™°åœ°çœ‹åˆ° XDP å’Œ tc å„è‡ªå¤„åœ¨ä»€ä¹ˆä½ç½®ï¼š
                +----------------------------------------+
                |              ç”¨æˆ·ç©ºé—´                  |
                |  (åº”ç”¨å±‚: Nginx, curl, ping, etc.)     |
                +----------------------------------------+
                                â–²
                                â”‚ send()/recv()
                                â”‚
                +----------------------------------------+
                |            å†…æ ¸ç½‘ç»œåè®®æ ˆ               |
                |----------------------------------------|
                |   L4 (TCP/UDP)                         |
                |   L3 (IP è·¯ç”±è½¬å‘)                     |
                |   L2 (Ethernet frame å¤„ç†)             |
                +----------------------------------------+
                     â–²                     â–²
                     â”‚                     â”‚
        tc ingress/qdisc           tc egress/qdisc
             â”‚                           â”‚
             â”‚                           â–¼
        +----------------------------------------+
        |        XDP (eXpress Data Path)         |
        | (ä½äºç½‘å¡é©±åŠ¨ä¸­ï¼Œæœ€é è¿‘ç¡¬ä»¶çš„é’©å­ç‚¹)     |
        +----------------------------------------+
                     â–²
                     â”‚
              NIC é©±åŠ¨ / DMA æ”¶åŒ…

å¤„ç†è·¯å¾„ç»†èŠ‚å¯¹æ¯”

  
      
          å¯¹æ¯”é¡¹
          XDP
          tc (ingress/egress)
      
  
  
      
          æ‰€åœ¨å±‚çº§
          NIC é©±åŠ¨å±‚ï¼ˆæ¯”å†…æ ¸åè®®æ ˆè¿˜æ—©ï¼‰
          å†…æ ¸ç½‘ç»œæ ˆï¼ˆL3/L4 å±‚ä¹‹é—´ï¼‰
      
      
          é’©å­ä½ç½®
          é©±åŠ¨æ¥æ”¶åŒ… â†’ DMA â†’ XDP
          skbï¼ˆsocket bufferï¼‰è¿›å…¥æˆ–ç¦»å¼€åè®®æ ˆæ—¶
      
      
          ä½œç”¨æ–¹å‘
          ä»…æ”¯æŒ ingressï¼ˆå…¥ç«™ï¼‰
          æ”¯æŒ ingress + egress
      
      
          å¤„ç†å¯¹è±¡
          åŸå§‹æ•°æ®åŒ…ï¼ˆframeï¼‰
          å°è£…åçš„ skb
      
      
          æ€§èƒ½
          æé«˜ï¼ˆå¯åœ¨ç™¾ä¸‡ pps çº§åˆ«ï¼‰
          ä¸­ç­‰ï¼ˆå—å†…æ ¸è°ƒåº¦å’Œ qdisc å½±å“ï¼‰
      
      
          å…¸å‹ç”¨é€”
          DDoS é˜²æŠ¤ã€æ—©æœŸä¸¢åŒ…ã€å¿«é€Ÿè½¬å‘ã€å†…æ ¸æ—è·¯
          QoSã€æµé‡æ•´å½¢ã€é™é€Ÿã€åŒ…åˆ†ç±»
      
      
          å¯ç¼–ç¨‹æ€§
          eBPF ç¨‹åºï¼ˆxdp ç¨‹åºï¼‰
          eBPF ç¨‹åºï¼ˆcls_bpfï¼‰
      
      
          è¿”å›åŠ¨ä½œ
          XDP_PASSã€XDP_DROPã€XDP_TXã€XDP_REDIRECT
          TC_ACT_OKã€TC_ACT_SHOTã€TC_ACT_REDIRECT
      
      
          ä½¿ç”¨æ¥å£
          ip link set dev eth0 xdp obj prog.o
          tc filter add dev eth0 ... bpf obj prog.o
      
  

æ•°æ®å¤„ç†æµç¨‹ä¸¾ä¾‹
XDP æµç¨‹ï¼ˆæœ€æ—©é˜¶æ®µï¼‰
[ç½‘å¡æ¥æ”¶åŒ…]
   â†“
[XDP ç¨‹åºæ‰§è¡Œ]
   â”œâ”€â”€ XDP_DROPï¼šç›´æ¥ä¸¢åŒ…ï¼ˆä¸è¿›å…¥å†…æ ¸ï¼‰
   â”œâ”€â”€ XDP_PASSï¼šè®©åŒ…è¿›å…¥å†…æ ¸åè®®æ ˆ
   â”œâ”€â”€ XDP_TXï¼šç›´æ¥ä»é©±åŠ¨å›å‘
   â””â”€â”€ XDP_REDIRECTï¼šè½¬å‘åˆ°å…¶ä»–ç½‘å¡æˆ– AF_XDP socket
å…¸å‹ç”¨é€”ï¼š"><meta name=author content="Kerolt"><link rel=canonical href=https://kerolt.github.io/posts/ebpf/tc%E5%92%8Cxdp/><meta name=google-site-verification content="NpIO0KEIJS0CPRzTzQCbYQdSRIyb0Lspx"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="2300A23B82DB579A2DEA6261191AD771"><link crossorigin=anonymous href=/assets/css/stylesheet.ebfb3cf928fcf4c6d18dc4b21d00e826495f32909f1de857dd91302a15bf135f.css integrity="sha256-6/s8+Sj89MbRjcSyHQDoJklfMpCfHehX3ZEwKhW/E18=" rel="preload stylesheet" as=style><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-screen-web/style.css><link rel=icon href=https://kerolt.github.io/images/avatar/favicon.png><link rel=icon type=image/png sizes=16x16 href=https://kerolt.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://kerolt.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://kerolt.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://kerolt.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://kerolt.github.io/posts/ebpf/tc%E5%92%8Cxdp/><script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css><script src=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js></script><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://kerolt.github.io/posts/ebpf/tc%E5%92%8Cxdp/"><meta property="og:site_name" content="Kerolt's Blog"><meta property="og:title" content="TCå’ŒXDP"><meta property="og:description" content="tc å’Œ XDP éƒ½èƒ½å¯¹ç½‘ç»œæ•°æ®åŒ…è¿›è¡Œå¤„ç†ï¼Œä½†å®ƒä»¬ä½äº ä¸åŒçš„ç½‘ç»œåè®®æ ˆå±‚æ¬¡ï¼Œå› æ­¤æ€§èƒ½ã€èƒ½åŠ›å’Œé€‚ç”¨åœºæ™¯å·®åˆ«éƒ½å¾ˆå¤§ï¼š
é¡¹ç›® ä½œç”¨å±‚çº§ å¤„ç†æ–¹å‘ ç‰¹ç‚¹ XDP (eXpress Data Path) é©±åŠ¨å±‚ï¼ˆæœ€æ—©ï¼‰ï¼šç½‘ç»œè®¾å¤‡é©±åŠ¨å…¥å£å¤„ï¼ˆL2 ä¹‹å‰ï¼‰ å…¥ç«™ï¼ˆIngressï¼‰ æå¿«ï¼Œç»•è¿‡å†…æ ¸åè®®æ ˆï¼Œå¯ç›´æ¥ä¸¢åŒ…/è½¬å‘ tc (Traffic Control) å†…æ ¸ç½‘ç»œæ ˆå±‚ï¼ˆL3/L4 ä¹‹åï¼‰ å…¥ç«™ + å‡ºç«™ é€šå¸¸ç”¨äºå¸¦å®½æ§åˆ¶ã€QoSã€æµé‡æ•´å½¢ç­‰ Linux ç½‘ç»œåŒ…å¤„ç†è·¯å¾„ ä¸‹é¢è¿™å¼ å›¾èƒ½æ¸…æ™°åœ°çœ‹åˆ° XDP å’Œ tc å„è‡ªå¤„åœ¨ä»€ä¹ˆä½ç½®ï¼š
+----------------------------------------+ | ç”¨æˆ·ç©ºé—´ | | (åº”ç”¨å±‚: Nginx, curl, ping, etc.) | +----------------------------------------+ â–² â”‚ send()/recv() â”‚ +----------------------------------------+ | å†…æ ¸ç½‘ç»œåè®®æ ˆ | |----------------------------------------| | L4 (TCP/UDP) | | L3 (IP è·¯ç”±è½¬å‘) | | L2 (Ethernet frame å¤„ç†) | +----------------------------------------+ â–² â–² â”‚ â”‚ tc ingress/qdisc tc egress/qdisc â”‚ â”‚ â”‚ â–¼ +----------------------------------------+ | XDP (eXpress Data Path) | | (ä½äºç½‘å¡é©±åŠ¨ä¸­ï¼Œæœ€é è¿‘ç¡¬ä»¶çš„é’©å­ç‚¹) | +----------------------------------------+ â–² â”‚ NIC é©±åŠ¨ / DMA æ”¶åŒ… å¤„ç†è·¯å¾„ç»†èŠ‚å¯¹æ¯” å¯¹æ¯”é¡¹ XDP tc (ingress/egress) æ‰€åœ¨å±‚çº§ NIC é©±åŠ¨å±‚ï¼ˆæ¯”å†…æ ¸åè®®æ ˆè¿˜æ—©ï¼‰ å†…æ ¸ç½‘ç»œæ ˆï¼ˆL3/L4 å±‚ä¹‹é—´ï¼‰ é’©å­ä½ç½® é©±åŠ¨æ¥æ”¶åŒ… â†’ DMA â†’ XDP skbï¼ˆsocket bufferï¼‰è¿›å…¥æˆ–ç¦»å¼€åè®®æ ˆæ—¶ ä½œç”¨æ–¹å‘ ä»…æ”¯æŒ ingressï¼ˆå…¥ç«™ï¼‰ æ”¯æŒ ingress + egress å¤„ç†å¯¹è±¡ åŸå§‹æ•°æ®åŒ…ï¼ˆframeï¼‰ å°è£…åçš„ skb æ€§èƒ½ æé«˜ï¼ˆå¯åœ¨ç™¾ä¸‡ pps çº§åˆ«ï¼‰ ä¸­ç­‰ï¼ˆå—å†…æ ¸è°ƒåº¦å’Œ qdisc å½±å“ï¼‰ å…¸å‹ç”¨é€” DDoS é˜²æŠ¤ã€æ—©æœŸä¸¢åŒ…ã€å¿«é€Ÿè½¬å‘ã€å†…æ ¸æ—è·¯ QoSã€æµé‡æ•´å½¢ã€é™é€Ÿã€åŒ…åˆ†ç±» å¯ç¼–ç¨‹æ€§ eBPF ç¨‹åºï¼ˆxdp ç¨‹åºï¼‰ eBPF ç¨‹åºï¼ˆcls_bpfï¼‰ è¿”å›åŠ¨ä½œ XDP_PASSã€XDP_DROPã€XDP_TXã€XDP_REDIRECT TC_ACT_OKã€TC_ACT_SHOTã€TC_ACT_REDIRECT ä½¿ç”¨æ¥å£ ip link set dev eth0 xdp obj prog.o tc filter add dev eth0 ... bpf obj prog.o æ•°æ®å¤„ç†æµç¨‹ä¸¾ä¾‹ XDP æµç¨‹ï¼ˆæœ€æ—©é˜¶æ®µï¼‰ [ç½‘å¡æ¥æ”¶åŒ…] â†“ [XDP ç¨‹åºæ‰§è¡Œ] â”œâ”€â”€ XDP_DROPï¼šç›´æ¥ä¸¢åŒ…ï¼ˆä¸è¿›å…¥å†…æ ¸ï¼‰ â”œâ”€â”€ XDP_PASSï¼šè®©åŒ…è¿›å…¥å†…æ ¸åè®®æ ˆ â”œâ”€â”€ XDP_TXï¼šç›´æ¥ä»é©±åŠ¨å›å‘ â””â”€â”€ XDP_REDIRECTï¼šè½¬å‘åˆ°å…¶ä»–ç½‘å¡æˆ– AF_XDP socket å…¸å‹ç”¨é€”ï¼š"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-10-29T00:00:00+00:00"><meta property="article:modified_time" content="2025-10-29T00:00:00+00:00"><meta property="article:tag" content="EBPF"><meta property="og:image" content="https://kerolt.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://kerolt.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="TCå’ŒXDP"><meta name=twitter:description content="tc å’Œ XDP éƒ½èƒ½å¯¹ç½‘ç»œæ•°æ®åŒ…è¿›è¡Œå¤„ç†ï¼Œä½†å®ƒä»¬ä½äº ä¸åŒçš„ç½‘ç»œåè®®æ ˆå±‚æ¬¡ï¼Œå› æ­¤æ€§èƒ½ã€èƒ½åŠ›å’Œé€‚ç”¨åœºæ™¯å·®åˆ«éƒ½å¾ˆå¤§ï¼š

  
      
          é¡¹ç›®
          ä½œç”¨å±‚çº§
          å¤„ç†æ–¹å‘
          ç‰¹ç‚¹
      
  
  
      
          XDP (eXpress Data Path)
          é©±åŠ¨å±‚ï¼ˆæœ€æ—©ï¼‰ï¼šç½‘ç»œè®¾å¤‡é©±åŠ¨å…¥å£å¤„ï¼ˆL2 ä¹‹å‰ï¼‰
          å…¥ç«™ï¼ˆIngressï¼‰
          æå¿«ï¼Œç»•è¿‡å†…æ ¸åè®®æ ˆï¼Œå¯ç›´æ¥ä¸¢åŒ…/è½¬å‘
      
      
          tc (Traffic Control)
          å†…æ ¸ç½‘ç»œæ ˆå±‚ï¼ˆL3/L4 ä¹‹åï¼‰
          å…¥ç«™ + å‡ºç«™
          é€šå¸¸ç”¨äºå¸¦å®½æ§åˆ¶ã€QoSã€æµé‡æ•´å½¢ç­‰
      
  

Linux ç½‘ç»œåŒ…å¤„ç†è·¯å¾„
ä¸‹é¢è¿™å¼ å›¾èƒ½æ¸…æ™°åœ°çœ‹åˆ° XDP å’Œ tc å„è‡ªå¤„åœ¨ä»€ä¹ˆä½ç½®ï¼š
                +----------------------------------------+
                |              ç”¨æˆ·ç©ºé—´                  |
                |  (åº”ç”¨å±‚: Nginx, curl, ping, etc.)     |
                +----------------------------------------+
                                â–²
                                â”‚ send()/recv()
                                â”‚
                +----------------------------------------+
                |            å†…æ ¸ç½‘ç»œåè®®æ ˆ               |
                |----------------------------------------|
                |   L4 (TCP/UDP)                         |
                |   L3 (IP è·¯ç”±è½¬å‘)                     |
                |   L2 (Ethernet frame å¤„ç†)             |
                +----------------------------------------+
                     â–²                     â–²
                     â”‚                     â”‚
        tc ingress/qdisc           tc egress/qdisc
             â”‚                           â”‚
             â”‚                           â–¼
        +----------------------------------------+
        |        XDP (eXpress Data Path)         |
        | (ä½äºç½‘å¡é©±åŠ¨ä¸­ï¼Œæœ€é è¿‘ç¡¬ä»¶çš„é’©å­ç‚¹)     |
        +----------------------------------------+
                     â–²
                     â”‚
              NIC é©±åŠ¨ / DMA æ”¶åŒ…

å¤„ç†è·¯å¾„ç»†èŠ‚å¯¹æ¯”

  
      
          å¯¹æ¯”é¡¹
          XDP
          tc (ingress/egress)
      
  
  
      
          æ‰€åœ¨å±‚çº§
          NIC é©±åŠ¨å±‚ï¼ˆæ¯”å†…æ ¸åè®®æ ˆè¿˜æ—©ï¼‰
          å†…æ ¸ç½‘ç»œæ ˆï¼ˆL3/L4 å±‚ä¹‹é—´ï¼‰
      
      
          é’©å­ä½ç½®
          é©±åŠ¨æ¥æ”¶åŒ… â†’ DMA â†’ XDP
          skbï¼ˆsocket bufferï¼‰è¿›å…¥æˆ–ç¦»å¼€åè®®æ ˆæ—¶
      
      
          ä½œç”¨æ–¹å‘
          ä»…æ”¯æŒ ingressï¼ˆå…¥ç«™ï¼‰
          æ”¯æŒ ingress + egress
      
      
          å¤„ç†å¯¹è±¡
          åŸå§‹æ•°æ®åŒ…ï¼ˆframeï¼‰
          å°è£…åçš„ skb
      
      
          æ€§èƒ½
          æé«˜ï¼ˆå¯åœ¨ç™¾ä¸‡ pps çº§åˆ«ï¼‰
          ä¸­ç­‰ï¼ˆå—å†…æ ¸è°ƒåº¦å’Œ qdisc å½±å“ï¼‰
      
      
          å…¸å‹ç”¨é€”
          DDoS é˜²æŠ¤ã€æ—©æœŸä¸¢åŒ…ã€å¿«é€Ÿè½¬å‘ã€å†…æ ¸æ—è·¯
          QoSã€æµé‡æ•´å½¢ã€é™é€Ÿã€åŒ…åˆ†ç±»
      
      
          å¯ç¼–ç¨‹æ€§
          eBPF ç¨‹åºï¼ˆxdp ç¨‹åºï¼‰
          eBPF ç¨‹åºï¼ˆcls_bpfï¼‰
      
      
          è¿”å›åŠ¨ä½œ
          XDP_PASSã€XDP_DROPã€XDP_TXã€XDP_REDIRECT
          TC_ACT_OKã€TC_ACT_SHOTã€TC_ACT_REDIRECT
      
      
          ä½¿ç”¨æ¥å£
          ip link set dev eth0 xdp obj prog.o
          tc filter add dev eth0 ... bpf obj prog.o
      
  

æ•°æ®å¤„ç†æµç¨‹ä¸¾ä¾‹
XDP æµç¨‹ï¼ˆæœ€æ—©é˜¶æ®µï¼‰
[ç½‘å¡æ¥æ”¶åŒ…]
   â†“
[XDP ç¨‹åºæ‰§è¡Œ]
   â”œâ”€â”€ XDP_DROPï¼šç›´æ¥ä¸¢åŒ…ï¼ˆä¸è¿›å…¥å†…æ ¸ï¼‰
   â”œâ”€â”€ XDP_PASSï¼šè®©åŒ…è¿›å…¥å†…æ ¸åè®®æ ˆ
   â”œâ”€â”€ XDP_TXï¼šç›´æ¥ä»é©±åŠ¨å›å‘
   â””â”€â”€ XDP_REDIRECTï¼šè½¬å‘åˆ°å…¶ä»–ç½‘å¡æˆ– AF_XDP socket
å…¸å‹ç”¨é€”ï¼š"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://kerolt.github.io/posts/"},{"@type":"ListItem","position":2,"name":"TCå’ŒXDP","item":"https://kerolt.github.io/posts/ebpf/tc%E5%92%8Cxdp/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"TCå’ŒXDP","name":"TCå’ŒXDP","description":"tc å’Œ XDP éƒ½èƒ½å¯¹ç½‘ç»œæ•°æ®åŒ…è¿›è¡Œå¤„ç†ï¼Œä½†å®ƒä»¬ä½äº ä¸åŒçš„ç½‘ç»œåè®®æ ˆå±‚æ¬¡ï¼Œå› æ­¤æ€§èƒ½ã€èƒ½åŠ›å’Œé€‚ç”¨åœºæ™¯å·®åˆ«éƒ½å¾ˆå¤§ï¼š\né¡¹ç›® ä½œç”¨å±‚çº§ å¤„ç†æ–¹å‘ ç‰¹ç‚¹ XDP (eXpress Data Path) é©±åŠ¨å±‚ï¼ˆæœ€æ—©ï¼‰ï¼šç½‘ç»œè®¾å¤‡é©±åŠ¨å…¥å£å¤„ï¼ˆL2 ä¹‹å‰ï¼‰ å…¥ç«™ï¼ˆIngressï¼‰ æå¿«ï¼Œç»•è¿‡å†…æ ¸åè®®æ ˆï¼Œå¯ç›´æ¥ä¸¢åŒ…/è½¬å‘ tc (Traffic Control) å†…æ ¸ç½‘ç»œæ ˆå±‚ï¼ˆL3/L4 ä¹‹åï¼‰ å…¥ç«™ + å‡ºç«™ é€šå¸¸ç”¨äºå¸¦å®½æ§åˆ¶ã€QoSã€æµé‡æ•´å½¢ç­‰ Linux ç½‘ç»œåŒ…å¤„ç†è·¯å¾„ ä¸‹é¢è¿™å¼ å›¾èƒ½æ¸…æ™°åœ°çœ‹åˆ° XDP å’Œ tc å„è‡ªå¤„åœ¨ä»€ä¹ˆä½ç½®ï¼š\n+----------------------------------------+ | ç”¨æˆ·ç©ºé—´ | | (åº”ç”¨å±‚: Nginx, curl, ping, etc.) | +----------------------------------------+ â–² â”‚ send()/recv() â”‚ +----------------------------------------+ | å†…æ ¸ç½‘ç»œåè®®æ ˆ | |----------------------------------------| | L4 (TCP/UDP) | | L3 (IP è·¯ç”±è½¬å‘) | | L2 (Ethernet frame å¤„ç†) | +----------------------------------------+ â–² â–² â”‚ â”‚ tc ingress/qdisc tc egress/qdisc â”‚ â”‚ â”‚ â–¼ +----------------------------------------+ | XDP (eXpress Data Path) | | (ä½äºç½‘å¡é©±åŠ¨ä¸­ï¼Œæœ€é è¿‘ç¡¬ä»¶çš„é’©å­ç‚¹) | +----------------------------------------+ â–² â”‚ NIC é©±åŠ¨ / DMA æ”¶åŒ… å¤„ç†è·¯å¾„ç»†èŠ‚å¯¹æ¯” å¯¹æ¯”é¡¹ XDP tc (ingress/egress) æ‰€åœ¨å±‚çº§ NIC é©±åŠ¨å±‚ï¼ˆæ¯”å†…æ ¸åè®®æ ˆè¿˜æ—©ï¼‰ å†…æ ¸ç½‘ç»œæ ˆï¼ˆL3/L4 å±‚ä¹‹é—´ï¼‰ é’©å­ä½ç½® é©±åŠ¨æ¥æ”¶åŒ… â†’ DMA â†’ XDP skbï¼ˆsocket bufferï¼‰è¿›å…¥æˆ–ç¦»å¼€åè®®æ ˆæ—¶ ä½œç”¨æ–¹å‘ ä»…æ”¯æŒ ingressï¼ˆå…¥ç«™ï¼‰ æ”¯æŒ ingress + egress å¤„ç†å¯¹è±¡ åŸå§‹æ•°æ®åŒ…ï¼ˆframeï¼‰ å°è£…åçš„ skb æ€§èƒ½ æé«˜ï¼ˆå¯åœ¨ç™¾ä¸‡ pps çº§åˆ«ï¼‰ ä¸­ç­‰ï¼ˆå—å†…æ ¸è°ƒåº¦å’Œ qdisc å½±å“ï¼‰ å…¸å‹ç”¨é€” DDoS é˜²æŠ¤ã€æ—©æœŸä¸¢åŒ…ã€å¿«é€Ÿè½¬å‘ã€å†…æ ¸æ—è·¯ QoSã€æµé‡æ•´å½¢ã€é™é€Ÿã€åŒ…åˆ†ç±» å¯ç¼–ç¨‹æ€§ eBPF ç¨‹åºï¼ˆxdp ç¨‹åºï¼‰ eBPF ç¨‹åºï¼ˆcls_bpfï¼‰ è¿”å›åŠ¨ä½œ XDP_PASSã€XDP_DROPã€XDP_TXã€XDP_REDIRECT TC_ACT_OKã€TC_ACT_SHOTã€TC_ACT_REDIRECT ä½¿ç”¨æ¥å£ ip link set dev eth0 xdp obj prog.o tc filter add dev eth0 ... bpf obj prog.o æ•°æ®å¤„ç†æµç¨‹ä¸¾ä¾‹ XDP æµç¨‹ï¼ˆæœ€æ—©é˜¶æ®µï¼‰ [ç½‘å¡æ¥æ”¶åŒ…] â†“ [XDP ç¨‹åºæ‰§è¡Œ] â”œâ”€â”€ XDP_DROPï¼šç›´æ¥ä¸¢åŒ…ï¼ˆä¸è¿›å…¥å†…æ ¸ï¼‰ â”œâ”€â”€ XDP_PASSï¼šè®©åŒ…è¿›å…¥å†…æ ¸åè®®æ ˆ â”œâ”€â”€ XDP_TXï¼šç›´æ¥ä»é©±åŠ¨å›å‘ â””â”€â”€ XDP_REDIRECTï¼šè½¬å‘åˆ°å…¶ä»–ç½‘å¡æˆ– AF_XDP socket å…¸å‹ç”¨é€”ï¼š\n","keywords":["eBPF"],"articleBody":"tc å’Œ XDP éƒ½èƒ½å¯¹ç½‘ç»œæ•°æ®åŒ…è¿›è¡Œå¤„ç†ï¼Œä½†å®ƒä»¬ä½äº ä¸åŒçš„ç½‘ç»œåè®®æ ˆå±‚æ¬¡ï¼Œå› æ­¤æ€§èƒ½ã€èƒ½åŠ›å’Œé€‚ç”¨åœºæ™¯å·®åˆ«éƒ½å¾ˆå¤§ï¼š\né¡¹ç›® ä½œç”¨å±‚çº§ å¤„ç†æ–¹å‘ ç‰¹ç‚¹ XDP (eXpress Data Path) é©±åŠ¨å±‚ï¼ˆæœ€æ—©ï¼‰ï¼šç½‘ç»œè®¾å¤‡é©±åŠ¨å…¥å£å¤„ï¼ˆL2 ä¹‹å‰ï¼‰ å…¥ç«™ï¼ˆIngressï¼‰ æå¿«ï¼Œç»•è¿‡å†…æ ¸åè®®æ ˆï¼Œå¯ç›´æ¥ä¸¢åŒ…/è½¬å‘ tc (Traffic Control) å†…æ ¸ç½‘ç»œæ ˆå±‚ï¼ˆL3/L4 ä¹‹åï¼‰ å…¥ç«™ + å‡ºç«™ é€šå¸¸ç”¨äºå¸¦å®½æ§åˆ¶ã€QoSã€æµé‡æ•´å½¢ç­‰ Linux ç½‘ç»œåŒ…å¤„ç†è·¯å¾„ ä¸‹é¢è¿™å¼ å›¾èƒ½æ¸…æ™°åœ°çœ‹åˆ° XDP å’Œ tc å„è‡ªå¤„åœ¨ä»€ä¹ˆä½ç½®ï¼š\n+----------------------------------------+ | ç”¨æˆ·ç©ºé—´ | | (åº”ç”¨å±‚: Nginx, curl, ping, etc.) | +----------------------------------------+ â–² â”‚ send()/recv() â”‚ +----------------------------------------+ | å†…æ ¸ç½‘ç»œåè®®æ ˆ | |----------------------------------------| | L4 (TCP/UDP) | | L3 (IP è·¯ç”±è½¬å‘) | | L2 (Ethernet frame å¤„ç†) | +----------------------------------------+ â–² â–² â”‚ â”‚ tc ingress/qdisc tc egress/qdisc â”‚ â”‚ â”‚ â–¼ +----------------------------------------+ | XDP (eXpress Data Path) | | (ä½äºç½‘å¡é©±åŠ¨ä¸­ï¼Œæœ€é è¿‘ç¡¬ä»¶çš„é’©å­ç‚¹) | +----------------------------------------+ â–² â”‚ NIC é©±åŠ¨ / DMA æ”¶åŒ… å¤„ç†è·¯å¾„ç»†èŠ‚å¯¹æ¯” å¯¹æ¯”é¡¹ XDP tc (ingress/egress) æ‰€åœ¨å±‚çº§ NIC é©±åŠ¨å±‚ï¼ˆæ¯”å†…æ ¸åè®®æ ˆè¿˜æ—©ï¼‰ å†…æ ¸ç½‘ç»œæ ˆï¼ˆL3/L4 å±‚ä¹‹é—´ï¼‰ é’©å­ä½ç½® é©±åŠ¨æ¥æ”¶åŒ… â†’ DMA â†’ XDP skbï¼ˆsocket bufferï¼‰è¿›å…¥æˆ–ç¦»å¼€åè®®æ ˆæ—¶ ä½œç”¨æ–¹å‘ ä»…æ”¯æŒ ingressï¼ˆå…¥ç«™ï¼‰ æ”¯æŒ ingress + egress å¤„ç†å¯¹è±¡ åŸå§‹æ•°æ®åŒ…ï¼ˆframeï¼‰ å°è£…åçš„ skb æ€§èƒ½ æé«˜ï¼ˆå¯åœ¨ç™¾ä¸‡ pps çº§åˆ«ï¼‰ ä¸­ç­‰ï¼ˆå—å†…æ ¸è°ƒåº¦å’Œ qdisc å½±å“ï¼‰ å…¸å‹ç”¨é€” DDoS é˜²æŠ¤ã€æ—©æœŸä¸¢åŒ…ã€å¿«é€Ÿè½¬å‘ã€å†…æ ¸æ—è·¯ QoSã€æµé‡æ•´å½¢ã€é™é€Ÿã€åŒ…åˆ†ç±» å¯ç¼–ç¨‹æ€§ eBPF ç¨‹åºï¼ˆxdp ç¨‹åºï¼‰ eBPF ç¨‹åºï¼ˆcls_bpfï¼‰ è¿”å›åŠ¨ä½œ XDP_PASSã€XDP_DROPã€XDP_TXã€XDP_REDIRECT TC_ACT_OKã€TC_ACT_SHOTã€TC_ACT_REDIRECT ä½¿ç”¨æ¥å£ ip link set dev eth0 xdp obj prog.o tc filter add dev eth0 ... bpf obj prog.o æ•°æ®å¤„ç†æµç¨‹ä¸¾ä¾‹ XDP æµç¨‹ï¼ˆæœ€æ—©é˜¶æ®µï¼‰ [ç½‘å¡æ¥æ”¶åŒ…] â†“ [XDP ç¨‹åºæ‰§è¡Œ] â”œâ”€â”€ XDP_DROPï¼šç›´æ¥ä¸¢åŒ…ï¼ˆä¸è¿›å…¥å†…æ ¸ï¼‰ â”œâ”€â”€ XDP_PASSï¼šè®©åŒ…è¿›å…¥å†…æ ¸åè®®æ ˆ â”œâ”€â”€ XDP_TXï¼šç›´æ¥ä»é©±åŠ¨å›å‘ â””â”€â”€ XDP_REDIRECTï¼šè½¬å‘åˆ°å…¶ä»–ç½‘å¡æˆ– AF_XDP socket å…¸å‹ç”¨é€”ï¼š\nDDoS é˜²æŠ¤ å†…æ ¸æ—è·¯è´Ÿè½½å‡è¡¡ï¼ˆå¦‚ Ciliumã€Katranï¼‰ é›¶æ‹·è´åŒ…å¤„ç†ï¼ˆAF_XDPï¼‰ tc æµç¨‹ï¼ˆç¨æ™šé˜¶æ®µï¼‰ [åŒ…è¿›å…¥å†…æ ¸åè®®æ ˆ] â†“ [tc ingress qdisc è¿‡æ»¤å™¨] â”œâ”€â”€ DROPï¼ˆä¸¢å¼ƒï¼‰ â”œâ”€â”€ REDIRECTï¼ˆé‡å®šå‘ï¼‰ â”œâ”€â”€ CLASSIFYï¼ˆåˆ†ç±»ï¼‰ â†“ [å†…æ ¸ç½‘ç»œå±‚è·¯ç”±ä¸ä¼ è¾“å±‚å¤„ç†] â†“ [tc egress qdisc è¿‡æ»¤å™¨] â”œâ”€â”€ é™é€Ÿã€æ’é˜Ÿã€ä¼˜å…ˆçº§è°ƒåº¦ â””â”€â”€ æœ€ç»ˆå‘å¾€ç½‘å¡å‘é€é˜Ÿåˆ— å…¸å‹ç”¨é€”ï¼š\nQoS ä¼˜å…ˆçº§è°ƒåº¦ï¼ˆHTBã€HFSCï¼‰ å‡ºå£é™é€Ÿï¼ˆTBFï¼‰ ç½‘ç»œå»¶è¿Ÿä»¿çœŸï¼ˆnetemï¼‰ eBPF-based ç›‘æ§/æµé‡æ ‡è®° ç°ä»£ç³»ç»Ÿï¼ˆä¾‹å¦‚ Ciliumã€Facebook Katranã€Cloudflare å†…æ ¸åŠ é€Ÿï¼‰å¸¸å¸¸ç»“åˆä¸¤è€…ä½¿ç”¨ï¼š\n+-----------+ +----------------+ NIC ---\u003e | XDP | å…ˆçº§ç­›é€‰ | tc ingress | | (æ—©ä¸¢åŒ…) | -------\u003e | (QoS/åˆ†ç±»/æ ‡è®°)| +-----------+ +----------------+ ä¾‹å¦‚ï¼š\nåœ¨ XDP å±‚ å…ˆå¿«é€Ÿä¸¢å¼ƒæ˜æ˜¾æ¶æ„æˆ–æ— æ•ˆæµé‡ï¼›\nåœ¨ tc å±‚ åšå¸¦å®½ç®¡ç†ã€ä¼˜å…ˆçº§è°ƒåº¦ã€‚\næ€§èƒ½å±‚é¢æ¯”è¾ƒ é¡¹ç›® XDP tc æ‰§è¡Œä½ç½® é©±åŠ¨å±‚ å†…æ ¸ç½‘ç»œæ ˆ æ•°æ®ç»“æ„ åŸå§‹ buffer struct sk_buffï¼ˆå¼€é”€è¾ƒå¤§ï¼‰ å»¶è¿Ÿ çº³ç§’çº§ å¾®ç§’çº§ PPS åå ~10M pps ~1M pps é›¶æ‹·è´ âœ… å¯å®ç° (AF_XDP) âŒ æ— æ³•å®ç° æ€»ç»“ï¼š\nXDP æ˜¯â€œåœ¨å†…æ ¸æ ˆä¹‹å‰â€çš„åŠ é€Ÿç‚¹ï¼Œæç«¯é«˜æ€§èƒ½ï¼›\ntc æ˜¯â€œåœ¨å†…æ ¸æ ˆå†…éƒ¨â€çš„æ§åˆ¶ç‚¹ï¼Œæ›´çµæ´»ä½†ç¨æ…¢ã€‚\n","wordCount":"287","inLanguage":"en","image":"https://kerolt.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2025-10-29T00:00:00Z","dateModified":"2025-10-29T00:00:00Z","author":{"@type":"Person","name":"Kerolt"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://kerolt.github.io/posts/ebpf/tc%E5%92%8Cxdp/"},"publisher":{"@type":"Organization","name":"Kerolt's Blog","logo":{"@type":"ImageObject","url":"https://kerolt.github.io/images/avatar/favicon.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://kerolt.github.io/ accesskey=h title="Kerolt's Blog (Alt + H)">Kerolt's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://kerolt.github.io/posts/ title=æ–‡ç« ><span>æ–‡ç« </span></a></li><li><a href=https://kerolt.github.io/categories/ title=åˆ†ç±»><span>åˆ†ç±»</span></a></li><li><a href=https://kerolt.github.io/tags/ title=æ ‡ç­¾><span>æ ‡ç­¾</span></a></li><li><a href=https://kerolt.github.io/archives/ title=å½’æ¡£><span>å½’æ¡£</span></a></li><li><a href=https://kerolt.github.io/about/ title=å…³äºæˆ‘><span>å…³äºæˆ‘</span></a></li><li><a href=https://kerolt.github.io/search/ title="ğŸ” (Alt + /)" accesskey=/><span>ğŸ”</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://kerolt.github.io/>Home</a>&nbsp;Â»&nbsp;<a href=https://kerolt.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">TCå’ŒXDP</h1><div class=post-meta><span title='2025-10-29 00:00:00 +0000 UTC'>2025-10-29</span>&nbsp;Â·&nbsp;2 min&nbsp;Â·&nbsp;287 words&nbsp;Â·&nbsp;Kerolt</div><ul class=post-tags><li><a href=https://kerolt.github.io/tags/ebpf/>EBPF</a></li></ul></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#linux-%e7%bd%91%e7%bb%9c%e5%8c%85%e5%a4%84%e7%90%86%e8%b7%af%e5%be%84 aria-label="Linux ç½‘ç»œåŒ…å¤„ç†è·¯å¾„">Linux ç½‘ç»œåŒ…å¤„ç†è·¯å¾„</a></li><li><a href=#%e5%a4%84%e7%90%86%e8%b7%af%e5%be%84%e7%bb%86%e8%8a%82%e5%af%b9%e6%af%94 aria-label=å¤„ç†è·¯å¾„ç»†èŠ‚å¯¹æ¯”>å¤„ç†è·¯å¾„ç»†èŠ‚å¯¹æ¯”</a></li><li><a href=#%e6%95%b0%e6%8d%ae%e5%a4%84%e7%90%86%e6%b5%81%e7%a8%8b%e4%b8%be%e4%be%8b aria-label=æ•°æ®å¤„ç†æµç¨‹ä¸¾ä¾‹>æ•°æ®å¤„ç†æµç¨‹ä¸¾ä¾‹</a><ul><li><a href=#xdp-%e6%b5%81%e7%a8%8b%e6%9c%80%e6%97%a9%e9%98%b6%e6%ae%b5 aria-label="XDP æµç¨‹ï¼ˆæœ€æ—©é˜¶æ®µï¼‰">XDP æµç¨‹ï¼ˆæœ€æ—©é˜¶æ®µï¼‰</a></li><li><a href=#tc-%e6%b5%81%e7%a8%8b%e7%a8%8d%e6%99%9a%e9%98%b6%e6%ae%b5 aria-label="tc æµç¨‹ï¼ˆç¨æ™šé˜¶æ®µï¼‰">tc æµç¨‹ï¼ˆç¨æ™šé˜¶æ®µï¼‰</a></li></ul></li><li><a href=#%e6%80%a7%e8%83%bd%e5%b1%82%e9%9d%a2%e6%af%94%e8%be%83 aria-label=æ€§èƒ½å±‚é¢æ¯”è¾ƒ>æ€§èƒ½å±‚é¢æ¯”è¾ƒ</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><p><strong><code>tc</code></strong> å’Œ <strong><code>XDP</code></strong> éƒ½èƒ½å¯¹ç½‘ç»œæ•°æ®åŒ…è¿›è¡Œå¤„ç†ï¼Œä½†å®ƒä»¬ä½äº <strong>ä¸åŒçš„ç½‘ç»œåè®®æ ˆå±‚æ¬¡</strong>ï¼Œå› æ­¤æ€§èƒ½ã€èƒ½åŠ›å’Œé€‚ç”¨åœºæ™¯å·®åˆ«éƒ½å¾ˆå¤§ï¼š</p><table><thead><tr><th>é¡¹ç›®</th><th>ä½œç”¨å±‚çº§</th><th>å¤„ç†æ–¹å‘</th><th>ç‰¹ç‚¹</th></tr></thead><tbody><tr><td><strong>XDP (eXpress Data Path)</strong></td><td><strong>é©±åŠ¨å±‚ï¼ˆæœ€æ—©ï¼‰</strong>ï¼šç½‘ç»œè®¾å¤‡é©±åŠ¨å…¥å£å¤„ï¼ˆL2 ä¹‹å‰ï¼‰</td><td>å…¥ç«™ï¼ˆIngressï¼‰</td><td>æå¿«ï¼Œç»•è¿‡å†…æ ¸åè®®æ ˆï¼Œå¯ç›´æ¥ä¸¢åŒ…/è½¬å‘</td></tr><tr><td><strong>tc (Traffic Control)</strong></td><td><strong>å†…æ ¸ç½‘ç»œæ ˆå±‚ï¼ˆL3/L4 ä¹‹åï¼‰</strong></td><td>å…¥ç«™ + å‡ºç«™</td><td>é€šå¸¸ç”¨äºå¸¦å®½æ§åˆ¶ã€QoSã€æµé‡æ•´å½¢ç­‰</td></tr></tbody></table><h2 id=linux-ç½‘ç»œåŒ…å¤„ç†è·¯å¾„>Linux ç½‘ç»œåŒ…å¤„ç†è·¯å¾„<a hidden class=anchor aria-hidden=true href=#linux-ç½‘ç»œåŒ…å¤„ç†è·¯å¾„>#</a></h2><p>ä¸‹é¢è¿™å¼ å›¾èƒ½æ¸…æ™°åœ°çœ‹åˆ° <code>XDP</code> å’Œ <code>tc</code> å„è‡ªå¤„åœ¨ä»€ä¹ˆä½ç½®ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>                +----------------------------------------+
</span></span><span style=display:flex><span>                |              ç”¨æˆ·ç©ºé—´                  |
</span></span><span style=display:flex><span>                |  (åº”ç”¨å±‚: Nginx, curl, ping, etc.)     |
</span></span><span style=display:flex><span>                +----------------------------------------+
</span></span><span style=display:flex><span>                                â–²
</span></span><span style=display:flex><span>                                â”‚ send()/recv()
</span></span><span style=display:flex><span>                                â”‚
</span></span><span style=display:flex><span>                +----------------------------------------+
</span></span><span style=display:flex><span>                |            å†…æ ¸ç½‘ç»œåè®®æ ˆ               |
</span></span><span style=display:flex><span>                |----------------------------------------|
</span></span><span style=display:flex><span>                |   L4 (TCP/UDP)                         |
</span></span><span style=display:flex><span>                |   L3 (IP è·¯ç”±è½¬å‘)                     |
</span></span><span style=display:flex><span>                |   L2 (Ethernet frame å¤„ç†)             |
</span></span><span style=display:flex><span>                +----------------------------------------+
</span></span><span style=display:flex><span>                     â–²                     â–²
</span></span><span style=display:flex><span>                     â”‚                     â”‚
</span></span><span style=display:flex><span>        tc ingress/qdisc           tc egress/qdisc
</span></span><span style=display:flex><span>             â”‚                           â”‚
</span></span><span style=display:flex><span>             â”‚                           â–¼
</span></span><span style=display:flex><span>        +----------------------------------------+
</span></span><span style=display:flex><span>        |        XDP (eXpress Data Path)         |
</span></span><span style=display:flex><span>        | (ä½äºç½‘å¡é©±åŠ¨ä¸­ï¼Œæœ€é è¿‘ç¡¬ä»¶çš„é’©å­ç‚¹)     |
</span></span><span style=display:flex><span>        +----------------------------------------+
</span></span><span style=display:flex><span>                     â–²
</span></span><span style=display:flex><span>                     â”‚
</span></span><span style=display:flex><span>              NIC é©±åŠ¨ / DMA æ”¶åŒ…
</span></span></code></pre></div><hr><h2 id=å¤„ç†è·¯å¾„ç»†èŠ‚å¯¹æ¯”>å¤„ç†è·¯å¾„ç»†èŠ‚å¯¹æ¯”<a hidden class=anchor aria-hidden=true href=#å¤„ç†è·¯å¾„ç»†èŠ‚å¯¹æ¯”>#</a></h2><table><thead><tr><th>å¯¹æ¯”é¡¹</th><th><strong>XDP</strong></th><th><strong>tc (ingress/egress)</strong></th></tr></thead><tbody><tr><td><strong>æ‰€åœ¨å±‚çº§</strong></td><td>NIC é©±åŠ¨å±‚ï¼ˆæ¯”å†…æ ¸åè®®æ ˆè¿˜æ—©ï¼‰</td><td>å†…æ ¸ç½‘ç»œæ ˆï¼ˆL3/L4 å±‚ä¹‹é—´ï¼‰</td></tr><tr><td><strong>é’©å­ä½ç½®</strong></td><td>é©±åŠ¨æ¥æ”¶åŒ… â†’ DMA â†’ XDP</td><td>skbï¼ˆsocket bufferï¼‰è¿›å…¥æˆ–ç¦»å¼€åè®®æ ˆæ—¶</td></tr><tr><td><strong>ä½œç”¨æ–¹å‘</strong></td><td>ä»…æ”¯æŒ ingressï¼ˆå…¥ç«™ï¼‰</td><td>æ”¯æŒ ingress + egress</td></tr><tr><td><strong>å¤„ç†å¯¹è±¡</strong></td><td>åŸå§‹æ•°æ®åŒ…ï¼ˆframeï¼‰</td><td>å°è£…åçš„ skb</td></tr><tr><td><strong>æ€§èƒ½</strong></td><td>æé«˜ï¼ˆå¯åœ¨ç™¾ä¸‡ pps çº§åˆ«ï¼‰</td><td>ä¸­ç­‰ï¼ˆå—å†…æ ¸è°ƒåº¦å’Œ qdisc å½±å“ï¼‰</td></tr><tr><td><strong>å…¸å‹ç”¨é€”</strong></td><td>DDoS é˜²æŠ¤ã€æ—©æœŸä¸¢åŒ…ã€å¿«é€Ÿè½¬å‘ã€å†…æ ¸æ—è·¯</td><td>QoSã€æµé‡æ•´å½¢ã€é™é€Ÿã€åŒ…åˆ†ç±»</td></tr><tr><td><strong>å¯ç¼–ç¨‹æ€§</strong></td><td>eBPF ç¨‹åºï¼ˆxdp ç¨‹åºï¼‰</td><td>eBPF ç¨‹åºï¼ˆcls_bpfï¼‰</td></tr><tr><td><strong>è¿”å›åŠ¨ä½œ</strong></td><td>XDP_PASSã€XDP_DROPã€XDP_TXã€XDP_REDIRECT</td><td>TC_ACT_OKã€TC_ACT_SHOTã€TC_ACT_REDIRECT</td></tr><tr><td><strong>ä½¿ç”¨æ¥å£</strong></td><td><code>ip link set dev eth0 xdp obj prog.o</code></td><td><code>tc filter add dev eth0 ... bpf obj prog.o</code></td></tr></tbody></table><h2 id=æ•°æ®å¤„ç†æµç¨‹ä¸¾ä¾‹>æ•°æ®å¤„ç†æµç¨‹ä¸¾ä¾‹<a hidden class=anchor aria-hidden=true href=#æ•°æ®å¤„ç†æµç¨‹ä¸¾ä¾‹>#</a></h2><h3 id=xdp-æµç¨‹æœ€æ—©é˜¶æ®µ>XDP æµç¨‹ï¼ˆæœ€æ—©é˜¶æ®µï¼‰<a hidden class=anchor aria-hidden=true href=#xdp-æµç¨‹æœ€æ—©é˜¶æ®µ>#</a></h3><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>[ç½‘å¡æ¥æ”¶åŒ…]
</span></span><span style=display:flex><span>   â†“
</span></span><span style=display:flex><span>[XDP ç¨‹åºæ‰§è¡Œ]
</span></span><span style=display:flex><span>   â”œâ”€â”€ XDP_DROPï¼šç›´æ¥ä¸¢åŒ…ï¼ˆä¸è¿›å…¥å†…æ ¸ï¼‰
</span></span><span style=display:flex><span>   â”œâ”€â”€ XDP_PASSï¼šè®©åŒ…è¿›å…¥å†…æ ¸åè®®æ ˆ
</span></span><span style=display:flex><span>   â”œâ”€â”€ XDP_TXï¼šç›´æ¥ä»é©±åŠ¨å›å‘
</span></span><span style=display:flex><span>   â””â”€â”€ XDP_REDIRECTï¼šè½¬å‘åˆ°å…¶ä»–ç½‘å¡æˆ– AF_XDP socket
</span></span></code></pre></div><p><strong>å…¸å‹ç”¨é€”ï¼š</strong></p><ul><li>DDoS é˜²æŠ¤</li><li>å†…æ ¸æ—è·¯è´Ÿè½½å‡è¡¡ï¼ˆå¦‚ Ciliumã€Katranï¼‰</li><li>é›¶æ‹·è´åŒ…å¤„ç†ï¼ˆAF_XDPï¼‰</li></ul><h3 id=tc-æµç¨‹ç¨æ™šé˜¶æ®µ>tc æµç¨‹ï¼ˆç¨æ™šé˜¶æ®µï¼‰<a hidden class=anchor aria-hidden=true href=#tc-æµç¨‹ç¨æ™šé˜¶æ®µ>#</a></h3><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>[åŒ…è¿›å…¥å†…æ ¸åè®®æ ˆ]
</span></span><span style=display:flex><span>   â†“
</span></span><span style=display:flex><span>[tc ingress qdisc è¿‡æ»¤å™¨]
</span></span><span style=display:flex><span>   â”œâ”€â”€ DROPï¼ˆä¸¢å¼ƒï¼‰
</span></span><span style=display:flex><span>   â”œâ”€â”€ REDIRECTï¼ˆé‡å®šå‘ï¼‰
</span></span><span style=display:flex><span>   â”œâ”€â”€ CLASSIFYï¼ˆåˆ†ç±»ï¼‰
</span></span><span style=display:flex><span>   â†“
</span></span><span style=display:flex><span>[å†…æ ¸ç½‘ç»œå±‚è·¯ç”±ä¸ä¼ è¾“å±‚å¤„ç†]
</span></span><span style=display:flex><span>   â†“
</span></span><span style=display:flex><span>[tc egress qdisc è¿‡æ»¤å™¨]
</span></span><span style=display:flex><span>   â”œâ”€â”€ é™é€Ÿã€æ’é˜Ÿã€ä¼˜å…ˆçº§è°ƒåº¦
</span></span><span style=display:flex><span>   â””â”€â”€ æœ€ç»ˆå‘å¾€ç½‘å¡å‘é€é˜Ÿåˆ—
</span></span></code></pre></div><p><strong>å…¸å‹ç”¨é€”ï¼š</strong></p><ul><li>QoS ä¼˜å…ˆçº§è°ƒåº¦ï¼ˆHTBã€HFSCï¼‰</li><li>å‡ºå£é™é€Ÿï¼ˆTBFï¼‰</li><li>ç½‘ç»œå»¶è¿Ÿä»¿çœŸï¼ˆnetemï¼‰</li><li>eBPF-based ç›‘æ§/æµé‡æ ‡è®°</li></ul><hr><p>ç°ä»£ç³»ç»Ÿï¼ˆä¾‹å¦‚ <strong>Ciliumã€Facebook Katranã€Cloudflare å†…æ ¸åŠ é€Ÿ</strong>ï¼‰å¸¸å¸¸ç»“åˆä¸¤è€…ä½¿ç”¨ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>          +-----------+           +----------------+
</span></span><span style=display:flex><span> NIC ---&gt; |    XDP    | å…ˆçº§ç­›é€‰ | tc ingress     |
</span></span><span style=display:flex><span>          | (æ—©ä¸¢åŒ…)  | -------&gt; | (QoS/åˆ†ç±»/æ ‡è®°)|
</span></span><span style=display:flex><span>          +-----------+           +----------------+
</span></span></code></pre></div><p>ä¾‹å¦‚ï¼š</p><ul><li><p>åœ¨ <strong>XDP å±‚</strong> å…ˆå¿«é€Ÿä¸¢å¼ƒæ˜æ˜¾æ¶æ„æˆ–æ— æ•ˆæµé‡ï¼›</p></li><li><p>åœ¨ <strong>tc å±‚</strong> åšå¸¦å®½ç®¡ç†ã€ä¼˜å…ˆçº§è°ƒåº¦ã€‚</p></li></ul><h2 id=æ€§èƒ½å±‚é¢æ¯”è¾ƒ>æ€§èƒ½å±‚é¢æ¯”è¾ƒ<a hidden class=anchor aria-hidden=true href=#æ€§èƒ½å±‚é¢æ¯”è¾ƒ>#</a></h2><table><thead><tr><th>é¡¹ç›®</th><th>XDP</th><th>tc</th></tr></thead><tbody><tr><td>æ‰§è¡Œä½ç½®</td><td>é©±åŠ¨å±‚</td><td>å†…æ ¸ç½‘ç»œæ ˆ</td></tr><tr><td>æ•°æ®ç»“æ„</td><td>åŸå§‹ buffer</td><td><code>struct sk_buff</code>ï¼ˆå¼€é”€è¾ƒå¤§ï¼‰</td></tr><tr><td>å»¶è¿Ÿ</td><td>çº³ç§’çº§</td><td>å¾®ç§’çº§</td></tr><tr><td>PPS åå</td><td>~10M pps</td><td>~1M pps</td></tr><tr><td>é›¶æ‹·è´</td><td>âœ… å¯å®ç° (AF_XDP)</td><td>âŒ æ— æ³•å®ç°</td></tr></tbody></table><p><strong>æ€»ç»“ï¼š</strong></p><blockquote><p>XDP æ˜¯â€œåœ¨å†…æ ¸æ ˆä¹‹å‰â€çš„åŠ é€Ÿç‚¹ï¼Œæç«¯é«˜æ€§èƒ½ï¼›<br>tc æ˜¯â€œåœ¨å†…æ ¸æ ˆå†…éƒ¨â€çš„æ§åˆ¶ç‚¹ï¼Œæ›´çµæ´»ä½†ç¨æ…¢ã€‚</p></blockquote></div><footer class=post-footer><nav class=paginav><a class=next href=https://kerolt.github.io/posts/ebpf/ebpf%E4%B8%AD%E4%BD%95%E6%97%B6%E4%BD%BF%E7%94%A8%E5%AD%97%E8%8A%82%E5%BA%8F%E8%BD%AC%E6%8D%A2%E5%87%BD%E6%95%B0/><span class=title>Next Â»</span><br><span>eBPFä¸­ä½•æ—¶ä½¿ç”¨å­—èŠ‚åºè½¬æ¢å‡½æ•°</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://kerolt.github.io/>Kerolt's Blog</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>