<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>åˆ©ç”¨eBPFä¸perf_eventæ„å»ºä¸€ä¸ªprofilingå·¥å…· | Kerolt's Blog</title><meta name=keywords content="perf,cpp,æ€§èƒ½åˆ†æ,ç³»ç»Ÿè°ƒç”¨,eBPF"><meta name=description content='å¼•è¨€
åœ¨æ€§èƒ½åˆ†æå’Œç³»ç»Ÿè°ƒä¼˜ä¸­ï¼Œäº†è§£åº”ç”¨ç¨‹åºåœ¨è¿è¡Œæ—¶çš„è°ƒç”¨æ ˆä¿¡æ¯è‡³å…³é‡è¦ã€‚åœ¨ ã€eBPF å…¥é—¨å®è·µæ•™ç¨‹åäºŒï¼šä½¿ç”¨ eBPF ç¨‹åº profile è¿›è¡Œæ€§èƒ½åˆ†æã€‘ è¿™ç¯‡æ–‡ç« ä¸­ï¼Œå…¶åˆ©ç”¨ Rust + eBPF æ„å»ºäº†ä¸€ä¸ª profiler å·¥å…·ï¼ŒæŠ±ç€å­¦ä¹ çš„ç›®çš„ï¼Œæˆ‘ä½¿ç”¨ C++ å®ç°äº†ç›¸åŒçš„åŠŸèƒ½ï¼Œå¹¶å°†æ‰€å­¦çŸ¥è¯†æ€»ç»“æˆæœ¬æ–‡ã€‚
perf_event_open æœºåˆ¶è§£æ


  
    
  



perf åŸç†å›¾ï¼šhttps://plantegg.github.io/2021/05/16/Perf_IPC%E4%BB%A5%E5%8F%8ACPU%E5%88%A9%E7%94%A8%E7%8E%87/

perf_event_open æ˜¯ Linux å†…æ ¸æä¾›çš„æ€§èƒ½ç›‘æ§æ¥å£ï¼Œå…è®¸ç”¨æˆ·ç©ºé—´ç¨‹åºåˆ›å»ºæ€§èƒ½äº‹ä»¶è®¡æ•°å™¨ã€‚å½“ç”¨æˆ·æ€ç¨‹åºè°ƒç”¨ sys_perf_event_open ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œå†…æ ¸ä¼šåˆ›å»ºç›¸åº”çš„æ€§èƒ½ç›‘æ§å®ä¾‹ã€‚ä»¥ä¸‹æ˜¯åŸºæœ¬çš„ä½¿ç”¨æ–¹å¼ï¼š
#include <linux/perf_event.h>
#include <sys/syscall.h>
#include <unistd.h>

int64_t perf_event_open(struct perf_event_attr* hw_event, pid_t pid, int cpu,
                     int group_fd, unsigned long flags) {
    return syscall(SYS_perf_event_open, hw_event, pid, cpu, group_fd, flags);
}
ä»¥æ–‡ä»¶æè¿°ç¬¦ä¸ºä¸­å¿ƒçš„ç›‘æ§å•å…ƒ
Linux éµå¾ª " ä¸€åˆ‡çš†æ–‡ä»¶ " çš„è®¾è®¡å“²å­¦ï¼Œperf_event_open ä¹Ÿä¸ä¾‹å¤–ã€‚æ¯æ¬¡è°ƒç”¨è¯¥å‡½æ•°ï¼Œå†…æ ¸éƒ½ä¼šåˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„æ€§èƒ½ç›‘æ§å®ä¾‹ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚
æ ¸å¿ƒæ¦‚å¿µï¼š

1 fd = 1 Eventï¼šæ¯ä¸ªæ–‡ä»¶æè¿°ç¬¦å¯¹åº”ä¸€ä¸ªå…·ä½“çš„ç›‘æ§ä»»åŠ¡ï¼Œä¾‹å¦‚ " ç›‘æ§ CPU 0 çš„æŒ‡ä»¤æ‰§è¡Œæ•° "
äº‹ä»¶åˆ†ç»„ (Group)ï¼šå¤šä¸ªæ–‡ä»¶æè¿°ç¬¦å¯ä»¥ç»‘å®šåœ¨ä¸€èµ·å½¢æˆäº‹ä»¶ç»„

åˆ†ç»„çš„é‡è¦æ€§ï¼š
å‡è®¾éœ€è¦è®¡ç®— " æ¯æ¡æŒ‡ä»¤çš„ç¼“å­˜æœªå‘½ä¸­ç‡ &ldquo;ï¼Œéœ€è¦åŒæ—¶ç›‘æ§ " æŒ‡ä»¤æ•° " å’Œ " ç¼“å­˜æœªå‘½ä¸­æ•° &ldquo;ã€‚å°†å®ƒä»¬æ”¾å…¥åŒä¸€äº‹ä»¶ç»„å¯ä»¥ç¡®ä¿ï¼š'><meta name=author content="Kerolt"><link rel=canonical href=https://kerolt.github.io/posts/ebpf/%E5%88%A9%E7%94%A8ebpf%E4%B8%8Eperf_event%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AAprofiling%E5%B7%A5%E5%85%B7/><meta name=google-site-verification content="NpIO0KEIJS0CPRzTzQCbYQdSRIyb0Lspx"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="2300A23B82DB579A2DEA6261191AD771"><link crossorigin=anonymous href=/assets/css/stylesheet.0802d94e6eef300965ab76e566006dff491a694c6b49e04aa88a46277ee1da90.css integrity="sha256-CALZTm7vMAllq3blZgBt/0kaaUxrSeBKqIpGJ37h2pA=" rel="preload stylesheet" as=style><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/cn-fontsource-source-han-serif-sc-vf@1.0.9/font.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-screen-web/style.css><link rel=icon href=https://kerolt.github.io/images/avatar/favicon.png><link rel=icon type=image/png sizes=16x16 href=https://kerolt.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://kerolt.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://kerolt.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://kerolt.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://kerolt.github.io/posts/ebpf/%E5%88%A9%E7%94%A8ebpf%E4%B8%8Eperf_event%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AAprofiling%E5%B7%A5%E5%85%B7/><script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css><script src=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js></script><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://kerolt.github.io/posts/ebpf/%E5%88%A9%E7%94%A8ebpf%E4%B8%8Eperf_event%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AAprofiling%E5%B7%A5%E5%85%B7/"><meta property="og:site_name" content="Kerolt's Blog"><meta property="og:title" content="åˆ©ç”¨eBPFä¸perf_eventæ„å»ºä¸€ä¸ªprofilingå·¥å…·"><meta property="og:description" content='å¼•è¨€ åœ¨æ€§èƒ½åˆ†æå’Œç³»ç»Ÿè°ƒä¼˜ä¸­ï¼Œäº†è§£åº”ç”¨ç¨‹åºåœ¨è¿è¡Œæ—¶çš„è°ƒç”¨æ ˆä¿¡æ¯è‡³å…³é‡è¦ã€‚åœ¨ ã€eBPF å…¥é—¨å®è·µæ•™ç¨‹åäºŒï¼šä½¿ç”¨ eBPF ç¨‹åº profile è¿›è¡Œæ€§èƒ½åˆ†æã€‘ è¿™ç¯‡æ–‡ç« ä¸­ï¼Œå…¶åˆ©ç”¨ Rust + eBPF æ„å»ºäº†ä¸€ä¸ª profiler å·¥å…·ï¼ŒæŠ±ç€å­¦ä¹ çš„ç›®çš„ï¼Œæˆ‘ä½¿ç”¨ C++ å®ç°äº†ç›¸åŒçš„åŠŸèƒ½ï¼Œå¹¶å°†æ‰€å­¦çŸ¥è¯†æ€»ç»“æˆæœ¬æ–‡ã€‚
perf_event_open æœºåˆ¶è§£æ perf åŸç†å›¾ï¼šhttps://plantegg.github.io/2021/05/16/Perf_IPC%E4%BB%A5%E5%8F%8ACPU%E5%88%A9%E7%94%A8%E7%8E%87/
perf_event_open æ˜¯ Linux å†…æ ¸æä¾›çš„æ€§èƒ½ç›‘æ§æ¥å£ï¼Œå…è®¸ç”¨æˆ·ç©ºé—´ç¨‹åºåˆ›å»ºæ€§èƒ½äº‹ä»¶è®¡æ•°å™¨ã€‚å½“ç”¨æˆ·æ€ç¨‹åºè°ƒç”¨ sys_perf_event_open ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œå†…æ ¸ä¼šåˆ›å»ºç›¸åº”çš„æ€§èƒ½ç›‘æ§å®ä¾‹ã€‚ä»¥ä¸‹æ˜¯åŸºæœ¬çš„ä½¿ç”¨æ–¹å¼ï¼š
#include <linux/perf_event.h> #include <sys/syscall.h> #include <unistd.h> int64_t perf_event_open(struct perf_event_attr* hw_event, pid_t pid, int cpu, int group_fd, unsigned long flags) { return syscall(SYS_perf_event_open, hw_event, pid, cpu, group_fd, flags); } ä»¥æ–‡ä»¶æè¿°ç¬¦ä¸ºä¸­å¿ƒçš„ç›‘æ§å•å…ƒ Linux éµå¾ª " ä¸€åˆ‡çš†æ–‡ä»¶ " çš„è®¾è®¡å“²å­¦ï¼Œperf_event_open ä¹Ÿä¸ä¾‹å¤–ã€‚æ¯æ¬¡è°ƒç”¨è¯¥å‡½æ•°ï¼Œå†…æ ¸éƒ½ä¼šåˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„æ€§èƒ½ç›‘æ§å®ä¾‹ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚
æ ¸å¿ƒæ¦‚å¿µï¼š
1 fd = 1 Eventï¼šæ¯ä¸ªæ–‡ä»¶æè¿°ç¬¦å¯¹åº”ä¸€ä¸ªå…·ä½“çš„ç›‘æ§ä»»åŠ¡ï¼Œä¾‹å¦‚ " ç›‘æ§ CPU 0 çš„æŒ‡ä»¤æ‰§è¡Œæ•° " äº‹ä»¶åˆ†ç»„ (Group)ï¼šå¤šä¸ªæ–‡ä»¶æè¿°ç¬¦å¯ä»¥ç»‘å®šåœ¨ä¸€èµ·å½¢æˆäº‹ä»¶ç»„ åˆ†ç»„çš„é‡è¦æ€§ï¼š å‡è®¾éœ€è¦è®¡ç®— " æ¯æ¡æŒ‡ä»¤çš„ç¼“å­˜æœªå‘½ä¸­ç‡ â€œï¼Œéœ€è¦åŒæ—¶ç›‘æ§ " æŒ‡ä»¤æ•° " å’Œ " ç¼“å­˜æœªå‘½ä¸­æ•° â€œã€‚å°†å®ƒä»¬æ”¾å…¥åŒä¸€äº‹ä»¶ç»„å¯ä»¥ç¡®ä¿ï¼š'><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2026-01-29T00:00:00+00:00"><meta property="article:modified_time" content="2026-01-29T00:00:00+00:00"><meta property="article:tag" content="Perf"><meta property="article:tag" content="Cpp"><meta property="article:tag" content="æ€§èƒ½åˆ†æ"><meta property="article:tag" content="ç³»ç»Ÿè°ƒç”¨"><meta property="article:tag" content="EBPF"><meta property="og:image" content="https://kerolt.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://kerolt.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="åˆ©ç”¨eBPFä¸perf_eventæ„å»ºä¸€ä¸ªprofilingå·¥å…·"><meta name=twitter:description content='å¼•è¨€
åœ¨æ€§èƒ½åˆ†æå’Œç³»ç»Ÿè°ƒä¼˜ä¸­ï¼Œäº†è§£åº”ç”¨ç¨‹åºåœ¨è¿è¡Œæ—¶çš„è°ƒç”¨æ ˆä¿¡æ¯è‡³å…³é‡è¦ã€‚åœ¨ ã€eBPF å…¥é—¨å®è·µæ•™ç¨‹åäºŒï¼šä½¿ç”¨ eBPF ç¨‹åº profile è¿›è¡Œæ€§èƒ½åˆ†æã€‘ è¿™ç¯‡æ–‡ç« ä¸­ï¼Œå…¶åˆ©ç”¨ Rust + eBPF æ„å»ºäº†ä¸€ä¸ª profiler å·¥å…·ï¼ŒæŠ±ç€å­¦ä¹ çš„ç›®çš„ï¼Œæˆ‘ä½¿ç”¨ C++ å®ç°äº†ç›¸åŒçš„åŠŸèƒ½ï¼Œå¹¶å°†æ‰€å­¦çŸ¥è¯†æ€»ç»“æˆæœ¬æ–‡ã€‚
perf_event_open æœºåˆ¶è§£æ


  
    
  



perf åŸç†å›¾ï¼šhttps://plantegg.github.io/2021/05/16/Perf_IPC%E4%BB%A5%E5%8F%8ACPU%E5%88%A9%E7%94%A8%E7%8E%87/

perf_event_open æ˜¯ Linux å†…æ ¸æä¾›çš„æ€§èƒ½ç›‘æ§æ¥å£ï¼Œå…è®¸ç”¨æˆ·ç©ºé—´ç¨‹åºåˆ›å»ºæ€§èƒ½äº‹ä»¶è®¡æ•°å™¨ã€‚å½“ç”¨æˆ·æ€ç¨‹åºè°ƒç”¨ sys_perf_event_open ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œå†…æ ¸ä¼šåˆ›å»ºç›¸åº”çš„æ€§èƒ½ç›‘æ§å®ä¾‹ã€‚ä»¥ä¸‹æ˜¯åŸºæœ¬çš„ä½¿ç”¨æ–¹å¼ï¼š
#include <linux/perf_event.h>
#include <sys/syscall.h>
#include <unistd.h>

int64_t perf_event_open(struct perf_event_attr* hw_event, pid_t pid, int cpu,
                     int group_fd, unsigned long flags) {
    return syscall(SYS_perf_event_open, hw_event, pid, cpu, group_fd, flags);
}
ä»¥æ–‡ä»¶æè¿°ç¬¦ä¸ºä¸­å¿ƒçš„ç›‘æ§å•å…ƒ
Linux éµå¾ª " ä¸€åˆ‡çš†æ–‡ä»¶ " çš„è®¾è®¡å“²å­¦ï¼Œperf_event_open ä¹Ÿä¸ä¾‹å¤–ã€‚æ¯æ¬¡è°ƒç”¨è¯¥å‡½æ•°ï¼Œå†…æ ¸éƒ½ä¼šåˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„æ€§èƒ½ç›‘æ§å®ä¾‹ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚
æ ¸å¿ƒæ¦‚å¿µï¼š

1 fd = 1 Eventï¼šæ¯ä¸ªæ–‡ä»¶æè¿°ç¬¦å¯¹åº”ä¸€ä¸ªå…·ä½“çš„ç›‘æ§ä»»åŠ¡ï¼Œä¾‹å¦‚ " ç›‘æ§ CPU 0 çš„æŒ‡ä»¤æ‰§è¡Œæ•° "
äº‹ä»¶åˆ†ç»„ (Group)ï¼šå¤šä¸ªæ–‡ä»¶æè¿°ç¬¦å¯ä»¥ç»‘å®šåœ¨ä¸€èµ·å½¢æˆäº‹ä»¶ç»„

åˆ†ç»„çš„é‡è¦æ€§ï¼š
å‡è®¾éœ€è¦è®¡ç®— " æ¯æ¡æŒ‡ä»¤çš„ç¼“å­˜æœªå‘½ä¸­ç‡ &ldquo;ï¼Œéœ€è¦åŒæ—¶ç›‘æ§ " æŒ‡ä»¤æ•° " å’Œ " ç¼“å­˜æœªå‘½ä¸­æ•° &ldquo;ã€‚å°†å®ƒä»¬æ”¾å…¥åŒä¸€äº‹ä»¶ç»„å¯ä»¥ç¡®ä¿ï¼š'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://kerolt.github.io/posts/"},{"@type":"ListItem","position":2,"name":"åˆ©ç”¨eBPFä¸perf_eventæ„å»ºä¸€ä¸ªprofilingå·¥å…·","item":"https://kerolt.github.io/posts/ebpf/%E5%88%A9%E7%94%A8ebpf%E4%B8%8Eperf_event%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AAprofiling%E5%B7%A5%E5%85%B7/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"åˆ©ç”¨eBPFä¸perf_eventæ„å»ºä¸€ä¸ªprofilingå·¥å…·","name":"åˆ©ç”¨eBPFä¸perf_eventæ„å»ºä¸€ä¸ªprofilingå·¥å…·","description":"å¼•è¨€ åœ¨æ€§èƒ½åˆ†æå’Œç³»ç»Ÿè°ƒä¼˜ä¸­ï¼Œäº†è§£åº”ç”¨ç¨‹åºåœ¨è¿è¡Œæ—¶çš„è°ƒç”¨æ ˆä¿¡æ¯è‡³å…³é‡è¦ã€‚åœ¨ ã€eBPF å…¥é—¨å®è·µæ•™ç¨‹åäºŒï¼šä½¿ç”¨ eBPF ç¨‹åº profile è¿›è¡Œæ€§èƒ½åˆ†æã€‘ è¿™ç¯‡æ–‡ç« ä¸­ï¼Œå…¶åˆ©ç”¨ Rust + eBPF æ„å»ºäº†ä¸€ä¸ª profiler å·¥å…·ï¼ŒæŠ±ç€å­¦ä¹ çš„ç›®çš„ï¼Œæˆ‘ä½¿ç”¨ C++ å®ç°äº†ç›¸åŒçš„åŠŸèƒ½ï¼Œå¹¶å°†æ‰€å­¦çŸ¥è¯†æ€»ç»“æˆæœ¬æ–‡ã€‚\nperf_event_open æœºåˆ¶è§£æ perf åŸç†å›¾ï¼šhttps://plantegg.github.io/2021/05/16/Perf_IPC%E4%BB%A5%E5%8F%8ACPU%E5%88%A9%E7%94%A8%E7%8E%87/\nperf_event_open æ˜¯ Linux å†…æ ¸æä¾›çš„æ€§èƒ½ç›‘æ§æ¥å£ï¼Œå…è®¸ç”¨æˆ·ç©ºé—´ç¨‹åºåˆ›å»ºæ€§èƒ½äº‹ä»¶è®¡æ•°å™¨ã€‚å½“ç”¨æˆ·æ€ç¨‹åºè°ƒç”¨ sys_perf_event_open ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œå†…æ ¸ä¼šåˆ›å»ºç›¸åº”çš„æ€§èƒ½ç›‘æ§å®ä¾‹ã€‚ä»¥ä¸‹æ˜¯åŸºæœ¬çš„ä½¿ç”¨æ–¹å¼ï¼š\n#include \u0026lt;linux/perf_event.h\u0026gt; #include \u0026lt;sys/syscall.h\u0026gt; #include \u0026lt;unistd.h\u0026gt; int64_t perf_event_open(struct perf_event_attr* hw_event, pid_t pid, int cpu, int group_fd, unsigned long flags) { return syscall(SYS_perf_event_open, hw_event, pid, cpu, group_fd, flags); } ä»¥æ–‡ä»¶æè¿°ç¬¦ä¸ºä¸­å¿ƒçš„ç›‘æ§å•å…ƒ Linux éµå¾ª \u0026quot; ä¸€åˆ‡çš†æ–‡ä»¶ \u0026quot; çš„è®¾è®¡å“²å­¦ï¼Œperf_event_open ä¹Ÿä¸ä¾‹å¤–ã€‚æ¯æ¬¡è°ƒç”¨è¯¥å‡½æ•°ï¼Œå†…æ ¸éƒ½ä¼šåˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„æ€§èƒ½ç›‘æ§å®ä¾‹ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚\næ ¸å¿ƒæ¦‚å¿µï¼š\n1 fd = 1 Eventï¼šæ¯ä¸ªæ–‡ä»¶æè¿°ç¬¦å¯¹åº”ä¸€ä¸ªå…·ä½“çš„ç›‘æ§ä»»åŠ¡ï¼Œä¾‹å¦‚ \u0026quot; ç›‘æ§ CPU 0 çš„æŒ‡ä»¤æ‰§è¡Œæ•° \u0026quot; äº‹ä»¶åˆ†ç»„ (Group)ï¼šå¤šä¸ªæ–‡ä»¶æè¿°ç¬¦å¯ä»¥ç»‘å®šåœ¨ä¸€èµ·å½¢æˆäº‹ä»¶ç»„ åˆ†ç»„çš„é‡è¦æ€§ï¼š å‡è®¾éœ€è¦è®¡ç®— \u0026quot; æ¯æ¡æŒ‡ä»¤çš„ç¼“å­˜æœªå‘½ä¸­ç‡ \u0026ldquo;ï¼Œéœ€è¦åŒæ—¶ç›‘æ§ \u0026quot; æŒ‡ä»¤æ•° \u0026quot; å’Œ \u0026quot; ç¼“å­˜æœªå‘½ä¸­æ•° \u0026ldquo;ã€‚å°†å®ƒä»¬æ”¾å…¥åŒä¸€äº‹ä»¶ç»„å¯ä»¥ç¡®ä¿ï¼š\n","keywords":["perf","cpp","æ€§èƒ½åˆ†æ","ç³»ç»Ÿè°ƒç”¨","eBPF"],"articleBody":"å¼•è¨€ åœ¨æ€§èƒ½åˆ†æå’Œç³»ç»Ÿè°ƒä¼˜ä¸­ï¼Œäº†è§£åº”ç”¨ç¨‹åºåœ¨è¿è¡Œæ—¶çš„è°ƒç”¨æ ˆä¿¡æ¯è‡³å…³é‡è¦ã€‚åœ¨ ã€eBPF å…¥é—¨å®è·µæ•™ç¨‹åäºŒï¼šä½¿ç”¨ eBPF ç¨‹åº profile è¿›è¡Œæ€§èƒ½åˆ†æã€‘ è¿™ç¯‡æ–‡ç« ä¸­ï¼Œå…¶åˆ©ç”¨ Rust + eBPF æ„å»ºäº†ä¸€ä¸ª profiler å·¥å…·ï¼ŒæŠ±ç€å­¦ä¹ çš„ç›®çš„ï¼Œæˆ‘ä½¿ç”¨ C++ å®ç°äº†ç›¸åŒçš„åŠŸèƒ½ï¼Œå¹¶å°†æ‰€å­¦çŸ¥è¯†æ€»ç»“æˆæœ¬æ–‡ã€‚\nperf_event_open æœºåˆ¶è§£æ perf åŸç†å›¾ï¼šhttps://plantegg.github.io/2021/05/16/Perf_IPC%E4%BB%A5%E5%8F%8ACPU%E5%88%A9%E7%94%A8%E7%8E%87/\nperf_event_open æ˜¯ Linux å†…æ ¸æä¾›çš„æ€§èƒ½ç›‘æ§æ¥å£ï¼Œå…è®¸ç”¨æˆ·ç©ºé—´ç¨‹åºåˆ›å»ºæ€§èƒ½äº‹ä»¶è®¡æ•°å™¨ã€‚å½“ç”¨æˆ·æ€ç¨‹åºè°ƒç”¨ sys_perf_event_open ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œå†…æ ¸ä¼šåˆ›å»ºç›¸åº”çš„æ€§èƒ½ç›‘æ§å®ä¾‹ã€‚ä»¥ä¸‹æ˜¯åŸºæœ¬çš„ä½¿ç”¨æ–¹å¼ï¼š\n#include #include #include int64_t perf_event_open(struct perf_event_attr* hw_event, pid_t pid, int cpu, int group_fd, unsigned long flags) { return syscall(SYS_perf_event_open, hw_event, pid, cpu, group_fd, flags); } ä»¥æ–‡ä»¶æè¿°ç¬¦ä¸ºä¸­å¿ƒçš„ç›‘æ§å•å…ƒ Linux éµå¾ª \" ä¸€åˆ‡çš†æ–‡ä»¶ \" çš„è®¾è®¡å“²å­¦ï¼Œperf_event_open ä¹Ÿä¸ä¾‹å¤–ã€‚æ¯æ¬¡è°ƒç”¨è¯¥å‡½æ•°ï¼Œå†…æ ¸éƒ½ä¼šåˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„æ€§èƒ½ç›‘æ§å®ä¾‹ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚\næ ¸å¿ƒæ¦‚å¿µï¼š\n1 fd = 1 Eventï¼šæ¯ä¸ªæ–‡ä»¶æè¿°ç¬¦å¯¹åº”ä¸€ä¸ªå…·ä½“çš„ç›‘æ§ä»»åŠ¡ï¼Œä¾‹å¦‚ \" ç›‘æ§ CPU 0 çš„æŒ‡ä»¤æ‰§è¡Œæ•° \" äº‹ä»¶åˆ†ç»„ (Group)ï¼šå¤šä¸ªæ–‡ä»¶æè¿°ç¬¦å¯ä»¥ç»‘å®šåœ¨ä¸€èµ·å½¢æˆäº‹ä»¶ç»„ åˆ†ç»„çš„é‡è¦æ€§ï¼š å‡è®¾éœ€è¦è®¡ç®— \" æ¯æ¡æŒ‡ä»¤çš„ç¼“å­˜æœªå‘½ä¸­ç‡ â€œï¼Œéœ€è¦åŒæ—¶ç›‘æ§ \" æŒ‡ä»¤æ•° \" å’Œ \" ç¼“å­˜æœªå‘½ä¸­æ•° â€œã€‚å°†å®ƒä»¬æ”¾å…¥åŒä¸€äº‹ä»¶ç»„å¯ä»¥ç¡®ä¿ï¼š\nä¸¤ä¸ªäº‹ä»¶åŒæ—¶å¼€å§‹ã€åŒæ—¶ç»“æŸè®¡æ•° ç¡¬ä»¶è®¡æ•°å™¨åŒæ­¥é‡‡æ ·ï¼Œä¿è¯è®¡ç®—æ¯”ä¾‹çš„å‡†ç¡®æ€§ å‡å°‘ç³»ç»Ÿè°ƒç”¨å¼€é”€ äº‹ä»¶çŠ¶æ€æ§åˆ¶ï¼šioctl ä¸ prctl åˆ›å»ºäº‹ä»¶åï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ§åˆ¶å…¶è¿è¡ŒçŠ¶æ€ï¼š\nioctl (Input/Output Control)ï¼šé’ˆå¯¹å•ä¸ªæ–‡ä»¶æè¿°ç¬¦çš„æ“ä½œ ioctl(fd, PERF_EVENT_IOC_ENABLE)ï¼šå¯ç”¨äº‹ä»¶ç›‘æ§ ioctl(fd, PERF_EVENT_IOC_DISABLE)ï¼šæš‚åœäº‹ä»¶ç›‘æ§ prctl (Process Control)ï¼šé’ˆå¯¹å½“å‰è¿›ç¨‹æ‰€æœ‰äº‹ä»¶çš„æ‰¹é‡æ“ä½œ é€‚ç”¨äºç®¡ç†å¤šä¸ªç›‘æ§äº‹ä»¶çš„åœºæ™¯ï¼Œé¿å…é¢‘ç¹çš„ ioctl è°ƒç”¨ è®¾è®¡ä¼˜åŠ¿ï¼šäº‹ä»¶è¢«ç¦ç”¨æ—¶ï¼Œè®¡æ•°å™¨æš‚åœä½†æ•°æ®ä¿ç•™ã€‚è¿™ç§è®¾è®¡å…è®¸åœ¨ç¨‹åºç‰¹å®šé˜¶æ®µï¼ˆå¦‚å…³é”®ç®—æ³•æ‰§è¡ŒæœŸé—´ï¼‰ç²¾ç¡®å¼€å¯ç›‘æ§ï¼Œå®ç°ç»†ç²’åº¦çš„æ€§èƒ½åˆ†æã€‚\nä¸¤ç§å·¥ä½œæ¨¡å¼ï¼šè®¡æ•° vs é‡‡æ · perf_event æ”¯æŒä¸¤ç§åŸºæœ¬å·¥ä½œæ¨¡å¼ï¼Œæ»¡è¶³ä¸åŒçš„æ€§èƒ½åˆ†æéœ€æ±‚ï¼š\nè®¡æ•°æ¨¡å¼ (Counting Mode) å†…æ ¸ç»´æŠ¤ä¸€ä¸ªç®€å•çš„è®¡æ•°å™¨ï¼ˆé€šå¸¸æ˜¯ u64 ç±»å‹æ•´æ•°ï¼‰ã€‚è®¡æ•°äº‹ä»¶çš„ç»“æœé€šè¿‡ read ç³»ç»Ÿè°ƒç”¨æ”¶é›†ã€‚\nç‰¹ç‚¹ï¼š\nä½å¼€é”€ï¼šä»…ç»´æŠ¤è®¡æ•°å™¨ï¼Œä¸è®°å½•è¯¦ç»†ä¸Šä¸‹æ–‡ ç»“æœç®€å•ï¼šè¿”å›äº‹ä»¶å‘ç”Ÿçš„æ€»æ¬¡æ•° åº”ç”¨åœºæ™¯ï¼šåŸºå‡†æµ‹è¯•ã€æ€§èƒ½ç»Ÿè®¡ ä¾‹å¦‚ï¼šâ€ è¿™æ®µä»£ç æ‰§è¡Œæ¶ˆè€—äº†å¤šå°‘ CPU å‘¨æœŸ \" \" å‡½æ•°è°ƒç”¨å‘ç”Ÿäº†å¤šå°‘æ¬¡ç¼“å­˜æœªå‘½ä¸­ \" é‡‡æ ·æ¨¡å¼ (Sampling Mode) è®¾ç½®é‡‡æ ·é˜ˆå€¼ï¼ˆå¦‚æ¯ 1000 æ¬¡ç¼“å­˜æœªå‘½ä¸­é‡‡æ ·ä¸€æ¬¡ï¼‰ã€‚å½“äº‹ä»¶è®¡æ•°å™¨æº¢å‡ºæ—¶ï¼Œå†…æ ¸ä¼šæ•è·å½“å‰çš„æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ˆåŒ…æ‹¬æŒ‡ä»¤æŒ‡é’ˆã€è¿›ç¨‹ IDã€è°ƒç”¨æ ˆç­‰ï¼‰ã€‚\nå·¥ä½œåŸç†ï¼š\nå†…æ ¸åˆ†é…ç¯å½¢ç¼“å†²åŒºç”¨äºå­˜å‚¨é‡‡æ ·æ•°æ® é‡‡æ ·æ•°æ®é€šè¿‡å†…å­˜æ˜ å°„ (mmap) æš´éœ²ç»™ç”¨æˆ·ç©ºé—´ ç”¨æˆ·ç¨‹åºä»ç¼“å†²åŒº \" æ¶ˆè´¹ \" é‡‡æ ·æ•°æ® ä¼˜åŠ¿ï¼š\nè®°å½•è¯¦ç»†çš„æ‰§è¡Œä¸Šä¸‹æ–‡ä¿¡æ¯ æ”¯æŒè°ƒç”¨æ ˆå›æº¯ åº”ç”¨åœºæ™¯ï¼šæ€§èƒ½çƒ­ç‚¹åˆ†æã€ç«ç„°å›¾ç”Ÿæˆã€å‡½æ•°è°ƒç”¨é¢‘ç‡ç»Ÿè®¡ ç»“åˆ eBPF å®ç° profiling ä¼ ç»Ÿ perf å·¥å…·è™½ç„¶åŠŸèƒ½å¼ºå¤§ï¼Œä½†åœ¨æŸäº›åœºæ™¯ä¸‹å­˜åœ¨å±€é™æ€§ã€‚eBPF æä¾›äº†æ›´çµæ´»ã€æ›´ä½å¼€é”€çš„æ€§èƒ½ç›‘æ§æ–¹æ¡ˆã€‚é€šè¿‡å°† eBPF ç¨‹åºæŒ‚è½½åˆ° perf_event ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å†…æ ¸ç©ºé—´ç›´æ¥å¤„ç†æ€§èƒ½äº‹ä»¶ï¼Œå®ç°é«˜æ•ˆçš„è°ƒç”¨æ ˆé‡‡é›†ã€‚\næ ¸å¿ƒæ€è·¯ï¼š\nåˆ©ç”¨ perf_event è§¦å‘é‡‡æ ·äº‹ä»¶ eBPF ç¨‹åºåœ¨å†…æ ¸ä¸­æ•è·äº‹ä»¶å¹¶é‡‡é›†è°ƒç”¨æ ˆä¿¡æ¯ é€šè¿‡ Ring Buffer é«˜æ•ˆä¼ è¾“æ•°æ®åˆ°ç”¨æˆ·ç©ºé—´ ç”¨æˆ·ç©ºé—´ç¨‹åºè§£æå¹¶å±•ç¤ºç»“æœ #include \"vmlinux.h\" #include char LICENSE[] SEC(\"license\") = \"Dual BSD/GPL\"; #ifndef TASK_COMM_LEN #define TASK_COMM_LEN 16 #endif #ifndef MAX_STACK_DEPTH #define MAX_STACK_DEPTH 128 #endif typedef __u64 stack_trace_t[MAX_STACK_DEPTH]; struct stack_trace_event { __u32 pid; __u32 cpu_id; __u64 timestamp; char comm[TASK_COMM_LEN]; __s32 kstack_sz; __s32 ustack_sz; stack_trace_t kstack; stack_trace_t ustack; }; struct { __uint(type, BPF_MAP_TYPE_RINGBUF); __uint(max_entries, 256 * 1024); } events SEC(\".maps\"); SEC(\"perf_event\") int profile(void* ctx) { struct stack_trace_event* event = bpf_ringbuf_reserve(\u0026events, sizeof(struct stack_trace_event), 0); if (!event) { return 1; } int pid = bpf_get_current_pid_tgid() \u003e\u003e 32; int cpu_id = bpf_get_smp_processor_id(); event-\u003epid = pid; event-\u003ecpu_id = cpu_id; event-\u003etimestamp = bpf_ktime_get_ns(); // è·å–å½“å‰è¿›ç¨‹å if (bpf_get_current_comm(event-\u003ecomm, sizeof(event-\u003ecomm))) { event-\u003ecomm[0] = 0; } // è·å–å†…æ ¸æ ˆã€ç”¨æˆ·æ ˆä¿¡æ¯ event-\u003ekstack_sz = bpf_get_stack(ctx, event-\u003ekstack, sizeof(event-\u003ekstack), 0); event-\u003eustack_sz = bpf_get_stack( ctx, event-\u003eustack, sizeof(event-\u003eustack), BPF_F_USER_STACK); bpf_ringbuf_submit(event, 0); return 0; } eBPF ç¨‹åºæ‰§è¡Œæµç¨‹ï¼š\nç¨‹åºæŒ‚è½½åˆ° perf_eventï¼Œéšæ€§èƒ½è®¡æ•°å™¨ï¼ˆCPU å‘¨æœŸã€æŒ‡ä»¤æ•°ç­‰ï¼‰æˆ–å®šæ—¶å™¨è§¦å‘ æ¯æ¬¡è§¦å‘æ—¶ï¼ŒeBPF ç¨‹åºåœ¨å†…æ ¸ç©ºé—´æ‰§è¡Œä¸€æ¬¡ é‡‡é›†å…³é”®æ€§èƒ½æ•°æ®å¹¶é€šè¿‡ Ring Buffer ä¼ è¾“åˆ°ç”¨æˆ·ç©ºé—´ é‡‡é›†çš„å…³é”®ä¿¡æ¯ï¼š\nè¿›ç¨‹æ ‡è¯†ï¼šå½“å‰è¿è¡Œè¿›ç¨‹çš„ PID CPU ä¿¡æ¯ï¼šæ‰§è¡Œä»»åŠ¡çš„ CPU æ ¸å¿ƒç¼–å· æ—¶é—´æˆ³ï¼šäº‹ä»¶å‘ç”Ÿçš„ç²¾ç¡®æ—¶é—´ï¼ˆçº³ç§’çº§ï¼‰ è¿›ç¨‹åï¼šå¯æ‰§è¡Œæ–‡ä»¶åç§° æ ˆå›æº¯ï¼šå†…æ ¸æ ˆå’Œç”¨æˆ·æ ˆçš„å®Œæ•´è°ƒç”¨é“¾ æ•°æ®ç»“æ„è®¾è®¡ï¼š\nstruct stack_trace_event { __u32 pid; // è¿›ç¨‹ ID __u32 cpu_id; // CPU æ ¸å¿ƒç¼–å· __u64 timestamp; // æ—¶é—´æˆ³ï¼ˆçº³ç§’ï¼‰ char comm[TASK_COMM_LEN]; // è¿›ç¨‹å __s32 kstack_sz; // å†…æ ¸æ ˆå¤§å° __s32 ustack_sz; // ç”¨æˆ·æ ˆå¤§å° stack_trace_t kstack; // å†…æ ¸æ ˆåœ°å€æ•°ç»„ stack_trace_t ustack; // ç”¨æˆ·æ ˆåœ°å€æ•°ç»„ }; åº”ç”¨ä»·å€¼ï¼š é‡‡é›†çš„æ•°æ®ç»è¿‡å¤„ç†åï¼Œå¯ä»¥ç”Ÿæˆ ç«ç„°å›¾ (Flame Graphs)ï¼Œç›´è§‚å±•ç¤ºï¼š\nCPU æ¶ˆè€—åˆ†å¸ƒï¼šå“ªä¸ªè¿›ç¨‹/å‡½æ•°å ç”¨æœ€å¤š CPU æ—¶é—´ è°ƒç”¨é“¾åˆ†æï¼šçƒ­ç‚¹å‡½æ•°çš„å®Œæ•´è°ƒç”¨è·¯å¾„ å†…æ ¸/ç”¨æˆ·æ€æ¯”ä¾‹ï¼šç³»ç»Ÿè°ƒç”¨ä¸ä¸šåŠ¡é€»è¾‘çš„æ—¶é—´åˆ†é… æ€§èƒ½ç“¶é¢ˆå®šä½ï¼šå¿«é€Ÿè¯†åˆ«æ€§èƒ½çƒ­ç‚¹å’Œä¼˜åŒ–æœºä¼š è§£æé‡‡é›†çš„æ ˆå›æº¯ä¿¡æ¯ API è®¾è®¡ å®šä¹‰å†…æ ¸è¿”å›çš„ event ç»“æ„ä½“ï¼š\nstruct StacktraceEvent { uint32_t pid; uint32_t cpu_id; uint64_t timestamp; char comm[TASK_COMM_LEN]; int32_t kstack_size; int32_t ustack_size; uint64_t kstack[MAX_STACK_DEPTH]; uint64_t ustack[MAX_STACK_DEPTH]; }; å®šä¹‰äº‹ä»¶å¤„ç†å™¨ï¼š\nenum class OutputFormat : uint8_t { Standard, FoldExtend }; class EventHandler { public: EventHandler(OutputFormat fmt) : format(fmt) { boot_time_ns = get_boot_time_ns(); } ~EventHandler() = default; auto handle(const uint8_t* data, size_t len) -\u003e int; void show_stack_trace(const uint64_t* stack, uint32_t size, uint32_t pid); private: blaze::Symbolizer symbolizer_; OutputFormat format; uint64_t boot_time_ns; static auto get_boot_time_ns() -\u003e uint64_t; // ç¬¦å·åŒ–å †æ ˆå¹¶è¿”å›å­—ç¬¦ä¸²å‘é‡ auto symbolize_stack_to_vec(const uint64_t* stack, uint32_t stack_sz, uint32_t pid) -\u003e std::vector\u003cstd::string\u003e; void handle_standard(const StacktraceEvent* event); void handle_fold_extend(const StacktraceEvent* event); }; ç¬¦å·åŒ–è§£æï¼šå°†åœ°å€è½¬æ¢ä¸ºå‡½æ•°å eBPF é‡‡é›†çš„è°ƒç”¨æ ˆä¿¡æ¯æ˜¯å†…å­˜åœ°å€æ•°ç»„ï¼Œéœ€è¦è½¬æ¢ä¸ºå¯è¯»çš„å‡½æ•°åå’Œæºä»£ç ä½ç½®ã€‚è¿™é‡Œä½¿ç”¨ blazesym åº“è¿›è¡Œç¬¦å·åŒ–è§£æï¼Œå¹¶å°è£…ä¸ºæ˜“ç”¨çš„ C++ æ¥å£ã€‚\nç¬¦å·åŒ–çš„é‡è¦æ€§ï¼š\nåŸå§‹åœ°å€ï¼ˆå¦‚ 0xffffffff81000000ï¼‰å¯¹äººç±»ä¸å‹å¥½ éœ€è¦è½¬æ¢ä¸ºå‡½æ•°åï¼ˆå¦‚ do_syscall_64ï¼‰å’Œæºä»£ç ä½ç½® æ”¯æŒå†…æ ¸ç¬¦å·å’Œç”¨æˆ·ç©ºé—´ç¬¦å·çš„å·®å¼‚åŒ–å¤„ç† #ifndef BLAZE_H_ #define BLAZE_H_ #include #include #include #include #include \"utils.h\" namespace blaze { struct CodeInfo { const blaze_symbolize_code_info* info_; CodeInfo(const blaze_symbolize_code_info* info) : info_(info) {} }; struct Syms { const blaze_syms* syms_; Syms(const blaze_syms* syms) : syms_(syms) {} ~Syms() { if (syms_) { blaze_syms_free(syms_); } } // ç¦æ­¢æ‹·è´ï¼Œé˜²æ­¢åŒé‡é‡Šæ”¾ Syms(const Syms\u0026) = delete; auto operator=(const Syms\u0026) -\u003e Syms\u0026 = delete; }; // ç¬¦å·æº using Source = std::variant\u003cblaze_symbolize_src_process, blaze_symbolize_src_kernel\u003e; struct Input { const uint64_t* addrs_; size_t cnt_; }; struct Symbolizer { blaze_symbolizer* symbolizer_; Symbolizer() { symbolizer_ = blaze_symbolizer_new(); } ~Symbolizer() { blaze_symbolizer_free(symbolizer_); } [[nodiscard]] auto symbolize(Source src, const Input\u0026 input) const -\u003e Result\u003cSyms\u003e { if (!input.addrs_ || input.cnt_ == 0) { return Err\u003c\u003e{\"Empty input addresses\"}; } const blaze_syms* syms = nullptr; std::visit( Overloaded{ [\u0026](blaze_symbolize_src_kernel\u0026 kern_src) -\u003e void { syms = blaze_symbolize_kernel_abs_addrs( symbolizer_, \u0026kern_src, input.addrs_, input.cnt_); }, [\u0026](blaze_symbolize_src_process\u0026 proc_src) -\u003e void { syms = blaze_symbolize_process_abs_addrs( symbolizer_, \u0026proc_src, input.addrs_, input.cnt_); }, }, src); return syms ? Result\u003cSyms\u003e{syms} : Err\u003c\u003e{std::format(\"Symbolization failed, errno is: {}\", static_cast\u003cint16_t\u003e(blaze_err_last()))}; } }; inline auto get_symbolize_source(uint32_t pid) -\u003e blaze::Source { if (pid == 0) { blaze_symbolize_src_kernel src{ .type_size = sizeof(src), }; return blaze::Source{src}; } else { blaze_symbolize_src_process src{ .type_size = sizeof(src), .pid = pid, }; return blaze::Source{src}; } } } // namespace blaze #endif /* BLAZE_H_ */ å…¶ä¸­çš„ Resultã€Errã€Overloaded åˆ†åˆ«å€Ÿé‰´äº† Rust ä¸­çš„ Resultã€Err å’Œ matchã€‚\nSymbolizer::symbolize ç”¨äºæŠŠç»å¯¹åœ°å€æ•°ç»„ç¬¦å·åŒ–ï¼ˆè½¬æˆç¬¦å·/è°ƒè¯•ä¿¡æ¯ï¼‰ï¼š\nå¦‚æœÂ input.addrs_Â ä¸º null æˆ–Â input.cnt_ == 0ï¼Œè¿”å›é”™è¯¯Â Err\u003c\u003e{\"Empty input addresses\"}ã€‚ æ ¹æ®å‚æ•°Â srcï¼ˆSourceÂ æ˜¯Â blaze_symbolize_src_processÂ æˆ–Â blaze_symbolize_src_kernelÂ çš„Â std::variantï¼‰è°ƒç”¨ä¸åŒçš„ç¬¦å·åŒ–æ¥å£ï¼š å†…æ ¸æºæ—¶è°ƒç”¨Â blaze_symbolize_kernel_abs_addrs(symbolizer_, \u0026kern_src, input.addrs_, input.cnt_)ï¼› è¿›ç¨‹æºæ—¶è°ƒç”¨Â blaze_symbolize_process_abs_addrs(symbolizer_, \u0026proc_src, input.addrs_, input.cnt_)ã€‚ ä½¿ç”¨Â std::visitÂ +Â OverloadedÂ é€‰æ‹©åˆ†æ”¯ã€‚ ç»“æœå¤„ç†ï¼šæŠŠè¿”å›çš„Â const blaze_syms* symsÂ å°è£…è¿›Â Symsï¼ˆRAIIï¼Œææ„æ—¶ä¼šè°ƒç”¨Â blaze_syms_freeï¼‰ã€‚è‹¥Â symsÂ éç©ºåˆ™è¿”å›Â Result{syms}ï¼›å¦åˆ™è¿”å›å¸¦æœ‰Â blaze_err_last()ï¼ˆè½¬æ¢ä¸ºæ•´æ•°ï¼‰çš„é”™è¯¯ä¿¡æ¯ã€‚ äº‹ä»¶å¤„ç† EventHandler::handleÂ æ¥æ”¶çš„æ˜¯ä¸€å—â€œåŸå§‹äºŒè¿›åˆ¶ç¼“å†²åŒºâ€ï¼ˆraw bytesï¼‰è€Œä¸æ˜¯å·²ç»è§£æå¥½çš„ç»“æ„ä½“ï¼Œæ‰€ä»¥ç”¨Â const uint8_t* data, size_t lenÂ æ›´é€šç”¨ã€å®‰å…¨ï¼Œå¹¶ä¸”å…è®¸åœ¨ç”¨æˆ·æ€ä» ring/payloadã€socket æˆ– perf buffer ç­‰æ¥æºç›´æ¥è¯»å–æ•°æ®å¹¶æ£€æŸ¥é•¿åº¦åå†è§£æï¼ˆåœ¨è¿™ä¸ªé¡¹ç›®ä¸­ï¼Œæ•°æ®ä» ringbuf ä¸­è·å–ï¼‰ã€‚\nauto EventHandler::handle(const uint8_t* data, size_t len) -\u003e int { if (len != sizeof(StacktraceEvent)) { std::println(\"Data length mismatch: expected {}, got {}\", sizeof(StacktraceEvent), len); return 1; } const auto* const event = reinterpret_cast\u003cconst StacktraceEvent*\u003e(data); if (event-\u003ekstack_size \u003c= 0 \u0026\u0026 event-\u003eustack_size \u003c= 0) { return 1; } if (format == OutputFormat::Standard) { handle_standard(event); } else { handle_fold_extend(event); } return 0; } æ ‡å‡†è¾“å‡ºæ ¼å¼ï¼šå¯è¯»çš„é€å¸§å±•ç¤º handle_standard æ–¹æ³•ç”Ÿæˆäººç±»å¯è¯»çš„è°ƒç”¨æ ˆè¾“å‡ºï¼ŒåŒ…å«å®Œæ•´çš„æ—¶é—´æˆ³ã€è¿›ç¨‹ä¿¡æ¯å’Œæºä»£ç ä½ç½®ã€‚è¿™ç§æ ¼å¼é€‚åˆç›´æ¥æŸ¥çœ‹å’Œåˆ†æï¼š\nstatic void print_frame(const char* name, Option\u003cAddrInfo\u003e addr_info, const blaze_symbolize_code_info* code_info) { std::string code_str; if (code_info != nullptr) { // path if ((code_info-\u003edir != nullptr) \u0026\u0026 (code_info-\u003efile != nullptr)) { code_str = std::format(\" {}/{})\", code_info-\u003edir, code_info-\u003efile); } else if (code_info-\u003efile != nullptr) { code_str = code_info-\u003efile; } // line and column if (code_info-\u003eline \u003e 0) { code_str += std::format(\":{}\", code_info-\u003eline); if (code_info-\u003ecolumn \u003e 0) { code_str += std::format(\":{}\", code_info-\u003ecolumn); } } } if (addr_info.has_value()) { auto [input_addr, addr, offset] = *addr_info; std::println(\"0x{:0\u003e{}}: {} @ {:#x} + {:#x}{}\", input_addr, ADDR_WIDTH, (name != nullptr) ? name : \"\", addr, offset, code_str); } else { std::println(\"{:\u003e{}} {}{} [inlined]\", \"\", ADDR_WIDTH, name, code_str); } } void EventHandler::show_stack_trace(const uint64_t* stack, uint32_t size, uint32_t pid) { blaze::Source src = blaze::get_symbolize_source(pid); size_t count = static_cast\u003csize_t\u003e(size) / sizeof(uint64_t); // æ ˆå¸§æ•°é‡ auto result = symbolizer_.symbolize( src, blaze::Input{.addrs_ = stack, .cnt_ = count}); if (!result) { std::println(stderr, \" Failed to symbolize stack trace. err: {}\", result.error()); return; } const auto* syms = result-\u003esyms_; for (size_t i = 0; i \u003c count; ++i) { if (i \u003c syms-\u003ecnt \u0026\u0026 (syms-\u003esyms[i].name != nullptr)) { print_frame( syms-\u003esyms[i].name, Option\u003cAddrInfo\u003e(std::make_tuple( stack[i], syms-\u003esyms[i].addr, syms-\u003esyms[i].offset)), \u0026syms-\u003esyms[i].code_info); // æ‰“å°å†…è”å‡½æ•°ä¿¡æ¯ for (size_t j = 0; j \u003c syms-\u003esyms[i].inlined_cnt; ++j) { print_frame(syms-\u003esyms[i].inlined[j].name, std::nullopt, \u0026syms-\u003esyms[i].inlined[j].code_info); } } else { std::println(\"{:\u003e0{}}: \", stack[i], ADDR_WIDTH); } } } void EventHandler::handle_standard(const StacktraceEvent* event) { uint64_t unix_ns = event-\u003etimestamp + boot_time_ns; std::println(\"[{}.{:09} COMM: {} (pid={}) @ CPU {}]\", unix_ns / 1'000'000'000, unix_ns % 1'000'000'000, event-\u003ecomm, event-\u003epid, event-\u003ecpu_id); // æ‰“å°å†…æ ¸æ ˆ if (event-\u003ekstack_size \u003e 0) { std::println(\"Kernel:\"); show_stack_trace(event-\u003ekstack, event-\u003ekstack_size, 0); } else { std::println(\"Kernel: \"); } // æ‰“å°ç”¨æˆ·æ ˆ if (event-\u003eustack_size \u003e 0) { std::println(\"Userspace:\"); show_stack_trace(event-\u003eustack, event-\u003eustack_size, event-\u003epid); } else { std::println(\"Userspace: \"); } std::println(); } ç«ç„°å›¾æ ¼å¼ï¼šæœºå™¨å¯è¯»çš„æ•°æ®è¾“å‡º handle_fold_extend ç”ŸæˆæŠ˜å è¡Œï¼ˆcomm-pid;frame;... 1ï¼‰ï¼Œç”¨äºç”Ÿæˆç«ç„°å›¾ï¼ˆFlameGraphï¼‰ã€‚handle_fold_extendÂ å¯¹æ¯ä¸ªæ ˆç»“æœåšÂ reverseï¼ŒæŠŠæ ˆä»â€œæ ¹â€ï¼ˆç¨‹åºå…¥å£ï¼‰åˆ°â€œå¶â€ï¼ˆå½“å‰å¸§ï¼‰æ’åˆ—ï¼Œç¬¦åˆç«ç„°å›¾æœŸæœ›çš„çˆ¶åˆ°å­é¡ºåºã€‚\nauto EventHandler::symbolize_stack_to_vec(const uint64_t* stack, uint32_t stack_sz, uint32_t pid) -\u003e std::vector\u003cstd::string\u003e { if (stack_sz \u003c= 0) { return {}; } blaze::Source src = blaze::get_symbolize_source(pid); size_t count = stack_sz / sizeof(uint64_t); auto result = symbolizer_.symbolize( src, blaze::Input{.addrs_ = stack, .cnt_ = count}); if (!result) { return {}; } const auto* syms = result-\u003esyms_; std::vector\u003cstd::string\u003e vec; if (syms == nullptr) { for (size_t i = 0; i \u003c count; ++i) { vec.push_back(std::format(\"0x{:x}\", stack[i])); } return vec; } for (size_t i = 0; i \u003c syms-\u003ecnt; ++i) { if (syms-\u003esyms[i].name != nullptr) { vec.emplace_back(syms-\u003esyms[i].name); } else { vec.push_back(std::format(\"0x{:x}\", stack[i])); } } return vec; } void EventHandler::handle_fold_extend(const StacktraceEvent* event) { std::vector\u003cstd::string\u003e stack_frames; // ä¸ºäº†è®©ç«ç„°å›¾èƒ½å¤ŸæŒ‰è¿›ç¨‹èšåˆï¼Œå°† \"comm-pid\" ä½œä¸ºæ ˆåº• stack_frames.push_back(std::format(\"{}-{}\", event-\u003ecomm, event-\u003epid)); // å¤„ç†ç”¨æˆ·æ€ if (event-\u003eustack_size \u003e 0) { auto user_frames = symbolize_stack_to_vec( event-\u003eustack, event-\u003eustack_size, event-\u003epid); for (const auto\u0026 frame : user_frames | std::views::reverse) { stack_frames.push_back(frame); } } // å¤„ç†å†…æ ¸æ€ if (event-\u003ekstack_size \u003e 0) { auto kern_frames = symbolize_stack_to_vec(event-\u003ekstack, event-\u003ekstack_size, 0); for (const auto\u0026 frame : kern_frames | std::views::reverse) { stack_frames.push_back(frame + \"_[k]\"); } } auto temp = stack_frames | std::views::join_with(';'); // è¾“å‡ºæ ¼å¼ï¼šstack;frames 1 // FlameGraph å·¥å…·æœŸæœ›æ¯è¡Œä»¥ç©ºæ ¼å’Œæ•°å­—ç»“å°¾ std::println(\"{} 1\", temp | std::ranges::to\u003cstd::string\u003e()); } æµç¨‹å›¾ flowchart TD A[eBPF ç¨‹åºï¼ˆå†…æ ¸ï¼‰ é‡‡é›† stacktrace ] --\u003e B[Userspace reader æ¥æ”¶ StacktraceEvent] B --\u003e C[EventHandler::handle æ ¡éªŒ \u0026 é€‰æ‹©è¾“å‡ºæ ¼å¼] C --\u003e D{æœ‰ ustack?} C --\u003e E{æœ‰ kstack?} D -- yes --\u003e U1[\"æ„é€  blaze::Source (process) æ„é€  blaze::Input(addrs,cnt)\"] E -- yes --\u003e K1[\"æ„é€  blaze::Source (kernel) æ„é€  blaze::Input(addrs,cnt)\"] U1 --\u003e S1[\"Symbolizer::symbolize (std::visit -\u003e process API)\"] K1 --\u003e S2[\"Symbolizer::symbolize (std::visit -\u003e kernel API)\"] S1 --\u003e F{symbolize æˆåŠŸ?} S2 --\u003e F F -- yes --\u003e G[è¿”å› Symsï¼ˆRAIIï¼‰] F -- no --\u003e H[\"è¿”å› Err è®°å½• blaze_err_last() -\u003e fallback: æ‰“å°åŸå§‹åœ°å€\"] G --\u003e P1[show_stack_trace é€å¸§æ‰“å°ï¼ˆå«å†…è”ï¼‰] G --\u003e P2[symbolize_stack_to_vec ç”ŸæˆæŠ˜å å¸§å‘é‡] P2 --\u003e M[ç»„è£…æŠ˜å è¡Œ -\u003e è¾“å‡ºç»™ FlameGraph] P1 --\u003e O[æ ‡å‡†å¯è¯»è¾“å‡º] H --\u003e O2[æ‰“å°åŸå§‹åœ°å€ / è®°å½•é”™è¯¯æ—¥å¿—] style U1 fill:#e6ffed,stroke:#2d9a3b style K1 fill:#e6f0ff,stroke:#2176d2 style H fill:#fff1f0,stroke:#d9534f å¯åŠ¨ä¸äº‹ä»¶å¾ªç¯ è¿™ä¸€èŠ‚æè¿°ç”¨æˆ·æ€ç¨‹åºå¦‚ä½•å®Œæˆå¯åŠ¨å‡†å¤‡å¹¶è¿›å…¥äº‹ä»¶è½®è¯¢ï¼šè§£æå‘½ä»¤è¡Œä¸æ—¥å¿—çº§åˆ«ã€æå‡å¿…è¦çš„èµ„æºé™åˆ¶ã€åŠ è½½å¹¶ attach eBPF ç¨‹åºã€é€šè¿‡ ring buffer æ¥æ”¶å†…æ ¸äº‹ä»¶ã€è°ƒç”¨ EventHandler è¿›è¡Œè§£æè¾“å‡ºï¼Œä»¥åŠåœ¨æ¥æ”¶åˆ°ä¿¡å·æ—¶ä¼˜é›…é€€å‡ºã€‚\nå…³é”®ä¾èµ–ä¸æƒé™ ä¾èµ–é¡¹ï¼šlibbpfï¼ˆåŠ è½½ BPF å¯¹è±¡ä¸ mapsï¼‰ã€spdlogï¼ˆæ—¥å¿—ï¼‰ã€CLI11ï¼ˆå‘½ä»¤è¡Œè§£æï¼‰ã€å¯é€‰çš„å†…æ ¸ BTF / vmlinuxï¼ˆç”¨äºå†…æ ¸ç¬¦å·åŒ–ï¼‰ã€‚\nè¿è¡Œæƒé™ï¼šé€šå¸¸éœ€è¦ root æˆ–è‡³å°‘ CAP_BPF/CAP_SYS_ADMINã€‚å¦å¤–å¿…é¡»æå‡ RLIMIT_MEMLOCKï¼Œå¦åˆ™å†…æ ¸ä¼šå› ä¸ºæ— æ³•é”å®šå†…å­˜è€Œæ‹’ç»åŠ è½½ BPF å¯¹è±¡ã€‚\nå»ºè®®åœ¨å¯åŠ¨å‰åšæœ€åŸºæœ¬çš„ç¯å¢ƒæ£€æŸ¥ï¼š\nuname -r which bpftool å‘½ä»¤è¡Œä¸æ—¥å¿—åˆå§‹åŒ– ä½¿ç”¨ CLI11 è§£æé‡‡æ ·é¢‘ç‡ï¼ˆ-fï¼‰ã€PID è¿‡æ»¤ï¼ˆ-pï¼‰ã€è¾“å‡ºæ ¼å¼ï¼ˆ-Eï¼‰ç­‰é€‰é¡¹ï¼Œå¹¶ä½¿ç”¨ spdlog é…ç½®é»˜è®¤æ—¥å¿—å™¨ä¸æ—¥å¿—ç­‰çº§ã€‚ç¤ºä¾‹ä»£ç ï¼š\nCLI::App app{\"A simple profiler using eBPF\"}; Args args; app.add_option(\"-f,--freq\", args.freq, \"Sampling frequency\")-\u003edefault_val(10); app.add_flag(\"-E,--fold-extend\", args.fold_extend, \"Output in extended folded format\"); CLI11_PARSE(app, argc, argv); using Level = spdlog::level::level_enum; Level level = (args.verbosity == 0) ? Level::warn : (args.verbosity==1 ? Level::info : Level::debug); auto console = spdlog::stdout_color_mt(\"console\"); spdlog::set_default_logger(console); spdlog::set_level(level); å°†æ—¥å¿—çº§åˆ«ä¸å‘½ä»¤è¡Œç»‘å®šï¼Œä¾¿äºåœ¨è°ƒè¯•æ—¶æŸ¥çœ‹è¯¦ç»†ç¬¦å·åŒ–é”™è¯¯æˆ–åœ¨ç”Ÿäº§æ—¶é™ä½è¾“å‡ºå™ªéŸ³ã€‚\næå‡èµ„æºé™åˆ¶ï¼ˆRLIMIT_MEMLOCKï¼‰ BPF å¯¹è±¡å’Œ ring buffer éœ€è¦è¢«å†…æ ¸é”å®šåœ¨å†…å­˜ã€‚æ¨èå°† RLIMIT_MEMLOCK è®¾ä¸ºæ— é™ä»¥é¿å…åŠ è½½å¤±è´¥ï¼š\nrlimit rl = {.rlim_cur = RLIM_INFINITY, .rlim_max = RLIM_INFINITY}; setrlimit(RLIMIT_MEMLOCK, \u0026rl); åœ¨å—é™ç¯å¢ƒä¸‹ï¼ˆå®¹å™¨ã€å—é™ç”¨æˆ·ï¼‰åº”æå‰ç¡®è®¤æ˜¯å¦å…è®¸ä¿®æ”¹è¯¥é™åˆ¶ã€‚\nåŠ è½½å¹¶ç®¡ç† BPF å¯¹è±¡ï¼ˆProfilerSkelï¼‰ é€šè¿‡ bpf çš„ skeletonï¼ˆä¾‹å¦‚ profiler_bpfï¼‰ç”Ÿæˆçš„å°è£…ï¼Œä½¿ç”¨ RAII ç®¡ç†ç”Ÿå‘½å‘¨æœŸï¼šopen/load åœ¨æ„é€ æ—¶å®Œæˆï¼Œèµ„æºåœ¨ææ„æ—¶é‡Šæ”¾ã€‚è‹¥åŠ è½½å¤±è´¥ï¼Œåº”ç«‹å³è®°å½•é”™è¯¯å¹¶é€€å‡ºã€‚\nstruct ProfilerSkel { profiler_bpf* obj{nullptr}; ProfilerSkel() { obj = profiler_bpf::open_and_load(); if (obj == nullptr) spdlog::error(\"Failed to open and load BPF object\"); } ~ProfilerSkel() { if (obj) profiler_bpf__destroy(obj); } operator bool() const { return obj != nullptr; } auto operator-\u003e() const -\u003e profiler_bpf* { return obj; } }; åœ¨åŠ è½½æˆåŠŸåï¼Œè¿˜å¯èƒ½éœ€è¦å¯¹ map è¿›è¡Œé¢„åˆå§‹åŒ–ï¼ˆä¾‹å¦‚è®¾ç½® PID è¿‡æ»¤å™¨ï¼‰æˆ–ä¸º symbolization æä¾› vmlinux è·¯å¾„ã€‚\nåˆå§‹åŒ– perf äº‹ä»¶å¹¶ attach æ ¹æ®é…ç½®ï¼ˆé‡‡æ ·é¢‘ç‡ã€æ˜¯å¦ä½¿ç”¨è½¯ä»¶äº‹ä»¶ã€æ˜¯å¦æŒ‰ PID è¿‡æ»¤ç­‰ï¼‰åˆ›å»º perf event æ–‡ä»¶æè¿°ç¬¦å¹¶è¿”å›ç»™è°ƒç”¨æ–¹ï¼›éšåå°†è¿™äº› fd attach åˆ° eBPF ç¨‹åºçš„ entryï¼ˆä¾‹å¦‚ profileï¼‰ä¸Šã€‚åˆå§‹åŒ–å¤±è´¥æ—¶åº”å½“è®°å½•å¹¶é€€å‡ºã€‚\n// perf.cpp auto init_perf_monitor(uint64_t freq, bool sw_event, pid_t pid = -1) -\u003e Result\u003cstd::vector\u003cint\u003e, libbpf_errno\u003e { int cpus = libbpf_num_possible_cpus(); if (cpus \u003c 0) { return Err(libbpf_errno::LIBBPF_ERRNO__INTERNAL); } perf_event_attr attr = { .type = sw_event ? PERF_TYPE_SOFTWARE : PERF_TYPE_HARDWARE, // é‡‡æ ·ç±»å‹ .size = sizeof(perf_event_attr), .config = (sw_event ? static_cast\u003cuint64_t\u003e(PERF_COUNT_SW_CPU_CLOCK) : static_cast\u003cuint64_t\u003e(PERF_COUNT_HW_CPU_CYCLES)), .sample_freq = freq, // è®¾ç½®é¢‘ç‡ï¼Œæ¯ç§’ freq æ¬¡é‡‡æ · .freq = 1, // æ ‡å¿—ä½ï¼šè®¾ä¸º 1 è¡¨ç¤ºä½¿ç”¨ sample_freq }; std::vector\u003cint\u003e fds; for (int cpu = 0; cpu \u003c cpus; ++cpu) { int fd = static_cast\u003cint\u003e(perf_event_open(\u0026attr, pid, cpu, -1, 0)); if (fd \u003c 0) { return Err(libbpf_errno::LIBBPF_ERRNO__INTERNAL); } fds.push_back(fd); } return fds; } auto attach_perf_events(const std::vector\u003cint\u003e\u0026 fds, bpf_program* prog) -\u003e std::vector\u003cResult\u003cbpf_link*, libbpf_errno\u003e\u003e { std::vector\u003cResult\u003cbpf_link*, libbpf_errno\u003e\u003e links; for (int fd : fds) { auto* link = bpf_program__attach_perf_event(prog, fd); if (libbpf_get_error(link) != 0) { links.emplace_back(Err(libbpf_errno::LIBBPF_ERRNO__INTERNAL)); } links.emplace_back(link); } return links; } // --------------------------------------------------------------- // main.cpp auto perf_fds = init_perf_monitor(freq, args.sw_event, args.pid); if (!perf_fds) { spdlog::error(\"Failed to initialize perf monitor\"); return 1; } attach_perf_events(perf_fds.value(), obj-\u003eprogs.profile); attach æˆåŠŸåï¼Œå†…æ ¸é‡‡æ ·äº‹ä»¶è§¦å‘æ—¶ä¼šè¿›å…¥ eBPF ç¨‹åºï¼Œç¨‹åºä¼šæŠŠæ•°æ®å†™å…¥ä¹‹å‰å£°æ˜çš„ ring buffer mapã€‚\nRing Buffer ä¸äº‹ä»¶å›è°ƒ ç”¨æˆ·æ€é€šè¿‡ ring buffer ä»å†…æ ¸è¯»å–äº‹ä»¶æ ·æœ¬ã€‚å›è°ƒå‡½æ•°è´Ÿè´£ç±»å‹å®‰å…¨åœ°æŠŠåŸå§‹å­—èŠ‚ä¼ é€’ç»™ EventHandler::handleï¼Œç”±å…¶å®Œæˆé•¿åº¦æ£€æŸ¥ã€è§£æä¸è¾“å‡ºã€‚\nstatic auto handle_event_wrapper(void* ctx, void* data, size_t data_sz) -\u003e int { auto* handler = static_cast\u003cEventHandler*\u003e(ctx); return handler-\u003ehandle(static_cast\u003cconst uint8_t*\u003e(data), data_sz); } RingBuffer rb{bpf_map__fd(obj-\u003emaps.events), handle_event_wrapper, \u0026event_handler, nullptr}; if (!rb) { spdlog::error(\"Failed to create ring buffer\"); return 1; } è¦ç‚¹ï¼š\nå›è°ƒç­¾åä½¿ç”¨ const uint8_t* data, size_t data_szï¼Œæœ‰åˆ©äºåœ¨ç”¨æˆ·æ€å¯¹æ¥è‡ªä¸åŒæ¥æºï¼ˆringbufã€perf bufferã€socket ç­‰ï¼‰çš„åŸå§‹å­—èŠ‚æµåšç»Ÿä¸€å¤„ç†å’Œè¾¹ç•Œæ ¡éªŒï¼› ring buffer çš„å®¹é‡åº”æ ¹æ®é‡‡æ ·é¢‘ç‡ä¸å¤„ç†é€Ÿç‡è°ƒæ•´ï¼Œé¿å…ä¸¢å¤±æ ·æœ¬ã€‚ ä¸»å¾ªç¯ã€è½®è¯¢ä¸ä¼˜é›…é€€å‡º ä¸»å¾ªç¯è´Ÿè´£è½®è¯¢ ring bufferï¼Œå¹¶åœ¨æ¥æ”¶åˆ°ä¸­æ–­ä¿¡å·æ—¶ä¼˜é›…é€€å‡ºï¼š\nstatic volatile bool exiting = false; static void sig_handler(int sig) { exiting = true; } ... signal(SIGINT, sig_handler); while (!exiting) { int err = rb.poll(100); if (err == -EINTR) { // Interrupted by signal, continue to check exiting flag continue; } if (err \u003c 0) { spdlog::error(\"Error polling ring buffer: {}\", err); break; } } auto r = close_perf_events(perf_fds.value()); if (!r) { spdlog::error(\"Failed to close perf events, error message is: {}\", static_cast\u003cint\u003e(r.error())); return 1; } é€€å‡ºæµç¨‹è¦ç‚¹ï¼š\nsignal handler ä»…è®¾ç½®åŸå­/æ˜“å˜æ ‡å¿—ï¼Œå®é™…æ¸…ç†åœ¨ä¸»çº¿ç¨‹å®Œæˆï¼› è°ƒç”¨ close_perf_events å…³é—­ perf fdsï¼Œç¡®ä¿å…§æ ¸è®¡æ•°å™¨åœæ­¢å¹¶é‡Šæ”¾èµ„æºï¼› ä¾èµ– RAII çš„ BPF skeleton åœ¨ä½œç”¨åŸŸç»“æŸæ—¶é”€æ¯ BPF å¯¹è±¡å’Œ mapsã€‚ è¿™æ ·å¯ä»¥ä¿è¯åœ¨æ”¶åˆ° SIGINT / SIGTERM æ—¶ï¼Œç¨‹åºèƒ½å¤Ÿå°½é‡æŠŠå·²ç»åˆ°è¾¾çš„æ ·æœ¬å¤„ç†å®Œå¹¶æ­£ç¡®é‡Šæ”¾æ‰€æœ‰å†…æ ¸èµ„æºã€‚\nå¯¹ eBPF ç¨‹åºæŒ‚è½½æ–¹å¼çš„æ€è€ƒ ä¸ºä»€ä¹ˆä¸ç”¨ bpf skeleton ä¸­çš„ bpf_object__attach_skeleton æ¥æŒ‚è½½ï¼Œè€Œæ˜¯ä½¿ç”¨ bpf_program__attach_perf_event ï¼Ÿ åœ¨ä½¿ç”¨ libbpf å¼€å‘ BPF ç¨‹åºæ—¶ï¼Œé€šå¸¸ skeleton ä¼šæä¾›çš„è‡ªåŠ¨ attach æœºåˆ¶ bpf_object__attach_skeletonï¼Œä½†åœ¨å®é™…å®ç° perf é‡‡æ ·ç›‘æ§ï¼ˆä¾‹å¦‚ init_perf_monitor è¿™ç±»é€»è¾‘ï¼‰çš„è¿‡ç¨‹ä¸­ï¼Œæœ€ç»ˆé€‰æ‹©çš„æ˜¯æ‰‹åŠ¨åˆ›å»º perf_event fdï¼Œå¹¶ä½¿ç”¨ bpf_program__attach_perf_event è¿›è¡ŒæŒ‚è½½ã€‚è¿™å¹¶ä¸æ˜¯å› ä¸º skeleton ä¸å¥½ï¼Œè€Œæ˜¯ä¸¤è€…é€‚ç”¨çš„å±‚çº§å’Œåœºæ™¯å¹¶ä¸ç›¸åŒã€‚\nskeleton attach æ˜¯ä»€ä¹ˆï¼Œå®ƒè§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ skeleton attachï¼ˆæœ¬è´¨æ˜¯ bpf_object__attach_skeleton æˆ–ç”Ÿæˆä»£ç ä¸­çš„ xxx__attach()ï¼‰æ˜¯ä¸€ç§é«˜å±‚æŠ½è±¡ï¼š\nåœ¨ BPF ELF ä¸­é€šè¿‡ section æè¿°ç¨‹åºçš„ attach ç±»å‹ libbpf æ ¹æ®è¿™äº›å…ƒä¿¡æ¯ï¼Œè‡ªåŠ¨æŠŠæ‰€æœ‰ program æŒ‚è½½åˆ°å¯¹åº”çš„ hook ç‚¹ ç”¨æˆ·æ€å‡ ä¹ä¸éœ€è¦å…³å¿ƒ attach çš„ç»†èŠ‚ å®ƒéå¸¸é€‚åˆä¸‹é¢è¿™äº›åœºæ™¯ï¼š\nattach ç±»å‹æ˜¯ é™æ€çš„ã€ç¼–è¯‘æœŸå°±ç¡®å®šçš„ æ¯”å¦‚ tracepointã€kprobeã€raw_tp ç­‰ å¸Œæœ›å¿«é€ŸæŠŠç¨‹åºè·‘èµ·æ¥ï¼Œè€Œä¸æ˜¯å†™å¤§é‡æ ·æ¿ä»£ç  åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œskeleton attach æ˜¯å‡ ä¹æ²¡æœ‰ç†ç”±æ‹’ç»çš„ã€‚ä½†å½“ attach å¯¹è±¡å˜æˆ perf event æ—¶ï¼Œæƒ…å†µå°±ä¸å¤ªä¸€æ ·äº†ã€‚\nperf åœºæ™¯ä¸‹çš„ä¸åŒ perf äº‹ä»¶å¹¶ä¸æ˜¯ä¸€ä¸ªâ€œå¤©ç„¶å­˜åœ¨çš„ hook ç‚¹â€ï¼Œè€Œæ˜¯éœ€è¦ç”¨æˆ·æ€æ˜¾å¼åˆ›å»ºçš„ï¼š\néœ€è¦è°ƒç”¨ perf_event_open éœ€è¦æ„é€  perf_event_attr éœ€è¦å†³å®šï¼š æ˜¯æŒ‰ CPU è¿˜æ˜¯æŒ‰ PID é‡‡æ ·é¢‘ç‡ / period æ˜¯å¦ per-CPU åˆ›å»ºå¤šä¸ª fd è¿™äº›ä¿¡æ¯å¤©ç„¶å±äºè¿è¡Œæ—¶é…ç½®ï¼Œè€Œä¸æ˜¯ ELF å…ƒä¿¡æ¯çš„ä¸€éƒ¨åˆ†ã€‚\nè€Œ skeleton attach çš„è®¾è®¡å‡è®¾æ˜¯ï¼š\nattach è¡Œä¸ºå·²ç»åœ¨ BPF ç¨‹åºä¸­å£°æ˜å¥½ï¼Œç”¨æˆ·æ€åªè´Ÿè´£â€œä¸€æ¬¡æ€§æŒ‚ä¸Šå»â€ã€‚\nå› è€Œè¿™é‡Œé€‰æ‹©äº†å¦ä¸€æ¡è·¯å¾„ï¼š\nåœ¨ç”¨æˆ·æ€æ˜¾å¼åˆ›å»º perf_event fd å°†å•ä¸ª bpf_program é™„åŠ åˆ°æŒ‡å®šçš„ perf fd ä¸Š ä¹Ÿå°±æ˜¯ä½¿ç”¨ï¼š\nbpf_program__attach_perf_event(prog, perf_fd); è¿™ç§æ–¹å¼å¸¦æ¥çš„å¥½å¤„ï¼Œä¸»è¦ä½“ç°åœ¨æ§åˆ¶æƒå®Œå…¨å›åˆ°ç”¨æˆ·æ€ã€‚\nprogram attach æŒ‚è½½çš„å¥½å¤„ ï¼ˆ1ï¼‰attach ç²’åº¦æ›´ç»†\nskeleton attachï¼š ä»¥æ•´ä¸ª skeleton ä¸ºå•ä½ è‡ªåŠ¨ attach å¤šä¸ª program / link program attachï¼š æ˜ç¡®åœ°æ§åˆ¶â€œå“ªä¸ª program â†’ å“ªä¸ª perf fdâ€ è¿™åœ¨ perf åœºæ™¯ä¸‹éå¸¸é‡è¦ï¼Œå› ä¸º fd æœ¬èº«å°±æ˜¯ç­–ç•¥çš„ä¸€éƒ¨åˆ†ã€‚\nï¼ˆ2ï¼‰perf å‚æ•°å¯ä»¥åœ¨è¿è¡Œæ—¶è‡ªç”±é…ç½®\né€šè¿‡æ‰‹åŠ¨åˆ›å»º perf fdï¼Œå¯ä»¥åœ¨ç”¨æˆ·æ€ç²¾ç¡®æ§åˆ¶ï¼š\né‡‡æ ·é¢‘ç‡ï¼ˆfreq / periodï¼‰ perf event ç±»å‹ ç»‘å®šåˆ°å“ªä¸ª CPU æˆ– PID æ˜¯å¦ä¸ºæ¯ä¸ª CPU åˆ›å»ºç‹¬ç«‹ fd è¿™äº›é…ç½®å¾ˆéš¾ä¼˜é›…åœ°æ”¾è¿› skeleton çš„è‡ªåŠ¨ attach æµç¨‹ä¸­ï¼Œä½†å´æ˜¯ perf é‡‡æ ·ä¸­æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ã€‚\nï¼ˆ3ï¼‰å¤©ç„¶æ”¯æŒ per-CPU / å¤š fd æ¨¡å‹\nä¸€ä¸ªå¾ˆå…¸å‹çš„æ¨¡å¼æ˜¯ï¼š\nä¸ºæ¯ä¸ª CPU åˆ›å»ºä¸€ä¸ª perf fd æŠŠåŒä¸€ä¸ª BPF ç¨‹åºé™„åŠ åˆ°æ‰€æœ‰è¿™äº› fd ä¸Š è¿™åœ¨ program attach æ¨¡å‹ä¸‹æ˜¯é¡ºç†æˆç« çš„äº‹æƒ…ï¼š\nfor_each_cpu(cpu) { perf_fd = perf_event_open(..., cpu, ...); link[cpu] = bpf_program__attach_perf_event(prog, perf_fd); } è€Œ skeleton attach å¹¶ä¸æ“…é•¿è¡¨è¾¾è¿™ç§ â€œä¸€å¯¹å¤šã€è¿è¡Œæ—¶ç”Ÿæˆâ€çš„ attach å…³ç³»ã€‚\nï¼ˆ4ï¼‰é”™è¯¯å¤„ç†é€»è¾‘æ›´æ¸…æ™°\næ‰‹åŠ¨ç®¡ç† perf fd å’Œ linkï¼Œä¹Ÿæ„å‘³ç€ï¼š\nperf_event_open å¤±è´¥æ—¶å¯ä»¥ï¼š è·³è¿‡æŸäº› CPU é™çº§é‡‡æ ·ç­–ç•¥ åšé‡è¯•æˆ– fallback attach å¤±è´¥æ—¶å¯ä»¥å•ç‹¬å¤„ç†ï¼Œè€Œä¸æ˜¯æ•´ä½“å¤±è´¥ å¯¹æ¯”å°ç»“ éœ€è¦å¼ºè°ƒçš„ä¸€ç‚¹æ˜¯ï¼Œåº•å±‚å…¶å®å¹¶æ²¡æœ‰â€œè°æ›´é«˜çº§â€ï¼š\næ— è®ºæ˜¯ skeleton attach è¿˜æ˜¯ bpf_program__attach_perf_eventï¼Œæœ€ç»ˆå†…æ ¸é‡Œåšçš„äº‹æƒ…æœ¬è´¨ä¸Šæ˜¯ä¸€æ ·çš„â€”â€”å»ºç«‹ bpf_linkï¼ŒæŠŠç¨‹åºç»‘å®šåˆ°äº‹ä»¶ä¸Šã€‚\nå¯¹å½“å‰çš„ perf é‡‡æ ·ç›‘æ§åœºæ™¯æ¥è¯´ï¼š\né‡‡æ ·é¢‘ç‡ã€CPU ç»‘å®šã€fd æ•°é‡éƒ½æ˜¯è¿è¡Œæ—¶å†³ç­– éœ€è¦ per-CPU åˆ›å»º perf fd éœ€è¦æ¸…æ™°çš„é”™è¯¯å¤„ç†å’Œèµ„æºç®¡ç†è·¯å¾„ å› æ­¤åœ¨ç”¨æˆ·æ€åˆ›å»º perf_event fdï¼Œå¹¶ä½¿ç”¨ bpf_program__attach_perf_event é€ä¸ª attachï¼Œæ˜¯æ›´è‡ªç„¶ã€ä¹Ÿæ›´å¯æ§çš„åšæ³•ã€‚\nå‚è€ƒ eBPF å…¥é—¨å®è·µæ•™ç¨‹åäºŒï¼šä½¿ç”¨ eBPF ç¨‹åº profile è¿›è¡Œæ€§èƒ½åˆ†æ eBPF æ€§èƒ½åˆ†æå®æˆ˜ - eBPF åœ¨æ€§èƒ½åˆ†æä¸­çš„åº”ç”¨ Perf IPC ä¸ CPU åˆ©ç”¨ç‡ - perf åŸç†æ·±å…¥è§£æ perf_event_open æ‰‹å†Œé¡µ - å®˜æ–¹æ–‡æ¡£å‚è€ƒ FlameGraph å·¥å…· - ç«ç„°å›¾ç”Ÿæˆå·¥å…· blazesym ç¬¦å·åŒ–åº“ - é«˜æ€§èƒ½ç¬¦å·åŒ–åº“ ","wordCount":"2215","inLanguage":"en","image":"https://kerolt.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2026-01-29T00:00:00Z","dateModified":"2026-01-29T00:00:00Z","author":{"@type":"Person","name":"Kerolt"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://kerolt.github.io/posts/ebpf/%E5%88%A9%E7%94%A8ebpf%E4%B8%8Eperf_event%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AAprofiling%E5%B7%A5%E5%85%B7/"},"publisher":{"@type":"Organization","name":"Kerolt's Blog","logo":{"@type":"ImageObject","url":"https://kerolt.github.io/images/avatar/favicon.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://kerolt.github.io/ accesskey=h title="Kerolt's Blog (Alt + H)">Kerolt's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://kerolt.github.io/posts/ title=æ–‡ç« ><span>æ–‡ç« </span></a></li><li><a href=https://kerolt.github.io/categories/ title=åˆ†ç±»><span>åˆ†ç±»</span></a></li><li><a href=https://kerolt.github.io/tags/ title=æ ‡ç­¾><span>æ ‡ç­¾</span></a></li><li><a href=https://kerolt.github.io/archives/ title=å½’æ¡£><span>å½’æ¡£</span></a></li><li><a href=https://kerolt.github.io/about/ title=å…³äºæˆ‘><span>å…³äºæˆ‘</span></a></li><li><a href=https://kerolt.github.io/search/ title="ğŸ” (Alt + /)" accesskey=/><span>ğŸ”</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://kerolt.github.io/>Home</a>&nbsp;Â»&nbsp;<a href=https://kerolt.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">åˆ©ç”¨eBPFä¸perf_eventæ„å»ºä¸€ä¸ªprofilingå·¥å…·</h1><div class=post-meta><span title='2026-01-29 00:00:00 +0000 UTC'>å‘å¸ƒäº2026-01-29</span>&nbsp;&nbsp;Â·&nbsp;&nbsp;Kerolt</div><ul class=post-tags><li><a href=https://kerolt.github.io/tags/perf/>Perf</a></li><li><a href=https://kerolt.github.io/tags/cpp/>Cpp</a></li><li><a href=https://kerolt.github.io/tags/%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/>æ€§èƒ½åˆ†æ</a></li><li><a href=https://kerolt.github.io/tags/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/>ç³»ç»Ÿè°ƒç”¨</a></li><li><a href=https://kerolt.github.io/tags/ebpf/>EBPF</a></li></ul></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e5%bc%95%e8%a8%80 aria-label=å¼•è¨€>å¼•è¨€</a></li><li><a href=#perf_event_open-%e6%9c%ba%e5%88%b6%e8%a7%a3%e6%9e%90 aria-label="perf_event_open æœºåˆ¶è§£æ">perf_event_open æœºåˆ¶è§£æ</a><ul><li><a href=#%e4%bb%a5%e6%96%87%e4%bb%b6%e6%8f%8f%e8%bf%b0%e7%ac%a6%e4%b8%ba%e4%b8%ad%e5%bf%83%e7%9a%84%e7%9b%91%e6%8e%a7%e5%8d%95%e5%85%83 aria-label=ä»¥æ–‡ä»¶æè¿°ç¬¦ä¸ºä¸­å¿ƒçš„ç›‘æ§å•å…ƒ>ä»¥æ–‡ä»¶æè¿°ç¬¦ä¸ºä¸­å¿ƒçš„ç›‘æ§å•å…ƒ</a></li><li><a href=#%e4%ba%8b%e4%bb%b6%e7%8a%b6%e6%80%81%e6%8e%a7%e5%88%b6ioctl-%e4%b8%8e-prctl aria-label="äº‹ä»¶çŠ¶æ€æ§åˆ¶ï¼šioctl ä¸ prctl">äº‹ä»¶çŠ¶æ€æ§åˆ¶ï¼šioctl ä¸ prctl</a></li></ul></li><li><a href=#%e4%b8%a4%e7%a7%8d%e5%b7%a5%e4%bd%9c%e6%a8%a1%e5%bc%8f%e8%ae%a1%e6%95%b0-vs-%e9%87%87%e6%a0%b7 aria-label="ä¸¤ç§å·¥ä½œæ¨¡å¼ï¼šè®¡æ•° vs é‡‡æ ·">ä¸¤ç§å·¥ä½œæ¨¡å¼ï¼šè®¡æ•° vs é‡‡æ ·</a><ul><li><a href=#%e8%ae%a1%e6%95%b0%e6%a8%a1%e5%bc%8f-counting-mode aria-label="è®¡æ•°æ¨¡å¼ (Counting Mode)">è®¡æ•°æ¨¡å¼ (Counting Mode)</a></li><li><a href=#%e9%87%87%e6%a0%b7%e6%a8%a1%e5%bc%8f-sampling-mode aria-label="é‡‡æ ·æ¨¡å¼ (Sampling Mode)">é‡‡æ ·æ¨¡å¼ (Sampling Mode)</a></li></ul></li><li><a href=#%e7%bb%93%e5%90%88-ebpf-%e5%ae%9e%e7%8e%b0-profiling aria-label="ç»“åˆ eBPF å®ç° profiling">ç»“åˆ eBPF å®ç° profiling</a></li><li><a href=#%e8%a7%a3%e6%9e%90%e9%87%87%e9%9b%86%e7%9a%84%e6%a0%88%e5%9b%9e%e6%ba%af%e4%bf%a1%e6%81%af aria-label=è§£æé‡‡é›†çš„æ ˆå›æº¯ä¿¡æ¯>è§£æé‡‡é›†çš„æ ˆå›æº¯ä¿¡æ¯</a><ul><li><a href=#api-%e8%ae%be%e8%ae%a1 aria-label="API è®¾è®¡">API è®¾è®¡</a></li><li><a href=#%e7%ac%a6%e5%8f%b7%e5%8c%96%e8%a7%a3%e6%9e%90%e5%b0%86%e5%9c%b0%e5%9d%80%e8%bd%ac%e6%8d%a2%e4%b8%ba%e5%87%bd%e6%95%b0%e5%90%8d aria-label=ç¬¦å·åŒ–è§£æï¼šå°†åœ°å€è½¬æ¢ä¸ºå‡½æ•°å>ç¬¦å·åŒ–è§£æï¼šå°†åœ°å€è½¬æ¢ä¸ºå‡½æ•°å</a></li><li><a href=#%e4%ba%8b%e4%bb%b6%e5%a4%84%e7%90%86 aria-label=äº‹ä»¶å¤„ç†>äº‹ä»¶å¤„ç†</a></li><li><a href=#%e6%a0%87%e5%87%86%e8%be%93%e5%87%ba%e6%a0%bc%e5%bc%8f%e5%8f%af%e8%af%bb%e7%9a%84%e9%80%90%e5%b8%a7%e5%b1%95%e7%a4%ba aria-label=æ ‡å‡†è¾“å‡ºæ ¼å¼ï¼šå¯è¯»çš„é€å¸§å±•ç¤º>æ ‡å‡†è¾“å‡ºæ ¼å¼ï¼šå¯è¯»çš„é€å¸§å±•ç¤º</a></li><li><a href=#%e7%81%ab%e7%84%b0%e5%9b%be%e6%a0%bc%e5%bc%8f%e6%9c%ba%e5%99%a8%e5%8f%af%e8%af%bb%e7%9a%84%e6%95%b0%e6%8d%ae%e8%be%93%e5%87%ba aria-label=ç«ç„°å›¾æ ¼å¼ï¼šæœºå™¨å¯è¯»çš„æ•°æ®è¾“å‡º>ç«ç„°å›¾æ ¼å¼ï¼šæœºå™¨å¯è¯»çš„æ•°æ®è¾“å‡º</a></li><li><a href=#%e6%b5%81%e7%a8%8b%e5%9b%be aria-label=æµç¨‹å›¾>æµç¨‹å›¾</a></li></ul></li><li><a href=#%e5%90%af%e5%8a%a8%e4%b8%8e%e4%ba%8b%e4%bb%b6%e5%be%aa%e7%8e%af aria-label=å¯åŠ¨ä¸äº‹ä»¶å¾ªç¯>å¯åŠ¨ä¸äº‹ä»¶å¾ªç¯</a><ul><li><a href=#%e5%85%b3%e9%94%ae%e4%be%9d%e8%b5%96%e4%b8%8e%e6%9d%83%e9%99%90 aria-label=å…³é”®ä¾èµ–ä¸æƒé™>å…³é”®ä¾èµ–ä¸æƒé™</a></li><li><a href=#%e5%91%bd%e4%bb%a4%e8%a1%8c%e4%b8%8e%e6%97%a5%e5%bf%97%e5%88%9d%e5%a7%8b%e5%8c%96 aria-label=å‘½ä»¤è¡Œä¸æ—¥å¿—åˆå§‹åŒ–>å‘½ä»¤è¡Œä¸æ—¥å¿—åˆå§‹åŒ–</a></li><li><a href=#%e6%8f%90%e5%8d%87%e8%b5%84%e6%ba%90%e9%99%90%e5%88%b6rlimit_memlock aria-label=æå‡èµ„æºé™åˆ¶ï¼ˆRLIMIT_MEMLOCKï¼‰>æå‡èµ„æºé™åˆ¶ï¼ˆ<code>RLIMIT_MEMLOCK</code>ï¼‰</a></li><li><a href=#%e5%8a%a0%e8%bd%bd%e5%b9%b6%e7%ae%a1%e7%90%86-bpf-%e5%af%b9%e8%b1%a1profilerskel aria-label="åŠ è½½å¹¶ç®¡ç† BPF å¯¹è±¡ï¼ˆProfilerSkelï¼‰">åŠ è½½å¹¶ç®¡ç† BPF å¯¹è±¡ï¼ˆ<code>ProfilerSkel</code>ï¼‰</a></li><li><a href=#%e5%88%9d%e5%a7%8b%e5%8c%96-perf-%e4%ba%8b%e4%bb%b6%e5%b9%b6-attach aria-label="åˆå§‹åŒ– perf äº‹ä»¶å¹¶ attach">åˆå§‹åŒ– perf äº‹ä»¶å¹¶ attach</a></li><li><a href=#ring-buffer-%e4%b8%8e%e4%ba%8b%e4%bb%b6%e5%9b%9e%e8%b0%83 aria-label="Ring Buffer ä¸äº‹ä»¶å›è°ƒ">Ring Buffer ä¸äº‹ä»¶å›è°ƒ</a></li><li><a href=#%e4%b8%bb%e5%be%aa%e7%8e%af%e8%bd%ae%e8%af%a2%e4%b8%8e%e4%bc%98%e9%9b%85%e9%80%80%e5%87%ba aria-label=ä¸»å¾ªç¯ã€è½®è¯¢ä¸ä¼˜é›…é€€å‡º>ä¸»å¾ªç¯ã€è½®è¯¢ä¸ä¼˜é›…é€€å‡º</a></li></ul></li><li><a href=#%e5%af%b9-ebpf-%e7%a8%8b%e5%ba%8f%e6%8c%82%e8%bd%bd%e6%96%b9%e5%bc%8f%e7%9a%84%e6%80%9d%e8%80%83 aria-label="å¯¹ eBPF ç¨‹åºæŒ‚è½½æ–¹å¼çš„æ€è€ƒ">å¯¹ eBPF ç¨‹åºæŒ‚è½½æ–¹å¼çš„æ€è€ƒ</a><ul><li><a href=#skeleton-attach-%e6%98%af%e4%bb%80%e4%b9%88%e5%ae%83%e8%a7%a3%e5%86%b3%e4%ba%86%e4%bb%80%e4%b9%88%e9%97%ae%e9%a2%98 aria-label="skeleton attach æ˜¯ä»€ä¹ˆï¼Œå®ƒè§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ">skeleton attach æ˜¯ä»€ä¹ˆï¼Œå®ƒè§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ</a></li><li><a href=#perf-%e5%9c%ba%e6%99%af%e4%b8%8b%e7%9a%84%e4%b8%8d%e5%90%8c aria-label="perf åœºæ™¯ä¸‹çš„ä¸åŒ">perf åœºæ™¯ä¸‹çš„ä¸åŒ</a></li><li><a href=#program-attach-%e6%8c%82%e8%bd%bd%e7%9a%84%e5%a5%bd%e5%a4%84 aria-label="program attach æŒ‚è½½çš„å¥½å¤„">program attach æŒ‚è½½çš„å¥½å¤„</a></li><li><a href=#%e5%af%b9%e6%af%94%e5%b0%8f%e7%bb%93 aria-label=å¯¹æ¯”å°ç»“>å¯¹æ¯”å°ç»“</a></li></ul></li><li><a href=#%e5%8f%82%e8%80%83 aria-label=å‚è€ƒ>å‚è€ƒ</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h2 id=å¼•è¨€>å¼•è¨€<a hidden class=anchor aria-hidden=true href=#å¼•è¨€>#</a></h2><p>åœ¨æ€§èƒ½åˆ†æå’Œç³»ç»Ÿè°ƒä¼˜ä¸­ï¼Œäº†è§£åº”ç”¨ç¨‹åºåœ¨è¿è¡Œæ—¶çš„è°ƒç”¨æ ˆä¿¡æ¯è‡³å…³é‡è¦ã€‚åœ¨ <a href=https://eunomia.dev/zh/tutorials/12-profile/>ã€eBPF å…¥é—¨å®è·µæ•™ç¨‹åäºŒï¼šä½¿ç”¨ eBPF ç¨‹åº profile è¿›è¡Œæ€§èƒ½åˆ†æã€‘</a> è¿™ç¯‡æ–‡ç« ä¸­ï¼Œå…¶åˆ©ç”¨ Rust + eBPF æ„å»ºäº†ä¸€ä¸ª profiler å·¥å…·ï¼ŒæŠ±ç€å­¦ä¹ çš„ç›®çš„ï¼Œæˆ‘ä½¿ç”¨ C++ å®ç°äº†ç›¸åŒçš„åŠŸèƒ½ï¼Œå¹¶å°†æ‰€å­¦çŸ¥è¯†æ€»ç»“æˆæœ¬æ–‡ã€‚</p><h2 id=perf_event_open-æœºåˆ¶è§£æ>perf_event_open æœºåˆ¶è§£æ<a hidden class=anchor aria-hidden=true href=#perf_event_open-æœºåˆ¶è§£æ>#</a></h2><p><div class=post-img-view><a data-fancybox=gallery href=https://plantegg.github.io/images/951413iMgBlog/5edebc74-f8ac-483c-8bcd-24e09abfd06b.png><img src=https://plantegg.github.io/images/951413iMgBlog/5edebc74-f8ac-483c-8bcd-24e09abfd06b.png alt></a></div></p><blockquote><p>perf åŸç†å›¾ï¼šhttps://plantegg.github.io/2021/05/16/Perf_IPC%E4%BB%A5%E5%8F%8ACPU%E5%88%A9%E7%94%A8%E7%8E%87/</p></blockquote><p><code>perf_event_open</code> æ˜¯ Linux å†…æ ¸æä¾›çš„æ€§èƒ½ç›‘æ§æ¥å£ï¼Œå…è®¸ç”¨æˆ·ç©ºé—´ç¨‹åºåˆ›å»ºæ€§èƒ½äº‹ä»¶è®¡æ•°å™¨ã€‚å½“ç”¨æˆ·æ€ç¨‹åºè°ƒç”¨ <code>sys_perf_event_open</code> ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œå†…æ ¸ä¼šåˆ›å»ºç›¸åº”çš„æ€§èƒ½ç›‘æ§å®ä¾‹ã€‚ä»¥ä¸‹æ˜¯åŸºæœ¬çš„ä½¿ç”¨æ–¹å¼ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#099>#include</span> <span style=color:#099>&lt;linux/perf_event.h&gt;</span><span style=color:#099>
</span></span></span><span style=display:flex><span><span style=color:#099>#include</span> <span style=color:#099>&lt;sys/syscall.h&gt;</span><span style=color:#099>
</span></span></span><span style=display:flex><span><span style=color:#099>#include</span> <span style=color:#099>&lt;unistd.h&gt;</span><span style=color:#099>
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#078;font-weight:700>int64_t</span> <span style=color:#c0f>perf_event_open</span>(<span style=color:#069;font-weight:700>struct</span> perf_event_attr<span style=color:#555>*</span> hw_event, <span style=color:#078;font-weight:700>pid_t</span> pid, <span style=color:#078;font-weight:700>int</span> cpu,
</span></span><span style=display:flex><span>                     <span style=color:#078;font-weight:700>int</span> group_fd, <span style=color:#078;font-weight:700>unsigned</span> <span style=color:#078;font-weight:700>long</span> flags) {
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>return</span> <span style=color:#c0f>syscall</span>(SYS_perf_event_open, hw_event, pid, cpu, group_fd, flags);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=ä»¥æ–‡ä»¶æè¿°ç¬¦ä¸ºä¸­å¿ƒçš„ç›‘æ§å•å…ƒ>ä»¥æ–‡ä»¶æè¿°ç¬¦ä¸ºä¸­å¿ƒçš„ç›‘æ§å•å…ƒ<a hidden class=anchor aria-hidden=true href=#ä»¥æ–‡ä»¶æè¿°ç¬¦ä¸ºä¸­å¿ƒçš„ç›‘æ§å•å…ƒ>#</a></h3><p>Linux éµå¾ª " ä¸€åˆ‡çš†æ–‡ä»¶ " çš„è®¾è®¡å“²å­¦ï¼Œ<code>perf_event_open</code> ä¹Ÿä¸ä¾‹å¤–ã€‚æ¯æ¬¡è°ƒç”¨è¯¥å‡½æ•°ï¼Œå†…æ ¸éƒ½ä¼šåˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„æ€§èƒ½ç›‘æ§å®ä¾‹ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚</p><p><strong>æ ¸å¿ƒæ¦‚å¿µ</strong>ï¼š</p><ul><li><strong>1 fd = 1 Event</strong>ï¼šæ¯ä¸ªæ–‡ä»¶æè¿°ç¬¦å¯¹åº”ä¸€ä¸ªå…·ä½“çš„ç›‘æ§ä»»åŠ¡ï¼Œä¾‹å¦‚ " ç›‘æ§ CPU 0 çš„æŒ‡ä»¤æ‰§è¡Œæ•° "</li><li><strong>äº‹ä»¶åˆ†ç»„ (Group)</strong>ï¼šå¤šä¸ªæ–‡ä»¶æè¿°ç¬¦å¯ä»¥ç»‘å®šåœ¨ä¸€èµ·å½¢æˆäº‹ä»¶ç»„</li></ul><p><strong>åˆ†ç»„çš„é‡è¦æ€§</strong>ï¼š
å‡è®¾éœ€è¦è®¡ç®— " æ¯æ¡æŒ‡ä»¤çš„ç¼“å­˜æœªå‘½ä¸­ç‡ &ldquo;ï¼Œéœ€è¦åŒæ—¶ç›‘æ§ " æŒ‡ä»¤æ•° " å’Œ " ç¼“å­˜æœªå‘½ä¸­æ•° &ldquo;ã€‚å°†å®ƒä»¬æ”¾å…¥åŒä¸€äº‹ä»¶ç»„å¯ä»¥ç¡®ä¿ï¼š</p><ol><li>ä¸¤ä¸ªäº‹ä»¶<strong>åŒæ—¶å¼€å§‹ã€åŒæ—¶ç»“æŸ</strong>è®¡æ•°</li><li>ç¡¬ä»¶è®¡æ•°å™¨åŒæ­¥é‡‡æ ·ï¼Œä¿è¯è®¡ç®—æ¯”ä¾‹çš„å‡†ç¡®æ€§</li><li>å‡å°‘ç³»ç»Ÿè°ƒç”¨å¼€é”€</li></ol><h3 id=äº‹ä»¶çŠ¶æ€æ§åˆ¶ioctl-ä¸-prctl>äº‹ä»¶çŠ¶æ€æ§åˆ¶ï¼šioctl ä¸ prctl<a hidden class=anchor aria-hidden=true href=#äº‹ä»¶çŠ¶æ€æ§åˆ¶ioctl-ä¸-prctl>#</a></h3><p>åˆ›å»ºäº‹ä»¶åï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ§åˆ¶å…¶è¿è¡ŒçŠ¶æ€ï¼š</p><ul><li><strong>ioctl (Input/Output Control)</strong>ï¼šé’ˆå¯¹å•ä¸ªæ–‡ä»¶æè¿°ç¬¦çš„æ“ä½œ<ul><li><code>ioctl(fd, PERF_EVENT_IOC_ENABLE)</code>ï¼šå¯ç”¨äº‹ä»¶ç›‘æ§</li><li><code>ioctl(fd, PERF_EVENT_IOC_DISABLE)</code>ï¼šæš‚åœäº‹ä»¶ç›‘æ§</li></ul></li><li><strong>prctl (Process Control)</strong>ï¼šé’ˆå¯¹å½“å‰è¿›ç¨‹æ‰€æœ‰äº‹ä»¶çš„æ‰¹é‡æ“ä½œ<ul><li>é€‚ç”¨äºç®¡ç†å¤šä¸ªç›‘æ§äº‹ä»¶çš„åœºæ™¯ï¼Œé¿å…é¢‘ç¹çš„ <code>ioctl</code> è°ƒç”¨</li></ul></li></ul><p><strong>è®¾è®¡ä¼˜åŠ¿</strong>ï¼šäº‹ä»¶è¢«ç¦ç”¨æ—¶ï¼Œè®¡æ•°å™¨æš‚åœä½†æ•°æ®ä¿ç•™ã€‚è¿™ç§è®¾è®¡å…è®¸åœ¨ç¨‹åºç‰¹å®šé˜¶æ®µï¼ˆå¦‚å…³é”®ç®—æ³•æ‰§è¡ŒæœŸé—´ï¼‰ç²¾ç¡®å¼€å¯ç›‘æ§ï¼Œå®ç°ç»†ç²’åº¦çš„æ€§èƒ½åˆ†æã€‚</p><h2 id=ä¸¤ç§å·¥ä½œæ¨¡å¼è®¡æ•°-vs-é‡‡æ ·>ä¸¤ç§å·¥ä½œæ¨¡å¼ï¼šè®¡æ•° vs é‡‡æ ·<a hidden class=anchor aria-hidden=true href=#ä¸¤ç§å·¥ä½œæ¨¡å¼è®¡æ•°-vs-é‡‡æ ·>#</a></h2><p><code>perf_event</code> æ”¯æŒä¸¤ç§åŸºæœ¬å·¥ä½œæ¨¡å¼ï¼Œæ»¡è¶³ä¸åŒçš„æ€§èƒ½åˆ†æéœ€æ±‚ï¼š</p><h3 id=è®¡æ•°æ¨¡å¼-counting-mode>è®¡æ•°æ¨¡å¼ (Counting Mode)<a hidden class=anchor aria-hidden=true href=#è®¡æ•°æ¨¡å¼-counting-mode>#</a></h3><p>å†…æ ¸ç»´æŠ¤ä¸€ä¸ªç®€å•çš„è®¡æ•°å™¨ï¼ˆé€šå¸¸æ˜¯ <code>u64</code> ç±»å‹æ•´æ•°ï¼‰ã€‚è®¡æ•°äº‹ä»¶çš„ç»“æœé€šè¿‡ <code>read</code> ç³»ç»Ÿè°ƒç”¨æ”¶é›†ã€‚</p><p><strong>ç‰¹ç‚¹</strong>ï¼š</p><ul><li>ä½å¼€é”€ï¼šä»…ç»´æŠ¤è®¡æ•°å™¨ï¼Œä¸è®°å½•è¯¦ç»†ä¸Šä¸‹æ–‡</li><li>ç»“æœç®€å•ï¼šè¿”å›äº‹ä»¶å‘ç”Ÿçš„æ€»æ¬¡æ•°</li><li><strong>åº”ç”¨åœºæ™¯</strong>ï¼šåŸºå‡†æµ‹è¯•ã€æ€§èƒ½ç»Ÿè®¡<ul><li>ä¾‹å¦‚ï¼š&rdquo; è¿™æ®µä»£ç æ‰§è¡Œæ¶ˆè€—äº†å¤šå°‘ CPU å‘¨æœŸ "</li><li>" å‡½æ•°è°ƒç”¨å‘ç”Ÿäº†å¤šå°‘æ¬¡ç¼“å­˜æœªå‘½ä¸­ "</li></ul></li></ul><h3 id=é‡‡æ ·æ¨¡å¼-sampling-mode>é‡‡æ ·æ¨¡å¼ (Sampling Mode)<a hidden class=anchor aria-hidden=true href=#é‡‡æ ·æ¨¡å¼-sampling-mode>#</a></h3><p>è®¾ç½®é‡‡æ ·é˜ˆå€¼ï¼ˆå¦‚æ¯ 1000 æ¬¡ç¼“å­˜æœªå‘½ä¸­é‡‡æ ·ä¸€æ¬¡ï¼‰ã€‚å½“äº‹ä»¶è®¡æ•°å™¨æº¢å‡ºæ—¶ï¼Œå†…æ ¸ä¼šæ•è·å½“å‰çš„æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ˆåŒ…æ‹¬æŒ‡ä»¤æŒ‡é’ˆã€è¿›ç¨‹ IDã€è°ƒç”¨æ ˆç­‰ï¼‰ã€‚</p><p><strong>å·¥ä½œåŸç†</strong>ï¼š</p><ol><li>å†…æ ¸åˆ†é…ç¯å½¢ç¼“å†²åŒºç”¨äºå­˜å‚¨é‡‡æ ·æ•°æ®</li><li>é‡‡æ ·æ•°æ®é€šè¿‡å†…å­˜æ˜ å°„ (<code>mmap</code>) æš´éœ²ç»™ç”¨æˆ·ç©ºé—´</li><li>ç”¨æˆ·ç¨‹åºä»ç¼“å†²åŒº " æ¶ˆè´¹ " é‡‡æ ·æ•°æ®</li></ol><p><strong>ä¼˜åŠ¿</strong>ï¼š</p><ul><li>è®°å½•è¯¦ç»†çš„æ‰§è¡Œä¸Šä¸‹æ–‡ä¿¡æ¯</li><li>æ”¯æŒè°ƒç”¨æ ˆå›æº¯</li><li><strong>åº”ç”¨åœºæ™¯</strong>ï¼šæ€§èƒ½çƒ­ç‚¹åˆ†æã€ç«ç„°å›¾ç”Ÿæˆã€å‡½æ•°è°ƒç”¨é¢‘ç‡ç»Ÿè®¡</li></ul><h2 id=ç»“åˆ-ebpf-å®ç°-profiling>ç»“åˆ eBPF å®ç° profiling<a hidden class=anchor aria-hidden=true href=#ç»“åˆ-ebpf-å®ç°-profiling>#</a></h2><p>ä¼ ç»Ÿ <code>perf</code> å·¥å…·è™½ç„¶åŠŸèƒ½å¼ºå¤§ï¼Œä½†åœ¨æŸäº›åœºæ™¯ä¸‹å­˜åœ¨å±€é™æ€§ã€‚eBPF æä¾›äº†æ›´çµæ´»ã€æ›´ä½å¼€é”€çš„æ€§èƒ½ç›‘æ§æ–¹æ¡ˆã€‚é€šè¿‡å°† eBPF ç¨‹åºæŒ‚è½½åˆ° <code>perf_event</code> ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å†…æ ¸ç©ºé—´ç›´æ¥å¤„ç†æ€§èƒ½äº‹ä»¶ï¼Œå®ç°é«˜æ•ˆçš„è°ƒç”¨æ ˆé‡‡é›†ã€‚</p><p><strong>æ ¸å¿ƒæ€è·¯</strong>ï¼š</p><ol><li>åˆ©ç”¨ <code>perf_event</code> è§¦å‘é‡‡æ ·äº‹ä»¶</li><li>eBPF ç¨‹åºåœ¨å†…æ ¸ä¸­æ•è·äº‹ä»¶å¹¶é‡‡é›†è°ƒç”¨æ ˆä¿¡æ¯</li><li>é€šè¿‡ Ring Buffer é«˜æ•ˆä¼ è¾“æ•°æ®åˆ°ç”¨æˆ·ç©ºé—´</li><li>ç”¨æˆ·ç©ºé—´ç¨‹åºè§£æå¹¶å±•ç¤ºç»“æœ</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#099>#include</span> <span style=color:#099>&#34;vmlinux.h&#34;</span><span style=color:#099>
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#099>#include</span> <span style=color:#099>&lt;bpf/bpf_helpers.h&gt;</span><span style=color:#099>
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#078;font-weight:700>char</span> LICENSE[] <span style=color:#c0f>SEC</span>(<span style=color:#c30>&#34;license&#34;</span>) <span style=color:#555>=</span> <span style=color:#c30>&#34;Dual BSD/GPL&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#099>#ifndef TASK_COMM_LEN
</span></span></span><span style=display:flex><span><span style=color:#099>#define TASK_COMM_LEN 16
</span></span></span><span style=display:flex><span><span style=color:#099>#endif
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#099>#ifndef MAX_STACK_DEPTH
</span></span></span><span style=display:flex><span><span style=color:#099>#define MAX_STACK_DEPTH 128
</span></span></span><span style=display:flex><span><span style=color:#099>#endif
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>typedef</span> __u64 <span style=color:#078;font-weight:700>stack_trace_t</span>[MAX_STACK_DEPTH];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>struct</span> stack_trace_event {
</span></span><span style=display:flex><span>    __u32 pid;
</span></span><span style=display:flex><span>    __u32 cpu_id;
</span></span><span style=display:flex><span>    __u64 timestamp;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>char</span> comm[TASK_COMM_LEN];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    __s32 kstack_sz;
</span></span><span style=display:flex><span>    __s32 ustack_sz;
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>stack_trace_t</span> kstack;
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>stack_trace_t</span> ustack;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#c0f>__uint</span>(type, BPF_MAP_TYPE_RINGBUF);
</span></span><span style=display:flex><span>    <span style=color:#c0f>__uint</span>(max_entries, <span style=color:#f60>256</span> <span style=color:#555>*</span> <span style=color:#f60>1024</span>);
</span></span><span style=display:flex><span>} events <span style=color:#c0f>SEC</span>(<span style=color:#c30>&#34;.maps&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c0f>SEC</span>(<span style=color:#c30>&#34;perf_event&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#078;font-weight:700>int</span> <span style=color:#c0f>profile</span>(<span style=color:#078;font-weight:700>void</span><span style=color:#555>*</span> ctx) {
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>struct</span> stack_trace_event<span style=color:#555>*</span> event <span style=color:#555>=</span>
</span></span><span style=display:flex><span>        <span style=color:#c0f>bpf_ringbuf_reserve</span>(<span style=color:#555>&amp;</span>events, <span style=color:#069;font-weight:700>sizeof</span>(<span style=color:#069;font-weight:700>struct</span> stack_trace_event), <span style=color:#f60>0</span>);
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>if</span> (<span style=color:#555>!</span>event) {
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>return</span> <span style=color:#f60>1</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>int</span> pid <span style=color:#555>=</span> <span style=color:#c0f>bpf_get_current_pid_tgid</span>() <span style=color:#555>&gt;&gt;</span> <span style=color:#f60>32</span>;
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>int</span> cpu_id <span style=color:#555>=</span> <span style=color:#c0f>bpf_get_smp_processor_id</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    event<span style=color:#555>-&gt;</span>pid <span style=color:#555>=</span> pid;
</span></span><span style=display:flex><span>    event<span style=color:#555>-&gt;</span>cpu_id <span style=color:#555>=</span> cpu_id;
</span></span><span style=display:flex><span>    event<span style=color:#555>-&gt;</span>timestamp <span style=color:#555>=</span> <span style=color:#c0f>bpf_ktime_get_ns</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#09f;font-style:italic>// è·å–å½“å‰è¿›ç¨‹å
</span></span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>if</span> (<span style=color:#c0f>bpf_get_current_comm</span>(event<span style=color:#555>-&gt;</span>comm, <span style=color:#069;font-weight:700>sizeof</span>(event<span style=color:#555>-&gt;</span>comm))) {
</span></span><span style=display:flex><span>        event<span style=color:#555>-&gt;</span>comm[<span style=color:#f60>0</span>] <span style=color:#555>=</span> <span style=color:#f60>0</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#09f;font-style:italic>// è·å–å†…æ ¸æ ˆã€ç”¨æˆ·æ ˆä¿¡æ¯
</span></span></span><span style=display:flex><span>    event<span style=color:#555>-&gt;</span>kstack_sz <span style=color:#555>=</span>
</span></span><span style=display:flex><span>        <span style=color:#c0f>bpf_get_stack</span>(ctx, event<span style=color:#555>-&gt;</span>kstack, <span style=color:#069;font-weight:700>sizeof</span>(event<span style=color:#555>-&gt;</span>kstack), <span style=color:#f60>0</span>);
</span></span><span style=display:flex><span>    event<span style=color:#555>-&gt;</span>ustack_sz <span style=color:#555>=</span> <span style=color:#c0f>bpf_get_stack</span>(
</span></span><span style=display:flex><span>        ctx, event<span style=color:#555>-&gt;</span>ustack, <span style=color:#069;font-weight:700>sizeof</span>(event<span style=color:#555>-&gt;</span>ustack), BPF_F_USER_STACK);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c0f>bpf_ringbuf_submit</span>(event, <span style=color:#f60>0</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>return</span> <span style=color:#f60>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>eBPF ç¨‹åºæ‰§è¡Œæµç¨‹</strong>ï¼š</p><ol><li>ç¨‹åºæŒ‚è½½åˆ° <code>perf_event</code>ï¼Œéšæ€§èƒ½è®¡æ•°å™¨ï¼ˆCPU å‘¨æœŸã€æŒ‡ä»¤æ•°ç­‰ï¼‰æˆ–å®šæ—¶å™¨è§¦å‘</li><li>æ¯æ¬¡è§¦å‘æ—¶ï¼ŒeBPF ç¨‹åºåœ¨å†…æ ¸ç©ºé—´æ‰§è¡Œä¸€æ¬¡</li><li>é‡‡é›†å…³é”®æ€§èƒ½æ•°æ®å¹¶é€šè¿‡ Ring Buffer ä¼ è¾“åˆ°ç”¨æˆ·ç©ºé—´</li></ol><p><strong>é‡‡é›†çš„å…³é”®ä¿¡æ¯</strong>ï¼š</p><ol><li><strong>è¿›ç¨‹æ ‡è¯†</strong>ï¼šå½“å‰è¿è¡Œè¿›ç¨‹çš„ PID</li><li><strong>CPU ä¿¡æ¯</strong>ï¼šæ‰§è¡Œä»»åŠ¡çš„ CPU æ ¸å¿ƒç¼–å·</li><li><strong>æ—¶é—´æˆ³</strong>ï¼šäº‹ä»¶å‘ç”Ÿçš„ç²¾ç¡®æ—¶é—´ï¼ˆçº³ç§’çº§ï¼‰</li><li><strong>è¿›ç¨‹å</strong>ï¼šå¯æ‰§è¡Œæ–‡ä»¶åç§°</li><li><strong>æ ˆå›æº¯</strong>ï¼šå†…æ ¸æ ˆå’Œç”¨æˆ·æ ˆçš„å®Œæ•´è°ƒç”¨é“¾</li></ol><p><strong>æ•°æ®ç»“æ„è®¾è®¡</strong>ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#069;font-weight:700>struct</span> stack_trace_event {
</span></span><span style=display:flex><span>    __u32 pid;           <span style=color:#09f;font-style:italic>// è¿›ç¨‹ ID
</span></span></span><span style=display:flex><span>    __u32 cpu_id;        <span style=color:#09f;font-style:italic>// CPU æ ¸å¿ƒç¼–å·
</span></span></span><span style=display:flex><span>    __u64 timestamp;     <span style=color:#09f;font-style:italic>// æ—¶é—´æˆ³ï¼ˆçº³ç§’ï¼‰
</span></span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>char</span> comm[TASK_COMM_LEN];  <span style=color:#09f;font-style:italic>// è¿›ç¨‹å
</span></span></span><span style=display:flex><span>    __s32 kstack_sz;     <span style=color:#09f;font-style:italic>// å†…æ ¸æ ˆå¤§å°
</span></span></span><span style=display:flex><span>    __s32 ustack_sz;     <span style=color:#09f;font-style:italic>// ç”¨æˆ·æ ˆå¤§å°
</span></span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>stack_trace_t</span> kstack; <span style=color:#09f;font-style:italic>// å†…æ ¸æ ˆåœ°å€æ•°ç»„
</span></span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>stack_trace_t</span> ustack; <span style=color:#09f;font-style:italic>// ç”¨æˆ·æ ˆåœ°å€æ•°ç»„
</span></span></span><span style=display:flex><span>};
</span></span></code></pre></div><p><strong>åº”ç”¨ä»·å€¼</strong>ï¼š
é‡‡é›†çš„æ•°æ®ç»è¿‡å¤„ç†åï¼Œå¯ä»¥ç”Ÿæˆ <strong>ç«ç„°å›¾ (Flame Graphs)</strong>ï¼Œç›´è§‚å±•ç¤ºï¼š</p><ol><li><strong>CPU æ¶ˆè€—åˆ†å¸ƒ</strong>ï¼šå“ªä¸ªè¿›ç¨‹/å‡½æ•°å ç”¨æœ€å¤š CPU æ—¶é—´</li><li><strong>è°ƒç”¨é“¾åˆ†æ</strong>ï¼šçƒ­ç‚¹å‡½æ•°çš„å®Œæ•´è°ƒç”¨è·¯å¾„</li><li><strong>å†…æ ¸/ç”¨æˆ·æ€æ¯”ä¾‹</strong>ï¼šç³»ç»Ÿè°ƒç”¨ä¸ä¸šåŠ¡é€»è¾‘çš„æ—¶é—´åˆ†é…</li><li><strong>æ€§èƒ½ç“¶é¢ˆå®šä½</strong>ï¼šå¿«é€Ÿè¯†åˆ«æ€§èƒ½çƒ­ç‚¹å’Œä¼˜åŒ–æœºä¼š</li></ol><h2 id=è§£æé‡‡é›†çš„æ ˆå›æº¯ä¿¡æ¯>è§£æé‡‡é›†çš„æ ˆå›æº¯ä¿¡æ¯<a hidden class=anchor aria-hidden=true href=#è§£æé‡‡é›†çš„æ ˆå›æº¯ä¿¡æ¯>#</a></h2><h3 id=api-è®¾è®¡>API è®¾è®¡<a hidden class=anchor aria-hidden=true href=#api-è®¾è®¡>#</a></h3><p>å®šä¹‰å†…æ ¸è¿”å›çš„ event ç»“æ„ä½“ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#069;font-weight:700>struct</span> <span style=color:#0a8;font-weight:700>StacktraceEvent</span> {
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>uint32_t</span> pid;
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>uint32_t</span> cpu_id;
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>uint64_t</span> timestamp;
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>char</span> comm[TASK_COMM_LEN];
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>int32_t</span> kstack_size;
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>int32_t</span> ustack_size;
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>uint64_t</span> kstack[MAX_STACK_DEPTH];
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>uint64_t</span> ustack[MAX_STACK_DEPTH];
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>å®šä¹‰äº‹ä»¶å¤„ç†å™¨ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#069;font-weight:700>enum</span> <span style=color:#069;font-weight:700>class</span> <span style=color:#0a8;font-weight:700>OutputFormat</span> <span style=color:#555>:</span> <span style=color:#078;font-weight:700>uint8_t</span> { Standard, FoldExtend };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>class</span> <span style=color:#0a8;font-weight:700>EventHandler</span> {
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>public</span><span style=color:#555>:</span>
</span></span><span style=display:flex><span>    EventHandler(OutputFormat fmt) <span style=color:#555>:</span> format(fmt) {
</span></span><span style=display:flex><span>        boot_time_ns <span style=color:#555>=</span> get_boot_time_ns();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#555>~</span>EventHandler() <span style=color:#555>=</span> <span style=color:#069;font-weight:700>default</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>auto</span> <span style=color:#c0f>handle</span>(<span style=color:#069;font-weight:700>const</span> <span style=color:#078;font-weight:700>uint8_t</span><span style=color:#555>*</span> data, size_t len) <span style=color:#555>-&gt;</span> <span style=color:#078;font-weight:700>int</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>void</span> <span style=color:#c0f>show_stack_trace</span>(<span style=color:#069;font-weight:700>const</span> <span style=color:#078;font-weight:700>uint64_t</span><span style=color:#555>*</span> stack, <span style=color:#078;font-weight:700>uint32_t</span> size, <span style=color:#078;font-weight:700>uint32_t</span> pid);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>private</span><span style=color:#555>:</span>
</span></span><span style=display:flex><span>    blaze<span style=color:#555>::</span>Symbolizer symbolizer_;
</span></span><span style=display:flex><span>    OutputFormat format;
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>uint64_t</span> boot_time_ns;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>static</span> <span style=color:#069;font-weight:700>auto</span> <span style=color:#c0f>get_boot_time_ns</span>() <span style=color:#555>-&gt;</span> <span style=color:#078;font-weight:700>uint64_t</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#09f;font-style:italic>// ç¬¦å·åŒ–å †æ ˆå¹¶è¿”å›å­—ç¬¦ä¸²å‘é‡
</span></span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>auto</span> <span style=color:#c0f>symbolize_stack_to_vec</span>(<span style=color:#069;font-weight:700>const</span> <span style=color:#078;font-weight:700>uint64_t</span><span style=color:#555>*</span> stack, <span style=color:#078;font-weight:700>uint32_t</span> stack_sz,
</span></span><span style=display:flex><span>                                <span style=color:#078;font-weight:700>uint32_t</span> pid) <span style=color:#555>-&gt;</span> std<span style=color:#555>::</span>vector<span style=color:#555>&lt;</span>std<span style=color:#555>::</span>string<span style=color:#555>&gt;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>void</span> <span style=color:#c0f>handle_standard</span>(<span style=color:#069;font-weight:700>const</span> StacktraceEvent<span style=color:#555>*</span> event);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>void</span> <span style=color:#c0f>handle_fold_extend</span>(<span style=color:#069;font-weight:700>const</span> StacktraceEvent<span style=color:#555>*</span> event);
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><h3 id=ç¬¦å·åŒ–è§£æå°†åœ°å€è½¬æ¢ä¸ºå‡½æ•°å>ç¬¦å·åŒ–è§£æï¼šå°†åœ°å€è½¬æ¢ä¸ºå‡½æ•°å<a hidden class=anchor aria-hidden=true href=#ç¬¦å·åŒ–è§£æå°†åœ°å€è½¬æ¢ä¸ºå‡½æ•°å>#</a></h3><p>eBPF é‡‡é›†çš„è°ƒç”¨æ ˆä¿¡æ¯æ˜¯å†…å­˜åœ°å€æ•°ç»„ï¼Œéœ€è¦è½¬æ¢ä¸ºå¯è¯»çš„å‡½æ•°åå’Œæºä»£ç ä½ç½®ã€‚è¿™é‡Œä½¿ç”¨ <code>blazesym</code> åº“è¿›è¡Œç¬¦å·åŒ–è§£æï¼Œå¹¶å°è£…ä¸ºæ˜“ç”¨çš„ C++ æ¥å£ã€‚</p><p><strong>ç¬¦å·åŒ–çš„é‡è¦æ€§</strong>ï¼š</p><ul><li>åŸå§‹åœ°å€ï¼ˆå¦‚ <code>0xffffffff81000000</code>ï¼‰å¯¹äººç±»ä¸å‹å¥½</li><li>éœ€è¦è½¬æ¢ä¸ºå‡½æ•°åï¼ˆå¦‚ <code>do_syscall_64</code>ï¼‰å’Œæºä»£ç ä½ç½®</li><li>æ”¯æŒå†…æ ¸ç¬¦å·å’Œç”¨æˆ·ç©ºé—´ç¬¦å·çš„å·®å¼‚åŒ–å¤„ç†</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#099>#ifndef BLAZE_H_
</span></span></span><span style=display:flex><span><span style=color:#099>#define BLAZE_H_
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#099>#include</span> <span style=color:#099>&lt;cstdint&gt;</span><span style=color:#099>
</span></span></span><span style=display:flex><span><span style=color:#099>#include</span> <span style=color:#099>&lt;format&gt;</span><span style=color:#099>
</span></span></span><span style=display:flex><span><span style=color:#099>#include</span> <span style=color:#099>&lt;variant&gt;</span><span style=color:#099>
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#099>#include</span> <span style=color:#099>&lt;blazesym.h&gt;</span><span style=color:#099>
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#099>#include</span> <span style=color:#099>&#34;utils.h&#34;</span><span style=color:#099>
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>namespace</span> blaze {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>struct</span> <span style=color:#0a8;font-weight:700>CodeInfo</span> {
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>const</span> blaze_symbolize_code_info<span style=color:#555>*</span> info_;
</span></span><span style=display:flex><span>    CodeInfo(<span style=color:#069;font-weight:700>const</span> blaze_symbolize_code_info<span style=color:#555>*</span> info) <span style=color:#555>:</span> info_(info) {}
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>struct</span> <span style=color:#0a8;font-weight:700>Syms</span> {
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>const</span> blaze_syms<span style=color:#555>*</span> syms_;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Syms(<span style=color:#069;font-weight:700>const</span> blaze_syms<span style=color:#555>*</span> syms) <span style=color:#555>:</span> syms_(syms) {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#555>~</span>Syms() {
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>if</span> (syms_) {
</span></span><span style=display:flex><span>            blaze_syms_free(syms_);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#09f;font-style:italic>// ç¦æ­¢æ‹·è´ï¼Œé˜²æ­¢åŒé‡é‡Šæ”¾
</span></span></span><span style=display:flex><span>    Syms(<span style=color:#069;font-weight:700>const</span> Syms<span style=color:#555>&amp;</span>) <span style=color:#555>=</span> <span style=color:#069;font-weight:700>delete</span>;
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>auto</span> <span style=color:#069;font-weight:700>operator</span><span style=color:#555>=</span>(<span style=color:#069;font-weight:700>const</span> Syms<span style=color:#555>&amp;</span>) <span style=color:#555>-&gt;</span> Syms<span style=color:#555>&amp;</span> <span style=color:#555>=</span> <span style=color:#069;font-weight:700>delete</span>;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>// ç¬¦å·æº
</span></span></span><span style=display:flex><span><span style=color:#069;font-weight:700>using</span> Source <span style=color:#555>=</span>
</span></span><span style=display:flex><span>    std<span style=color:#555>::</span>variant<span style=color:#555>&lt;</span>blaze_symbolize_src_process, blaze_symbolize_src_kernel<span style=color:#555>&gt;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>struct</span> <span style=color:#0a8;font-weight:700>Input</span> {
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>const</span> <span style=color:#078;font-weight:700>uint64_t</span><span style=color:#555>*</span> addrs_;
</span></span><span style=display:flex><span>    size_t cnt_;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>struct</span> <span style=color:#0a8;font-weight:700>Symbolizer</span> {
</span></span><span style=display:flex><span>    blaze_symbolizer<span style=color:#555>*</span> symbolizer_;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Symbolizer() { symbolizer_ <span style=color:#555>=</span> blaze_symbolizer_new(); }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#555>~</span>Symbolizer() { blaze_symbolizer_free(symbolizer_); }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#309>[[nodiscard]]</span>
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>auto</span> symbolize(Source src, <span style=color:#069;font-weight:700>const</span> Input<span style=color:#555>&amp;</span> input) <span style=color:#069;font-weight:700>const</span> <span style=color:#555>-&gt;</span> Result<span style=color:#555>&lt;</span>Syms<span style=color:#555>&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>if</span> (<span style=color:#555>!</span>input.addrs_ <span style=color:#555>||</span> input.cnt_ <span style=color:#555>==</span> <span style=color:#f60>0</span>) {
</span></span><span style=display:flex><span>            <span style=color:#069;font-weight:700>return</span> Err<span style=color:#555>&lt;&gt;</span>{<span style=color:#c30>&#34;Empty input addresses&#34;</span>};
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>const</span> blaze_syms<span style=color:#555>*</span> syms <span style=color:#555>=</span> <span style=color:#069;font-weight:700>nullptr</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        std<span style=color:#555>::</span>visit(
</span></span><span style=display:flex><span>            Overloaded{
</span></span><span style=display:flex><span>                [<span style=color:#555>&amp;</span>](blaze_symbolize_src_kernel<span style=color:#555>&amp;</span> kern_src) <span style=color:#555>-&gt;</span> <span style=color:#078;font-weight:700>void</span> {
</span></span><span style=display:flex><span>                    syms <span style=color:#555>=</span> blaze_symbolize_kernel_abs_addrs(
</span></span><span style=display:flex><span>                        symbolizer_, <span style=color:#555>&amp;</span>kern_src, input.addrs_, input.cnt_);
</span></span><span style=display:flex><span>                },
</span></span><span style=display:flex><span>                [<span style=color:#555>&amp;</span>](blaze_symbolize_src_process<span style=color:#555>&amp;</span> proc_src) <span style=color:#555>-&gt;</span> <span style=color:#078;font-weight:700>void</span> {
</span></span><span style=display:flex><span>                    syms <span style=color:#555>=</span> blaze_symbolize_process_abs_addrs(
</span></span><span style=display:flex><span>                        symbolizer_, <span style=color:#555>&amp;</span>proc_src, input.addrs_, input.cnt_);
</span></span><span style=display:flex><span>                },
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            src);
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>return</span> syms
</span></span><span style=display:flex><span>                   <span style=color:#555>?</span> Result<span style=color:#555>&lt;</span>Syms<span style=color:#555>&gt;</span>{syms}
</span></span><span style=display:flex><span>                   <span style=color:#555>:</span> Err<span style=color:#555>&lt;&gt;</span>{std<span style=color:#555>::</span>format(<span style=color:#c30>&#34;Symbolization failed, errno is: {}&#34;</span>,
</span></span><span style=display:flex><span>                                       <span style=color:#069;font-weight:700>static_cast</span><span style=color:#555>&lt;</span><span style=color:#078;font-weight:700>int16_t</span><span style=color:#555>&gt;</span>(blaze_err_last()))};
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>inline</span> <span style=color:#069;font-weight:700>auto</span> <span style=color:#c0f>get_symbolize_source</span>(<span style=color:#078;font-weight:700>uint32_t</span> pid) <span style=color:#555>-&gt;</span> blaze<span style=color:#555>::</span>Source {
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>if</span> (pid <span style=color:#555>==</span> <span style=color:#f60>0</span>) {
</span></span><span style=display:flex><span>        blaze_symbolize_src_kernel src{
</span></span><span style=display:flex><span>            .type_size <span style=color:#555>=</span> <span style=color:#069;font-weight:700>sizeof</span>(src),
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>return</span> blaze<span style=color:#555>::</span>Source{src};
</span></span><span style=display:flex><span>    } <span style=color:#069;font-weight:700>else</span> {
</span></span><span style=display:flex><span>        blaze_symbolize_src_process src{
</span></span><span style=display:flex><span>            .type_size <span style=color:#555>=</span> <span style=color:#069;font-weight:700>sizeof</span>(src),
</span></span><span style=display:flex><span>            .pid <span style=color:#555>=</span> pid,
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>return</span> blaze<span style=color:#555>::</span>Source{src};
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}  <span style=color:#09f;font-style:italic>// namespace blaze
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#099>#endif </span><span style=color:#09f;font-style:italic>/* BLAZE_H_ */</span><span style=color:#099>
</span></span></span></code></pre></div><p>å…¶ä¸­çš„ <code>Result</code>ã€<code>Err</code>ã€<code>Overloaded</code> åˆ†åˆ«å€Ÿé‰´äº† Rust ä¸­çš„ <code>Result</code>ã€<code>Err</code> å’Œ <code>match</code>ã€‚</p><p><strong><code>Symbolizer::symbolize</code> ç”¨äºæŠŠç»å¯¹åœ°å€æ•°ç»„ç¬¦å·åŒ–ï¼ˆè½¬æˆç¬¦å·/è°ƒè¯•ä¿¡æ¯ï¼‰</strong>ï¼š</p><ul><li>å¦‚æœÂ <code>input.addrs_</code>Â ä¸º null æˆ–Â <code>input.cnt_ == 0</code>ï¼Œè¿”å›é”™è¯¯Â <code>Err&lt;>{"Empty input addresses"}</code>ã€‚</li><li>æ ¹æ®å‚æ•°Â <code>src</code>ï¼ˆ<code>Source</code>Â æ˜¯Â <code>blaze_symbolize_src_process</code>Â æˆ–Â <code>blaze_symbolize_src_kernel</code>Â çš„Â <code>std::variant</code>ï¼‰è°ƒç”¨ä¸åŒçš„ç¬¦å·åŒ–æ¥å£ï¼š<ul><li>å†…æ ¸æºæ—¶è°ƒç”¨Â <code>blaze_symbolize_kernel_abs_addrs(symbolizer_, &amp;kern_src, input.addrs_, input.cnt_)</code>ï¼›</li><li>è¿›ç¨‹æºæ—¶è°ƒç”¨Â <code>blaze_symbolize_process_abs_addrs(symbolizer_, &amp;proc_src, input.addrs_, input.cnt_)</code>ã€‚
ä½¿ç”¨Â <code>std::visit</code>Â +Â <code>Overloaded</code>Â é€‰æ‹©åˆ†æ”¯ã€‚</li></ul></li><li>ç»“æœå¤„ç†ï¼šæŠŠè¿”å›çš„Â <code>const blaze_syms* syms</code>Â å°è£…è¿›Â <code>Syms</code>ï¼ˆRAIIï¼Œææ„æ—¶ä¼šè°ƒç”¨Â <code>blaze_syms_free</code>ï¼‰ã€‚è‹¥Â <code>syms</code>Â éç©ºåˆ™è¿”å›Â <code>Result&lt;Syms>{syms}</code>ï¼›å¦åˆ™è¿”å›å¸¦æœ‰Â <code>blaze_err_last()</code>ï¼ˆè½¬æ¢ä¸ºæ•´æ•°ï¼‰çš„é”™è¯¯ä¿¡æ¯ã€‚</li></ul><h3 id=äº‹ä»¶å¤„ç†>äº‹ä»¶å¤„ç†<a hidden class=anchor aria-hidden=true href=#äº‹ä»¶å¤„ç†>#</a></h3><p><code>EventHandler::handle</code>Â æ¥æ”¶çš„æ˜¯ä¸€å—â€œåŸå§‹äºŒè¿›åˆ¶ç¼“å†²åŒºâ€ï¼ˆraw bytesï¼‰è€Œä¸æ˜¯å·²ç»è§£æå¥½çš„ç»“æ„ä½“ï¼Œæ‰€ä»¥ç”¨Â <code>const uint8_t* data, size_t len</code>Â æ›´é€šç”¨ã€å®‰å…¨ï¼Œå¹¶ä¸”å…è®¸åœ¨ç”¨æˆ·æ€ä» ring/payloadã€socket æˆ– perf buffer ç­‰æ¥æºç›´æ¥è¯»å–æ•°æ®å¹¶æ£€æŸ¥é•¿åº¦åå†è§£æï¼ˆåœ¨è¿™ä¸ªé¡¹ç›®ä¸­ï¼Œæ•°æ®ä» ringbuf ä¸­è·å–ï¼‰ã€‚</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#069;font-weight:700>auto</span> EventHandler<span style=color:#555>::</span>handle(<span style=color:#069;font-weight:700>const</span> <span style=color:#078;font-weight:700>uint8_t</span><span style=color:#555>*</span> data, size_t len) <span style=color:#555>-&gt;</span> <span style=color:#078;font-weight:700>int</span> {
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>if</span> (len <span style=color:#555>!=</span> <span style=color:#069;font-weight:700>sizeof</span>(StacktraceEvent)) {
</span></span><span style=display:flex><span>        std<span style=color:#555>::</span>println(<span style=color:#c30>&#34;Data length mismatch: expected {}, got {}&#34;</span>,
</span></span><span style=display:flex><span>                     <span style=color:#069;font-weight:700>sizeof</span>(StacktraceEvent),
</span></span><span style=display:flex><span>                     len);
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>return</span> <span style=color:#f60>1</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>const</span> <span style=color:#069;font-weight:700>auto</span><span style=color:#555>*</span> <span style=color:#069;font-weight:700>const</span> event <span style=color:#555>=</span> <span style=color:#069;font-weight:700>reinterpret_cast</span><span style=color:#555>&lt;</span><span style=color:#069;font-weight:700>const</span> StacktraceEvent<span style=color:#555>*&gt;</span>(data);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>if</span> (event<span style=color:#555>-&gt;</span>kstack_size <span style=color:#555>&lt;=</span> <span style=color:#f60>0</span> <span style=color:#555>&amp;&amp;</span> event<span style=color:#555>-&gt;</span>ustack_size <span style=color:#555>&lt;=</span> <span style=color:#f60>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>return</span> <span style=color:#f60>1</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>if</span> (format <span style=color:#555>==</span> OutputFormat<span style=color:#555>::</span>Standard) {
</span></span><span style=display:flex><span>        handle_standard(event);
</span></span><span style=display:flex><span>    } <span style=color:#069;font-weight:700>else</span> {
</span></span><span style=display:flex><span>        handle_fold_extend(event);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>return</span> <span style=color:#f60>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=æ ‡å‡†è¾“å‡ºæ ¼å¼å¯è¯»çš„é€å¸§å±•ç¤º>æ ‡å‡†è¾“å‡ºæ ¼å¼ï¼šå¯è¯»çš„é€å¸§å±•ç¤º<a hidden class=anchor aria-hidden=true href=#æ ‡å‡†è¾“å‡ºæ ¼å¼å¯è¯»çš„é€å¸§å±•ç¤º>#</a></h3><p><code>handle_standard</code> æ–¹æ³•ç”Ÿæˆäººç±»å¯è¯»çš„è°ƒç”¨æ ˆè¾“å‡ºï¼ŒåŒ…å«å®Œæ•´çš„æ—¶é—´æˆ³ã€è¿›ç¨‹ä¿¡æ¯å’Œæºä»£ç ä½ç½®ã€‚è¿™ç§æ ¼å¼é€‚åˆç›´æ¥æŸ¥çœ‹å’Œåˆ†æï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#069;font-weight:700>static</span> <span style=color:#078;font-weight:700>void</span> <span style=color:#c0f>print_frame</span>(<span style=color:#069;font-weight:700>const</span> <span style=color:#078;font-weight:700>char</span><span style=color:#555>*</span> name, Option<span style=color:#555>&lt;</span>AddrInfo<span style=color:#555>&gt;</span> addr_info,
</span></span><span style=display:flex><span>                        <span style=color:#069;font-weight:700>const</span> blaze_symbolize_code_info<span style=color:#555>*</span> code_info) {
</span></span><span style=display:flex><span>    std<span style=color:#555>::</span>string code_str;
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>if</span> (code_info <span style=color:#555>!=</span> <span style=color:#069;font-weight:700>nullptr</span>) {
</span></span><span style=display:flex><span>        <span style=color:#09f;font-style:italic>// path
</span></span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>if</span> ((code_info<span style=color:#555>-&gt;</span>dir <span style=color:#555>!=</span> <span style=color:#069;font-weight:700>nullptr</span>) <span style=color:#555>&amp;&amp;</span> (code_info<span style=color:#555>-&gt;</span>file <span style=color:#555>!=</span> <span style=color:#069;font-weight:700>nullptr</span>)) {
</span></span><span style=display:flex><span>            code_str <span style=color:#555>=</span> std<span style=color:#555>::</span>format(<span style=color:#c30>&#34; {}/{})&#34;</span>, code_info<span style=color:#555>-&gt;</span>dir, code_info<span style=color:#555>-&gt;</span>file);
</span></span><span style=display:flex><span>        } <span style=color:#069;font-weight:700>else</span> <span style=color:#069;font-weight:700>if</span> (code_info<span style=color:#555>-&gt;</span>file <span style=color:#555>!=</span> <span style=color:#069;font-weight:700>nullptr</span>) {
</span></span><span style=display:flex><span>            code_str <span style=color:#555>=</span> code_info<span style=color:#555>-&gt;</span>file;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#09f;font-style:italic>// line and column
</span></span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>if</span> (code_info<span style=color:#555>-&gt;</span>line <span style=color:#555>&gt;</span> <span style=color:#f60>0</span>) {
</span></span><span style=display:flex><span>            code_str <span style=color:#555>+=</span> std<span style=color:#555>::</span>format(<span style=color:#c30>&#34;:{}&#34;</span>, code_info<span style=color:#555>-&gt;</span>line);
</span></span><span style=display:flex><span>            <span style=color:#069;font-weight:700>if</span> (code_info<span style=color:#555>-&gt;</span>column <span style=color:#555>&gt;</span> <span style=color:#f60>0</span>) {
</span></span><span style=display:flex><span>                code_str <span style=color:#555>+=</span> std<span style=color:#555>::</span>format(<span style=color:#c30>&#34;:{}&#34;</span>, code_info<span style=color:#555>-&gt;</span>column);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>if</span> (addr_info.has_value()) {
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>auto</span> [input_addr, addr, offset] <span style=color:#555>=</span> <span style=color:#555>*</span>addr_info;
</span></span><span style=display:flex><span>        std<span style=color:#555>::</span>println(<span style=color:#c30>&#34;0x{:0&gt;{}}: {} @ {:#x} + {:#x}{}&#34;</span>,
</span></span><span style=display:flex><span>                     input_addr,
</span></span><span style=display:flex><span>                     ADDR_WIDTH,
</span></span><span style=display:flex><span>                     (name <span style=color:#555>!=</span> <span style=color:#069;font-weight:700>nullptr</span>) <span style=color:#555>?</span> <span style=color:#99f>name</span> : <span style=color:#c30>&#34;&lt;unknown&gt;&#34;</span>,
</span></span><span style=display:flex><span>                     addr,
</span></span><span style=display:flex><span>                     offset,
</span></span><span style=display:flex><span>                     code_str);
</span></span><span style=display:flex><span>    } <span style=color:#069;font-weight:700>else</span> {
</span></span><span style=display:flex><span>        std<span style=color:#555>::</span>println(<span style=color:#c30>&#34;{:&gt;{}} {}{} [inlined]&#34;</span>, <span style=color:#c30>&#34;&#34;</span>, ADDR_WIDTH, name, code_str);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#078;font-weight:700>void</span> EventHandler<span style=color:#555>::</span>show_stack_trace(<span style=color:#069;font-weight:700>const</span> <span style=color:#078;font-weight:700>uint64_t</span><span style=color:#555>*</span> stack, <span style=color:#078;font-weight:700>uint32_t</span> size,
</span></span><span style=display:flex><span>                                    <span style=color:#078;font-weight:700>uint32_t</span> pid) {
</span></span><span style=display:flex><span>    blaze<span style=color:#555>::</span>Source src <span style=color:#555>=</span> blaze<span style=color:#555>::</span>get_symbolize_source(pid);
</span></span><span style=display:flex><span>    size_t count <span style=color:#555>=</span> <span style=color:#069;font-weight:700>static_cast</span><span style=color:#555>&lt;</span>size_t<span style=color:#555>&gt;</span>(size) <span style=color:#555>/</span> <span style=color:#069;font-weight:700>sizeof</span>(<span style=color:#078;font-weight:700>uint64_t</span>);  <span style=color:#09f;font-style:italic>// æ ˆå¸§æ•°é‡
</span></span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>auto</span> result <span style=color:#555>=</span> symbolizer_.symbolize(
</span></span><span style=display:flex><span>        src, blaze<span style=color:#555>::</span>Input{.addrs_ <span style=color:#555>=</span> stack, .cnt_ <span style=color:#555>=</span> count});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>if</span> (<span style=color:#555>!</span>result) {
</span></span><span style=display:flex><span>        std<span style=color:#555>::</span>println(stderr,
</span></span><span style=display:flex><span>                     <span style=color:#c30>&#34;  Failed to symbolize stack trace. err: {}&#34;</span>,
</span></span><span style=display:flex><span>                     result.error());
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>const</span> <span style=color:#069;font-weight:700>auto</span><span style=color:#555>*</span> syms <span style=color:#555>=</span> result<span style=color:#555>-&gt;</span>syms_;
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>for</span> (size_t i <span style=color:#555>=</span> <span style=color:#f60>0</span>; i <span style=color:#555>&lt;</span> count; <span style=color:#555>++</span>i) {
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>if</span> (i <span style=color:#555>&lt;</span> syms<span style=color:#555>-&gt;</span>cnt <span style=color:#555>&amp;&amp;</span> (syms<span style=color:#555>-&gt;</span>syms[i].name <span style=color:#555>!=</span> <span style=color:#069;font-weight:700>nullptr</span>)) {
</span></span><span style=display:flex><span>            print_frame(
</span></span><span style=display:flex><span>                syms<span style=color:#555>-&gt;</span>syms[i].name,
</span></span><span style=display:flex><span>                Option<span style=color:#555>&lt;</span>AddrInfo<span style=color:#555>&gt;</span>(std<span style=color:#555>::</span>make_tuple(
</span></span><span style=display:flex><span>                    stack[i], syms<span style=color:#555>-&gt;</span>syms[i].addr, syms<span style=color:#555>-&gt;</span>syms[i].offset)),
</span></span><span style=display:flex><span>                <span style=color:#555>&amp;</span>syms<span style=color:#555>-&gt;</span>syms[i].code_info);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#09f;font-style:italic>// æ‰“å°å†…è”å‡½æ•°ä¿¡æ¯
</span></span></span><span style=display:flex><span>            <span style=color:#069;font-weight:700>for</span> (size_t j <span style=color:#555>=</span> <span style=color:#f60>0</span>; j <span style=color:#555>&lt;</span> syms<span style=color:#555>-&gt;</span>syms[i].inlined_cnt; <span style=color:#555>++</span>j) {
</span></span><span style=display:flex><span>                print_frame(syms<span style=color:#555>-&gt;</span>syms[i].inlined[j].name,
</span></span><span style=display:flex><span>                            std<span style=color:#555>::</span>nullopt,
</span></span><span style=display:flex><span>                            <span style=color:#555>&amp;</span>syms<span style=color:#555>-&gt;</span>syms[i].inlined[j].code_info);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        } <span style=color:#069;font-weight:700>else</span> {
</span></span><span style=display:flex><span>            std<span style=color:#555>::</span>println(<span style=color:#c30>&#34;{:&gt;0{}}: &lt;no-symbol&gt;&#34;</span>, stack[i], ADDR_WIDTH);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#078;font-weight:700>void</span> EventHandler<span style=color:#555>::</span>handle_standard(<span style=color:#069;font-weight:700>const</span> StacktraceEvent<span style=color:#555>*</span> event) {
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>uint64_t</span> unix_ns <span style=color:#555>=</span> event<span style=color:#555>-&gt;</span>timestamp <span style=color:#555>+</span> boot_time_ns;
</span></span><span style=display:flex><span>    std<span style=color:#555>::</span>println(<span style=color:#c30>&#34;[{}.{:09} COMM: {} (pid={}) @ CPU {}]&#34;</span>,
</span></span><span style=display:flex><span>                 unix_ns <span style=color:#555>/</span> <span style=color:#f60>1&#39;000&#39;000&#39;000</span>,
</span></span><span style=display:flex><span>                 unix_ns <span style=color:#555>%</span> <span style=color:#f60>1&#39;000&#39;000&#39;000</span>,
</span></span><span style=display:flex><span>                 event<span style=color:#555>-&gt;</span>comm,
</span></span><span style=display:flex><span>                 event<span style=color:#555>-&gt;</span>pid,
</span></span><span style=display:flex><span>                 event<span style=color:#555>-&gt;</span>cpu_id);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#09f;font-style:italic>// æ‰“å°å†…æ ¸æ ˆ
</span></span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>if</span> (event<span style=color:#555>-&gt;</span>kstack_size <span style=color:#555>&gt;</span> <span style=color:#f60>0</span>) {
</span></span><span style=display:flex><span>        std<span style=color:#555>::</span>println(<span style=color:#c30>&#34;Kernel:&#34;</span>);
</span></span><span style=display:flex><span>        show_stack_trace(event<span style=color:#555>-&gt;</span>kstack, event<span style=color:#555>-&gt;</span>kstack_size, <span style=color:#f60>0</span>);
</span></span><span style=display:flex><span>    } <span style=color:#069;font-weight:700>else</span> {
</span></span><span style=display:flex><span>        std<span style=color:#555>::</span>println(<span style=color:#c30>&#34;Kernel: &lt;no stack&gt;&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#09f;font-style:italic>// æ‰“å°ç”¨æˆ·æ ˆ
</span></span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>if</span> (event<span style=color:#555>-&gt;</span>ustack_size <span style=color:#555>&gt;</span> <span style=color:#f60>0</span>) {
</span></span><span style=display:flex><span>        std<span style=color:#555>::</span>println(<span style=color:#c30>&#34;Userspace:&#34;</span>);
</span></span><span style=display:flex><span>        show_stack_trace(event<span style=color:#555>-&gt;</span>ustack, event<span style=color:#555>-&gt;</span>ustack_size, event<span style=color:#555>-&gt;</span>pid);
</span></span><span style=display:flex><span>    } <span style=color:#069;font-weight:700>else</span> {
</span></span><span style=display:flex><span>        std<span style=color:#555>::</span>println(<span style=color:#c30>&#34;Userspace: &lt;no stack&gt;&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    std<span style=color:#555>::</span>println();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=ç«ç„°å›¾æ ¼å¼æœºå™¨å¯è¯»çš„æ•°æ®è¾“å‡º>ç«ç„°å›¾æ ¼å¼ï¼šæœºå™¨å¯è¯»çš„æ•°æ®è¾“å‡º<a hidden class=anchor aria-hidden=true href=#ç«ç„°å›¾æ ¼å¼æœºå™¨å¯è¯»çš„æ•°æ®è¾“å‡º>#</a></h3><p><code>handle_fold_extend</code> ç”ŸæˆæŠ˜å è¡Œï¼ˆ<code>comm-pid;frame;... 1</code>ï¼‰ï¼Œç”¨äºç”Ÿæˆç«ç„°å›¾ï¼ˆFlameGraphï¼‰ã€‚<code>handle_fold_extend</code>Â å¯¹æ¯ä¸ªæ ˆç»“æœåšÂ <code>reverse</code>ï¼ŒæŠŠæ ˆä»â€œæ ¹â€ï¼ˆç¨‹åºå…¥å£ï¼‰åˆ°â€œå¶â€ï¼ˆå½“å‰å¸§ï¼‰æ’åˆ—ï¼Œç¬¦åˆç«ç„°å›¾æœŸæœ›çš„çˆ¶åˆ°å­é¡ºåºã€‚</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#069;font-weight:700>auto</span> EventHandler<span style=color:#555>::</span>symbolize_stack_to_vec(<span style=color:#069;font-weight:700>const</span> <span style=color:#078;font-weight:700>uint64_t</span><span style=color:#555>*</span> stack,
</span></span><span style=display:flex><span>                                          <span style=color:#078;font-weight:700>uint32_t</span> stack_sz, <span style=color:#078;font-weight:700>uint32_t</span> pid)
</span></span><span style=display:flex><span>    <span style=color:#555>-&gt;</span> std<span style=color:#555>::</span>vector<span style=color:#555>&lt;</span>std<span style=color:#555>::</span>string<span style=color:#555>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>if</span> (stack_sz <span style=color:#555>&lt;=</span> <span style=color:#f60>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>return</span> {};
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    blaze<span style=color:#555>::</span>Source src <span style=color:#555>=</span> blaze<span style=color:#555>::</span>get_symbolize_source(pid);
</span></span><span style=display:flex><span>    size_t count <span style=color:#555>=</span> stack_sz <span style=color:#555>/</span> <span style=color:#069;font-weight:700>sizeof</span>(<span style=color:#078;font-weight:700>uint64_t</span>);
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>auto</span> result <span style=color:#555>=</span> symbolizer_.symbolize(
</span></span><span style=display:flex><span>        src, blaze<span style=color:#555>::</span>Input{.addrs_ <span style=color:#555>=</span> stack, .cnt_ <span style=color:#555>=</span> count});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>if</span> (<span style=color:#555>!</span>result) {
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>return</span> {};
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>const</span> <span style=color:#069;font-weight:700>auto</span><span style=color:#555>*</span> syms <span style=color:#555>=</span> result<span style=color:#555>-&gt;</span>syms_;
</span></span><span style=display:flex><span>    std<span style=color:#555>::</span>vector<span style=color:#555>&lt;</span>std<span style=color:#555>::</span>string<span style=color:#555>&gt;</span> vec;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>if</span> (syms <span style=color:#555>==</span> <span style=color:#069;font-weight:700>nullptr</span>) {
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>for</span> (size_t i <span style=color:#555>=</span> <span style=color:#f60>0</span>; i <span style=color:#555>&lt;</span> count; <span style=color:#555>++</span>i) {
</span></span><span style=display:flex><span>            vec.push_back(std<span style=color:#555>::</span>format(<span style=color:#c30>&#34;0x{:x}&#34;</span>, stack[i]));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>return</span> vec;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>for</span> (size_t i <span style=color:#555>=</span> <span style=color:#f60>0</span>; i <span style=color:#555>&lt;</span> syms<span style=color:#555>-&gt;</span>cnt; <span style=color:#555>++</span>i) {
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>if</span> (syms<span style=color:#555>-&gt;</span>syms[i].name <span style=color:#555>!=</span> <span style=color:#069;font-weight:700>nullptr</span>) {
</span></span><span style=display:flex><span>            vec.emplace_back(syms<span style=color:#555>-&gt;</span>syms[i].name);
</span></span><span style=display:flex><span>        } <span style=color:#069;font-weight:700>else</span> {
</span></span><span style=display:flex><span>            vec.push_back(std<span style=color:#555>::</span>format(<span style=color:#c30>&#34;0x{:x}&#34;</span>, stack[i]));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>return</span> vec;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#078;font-weight:700>void</span> EventHandler<span style=color:#555>::</span>handle_fold_extend(<span style=color:#069;font-weight:700>const</span> StacktraceEvent<span style=color:#555>*</span> event) {
</span></span><span style=display:flex><span>    std<span style=color:#555>::</span>vector<span style=color:#555>&lt;</span>std<span style=color:#555>::</span>string<span style=color:#555>&gt;</span> stack_frames;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#09f;font-style:italic>// ä¸ºäº†è®©ç«ç„°å›¾èƒ½å¤ŸæŒ‰è¿›ç¨‹èšåˆï¼Œå°† &#34;comm-pid&#34; ä½œä¸ºæ ˆåº•
</span></span></span><span style=display:flex><span>    stack_frames.push_back(std<span style=color:#555>::</span>format(<span style=color:#c30>&#34;{}-{}&#34;</span>, event<span style=color:#555>-&gt;</span>comm, event<span style=color:#555>-&gt;</span>pid));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#09f;font-style:italic>// å¤„ç†ç”¨æˆ·æ€
</span></span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>if</span> (event<span style=color:#555>-&gt;</span>ustack_size <span style=color:#555>&gt;</span> <span style=color:#f60>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>auto</span> user_frames <span style=color:#555>=</span> symbolize_stack_to_vec(
</span></span><span style=display:flex><span>            event<span style=color:#555>-&gt;</span>ustack, event<span style=color:#555>-&gt;</span>ustack_size, event<span style=color:#555>-&gt;</span>pid);
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>for</span> (<span style=color:#069;font-weight:700>const</span> <span style=color:#069;font-weight:700>auto</span><span style=color:#555>&amp;</span> <span style=color:#99f>frame</span> : user_frames <span style=color:#555>|</span> std<span style=color:#555>::</span>views<span style=color:#555>::</span>reverse) {
</span></span><span style=display:flex><span>            stack_frames.push_back(frame);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#09f;font-style:italic>// å¤„ç†å†…æ ¸æ€
</span></span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>if</span> (event<span style=color:#555>-&gt;</span>kstack_size <span style=color:#555>&gt;</span> <span style=color:#f60>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>auto</span> kern_frames <span style=color:#555>=</span>
</span></span><span style=display:flex><span>            symbolize_stack_to_vec(event<span style=color:#555>-&gt;</span>kstack, event<span style=color:#555>-&gt;</span>kstack_size, <span style=color:#f60>0</span>);
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>for</span> (<span style=color:#069;font-weight:700>const</span> <span style=color:#069;font-weight:700>auto</span><span style=color:#555>&amp;</span> <span style=color:#99f>frame</span> : kern_frames <span style=color:#555>|</span> std<span style=color:#555>::</span>views<span style=color:#555>::</span>reverse) {
</span></span><span style=display:flex><span>            stack_frames.push_back(frame <span style=color:#555>+</span> <span style=color:#c30>&#34;_[k]&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>auto</span> temp <span style=color:#555>=</span> stack_frames <span style=color:#555>|</span> std<span style=color:#555>::</span>views<span style=color:#555>::</span>join_with(<span style=color:#c30>&#39;;&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#09f;font-style:italic>// è¾“å‡ºæ ¼å¼ï¼šstack;frames 1
</span></span></span><span style=display:flex><span>    <span style=color:#09f;font-style:italic>// FlameGraph å·¥å…·æœŸæœ›æ¯è¡Œä»¥ç©ºæ ¼å’Œæ•°å­—ç»“å°¾
</span></span></span><span style=display:flex><span>    std<span style=color:#555>::</span>println(<span style=color:#c30>&#34;{} 1&#34;</span>, temp <span style=color:#555>|</span> std<span style=color:#555>::</span>ranges<span style=color:#555>::</span>to<span style=color:#555>&lt;</span>std<span style=color:#555>::</span>string<span style=color:#555>&gt;</span>());
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=æµç¨‹å›¾>æµç¨‹å›¾<a hidden class=anchor aria-hidden=true href=#æµç¨‹å›¾>#</a></h3><pre tabindex=0><code class=language-mermaid data-lang=mermaid>flowchart TD
  A[eBPF ç¨‹åºï¼ˆå†…æ ¸ï¼‰
    é‡‡é›† stacktrace
  ] --&gt; B[Userspace reader
    æ¥æ”¶ StacktraceEvent]
  B --&gt; C[EventHandler::handle
    æ ¡éªŒ &amp; é€‰æ‹©è¾“å‡ºæ ¼å¼]
  C --&gt; D{æœ‰ ustack?}
  C --&gt; E{æœ‰ kstack?}
  D -- yes --&gt; U1[&#34;æ„é€  blaze::Source (process)
    æ„é€  blaze::Input(addrs,cnt)&#34;]
  E -- yes --&gt; K1[&#34;æ„é€  blaze::Source (kernel)
    æ„é€  blaze::Input(addrs,cnt)&#34;]
  U1 --&gt; S1[&#34;Symbolizer::symbolize
    (std::visit -&gt; process API)&#34;]
  K1 --&gt; S2[&#34;Symbolizer::symbolize
    (std::visit -&gt; kernel API)&#34;]
  S1 --&gt; F{symbolize æˆåŠŸ?}
  S2 --&gt; F
  F -- yes --&gt; G[è¿”å› Symsï¼ˆRAIIï¼‰]
  F -- no --&gt; H[&#34;è¿”å› Err
    è®°å½• blaze_err_last() -&gt; fallback: æ‰“å°åŸå§‹åœ°å€&#34;]
  G --&gt; P1[show_stack_trace
    é€å¸§æ‰“å°ï¼ˆå«å†…è”ï¼‰]
  G --&gt; P2[symbolize_stack_to_vec
            ç”ŸæˆæŠ˜å å¸§å‘é‡]
  P2 --&gt; M[ç»„è£…æŠ˜å è¡Œ -&gt; è¾“å‡ºç»™ FlameGraph]
  P1 --&gt; O[æ ‡å‡†å¯è¯»è¾“å‡º]
  H --&gt; O2[æ‰“å°åŸå§‹åœ°å€ / è®°å½•é”™è¯¯æ—¥å¿—]
  style U1 fill:#e6ffed,stroke:#2d9a3b
  style K1 fill:#e6f0ff,stroke:#2176d2
  style H fill:#fff1f0,stroke:#d9534f
</code></pre><h2 id=å¯åŠ¨ä¸äº‹ä»¶å¾ªç¯>å¯åŠ¨ä¸äº‹ä»¶å¾ªç¯<a hidden class=anchor aria-hidden=true href=#å¯åŠ¨ä¸äº‹ä»¶å¾ªç¯>#</a></h2><p>è¿™ä¸€èŠ‚æè¿°ç”¨æˆ·æ€ç¨‹åºå¦‚ä½•å®Œæˆå¯åŠ¨å‡†å¤‡å¹¶è¿›å…¥äº‹ä»¶è½®è¯¢ï¼šè§£æå‘½ä»¤è¡Œä¸æ—¥å¿—çº§åˆ«ã€æå‡å¿…è¦çš„èµ„æºé™åˆ¶ã€åŠ è½½å¹¶ attach eBPF ç¨‹åºã€é€šè¿‡ ring buffer æ¥æ”¶å†…æ ¸äº‹ä»¶ã€è°ƒç”¨ <code>EventHandler</code> è¿›è¡Œè§£æè¾“å‡ºï¼Œä»¥åŠåœ¨æ¥æ”¶åˆ°ä¿¡å·æ—¶ä¼˜é›…é€€å‡ºã€‚</p><h3 id=å…³é”®ä¾èµ–ä¸æƒé™>å…³é”®ä¾èµ–ä¸æƒé™<a hidden class=anchor aria-hidden=true href=#å…³é”®ä¾èµ–ä¸æƒé™>#</a></h3><p>ä¾èµ–é¡¹ï¼š<code>libbpf</code>ï¼ˆåŠ è½½ BPF å¯¹è±¡ä¸ mapsï¼‰ã€<code>spdlog</code>ï¼ˆæ—¥å¿—ï¼‰ã€<code>CLI11</code>ï¼ˆå‘½ä»¤è¡Œè§£æï¼‰ã€å¯é€‰çš„å†…æ ¸ BTF / <code>vmlinux</code>ï¼ˆç”¨äºå†…æ ¸ç¬¦å·åŒ–ï¼‰ã€‚</p><p>è¿è¡Œæƒé™ï¼šé€šå¸¸éœ€è¦ root æˆ–è‡³å°‘ <code>CAP_BPF</code>/<code>CAP_SYS_ADMIN</code>ã€‚å¦å¤–å¿…é¡»æå‡ <code>RLIMIT_MEMLOCK</code>ï¼Œå¦åˆ™å†…æ ¸ä¼šå› ä¸ºæ— æ³•é”å®šå†…å­˜è€Œæ‹’ç»åŠ è½½ BPF å¯¹è±¡ã€‚</p><p>å»ºè®®åœ¨å¯åŠ¨å‰åšæœ€åŸºæœ¬çš„ç¯å¢ƒæ£€æŸ¥ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-bash data-lang=bash><span style=display:flex><span>uname -r
</span></span><span style=display:flex><span>which bpftool
</span></span></code></pre></div><h3 id=å‘½ä»¤è¡Œä¸æ—¥å¿—åˆå§‹åŒ–>å‘½ä»¤è¡Œä¸æ—¥å¿—åˆå§‹åŒ–<a hidden class=anchor aria-hidden=true href=#å‘½ä»¤è¡Œä¸æ—¥å¿—åˆå§‹åŒ–>#</a></h3><p>ä½¿ç”¨ <code>CLI11</code> è§£æé‡‡æ ·é¢‘ç‡ï¼ˆ<code>-f</code>ï¼‰ã€PID è¿‡æ»¤ï¼ˆ<code>-p</code>ï¼‰ã€è¾“å‡ºæ ¼å¼ï¼ˆ<code>-E</code>ï¼‰ç­‰é€‰é¡¹ï¼Œå¹¶ä½¿ç”¨ <code>spdlog</code> é…ç½®é»˜è®¤æ—¥å¿—å™¨ä¸æ—¥å¿—ç­‰çº§ã€‚ç¤ºä¾‹ä»£ç ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-cpp data-lang=cpp><span style=display:flex><span>CLI<span style=color:#555>::</span>App app{<span style=color:#c30>&#34;A simple profiler using eBPF&#34;</span>};
</span></span><span style=display:flex><span>Args args;
</span></span><span style=display:flex><span>app.add_option(<span style=color:#c30>&#34;-f,--freq&#34;</span>, args.freq, <span style=color:#c30>&#34;Sampling frequency&#34;</span>)<span style=color:#555>-&gt;</span>default_val(<span style=color:#f60>10</span>);
</span></span><span style=display:flex><span>app.add_flag(<span style=color:#c30>&#34;-E,--fold-extend&#34;</span>, args.fold_extend, <span style=color:#c30>&#34;Output in extended folded format&#34;</span>);
</span></span><span style=display:flex><span>CLI11_PARSE(app, argc, argv);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>using</span> Level <span style=color:#555>=</span> spdlog<span style=color:#555>::</span>level<span style=color:#555>::</span>level_enum;
</span></span><span style=display:flex><span>Level level <span style=color:#555>=</span> (args.verbosity <span style=color:#555>==</span> <span style=color:#f60>0</span>) <span style=color:#555>?</span> Level<span style=color:#555>::</span><span style=color:#99f>warn</span> : (args.verbosity<span style=color:#555>==</span><span style=color:#f60>1</span> <span style=color:#555>?</span> Level<span style=color:#555>::</span><span style=color:#99f>info</span> : Level<span style=color:#555>::</span>debug);
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>auto</span> console <span style=color:#555>=</span> spdlog<span style=color:#555>::</span>stdout_color_mt(<span style=color:#c30>&#34;console&#34;</span>);
</span></span><span style=display:flex><span>spdlog<span style=color:#555>::</span>set_default_logger(console);
</span></span><span style=display:flex><span>spdlog<span style=color:#555>::</span>set_level(level);
</span></span></code></pre></div><p>å°†æ—¥å¿—çº§åˆ«ä¸å‘½ä»¤è¡Œç»‘å®šï¼Œä¾¿äºåœ¨è°ƒè¯•æ—¶æŸ¥çœ‹è¯¦ç»†ç¬¦å·åŒ–é”™è¯¯æˆ–åœ¨ç”Ÿäº§æ—¶é™ä½è¾“å‡ºå™ªéŸ³ã€‚</p><h3 id=æå‡èµ„æºé™åˆ¶rlimit_memlock>æå‡èµ„æºé™åˆ¶ï¼ˆ<code>RLIMIT_MEMLOCK</code>ï¼‰<a hidden class=anchor aria-hidden=true href=#æå‡èµ„æºé™åˆ¶rlimit_memlock>#</a></h3><p>BPF å¯¹è±¡å’Œ ring buffer éœ€è¦è¢«å†…æ ¸é”å®šåœ¨å†…å­˜ã€‚æ¨èå°† <code>RLIMIT_MEMLOCK</code> è®¾ä¸ºæ— é™ä»¥é¿å…åŠ è½½å¤±è´¥ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-cpp data-lang=cpp><span style=display:flex><span>rlimit rl <span style=color:#555>=</span> {.rlim_cur <span style=color:#555>=</span> RLIM_INFINITY, .rlim_max <span style=color:#555>=</span> RLIM_INFINITY};
</span></span><span style=display:flex><span>setrlimit(RLIMIT_MEMLOCK, <span style=color:#555>&amp;</span>rl);
</span></span></code></pre></div><p>åœ¨å—é™ç¯å¢ƒä¸‹ï¼ˆå®¹å™¨ã€å—é™ç”¨æˆ·ï¼‰åº”æå‰ç¡®è®¤æ˜¯å¦å…è®¸ä¿®æ”¹è¯¥é™åˆ¶ã€‚</p><h3 id=åŠ è½½å¹¶ç®¡ç†-bpf-å¯¹è±¡profilerskel>åŠ è½½å¹¶ç®¡ç† BPF å¯¹è±¡ï¼ˆ<code>ProfilerSkel</code>ï¼‰<a hidden class=anchor aria-hidden=true href=#åŠ è½½å¹¶ç®¡ç†-bpf-å¯¹è±¡profilerskel>#</a></h3><p>é€šè¿‡ bpf çš„ skeletonï¼ˆä¾‹å¦‚ <code>profiler_bpf</code>ï¼‰ç”Ÿæˆçš„å°è£…ï¼Œä½¿ç”¨ RAII ç®¡ç†ç”Ÿå‘½å‘¨æœŸï¼šopen/load åœ¨æ„é€ æ—¶å®Œæˆï¼Œèµ„æºåœ¨ææ„æ—¶é‡Šæ”¾ã€‚è‹¥åŠ è½½å¤±è´¥ï¼Œåº”ç«‹å³è®°å½•é”™è¯¯å¹¶é€€å‡ºã€‚</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#069;font-weight:700>struct</span> <span style=color:#0a8;font-weight:700>ProfilerSkel</span> {
</span></span><span style=display:flex><span>    profiler_bpf<span style=color:#555>*</span> obj{<span style=color:#069;font-weight:700>nullptr</span>};
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    ProfilerSkel() { obj <span style=color:#555>=</span> profiler_bpf<span style=color:#555>::</span>open_and_load(); <span style=color:#069;font-weight:700>if</span> (obj <span style=color:#555>==</span> <span style=color:#069;font-weight:700>nullptr</span>) spdlog<span style=color:#555>::</span>error(<span style=color:#c30>&#34;Failed to open and load BPF object&#34;</span>); }
</span></span><span style=display:flex><span>    <span style=color:#555>~</span>ProfilerSkel() { <span style=color:#069;font-weight:700>if</span> (obj) profiler_bpf__destroy(obj); }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>operator</span> <span style=color:#c0f>bool</span>() <span style=color:#069;font-weight:700>const</span> { <span style=color:#069;font-weight:700>return</span> obj <span style=color:#555>!=</span> <span style=color:#069;font-weight:700>nullptr</span>; }
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>auto</span> <span style=color:#069;font-weight:700>operator</span><span style=color:#555>-&gt;</span>() <span style=color:#069;font-weight:700>const</span> <span style=color:#555>-&gt;</span> profiler_bpf<span style=color:#555>*</span> { <span style=color:#069;font-weight:700>return</span> obj; }
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>åœ¨åŠ è½½æˆåŠŸåï¼Œè¿˜å¯èƒ½éœ€è¦å¯¹ map è¿›è¡Œé¢„åˆå§‹åŒ–ï¼ˆä¾‹å¦‚è®¾ç½® PID è¿‡æ»¤å™¨ï¼‰æˆ–ä¸º symbolization æä¾› vmlinux è·¯å¾„ã€‚</p><h3 id=åˆå§‹åŒ–-perf-äº‹ä»¶å¹¶-attach>åˆå§‹åŒ– perf äº‹ä»¶å¹¶ attach<a hidden class=anchor aria-hidden=true href=#åˆå§‹åŒ–-perf-äº‹ä»¶å¹¶-attach>#</a></h3><p>æ ¹æ®é…ç½®ï¼ˆé‡‡æ ·é¢‘ç‡ã€æ˜¯å¦ä½¿ç”¨è½¯ä»¶äº‹ä»¶ã€æ˜¯å¦æŒ‰ PID è¿‡æ»¤ç­‰ï¼‰åˆ›å»º perf event æ–‡ä»¶æè¿°ç¬¦å¹¶è¿”å›ç»™è°ƒç”¨æ–¹ï¼›éšåå°†è¿™äº› fd attach åˆ° eBPF ç¨‹åºçš„ entryï¼ˆä¾‹å¦‚ <code>profile</code>ï¼‰ä¸Šã€‚åˆå§‹åŒ–å¤±è´¥æ—¶åº”å½“è®°å½•å¹¶é€€å‡ºã€‚</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#09f;font-style:italic>// perf.cpp
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>auto</span> <span style=color:#c0f>init_perf_monitor</span>(<span style=color:#078;font-weight:700>uint64_t</span> freq, <span style=color:#078;font-weight:700>bool</span> sw_event, pid_t pid <span style=color:#555>=</span> <span style=color:#555>-</span><span style=color:#f60>1</span>)
</span></span><span style=display:flex><span>    <span style=color:#555>-&gt;</span> Result<span style=color:#555>&lt;</span>std<span style=color:#555>::</span>vector<span style=color:#555>&lt;</span><span style=color:#078;font-weight:700>int</span><span style=color:#555>&gt;</span>, libbpf_errno<span style=color:#555>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>int</span> cpus <span style=color:#555>=</span> libbpf_num_possible_cpus();
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>if</span> (cpus <span style=color:#555>&lt;</span> <span style=color:#f60>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>return</span> Err(libbpf_errno<span style=color:#555>::</span>LIBBPF_ERRNO__INTERNAL);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    perf_event_attr attr <span style=color:#555>=</span> {
</span></span><span style=display:flex><span>        .type <span style=color:#555>=</span> sw_event <span style=color:#555>?</span> <span style=color:#99f>PERF_TYPE_SOFTWARE</span> : PERF_TYPE_HARDWARE,  <span style=color:#09f;font-style:italic>// é‡‡æ ·ç±»å‹
</span></span></span><span style=display:flex><span>        .size <span style=color:#555>=</span> <span style=color:#069;font-weight:700>sizeof</span>(perf_event_attr),
</span></span><span style=display:flex><span>        .config <span style=color:#555>=</span> (sw_event <span style=color:#555>?</span> <span style=color:#069;font-weight:700>static_cast</span><span style=color:#555>&lt;</span><span style=color:#078;font-weight:700>uint64_t</span><span style=color:#555>&gt;</span>(PERF_COUNT_SW_CPU_CLOCK)
</span></span><span style=display:flex><span>                            <span style=color:#555>:</span> <span style=color:#069;font-weight:700>static_cast</span><span style=color:#555>&lt;</span><span style=color:#078;font-weight:700>uint64_t</span><span style=color:#555>&gt;</span>(PERF_COUNT_HW_CPU_CYCLES)),
</span></span><span style=display:flex><span>        .sample_freq <span style=color:#555>=</span> freq,  <span style=color:#09f;font-style:italic>// è®¾ç½®é¢‘ç‡ï¼Œæ¯ç§’ freq æ¬¡é‡‡æ ·
</span></span></span><span style=display:flex><span>        .freq <span style=color:#555>=</span> <span style=color:#f60>1</span>,            <span style=color:#09f;font-style:italic>// æ ‡å¿—ä½ï¼šè®¾ä¸º 1 è¡¨ç¤ºä½¿ç”¨ sample_freq
</span></span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    std<span style=color:#555>::</span>vector<span style=color:#555>&lt;</span><span style=color:#078;font-weight:700>int</span><span style=color:#555>&gt;</span> fds;
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>for</span> (<span style=color:#078;font-weight:700>int</span> cpu <span style=color:#555>=</span> <span style=color:#f60>0</span>; cpu <span style=color:#555>&lt;</span> cpus; <span style=color:#555>++</span>cpu) {
</span></span><span style=display:flex><span>        <span style=color:#078;font-weight:700>int</span> fd <span style=color:#555>=</span> <span style=color:#069;font-weight:700>static_cast</span><span style=color:#555>&lt;</span><span style=color:#078;font-weight:700>int</span><span style=color:#555>&gt;</span>(perf_event_open(<span style=color:#555>&amp;</span>attr, pid, cpu, <span style=color:#555>-</span><span style=color:#f60>1</span>, <span style=color:#f60>0</span>));
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>if</span> (fd <span style=color:#555>&lt;</span> <span style=color:#f60>0</span>) {
</span></span><span style=display:flex><span>            <span style=color:#069;font-weight:700>return</span> Err(libbpf_errno<span style=color:#555>::</span>LIBBPF_ERRNO__INTERNAL);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        fds.push_back(fd);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>return</span> fds;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>auto</span> <span style=color:#c0f>attach_perf_events</span>(<span style=color:#069;font-weight:700>const</span> std<span style=color:#555>::</span>vector<span style=color:#555>&lt;</span><span style=color:#078;font-weight:700>int</span><span style=color:#555>&gt;&amp;</span> fds, bpf_program<span style=color:#555>*</span> prog)
</span></span><span style=display:flex><span>    <span style=color:#555>-&gt;</span> std<span style=color:#555>::</span>vector<span style=color:#555>&lt;</span>Result<span style=color:#555>&lt;</span>bpf_link<span style=color:#555>*</span>, libbpf_errno<span style=color:#555>&gt;&gt;</span> {
</span></span><span style=display:flex><span>    std<span style=color:#555>::</span>vector<span style=color:#555>&lt;</span>Result<span style=color:#555>&lt;</span>bpf_link<span style=color:#555>*</span>, libbpf_errno<span style=color:#555>&gt;&gt;</span> links;
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>for</span> (<span style=color:#078;font-weight:700>int</span> <span style=color:#99f>fd</span> : fds) {
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>auto</span><span style=color:#555>*</span> link <span style=color:#555>=</span> bpf_program__attach_perf_event(prog, fd);
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>if</span> (libbpf_get_error(link) <span style=color:#555>!=</span> <span style=color:#f60>0</span>) {
</span></span><span style=display:flex><span>            links.emplace_back(Err(libbpf_errno<span style=color:#555>::</span>LIBBPF_ERRNO__INTERNAL));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        links.emplace_back(link);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>return</span> links;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>// ---------------------------------------------------------------
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>// main.cpp
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>auto</span> perf_fds <span style=color:#555>=</span> init_perf_monitor(freq, args.sw_event, args.pid);
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>if</span> (<span style=color:#555>!</span>perf_fds) { 
</span></span><span style=display:flex><span>    spdlog<span style=color:#555>::</span>error(<span style=color:#c30>&#34;Failed to initialize perf monitor&#34;</span>); 
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>return</span> <span style=color:#f60>1</span>; 
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>attach_perf_events(perf_fds.value(), obj<span style=color:#555>-&gt;</span>progs.profile);
</span></span></code></pre></div><p>attach æˆåŠŸåï¼Œå†…æ ¸é‡‡æ ·äº‹ä»¶è§¦å‘æ—¶ä¼šè¿›å…¥ eBPF ç¨‹åºï¼Œç¨‹åºä¼šæŠŠæ•°æ®å†™å…¥ä¹‹å‰å£°æ˜çš„ ring buffer mapã€‚</p><h3 id=ring-buffer-ä¸äº‹ä»¶å›è°ƒ>Ring Buffer ä¸äº‹ä»¶å›è°ƒ<a hidden class=anchor aria-hidden=true href=#ring-buffer-ä¸äº‹ä»¶å›è°ƒ>#</a></h3><p>ç”¨æˆ·æ€é€šè¿‡ ring buffer ä»å†…æ ¸è¯»å–äº‹ä»¶æ ·æœ¬ã€‚å›è°ƒå‡½æ•°è´Ÿè´£ç±»å‹å®‰å…¨åœ°æŠŠåŸå§‹å­—èŠ‚ä¼ é€’ç»™ <code>EventHandler::handle</code>ï¼Œç”±å…¶å®Œæˆé•¿åº¦æ£€æŸ¥ã€è§£æä¸è¾“å‡ºã€‚</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#069;font-weight:700>static</span> <span style=color:#069;font-weight:700>auto</span> <span style=color:#c0f>handle_event_wrapper</span>(<span style=color:#078;font-weight:700>void</span><span style=color:#555>*</span> ctx, <span style=color:#078;font-weight:700>void</span><span style=color:#555>*</span> data, size_t data_sz) <span style=color:#555>-&gt;</span> <span style=color:#078;font-weight:700>int</span> {
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>auto</span><span style=color:#555>*</span> handler <span style=color:#555>=</span> <span style=color:#069;font-weight:700>static_cast</span><span style=color:#555>&lt;</span>EventHandler<span style=color:#555>*&gt;</span>(ctx);
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>return</span> handler<span style=color:#555>-&gt;</span>handle(<span style=color:#069;font-weight:700>static_cast</span><span style=color:#555>&lt;</span><span style=color:#069;font-weight:700>const</span> <span style=color:#078;font-weight:700>uint8_t</span><span style=color:#555>*&gt;</span>(data), data_sz);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>RingBuffer rb{bpf_map__fd(obj<span style=color:#555>-&gt;</span>maps.events), handle_event_wrapper, <span style=color:#555>&amp;</span>event_handler, <span style=color:#069;font-weight:700>nullptr</span>};
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>if</span> (<span style=color:#555>!</span>rb) { 
</span></span><span style=display:flex><span>    spdlog<span style=color:#555>::</span>error(<span style=color:#c30>&#34;Failed to create ring buffer&#34;</span>); 
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>return</span> <span style=color:#f60>1</span>; 
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¦ç‚¹ï¼š</p><ul><li>å›è°ƒç­¾åä½¿ç”¨ <code>const uint8_t* data, size_t data_sz</code>ï¼Œæœ‰åˆ©äºåœ¨ç”¨æˆ·æ€å¯¹æ¥è‡ªä¸åŒæ¥æºï¼ˆringbufã€perf bufferã€socket ç­‰ï¼‰çš„åŸå§‹å­—èŠ‚æµåšç»Ÿä¸€å¤„ç†å’Œè¾¹ç•Œæ ¡éªŒï¼›</li><li>ring buffer çš„å®¹é‡åº”æ ¹æ®é‡‡æ ·é¢‘ç‡ä¸å¤„ç†é€Ÿç‡è°ƒæ•´ï¼Œé¿å…ä¸¢å¤±æ ·æœ¬ã€‚</li></ul><h3 id=ä¸»å¾ªç¯è½®è¯¢ä¸ä¼˜é›…é€€å‡º>ä¸»å¾ªç¯ã€è½®è¯¢ä¸ä¼˜é›…é€€å‡º<a hidden class=anchor aria-hidden=true href=#ä¸»å¾ªç¯è½®è¯¢ä¸ä¼˜é›…é€€å‡º>#</a></h3><p>ä¸»å¾ªç¯è´Ÿè´£è½®è¯¢ ring bufferï¼Œå¹¶åœ¨æ¥æ”¶åˆ°ä¸­æ–­ä¿¡å·æ—¶ä¼˜é›…é€€å‡ºï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#069;font-weight:700>static</span> <span style=color:#069;font-weight:700>volatile</span> <span style=color:#078;font-weight:700>bool</span> exiting <span style=color:#555>=</span> <span style=color:#366>false</span>;
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>static</span> <span style=color:#078;font-weight:700>void</span> <span style=color:#c0f>sig_handler</span>(<span style=color:#078;font-weight:700>int</span> sig) { exiting <span style=color:#555>=</span> <span style=color:#366>true</span>; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>signal(SIGINT, sig_handler);
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>while</span> (<span style=color:#555>!</span>exiting) {
</span></span><span style=display:flex><span>    <span style=color:#078;font-weight:700>int</span> err <span style=color:#555>=</span> rb.poll(<span style=color:#f60>100</span>);
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>if</span> (err <span style=color:#555>==</span> <span style=color:#555>-</span>EINTR) {
</span></span><span style=display:flex><span>        <span style=color:#09f;font-style:italic>// Interrupted by signal, continue to check exiting flag
</span></span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>continue</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>if</span> (err <span style=color:#555>&lt;</span> <span style=color:#f60>0</span>) {
</span></span><span style=display:flex><span>        spdlog<span style=color:#555>::</span>error(<span style=color:#c30>&#34;Error polling ring buffer: {}&#34;</span>, err);
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>break</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>auto</span> r <span style=color:#555>=</span> close_perf_events(perf_fds.value());
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>if</span> (<span style=color:#555>!</span>r) {
</span></span><span style=display:flex><span>    spdlog<span style=color:#555>::</span>error(<span style=color:#c30>&#34;Failed to close perf events, error message is: {}&#34;</span>,
</span></span><span style=display:flex><span>                  <span style=color:#069;font-weight:700>static_cast</span><span style=color:#555>&lt;</span><span style=color:#078;font-weight:700>int</span><span style=color:#555>&gt;</span>(r.error()));
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>return</span> <span style=color:#f60>1</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>é€€å‡ºæµç¨‹è¦ç‚¹ï¼š</p><ul><li>signal handler ä»…è®¾ç½®åŸå­/æ˜“å˜æ ‡å¿—ï¼Œå®é™…æ¸…ç†åœ¨ä¸»çº¿ç¨‹å®Œæˆï¼›</li><li>è°ƒç”¨ <code>close_perf_events</code> å…³é—­ perf fdsï¼Œç¡®ä¿å…§æ ¸è®¡æ•°å™¨åœæ­¢å¹¶é‡Šæ”¾èµ„æºï¼›</li><li>ä¾èµ– RAII çš„ BPF skeleton åœ¨ä½œç”¨åŸŸç»“æŸæ—¶é”€æ¯ BPF å¯¹è±¡å’Œ mapsã€‚</li></ul><p>è¿™æ ·å¯ä»¥ä¿è¯åœ¨æ”¶åˆ° SIGINT / SIGTERM æ—¶ï¼Œç¨‹åºèƒ½å¤Ÿå°½é‡æŠŠå·²ç»åˆ°è¾¾çš„æ ·æœ¬å¤„ç†å®Œå¹¶æ­£ç¡®é‡Šæ”¾æ‰€æœ‰å†…æ ¸èµ„æºã€‚</p><h2 id=å¯¹-ebpf-ç¨‹åºæŒ‚è½½æ–¹å¼çš„æ€è€ƒ>å¯¹ eBPF ç¨‹åºæŒ‚è½½æ–¹å¼çš„æ€è€ƒ<a hidden class=anchor aria-hidden=true href=#å¯¹-ebpf-ç¨‹åºæŒ‚è½½æ–¹å¼çš„æ€è€ƒ>#</a></h2><link rel=stylesheet href=/css/vendors/admonitions.4fd9a0b8ec8899f2ca952048d255a569f433f77dfb3f52f5bc87e7d65cdce449.css integrity="sha256-T9mguOyImfLKlSBI0lWlafQz9337P1L1vIfn1lzc5Ek=" crossorigin=anonymous><div class="admonition question"><div class=admonition-header><svg viewBox="0 0 512 512"><path d="M256 512A256 256 0 10256 0a256 256 0 100 512zM169.8 165.3c7.9-22.3 29.1-37.3 52.8-37.3h58.3c34.9.0 63.1 28.3 63.1 63.1.0 22.6-12.1 43.5-31.7 54.8L280 264.4c-.2 13-10.9 23.6-24 23.6-13.3.0-24-10.7-24-24v-13.5c0-8.6 4.6-16.5 12.1-20.8l44.3-25.4c4.7-2.7 7.6-7.7 7.6-13.1.0-8.4-6.8-15.1-15.1-15.1h-58.3c-3.4.0-6.4 2.1-7.5 5.3l-.4 1.2c-4.4 12.5-18.2 19-30.6 14.6s-19-18.2-14.6-30.6l.4-1.2zM224 352a32 32 0 1164 0 32 32 0 11-64 0z"/></svg>
<span>ä¸ºä»€ä¹ˆä¸ç”¨ bpf skeleton ä¸­çš„ bpf_object__attach_skeleton æ¥æŒ‚è½½ï¼Œè€Œæ˜¯ä½¿ç”¨ bpf_program__attach_perf_event ï¼Ÿ</span></div></div><p>åœ¨ä½¿ç”¨ libbpf å¼€å‘ BPF ç¨‹åºæ—¶ï¼Œé€šå¸¸ <strong>skeleton ä¼šæä¾›çš„è‡ªåŠ¨ attach æœºåˆ¶ <code>bpf_object__attach_skeleton</code></strong>ï¼Œä½†åœ¨å®é™…å®ç° perf é‡‡æ ·ç›‘æ§ï¼ˆä¾‹å¦‚ <code>init_perf_monitor</code> è¿™ç±»é€»è¾‘ï¼‰çš„è¿‡ç¨‹ä¸­ï¼Œæœ€ç»ˆé€‰æ‹©çš„æ˜¯<strong>æ‰‹åŠ¨åˆ›å»º perf_event fdï¼Œå¹¶ä½¿ç”¨ <code>bpf_program__attach_perf_event</code> è¿›è¡ŒæŒ‚è½½</strong>ã€‚è¿™å¹¶ä¸æ˜¯å› ä¸º skeleton ä¸å¥½ï¼Œè€Œæ˜¯ä¸¤è€…é€‚ç”¨çš„å±‚çº§å’Œåœºæ™¯å¹¶ä¸ç›¸åŒã€‚</p><h3 id=skeleton-attach-æ˜¯ä»€ä¹ˆå®ƒè§£å†³äº†ä»€ä¹ˆé—®é¢˜>skeleton attach æ˜¯ä»€ä¹ˆï¼Œå®ƒè§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ<a hidden class=anchor aria-hidden=true href=#skeleton-attach-æ˜¯ä»€ä¹ˆå®ƒè§£å†³äº†ä»€ä¹ˆé—®é¢˜>#</a></h3><p><code>skeleton attach</code>ï¼ˆæœ¬è´¨æ˜¯ <code>bpf_object__attach_skeleton</code> æˆ–ç”Ÿæˆä»£ç ä¸­çš„ <code>xxx__attach()</code>ï¼‰æ˜¯ä¸€ç§<strong>é«˜å±‚æŠ½è±¡</strong>ï¼š</p><ul><li>åœ¨ BPF ELF ä¸­é€šè¿‡ section æè¿°ç¨‹åºçš„ attach ç±»å‹</li><li>libbpf æ ¹æ®è¿™äº›å…ƒä¿¡æ¯ï¼Œè‡ªåŠ¨æŠŠæ‰€æœ‰ program æŒ‚è½½åˆ°å¯¹åº”çš„ hook ç‚¹</li><li>ç”¨æˆ·æ€å‡ ä¹ä¸éœ€è¦å…³å¿ƒ attach çš„ç»†èŠ‚</li></ul><p>å®ƒéå¸¸é€‚åˆä¸‹é¢è¿™äº›åœºæ™¯ï¼š</p><ul><li>attach ç±»å‹æ˜¯ <strong>é™æ€çš„ã€ç¼–è¯‘æœŸå°±ç¡®å®šçš„</strong></li><li>æ¯”å¦‚ tracepointã€kprobeã€raw_tp ç­‰</li><li>å¸Œæœ›<strong>å¿«é€ŸæŠŠç¨‹åºè·‘èµ·æ¥</strong>ï¼Œè€Œä¸æ˜¯å†™å¤§é‡æ ·æ¿ä»£ç </li></ul><p>åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œskeleton attach æ˜¯å‡ ä¹æ²¡æœ‰ç†ç”±æ‹’ç»çš„ã€‚ä½†å½“ attach å¯¹è±¡å˜æˆ <strong>perf event</strong> æ—¶ï¼Œæƒ…å†µå°±ä¸å¤ªä¸€æ ·äº†ã€‚</p><h3 id=perf-åœºæ™¯ä¸‹çš„ä¸åŒ>perf åœºæ™¯ä¸‹çš„ä¸åŒ<a hidden class=anchor aria-hidden=true href=#perf-åœºæ™¯ä¸‹çš„ä¸åŒ>#</a></h3><p>perf äº‹ä»¶å¹¶ä¸æ˜¯ä¸€ä¸ªâ€œå¤©ç„¶å­˜åœ¨çš„ hook ç‚¹â€ï¼Œè€Œæ˜¯éœ€è¦ç”¨æˆ·æ€æ˜¾å¼åˆ›å»ºçš„ï¼š</p><ul><li>éœ€è¦è°ƒç”¨ <code>perf_event_open</code></li><li>éœ€è¦æ„é€  <code>perf_event_attr</code></li><li>éœ€è¦å†³å®šï¼š<ul><li>æ˜¯æŒ‰ CPU è¿˜æ˜¯æŒ‰ PID</li><li>é‡‡æ ·é¢‘ç‡ / period</li><li>æ˜¯å¦ per-CPU åˆ›å»ºå¤šä¸ª fd</li></ul></li></ul><p>è¿™äº›ä¿¡æ¯<strong>å¤©ç„¶å±äºè¿è¡Œæ—¶é…ç½®</strong>ï¼Œè€Œä¸æ˜¯ ELF å…ƒä¿¡æ¯çš„ä¸€éƒ¨åˆ†ã€‚</p><p>è€Œ skeleton attach çš„è®¾è®¡å‡è®¾æ˜¯ï¼š</p><blockquote><p>attach è¡Œä¸ºå·²ç»åœ¨ BPF ç¨‹åºä¸­å£°æ˜å¥½ï¼Œç”¨æˆ·æ€åªè´Ÿè´£â€œä¸€æ¬¡æ€§æŒ‚ä¸Šå»â€ã€‚</p></blockquote><p>å› è€Œè¿™é‡Œé€‰æ‹©äº†å¦ä¸€æ¡è·¯å¾„ï¼š</p><ol><li>åœ¨ç”¨æˆ·æ€æ˜¾å¼åˆ›å»º perf_event fd</li><li>å°†å•ä¸ª <code>bpf_program</code> é™„åŠ åˆ°æŒ‡å®šçš„ perf fd ä¸Š</li></ol><p>ä¹Ÿå°±æ˜¯ä½¿ç”¨ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#c0f>bpf_program__attach_perf_event</span>(prog, perf_fd);
</span></span></code></pre></div><p>è¿™ç§æ–¹å¼å¸¦æ¥çš„å¥½å¤„ï¼Œä¸»è¦ä½“ç°åœ¨<strong>æ§åˆ¶æƒå®Œå…¨å›åˆ°ç”¨æˆ·æ€</strong>ã€‚</p><h3 id=program-attach-æŒ‚è½½çš„å¥½å¤„>program attach æŒ‚è½½çš„å¥½å¤„<a hidden class=anchor aria-hidden=true href=#program-attach-æŒ‚è½½çš„å¥½å¤„>#</a></h3><p><strong>ï¼ˆ1ï¼‰attach ç²’åº¦æ›´ç»†</strong></p><ul><li>skeleton attachï¼š<ul><li>ä»¥æ•´ä¸ª skeleton ä¸ºå•ä½</li><li>è‡ªåŠ¨ attach å¤šä¸ª program / link</li></ul></li><li>program attachï¼š<ul><li>æ˜ç¡®åœ°æ§åˆ¶â€œå“ªä¸ª program â†’ å“ªä¸ª perf fdâ€</li></ul></li></ul><p>è¿™åœ¨ perf åœºæ™¯ä¸‹éå¸¸é‡è¦ï¼Œå› ä¸º <strong>fd æœ¬èº«å°±æ˜¯ç­–ç•¥çš„ä¸€éƒ¨åˆ†</strong>ã€‚</p><p><strong>ï¼ˆ2ï¼‰perf å‚æ•°å¯ä»¥åœ¨è¿è¡Œæ—¶è‡ªç”±é…ç½®</strong></p><p>é€šè¿‡æ‰‹åŠ¨åˆ›å»º perf fdï¼Œå¯ä»¥åœ¨ç”¨æˆ·æ€ç²¾ç¡®æ§åˆ¶ï¼š</p><ul><li>é‡‡æ ·é¢‘ç‡ï¼ˆfreq / periodï¼‰</li><li>perf event ç±»å‹</li><li>ç»‘å®šåˆ°å“ªä¸ª CPU æˆ– PID</li><li>æ˜¯å¦ä¸ºæ¯ä¸ª CPU åˆ›å»ºç‹¬ç«‹ fd</li></ul><p>è¿™äº›é…ç½®å¾ˆéš¾ä¼˜é›…åœ°æ”¾è¿› skeleton çš„è‡ªåŠ¨ attach æµç¨‹ä¸­ï¼Œä½†å´æ˜¯ perf é‡‡æ ·ä¸­æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ã€‚</p><p><strong>ï¼ˆ3ï¼‰å¤©ç„¶æ”¯æŒ per-CPU / å¤š fd æ¨¡å‹</strong></p><p>ä¸€ä¸ªå¾ˆå…¸å‹çš„æ¨¡å¼æ˜¯ï¼š</p><ul><li>ä¸ºæ¯ä¸ª CPU åˆ›å»ºä¸€ä¸ª perf fd</li><li>æŠŠåŒä¸€ä¸ª BPF ç¨‹åºé™„åŠ åˆ°æ‰€æœ‰è¿™äº› fd ä¸Š</li></ul><p>è¿™åœ¨ program attach æ¨¡å‹ä¸‹æ˜¯é¡ºç†æˆç« çš„äº‹æƒ…ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#c0f>for_each_cpu</span>(cpu) {
</span></span><span style=display:flex><span>    perf_fd <span style=color:#555>=</span> <span style=color:#c0f>perf_event_open</span>(..., cpu, ...);
</span></span><span style=display:flex><span>    link[cpu] <span style=color:#555>=</span> <span style=color:#c0f>bpf_program__attach_perf_event</span>(prog, perf_fd);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è€Œ skeleton attach å¹¶ä¸æ“…é•¿è¡¨è¾¾è¿™ç§ <strong>â€œä¸€å¯¹å¤šã€è¿è¡Œæ—¶ç”Ÿæˆâ€çš„ attach å…³ç³»</strong>ã€‚</p><p><strong>ï¼ˆ4ï¼‰é”™è¯¯å¤„ç†é€»è¾‘æ›´æ¸…æ™°</strong></p><p>æ‰‹åŠ¨ç®¡ç† perf fd å’Œ linkï¼Œä¹Ÿæ„å‘³ç€ï¼š</p><ul><li>perf_event_open å¤±è´¥æ—¶å¯ä»¥ï¼š<ul><li>è·³è¿‡æŸäº› CPU</li><li>é™çº§é‡‡æ ·ç­–ç•¥</li><li>åšé‡è¯•æˆ– fallback</li></ul></li><li>attach å¤±è´¥æ—¶å¯ä»¥å•ç‹¬å¤„ç†ï¼Œè€Œä¸æ˜¯æ•´ä½“å¤±è´¥</li></ul><h3 id=å¯¹æ¯”å°ç»“>å¯¹æ¯”å°ç»“<a hidden class=anchor aria-hidden=true href=#å¯¹æ¯”å°ç»“>#</a></h3><p>éœ€è¦å¼ºè°ƒçš„ä¸€ç‚¹æ˜¯ï¼Œåº•å±‚å…¶å®å¹¶æ²¡æœ‰â€œè°æ›´é«˜çº§â€ï¼š</p><blockquote><p>æ— è®ºæ˜¯ skeleton attach è¿˜æ˜¯ <code>bpf_program__attach_perf_event</code>ï¼Œæœ€ç»ˆå†…æ ¸é‡Œåšçš„äº‹æƒ…æœ¬è´¨ä¸Šæ˜¯ä¸€æ ·çš„â€”â€”å»ºç«‹ <code>bpf_link</code>ï¼ŒæŠŠç¨‹åºç»‘å®šåˆ°äº‹ä»¶ä¸Šã€‚</p></blockquote><p>å¯¹å½“å‰çš„ perf é‡‡æ ·ç›‘æ§åœºæ™¯æ¥è¯´ï¼š</p><ul><li>é‡‡æ ·é¢‘ç‡ã€CPU ç»‘å®šã€fd æ•°é‡éƒ½æ˜¯<strong>è¿è¡Œæ—¶å†³ç­–</strong></li><li>éœ€è¦ per-CPU åˆ›å»º perf fd</li><li>éœ€è¦æ¸…æ™°çš„é”™è¯¯å¤„ç†å’Œèµ„æºç®¡ç†è·¯å¾„</li></ul><p>å› æ­¤åœ¨ç”¨æˆ·æ€åˆ›å»º perf_event fdï¼Œå¹¶ä½¿ç”¨ <code>bpf_program__attach_perf_event</code> é€ä¸ª attachï¼Œæ˜¯æ›´è‡ªç„¶ã€ä¹Ÿæ›´å¯æ§çš„åšæ³•ã€‚</p><h2 id=å‚è€ƒ>å‚è€ƒ<a hidden class=anchor aria-hidden=true href=#å‚è€ƒ>#</a></h2><ol><li><a href=https://eunomia.dev/zh/tutorials/12-profile/>eBPF å…¥é—¨å®è·µæ•™ç¨‹åäºŒï¼šä½¿ç”¨ eBPF ç¨‹åº profile è¿›è¡Œæ€§èƒ½åˆ†æ</a></li><li><a href=https://zhuanlan.zhihu.com/p/623578927>eBPF æ€§èƒ½åˆ†æå®æˆ˜</a> - eBPF åœ¨æ€§èƒ½åˆ†æä¸­çš„åº”ç”¨</li><li><a href=https://plantegg.github.io/2021/05/16/Perf_IPC%E4%BB%A5%E5%8F%8ACPU%E5%88%A9%E7%94%A8%E7%8E%87>Perf IPC ä¸ CPU åˆ©ç”¨ç‡</a> - perf åŸç†æ·±å…¥è§£æ</li><li><a href=https://man7.org/linux/man-pages/man2/perf_event_open.2.html>perf_event_open æ‰‹å†Œé¡µ</a> - å®˜æ–¹æ–‡æ¡£å‚è€ƒ</li><li><a href=https://github.com/brendangregg/FlameGraph>FlameGraph å·¥å…·</a> - ç«ç„°å›¾ç”Ÿæˆå·¥å…·</li><li><a href=https://github.com/libbpf/blazesym>blazesym ç¬¦å·åŒ–åº“</a> - é«˜æ€§èƒ½ç¬¦å·åŒ–åº“</li></ol></div><footer class=post-footer><nav class=paginav><a class=prev href=https://kerolt.github.io/posts/dev-null/%E4%B8%BAhugo-papermod%E6%B7%BB%E5%8A%A0mermaid%E6%B8%B2%E6%9F%93/><span class=title>Â« Prev</span><br><span>ä¸ºHugo PaperModæ·»åŠ mermaidæ¸²æŸ“</span>
</a><a class=next href=https://kerolt.github.io/posts/docker/%E5%9C%A8-docker-compose-%E4%B8%AD%E4%B8%BA%E9%A1%B9%E7%9B%AE%E5%90%AF%E7%94%A8-ipv6-%E5%B9%B6%E5%8F%AF%E9%80%9A%E8%BF%87-ipv6-%E5%8F%AF%E8%AE%BF%E9%97%AE/><span class=title>Next Â»</span><br><span>åœ¨ Docker Compose ä¸­ä¸ºé¡¹ç›®å¯ç”¨ IPv6 å¹¶å¯é€šè¿‡ IPv6 å¯è®¿é—®</span></a></nav></footer></article><script type=module>  
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs'; 
    mermaid.initialize({ startOnLoad: true });  
</script><script>Array.from(document.getElementsByClassName("language-mermaid")).forEach(e=>{e.parentElement.outerHTML=`<div class="mermaid">${e.innerHTML}</div>`})</script><style>.mermaid svg{display:block;margin:auto}</style></main><footer class=footer><span>&copy; 2026 <a href=https://kerolt.github.io/>Kerolt's Blog</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>