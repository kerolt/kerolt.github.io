<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>eBPFå¢å¼ºNginxè´Ÿè½½å‡è¡¡ | Kerolt's Blog</title><meta name=keywords content="eBPF,Nginx"><meta name=description content='Nginx è´Ÿè½½å‡è¡¡åŸºå‡†æµ‹è¯•
/ # wrk -c100 "http://172.17.0.5"
Running 10s test @ http://172.17.0.5
  2 threads and 100 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    12.31ms   12.66ms  84.49ms   82.31%
    Req/Sec     5.71k     4.96k   12.98k    63.00%
  113583 requests in 10.04s, 17.87MB read
Requests/sec:  11313.86
Transfer/sec:      1.78MB

Latencyï¼ˆå»¶è¿Ÿï¼‰

Avg 12.31msï¼šå¹³å‡æ¯ä¸ªè¯·æ±‚çš„å“åº”æ—¶é—´ä¸º 12.31 æ¯«ç§’
Stdev 12.66msï¼šæ ‡å‡†å·®è¯´æ˜å“åº”æ—¶é—´æ³¢åŠ¨è¾ƒå¤§
Max 84.49msï¼šæœ€é•¿è¯·æ±‚èŠ±äº† 84.49 æ¯«ç§’
82.31% +/- Stdevï¼š82% çš„è¯·æ±‚å»¶è¿Ÿåœ¨ Â±1 æ ‡å‡†å·®èŒƒå›´å†…ï¼ˆè¯´æ˜å¤§éƒ¨åˆ†è¯·æ±‚åˆ†å¸ƒè¾ƒå¹¿ï¼‰

Req/Secï¼ˆæ¯ç§’è¯·æ±‚æ•°ï¼‰

Avg 5.71kï¼šå¹³å‡æ¯ä¸ªçº¿ç¨‹æ¯ç§’å‘å‡ºçº¦ 5710 ä¸ªè¯·æ±‚
Stdev 4.96kï¼šæ ‡å‡†å·®è¯´æ˜ä¸åŒæ—¶é—´ç‚¹ååæ³¢åŠ¨è¾ƒå¤§
Max 12.98kï¼šå•ä¸ªçº¿ç¨‹çš„æœ€é«˜ç¬æ—¶è¯·æ±‚é€Ÿç‡ä¸º 12.98k/s
63.00% +/- Stdevï¼šçº¦ 63% çš„æ ·æœ¬åœ¨è¿™ä¸ªèŒƒå›´å†…


æ¥ä¸‹æ¥æˆ‘ä»¬åˆ©ç”¨å¥—æ¥å­— eBPF ç¨‹åºä¼˜åŒ–'><meta name=author content="Kerolt"><link rel=canonical href=https://kerolt.github.io/posts/ebpf/ebpf%E5%A2%9E%E5%BC%BAnginx%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/><meta name=google-site-verification content="NpIO0KEIJS0CPRzTzQCbYQdSRIyb0Lspx"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="2300A23B82DB579A2DEA6261191AD771"><link crossorigin=anonymous href=/assets/css/stylesheet.ef9ab3c5a056d4b92179b140aee474d5f961270bacb25621ebcfd8a244feac6a.css integrity="sha256-75qzxaBW1LkhebFAruR01flhJwusslYh68/YokT+rGo=" rel="preload stylesheet" as=style><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-screen-web/style.css><link rel=stylesheet href=css/extended/custom.css><link rel=icon href=https://kerolt.github.io/images/avatar/favicon.png><link rel=icon type=image/png sizes=16x16 href=https://kerolt.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://kerolt.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://kerolt.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://kerolt.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://kerolt.github.io/posts/ebpf/ebpf%E5%A2%9E%E5%BC%BAnginx%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/><script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css><script src=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js></script><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://kerolt.github.io/posts/ebpf/ebpf%E5%A2%9E%E5%BC%BAnginx%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/"><meta property="og:site_name" content="Kerolt's Blog"><meta property="og:title" content="eBPFå¢å¼ºNginxè´Ÿè½½å‡è¡¡"><meta property="og:description" content='Nginx è´Ÿè½½å‡è¡¡åŸºå‡†æµ‹è¯• / # wrk -c100 "http://172.17.0.5" Running 10s test @ http://172.17.0.5 2 threads and 100 connections Thread Stats Avg Stdev Max +/- Stdev Latency 12.31ms 12.66ms 84.49ms 82.31% Req/Sec 5.71k 4.96k 12.98k 63.00% 113583 requests in 10.04s, 17.87MB read Requests/sec: 11313.86 Transfer/sec: 1.78MB Latencyï¼ˆå»¶è¿Ÿï¼‰
Avg 12.31msï¼šå¹³å‡æ¯ä¸ªè¯·æ±‚çš„å“åº”æ—¶é—´ä¸º 12.31 æ¯«ç§’ Stdev 12.66msï¼šæ ‡å‡†å·®è¯´æ˜å“åº”æ—¶é—´æ³¢åŠ¨è¾ƒå¤§ Max 84.49msï¼šæœ€é•¿è¯·æ±‚èŠ±äº† 84.49 æ¯«ç§’ 82.31% +/- Stdevï¼š82% çš„è¯·æ±‚å»¶è¿Ÿåœ¨ Â±1 æ ‡å‡†å·®èŒƒå›´å†…ï¼ˆè¯´æ˜å¤§éƒ¨åˆ†è¯·æ±‚åˆ†å¸ƒè¾ƒå¹¿ï¼‰ Req/Secï¼ˆæ¯ç§’è¯·æ±‚æ•°ï¼‰
Avg 5.71kï¼šå¹³å‡æ¯ä¸ªçº¿ç¨‹æ¯ç§’å‘å‡ºçº¦ 5710 ä¸ªè¯·æ±‚ Stdev 4.96kï¼šæ ‡å‡†å·®è¯´æ˜ä¸åŒæ—¶é—´ç‚¹ååæ³¢åŠ¨è¾ƒå¤§ Max 12.98kï¼šå•ä¸ªçº¿ç¨‹çš„æœ€é«˜ç¬æ—¶è¯·æ±‚é€Ÿç‡ä¸º 12.98k/s 63.00% +/- Stdevï¼šçº¦ 63% çš„æ ·æœ¬åœ¨è¿™ä¸ªèŒƒå›´å†… æ¥ä¸‹æ¥æˆ‘ä»¬åˆ©ç”¨å¥—æ¥å­— eBPF ç¨‹åºä¼˜åŒ–'><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-10-21T00:00:00+00:00"><meta property="article:modified_time" content="2025-10-21T00:00:00+00:00"><meta property="article:tag" content="EBPF"><meta property="article:tag" content="Nginx"><meta property="og:image" content="https://kerolt.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://kerolt.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="eBPFå¢å¼ºNginxè´Ÿè½½å‡è¡¡"><meta name=twitter:description content='Nginx è´Ÿè½½å‡è¡¡åŸºå‡†æµ‹è¯•
/ # wrk -c100 "http://172.17.0.5"
Running 10s test @ http://172.17.0.5
  2 threads and 100 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    12.31ms   12.66ms  84.49ms   82.31%
    Req/Sec     5.71k     4.96k   12.98k    63.00%
  113583 requests in 10.04s, 17.87MB read
Requests/sec:  11313.86
Transfer/sec:      1.78MB

Latencyï¼ˆå»¶è¿Ÿï¼‰

Avg 12.31msï¼šå¹³å‡æ¯ä¸ªè¯·æ±‚çš„å“åº”æ—¶é—´ä¸º 12.31 æ¯«ç§’
Stdev 12.66msï¼šæ ‡å‡†å·®è¯´æ˜å“åº”æ—¶é—´æ³¢åŠ¨è¾ƒå¤§
Max 84.49msï¼šæœ€é•¿è¯·æ±‚èŠ±äº† 84.49 æ¯«ç§’
82.31% +/- Stdevï¼š82% çš„è¯·æ±‚å»¶è¿Ÿåœ¨ Â±1 æ ‡å‡†å·®èŒƒå›´å†…ï¼ˆè¯´æ˜å¤§éƒ¨åˆ†è¯·æ±‚åˆ†å¸ƒè¾ƒå¹¿ï¼‰

Req/Secï¼ˆæ¯ç§’è¯·æ±‚æ•°ï¼‰

Avg 5.71kï¼šå¹³å‡æ¯ä¸ªçº¿ç¨‹æ¯ç§’å‘å‡ºçº¦ 5710 ä¸ªè¯·æ±‚
Stdev 4.96kï¼šæ ‡å‡†å·®è¯´æ˜ä¸åŒæ—¶é—´ç‚¹ååæ³¢åŠ¨è¾ƒå¤§
Max 12.98kï¼šå•ä¸ªçº¿ç¨‹çš„æœ€é«˜ç¬æ—¶è¯·æ±‚é€Ÿç‡ä¸º 12.98k/s
63.00% +/- Stdevï¼šçº¦ 63% çš„æ ·æœ¬åœ¨è¿™ä¸ªèŒƒå›´å†…


æ¥ä¸‹æ¥æˆ‘ä»¬åˆ©ç”¨å¥—æ¥å­— eBPF ç¨‹åºä¼˜åŒ–'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://kerolt.github.io/posts/"},{"@type":"ListItem","position":2,"name":"eBPFå¢å¼ºNginxè´Ÿè½½å‡è¡¡","item":"https://kerolt.github.io/posts/ebpf/ebpf%E5%A2%9E%E5%BC%BAnginx%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"eBPFå¢å¼ºNginxè´Ÿè½½å‡è¡¡","name":"eBPFå¢å¼ºNginxè´Ÿè½½å‡è¡¡","description":"Nginx è´Ÿè½½å‡è¡¡åŸºå‡†æµ‹è¯• / # wrk -c100 \u0026#34;http://172.17.0.5\u0026#34; Running 10s test @ http://172.17.0.5 2 threads and 100 connections Thread Stats Avg Stdev Max +/- Stdev Latency 12.31ms 12.66ms 84.49ms 82.31% Req/Sec 5.71k 4.96k 12.98k 63.00% 113583 requests in 10.04s, 17.87MB read Requests/sec: 11313.86 Transfer/sec: 1.78MB Latencyï¼ˆå»¶è¿Ÿï¼‰\nAvg 12.31msï¼šå¹³å‡æ¯ä¸ªè¯·æ±‚çš„å“åº”æ—¶é—´ä¸º 12.31 æ¯«ç§’ Stdev 12.66msï¼šæ ‡å‡†å·®è¯´æ˜å“åº”æ—¶é—´æ³¢åŠ¨è¾ƒå¤§ Max 84.49msï¼šæœ€é•¿è¯·æ±‚èŠ±äº† 84.49 æ¯«ç§’ 82.31% +/- Stdevï¼š82% çš„è¯·æ±‚å»¶è¿Ÿåœ¨ Â±1 æ ‡å‡†å·®èŒƒå›´å†…ï¼ˆè¯´æ˜å¤§éƒ¨åˆ†è¯·æ±‚åˆ†å¸ƒè¾ƒå¹¿ï¼‰ Req/Secï¼ˆæ¯ç§’è¯·æ±‚æ•°ï¼‰\nAvg 5.71kï¼šå¹³å‡æ¯ä¸ªçº¿ç¨‹æ¯ç§’å‘å‡ºçº¦ 5710 ä¸ªè¯·æ±‚ Stdev 4.96kï¼šæ ‡å‡†å·®è¯´æ˜ä¸åŒæ—¶é—´ç‚¹ååæ³¢åŠ¨è¾ƒå¤§ Max 12.98kï¼šå•ä¸ªçº¿ç¨‹çš„æœ€é«˜ç¬æ—¶è¯·æ±‚é€Ÿç‡ä¸º 12.98k/s 63.00% +/- Stdevï¼šçº¦ 63% çš„æ ·æœ¬åœ¨è¿™ä¸ªèŒƒå›´å†… æ¥ä¸‹æ¥æˆ‘ä»¬åˆ©ç”¨å¥—æ¥å­— eBPF ç¨‹åºä¼˜åŒ–\n","keywords":["eBPF","Nginx"],"articleBody":"Nginx è´Ÿè½½å‡è¡¡åŸºå‡†æµ‹è¯• / # wrk -c100 \"http://172.17.0.5\" Running 10s test @ http://172.17.0.5 2 threads and 100 connections Thread Stats Avg Stdev Max +/- Stdev Latency 12.31ms 12.66ms 84.49ms 82.31% Req/Sec 5.71k 4.96k 12.98k 63.00% 113583 requests in 10.04s, 17.87MB read Requests/sec: 11313.86 Transfer/sec: 1.78MB Latencyï¼ˆå»¶è¿Ÿï¼‰\nAvg 12.31msï¼šå¹³å‡æ¯ä¸ªè¯·æ±‚çš„å“åº”æ—¶é—´ä¸º 12.31 æ¯«ç§’ Stdev 12.66msï¼šæ ‡å‡†å·®è¯´æ˜å“åº”æ—¶é—´æ³¢åŠ¨è¾ƒå¤§ Max 84.49msï¼šæœ€é•¿è¯·æ±‚èŠ±äº† 84.49 æ¯«ç§’ 82.31% +/- Stdevï¼š82% çš„è¯·æ±‚å»¶è¿Ÿåœ¨ Â±1 æ ‡å‡†å·®èŒƒå›´å†…ï¼ˆè¯´æ˜å¤§éƒ¨åˆ†è¯·æ±‚åˆ†å¸ƒè¾ƒå¹¿ï¼‰ Req/Secï¼ˆæ¯ç§’è¯·æ±‚æ•°ï¼‰\nAvg 5.71kï¼šå¹³å‡æ¯ä¸ªçº¿ç¨‹æ¯ç§’å‘å‡ºçº¦ 5710 ä¸ªè¯·æ±‚ Stdev 4.96kï¼šæ ‡å‡†å·®è¯´æ˜ä¸åŒæ—¶é—´ç‚¹ååæ³¢åŠ¨è¾ƒå¤§ Max 12.98kï¼šå•ä¸ªçº¿ç¨‹çš„æœ€é«˜ç¬æ—¶è¯·æ±‚é€Ÿç‡ä¸º 12.98k/s 63.00% +/- Stdevï¼šçº¦ 63% çš„æ ·æœ¬åœ¨è¿™ä¸ªèŒƒå›´å†… æ¥ä¸‹æ¥æˆ‘ä»¬åˆ©ç”¨å¥—æ¥å­— eBPF ç¨‹åºä¼˜åŒ–\nç†è§£ Nginx è´Ÿè½½å‡è¡¡çš„æœ¬è´¨ Nginx ä½œä¸ºåå‘ä»£ç†æˆ–è´Ÿè½½å‡è¡¡å™¨ï¼Œæœ¬è´¨ä¸Šæ˜¯ï¼š\nä»å®¢æˆ·ç«¯æ¥æ”¶è¯·æ±‚ï¼ˆé€šè¿‡ accept() å»ºç«‹ TCP è¿æ¥ï¼‰ é€‰æ‹©ä¸€ä¸ªä¸Šæ¸¸åç«¯ï¼ˆupstream serverï¼‰ åœ¨ç”¨æˆ·æ€å‘èµ·ä¸€ä¸ªæ–°çš„ TCP è¿æ¥ åˆ°è¯¥åç«¯ åœ¨ä¸¤ä¸ª socket ä¹‹é—´ä¸­è½¬æ•°æ®ï¼ˆå‰ç«¯ \u003c-\u003e åç«¯ï¼‰ å…³é”®ç‚¹ï¼šNginx çš„è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼ˆå¦‚ round robinã€ip_hashï¼‰åœ¨ç”¨æˆ·æ€å†³å®šï¼›è€Œå®é™…çš„æ•°æ®æµæ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„ socketï¼Œä¸­é—´çš„æ•°æ®è½¬å‘ä¹Ÿåœ¨ç”¨æˆ·æ€è¿›è¡Œï¼ˆæ•ˆç‡ä¸Šæœ‰æŸï¼‰ã€‚\nå½“æˆ‘ä»¬å¼•å…¥ eBPFï¼ˆextended Berkeley Packet Filterï¼‰ æ—¶ï¼Œç›®æ ‡å¾€å¾€æ˜¯ï¼š\næŠŠè´Ÿè½½å‡è¡¡é€»è¾‘ä¸‹æ”¾åˆ°å†…æ ¸æ€ å‡å°‘ Nginx ç”¨æˆ·æ€è½¬å‘å¼€é”€ å®ç°æ›´å¿«çš„æµé‡åˆ†å‘ï¼ˆé›¶æ‹·è´ã€ä½å»¶è¿Ÿï¼‰ ä¾‹å¦‚ï¼š\nç”¨ eBPF ç¨‹åºåœ¨ XDP æˆ– TC ingress hook é˜¶æ®µç›´æ¥é€‰æ‹©åç«¯ï¼› æˆ–è€…ä½¿ç”¨ sockmap/sockhash åœ¨å†…æ ¸ä¸­ç›´æ¥â€œè½¬å‘â€ä¸¤ä¸ª socket ä¹‹é—´çš„æ•°æ®ã€‚ ä½¿ç”¨ socket æ˜ å°„è½¬å‘ç½‘ç»œåŒ… socket æ˜ å°„ï¼ˆsocket mapï¼‰æ˜¯ eBPF ä¸­çš„ä¸€ç§ BPF map ç±»å‹ï¼Œå®ƒå¯ä»¥åœ¨å†…æ ¸ä¸­ä¿å­˜ socket çš„å¼•ç”¨ï¼ˆå³ TCP è¿æ¥å¯¹è±¡ï¼‰ï¼Œ ä»è€Œå…è®¸ eBPF ç¨‹åºç›´æ¥æ“ä½œå’Œè½¬å‘è¿™äº›è¿æ¥ä¸Šçš„æ•°æ®ã€‚å®ƒæœ‰ä¸¤ç§å½¢å¼ï¼š\nç±»å‹ åç§° ç‰¹ç‚¹ BPF_MAP_TYPE_SOCKMAP sockmap æ•°ç»„ç»“æ„ï¼ŒæŒ‰ç´¢å¼•å­˜ socket BPF_MAP_TYPE_SOCKHASH sockhash å“ˆå¸Œç»“æ„ï¼Œå¯æŒ‰ key æŸ¥æ‰¾ socket å¯ä»¥ç†è§£ä¸ºï¼šsockmap/sockhash = ä¸€ä¸ªâ€œè¿æ¥è·¯ç”±è¡¨â€ï¼Œå­˜æ”¾ æ˜ å°„å…³ç³»ã€‚ è®© eBPF ç¨‹åºåœ¨å†…æ ¸ä¸­çŸ¥é“â€œå“ªä¸ª key å¯¹åº”å“ªä¸ª socketâ€ã€‚\nä¼ ç»Ÿç”¨æˆ·æ€è½¬å‘çš„æ€§èƒ½ç“¶é¢ˆï¼Œä»¥ Nginx ä¸ºä¾‹ï¼š\nclient socket â†’ Nginx ç”¨æˆ·æ€ â†’ upstream socket æ•°æ®æµéœ€è¦ç»è¿‡ï¼š\n2 æ¬¡ç³»ç»Ÿè°ƒç”¨ï¼ˆrecv + sendï¼‰ 2 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ˆå†…æ ¸â†”ç”¨æˆ·æ€ï¼‰ 1 æ¬¡æ•°æ®æ‹·è´ï¼ˆå†…æ ¸ç¼“å†²åŒºâ†”ç”¨æˆ·ç¼“å†²åŒºï¼‰ å½“å¹¶å‘é‡å¾ˆé«˜ï¼ˆæ¯”å¦‚ wrk 10k QPSï¼‰æ—¶ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±æˆä¸ºç“¶é¢ˆã€‚\näºæ˜¯ Linux å¼•å…¥äº† socket æ˜ å°„ + SK_MSG eBPF ç¨‹åºå¯ä»¥ç›´æ¥åœ¨å†…æ ¸ä¸­å®Œæˆè½¬å‘ï¼š\næŠŠæ‰€æœ‰è¿æ¥ï¼ˆclient å’Œ upstreamï¼‰çš„ socket å¼•ç”¨æ³¨å†Œè¿› sockmapï¼› eBPF ç¨‹åºåœ¨å‘é€è·¯å¾„ä¸­ï¼ˆBPF_PROG_TYPE_SK_MSGï¼‰æ‰§è¡Œï¼› ç¨‹åºä» sockmap ä¸­æŸ¥æ‰¾ç›®æ ‡ socketï¼› å†…æ ¸ç›´æ¥æŠŠæ•°æ®ä»ä¸€ä¸ª socket å‘é€åˆ°å¦ä¸€ä¸ª socket â€”â€” é›¶æ‹·è´è½¬å‘ã€‚ åœ¨ eBPF ä¼˜åŒ–ä½“ç³»ä¸­ï¼š\næ§åˆ¶é¢ï¼ˆControl Planeï¼‰ï¼šå†³å®šæ€ä¹ˆè½¬å‘ï¼ˆè°è½¬å‘ç»™è°ï¼‰ â†’ ç”¨æˆ·æ€ï¼ˆNginxï¼‰ æ•°æ®é¢ï¼ˆData Planeï¼‰ï¼šå®é™…æ‰§è¡Œè½¬å‘ â†’ å†…æ ¸æ€ï¼ˆeBPFï¼‰ socket æ˜ å°„å°±æ˜¯ä¸¤è€…çš„â€œæ¡¥æ¢â€ï¼šNginx è´Ÿè´£æŠŠ socket æ³¨å†Œè¿› sockmapï¼ˆå‘Šè¯‰å†…æ ¸ï¼šclient_fd å¯¹åº” upstream_fdï¼‰ï¼ŒeBPF ç¨‹åºè´Ÿè´£ä» sockmap ä¸­æŸ¥æ‰¾ç›®æ ‡å¹¶å®Œæˆè½¬å‘ã€‚\nè¿™ç§æ¨¡å¼çš„å¥½å¤„æ˜¯ï¼š\neBPF ä¸éœ€è¦è‡ªå·±ç»´æŠ¤è¿æ¥ï¼› ç”¨æˆ·æ€åº”ç”¨å¯ä»¥åŠ¨æ€è°ƒæ•´æ˜ å°„ï¼› å†…æ ¸å¯ä»¥é«˜æ€§èƒ½åœ°å®Œæˆæ•°æ®è½¬å‘ã€‚ æ•°æ®æµç®€åŒ–ç¤ºæ„å›¾å¦‚ä¸‹ï¼š\nä¼ ç»Ÿ Nginx è½¬å‘ [Client Socket] â†“ recv() [ç”¨æˆ·æ€ç¼“å†²åŒº] â†“ send() [Upstream Socket] eBPF + socket æ˜ å°„ä¼˜åŒ–å [Client Socket] â†“ eBPF ç¨‹åº (SK_MSG) â†˜ï¸ æŸ¥æ‰¾ sockmap[key] â†“ [Upstream Socket] æ•´ä¸ªè½¬å‘åœ¨å†…æ ¸ä¸­å®Œæˆï¼Œæ— éœ€è¿›å…¥ Nginx ç”¨æˆ·æ€ã€‚\né‚£ä¼˜åŒ–çš„æ­¥éª¤å¦‚ä¸‹ï¼š\nåˆ›å»ºå¥—æ¥å­—æ˜ å°„ï¼› åœ¨ BPF_PROG_TYPE_SOCK_OPS ç±»å‹çš„ eBPF ç¨‹åºä¸­ï¼Œå°†æ–°åˆ›å»ºçš„å¥—æ¥å­—å­˜å…¥å¥—æ¥å­—æ˜ å°„ä¸­ï¼› åœ¨æµè§£æç±»çš„ eBPF ç¨‹åº (å¦‚ BPF_PROG_TYPE_SK_SKB æˆ– BPF_PROG_TYPE_SK_MSG ) ä¸­ï¼Œä»å¥—æ¥å­—æ˜ å°„ä¸­æå–å¥—æ¥å­—ä¿¡æ¯ï¼Œå¹¶è°ƒç”¨ BPF è¾…åŠ©å‡½æ•°è½¬å‘ç½‘ç»œåŒ…; åŠ è½½å¹¶æŒ‚è½½ eBPF ç¨‹åºåˆ°å¥—æ¥å­—äº‹ä»¶ã€‚ socket æ˜ å°„ è¿™é‡Œä½¿ç”¨ socket æ˜ å°„ï¼ˆsocket mapï¼‰ä¸­çš„ä¸€ç§ BPF Map ç±»å‹ï¼šBPF_MAP_TYPE_SOCKHASHï¼Œå®ƒçš„å€¼æ€»æ˜¯å¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦ï¼Œè€Œé”®åˆ™éœ€è¦æˆ‘ä»¬å»å®šä¹‰ã€‚\ntypedef struct { __u32 source_ip; __u32 dest_ip; __u16 source_port; __u16 dest_port; __u32 protocol; } SockKey; struct { __uint(type, BPF_MAP_TYPE_SOCKHASH); __uint(key_size, sizeof(SockKey)); __uint(value_size, sizeof(int)); __uint(max_entries, 65535); __uint(map_flags, 0); } sock_ops_map SEC(\".maps\"); BPF_PROG_TYPE_SOCK_OPS æ˜¯ å†…æ ¸å¥—æ¥å­—æ“ä½œå›è°ƒç±»å‹çš„ eBPF ç¨‹åºï¼Œå®ƒèƒ½åœ¨ TCP è¿æ¥çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶è¢«è§¦å‘æ—¶æ‰§è¡Œï¼ŒåŒ…æ‹¬ï¼š\nBPF_SOCK_OPS_PASSIVE_ESTABLISHED_CBï¼šè¢«åŠ¨è¿æ¥å»ºç«‹ï¼ˆå¦‚æœåŠ¡å™¨ acceptï¼‰ BPF_SOCK_OPS_ACTIVE_ESTABLISHED_CBï¼šä¸»åŠ¨è¿æ¥å»ºç«‹ï¼ˆå¦‚å®¢æˆ·ç«¯ connectï¼‰ BPF_SOCK_OPS_TCP_CLOSE_CBï¼šè¿æ¥å…³é—­ BPF_SOCK_OPS_STATE_CBï¼šçŠ¶æ€å˜åŒ– ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒå¯ä»¥è·Ÿè¸ª TCP socket çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸï¼Œåœ¨è¿æ¥å»ºç«‹/å…³é—­æ—¶è·å– socket çš„äº”å…ƒç»„ä¿¡æ¯ï¼Œå¹¶æŠŠ socket å­˜å…¥ sockhashï¼Œä»è€Œè®© å†…æ ¸æ€ eBPF æ•°æ®é¢ç¨‹åºï¼ˆå¦‚ SK_MSGï¼‰å¯ä»¥ç›´æ¥é«˜æ•ˆåœ°æŸ¥æ‰¾å’Œè½¬å‘ socket æ•°æ®ã€‚\néœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒBPF_PROG_TYPE_SOCK_OPS ç¨‹åºè·Ÿè¸ªäº†æ‰€æœ‰ç±»å‹çš„å¥—æ¥å­—æ“ä½œï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠæ–°åˆ›å»ºçš„å¥—æ¥å­—æ›´æ–°åˆ°æ˜ å°„ä¸­ã€‚\nSEC(\"sockops\") int bpf_sockmap(struct bpf_sock_ops* sockops) { // åªå¤„ç† IPv4 è¿æ¥ if (sockops-\u003efamily != AF_INET) { return BPF_OK; } // åªå¤„ç†å·²å»ºç«‹çš„è¿æ¥ if (sockops-\u003eop != BPF_SOCK_OPS_PASSIVE_ESTABLISHED_CB \u0026\u0026 sockops-\u003eop != BPF_SOCK_OPS_ACTIVE_ESTABLISHED_CB) { return BPF_OK; } SockKey key = { .dest_ip = sockops-\u003eremote_ip4, .source_ip = sockops-\u003elocal_ip4, .dest_port = sockops-\u003eremote_port, .source_port = bpf_htonl(sockops-\u003elocal_port), .protocol = sockops-\u003efamily, }; bpf_sock_hash_update(sockops, \u0026sock_ops_map, \u0026key, BPF_NOEXIST); return BPF_OK; } è½¬å‘ socket è½¬å‘ socket å¯ä»¥ä½¿ç”¨ BPF_PROG_TYPE_SK_MSG ç±»å‹çš„ eBPF ç¨‹åºï¼Œå®ƒåœ¨å†…æ ¸ä¸­çš„å®šä¹‰æ˜¯è¿™æ ·çš„ï¼š\nBPF_PROG_TYPE(BPF_PROG_TYPE_SK_MSG, sk_msg, struct sk_msg_md, struct sk_msg) æ•è· socket ä¸­çš„å‘é€æ•°æ®åŒ…ï¼Œå¹¶æ ¹æ®ä¹‹å‰çš„ socket æ˜ å°„è¿›è¡Œè½¬å‘ï¼š\nSEC(\"sk_msg\") int bpf_sock_redirect(struct sk_msg_md* msg) { SockKey key = { .source_ip = msg-\u003eremote_ip4, .dest_ip = msg-\u003elocal_ip4, .source_port = msg-\u003eremote_port, .dest_port = bpf_htonl(msg-\u003elocal_port), .protocol = msg-\u003efamily, }; bpf_msg_redirect_hash(msg, \u0026sock_ops_map, \u0026key, BPF_F_INGRESS); return SK_PASS; } æµ‹è¯•ç»“æœ / # wrk -c100 \"http://172.17.0.5\" Running 10s test @ http://172.17.0.5 2 threads and 100 connections Thread Stats Avg Stdev Max +/- Stdev Latency 7.88ms 6.22ms 55.43ms 68.53% Req/Sec 7.03k 4.99k 15.03k 69.00% 140073 requests in 10.05s, 22.04MB read Requests/sec: 13940.22 Transfer/sec: 2.19MB ååæå‡ â‰ˆ 23.2%ã€‚ å¹³å‡å»¶è¿Ÿä¸‹é™ â‰ˆ 36.0%ã€‚ ","wordCount":"535","inLanguage":"en","image":"https://kerolt.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2025-10-21T00:00:00Z","dateModified":"2025-10-21T00:00:00Z","author":{"@type":"Person","name":"Kerolt"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://kerolt.github.io/posts/ebpf/ebpf%E5%A2%9E%E5%BC%BAnginx%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/"},"publisher":{"@type":"Organization","name":"Kerolt's Blog","logo":{"@type":"ImageObject","url":"https://kerolt.github.io/images/avatar/favicon.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://kerolt.github.io/ accesskey=h title="Kerolt's Blog (Alt + H)">Kerolt's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://kerolt.github.io/posts/ title=æ–‡ç« ><span>æ–‡ç« </span></a></li><li><a href=https://kerolt.github.io/categories/ title=åˆ†ç±»><span>åˆ†ç±»</span></a></li><li><a href=https://kerolt.github.io/tags/ title=æ ‡ç­¾><span>æ ‡ç­¾</span></a></li><li><a href=https://kerolt.github.io/archives/ title=å½’æ¡£><span>å½’æ¡£</span></a></li><li><a href=https://kerolt.github.io/about/ title=å…³äºæˆ‘><span>å…³äºæˆ‘</span></a></li><li><a href=https://kerolt.github.io/search/ title="ğŸ” (Alt + /)" accesskey=/><span>ğŸ”</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://kerolt.github.io/>Home</a>&nbsp;Â»&nbsp;<a href=https://kerolt.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">eBPFå¢å¼ºNginxè´Ÿè½½å‡è¡¡</h1><div class=post-meta><span title='2025-10-21 00:00:00 +0000 UTC'>å‘å¸ƒäº2025-10-21</span>&nbsp;&nbsp;Â·&nbsp;&nbsp;Kerolt</div><ul class=post-tags><li><a href=https://kerolt.github.io/tags/ebpf/>EBPF</a></li><li><a href=https://kerolt.github.io/tags/nginx/>Nginx</a></li></ul></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#nginx-%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1%e5%9f%ba%e5%87%86%e6%b5%8b%e8%af%95 aria-label="Nginx è´Ÿè½½å‡è¡¡åŸºå‡†æµ‹è¯•">Nginx è´Ÿè½½å‡è¡¡åŸºå‡†æµ‹è¯•</a></li><li><a href=#%e7%90%86%e8%a7%a3-nginx-%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1%e7%9a%84%e6%9c%ac%e8%b4%a8 aria-label="ç†è§£ Nginx è´Ÿè½½å‡è¡¡çš„æœ¬è´¨">ç†è§£ Nginx è´Ÿè½½å‡è¡¡çš„æœ¬è´¨</a></li><li><a href=#%e4%bd%bf%e7%94%a8-socket-%e6%98%a0%e5%b0%84%e8%bd%ac%e5%8f%91%e7%bd%91%e7%bb%9c%e5%8c%85 aria-label="ä½¿ç”¨ socket æ˜ å°„è½¬å‘ç½‘ç»œåŒ…">ä½¿ç”¨ socket æ˜ å°„è½¬å‘ç½‘ç»œåŒ…</a></li><li><a href=#socket-%e6%98%a0%e5%b0%84 aria-label="socket æ˜ å°„">socket æ˜ å°„</a></li><li><a href=#%e8%bd%ac%e5%8f%91-socket aria-label="è½¬å‘ socket">è½¬å‘ socket</a></li><li><a href=#%e6%b5%8b%e8%af%95%e7%bb%93%e6%9e%9c aria-label=æµ‹è¯•ç»“æœ>æµ‹è¯•ç»“æœ</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h2 id=nginx-è´Ÿè½½å‡è¡¡åŸºå‡†æµ‹è¯•>Nginx è´Ÿè½½å‡è¡¡åŸºå‡†æµ‹è¯•<a hidden class=anchor aria-hidden=true href=#nginx-è´Ÿè½½å‡è¡¡åŸºå‡†æµ‹è¯•>#</a></h2><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>/ <span style=color:#09f;font-style:italic># wrk -c100 &#34;http://172.17.0.5&#34;</span>
</span></span><span style=display:flex><span>Running 10s <span style=color:#366>test</span> @ http://172.17.0.5
</span></span><span style=display:flex><span>  <span style=color:#f60>2</span> threads and <span style=color:#f60>100</span> connections
</span></span><span style=display:flex><span>  Thread Stats   Avg      Stdev     Max   +/- Stdev
</span></span><span style=display:flex><span>    Latency    12.31ms   12.66ms  84.49ms   82.31%
</span></span><span style=display:flex><span>    Req/Sec     5.71k     4.96k   12.98k    63.00%
</span></span><span style=display:flex><span>  <span style=color:#f60>113583</span> requests in 10.04s, 17.87MB <span style=color:#366>read</span>
</span></span><span style=display:flex><span>Requests/sec:  11313.86
</span></span><span style=display:flex><span>Transfer/sec:      1.78MB
</span></span></code></pre></div><blockquote><p><strong>Latencyï¼ˆå»¶è¿Ÿï¼‰</strong></p><ul><li><strong>Avg 12.31ms</strong>ï¼šå¹³å‡æ¯ä¸ªè¯·æ±‚çš„å“åº”æ—¶é—´ä¸º <strong>12.31 æ¯«ç§’</strong></li><li><strong>Stdev 12.66ms</strong>ï¼šæ ‡å‡†å·®è¯´æ˜å“åº”æ—¶é—´æ³¢åŠ¨è¾ƒå¤§</li><li><strong>Max 84.49ms</strong>ï¼šæœ€é•¿è¯·æ±‚èŠ±äº† 84.49 æ¯«ç§’</li><li><strong>82.31% +/- Stdev</strong>ï¼š82% çš„è¯·æ±‚å»¶è¿Ÿåœ¨ Â±1 æ ‡å‡†å·®èŒƒå›´å†…ï¼ˆè¯´æ˜å¤§éƒ¨åˆ†è¯·æ±‚åˆ†å¸ƒè¾ƒå¹¿ï¼‰</li></ul><p><strong>Req/Secï¼ˆæ¯ç§’è¯·æ±‚æ•°ï¼‰</strong></p><ul><li><strong>Avg 5.71k</strong>ï¼šå¹³å‡æ¯ä¸ªçº¿ç¨‹æ¯ç§’å‘å‡ºçº¦ <strong>5710 ä¸ªè¯·æ±‚</strong></li><li><strong>Stdev 4.96k</strong>ï¼šæ ‡å‡†å·®è¯´æ˜ä¸åŒæ—¶é—´ç‚¹ååæ³¢åŠ¨è¾ƒå¤§</li><li><strong>Max 12.98k</strong>ï¼šå•ä¸ªçº¿ç¨‹çš„æœ€é«˜ç¬æ—¶è¯·æ±‚é€Ÿç‡ä¸º 12.98k/s</li><li><strong>63.00% +/- Stdev</strong>ï¼šçº¦ 63% çš„æ ·æœ¬åœ¨è¿™ä¸ªèŒƒå›´å†…</li></ul></blockquote><p>æ¥ä¸‹æ¥æˆ‘ä»¬åˆ©ç”¨å¥—æ¥å­— eBPF ç¨‹åºä¼˜åŒ–</p><h2 id=ç†è§£-nginx-è´Ÿè½½å‡è¡¡çš„æœ¬è´¨>ç†è§£ Nginx è´Ÿè½½å‡è¡¡çš„æœ¬è´¨<a hidden class=anchor aria-hidden=true href=#ç†è§£-nginx-è´Ÿè½½å‡è¡¡çš„æœ¬è´¨>#</a></h2><p>Nginx ä½œä¸ºåå‘ä»£ç†æˆ–è´Ÿè½½å‡è¡¡å™¨ï¼Œæœ¬è´¨ä¸Šæ˜¯ï¼š</p><ol><li><strong>ä»å®¢æˆ·ç«¯æ¥æ”¶è¯·æ±‚</strong>ï¼ˆé€šè¿‡ <code>accept()</code> å»ºç«‹ TCP è¿æ¥ï¼‰</li><li><strong>é€‰æ‹©ä¸€ä¸ªä¸Šæ¸¸åç«¯ï¼ˆupstream serverï¼‰</strong></li><li><strong>åœ¨ç”¨æˆ·æ€å‘èµ·ä¸€ä¸ªæ–°çš„ TCP è¿æ¥</strong> åˆ°è¯¥åç«¯</li><li><strong>åœ¨ä¸¤ä¸ª socket ä¹‹é—´ä¸­è½¬æ•°æ®</strong>ï¼ˆå‰ç«¯ &lt;-> åç«¯ï¼‰</li></ol><p>å…³é”®ç‚¹ï¼šNginx çš„è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼ˆå¦‚ round robinã€ip_hashï¼‰åœ¨<strong>ç”¨æˆ·æ€</strong>å†³å®šï¼›è€Œå®é™…çš„æ•°æ®æµæ˜¯<strong>ä¸¤ä¸ªç‹¬ç«‹çš„ socket</strong>ï¼Œä¸­é—´çš„æ•°æ®è½¬å‘ä¹Ÿåœ¨ç”¨æˆ·æ€è¿›è¡Œï¼ˆæ•ˆç‡ä¸Šæœ‰æŸï¼‰ã€‚</p><p>å½“æˆ‘ä»¬å¼•å…¥ <strong>eBPFï¼ˆextended Berkeley Packet Filterï¼‰</strong> æ—¶ï¼Œç›®æ ‡å¾€å¾€æ˜¯ï¼š</p><ul><li><strong>æŠŠè´Ÿè½½å‡è¡¡é€»è¾‘ä¸‹æ”¾åˆ°å†…æ ¸æ€</strong></li><li><strong>å‡å°‘ Nginx ç”¨æˆ·æ€è½¬å‘å¼€é”€</strong></li><li><strong>å®ç°æ›´å¿«çš„æµé‡åˆ†å‘ï¼ˆé›¶æ‹·è´ã€ä½å»¶è¿Ÿï¼‰</strong></li></ul><p>ä¾‹å¦‚ï¼š</p><ul><li>ç”¨ eBPF ç¨‹åºåœ¨ <strong>XDP</strong> æˆ– <strong>TC ingress hook</strong> é˜¶æ®µç›´æ¥é€‰æ‹©åç«¯ï¼›</li><li>æˆ–è€…ä½¿ç”¨ <strong>sockmap/sockhash</strong> åœ¨å†…æ ¸ä¸­ç›´æ¥â€œè½¬å‘â€ä¸¤ä¸ª socket ä¹‹é—´çš„æ•°æ®ã€‚</li></ul><h2 id=ä½¿ç”¨-socket-æ˜ å°„è½¬å‘ç½‘ç»œåŒ…>ä½¿ç”¨ socket æ˜ å°„è½¬å‘ç½‘ç»œåŒ…<a hidden class=anchor aria-hidden=true href=#ä½¿ç”¨-socket-æ˜ å°„è½¬å‘ç½‘ç»œåŒ…>#</a></h2><p><strong>socket æ˜ å°„</strong>ï¼ˆsocket mapï¼‰æ˜¯ eBPF ä¸­çš„ä¸€ç§ <strong>BPF map</strong> ç±»å‹ï¼Œå®ƒå¯ä»¥åœ¨å†…æ ¸ä¸­ä¿å­˜ <strong>socket çš„å¼•ç”¨</strong>ï¼ˆå³ TCP è¿æ¥å¯¹è±¡ï¼‰ï¼Œ ä»è€Œå…è®¸ eBPF ç¨‹åºç›´æ¥æ“ä½œå’Œè½¬å‘è¿™äº›è¿æ¥ä¸Šçš„æ•°æ®ã€‚å®ƒæœ‰ä¸¤ç§å½¢å¼ï¼š</p><table><thead><tr><th>ç±»å‹</th><th>åç§°</th><th>ç‰¹ç‚¹</th></tr></thead><tbody><tr><td><code>BPF_MAP_TYPE_SOCKMAP</code></td><td>sockmap</td><td>æ•°ç»„ç»“æ„ï¼ŒæŒ‰ç´¢å¼•å­˜ socket</td></tr><tr><td><code>BPF_MAP_TYPE_SOCKHASH</code></td><td>sockhash</td><td>å“ˆå¸Œç»“æ„ï¼Œå¯æŒ‰ key æŸ¥æ‰¾ socket</td></tr></tbody></table><p>å¯ä»¥ç†è§£ä¸ºï¼š<strong>sockmap/sockhash = ä¸€ä¸ªâ€œè¿æ¥è·¯ç”±è¡¨â€ï¼Œå­˜æ”¾ <code>&lt;key, socket></code> æ˜ å°„å…³ç³»ã€‚ è®© eBPF ç¨‹åºåœ¨å†…æ ¸ä¸­çŸ¥é“â€œå“ªä¸ª key å¯¹åº”å“ªä¸ª socketâ€</strong>ã€‚</p><hr><p>ä¼ ç»Ÿç”¨æˆ·æ€è½¬å‘çš„æ€§èƒ½ç“¶é¢ˆï¼Œä»¥ Nginx ä¸ºä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>client socket â†’ Nginx ç”¨æˆ·æ€ â†’ upstream socket
</span></span></code></pre></div><p>æ•°æ®æµéœ€è¦ç»è¿‡ï¼š</p><ul><li>2 æ¬¡ç³»ç»Ÿè°ƒç”¨ï¼ˆrecv + sendï¼‰</li><li>2 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ˆå†…æ ¸â†”ç”¨æˆ·æ€ï¼‰</li><li>1 æ¬¡æ•°æ®æ‹·è´ï¼ˆå†…æ ¸ç¼“å†²åŒºâ†”ç”¨æˆ·ç¼“å†²åŒºï¼‰</li></ul><p>å½“å¹¶å‘é‡å¾ˆé«˜ï¼ˆæ¯”å¦‚ wrk 10k QPSï¼‰æ—¶ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±æˆä¸ºç“¶é¢ˆã€‚</p><p>äºæ˜¯ Linux å¼•å…¥äº† <strong>socket æ˜ å°„ + SK_MSG eBPF ç¨‹åº</strong>å¯ä»¥ç›´æ¥åœ¨å†…æ ¸ä¸­å®Œæˆè½¬å‘ï¼š</p><ol><li>æŠŠæ‰€æœ‰è¿æ¥ï¼ˆclient å’Œ upstreamï¼‰çš„ socket å¼•ç”¨æ³¨å†Œè¿› sockmapï¼›</li><li>eBPF ç¨‹åºåœ¨å‘é€è·¯å¾„ä¸­ï¼ˆ<code>BPF_PROG_TYPE_SK_MSG</code>ï¼‰æ‰§è¡Œï¼›</li><li>ç¨‹åºä» sockmap ä¸­æŸ¥æ‰¾ç›®æ ‡ socketï¼›</li><li>å†…æ ¸ç›´æ¥æŠŠæ•°æ®ä»ä¸€ä¸ª socket å‘é€åˆ°å¦ä¸€ä¸ª socket â€”â€” <strong>é›¶æ‹·è´è½¬å‘</strong>ã€‚</li></ol><p>åœ¨ eBPF ä¼˜åŒ–ä½“ç³»ä¸­ï¼š</p><ul><li><strong>æ§åˆ¶é¢ï¼ˆControl Planeï¼‰</strong>ï¼šå†³å®šæ€ä¹ˆè½¬å‘ï¼ˆè°è½¬å‘ç»™è°ï¼‰ â†’ ç”¨æˆ·æ€ï¼ˆNginxï¼‰</li><li><strong>æ•°æ®é¢ï¼ˆData Planeï¼‰</strong>ï¼šå®é™…æ‰§è¡Œè½¬å‘ â†’ å†…æ ¸æ€ï¼ˆeBPFï¼‰</li></ul><p>socket æ˜ å°„å°±æ˜¯ä¸¤è€…çš„â€œæ¡¥æ¢â€ï¼šNginx è´Ÿè´£æŠŠ socket æ³¨å†Œè¿› sockmapï¼ˆå‘Šè¯‰å†…æ ¸ï¼šclient_fd å¯¹åº” upstream_fdï¼‰ï¼ŒeBPF ç¨‹åºè´Ÿè´£ä» sockmap ä¸­æŸ¥æ‰¾ç›®æ ‡å¹¶å®Œæˆè½¬å‘ã€‚</p><p>è¿™ç§æ¨¡å¼çš„å¥½å¤„æ˜¯ï¼š</p><ul><li>eBPF ä¸éœ€è¦è‡ªå·±ç»´æŠ¤è¿æ¥ï¼›</li><li>ç”¨æˆ·æ€åº”ç”¨å¯ä»¥åŠ¨æ€è°ƒæ•´æ˜ å°„ï¼›</li><li>å†…æ ¸å¯ä»¥é«˜æ€§èƒ½åœ°å®Œæˆæ•°æ®è½¬å‘ã€‚</li></ul><hr><p>æ•°æ®æµç®€åŒ–ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p><ol><li>ä¼ ç»Ÿ Nginx è½¬å‘</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>[Client Socket]
</span></span><span style=display:flex><span>   â†“ recv()
</span></span><span style=display:flex><span>[ç”¨æˆ·æ€ç¼“å†²åŒº]
</span></span><span style=display:flex><span>   â†“ send()
</span></span><span style=display:flex><span>[Upstream Socket]
</span></span></code></pre></div><ol start=2><li>eBPF + socket æ˜ å°„ä¼˜åŒ–å</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>[Client Socket]
</span></span><span style=display:flex><span>   â†“  eBPF ç¨‹åº (SK_MSG)
</span></span><span style=display:flex><span>   â†˜ï¸ æŸ¥æ‰¾ sockmap[key]
</span></span><span style=display:flex><span>       â†“
</span></span><span style=display:flex><span>   [Upstream Socket]
</span></span></code></pre></div><p>æ•´ä¸ªè½¬å‘åœ¨å†…æ ¸ä¸­å®Œæˆï¼Œæ— éœ€è¿›å…¥ Nginx ç”¨æˆ·æ€ã€‚</p><hr><p>é‚£ä¼˜åŒ–çš„æ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li>åˆ›å»ºå¥—æ¥å­—æ˜ å°„ï¼›</li><li>åœ¨ <code>BPF_PROG_TYPE_SOCK_OPS</code> ç±»å‹çš„ eBPF ç¨‹åºä¸­ï¼Œå°†æ–°åˆ›å»ºçš„å¥—æ¥å­—å­˜å…¥å¥—æ¥å­—æ˜ å°„ä¸­ï¼›</li><li>åœ¨æµè§£æç±»çš„ eBPF ç¨‹åº (å¦‚ <code>BPF_PROG_TYPE_SK_SKB</code> æˆ– <code>BPF_PROG_TYPE_SK_MSG</code> ) ä¸­ï¼Œä»å¥—æ¥å­—æ˜ å°„ä¸­æå–å¥—æ¥å­—ä¿¡æ¯ï¼Œå¹¶è°ƒç”¨ BPF è¾…åŠ©å‡½æ•°è½¬å‘ç½‘ç»œåŒ…;</li><li>åŠ è½½å¹¶æŒ‚è½½ eBPF ç¨‹åºåˆ°å¥—æ¥å­—äº‹ä»¶ã€‚</li></ol><h2 id=socket-æ˜ å°„>socket æ˜ å°„<a hidden class=anchor aria-hidden=true href=#socket-æ˜ å°„>#</a></h2><p>è¿™é‡Œä½¿ç”¨ <strong>socket æ˜ å°„</strong>ï¼ˆsocket mapï¼‰ä¸­çš„ä¸€ç§ BPF Map ç±»å‹ï¼š<code>BPF_MAP_TYPE_SOCKHASH</code>ï¼Œå®ƒçš„å€¼æ€»æ˜¯å¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦ï¼Œè€Œé”®åˆ™éœ€è¦æˆ‘ä»¬å»å®šä¹‰ã€‚</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#069;font-weight:700>typedef</span> <span style=color:#069;font-weight:700>struct</span> {
</span></span><span style=display:flex><span>    __u32 source_ip;
</span></span><span style=display:flex><span>    __u32 dest_ip;
</span></span><span style=display:flex><span>    __u16 source_port;
</span></span><span style=display:flex><span>    __u16 dest_port;
</span></span><span style=display:flex><span>    __u32 protocol;
</span></span><span style=display:flex><span>} SockKey;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#c0f>__uint</span>(type, BPF_MAP_TYPE_SOCKHASH);
</span></span><span style=display:flex><span>    <span style=color:#c0f>__uint</span>(key_size, <span style=color:#069;font-weight:700>sizeof</span>(SockKey));
</span></span><span style=display:flex><span>    <span style=color:#c0f>__uint</span>(value_size, <span style=color:#069;font-weight:700>sizeof</span>(<span style=color:#078;font-weight:700>int</span>));
</span></span><span style=display:flex><span>    <span style=color:#c0f>__uint</span>(max_entries, <span style=color:#f60>65535</span>);
</span></span><span style=display:flex><span>    <span style=color:#c0f>__uint</span>(map_flags, <span style=color:#f60>0</span>);
</span></span><span style=display:flex><span>} sock_ops_map <span style=color:#c0f>SEC</span>(<span style=color:#c30>&#34;.maps&#34;</span>);
</span></span></code></pre></div><p><code>BPF_PROG_TYPE_SOCK_OPS</code> æ˜¯ <strong>å†…æ ¸å¥—æ¥å­—æ“ä½œå›è°ƒç±»å‹</strong>çš„ eBPF ç¨‹åºï¼Œå®ƒèƒ½åœ¨ <strong>TCP è¿æ¥çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶</strong>è¢«è§¦å‘æ—¶æ‰§è¡Œï¼ŒåŒ…æ‹¬ï¼š</p><ul><li><code>BPF_SOCK_OPS_PASSIVE_ESTABLISHED_CB</code>ï¼šè¢«åŠ¨è¿æ¥å»ºç«‹ï¼ˆå¦‚æœåŠ¡å™¨ acceptï¼‰</li><li><code>BPF_SOCK_OPS_ACTIVE_ESTABLISHED_CB</code>ï¼šä¸»åŠ¨è¿æ¥å»ºç«‹ï¼ˆå¦‚å®¢æˆ·ç«¯ connectï¼‰</li><li><code>BPF_SOCK_OPS_TCP_CLOSE_CB</code>ï¼šè¿æ¥å…³é—­</li><li><code>BPF_SOCK_OPS_STATE_CB</code>ï¼šçŠ¶æ€å˜åŒ–</li></ul><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒå¯ä»¥è·Ÿè¸ª TCP socket çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸï¼Œåœ¨<strong>è¿æ¥å»ºç«‹/å…³é—­æ—¶è·å– socket çš„äº”å…ƒç»„ä¿¡æ¯</strong>ï¼Œå¹¶æŠŠ socket å­˜å…¥ sockhashï¼Œä»è€Œè®© <strong>å†…æ ¸æ€ eBPF æ•°æ®é¢ç¨‹åºï¼ˆå¦‚ SK_MSGï¼‰å¯ä»¥ç›´æ¥é«˜æ•ˆåœ°æŸ¥æ‰¾å’Œè½¬å‘ socket æ•°æ®</strong>ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>BPF_PROG_TYPE_SOCK_OPS</code> ç¨‹åºè·Ÿè¸ªäº†æ‰€æœ‰ç±»å‹çš„å¥—æ¥å­—æ“ä½œï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠ<strong>æ–°åˆ›å»º</strong>çš„å¥—æ¥å­—æ›´æ–°åˆ°æ˜ å°„ä¸­ã€‚</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#c0f>SEC</span>(<span style=color:#c30>&#34;sockops&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#078;font-weight:700>int</span> <span style=color:#c0f>bpf_sockmap</span>(<span style=color:#069;font-weight:700>struct</span> bpf_sock_ops<span style=color:#555>*</span> sockops) {
</span></span><span style=display:flex><span>    <span style=color:#09f;font-style:italic>// åªå¤„ç† IPv4 è¿æ¥
</span></span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>if</span> (sockops<span style=color:#555>-&gt;</span>family <span style=color:#555>!=</span> AF_INET) {
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>return</span> BPF_OK;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#09f;font-style:italic>// åªå¤„ç†å·²å»ºç«‹çš„è¿æ¥
</span></span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>if</span> (sockops<span style=color:#555>-&gt;</span>op <span style=color:#555>!=</span> BPF_SOCK_OPS_PASSIVE_ESTABLISHED_CB <span style=color:#555>&amp;&amp;</span>
</span></span><span style=display:flex><span>        sockops<span style=color:#555>-&gt;</span>op <span style=color:#555>!=</span> BPF_SOCK_OPS_ACTIVE_ESTABLISHED_CB) {
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>return</span> BPF_OK;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    SockKey key <span style=color:#555>=</span> {
</span></span><span style=display:flex><span>        .dest_ip <span style=color:#555>=</span> sockops<span style=color:#555>-&gt;</span>remote_ip4,
</span></span><span style=display:flex><span>        .source_ip <span style=color:#555>=</span> sockops<span style=color:#555>-&gt;</span>local_ip4,
</span></span><span style=display:flex><span>        .dest_port <span style=color:#555>=</span> sockops<span style=color:#555>-&gt;</span>remote_port,
</span></span><span style=display:flex><span>        .source_port <span style=color:#555>=</span> <span style=color:#c0f>bpf_htonl</span>(sockops<span style=color:#555>-&gt;</span>local_port),
</span></span><span style=display:flex><span>        .protocol <span style=color:#555>=</span> sockops<span style=color:#555>-&gt;</span>family,
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c0f>bpf_sock_hash_update</span>(sockops, <span style=color:#555>&amp;</span>sock_ops_map, <span style=color:#555>&amp;</span>key, BPF_NOEXIST);
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>return</span> BPF_OK;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=è½¬å‘-socket>è½¬å‘ socket<a hidden class=anchor aria-hidden=true href=#è½¬å‘-socket>#</a></h2><p>è½¬å‘ socket å¯ä»¥ä½¿ç”¨ <code>BPF_PROG_TYPE_SK_MSG</code> ç±»å‹çš„ eBPF ç¨‹åºï¼Œå®ƒåœ¨å†…æ ¸ä¸­çš„å®šä¹‰æ˜¯è¿™æ ·çš„ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#c0f>BPF_PROG_TYPE</span>(BPF_PROG_TYPE_SK_MSG, sk_msg,
</span></span><span style=display:flex><span>	      <span style=color:#069;font-weight:700>struct</span> sk_msg_md, <span style=color:#069;font-weight:700>struct</span> sk_msg)
</span></span></code></pre></div><p>æ•è· socket ä¸­çš„å‘é€æ•°æ®åŒ…ï¼Œå¹¶æ ¹æ®ä¹‹å‰çš„ socket æ˜ å°„è¿›è¡Œè½¬å‘ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#c0f>SEC</span>(<span style=color:#c30>&#34;sk_msg&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#078;font-weight:700>int</span> <span style=color:#c0f>bpf_sock_redirect</span>(<span style=color:#069;font-weight:700>struct</span> sk_msg_md<span style=color:#555>*</span> msg) {
</span></span><span style=display:flex><span>    SockKey key <span style=color:#555>=</span> {
</span></span><span style=display:flex><span>        .source_ip <span style=color:#555>=</span> msg<span style=color:#555>-&gt;</span>remote_ip4,
</span></span><span style=display:flex><span>        .dest_ip <span style=color:#555>=</span> msg<span style=color:#555>-&gt;</span>local_ip4,
</span></span><span style=display:flex><span>        .source_port <span style=color:#555>=</span> msg<span style=color:#555>-&gt;</span>remote_port,
</span></span><span style=display:flex><span>        .dest_port <span style=color:#555>=</span> <span style=color:#c0f>bpf_htonl</span>(msg<span style=color:#555>-&gt;</span>local_port),
</span></span><span style=display:flex><span>        .protocol <span style=color:#555>=</span> msg<span style=color:#555>-&gt;</span>family,
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c0f>bpf_msg_redirect_hash</span>(msg, <span style=color:#555>&amp;</span>sock_ops_map, <span style=color:#555>&amp;</span>key, BPF_F_INGRESS);
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>return</span> SK_PASS;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=æµ‹è¯•ç»“æœ>æµ‹è¯•ç»“æœ<a hidden class=anchor aria-hidden=true href=#æµ‹è¯•ç»“æœ>#</a></h2><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>/ <span style=color:#09f;font-style:italic># wrk -c100 &#34;http://172.17.0.5&#34;</span>
</span></span><span style=display:flex><span>Running 10s <span style=color:#366>test</span> @ http://172.17.0.5
</span></span><span style=display:flex><span>  <span style=color:#f60>2</span> threads and <span style=color:#f60>100</span> connections
</span></span><span style=display:flex><span>  Thread Stats   Avg      Stdev     Max   +/- Stdev
</span></span><span style=display:flex><span>    Latency     7.88ms    6.22ms  55.43ms   68.53%
</span></span><span style=display:flex><span>    Req/Sec     7.03k     4.99k   15.03k    69.00%
</span></span><span style=display:flex><span>  <span style=color:#f60>140073</span> requests in 10.05s, 22.04MB <span style=color:#366>read</span>
</span></span><span style=display:flex><span>Requests/sec:  13940.22
</span></span><span style=display:flex><span>Transfer/sec:      2.19MB
</span></span></code></pre></div><ul><li>ååæå‡ â‰ˆ <strong>23.2%</strong>ã€‚</li><li>å¹³å‡å»¶è¿Ÿä¸‹é™ â‰ˆ <strong>36.0%</strong>ã€‚</li></ul></div><footer class=post-footer><nav class=paginav><a class=prev href=https://kerolt.github.io/posts/ebpf/ebpf%E4%B8%AD%E4%BD%95%E6%97%B6%E4%BD%BF%E7%94%A8%E5%AD%97%E8%8A%82%E5%BA%8F%E8%BD%AC%E6%8D%A2%E5%87%BD%E6%95%B0/><span class=title>Â« Prev</span><br><span>eBPFä¸­ä½•æ—¶ä½¿ç”¨å­—èŠ‚åºè½¬æ¢å‡½æ•°</span>
</a><a class=next href=https://kerolt.github.io/posts/%E5%89%8D%E7%AB%AF/vue3%E8%B7%AF%E7%94%B1%E4%B8%8Evite%E7%9A%84base/><span class=title>Next Â»</span><br><span>Vue3è·¯ç”±ä¸Viteçš„base</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2026 <a href=https://kerolt.github.io/>Kerolt's Blog</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>